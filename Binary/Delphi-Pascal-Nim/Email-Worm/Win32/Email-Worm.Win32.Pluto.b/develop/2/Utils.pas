UNIT Utils;

INTERFACE

CONST
  TH32CS_SNAPPROCESS    = 2;
  FILE_ATTRIBUTE_HIDDEN = 2;
  HKEY_CURRENT_USER     = $80000001;
  HKEY_LOCAL_MACHINE    = $80000002;
  faHidden              = $00000002;
  faSysFile             = $00000004;
  faVolumeID            = $00000008;
  faDirectory           = $00000010;
  faAnyFile             = $0000003F;
  INVALID_HANDLE_VALUE  = LONGWORD(-1);
  MAX_PATH              = 260;
  WAIT_TIMEOUT          = 258;
  Kernel32              = 'kernel32.dll';
  User32                = 'user32.DLL';

TYPE
  DWORD     = LongWord;
  BOOL      = LongBool;
  LPDWORD   =^DWORD;
  HWND      = TYPE LongWord;
  TFileName = TYPE STRING;
  THandle   = Integer;

  TOSVersionInfo = RECORD
    dwOSVersionInfoSize : DWORD;
    dwMajorVersion      : DWORD;
    dwMinorVersion      : DWORD;
    dwBuildNumber       : DWORD;
    dwPlatformId        : DWORD;
    szCSDVersion        : ARRAY[0..127] OF AnsiChar;
  END;

  TFILETIME = RECORD
    dwLowDateTime  : LongWord;
    dwHighDateTime : LongWord;
  END;

  TProcessEntry32 = RECORD
    dwSize              : Cardinal;
    cntUsage            : Cardinal;
    th32ProcessID       : Cardinal;
    th32DefaultHeapID   : Cardinal;
    th32ModuleID        : Cardinal;
    cntThreads          : Cardinal;
    th32ParentProcessID : Cardinal;
    pcPriClassBase      : Integer;
    dwFlags             : Cardinal;
    szExeFile           : ARRAY [0..259] OF Char;
  END;

   _WIN32_FIND_DATAA = RECORD
     dwFileAttributes   : LongWord;
     ftCreationTime     : TFileTime;
     ftLastAccessTime   : TFileTime;
     ftLastWriteTime    : TFileTime;
     nFileSizeHigh      : LongWord;
     nFileSizeLow       : LongWord;
     dwReserved0        : LongWord;
     dwReserved1        : LongWord;
     cFileName          : ARRAY[0..MAX_PATH - 1] OF AnsiChar;
     cAlternateFileName : ARRAY[0..13] OF AnsiChar;
  END;

  TWin32FindData = _WIN32_FIND_DATAA;

  TSearchRec = RECORD
    Time        : Integer;
    Size        : Integer;
    Attr        : Integer;
    Name        : TFileName;
    ExcludeAttr : Integer;
    FindHandle  : THandle;
    FindData    : TWin32FindData;
  END;

FUNCTION InternetGetConnectedState(lpdwFlags:LPDWORD;dwReserved:DWORD): BOOL; STDCALL; EXTERNAL 'WININET.DLL';

FUNCTION FindFirst(CONST Path:STRING;Attr:Integer;VAR F:TSearchRec) : Integer;
FUNCTION ExtractFileName(FileName:STRING) : STRING;
FUNCTION FileExists(FileName:STRING) : Boolean;
FUNCTION FindNext(VAR F:TSearchRec) : Integer;
FUNCTION UpperCase(S:STRING) : STRING;

FUNCTION CreateDir(lpPathName:STRING;lpSecurityAttributes:Integer) : Boolean; STDCALL;
FUNCTION GetLastError : DWORD; STDCALL;
FUNCTION TerminateProcess(hProcess,uExitCode:Cardinal): BOOL; STDCALL;
FUNCTION OpenProcess(wDesiredAccess:Cardinal;blnheritHandle:LongBool;dwProcessld:Cardinal) : Integer; STDCALL;
FUNCTION CloseHandle(hObject:Cardinal) : BOOl; STDCALL;
FUNCTION Process32First(hSnapshot:Integer;VAR lppe:TProcessEntry32) : BOOL; STDCALL;
FUNCTION CreateToolHelp32Snapshot(dwFlags,th32ProcessID:Cardinal) : Integer; STDCALL;
FUNCTION Process32Next(hSnapshot:Cardinal;VAR lppe:TProcessEntry32) : BOOL; STDCALL;
FUNCTION WaitForSingleObject(hHandle,dwMilliseconds:Cardinal) : Cardinal; STDCALL;
FUNCTION CreateMutex(lpMutexAttributes:Pointer;bInitialOwner:BOOL;lpName:STRING) : Cardinal; STDCALL;
FUNCTION GetVersionEx(VAR lpVersionInformation: TOSVersionInfo) : BOOL; STDCALL;
FUNCTION GetDriveType(lpDisk:STRING) : Integer; STDCALL;
FUNCTION ShowWindow(hWnd: HWND; nCmdShow: Integer) : BOOL; STDCALL;
FUNCTION SetWindowLong(hWnd:HWND;nIndex:Integer;dwNewLong:Longint) : Longint; STDCALL;
FUNCTION GetWindowLong(hWnd,nIndex:Integer) : Integer; STDCALL;
FUNCTION CopyFile2(lpExistingFileName,lpNewFileName:PChar;bFailIfExists:BOOL) : BOOL; STDCALL;
FUNCTION SetFileAttributes(lpFileName:pChar;dwFileAttributes:Longint) : LongBool; STDCALL;

FUNCTION CreateDir; EXTERNAL Kernel32 Name 'CreateDirectoryA';
FUNCTION GetLastError; EXTERNAL Kernel32 Name 'GetLastError';
FUNCTION TerminateProcess; EXTERNAL Kernel32 Name 'TerminateProcess';
FUNCTION OpenProcess; EXTERNAL Kernel32 Name 'OpenProcess';
FUNCTION CloseHandle; EXTERNAL Kernel32 Name 'CloseHandle';
FUNCTION Process32First; EXTERNAL Kernel32 Name 'Process32First';
FUNCTION CreateToolHelp32Snapshot; EXTERNAL Kernel32 Name 'CreateToolhelp32Snapshot';
FUNCTION Process32Next; EXTERNAL Kernel32 Name 'Process32Next';
FUNCTION WaitForSingleObject; EXTERNAL Kernel32 Name 'WaitForSingleObject';
FUNCTION CreateMutex; EXTERNAL Kernel32 Name 'CreateMutexA';
FUNCTION GetVersionEx; EXTERNAL Kernel32 name 'GetVersionExA';
FUNCTION GetDriveType; EXTERNAL Kernel32 name 'GetDriveTypeA';
FUNCTION CopyFile2; EXTERNAL Kernel32 Name 'CopyFileA';
FUNCTION SetFileAttributes; EXTERNAL Kernel32 Name 'SetFileAttributesA';
FUNCTION ShowWindow; EXTERNAL User32 name 'ShowWindow';
FUNCTION SetWindowLong; EXTERNAL User32 name 'SetWindowLongA';
FUNCTION GetWindowLong; EXTERNAL User32 name 'GetWindowLongA';

IMPLEMENTATION

FUNCTION FindFirstFileA(lpFileName:PChar;VAR lpFindFileData:TWIN32FindData) : THandle; STDCALL; EXTERNAL Kernel32 Name 'FindFirstFileA';
FUNCTION FindNextFileA(hFindFile:THandle;VAR lpFindFileData:TWIN32FindData) : LONGBOOL; STDCALL;EXTERNAL Kernel32 Name 'FindNextFileA';
FUNCTION FindCloseA(hFindFile:THandle) : LONGBOOL; STDCALL;EXTERNAL Kernel32 Name 'FindClose';

FUNCTION FindMatchingFile(VAR F: TSearchRec): Integer;
VAR
  LocalFileTime : TFileTime;
BEGIN
  WITH F DO BEGIN
    WHILE FindData.dwFileAttributes AND ExcludeAttr<>0 DO
      IF NOT FindNextFileA(FindHandle,FindData) THEN BEGIN
        Result:=GetLastError;
        Exit;
      END;
      Size:=FindData.nFileSizeLow;
      Attr:=FindData.dwFileAttributes;
      Name:=FindData.cFileName;
  END;
  Result:=0;
END;

PROCEDURE FindClose(VAR F:TSearchRec);
BEGIN
  IF F.FindHandle <> INVALID_HANDLE_VALUE THEN BEGIN
    FindCloseA(F.FindHandle);
    F.FindHandle := INVALID_HANDLE_VALUE;
  END;
END;

FUNCTION FindFirst(CONST Path:STRING;Attr:Integer;VAR F:TSearchRec) : Integer;
CONST
  faSpecial=faHidden OR faSysFile OR faVolumeID OR faDirectory;
BEGIN
  F.ExcludeAttr:=NOT Attr AND faSpecial;
  F.FindHandle:=FindFirstFileA(PChar(Path),F.FindData);
  if F.FindHandle<>INVALID_HANDLE_VALUE THEN BEGIN
    Result:=FindMatchingFile(F);
    IF Result<>0 THEN FindClose(F);
  END ELSE Result:=GetLastError;
END;

FUNCTION FileExists(FileName:STRING): Boolean;
VAR
  F : FILE;
BEGIN
  {$I-}
  AssignFile(F,FileName);
  FileMode:=0;
  Reset(F);
  CloseFile(F);
  {$I+}
  FileExists:=(IOResult=0)AND(FileName<>'');
END;

FUNCTION ExtractFileName(FileName:STRING) : STRING;
VAR
  I : Integer;
BEGIN
  I:=Length(FileName);
  WHILE(I>=1)AND NOT(FileName[I] IN ['\',':']) DO Dec(I);
  Result:=Copy(FileName,I+1,255);
  IF (Length(Result)>0)AND(Result[length(Result)]=#0)THEN Setlength(result,Length(Result)-1);
END;

FUNCTION UpperCase(S:STRING) : STRING;
VAR
  Ch           : Char;
  L            : Integer;
  Source, Dest : PChar;
BEGIN
  L:=Length(S);
  SetLength(Result,L);
  Source:=Pointer(S);
  Dest:=Pointer(Result);
  WHILE L<>0 DO BEGIN
    Ch:=Source^;
    IF (Ch>='a')AND(Ch<='z') THEN Dec(Ch, 32);
    Dest^:=Ch;
    Inc(Source);
    Inc(Dest);
    Dec(L);
  END;
END;

FUNCTION FindNext(VAR F:TSearchRec) : Integer;
BEGIN
  IF FindNextFileA(F.FindHandle,F.FindData) THEN Result:=FindMatchingFile(F)
  ELSE Result:=GetLastError;
END;

END.
