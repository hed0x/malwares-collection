   ;Include file ring-3 InputOutput functions
   ;(c) necr0mancer
   ;
   ;                       necr0mancer2001@hotmail.com

   ;-------------------------------
   ;Input:edx=offset of filename

   fopen  proc

          pushad

          xor ebx,ebx

          push ebx
          push FILE_ATTRIBUTE_NORMAL
          push OPEN_EXISTING
          push ebx
          push FILE_SHARE_READ + FILE_SHARE_WRITE
          push GENERIC_READ + GENERIC_WRITE
          push edx
          call [ebp+CreateFile @ex]

          inc eax                 ;eax=-1?
          jz fopen_exit
          dec eax

   fopen_exit:

          mov [esp._eax], eax
          popad
          retn
   fopen  endp


   ;-------------------------------
   ;Input:ebx=handle

   fclose proc

          pushad

          push ebx
          call [ebp+CloseHandle @ex]

          popad
          retn
   fclose endp


   ;-------------------------------
   ;Input:ebx=handle file
   ;      ecx=count of bytes to read
   ;      edx=offset of bufer
   fread  proc

          pushad

          push 0

          lea eax,[ebp+offset bytesread @ex]
          push eax

          push ecx
          push edx
          push ebx
          call [ebp+ReadFile @ex]

          popad
          retn
   fread  endp

   ;-------------------------------
   ;Input:ebx=handle file
   ;      ecx=count of bytes to move
   fseek  proc

          pushad

          push FILE_BEGIN
          push 0
          push ecx
          push ebx
          call [ebp+SetFilePointer @ex]

          popad
          retn
   fseek  endp



   ;-------------------------------
   ;Input:ebx=handle file
   ;      ecx=count of bytes to write
   ;      edi=offset of bufer

   fwrite  proc

          pushad

          push 0

          lea eax,[ebp+offset bytesread @ex]
          push eax

          push ecx
          push edi

          push ebx
          call [ebp+WriteFile @ex]

          popad
          retn
   fwrite  endp


   f_createmap  proc
          pusha

          xor eax,eax
          push eax             ;for mapvievoffile

          push eax             ;name
          push eax                     ;lowsize
          push eax                     ;highsize
          push PAGE_READWRITE
          push eax
          push ebx
          call [ebp+CreateFileMappingA @ex]

          xchg ebx,eax

          pop eax              ;null
          push eax             ;count bytes
          push eax                     ;lowsize
          push eax                     ;highsize
          push FILE_MAP_WRITE
          push ebx
          call [ebp+MapViewOfFile @ex]

          mov [esp+_eax],eax
          popa
          retn
   f_createmap  endp


   f_closemap  proc
          pusha
          push ebx
          call [ebp+UnmapViewOfFile @ex]
          popa
          retn
   f_closemap  endp
